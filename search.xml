<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å¤§è¯­è¨€æ¨¡å‹ä¸­çš„Normå’Œæ¿€æ´»å‡½æ•°</title>
      <link href="/2025/03/18/da-yu-yan-mo-xing-zhong-de-norm-he-ji-huo-han-shu/"/>
      <url>/2025/03/18/da-yu-yan-mo-xing-zhong-de-norm-he-ji-huo-han-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="norm">Norm</h2><p>å½’ä¸€åŒ–ç­–ç•¥ä¸»è¦æ˜¯ä¸ºäº†åŠ å¼ºç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šæ€§ï¼Œå…·ä½“æ¥è¯´å¯ä»¥å½’çº³ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š- <strong>åŠ é€Ÿæ”¶æ•›</strong>ï¼šå½’ä¸€åŒ–å¯ä»¥å‡å°‘å†…éƒ¨åå˜é‡åç§»ï¼ˆinternalcovariateshiftï¼‰ä»¥ä½¿å¾—è¾“å…¥æ•°æ®çš„åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­ä¸ç”¨å†è€ƒè™‘æ•°æ®åˆ†å¸ƒçš„å½±å“ï¼Œå°¤å…¶æ˜¯åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ˜¯çš„æ¨¡å‹å¯ä»¥å¿«é€Ÿé€‚åº”ï¼Œæ”¶æ•›æ›´å¿«ã€‚-<strong>ç¨³å®šæ€§</strong>ï¼šå½’ä¸€åŒ–ç­–ç•¥å¯ä»¥ä½¿å¾—æ¢¯åº¦æ›´åŠ ç¨³å®šï¼Œå‡å°‘äº†æ¢¯åº¦çˆ†ç‚¸å’Œæ¢¯åº¦æ¶ˆå¤±çš„å¯èƒ½æ€§ã€‚-<strong>ç¼“è§£è¿‡æ‹Ÿåˆ</strong>ï¼šå½’ä¸€åŒ–å¸¦æœ‰æ­£åˆ™åŒ–æ•ˆæœï¼ˆç”±äºæ‰¹æ¬¡çš„éšæœºæ€§å¼•å…¥äº†å™ªå£°ï¼‰ï¼Œå¯¹è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„åˆ†å¸ƒå·®å¼‚è¿›è¡Œçº¦æŸï¼Œä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸Šçš„è¡¨ç°æ›´åŠ ä¸€è‡´ï¼Œç¼“è§£è¿‡æ‹Ÿåˆã€‚</p><h3 id="nlpä¸­çš„norm">NLPä¸­çš„Norm</h3><p>å¯¹äºæ‰¹é‡å¤§å°ä¸ºBï¼Œåºåˆ—é•¿åº¦ä¸ºLï¼Œéšè—ç»´åº¦ä¸ºHçš„è¾“å…¥ï¼š #### LayerNormè®¡ç®—æ¯ä¸€å±‚ä¸­æ‰€æœ‰æ¿€æ´»å€¼çš„å‡å€¼ ğ å’Œæ–¹å·®ğˆï¼Œä»è€Œé‡æ–°è°ƒæ•´æ¿€æ´»å€¼çš„ä¸­å¿ƒå’Œç¼©æ”¾æ¯”ä¾‹: $$\mu = \frac{1}{H} \sum_{i=1}^{H} x_{i}$$$$\sigma = \sqrt{\frac{1}{H} \sum_{i=1}^{H} (x_{i} - \mu)^{2}}$$$$LayerNorm(x) = \frac{x - \mu}{\sigma}\cdot\gamma + \beta$$ å…¶ä¸­<span class="math inline">\(x\)</span>æ˜¯å•ä¸ªè¯å…ƒçš„æ¿€æ´»å€¼ï¼Œ<span class="math inline">\(x_{i}\)</span>æ˜¯ç´¢å¼•iä¸Šçš„æ•°å€¼ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒLayerNormçš„è®¡ç®—æ˜¯æ²¿ç€Hç»´åº¦è¿›è¡Œçš„ï¼Œå¯¹æ¯ä¸€å±‚çš„è¯å…ƒå‘é‡è¿›è¡Œå½’ä¸€åŒ–ã€‚</p><h4 id="rmsnorm">RMSNorm</h4><p>ä¸ºäº†æé«˜å±‚å½’ä¸€åŒ–çš„è®­ç»ƒé€Ÿåº¦ï¼ŒRMSNormä»…åˆ©ç”¨æ¿€æ´»å€¼æ€»å’Œçš„å‡æ–¹æ ¹ RMS(ğ’™)å¯¹æ¿€æ´»å€¼è¿›è¡Œé‡æ–°ç¼©æ”¾ã€‚ $$RMS(x) = \sqrt{\frac{1}{H} \sum_{i=1}^{H} x_{i}^{2}}$$$$RMSNorm(x) = \frac{x}{RMS(x)}\cdot\gamma$$ #### DeepNorm DeepNorm åœ¨ LayerNormçš„åŸºç¡€ä¸Šï¼Œåœ¨æ®‹å·®è¿æ¥ä¸­å¯¹ä¹‹å‰çš„æ¿€æ´»å€¼ ğ’™ æŒ‰ç…§ä¸€å®šæ¯”ä¾‹ ğ›¼è¿›è¡Œæ”¾ç¼©ã€‚é€šè¿‡è¿™ä¸€ç®€å•çš„æ“ä½œï¼ŒTransformer çš„å±‚æ•°å¯ä»¥è¢«æˆåŠŸåœ°æ‰©å±•è‡³ 1,000å±‚,è¿›è€Œæœ‰æ•ˆæå‡äº†æ¨¡å‹æ€§èƒ½ä¸è®­ç»ƒç¨³å®šæ€§ã€‚ $$DeepNorm(x) = LayerNorm(\alpha\cdot x + sublayer(x)) $$å…¶ä¸­sublayer(x)æ˜¯æ®‹å·®è¿æ¥ä¸­çš„å‰é¦ˆç¥ç»ç½‘ç»œæˆ–è€…æ³¨æ„åŠ›å—ã€‚</p><h3 id="cvä¸­çš„norm">CVä¸­çš„Norm</h3><p>å‡è®¾è¾“å…¥ä¸ºB,H,W,Cï¼Œå…¶ä¸­Bæ˜¯batch sizeï¼ŒHå’ŒWæ˜¯ç©ºé—´ç»´åº¦ï¼ŒCæ˜¯é€šé“æ•°ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250322003312.png">#### BatchNormè·¨æ ·æœ¬çš„å½’ä¸€åŒ–ï¼šé’ˆå¯¹æ¯ä¸ªç¥ç»å…ƒï¼Œä½¿æ•°æ®åœ¨è¿›å…¥æ¿€æ´»å‡½æ•°ä¹‹å‰ï¼Œæ²¿ç€é€šé“è®¡ç®—æ¯ä¸ªbatchçš„å‡å€¼ã€æ–¹å·®ï¼Œâ€˜å¼ºè¿«â€™æ•°æ®ä¿æŒå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1çš„æ­£æ€åˆ†å¸ƒã€‚</p><h4 id="layernorm">LayerNorm</h4><p>å•ä¸ªæ ·æœ¬è·¨é€šé“çš„å½’ä¸€åŒ–:å¯¹å•ä¸ªæ ·æœ¬ï¼Œè®¡ç®—æ‰€æœ‰é€šé“åœ¨ä¸€èµ·çš„å‡å€¼ã€æ–¹å·®ï¼Œç„¶åè·¨é€šé“è¿›è¡Œå½’ä¸€åŒ–ã€‚</p><h4 id="instancenorm">InstanceNorm</h4><p>å•ä¸ªæ ·æœ¬å•é€šé“çš„å½’ä¸€åŒ–ï¼šå¯¹å•ä¸ªæ ·æœ¬ï¼Œè®¡ç®—å•é€šé“çš„å‡å€¼ã€æ–¹å·®ï¼Œç„¶åæŒ‰ç…§é€šé“å„è‡ªè¿›è¡Œå½’ä¸€åŒ–ã€‚</p><h4 id="groupnorm">GroupNorm</h4><p>å°†é€šé“åˆ†ç»„ï¼Œæ¯ä¸ªç»„å†…è®¡ç®—å‡å€¼ã€æ–¹å·®ï¼Œç„¶åç»„å†…å½’ä¸€åŒ–ã€‚</p><p><strong>InstanceNormå’ŒGroupNormå¸¸ç”¨äºå›¾åƒé£æ ¼è¿ç§»</strong></p><h3 id="ln-åœ¨cvå’Œnlpä¸­çš„åŒºåˆ«">LN åœ¨CVå’ŒNLPä¸­çš„åŒºåˆ«</h3><p>CVä¸­çš„LNæ˜¯å•ä¸ªæ ·æœ¬æŒ‰ç…§Cã€Hã€Wå…±åŒè®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼Œè€ŒNLPä¸­çš„LNæ˜¯å•ä¸ªè¯å…ƒæŒ‰ç…§Hç»´åº¦è®¡ç®—å‡å€¼å’Œæ–¹å·®ã€‚å¯ä»¥çœ‹å‡ºï¼ŒNLPä¸­çš„LNå½’ä¸€åŒ–çš„ç²’åº¦æ¯”CVä¸­çš„LNæ›´ç»†ã€‚</p><p>å¦‚æœæŠŠCVä¸­çš„è¾“å…¥BxCxï¼ˆHxWï¼‰ç±»æ¯”NLPä¸­çš„è¾“å…¥BxLxHï¼Œé‚£ä¹ˆCVä¸­çš„IntanceNormæ‰ç›¸å½“äºNLPä¸­çš„LNã€‚### ä¸ºä»€ä¹ˆNLPä¸­ä¸ç”¨BN BNéš¾ä»¥å¤„ç†å¯å˜é•¿åº¦çš„åºåˆ—æ•°æ®å’Œå°æ‰¹æ¬¡æ•°æ®ã€‚ -å¯å˜é•¿åº¦çš„åºåˆ—æ•°æ®:BNå¯¹äºä¸åŒé•¿åº¦çš„åºåˆ—æ•°æ®ä¸­çš„å¡«å……éƒ¨åˆ†ï¼Œä¼šè®¡ç®—å‡ºé”™è¯¯çš„å‡å€¼å’Œæ–¹å·®ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚-å°æ‰¹æ¬¡æ•°æ®:BNéœ€è¦è¾ƒå¤§çš„æ‰¹æ¬¡å¤§å°æ‰èƒ½è·å¾—ç¨³å®šçš„å‡å€¼å’Œæ–¹å·®ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œè€Œtransformerä¸­ä¸€èˆ¬batchsizeè¾ƒå°ï¼Œæ‰€ä»¥BNæ•ˆæœä¸å¥½ã€‚</p><p>LNåˆ™æ²¡æœ‰è¿™äº›é—®é¢˜ï¼Œå› ä¸ºLNæ˜¯æ²¿ç€Hç»´åº¦è®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼Œä¸åºåˆ—é•¿åº¦æ— å…³ï¼Œå› æ­¤å¯ä»¥å¤„ç†å¯å˜é•¿åº¦çš„åºåˆ—æ•°æ®å’Œå°æ‰¹æ¬¡æ•°æ®ã€‚</p><h3 id="ä¸ºä»€ä¹ˆcvä¸­bnæ¯”lnæ›´å¸¸ç”¨">ä¸ºä»€ä¹ˆCVä¸­BNæ¯”LNæ›´å¸¸ç”¨</h3><ul><li>æ‰¹æ¬¡å¤§å°ï¼šCVä¸­ä¸€èˆ¬batch sizeè¾ƒå¤§ï¼ŒBNæ•ˆæœè¾ƒå¥½ã€‚</li><li>å·ç§¯æ“ä½œï¼šå·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ä¸­çš„å·ç§¯æ“ä½œé€šå¸¸åœ¨ç©ºé—´ç»´åº¦ä¸Šå…±äº«æƒé‡ï¼ŒBNå¯ä»¥åœ¨æ¯ä¸ªé€šé“ä¸Šè¿›è¡Œå½’ä¸€åŒ–ï¼Œè¿™ä¸å·ç§¯æ“ä½œçš„ç‰¹æ€§ç›¸åŒ¹é…ã€‚</li></ul><h2 id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h2><h3 id="æ¿€æ´»å‡½æ•°åº”è¯¥å…·å¤‡å“ªäº›ç‰¹æ€§">æ¿€æ´»å‡½æ•°åº”è¯¥å…·å¤‡å“ªäº›ç‰¹æ€§ï¼Ÿ</h3><ul><li>å¿…é¡»<ul><li>éçº¿æ€§</li><li>å®šä¹‰åŸŸå…¨ä½“å®æ•°</li><li>å‡ ä¹å¤„å¤„å¯å¾®ï¼Œæœ€å¥½å¯¼æ•°è®¡ç®—ç®€å•</li></ul></li><li>æœ€å¥½æœ‰<ul><li>éé¥±å’Œï¼Œé˜²æ­¢å‡ºç°æ¢¯åº¦å¯¹æ•°æ®å˜åŒ–ä¸æ•æ„Ÿï¼Œå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±ï¼Œä½†æœ‰åä¾‹ï¼šsigmoid/tanh</li><li>æ— ä¸Šç•Œæœ‰ä¸‹ç•Œï¼šæ— ä¸Šç•ŒåŒä¸Šï¼Œæœ‰ä¸‹ç•Œæœ‰åŠ©äºæ­£åˆ™æ•ˆæœã€‚</li><li>å•è°ƒï¼Œå¯¼æ•°ç¬¦å·ä¸å˜ï¼Œæ¢¯åº¦æ›´æ–°æ–¹å‘ç¨³å®šï¼Œä½†æœ‰åä¾‹ï¼šGELU</li><li>å¸¦æœ‰éé›¶è´Ÿå€¼æ¢¯åº¦ï¼Œæ¢¯åº¦æ›´æ–°æ•ˆç‡å¿«ï¼Œ ä½†æœ‰åä¾‹ï¼šReLU</li></ul></li></ul><h3 id="å¸¸è§æ¿€æ´»å‡½æ•°">å¸¸è§æ¿€æ´»å‡½æ•°</h3><ul><li>Sigmoid/tanhæ¢¯åº¦é¥±å’Œé—®é¢˜ï¼Œsigmoidçš„èŒƒå›´åœ¨0-1ä¸­ï¼Œåœ¨ä¸€äº›éœ€è¦é¢„æµ‹ç»“æœä¹Ÿåœ¨0-1çš„ä»»åŠ¡ä¸­ç”¨ï¼Œæ¯”å¦‚bboxçš„åç§»é¢„æµ‹ã€‚</li><li>ReLU å¸¦æœ‰éé›¶è´Ÿå€¼æˆ–è€…åŸç‚¹å¹³æ»‘çš„ç‰ˆæœ¬ï¼š<ul><li>LeakyReLU</li><li>SiLU: x*sigmoid(x)</li><li>Swishï¼šx * (1 / (1 + np.exp(-beta * x)))ï¼Œbeta=1æ—¶å°±æ˜¯SiLUï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿç›´æ¥æŠŠSiLUä½œä¸ºSwishã€‚</li><li>GELUï¼š x*norm.cdf(x)ï¼Œcdfä¸ºæ ‡å‡†çŠ¶æ€å‘å¸ƒçš„åˆ†å¸ƒå‡½æ•°ï¼Œå¾€å·¦è¶‹äº0ï¼Œå¾€å³è¶‹äº1ã€‚</li><li>Mishï¼šx*tanh(ln(1+epx(x)))</li></ul></li><li>GLUï¼ˆé—¨æ§çº¿æ€§å•å…ƒï¼‰: sigmoid(W1(x)) é€å…ƒç´ ä¹˜ä»¥W2(x)-----------ä¸¤ä¸ªä¸åŒçš„çº¿æ€§å±‚ï¼Œä¸‰ä¸ªæƒé‡çŸ©é˜µï¼ˆxç»è¿‡SwiGluåå†è¿‡ä¸€ä¸ªçº¿æ€§å±‚ï¼Œæ€»å…±ä¸‰ä¸ªæƒé‡çŸ©é˜µã€‚ç”±äºåŸå§‹FFNä¸­å‚æ•°é‡ä¸º8h<sup>2ï¼ˆä¸¤ä¸ªçº¿æ€§å±‚ï¼Œæ¯ä¸ª4h</sup>2ï¼‰,æ”¹ä¸ºSwiGLUåçš„å•ä¸ªæƒé‡å¤§å°ä¸º8h^2/3ã€‚ï¼‰<ul><li>SwiGLU: GLUä¸­çš„æ¿€æ´»å‡½æ•°å˜ä¸ºSwish</li><li>GeGLU: GLUä¸­çš„æ¿€æ´»å‡½æ•°å˜ä¸ºGELU</li></ul></li><li>softmax å¤šåˆ†ç±»é—®é¢˜ï¼ˆè½¬ä¸ºä¸åŒç±»åˆ«çš„æ¦‚ç‡ï¼‰</li></ul><blockquote><p>å¤§æ¨¡å‹ä¸­ä½¿ç”¨SwiGLUçš„å¥½å¤„ï¼ˆé™¤äº†ç±»ä¼¼ReLUçš„å¥½å¤„ï¼‰ï¼šå¹¶è¡Œè®¡ç®—ï¼šsigmoid(W1(x))å’Œ W2(x) å¯ä»¥å¹¶è¡Œè®¡ç®—ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> LayerNorm </tag>
            
            <tag> BatchNorm </tag>
            
            <tag> RMSNorm </tag>
            
            <tag> GLU </tag>
            
            <tag> SwiGLU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-é«˜çº§ä¼˜åŒ–æ–¹æ³•ä¸“é¢˜</title>
      <link href="/2025/03/13/da-mo-xing-dong-li-yin-qing-gao-ji-you-hua-fang-fa-zhuan-ti/"/>
      <url>/2025/03/13/da-mo-xing-dong-li-yin-qing-gao-ji-you-hua-fang-fa-zhuan-ti/</url>
      
        <content type="html"><![CDATA[<h2 id="è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ">è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ</h2><p>NVIDIAä»Voltaæ¶æ„ä¹‹åå°±å¢åŠ äº†ä¸“é—¨ç”¨äºåŠ é€ŸçŸ©é˜µä¹˜æ³•å’Œç´¯åŠ æ“ä½œçš„TensorCoreç¡¬ä»¶å•å…ƒï¼Œåœ¨åŠç²¾åº¦ç”šè‡³æ›´ä½ç²¾åº¦è®¡ç®—ä»»åŠ¡ä¸­ç›¸æ¯”ä¼ ç»ŸCUDAæ ¸å¿ƒå¯ä»¥å®ç°æ•°å€åŠ é€Ÿã€‚</p><p>ç»“åˆæ··åˆç²¾åº¦çš„è®­ç»ƒæ–¹æ³•å¯ä»¥åœ¨å……åˆ†åˆ©ç”¨ä½ç²¾åº¦ä¼˜ç§€çš„è®¡ç®—æ€§èƒ½å’Œæ˜¾å­˜å ç”¨çš„åŒæ—¶ï¼Œä¿æŒä¸å•ç²¾åº¦è®­ç»ƒç›¸è¿‘çš„æ¨¡å‹ç²¾åº¦ã€‚</p><h3 id="æµ®ç‚¹æ•°çš„è¡¨ç¤º">æµ®ç‚¹æ•°çš„è¡¨ç¤º</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313235546.png"></p><p>å¯ä»¥ç›´è§‚çš„çœ‹å‡ºæ•°å€¼èŒƒå›´ä¸»è¦ç”±æŒ‡æ•°éƒ¨åˆ†å†³å®šã€‚è€Œç²¾åº¦ä¸»è¦ç”±å°¾æ•°çš„ä½æ•°å†³å®šã€‚</p><p>å†çœ‹ä¸€ä¸‹å¯¹äºFP16æ¥è¯´ï¼Œä¸åŒæŒ‡æ•°ä½ä¸‹çš„æ•°å€¼èŒƒå›´å’Œç²¾åº¦æƒ…å†µï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250314000155.png"></p><p>æ³¨æ„åœ¨åŒä¸€æŒ‡æ•°æ¡£ä½ä¸­ï¼Œä¸åŒçš„å°¾æ•°å°±ç›¸å½“äºåœ¨è¯¥æ¡£ä½çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¸­é—´å‡ç­‰åœ°æ’å…¥è‹¥å¹²å¯ä»¥è¡¨ç¤ºçš„æ•°å­—ã€‚å½“æˆ‘ä»¬æƒ³è¦æ‰¾åˆ°ä¸€ä¸ªå®æ•°çš„å¯¹åº”è¡¨ç¤ºæ—¶ï¼Œå¿…é¡»æ‰¾åˆ°ç¦»è‡ªå·±æœ€è¿‘çš„å¯ä»¥è¡¨ç¤ºçš„æ•°å­—ã€‚æ¯”å¦‚float16çš„å°¾æ•°ä¼šåœ¨æ¯ä¸ªæ¡£ä½ä¸­æ’å…¥1024ä¸ªæ•°å­—ï¼Œè¿™æ ·<span class="math inline">\(2^{6}\)</span>å’Œ<span class="math inline">\(2^{7}\)</span>ä¹‹é—´çš„æ•°å­—é—´éš”ä¸º <span class="math inline">\(2^{6} / 1024 =0.0625\)</span>ã€‚æ‰€ä»¥è½åœ¨è¿™ä¸ªæ¡£ä½ä¸­çš„ä¸¤ä¸ªå®æ•°ï¼Œå¦‚æœå·®å¼‚åœ¨0.0625ä»¥ä¸‹åˆ™ä¼šè¢«è¡¨ç¤ºæˆåŒä¸€ä¸ªfloat16æ•°å­—ï¼Œè¿™å°±æ˜¯å°¾æ•°å¯¹æ•°å€¼ç²¾åº¦çš„å½±å“ã€‚</p><p>å› æ­¤åœ¨åŒä¸€ç§ç²¾åº¦ä¸‹ï¼Œåœ¨æŒ‡æ•°æ¡£ä½å°çš„æ—¶å€™ç²¾åº¦ä¼šæ›´é«˜äº›ï¼ˆåœ¨æ›´å°çš„èŒƒå›´ä¸­é—´æ’å…¥ç›¸åŒçš„æ•°é‡çš„æ•°å­—ï¼‰ã€‚</p><h3 id="ä½¿ç”¨ä½ç²¾åº¦æ•°æ®ç±»å‹çš„ä¼˜ç¼ºç‚¹">ä½¿ç”¨ä½ç²¾åº¦æ•°æ®ç±»å‹çš„ä¼˜ç¼ºç‚¹</h3><h4 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h4><ul><li>è®¡ç®—æ•ˆç‡æ›´é«˜ï¼š16ä½æµ®ç‚¹æ•°çš„è®¡ç®—é€Ÿåº¦é€šå¸¸æ˜¯32ä½æµ®ç‚¹æ•°çš„ä¸¤å€ã€‚</li><li>å­˜å‚¨ç©ºé—´æ›´å°‘ï¼š16ä½æµ®ç‚¹æ•°ä»…éœ€32ä½æµ®ç‚¹æ•°ä¸€åŠçš„å­˜å‚¨ç©ºé—´ã€‚</li><li>ä¼ è¾“é€Ÿåº¦æ›´å¿«ï¼šè¾ƒå°çš„å­˜å‚¨éœ€æ±‚æ„å‘³ç€åœ¨ç›¸åŒæ—¶é—´å†…ä¼ è¾“æ›´å°‘çš„æ•°æ®é‡ï¼Œè¿™ä¸ä»…èƒ½åŠ é€Ÿç¡¬ç›˜è¯»å†™é€Ÿåº¦ï¼Œä¹Ÿæœ‰åŠ©äºæé«˜å†…å­˜ã€æ˜¾å­˜ä»¥åŠå¤šçº§ç¼“å­˜çš„è¯»å†™æ•ˆç‡ã€‚</li></ul><h4 id="ç¼ºç‚¹">ç¼ºç‚¹</h4><ul><li>æ•°å€¼èŒƒå›´å’Œç²¾åº¦çš„é™åˆ¶ï¼šfloat16çš„æ•°å€¼èŒƒå›´å’Œç²¾åº¦è¾ƒä½ã€‚</li><li>é¢å¤–çš„æ•°å€¼è½¬æ¢å¼€é”€ï¼šå¹¶éæ‰€æœ‰è®¡ç®—æ“ä½œéƒ½é€‚åˆä½¿ç”¨float16ï¼Œè€Œåœ¨float32ä¸float16ä¹‹é—´çš„æ•°æ®è½¬æ¢å¯èƒ½ä¼šäº§ç”Ÿé¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚</li><li>éœ€è¦ç‰¹å®šç¡¬ä»¶æ”¯æŒï¼šä¸ºäº†å……åˆ†åˆ©ç”¨float16çš„ä¼˜åŠ¿ï¼Œå¿…é¡»é…å¤‡æ”¯æŒåŠç²¾åº¦è¿ç®—åŠ é€Ÿçš„ç¡¬ä»¶ï¼Œå¦‚NVIDIAçš„AIè®¡ç®—å¡æˆ–RTX30ç³»åˆ—ä»¥ä¸Šçš„æ˜¾å¡ã€‚åœ¨è€æ—§æˆ–ä¸æ”¯æŒfloat16è®¡ç®—çš„GPUä¸Šï¼Œä¸ä»…æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œè¿˜å¯èƒ½å› æ•°æ®è½¬æ¢çš„é¢å¤–å¼€é”€è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li></ul><h3 id="pytorchçš„è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ">PyTorchçš„è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ</h3><p>ä½¿ç”¨FP16åœ¨è®­ç»ƒæ—¶ä¼šå‡ºç°çš„é—®é¢˜ï¼š -è®­ç»ƒåˆæœŸæ³¢åŠ¨å¤§ï¼Œå®¹æ˜“æ•°å€¼æº¢å‡ºï¼Œå®¹æ˜“å‡ºç°NaNæˆ–Infã€‚ -å¸Œæœ›èƒ½å¤Ÿè‡ªåŠ¨åˆ¤æ–­å“ªäº›ç®—å­é€‚åˆä½¿ç”¨float16åŠ é€Ÿï¼Œå¹¶è‡ªåŠ¨å¯¹è¿™äº›ç®—å­çš„è¾“å…¥è¾“å‡ºå¼ é‡è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><p>PyTorchæä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼š<code>torch.autocast</code>å’Œ<code>torch.cuda.amp.GradScaler</code>ã€‚</p><p><strong>torch.autocast</strong>å¯ä»¥æ ¹æ®ç®—å­ç±»å‹ï¼Œè‡ªåŠ¨é€‰æ‹©ä½¿ç”¨åŠç²¾åº¦(float16)æˆ–å•ç²¾åº¦(float32)è¿›è¡Œè®¡ç®—ï¼Œä»¥é€‚åº”ä¸åŒç®—å­å¯¹ç²¾åº¦çš„è¦æ±‚ï¼Œè¾¾åˆ°è¾ƒå¥½çš„æ€§èƒ½ã€ç²¾åº¦å¹³è¡¡ã€‚</p><p><strong>torch.cuda.amp.GradScaler</strong>åˆ™ç”¨äºå¹³è¡¡å‰å‘å¼ é‡å’Œåå‘æ¢¯åº¦çš„æ•°å€¼èŒƒå›´ã€‚å…¶åŸºæœ¬åŸç†æ˜¯åˆ©ç”¨ä¸€ä¸ªæ”¾å¤§ç³»æ•°(scalefactor)ï¼Œåœ¨ä¸å¼•èµ·æ¢¯åº¦æº¢å‡ºçš„æƒ…å†µä¸‹å°½å¯èƒ½ä½¿ç”¨è¾ƒé«˜çš„æ”¾å¤§ç³»æ•°ï¼Œä»è€Œå……åˆ†åˆ©ç”¨float16çš„æ•°å€¼èŒƒå›´ã€‚è®­ç»ƒè¿‡ç¨‹ä¸­å¦‚æœæ£€æµ‹åˆ°æ¢¯åº¦æº¢å‡ºï¼ŒGradScalerä¼šè‡ªåŠ¨è·³è¿‡è¯¥æ¬¡çš„æƒé‡æ›´æ–°ï¼Œå¹¶ç›¸åº”ç¼©å°æ”¾å¤§ç³»æ•°ã€‚å¦‚æœä¸€æ®µæ—¶é—´å†…æœªå‘ç”Ÿæ¢¯åº¦æº¢å‡ºï¼ŒGradScaleråˆ™ä¼šå°è¯•å¢åŠ æ”¾å¤§ç³»æ•°ï¼Œä»¥æœ€å¤§åŒ–float16çš„æ•°å€¼èŒƒå›´åˆ©ç”¨ç‡ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport timeimport torch.nn as nnfrom torch.profiler import profile, ProfilerActivityfrom torch.optim import SGDfrom torch.utils.data import TensorDatasetclass SimpleCNN(nn.Module):    def __init__(self, input_channels):        super(SimpleCNN, self).__init__()        self.conv1 = nn.Conv2d(            input_channels, 64, kernel_size=3, stride=1, padding=1        )        self.conv2 = nn.Conv2d(64, 128, kernel_size=3, stride=1, padding=1)        self.conv3 = nn.Conv2d(128, 256, kernel_size=3, stride=1, padding=1)        self.conv4 = nn.Conv2d(256, 512, kernel_size=3, stride=1, padding=1)        self.relu = nn.ReLU()    def forward(self, x):        out = self.relu(self.conv1(x))        out = self.relu(self.conv2(out))        out = self.relu(self.conv3(out))        out = self.relu(self.conv4(out))        return outdef train(dataset, model, use_amp):    optimizer = SGD(model.parameters(), lr=0.1, momentum=0.9)    #----------------------torch.cuda.amp.GradScaler----------------------    scaler = torch.cuda.amp.GradScaler(enabled=use_amp)    for batch_data in dataset:        #----------------------torch.autocast----------------------        with torch.autocast(            device_type="cuda", dtype=torch.float16, enabled=use_amp        ):            result = model(batch_data[0])            loss = result.sum()        optimizer.zero_grad()        #----------------------torch.cuda.amp.GradScaler----------------------        scaler.scale(loss).backward()       # å¯¹lossè¿›è¡Œæ”¾å¤§        scaler.step(optimizer)             # æ›´æ–°æƒé‡        scaler.update()                    # æ›´æ–°æ”¾å¤§ç³»æ•°</code></pre><p>åœ¨æ”¯æŒFP16è®¡ç®—çš„æœºå™¨ä¸Šè¿è¡Œä»¥ä¸‹è®­ç»ƒä»£ç ï¼Œå¯ä»¥å‘ç°å¼€å¯ampåé€Ÿåº¦æé«˜ä¸€å€ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">N, C, H, W = 32, 3, 256, 256  # Example dimensionsdata = torch.randn(10, N, C, H, W, device="cuda")dataset = TensorDataset(data)model = SimpleCNN(C).to("cuda")# warm uptrain(dataset, model, use_amp=False)torch.cuda.synchronize()# æµ‹é‡æœªä½¿ç”¨AMPæ—¶çš„æ—¶é—´å’Œæ€§èƒ½å›¾è°±start_time = time.perf_counter()with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:    train(dataset, model, use_amp=False)    torch.cuda.synchronize()prof.export_chrome_trace("traces/PROF_wo_amp.json")end_time = time.perf_counter()elapsed = end_time - start_timeprint(f"Float32 Time: {elapsed} seconds")# warm uptrain(dataset, model, use_amp=True)torch.cuda.synchronize()# æµ‹é‡ä½¿ç”¨AMPåçš„æ—¶é—´å’Œæ€§èƒ½å›¾è°±start_time = time.perf_counter()with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:    train(dataset, model, use_amp=True)    torch.cuda.synchronize()prof.export_chrome_trace("traces/PROF_amp.json")end_time = time.perf_counter()elapsed = end_time - start_timeprint(f"Float16 Time: {elapsed} seconds")</code></pre>åœ¨æ€§èƒ½ç”»åƒä¸­å¯ä»¥çœ‹åˆ°æœ‰æ¯”è¾ƒæ˜æ˜¾çš„é‡å¤æ¨¡å¼ï¼Œè¿™å¯¹åº”äº†ç¨‹åºä¸­çš„10ä¸ªè¿­ä»£æ­¥éª¤ã€‚å¯ä»¥çœ‹åˆ°ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒåæ¯ä¸ªè¿­ä»£çš„æ—¶é—´ä»741msç¼©çŸ­åˆ°äº†363msï¼Œå¹¶ä¸”ä»kernelçš„åç§°å¯ä»¥è¿›ä¸€æ­¥ç¡®è®¤PyTorchè°ƒç”¨äº†float16å¯¹åº”çš„å†…æ ¸å‡½æ•°ã€‚<p></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250314011008.png"></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªåŠ¨æ··åˆç²¾åº¦åœ¨GPUä½¿ç”¨ç‡è¶Šé«˜çš„åœºæ™¯ä¸­ï¼ŒåŠ é€Ÿæ•ˆæœè¶Šæ˜æ˜¾ã€‚å¯¹äºGPUä½¿ç”¨ç‡å¾ˆä½ï¼Œ<strong>ä»¥CPUç“¶é¢ˆä¸ºä¸»çš„è®­ç»ƒè¿‡ç¨‹ï¼Œè‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒçš„æ€§èƒ½å¯èƒ½åè€Œå˜å·®</strong>â€”â€”é¢å¤–çš„æ•°æ®è½¬æ¢å¼€é”€ä¸å¯å¿½è§†ã€‚</p><h2 id="è‡ªå®šä¹‰é«˜æ€§èƒ½ç®—å­">è‡ªå®šä¹‰é«˜æ€§èƒ½ç®—å­</h2><p>ç®—å­çš„è®¡ç®—æ•ˆç‡æˆä¸ºç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œæ›´è¿›ä¸€æ­¥çš„ä¼˜åŒ–ä¼šé¢ä¸´ä¸¤ä¸ªä¸»è¦æŒ‘æˆ˜ï¼š- 1.ç¼ºå°‘å…¨å±€çš„è®¡ç®—å›¾ï¼šPyTorchä¸»è¦æä¾›åŸºç¡€ç®—å­ï¼Œä½†æ˜¯ç”±äºç¼ºå°‘å…¨å±€çš„è®¡ç®—å›¾ä¿¡æ¯æ— æ³•è‡ªåŠ¨åˆå¹¶è®¡ç®—ï¼Œè¿™ä¹Ÿæå¤§é™åˆ¶äº†PyTorchåœ¨ç®—å­å±‚é¢çš„ä¼˜åŒ–ç©ºé—´ã€‚- 2.è°ƒåº¦å¼€é”€ï¼šç”±äºåŠ¨æ€å›¾æ¨¡å¼ä¸­æ¯ä¸ªç®—å­æ˜¯ç‹¬ç«‹çš„ï¼Œå› æ­¤æ¯æ¬¡è°ƒç”¨éƒ½ä¼´éšä¸€æ¬¡è°ƒåº¦å¼€é”€ã€‚</p><p>åœ¨å¼€å‘è€…æ·±å…¥äº†è§£è®¡ç®—å›¾çš„å‰æä¸‹ï¼Œç¼–å†™è‡ªå®šä¹‰ç®—å­ä¸ä»…å¯ä»¥åˆå¹¶å¤šä¸ªç®—å­é™ä½è°ƒåº¦å¼€é”€ï¼Œè¿˜å¯ä»¥ç²¾ç»†æ§åˆ¶GPUçš„æ‰§è¡Œï¼ŒåŒ…æ‹¬çº¿ç¨‹å—çš„é…ç½®ä»¥åŠå†…å­˜è®¿é—®æ¨¡å¼ç­‰ã€‚ä»¥flash-attentionåº“ä¸ºä¾‹ï¼Œå®ƒä¸ºTransformeræ¨¡å‹ä¸­çš„è‡ªæ³¨æ„åŠ›éƒ¨åˆ†æä¾›äº†ä¸“é—¨çš„è‡ªå®šä¹‰ç®—å­ï¼Œé€šè¿‡ä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼å’Œå……åˆ†åˆ©ç”¨GPUçš„å¹¶è¡Œå¤„ç†åŠŸèƒ½æ¥æå‡è®¡ç®—æ•ˆç‡ã€‚</p><h3 id="è‡ªå®šä¹‰é«˜æ€§èƒ½ç®—å­çš„å°è£…æµç¨‹">è‡ªå®šä¹‰é«˜æ€§èƒ½ç®—å­çš„å°è£…æµç¨‹</h3><p>å®ç°ä¸€ä¸ªPyTorchè‡ªå®šä¹‰ç®—å­åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ï¼š - 1.[C++/CUDA]ç®—å­çš„å¤šåç«¯ä»£ç å®ç°ï¼Œæ¯”å¦‚CPUå®ç°ã€CUDAå®ç°ç­‰ã€‚ - 2.[Python]å°†ç®—å­æ³¨å†Œåˆ°Pythonä¸­ï¼Œé€šè¿‡Pybindå°†ç®—å­å¯¼å…¥åˆ°Pythonã€‚ - 3.[PyTorch]å°†ç®—å­æ³¨å†Œåˆ°PyTorchä¸­ï¼Œå°è£…æˆnn.Moduleä¾¿äºåœ¨PyTorchä¸­è°ƒç”¨ã€‚</p><p>åé¢ä»¥åŠ¨æ‰‹å®ç°ä¸€ä¸ªSigmoidç®—å­ä¸ºä¾‹ï¼Œä»‹ç»è‡ªå®šä¹‰ç®—å­çš„å°è£…æµç¨‹ã€‚ï¼ˆæ³¨æ„ï¼šè¿™é‡Œå®ç°çš„æ²¡æœ‰Pytorchè‡ªå¸¦çš„é«˜æ•ˆï¼Œåªæ˜¯ä¸ºäº†ä»‹ç»è‡ªå®šä¹‰ç®—å­çš„å°è£…æµç¨‹ï¼‰<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250314014946.png"></p><h4 id="è‡ªå®šä¹‰ç®—å­çš„åç«¯å®ç°">è‡ªå®šä¹‰ç®—å­çš„åç«¯å®ç°</h4><p>é¦–å…ˆæ¥å®šä¹‰Sigmoidçš„CUDAæ ¸å‡½æ•°å®ç°ï¼Œæˆ‘ä»¬å°†å…¶å†™åœ¨custom_sigmoid_cuda.cuæ–‡ä»¶ä¸­ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">// custom_sigmoid_cuda.cu#include &lt;cuda.h&gt;#include &lt;cuda_runtime.h&gt;#include &lt;torch/extension.h&gt;    // Pytorchä¸ºè‡ªå®šä¹‰ç®—å­æä¾›çš„ä¸€ç³»åˆ—é¢„ç½®å‡½æ•°å’Œæ¥å£#include &lt;iostream&gt;#include &lt;vector&gt;template &lt;typename scalar_t&gt;__global__ void sigmoid_kernel(const scalar_t *__restrict__ input_tensor_data,                               scalar_t *__restrict__ output_tensor_data,                               size_t total_num_elements) {    // è®¡ç®—è¦å¤„ç†çš„å…ƒç´ ä½ç½®    const int element_index = blockIdx.x * blockDim.x + threadIdx.x;    if (element_index &lt; total_num_elements) {        // åœ¨å•ä¸ªå…ƒç´ ä¸Šè¿›è¡Œsigmoidè®¡ç®—        scalar_t x = input_tensor_data[element_index];        scalar_t y = 1.0 / (1.0 + exp(-x));        // å°†è®¡ç®—ç»“æœå†™å›æ˜¾å­˜        output_tensor_data[element_index] = y;    }}</code></pre>ç®€å•æ¥è¯´è¿™é‡Œçš„sigmoid_kernelå‡½æ•°å¯ä»¥è¯»å–è¾“å…¥å¼ é‡çš„æ˜¾å­˜åœ°å€ï¼Œè¿›è¡Œè¿ç®—åï¼Œå†å°†ç»“æœå†™å…¥è¾“å‡ºå¼ é‡çš„æ˜¾å­˜åœ°å€ä¸­ã€‚è¿™é‡Œæ¨¡ç‰ˆçš„ä½œç”¨ä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿æ”¯æŒä¸åŒç±»å‹çš„æ•°æ®ã€‚<p></p><p>æ¥ä¸‹æ¥è¦å¯¹å®šä¹‰çš„æ ¸å‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥çš„å°è£…ï¼Œè®©å®ƒèƒ½æ¥å—å¹¶è¿”å›torch::Tensorï¼Œè¿™é‡Œtorch::Tensorå°±æ˜¯PyTorchæä¾›çš„C++å±‚é¢çš„å¼ é‡ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">// custom_sigmoid_cuda.cutorch::Tensor custom_sigmoid_cuda_forward(torch::Tensor input) {    size_t total_num_elements = input.numel();    auto output = torch::zeros_like(input);    // é…ç½®CUDAçº¿ç¨‹æ•°å’Œçº¿ç¨‹å—æ•°    const int threads = 512;    const int blocks = (total_num_elements + threads - 1) / threads;    // å°†å®ç°å¥½çš„CUDA kernelæ³¨å†Œä¸ºå‰å‘ç®—å­çš„CUDAåç«¯å®ç°    AT_DISPATCH_FLOATING_TYPES(        input.type(), "sigmoid_kernel", ([&amp;] {            sigmoid_kernel&lt;scalar_t&gt;&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;(                input.data&lt;scalar_t&gt;(), output.data&lt;scalar_t&gt;(),                total_num_elements);        }));    return output;}</code></pre>è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸ºcustom_sigmoid_cuda_forwardçš„å°è£…å‡½æ•°ï¼Œä¸»è¦é€»è¾‘æ˜¯å°†æ•°æ®ä»è¾“å…¥å¼ é‡ä¸­åŠ è½½ï¼Œé…ç½®å¥½CUDAçº¿ç¨‹æ•°å’Œçº¿ç¨‹å—æ•°ä¹‹åï¼Œè°ƒç”¨ä¹‹å‰å†™å¥½çš„sigmoid_kernelé€ä¸ªå…ƒç´ è¿›è¡ŒSigmoidæ“ä½œï¼Œå†å°†ç»“æœå†™åˆ°è¾“å‡ºå¼ é‡outputä¸­ã€‚è¿™é‡ŒAT_DISPATCH_FLOATING_TYPESæ˜¯torch/extension.hä¸­æä¾›çš„è¾…åŠ©å‡½æ•°ï¼Œå®ƒä¼šæ ¹æ®è¾“å…¥å¼ é‡çš„åŠ¨æ€ç±»å‹ï¼Œè‡ªåŠ¨æ‰¾åˆ°å¹¶è°ƒç”¨ç›¸åº”sigmoid_kernel<t>çš„æ¨¡æ¿å®ç°ã€‚<p></p><p>åå‘ä¼ æ’­çš„æ ¸å‡½æ•°å’Œå°è£…ç±»ä¼¼ï¼š </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">// custom_sigmoid_cuda.cutemplate &lt;typename scalar_t&gt;__global__ void sigmoid_grad_kernel(    const scalar_t *__restrict__ output_tensor,    const scalar_t *__restrict__ output_grad_tensor,    scalar_t *__restrict__ input_grad_tensor, size_t total_num_elements) {    // è®¡ç®—è¦å¤„ç†çš„å…ƒç´ ä½ç½®    const int element_index = blockIdx.x * blockDim.x + threadIdx.x;    if (element_index &lt; total_num_elements) {        // åœ¨å•ä¸ªå…ƒç´ ä¸Šè¿›è¡Œsigmoidçš„æ¢¯åº¦è®¡ç®—        scalar_t output_grad = output_grad_tensor[element_index];        scalar_t output = output_tensor[element_index];        scalar_t input_grad = (1.0 - output) * output * output_grad;        // å°†è®¡ç®—ç»“æœå†™å›æ˜¾å­˜        input_grad_tensor[element_index] = input_grad;    }}torch::Tensor custom_sigmoid_cuda_backward(torch::Tensor output,                                           torch::Tensor output_grad) {    size_t total_num_elements = output_grad.numel();    auto input_grad = torch::zeros_like(output_grad);    const int threads = 512;    const int blocks = (total_num_elements + threads - 1) / threads;    // å°†å®ç°å¥½çš„CUDA kernelæ³¨å†Œä¸ºåå‘ç®—å­çš„CUDAåç«¯å®ç°    AT_DISPATCH_FLOATING_TYPES(        output_grad.type(), "sigmoid_grad_kernel", ([&amp;] {            sigmoid_grad_kernel&lt;scalar_t&gt;&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;(                output.data&lt;scalar_t&gt;(), output_grad.data&lt;scalar_t&gt;(),                input_grad.data&lt;scalar_t&gt;(), total_num_elements);        }));    return input_grad;}</code></pre><p></p><h4 id="è‡ªå®šä¹‰ç®—å­å¯¼å…¥python">è‡ªå®šä¹‰ç®—å­å¯¼å…¥Python</h4><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå®ç°äº†Sigmoidç®—å­çš„CUDAåç«¯ä»£ç ï¼Œç”¨ç±»ä¼¼çš„æ–¹æ³•è¿˜å¯ä»¥å®ç°Sigmoidçš„CPUæˆ–è€…å…¶ä»–åç«¯ä»£ç ã€‚ä½†æ˜¯æˆ‘ä»¬<strong>æœ€ç»ˆéœ€è¦æ ¹æ®Pythonä¸­çš„torch.deviceæ¥å†³å®šè°ƒç”¨å“ªä¸ªåç«¯çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å®ç°ä¸€å±‚ä»£ç åˆ†å‘çš„æœºåˆ¶</strong>ã€‚ä¸‹é¢çš„ä»£ç æ˜¯ä¸€ä¸ªç®€æ˜“çš„SigmoidCPUåç«¯çš„å®ç°ï¼Œå¹¶ä¸”ä¼šæ ¹æ®è¾“å…¥å¼ é‡çš„åç«¯æ¥å†³å®šè°ƒç”¨ç®—å­çš„CUDAå®ç°æˆ–æ˜¯CPUå®ç°ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">// custom_sigmoid.cpp#include &lt;torch/extension.h&gt;#include &lt;iostream&gt;#include &lt;vector&gt;// forward declarations or include the headertorch::Tensor custom_sigmoid_cuda_forward(torch::Tensor input);torch::Tensor custom_sigmoid_cuda_backward(torch::Tensor output,                                           torch::Tensor output_grad);// ç®€æ˜“çš„sigmoidå‰å‘ç®—å­çš„CPUåç«¯å®ç°torch::Tensor custom_sigmoid_cpu_forward(torch::Tensor input) {    return 1.0 / (1 + torch::exp(-input));}// ç®€æ˜“çš„sigmoidåå‘ç®—å­çš„CPUåç«¯å®ç°torch::Tensor custom_sigmoid_cpu_backward(torch::Tensor output,                                          torch::Tensor output_grad) {    return (1 - output) * output * output_grad;}// è¿›è¡Œå‰å‘ç®—å­çš„åç«¯å®ç°åˆ†å‘torch::Tensor custom_sigmoid_forward(torch::Tensor input) {    TORCH_CHECK(input.is_contiguous(), "input must be contiguous")    if (input.device().is_cuda()) {        return custom_sigmoid_cuda_forward(input);    } else {        return custom_sigmoid_cpu_forward(input);    }}// è¿›è¡Œåå‘ç®—å­çš„åç«¯å®ç°åˆ†å‘torch::Tensor custom_sigmoid_backward(torch::Tensor output,                                      torch::Tensor grad_output) {    TORCH_CHECK(grad_output.is_contiguous(), "input must be contiguous")    if (output.device().is_cuda()) {        return custom_sigmoid_cuda_backward(output, grad_output);    } else {        return custom_sigmoid_cpu_backward(output, grad_output);    }}PYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {    // æ³¨å†Œç®—å­ä»¥ä¾¿åœ¨Pythonä¸­è°ƒç”¨    m.def("sigmoid_fwd", &amp;custom_sigmoid_forward, "Custom sigmoid forward");    m.def("sigmoid_bwd", &amp;custom_sigmoid_backward, "Custom sigmoid backward");}</code></pre>è¿™é‡Œæˆ‘ä»¬ç”¨custom_sigmoid_forwardä»¥åŠcustom_sigmoid_backwardåšäº†ä¸€å±‚ç®€å•çš„ç»“åˆåˆ†å‘çš„å°è£…ï¼Œç„¶åè°ƒç”¨<strong>PYBIND11_MODULE</strong>å°†å…¶æ³¨å†Œåˆ°Pythonä¸­ï¼Œæ–¹ä¾¿åç»­åœ¨Pythonä»£ç ä¸­è°ƒç”¨C++ä»£ç ä¸­å®šä¹‰çš„ç®—å­ã€‚<p></p><h4 id="è‡ªå®šä¹‰ç®—å­å¯¼å…¥pytorch">è‡ªå®šä¹‰ç®—å­å¯¼å…¥PyTorch</h4><p>ä¸ºäº†èƒ½æœ€ç»ˆåœ¨PyTorchä¸­ä½¿ç”¨æˆ‘ä»¬ç¼–å†™çš„ç®—å­ï¼Œè¿˜éœ€è¦å†™ä¸€ä¸ªsetup.pyæ–‡ä»¶æ¥ç¼–è¯‘å¹¶æœ€ç»ˆä»¥Pythonæ¨¡å—çš„å½¢å¼ï¼Œå¯¼å…¥åˆ°PyTorchä¸­ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># setup.pyfrom setuptools import setupfrom torch.utils.cpp_extension import BuildExtension, CppExtensionsetup(    name="custom_ops",    ext_modules=[        CppExtension(            "custom_ops",            [                "custom_sigmoid.cpp",                "custom_sigmoid_cuda.cu",            ],            extra_compile_args={"cxx": ["-g"], "nvcc": ["-O2"]},        )    ],    cmdclass={"build_ext": BuildExtension},)</code></pre> ä½¿ç”¨ä¸‹é¢å‘½ä»¤å°±å¯ä»¥ç¼–è¯‘è‡ªå®šä¹‰çš„Pythonæ¨¡å—custom_opsï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python setup.py install</code></pre>æˆ‘ä»¬è¿›ä¸€æ­¥å°†è‡ªå®šä¹‰çš„Sigmoidç®—å­ä½œä¸ºtorch.nn.Moduleå¯¼å…¥åˆ°PyTorchä¸­ï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python"># custom_sigmoid_op.pyimport torchfrom torch.autograd import Function# custom_ops ä¾¿æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„Pythonæ‰©å±•æ¨¡å—ï¼ŒåŒ…å«äº†C++ä¸­ç¼–å†™çš„è‡ªå®šä¹‰sigmoidç®—å­import custom_opsclass CustomSigmoidFunction(Function):    @staticmethod    def forward(ctx, input):        # è°ƒç”¨è‡ªå®šä¹‰ç®—å­çš„å‰å‘æ“ä½œ        output = custom_ops.sigmoid_fwd(input)        ctx.save_for_backward(output)        return output    @staticmethod    def backward(ctx, grad_output):        (output,) = ctx.saved_tensors        # è°ƒç”¨è‡ªå®šä¹‰ç®—å­çš„åå‘æ“ä½œ        grad_input = custom_ops.sigmoid_bwd(output, grad_output.contiguous())        return grad_inputclass CustomSigmoid(torch.nn.Module):    def forward(self, input):        return CustomSigmoidFunction.apply(input)</code></pre> ä¸ºäº†ä¸PyTorchçš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿæ— ç¼è¡”æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨torch.autograd.Functionå°†CustomSigmoidç®—å­çš„å‰å‘å‡½æ•°å’Œåå‘å‡½æ•°å…³è”èµ·æ¥ï¼Œç„¶åä¸€èµ·å°è£…æˆtorch.nn.Moduleã€‚<p></p><h4 id="åœ¨pythonä¸­ä½¿ç”¨è‡ªå®šä¹‰ç®—å­">åœ¨Pythonä¸­ä½¿ç”¨è‡ªå®šä¹‰ç®—å­</h4><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰è‡ªå®šä¹‰ç®—å­çš„æ³¨å†Œæµç¨‹ã€‚æ¥ä¸‹æ¥å¯ä»¥åƒä½¿ç”¨å…¶ä»–PyTorchåŸç”Ÿç®—å­ä¸€æ ·ï¼Œåœ¨PyTorchä¸­è°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„è‡ªå®šä¹‰ç®—å­ï¼Œè®©æˆ‘ä»¬æ¥å®é™…æµ‹è¯•ä¸€ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyimport torchimport torch.nn.functional as Fimport numpy as npfrom custom_sigmoid_op import CustomSigmoiddef run(np_input, sigmoid_op, device="cuda"):    x = torch.tensor(np_input, dtype=torch.double, device=device, requires_grad=True)    output = sigmoid_op(x)    loss = torch.sum(output)    loss.backward()    return output.clone(), x.grad.clone()custom_sigmoid = CustomSigmoid()device = "cuda"np_input = np.random.randn(10, 20)# ç¡®ä¿è‡ªå®šä¹‰ç®—å­å„ä¸ªåç«¯çš„è®¡ç®—ç»“æœä¸PyTorchåŸç”Ÿsigmoidç®—å­çš„ç»“æœæ˜¯ä¸€è‡´çš„for device in ["cpu", "cuda"]:    sigmoid_out_torch, sigmoid_grad_torch = run(np_input, torch.sigmoid, device)    sigmoid_out_custom, sigmoid_grad_custom = run(np_input, custom_sigmoid, device)    # Compare results    if torch.allclose(sigmoid_out_torch, sigmoid_out_custom) and torch.allclose(        sigmoid_grad_torch, sigmoid_grad_custom    ):        print(f"Pass on {device}")    else:        print(f"Error: results mismatch on {device}")</code></pre><p></p><h2 id="åŸºäºè®¡ç®—å›¾çš„æ€§èƒ½ä¼˜åŒ–">åŸºäºè®¡ç®—å›¾çš„æ€§èƒ½ä¼˜åŒ–</h2><h3 id="torch.compile">torch.compile</h3><p>torch.compileæ˜¯ä¸€ä¸ªæå…¶å¤æ‚çš„ç³»ç»Ÿï¼Œå®ƒè¦†ç›–äº†è¯¸å¤šé¢†åŸŸï¼ŒåŒ…æ‹¬è®¡ç®—å›¾çš„æå–ã€ä¼˜åŒ–ä»¥åŠè·¨åç«¯çš„ä»£ç ç”Ÿæˆã€‚</p><p>ä½†å®é™…ä½¿ç”¨å¹¶ä¸éœ€è¦æ·±å…¥äº†è§£æ‰€æœ‰çš„å®ç°ç»†èŠ‚ï¼Œå› ä¸ºå¯ç”¨å®ƒåªéœ€ç®€å•ä¸€è¡Œä»£ç ã€‚</p><p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºtorch.compileçš„å¼€å¯æ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿå…¶æ€§èƒ½ä¼˜åŒ–æ•ˆæœï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnclass SimpleNet(nn.Module):    def __init__(self):        super(SimpleNet, self).__init__()        self.fc1 = nn.Linear(1000, 20000)    def forward(self, x):        x = torch.relu(self.fc1(x))        y = x        for _ in range(50):            y = y * x        return y# æœªç»ä¼˜åŒ–çš„æ¨¡å‹model = SimpleNet().cuda()# æ‰“å¼€torch.compileè¿½è¸ªæ¨¡å‹çš„æ‰§è¡Œè¿‡ç¨‹å¹¶è‡ªåŠ¨ä¼˜åŒ–compiled_model = torch.compile(model)def timed(fn):    start = torch.cuda.Event(enable_timing=True)    end = torch.cuda.Event(enable_timing=True)    start.record()    result = fn()    end.record()    torch.cuda.synchronize()    return result, start.elapsed_time(end) / 1000N_ITERS = 5def benchmark(model):    times = []    for i in range(N_ITERS):        input_data = torch.randn(1000, 1000, device="cuda")        _, time = timed(lambda: model(input_data))        times.append(time)    return timesprint("eageræ¨¡å¼", benchmark(model))print("æ‰“å¼€torch.compileå", benchmark(compiled_model))# è¾“å‡º# eageræ¨¡å¼ [1.1121439208984376, 0.01659187126159668, 0.01635430335998535, 0.016350208282470705, 0.016306175231933593]# æ‰“å¼€torch.compileå [1.79336083984375, 0.002367487907409668, 0.0022937600612640383, 0.002292736053466797, 0.002288640022277832]</code></pre>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è¿è¡Œå˜æ…¢äº†ï¼Œè¿™æ˜¯è®¡ç®—å›¾çš„æå–å’Œç¼–è¯‘ä¼˜åŒ–å¯¼è‡´çš„ï¼Œä½†æ˜¯ä»ç¬¬äºŒæ¬¡è¿è¡Œå¼€å§‹ä¾¿å¯ä»¥è¾¾åˆ°è¿‘8å€çš„åŠ é€Ÿã€‚<p></p><p>æ€§èƒ½çš„æå‡å…¶å®ä¸»è¦æœ‰ä¸¤ä¸ªæ¥æºï¼š -ä¸€æ–¹é¢æ˜¯è®¡ç®—å›¾ä¸€æ—¦ç¼–è¯‘å¥½ï¼Œå…¶ç”Ÿæˆçš„ä»£ç ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œåç»­å¾ªç¯ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ç¼–è¯‘å¥½çš„è®¡ç®—å›¾ï¼Œè€Œçœå»äº†ç®—å­å•ç‹¬è°ƒç”¨çš„é¢å¤–å¼€é”€ï¼›-å¦ä¸€æ–¹é¢åˆ™æ˜¯torch.compileè¿›è¡Œäº†ä¸€å®šçš„å›¾ä¼˜åŒ–ï¼ŒåŒ…æ‹¬è€Œä¸é™äºç®—å­çš„èåˆã€æ›¿æ¢ç­‰ï¼Œå…¶æœ€ç»ˆç”Ÿæˆçš„<strong>é«˜æ€§èƒ½tritonç®—å­</strong>ä¹Ÿæ˜¯æ€§èƒ½æå‡çš„æ¥æºä¹‹ä¸€ã€‚</p><p>torch.compileè¿˜æœ‰ä¸€äº›å¸¸è§çš„å‚æ•°ï¼š -fullgraph=Trueï¼šå¼€å¯å®Œæ•´çš„è®¡ç®—å›¾ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ§åˆ¶æµã€æ¡ä»¶åˆ†æ”¯ç­‰ï¼›ä¸€æ—¦è®¡ç®—å›¾å‘ç”Ÿä¸­æ–­ï¼Œç³»ç»Ÿä¼šç«‹å³æŠ¥é”™ï¼Œå¸®åŠ©ç”¨æˆ·åŠæ—¶å‘ç°å¹¶å¤„ç†æ½œåœ¨çš„å›¾æ–­è£‚é—®é¢˜- dynamic=Trueï¼šå¼€å¯åŠ¨æ€å›¾ä¼˜åŒ–ï¼Œæ”¯æŒå¯¹åŠ¨æ€å›¾ä¸­å¼ é‡å½¢çŠ¶ä¸æ–­å˜åŒ–çš„åœºæ™¯ï¼› -mode="reduce-overhead"ï¼šå‡å°‘ä»CPUåˆ°GPUçš„è°ƒç”¨æ¬¡æ•°(CUDAgraphèƒ½å¤Ÿé€šè¿‡è®°å½•ä¸€ç³»åˆ—GPUæ“ä½œï¼Œå¦‚å†…æ ¸æ‰§è¡Œå’Œå†…å­˜æ‹·è´ï¼Œåˆ›å»ºä¸€ä¸ªå¯é‡ç”¨çš„GPUæ“ä½œåºåˆ—)</p><h3 id="è®¡ç®—å›¾çš„æå–">è®¡ç®—å›¾çš„æå–</h3><p>è®¡ç®—å›¾åœ¨æœ‰äº›æƒ…å†µä¸‹ä¼šå’Œå®é™…çš„pythonä»£ç é€»è¾‘ç›¸å…³ï¼Œæ¯”å¦‚ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">class DataDependentNet(nn.Module):    def __init__(self):        super(DataDependentNet, self).__init__()        self.linear1 = nn.Linear(10, 5)        self.linear2 = nn.Linear(5, 2)        self.linear3 = nn.Linear(5, 3)    def forward(self, x):        tmp = F.relu(self.linear1(x))        # æœ‰æ•°æ®ä¾èµ–çš„æ§åˆ¶æµï¼šå¦‚æœxçš„ç¬¬ä¸€ä¸ªå…ƒç´ å¤§äº0.5ï¼Œä½¿ç”¨linear2ï¼Œå¦åˆ™ä½¿ç”¨linear3        if tmp[0, 0] &gt; 0.5:            return self.linear2(tmp)        else:            return self.linear3(tmp)</code></pre><p></p><p><strong>åŸºäºPythonè¿è¡Œæ—¶çš„è·Ÿè¸ª(tracing)æ–¹æ³•</strong>æœ¬è´¨ä¸Šæ˜¯åœ¨æ¨¡å‹æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€æ•æ‰è®¡ç®—å›¾ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ç›‘è§†PyTorchæ“ä½œçš„æ‰§è¡Œï¼Œæ¥å®æ—¶è®°å½•è¿™äº›æ“ä½œåŠå…¶ä¸Šä¸‹æ¸¸ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿå‡†ç¡®æ•è·æ¨¡å‹å®é™…æ‰§è¡Œæ—¶çš„è¡Œä¸ºï¼Œå¹¶ä¸”å‡ ä¹å¯ä»¥æ— è§†æ§åˆ¶æµçš„å½±å“â€”â€”åªæ•è·å®é™…æ‰§è¡Œçš„åˆ†æ”¯å³å¯ï¼Œæœªè¢«æ‰§è¡Œçš„åˆ†æ”¯å°±ä¸æ”¾åœ¨è®¡ç®—å›¾é‡Œäº†ã€‚å¦‚å›¾ä¸­å·¦åŠéƒ¨åˆ†æ‰€ç¤ºï¼Œæˆ‘ä»¬ä»…æ•æ‰åˆ°äº†linear2è¿™ä¸ªæ“ä½œï¼Œlinear3æ“ä½œç”±äºå…¶åˆ†æ”¯æ²¡æœ‰è¢«æ‰§è¡Œä¾¿æ²¡æœ‰å‡ºç°åœ¨è®¡ç®—å›¾ä¸­ã€‚JIT tracingã€lazy tensorå’Œtorch.compileéƒ½æ˜¯åŸºäºè·Ÿè¸ªçš„æ–¹æ³•ã€‚</p><p><strong>åŸºäºæºç åˆ†æçš„æ–¹æ³•</strong>èƒ½å¤Ÿè¯†åˆ«Pythonä¸­çš„æ§åˆ¶æµç»“æ„ï¼Œå¦‚if-elseå’Œforå¾ªç¯ï¼ŒåŒæ—¶å°†æ‰€æœ‰ç›¸å…³æ“ä½œæå–è‡³åŒä¸€è®¡ç®—å›¾ä¸­ï¼Œä»è€Œæœ€å¤§åŒ–ä¿æŒå›¾çš„å®Œæ•´æ€§ã€‚è¿™ç§æ–¹æ³•çš„å…¸å‹å·¥å…·æ˜¯TorchScriptã€‚æ‹¥æœ‰ä¸€å¼ å®Œæ•´è®¡ç®—å›¾çš„å…¨å±€ä¿¡æ¯å¯¹å›¾ä¼˜åŒ–æä¸ºæœ‰åˆ©ã€‚ç„¶è€Œï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒTorchScriptå¾ˆéš¾å®Œå…¨æ”¯æŒæ‰€æœ‰Pythonè¯­è¨€ç‰¹æ€§ï¼Œä½¿ç”¨æ—¶å¯èƒ½éœ€è¦å¯¹åŸå§‹ä»£ç è¿›è¡Œè°ƒæ•´ï¼Œè¿™å¯èƒ½å½±å“ä»£ç çš„ç»“æ„å’Œçµæ´»æ€§ã€‚æ€»çš„æ¥è¯´ï¼Œå½“TorchScriptèƒ½å¤Ÿé¡ºåˆ©è¿è¡Œæ—¶ï¼Œå®ƒèƒ½æä¾›éå¸¸ä¼˜å¼‚çš„æ€§èƒ½ï¼Œä½†ä¸ºäº†è®©å®ƒèƒ½è·‘èµ·æ¥ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦åœ¨ä»£ç çš„ç¼–å†™ä¸Šåšå‡ºè¾ƒå¤§çš„å¦¥åã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250314224947.png"></p><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹torch.compileçš„è®¡ç®—å›¾æå–ä»¥åŠä¼˜åŒ–è¿‡ç¨‹ï¼š - 1.<strong>å­—èŠ‚ç åˆ†æ</strong>ï¼šPythonä»£ç åœ¨æ‰§è¡Œå‰ä¼šè¢«ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œè¿™æ˜¯ä¸€ç§å¹³å°æ— å…³çš„ä¸­é—´è¡¨ç¤ºå½¢å¼ã€‚CPythonæä¾›äº†å†…éƒ¨æ¥å£ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åˆ†æè¿™äº›å­—èŠ‚ç ã€‚- 2. <strong>æ•è·å¼ é‡æ“ä½œ</strong>ï¼šä½¿ç”¨<code>torch.compile</code>å’ŒTorchDynamoæŠ€æœ¯ï¼ŒPyTorchåœ¨è¿è¡Œæ—¶æ•è·å¼ é‡æ“ä½œ - 3.<strong>åŠ¨æ€ç”Ÿæˆè®¡ç®—å›¾</strong>ï¼šæ ¹æ®å®é™…è¿è¡Œæ—¶çš„æ•°æ®å’Œæ“ä½œï¼ŒåŠ¨æ€ç”Ÿæˆè®¡ç®—å›¾ã€‚- 4.<strong>ä¼˜åŒ–è®¡ç®—å›¾</strong>ï¼šç”Ÿæˆçš„è®¡ç®—å›¾å¯ä»¥è¢«è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä»¥æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œä¼˜åŒ–è¿‡ç¨‹å¯èƒ½åŒ…æ‹¬æ“ä½œèåˆã€å†…å­˜ä¼˜åŒ–ã€å¸¸é‡æŠ˜å ç­‰ã€‚- 5.<strong>ç”Ÿæˆé«˜æ•ˆæ‰§è¡Œä»£ç </strong>ï¼šä¼˜åŒ–åçš„è®¡ç®—å›¾ç”¨äºç”Ÿæˆæ›´é«˜æ•ˆçš„æ‰§è¡Œä»£ç ï¼Œæ‰§è¡Œæ—¶å°†å–ä»£åŸæ¥Pythonè§£é‡Šå™¨ä¸­çš„å‡½æ•°è°ƒç”¨ã€‚- 6.<strong>å›é€€æœºåˆ¶</strong>ï¼šå¦‚æœé‡åˆ°éš¾ä»¥è½¬æ¢æˆå›¾çš„ä»£ç ï¼Œ<code>torch.compile</code>ä¼šä¸­æ–­å›¾çš„æ„å»ºï¼Œç¨‹åºä¼šå›é€€åˆ°æ ‡å‡†çš„Pythonè§£é‡Šå™¨æ¥å¤„ç†ã€‚- 7.<strong>é€æ˜çš„ç”¨æˆ·ä½“éªŒ</strong>ï¼šå¯¹ç”¨æˆ·è€Œè¨€ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯é€æ˜çš„ã€‚ç”¨æˆ·ä»ç„¶ç¼–å†™æ ‡å‡†çš„Pythonä»£ç ï¼Œä½†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code>torch.compile</code>è‡ªåŠ¨è¯†åˆ«å¹¶ä¼˜åŒ–å¯æ”¹è¿›çš„éƒ¨åˆ†ã€‚<br>- 8. <strong>AOTAutogradæŠ€æœ¯</strong>ï¼š<code>torch.compile</code>ä¸ä»…æ•è·ç”¨æˆ·çš„å‰å‘ä»£ç ï¼Œè¿˜èƒ½æ•è·åå‘ä¼ æ’­çš„è®¡ç®—å›¾ã€‚</p><p>é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œ<code>torch.compile</code>åœ¨ä¸æ”¹å˜ç”¨æˆ·ä»£ç çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨ä¼˜åŒ–PyTorchç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><h3 id="å›¾çš„ä¼˜åŒ–å’Œåç«¯ä»£ç ">å›¾çš„ä¼˜åŒ–å’Œåç«¯ä»£ç </h3><p>ä¸ç®¡æ˜¯åŸºäºè¿è¡Œæ—¶è·Ÿè¸ªè¿˜æ˜¯åŸºäºæºç åˆ†æçš„æ–¹æ³•ï¼Œåœ¨è·å¾—è®¡ç®—å›¾ä¹‹åï¼Œtorch.compileåˆ©ç”¨åç«¯ï¼ˆå¦‚é»˜è®¤çš„inductoråç«¯ï¼‰æ¥æ‰§è¡Œçš„ä¼˜åŒ–æ˜¯å‡ ä¹ä¸€è‡´çš„ã€‚è¿™äº›ä¼˜åŒ–ä¸»è¦åŸºäºåç«¯çš„ç‰¹å®šç­–ç•¥å’Œç¡¬ä»¶çš„æŠ€æœ¯ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿç¼–è¯‘å™¨æ‰€é‡‡ç”¨çš„æ ‡å‡†ä¼˜åŒ–æµç¨‹ã€‚</p><p>ä¾‹å¦‚ï¼Œå½“å‰çš„ä»£ç ç”Ÿæˆä¸»è¦å…³æ³¨æé«˜ç®—å­çš„è®¡ç®—æ•ˆç‡ï¼Œè¿™éœ€è¦é€šè¿‡ç®—å­èåˆã€æ•°æ®å¸ƒå±€è½¬æ¢ä»¥åŠåˆ©ç”¨ç‰¹å®šç¡¬ä»¶çš„æŒ‡ä»¤é›†æ¥å®ç°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡è½»å¼€å‘è€…æ‰‹åŠ¨ç¼–å†™æ¯ä¸ªè‡ªå®šä¹‰ç®—å­çš„è´Ÿæ‹…ã€‚</p><p>ä¹‹å‰çš„ç¤ºä¾‹ä»£ç ä¸­ä½¿ç”¨PyTorchprofileræ‰“å°å…¶æ€§èƒ½å›¾è°±ï¼Œä»å›¾ä¸­ä»¥çœ‹å‡ºtorch.compileåœ¨åº•å±‚ç”Ÿæˆäº†tritonç®—å­ï¼Œè¯¥ç®—å­å°†åŸæœ¬çš„ä¹˜æ³•ç®—å­ã€ReLUç®—å­èåˆåœ¨äº†ä¸€èµ·ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250314231021.png"></p><p>åœ¨è®¾ç½®ç¯å¢ƒå˜é‡TORCH_COMPILE_DEBUG=1åé‡æ–°æ‰§è¡Œä»£ç æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°torch.compileç”Ÿæˆçš„tritonä»£ç ï¼Œ</p><p>æ¯”å¦‚ä¸‹é¢ä»£ç æ˜¯ç”±inductoråç«¯ç”Ÿæˆçš„å°†reluå’Œ50ä¸ªmulç®—å­èåˆæˆä¸€ä¸ªç®—å­çš„tritonä»£ç ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">@pointwise(    size_hints=[33554432],    filename=__file__,    triton_meta={        "signature": {0: "*fp32", 1: "*fp32", 2: "i32"},        "device": 0,        "device_type": "cuda",        "constants": {},        "configs": [            instance_descriptor(                divisible_by_16=(0, 1, 2),                equal_to_1=(),                ids_of_folded_args=(),                divisible_by_8=(2,),            )        ],    },    inductor_meta={        "autotune_hints": set(),        "kernel_name": "triton_poi_fused_mul_relu_0",        "mutated_arg_names": ["in_out_ptr0"],    },    min_elem_per_thread=0,)@triton.jitdef triton_(in_out_ptr0, in_ptr0, xnumel, XBLOCK: tl.constexpr):    xnumel = 20000000    xoffset = tl.program_id(0) * XBLOCK    xindex = xoffset + tl.arange(0, XBLOCK)[:]    xmask = xindex &lt; xnumel    x0 = xindex    tmp0 = tl.load(in_ptr0 + (x0), xmask)    tmp1 = triton_helpers.maximum(0, tmp0)    tmp2 = tmp1 * tmp1    tmp3 = tmp2 * tmp1    ...  # ç¯‡å¹…åŸå› çœç•¥ä¸­é—´çš„è¡Œ    tmp49 = tmp48 * tmp1    tmp50 = tmp49 * tmp1    tmp51 = tmp50 * tmp1    tl.store(in_out_ptr0 + (x0), tmp51, xmask)</code></pre><p></p><h2 id="å°ç»“">å°ç»“</h2><p>å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®æŒ‰ç…§å¦‚ä¸‹é¡ºåºæ¥å°è¯•è¿™äº›é«˜çº§ä¼˜åŒ–æŠ€å·§ï¼š -é¦–å…ˆæ¨èå°è¯•ä½¿ç”¨torch.compileï¼Œå› ä¸ºå…¶å¼€å¯æ–¹æ³•ç®€å•ä¸”å‡ ä¹æ²¡æœ‰å‰¯ä½œç”¨ã€‚åªéœ€åœ¨è®­ç»ƒæ¨¡å‹å¤–å±‚æ·»åŠ torch.compileï¼Œå¹¶è§‚å¯Ÿæ€§èƒ½å˜åŒ–å³å¯ã€‚å¦‚æœæ€§èƒ½ä¸‹é™æˆ–torch.compileæç¤ºâ€œå›é€€åˆ°Eageræ¨¡å¼â€â€‹ï¼Œåˆ™è¯´æ˜å½“å‰ç½‘ç»œç»“æ„æ— æ³•ç›´æ¥è¢«torch.compileä¼˜åŒ–</p><ul><li><p>å…¶æ¬¡ï¼Œæ¨èå°è¯•è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒï¼Œå› ä¸ºåŠç²¾åº¦è®­ç»ƒé€šå¸¸èƒ½æ˜¾è‘—æå‡æ€§èƒ½ã€‚å°½ç®¡å¯¹æ”¶æ•›æ€§å’Œæ¨¡å‹è´¨é‡å¯èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä½†å¤§å¤šæ•°æ¨¡å‹åœ¨å¼€å¯è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒåï¼Œä»èƒ½è¾¾åˆ°ä¸å•ç²¾åº¦è®­ç»ƒç›¸ä¼¼çš„ç»“æœã€‚ç„¶è€Œï¼Œä½¿ç”¨è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒæ—¶åº”ä¿æŒè°¨æ…ï¼Œéœ€è¦ä»”ç»†éªŒè¯æ”¶æ•›æ€§ã€‚å› æ­¤ï¼Œè‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒæ˜¯ä¸€ç§æœ‰æ½œåœ¨é£é™©çš„ä¼˜åŒ–æ–¹æ³•ã€‚</p></li><li><p>æœ€åï¼Œå°è¯•è‡ªå®šä¹‰ç®—å­çš„ä¼˜å…ˆçº§ï¼Œå…¶æŠ•å…¥äº§å‡ºæ¯”ç›¸å¯¹è¾ƒä½ä¸”ä¸ç¡®å®šæ€§è¾ƒå¤§ã€‚é€šå¸¸ä»…å»ºè®®åœ¨éœ€è¦æè‡´æ€§èƒ½ä¼˜åŒ–çš„åœºæ™¯ä¸‹å°è¯•è‡ªå®šä¹‰ç®—å­ã€‚ç†Ÿæ‚‰CUDAå’ŒCPUåŠ é€Ÿä¸”å…·å¤‡é«˜æ€§èƒ½è®¡ç®—èƒŒæ™¯çš„å¼€å‘è€…ï¼Œå¯ä»¥é€šè¿‡è‡ªè¡Œç¼–å†™é«˜æ€§èƒ½ç®—å­æ¥ä¼˜åŒ–ç‰¹å®šåº”ç”¨åœºæ™¯ã€‚å¦ä¸€ç§é€‰æ‹©æ˜¯ä½¿ç”¨å¼€æºç®—å­åº“ï¼Œä¸è¿‡ç¬¬ä¸‰æ–¹ç®—å­åº“å¾€å¾€å­˜åœ¨å±€é™æ€§æˆ–å‰¯ä½œç”¨ï¼Œæœªå¿…èƒ½ç›´æ¥åº”ç”¨äºè‡ªå·±çš„æ¨¡å‹ï¼Œä¸”å®é™…ä¼˜åŒ–æ•ˆæœä¸å¯æ§ã€‚</p></li></ul></t>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> é«˜çº§ä¼˜åŒ–æ–¹æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-åˆ†å¸ƒå¼è®­ç»ƒä¸“é¢˜</title>
      <link href="/2025/03/13/da-mo-xing-dong-li-yin-qing-fen-bu-shi-xun-lian-zhuan-ti/"/>
      <url>/2025/03/13/da-mo-xing-dong-li-yin-qing-fen-bu-shi-xun-lian-zhuan-ti/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ†å¸ƒå¼è®­ç»ƒçš„åŸç†">åˆ†å¸ƒå¼è®­ç»ƒçš„åŸç†</h2><p>ç›®å‰æµè¡Œçš„åˆ†å¸ƒå¼ç­–ç•¥æœ‰å¾ˆå¤šç§ï¼Œä¸»è¦åˆ†ä¸ºåˆ‡æ•°æ®(dataparallel)å’Œåˆ‡æ¨¡å‹(modelparallel)ä¸¤ä¸ªå¤§çš„æ–¹å‘ã€‚ä¸åŒç­–ç•¥çš„ç®—æ³•å’Œå®ç°å·®å¼‚è¾ƒå¤§ï¼Œä½†ä¸å¤–ä¹ä¸¤ä¸ªå‡ºå‘ç‚¹ï¼š-<strong>ç”¨é€šä¿¡å¼€é”€æ¥ç½®æ¢æ›´ç´§ç¼ºçš„èµ„æº</strong>ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ¯æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ä¼šä»¥é¢å¤–é€šä¿¡å¼€é”€ä¸ºä»£ä»·å¸¦æ¥é¢å¤–çš„æ˜¾å­˜å’Œè®¡ç®—èµ„æºï¼Œä½†å¦‚ä½•ä½¿ç”¨è¿™äº›é¢å¤–çš„èµ„æºè‡³å…³é‡è¦ã€‚å¦‚æœæˆ‘ä»¬ç”¨é€šä¿¡æ¥æ¢å–æ›´å¤§çš„æ•°æ®å¤„ç†å¹¶è¡Œåº¦ï¼Œä»è€ŒåŠ é€Ÿè®­ç»ƒè¿‡ç¨‹ï¼Œè¿™å°±æ˜¯æ•°æ®å¹¶è¡Œçš„å®ç°æ–¹å¼ï¼›è€Œå¦‚æœæˆ‘ä»¬ç”¨é€šä¿¡æ¥çªç ´å•å¡çš„æ˜¾å­˜å®¹é‡é™åˆ¶ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†æ›´å¤§è§„æ¨¡çš„æ¨¡å‹ï¼Œè¿™å°±æ˜¯æ¨¡å‹å¹¶è¡Œçš„ç­–ç•¥ã€‚å› æ­¤åˆ‡åˆ†æ–¹å¼çš„é€‰æ‹©ä¸»è¦å–å†³äºæˆ‘ä»¬éœ€è¦é€šè¿‡èµ„æºç½®æ¢æ¥è§£å†³çš„ä¸»è¦çŸ›ç›¾ã€‚å›¾8-1æ­ç¤ºä¸åŒèµ„æºä¹‹é—´é€šè¿‡ç½®æ¢æ¥çªç ´æ˜¾å­˜æˆ–è€…å¹¶è¡Œåº¦é™åˆ¶çš„å…¸å‹æ–¹æ³•ã€‚-<strong>å°½é‡éšè—é€šä¿¡å¼€é”€</strong>ã€‚è¿›ç¨‹é—´é€šä¿¡å’ŒGPUè®¡ç®—ä½¿ç”¨ä¸åŒçš„ç¡¬ä»¶å•å…ƒï¼Œæ‰€ä»¥ç†è®ºä¸Šæ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ã€‚ä¸€ä¸ªæœ‰æ•ˆçš„è®¾è®¡æ–¹æ¡ˆæ˜¯<strong>å°†é€šä¿¡è¿‡ç¨‹ä¸GPUè®¡ç®—è¿‡ç¨‹è¿›è¡Œé‡å ï¼Œä»¥æ­¤æ¥æ©ç›–é€šä¿¡çš„æ—¶é—´å¼€é”€å¹¶å‡å°‘é€šä¿¡å»¶è¿Ÿ</strong>ã€‚æµæ°´çº¿å¹¶è¡Œ(pipelineparallel)å°±æ˜¯åŸºäºè¿™ä¸ªæ€è·¯è®¾è®¡çš„åˆ†å¸ƒå¼ç­–ç•¥ï¼Œå®ƒé€šè¿‡å°†ä¸Šä¸€è½®è®­ç»ƒçš„é€šä¿¡è¿‡ç¨‹ä¸å½“å‰è®­ç»ƒçš„è®¡ç®—è¿‡ç¨‹é‡åˆæ¥å‡å°‘é€šä¿¡è¿‡ç¨‹å¯¹GPUè®¡ç®—çš„é˜»å¡ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313172033.png"></p><h2 id="é›†åˆé€šä¿¡åŸè¯­">é›†åˆé€šä¿¡åŸè¯­</h2><p>å®é™…ä¸Šä¸åŒçš„åˆ†å¸ƒå¼ç­–ç•¥ä¼šé€šä¿¡ä¸åŒç±»å‹çš„æ•°æ®ï¼Œä½†æ˜¯æ€»ä½“æ¥è¯´ä»¥å¼ é‡æ•°æ®ä¸ºä¸»:æ•°æ®å¹¶è¡Œç­–ç•¥ä¸»è¦é€šä¿¡æ¢¯åº¦å¼ é‡;æ¨¡å‹å¹¶è¡Œåˆ™ä¼šæ ¹æ®ç­–ç•¥ä¸åŒå¯¹æ¨¡å‹å‚æ•°ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€å’Œæ¿€æ´»å¼ é‡çš„é€šä¿¡éƒ½æœ‰å¯èƒ½æ¶‰åŠã€‚</p><p>ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„åŸºæœ¬é€šä¿¡ï¼ˆç‚¹å¯¹ç‚¹é€šä¿¡ï¼‰æ“ä½œä¸€èˆ¬åŒ…æ‹¬å‘é€(send)å’Œæ¥æ”¶(receive)ï¼Œä½†æ˜¯æ¶‰åŠéœ€è¦æ‰€æœ‰èŠ‚ç‚¹å‚ä¸çš„é›†ä½“é€šä¿¡æ“ä½œï¼Œè¢«å½’ä¸ºä¸€ç³»åˆ—é›†åˆé€šä¿¡åŸè¯­ã€‚</p><h3 id="å¹¿æ’­broadcastå’Œåˆ†å‘scatter">å¹¿æ’­ï¼ˆbroadcastï¼‰å’Œåˆ†å‘ï¼ˆscatterï¼‰</h3><p>è¿™ä¸¤ä¸ªæ“ä½œéƒ½æ˜¯ä»ä¸€ä¸ªèŠ‚ç‚¹å‘æ•´ä¸ªé›†ç¾¤å‘é€ä¿¡æ¯çš„æ“ä½œï¼ŒåŒºåˆ«ä»…åœ¨æ¯ä¸ªèŠ‚ç‚¹æ”¶åˆ°çš„å†…å®¹æ˜¯æ•´ä¸ªæ•°æ®è¿˜æ˜¯æ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="èšåˆgatherå’Œå½’çº¦reduce">èšåˆï¼ˆgatherï¼‰å’Œå½’çº¦ï¼ˆreduceï¼‰</h3><p>gatheræ˜¯scatterçš„é€†æ“ä½œï¼Œå®ƒå°†æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®æ”¶é›†åˆ°ä¸€èµ·ï¼Œè€Œreduceåˆ™æ˜¯å°†æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œå½’çº¦æ“ä½œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313173243.png"></p><p>åœ¨å¤šå¯¹å¤šé€šä¿¡ä¸­å¯ä»¥æ‰©å±•ä¸ºall gatherå’Œall reduceã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313173528.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œæœ‰ä¸€äº›é€šä¿¡åŸè¯­æ˜¯ç­‰ä»·çš„æˆ–è€…å¯ä»¥ç›¸äº’è½¬æ¢çš„ï¼Œæ¯”å¦‚allreduceä¸reduce+ broadcast, scatter +gatherä¸allgatherç­‰ï¼Œè¿™äº›ç­‰ä»·æ“ä½œå¯ä»¥æ ¹æ®å…·ä½“çš„éœ€æ±‚å’Œå®ç°ç­–ç•¥è¿›è¡Œæ›¿æ¢ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½æˆ–ç®€åŒ–å®ç°ã€‚</p><p>å¦å¤–åˆ†å¸ƒå¼è®­ç»ƒçš„ç‰¹å®šç­–ç•¥ä¸­è¿˜ä¼šæ¶‰åŠæ›´å¤šé€šä¿¡åŸè¯­ï¼Œå¦‚å…¨å±€å¹¿æ’­(all-to-allbroadcast)å’Œå½’çº¦åˆ†å‘(reduce-scatter)æ“ä½œç­‰ã€‚</p><h2 id="åº”å¯¹æ•°æ®å¢é•¿çš„å¹¶è¡Œç­–ç•¥">åº”å¯¹æ•°æ®å¢é•¿çš„å¹¶è¡Œç­–ç•¥</h2><h3 id="æ•°æ®å¹¶è¡Œ">æ•°æ®å¹¶è¡Œ</h3><p>åŸºæœ¬æ­¥éª¤ï¼š -1.æ¨¡å‹åˆå§‹åŒ–ï¼šä¸ºäº†ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ¨¡å‹å‚æ•°ä¿æŒä¸€è‡´ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨broadcastæ“ä½œï¼Œå°†ä¸»èŠ‚ç‚¹(masternode)ä¸Šçš„æ¨¡å‹å‚æ•°å‘é€åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ã€‚è¿™æ ·çš„æ“ä½œä¿è¯äº†å³ä¾¿æ˜¯éšæœºç”Ÿæˆçš„å‚æ•°ï¼Œå„èŠ‚ç‚¹ä¸Šçš„æ¨¡å‹åˆå§‹çŠ¶æ€ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚-2.æ•°æ®åˆ‡åˆ†ï¼šåœ¨æ•°æ®åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªè®­ç»ƒæ‰¹æ¬¡ä¼šè¢«å¹³å‡åˆ’åˆ†æˆNä»½ï¼Œå…¶ä¸­Nä»£è¡¨å‚ä¸è®¡ç®—çš„èŠ‚ç‚¹æ•°é‡ã€‚-3.æ¢¯åº¦åŒæ­¥ï¼šåœ¨åå‘ä¼ æ’­å®Œæˆåï¼Œæˆ‘ä»¬é€šè¿‡æ‰§è¡Œallreduceï¼Œå°†å„èŠ‚ç‚¹è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦è¿›è¡Œæ±‚å’Œï¼Œä»è€Œç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹åœ¨æ›´æ–°æ¨¡å‹å‚æ•°æ—¶ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æ¢¯åº¦å€¼ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313174818.png">å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç¬¬3æ­¥ä¸­æ‰§è¡Œçš„allreduceé»˜è®¤é˜»å¡æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ï¼Œç›´åˆ°æ¯ä¸ªèŠ‚ç‚¹è·å–åˆ°ä¸€è‡´çš„æ¢¯åº¦å€¼åæ‰ä¼šè¿›è¡Œæ¨¡å‹çš„æ›´æ–°ï¼Œè¿™ç§é€šå¸¸è¢«ç§°ä¸º<strong>åŒæ­¥çš„æ¢¯åº¦èšåˆæ›´æ–°</strong>ã€‚</p><h3 id="æ‰‹åŠ¨å®ç°æ•°æ®å¹¶è¡Œ">æ‰‹åŠ¨å®ç°æ•°æ®å¹¶è¡Œ</h3><p>é¦–å…ˆå…ˆçœ‹æ™®é€šå•æœºå•å¡çš„è®­ç»ƒä»£ç ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnimport torch.nn.functional as Ffrom torch.utils.data import DataLoaderfrom common import SimpleNet, MyTrainDatasetdef train(model, optimizer, train_data, device_id):    model = model.to(device_id)    for i, (src, target) in enumerate(train_data):        src = src.to(device_id)        target = target.to(device_id)        optimizer.zero_grad()        output = model(src)        loss = F.mse_loss(output, target)        loss.backward()        optimizer.step()        print(f"[GPU{device_id}]: batch {i}/{len(train_data)}, loss: {loss}")def main(device_id):    model = SimpleNet()    optimizer = torch.optim.SGD(model.parameters(), lr=1e-2)    batchsize_per_gpu = 32    dataset = MyTrainDataset(num=2048, size=512)    train_data = DataLoader(dataset, batch_size=batchsize_per_gpu)    train(model, optimizer, train_data, device_id)if __name__ == "__main__":    device_id = 0    main(device_id)</code></pre>æ¥æ¥ä¸‹æŒ‰ç…§N=world_sizeä¸ªèŠ‚ç‚¹æ¥å®ç°æ•°æ®å¹¶è¡Œï¼š<p></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnimport torch.nn.functional as Ffrom torch.utils.data import DataLoaderfrom common import SimpleNet, MyTrainDatasetimport osimport torch.distributed as distimport torch.multiprocessing as mp# (3) åˆå§‹åŒ–åˆ†å¸ƒå¼é€šä¿¡ç»„:æ‰€æœ‰è¿›ç¨‹å°†è¢«æ·»åŠ åˆ°åŒä¸€ä¸ªé€šä¿¡ç»„ä¸­,æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·(rank),æ¯ä¸ªç¼–å·çš„è¿›ç¨‹è´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„GPUdef setup(rank, device_id, world_size, backend):    os.environ["MASTER_ADDR"] = "127.0.0.1"    os.environ["MASTER_PORT"] = "29500"    dist.init_process_group(backend, rank=rank, world_size=world_size)    torch.cuda.set_device(device_id)def train(model, optimizer, train_data, rank, device_id, world_size):    for i, (src, target) in enumerate(train_data):        src = src.to(device_id)        target = target.to(device_id)        optimizer.zero_grad()        output = model(src)        loss = F.mse_loss(output, target)        loss.backward()        # (5) æ¯ä¸ªæ‰¹æ¬¡è®­ç»ƒç»“æŸåè¿›è¡Œæ¢¯åº¦åŒæ­¥:åœ¨è¿›è¡Œæ¢¯åº¦æ›´æ–°ä¹‹å‰ï¼Œæ‰€æœ‰è¿›ç¨‹é€šè¿‡allreduceåŒæ­¥æ¢¯åº¦æ•°å€¼        grads = [t.grad.data for t in model.parameters()]        for grad in grads:            grad.div_(world_size)            dist.all_reduce(grad, op=dist.ReduceOp.SUM)        optimizer.step()        print(f"[GPU{rank}]: batch {i}/{len(train_data)}, loss: {loss}")def main(rank, world_size, backend):    device_id = rank    setup(rank, device_id, world_size, backend)    model = SimpleNet().to(device_id)    # (4) åˆå§‹åŒ–æ¨¡å‹å¹¶å‚æ•°åŒæ­¥:è®­ç»ƒå¼€å§‹å‰ç”±ç¼–å·ä¸º0çš„èŠ‚ç‚¹å°†æ¨¡å‹çš„åˆå§‹å‚æ•°åŒæ­¥åˆ°æ•´ä¸ªé›†ç¾¤ã€‚    params = [t.detach() for t in model.parameters()]    for param in params:        dist.broadcast(param, 0)    optimizer = torch.optim.SGD(model.parameters(), lr=1e-2)    batchsize_per_gpu = 4096    dataset = MyTrainDataset(num=40960, size=512)    # (1) æ•°æ®åˆ†å‰²ï¼šé‡‡ç”¨äº†PyTorchçš„DistributedSamplerå·¥å…·ï¼Œå®ƒå¯ä»¥ç¡®ä¿æ¯ä¸ªGPUè·å¾—ç‹¬ä¸€æ— äºŒä¸”äº’ä¸é‡å çš„æ•°æ®å­é›†    sampler = torch.utils.data.distributed.DistributedSampler(        dataset, num_replicas=world_size, rank=rank    )    train_data = DataLoader(dataset, batch_size=batchsize_per_gpu, sampler=sampler)    train(model, optimizer, train_data, rank, device_id, world_size)if __name__ == "__main__":    # (2) å¤šè¿›ç¨‹å¯åŠ¨å’Œç®¡ç†ï¼šé‡‡ç”¨torch.multiprocessing.spawnå¯åŠ¨å¤šä¸ªè¿›ç¨‹ï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿›ç¨‹çš„rankå’Œworld_size    world_size = 2    mp.spawn(main, args=(world_size, "nccl"), nprocs=world_size, join=True)</code></pre><h3 id="pytorchçš„ddpå°è£…">PyTorchçš„DDPå°è£…</h3><p>ä¸Šè¿°æ‰‹åŠ¨çš„å®ç°æ–¹å¼è™½ç„¶å¯ä»¥å®ç°æ•°æ®å¹¶è¡Œï¼Œä½†æ˜¯å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š -1.æ¨¡å‹ä¸­çš„æ¯ä¸ªå‚æ•°å¼ é‡éƒ½è¿›è¡Œäº†ä¸€æ¬¡å•ç‹¬çš„allreduceæ“ä½œã€‚åœ¨å¤§è§„æ¨¡æ¨¡å‹ä¸­ï¼Œé€šå¸¸å­˜åœ¨æˆç™¾ä¸Šåƒä¸ªå‚æ•°å¼ é‡ã€‚å¦‚æœåœ¨æ¢¯åº¦èšåˆè¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸ªå‚æ•°æ¢¯åº¦è¿›è¡Œå•ç‹¬çš„allreduceé€šä¿¡ï¼Œé€šä¿¡æ“ä½œçš„å¯åŠ¨å’Œç»“æŸçš„å¼€é”€ä¼šéå¸¸å¤§ã€‚-2.æ‰€æœ‰allreduceæ“ä½œä¸€ç›´ç­‰å¾…æ‰€æœ‰å±‚çš„åå‘ä¼ æ’­å®Œæˆåæ‰å¼€å§‹æ‰§è¡Œã€‚ç„¶è€Œä»¥æ¨¡å‹ä¸­çš„fc3ç®—å­ä¸ºä¾‹ï¼Œå®é™…ä¸Šåœ¨è¯¥å±‚å®Œæˆåå‘ä¼ æ’­ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç«‹å³å¯¹fc3çš„å‚æ•°æ¢¯åº¦è¿›è¡Œå½’çº¦æ“ä½œï¼Œè€Œæ— é¡»ç­‰å¾…æ•´ä¸ªæ¨¡å‹çš„åå‘ä¼ æ’­å®Œå…¨ç»“æŸã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313181342.png"></p><p>PyTorchçš„DistributedDataParallel(DDP)ä»¥åŠåŸºäºå®ƒå¼€å‘çš„å¦‚accelerateè¿™ç±»é«˜çº§å°è£…å·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨å®Œæˆæ•°æ®å¹¶è¡Œè®­ç»ƒçš„ç»†èŠ‚ï¼Œå¹¶æä¾›æ›´ç®€æ´çš„æ¥å£ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnimport torch.nn.functional as Ffrom torch.utils.data import DataLoaderfrom common import SimpleNet, MyTrainDatasetimport osimport torch.distributed as distimport torch.multiprocessing as mpfrom torch.nn.parallel import DistributedDataParallel as DDP# (3) åˆå§‹åŒ–åˆ†å¸ƒå¼é€šä¿¡ç»„def setup(rank, device_id, world_size, backend):    os.environ["MASTER_ADDR"] = "127.0.0.1"    os.environ["MASTER_PORT"] = "29500"    dist.init_process_group(backend, rank=rank, world_size=world_size)    torch.cuda.set_device(device_id)def train(model, optimizer, train_data, rank, device_id):    for i, (src, target) in enumerate(train_data):        src = src.to(device_id)        target = target.to(device_id)        optimizer.zero_grad()        output = model(src)        loss = F.mse_loss(output, target)        loss.backward()        optimizer.step()        print(f"[GPU{rank}]: batch {i}/{len(train_data)}, loss: {loss}")def main(rank, world_size, backend):    device_id = rank    setup(rank, device_id, world_size, backend)    model = SimpleNet().to(device_id)    # (4) ä½¿ç”¨DDPå°è£…æ¨¡å‹ï¼ŒDDPä¼šè‡ªåŠ¨è¿›è¡Œæ¨¡å‹çš„åˆå§‹åŒ–å‚æ•°åŒæ­¥å’Œæ‰¹æ¬¡è®­ç»ƒç»“æŸåçš„æ¢¯åº¦åŒæ­¥    model = DDP(model, device_ids=[device_id])    optimizer = torch.optim.SGD(model.parameters(), lr=1e-2)    batchsize_per_gpu = 32    dataset = MyTrainDataset(num=2048, size=512)    # (1) æ•°æ®åˆ†å‰²    sampler = torch.utils.data.distributed.DistributedSampler(        dataset, num_replicas=world_size, rank=rank    )    train_data = DataLoader(dataset, batch_size=batchsize_per_gpu, sampler=sampler)    train(model, optimizer, train_data, rank, device_id)if __name__ == "__main__":    # (2) å¤šè¿›ç¨‹å¯åŠ¨å’Œç®¡ç†    world_size = 2    mp.spawn(main, args=(world_size, "nccl"), nprocs=world_size, join=True)</code></pre><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313181709.png">ä½¿ç”¨torch.profilerå¯¹åŸºäºDDPçš„ä»£ç è¿›è¡Œæ€§èƒ½åˆ†æï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åŸºäºDDPçš„å®ç°è‡ªåŠ¨è¿›è¡Œäº†ä¸Šé¢çš„æåˆ°çš„ä¸¤ä¸ªä¼˜åŒ–ï¼š-åˆ†ç»„ä¼ è¾“ï¼šä¸ºäº†å‡å°‘æ¯ä¸ªå‚æ•°ç‹¬ç«‹è¿›è¡Œallreduceæ“ä½œæ‰€å¸¦æ¥çš„é€šä¿¡å¼€é”€ï¼Œå¯ä»¥åˆ©ç”¨<strong>åˆ†ç»„ä¼ è¾“(Bucketing)æŠ€æœ¯</strong>ã€‚è¯¥æŠ€æœ¯è‡ªåŠ¨å°†æ¨¡å‹ä¸­çš„æ‰€æœ‰ç®—å­å‚æ•°åˆ†æˆå‡ ä¸ªç»„ï¼Œæ¯ç»„çš„å‚æ•°æ¢¯åº¦è¢«åˆå¹¶æˆä¸€ä¸ªè¾ƒå¤§çš„å¼ é‡åå†æ‰§è¡Œé€šä¿¡ã€‚è¿™æ ·ï¼Œæ¯ç»„å†…çš„æ¢¯åº¦è®¡ç®—å®Œæˆååªéœ€æ‰§è¡Œä¸€æ¬¡é€šä¿¡æ“ä½œï¼Œä»è€Œå¤§å¹…é™ä½äº†é€šä¿¡æ¬¡æ•°ï¼Œæé«˜äº†è®­ç»ƒæ•ˆç‡ã€‚-é‡å è®¡ç®—å’Œé€šä¿¡ï¼šæ¢¯åº¦è®¡ç®—è¾ƒæ—©å®Œæˆçš„ç»„ä¼šä¼˜å…ˆå¯åŠ¨é€šä¿¡æ“ä½œï¼Œè¿™ä¸€è¿‡ç¨‹ä¸åç»­å±‚çš„æ¢¯åº¦è®¡ç®—é‡å ï¼Œä»è€Œå¤§å¹…å‡å°‘äº†ç”±é€šä¿¡å¼•èµ·çš„å»¶è¿Ÿã€‚</p><p>åœ¨å¤æ‚çš„å¤§è§„æ¨¡è®­ç»ƒåœºæ™¯ä¸­ï¼Œé™¤äº†DDPå·²æä¾›çš„é€šç”¨ä¼˜åŒ–æªæ–½å¤–ï¼Œå¯èƒ½è¿˜éœ€è¦æ ¹æ®å…·ä½“çš„ç¡¬ä»¶é…ç½®å’Œå®é™…éœ€æ±‚è¿›è¡Œå®šåˆ¶åŒ–çš„ä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä¾›å‚è€ƒçš„ä¼˜åŒ–ç­–ç•¥ï¼š-é™ä½é€šä¿¡é‡ï¼šé€šè¿‡æ¢¯åº¦å‹ç¼©æŠ€æœ¯å‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œä¾‹å¦‚é‡åŒ–ã€ç¨€ç–åŒ–æˆ–ä½ç§©è¿‘ä¼¼ï¼Œä»è€Œé™ä½é€šä¿¡æˆæœ¬ã€‚-æ‹“æ‰‘æ„ŸçŸ¥ç­–ç•¥ï¼šæ ¹æ®è®¡ç®—èŠ‚ç‚¹çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„è®¾è®¡æ›´é«˜æ•ˆçš„é€šä¿¡æ“ä½œï¼Œä¼˜åŒ–æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p><h3 id="æ•°æ®å¹¶è¡Œçš„æ€§ä»·æ¯”">æ•°æ®å¹¶è¡Œçš„æ€§ä»·æ¯”</h3><p>ä¸ºäº†è¯„ä¼°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ€§èƒ½å¢ç›Šï¼Œåœ¨å¤„ç†åŒæ ·çš„æ•°æ®é‡çš„å‰æä¸‹ï¼Œå¯ä»¥ä½¿ç”¨åŠ é€Ÿæ¯”è¿™ä¸€æŒ‡æ ‡æ¥è¿›è¡Œè¡¡é‡ã€‚<span class="math display">\[åŠ é€Ÿæ¯” = \frac{å•æœºå•å¡çš„è®­ç»ƒæ—¶é—´}{Nä¸ªèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒçš„æ—¶é—´}\]</span>åœ¨æ²¡æœ‰é€šä¿¡å¼€é”€çš„ç†æƒ³æƒ…å†µä¸‹ï¼ŒåŠ é€Ÿæ¯”åº”è¯¥ç­‰äºNï¼Œå³åˆ†å¸ƒå¼è®­ç»ƒçš„åŠ é€Ÿæ¯”ä¸èŠ‚ç‚¹æ•°é‡æˆæ­£æ¯”ã€‚</p><p><strong>ä½†æ˜¯éšç€èŠ‚ç‚¹æ•°é‡çš„å¢åŠ ï¼ŒèŠ‚ç‚¹é—´çš„é€šä¿¡é‡å’Œé€šä¿¡æ¬¡æ•°é€šå¸¸ä¹Ÿä¼šç›¸åº”å¢åŠ ï¼Œè¿™å¯¼è‡´é€šä¿¡å»¶è¿Ÿé€æ¸å¢å¤§</strong>ã€‚ä¸€æ—¦å¢åŠ èŠ‚ç‚¹å¸¦æ¥çš„é€šä¿¡å¼€é”€æŠµæ¶ˆäº†å¹¶è¡Œè®¡ç®—å¸¦æ¥çš„å¥½å¤„ï¼Œå†æ‰©å±•ä¸‹å»å°±å¾—ä¸å¿å¤±äº†ã€‚</p><p>ä½¿ç”¨PyTorchçš„<code>DistributedDataParallel</code>æ¨¡å—ä¸­æä¾›çš„<code>register_comm_hook()</code>æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å°†DDPä¸­é»˜è®¤çš„èŠ‚ç‚¹é€šä¿¡å‡½æ•°æ›¿æ¢ä¸ºè‡ªå®šä¹‰å‡½æ•°ï¼Œä»è€Œè·å–æ›´ç²¾ç¡®çš„é€šä¿¡å¼€é”€æ•°æ®ã€‚</p><h3 id="å…¶ä»–æ•°æ®ç»´åº¦çš„åˆ‡åˆ†">å…¶ä»–æ•°æ®ç»´åº¦çš„åˆ‡åˆ†</h3><p>å‰é¢ä»‹ç»çš„éƒ½æ˜¯åœ¨BatchSizeç»´åº¦ä¸Šå¯¹æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œå¯¹äºæ–‡æœ¬ã€è§†é¢‘ç­‰é•¿åºåˆ—æ•°æ®ï¼Œå…¶åºåˆ—é•¿åº¦(sequencelength)ä¹Ÿä¼šå¯¹è®­ç»ƒæ€§èƒ½å’Œæ˜¾å­˜å ç”¨äº§ç”Ÿå¾ˆå¤§å½±å“ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯åŸºäºTransformerçš„å¤§å‹è¯­è¨€æ¨¡å‹åœ¨å¤„ç†è¶…é•¿æ–‡æœ¬æ—¶ï¼Œç”±äºå…¶è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œä¸­é—´å˜é‡æ‰€éœ€çš„æ˜¾å­˜ä¼šéšåºåˆ—é•¿åº¦çš„å¢é•¿è€Œæˆå¹³æ–¹çº§çš„å¢åŠ ï¼Œè¿™å¾ˆå®¹æ˜“è¶…è¿‡å•ä¸ªGPUçš„æ˜¾å­˜å®¹é‡ã€‚å› æ­¤ï¼Œé™¤äº†æ•°æ®å¹¶è¡Œä¹‹å¤–ï¼Œè¿˜å¯èƒ½éœ€è¦é‡‡ç”¨<strong>åºåˆ—å¹¶è¡Œ(sequenceparallel)</strong>ã€<strong>ä¸Šä¸‹æ–‡å¹¶è¡Œ(contextparallel)</strong>ç­‰ç­–ç•¥æ¥å¤„ç†å•ä¸ªæ ·æœ¬ä¸­çš„é•¿åºåˆ—ã€‚</p><h2 id="åº”å¯¹æ¨¡å‹å¢é•¿çš„å¹¶è¡Œç­–ç•¥">åº”å¯¹æ¨¡å‹å¢é•¿çš„å¹¶è¡Œç­–ç•¥</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313190247.png"></p><h3 id="é™æ€æ˜¾å­˜åˆ‡åˆ†">é™æ€æ˜¾å­˜åˆ‡åˆ†</h3><p>å•å¡ç¯å¢ƒä¸­ï¼Œå¾€å¾€åªèƒ½é€šè¿‡å°†é™æ€æ˜¾å­˜ä¸‹æ”¾åˆ°CPUæ¥ç¼“è§£æ˜¾å­˜å‹åŠ›ï¼Œä½†åœ¨å¤šGPUç¯å¢ƒä¸­ï¼Œå¾—ç›ŠäºNVLinkæˆ–InfiniBand,GPUé—´çš„é€šä¿¡æ•ˆç‡è¦è¿œè¶…GPU-CPUé—´çš„é€šä¿¡æ•ˆç‡ï¼Œå› æ­¤ï¼Œå°†é™æ€æ˜¾å­˜åˆ†å—å­˜å‚¨åœ¨ä¸åŒçš„GPUä¸Šï¼Œæœ¬è´¨ä¸Šæ˜¯å°†æŒç»­å ç”¨æ˜¾å­˜çš„é™æ€æ•°æ®è½¬å˜ä¸ºåŠ¨æ€çš„â€œæŒ‰éœ€åˆ†é…â€ï¼Œä»è€Œæœ‰æ•ˆé™ä½å•GPUæ˜¾å­˜å ç”¨çš„å³°å€¼ã€‚</p><p>åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œé™æ€æ˜¾å­˜çš„åˆ†å—å­˜å‚¨å¸¸ä½œä¸ºæ˜¾å­˜ä¼˜åŒ–æ‰‹æ®µä¸å…¶ä»–åˆ†å¸ƒå¼ç­–ç•¥ç»“åˆä½¿ç”¨ï¼š<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313191415.png"></p><p>Deepspeedå’ŒFairscaleæ¨å‡ºçš„ZeROå’ŒFSDPç­–ç•¥å‡åŸºäºæ­¤æ€è·¯å¼€å‘ï¼Œä»¥ZeROç­–ç•¥ä¸ºä¾‹ï¼Œå…¶æ˜¾å­˜åˆ‡åˆ†å®ç°äº†ä¸‰ä¸ªçº§åˆ«çš„ä¼˜åŒ–ï¼š- ZeRO-1ï¼šåˆ‡åˆ†ä¼˜åŒ–å™¨çŠ¶æ€åˆ†æ•£åˆ°å¤šä¸ªGPUä¸Šå­˜å‚¨ã€‚ -ZeRO-2ï¼šåˆ‡åˆ†æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€åˆ†æ•£åˆ°å¤šä¸ªGPUä¸Šå­˜å‚¨ã€‚ -ZeRO-3ï¼šåˆ‡åˆ†æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€å’Œæ¨¡å‹å‚æ•°åˆ†æ•£åˆ°å¤šä¸ªGPUä¸Šå­˜å‚¨ã€‚</p><p>ZeROç­–ç•¥åœ¨PyTorchä»¥åŠä¹‹å‰æåˆ°çš„Accelerateå’ŒDeepspeedæ¡†æ¶ä¸­å‡æœ‰å¯¹åº”çš„å®ç°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313192314.png"></p><p>ä»¥ä¸Šå›¾ä¸­çš„7.5Bæ¨¡å‹ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰N=64å—GPUè¿›è¡Œæ•°æ®å¹¶è¡Œè®­ç»ƒï¼Œ -åœ¨ZeRO-1é˜¶æ®µï¼Œä¼˜åŒ–å™¨çš„çŠ¶æ€é‡é¦–å…ˆè¢«åˆ†æ•£å­˜å‚¨åˆ°æ‰€æœ‰GPUä¸­ï¼Œæ­¤æ—¶å•å¼ GPUä¸Šçš„å†…å­˜ä½¿ç”¨é‡éª¤é™åˆ°(4+4+8/64)<em>7.5=60.9GBã€‚-ZeRO-2é˜¶æ®µè¿›ä¸€æ­¥åœ°å°†æ¨¡å‹çš„æ¢¯åº¦ä¹Ÿåˆ†æ•£å­˜å‚¨ï¼Œæ­¤æ—¶å•å¼ GPUä¸Šçš„å†…å­˜ä½¿ç”¨é‡ä¾¿æ˜¯(4+(4+8)/64)</em>7.5=31.4GBã€‚-ZeRO-3é˜¶æ®µå°†æ¨¡å‹çš„å‚æ•°ä¹Ÿåˆ†æ•£å­˜å‚¨åˆ°Nä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶æ¯å¼ GPUçš„å†…å­˜æ¶ˆè€—åªæœ‰(4+4+8)/64*7.5=1.875GBã€‚</p><h3 id="åŠ¨æ€æ˜¾å­˜åˆ‡åˆ†">åŠ¨æ€æ˜¾å­˜åˆ‡åˆ†</h3><h4 id="æ¨¡å‹å¹¶è¡Œæµæ°´çº¿å¹¶è¡Œ">æ¨¡å‹å¹¶è¡Œ/æµæ°´çº¿å¹¶è¡Œ</h4><p>ç”±äºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç»“æ„å¤©ç„¶æ˜¯ä¸€å±‚ä¸€å±‚è¿èµ·æ¥çš„ï¼Œå› æ­¤ä¸€ä¸ªç›´è§‚çš„åˆ‡åˆ†æ–¹æ³•æ˜¯å°†ä¸åŒçš„æ¨¡å‹å±‚åˆ†é…åˆ°ä¸åŒçš„GPUä¸Šï¼Œæ¯ä¸ªGPUåªè´Ÿè´£æ¨¡å‹å‡ ä¸ªå±‚çš„è®¡ç®—ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†ç¥ç»ç½‘ç»œçš„å‰å‡ å±‚æ”¾ç½®åœ¨ä¸€ä¸ªGPUä¸Šï¼Œéšåçš„å‡ å±‚æ”¾åœ¨å¦ä¸€ä¸ªGPUä¸Šï¼Œä¾æ­¤ç±»æ¨ã€‚è¿™æ ·ï¼Œæ•´ä¸ªæ¨¡å‹è¢«åˆ†æˆå‡ ä¸ªé˜¶æ®µï¼Œé˜¶æ®µä¹‹é—´ç”±é€šä¿¡ä¸²è”èµ·æ¥ï¼Œåƒä¸€æ¡æµæ°´çº¿ä¸€æ ·å¤„ç†ä¸€æ‰¹ä¸€æ‰¹çš„æ•°æ®ï¼Œå› æ­¤è¿™ç§æ–¹æ³•è¢«ç§°ä¸º<strong>æµæ°´çº¿å¹¶è¡Œ(pipelineparallel)</strong>ã€‚</p><p>å¦‚å›¾æ‰€ç¤ºä¸€ä¸ªæ¨¡å‹å…±æœ‰7å±‚ï¼Œå…¶ä¸­ç¬¬4å±‚çš„è®¡ç®—éœ€æ±‚æœ€å¤§ï¼Œå…¶ä»–å±‚è¾ƒå°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å±‚é—´è¿›è¡Œåˆ‡åˆ†ï¼Œå¦‚å°†å‰3å±‚ã€ä¸­é—´1å±‚å’Œæœ€å3å±‚åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„GPUä¸Šè¿›è¡Œå¤„ç†ï¼Œå¹¶é€šè¿‡èŠ‚ç‚¹é€šä¿¡å°†å¤„ç†ç»“æœåŒæ­¥åˆ°ä¸‹ä¸€ä¸ªGPUä¸­å‚ä¸åç»­è®¡ç®—ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313195204.png"></p><p>å¾ˆæ˜æ˜¾è¿™ç§ä¸²è¡Œçš„æ‰§è¡Œæ–¹å¼ä¼šå¯¼è‡´GPUåˆ©ç”¨ç‡ä¸å‡è¡¡ï¼Œé€šè¿‡è·Ÿè¸ªä¸€ä¸ªæ•°æ®æ‰¹æ¬¡åœ¨æ¨¡å‹ä¸­çš„å¤„ç†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°GPUå¤§éƒ¨åˆ†æ—¶é—´å¤„äºé—²ç½®çŠ¶æ€ï¼ˆâ€œæ°”æ³¡â€ï¼‰ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313195534.png"></p><p>ä¸ºäº†æé«˜æ•ˆç‡å¯ä»¥å°†å¤§çš„æ‰¹æ¬¡æ•°æ®åˆ†ä¸ºè‹¥å¹²ä¸ªå°æ‰¹æ¬¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ¯æ¬¡ä»…å¤„ç†ä¸€ä¸ªå°æ‰¹æ¬¡ï¼Œè¿™æ ·åœ¨åŸå…ˆç­‰å¾…çš„æ°”æ³¡æ—¶é—´é‡Œå°±å¯ä»¥å¤„ç†ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®(Gpipe)ã€‚ç”šè‡³å¯ä»¥è®©æ¯ä¸ªèŠ‚ç‚¹äº¤æ›¿è¿›è¡Œå‰å‘å’Œåå‘è®¡ç®—ï¼Œè¿™æ ·å¯ä»¥å°½æ—©åœ°å¯åŠ¨åå‘è¿ç®—çš„æµæ°´çº¿ï¼Œç¼©çŸ­ä¸­é—´èŠ‚ç‚¹çš„ç­‰å¾…æ—¶é—´(PipeDream)ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313195833.png">å¦‚å›¾å±•ç¤ºäº†ä¸€ä¸ªè¢«åˆ’åˆ†æˆ4ä¸ªé˜¶æ®µçš„æ¨¡å‹ï¼Œæ¯ä¸ªé˜¶æ®µåœ¨ä¸€å°GPUä¸Šè¿è¡Œã€‚åŒæ—¶ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®ä¹Ÿè¢«åˆ†ä¸º4ä¸ªå°æ‰¹æ¬¡ï¼Œä¾æ¬¡ä»GPU0å¼€å§‹è®¡ç®—ï¼Œé€æ­¥ä¼ æ’­åˆ°GPU3å¹¶è®¡ç®—æŸå¤±å€¼ï¼Œä¸€æ—¦GPU3å®Œæˆäº†ç¬¬ä¸€ä¸ªå°æ‰¹æ¬¡çš„å‰å‘ä¼ é€’ï¼Œå®ƒç«‹åˆ»å°±ä¼šå¯¹åŒä¸€ä¸ªå°æ‰¹æ¬¡æ‰§è¡Œåå‘ä¼ é€’ï¼Œç„¶åå¼€å§‹åœ¨åç»­å°æ‰¹æ¬¡ä¹‹é—´äº¤æ›¿è¿›è¡Œå‰å‘å’Œåå‘ä¼ é€’ã€‚éšç€åå‘ä¼ é€’å¼€å§‹å‘æµæ°´çº¿ä¸­è¾ƒæ—©çš„é˜¶æ®µä¼ æ’­ï¼Œæ¯ä¸ªé˜¶æ®µå¼€å§‹åœ¨ä¸åŒå°æ‰¹æ¬¡ä¹‹é—´äº¤æ›¿è¿›è¡Œå‰å‘å’Œåå‘ä¼ é€’ï¼Œå› æ­¤â€œæ°”æ³¡â€å¯ä»¥è¢«æœ‰æ•ˆæ¶ˆé™¤ã€‚</p><h4 id="å¼ é‡å¹¶è¡Œ">å¼ é‡å¹¶è¡Œ</h4><p>ä½†æ˜¯å½“æ¨¡å‹ä¸­æ˜¾å­˜å ç”¨æœ€å¤§çš„å±‚æ— æ³•åœ¨å•ä¸ªGPUä¸Šè¿è¡Œæ—¶ï¼Œæµæ°´çº¿å¹¶è¡Œç­–ç•¥å°±æ— æ³•ç»§ç»­ä½¿ç”¨ã€‚</p><p><strong>å¼ é‡å¹¶è¡Œ(tensorparallel)ç­–ç•¥</strong>ä¸»è¦æ˜¯é€šè¿‡çŸ©é˜µä¹˜æ³•çš„åˆ†å—è®¡ç®—ï¼Œå®ç°å•å¡æ— æ³•å®¹çº³çš„å¤§å‹çŸ©é˜µä¹˜æ³•æ“ä½œã€‚æ¯”å¦‚è¦å®ç°ä¸‹çŸ©é˜µä¹˜æ³•Y=XÃ—Wï¼Œåœ¨å‚æ•°çŸ©é˜µWéå¸¸å¤§ç”šè‡³è¶…å‡ºå•å¼ å¡çš„æ˜¾å­˜å®¹é‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒåœ¨ç‰¹å®šç»´åº¦ï¼ˆåˆ—æˆ–è€…è¡Œï¼‰ä¸Šåˆ‡åˆ†åˆ°å¤šå¼ å¡ä¸Šï¼Œæœ€åé€šè¿‡all-gather/all-reduceæ“ä½œæ±‡æ€»ï¼Œç»“æœåœ¨æ•°å­¦ä¸Šéƒ½ä¸ç›´æ¥åšY=XÃ—Wç­‰ä»·ã€‚</p><p>æŒ‰åˆ—åˆ‡å—çš„è®¡ç®—è¿‡ç¨‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313200600.png"></p><p>æŒ‰è¡Œåˆ‡å—çš„è®¡ç®—è¿‡ç¨‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313200929.png"></p><p>ä¸æµæ°´çº¿å¹¶è¡Œèƒ½åœ¨å¤šå°æœºå™¨ååŒè®­ç»ƒä¸åŒï¼Œå¼ é‡å¹¶è¡Œéœ€è¦ä¼ è¾“å¤§é‡æ•°æ®ï¼Œå½“è¿™ç§ä¼ è¾“éœ€è¦é€šè¿‡ç½‘ç»œè®¾å¤‡è·¨æœºå™¨è¿›è¡Œæ—¶ï¼Œå—é™çš„ç½‘ç»œå¸¦å®½ä¼šä¸¥é‡é˜»ç¢å¼ é‡å¹¶è¡Œè®­ç»ƒçš„æ•ˆç‡ã€‚å› æ­¤ï¼Œ<strong>å¼ é‡å¹¶è¡Œé€šå¸¸åªåœ¨é…å¤‡äº†NVLinkçš„å•æœºå¤šå¡èŒƒå›´ä¸­ä½¿ç”¨</strong>ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313201242.png"></p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> åˆ†å¸ƒå¼è®­ç»ƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-å•å¡æ˜¾å­˜ä¼˜åŒ–ä¸“é¢˜</title>
      <link href="/2025/03/12/da-mo-xing-dong-li-yin-qing-dan-qia-xian-cun-you-hua-zhuan-ti/"/>
      <url>/2025/03/12/da-mo-xing-dong-li-yin-qing-dan-qia-xian-cun-you-hua-zhuan-ti/</url>
      
        <content type="html"><![CDATA[<h2 id="pytorchçš„æ˜¾å­˜ç®¡ç†æœºåˆ¶">Pytorchçš„æ˜¾å­˜ç®¡ç†æœºåˆ¶</h2><p><strong>æ˜¾å­˜æ± æœºåˆ¶</strong>:æ¯å½“éœ€è¦ä¸ºå¼ é‡åˆ†é…æ˜¾å­˜æ—¶ï¼ŒPyTorchä¸ä¼šåªç”³è¯·å¼ é‡æ‰€éœ€çš„æ˜¾å­˜å¤§å°ï¼Œè€Œæ˜¯å‘é©±åŠ¨ä¸€æ¬¡æ€§ç”³è¯·ä¸€å—æ›´å¤§çš„æ˜¾å­˜ç©ºé—´ï¼Œè¿™æ ·å¤šå‡ºæ¥çš„æ˜¾å­˜ç©ºé—´å°±ä¼šè¢«æ˜¾å­˜æ± ç¼“å­˜ä¸‹æ¥ã€‚é™¤æ­¤ä»¥å¤–ï¼Œä»»ä½•å¼ é‡åœ¨é”€æ¯åï¼Œå…¶å ç”¨çš„æ˜¾å­˜ç©ºé—´ä¹Ÿä¸ä¼šç›´æ¥å½’è¿˜ç»™GPUé©±åŠ¨ï¼Œè€Œæ˜¯åŒæ ·è¢«æ˜¾å­˜æ± ç¼“å­˜ä¸‹æ¥ã€‚</p><p>è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œå½“éœ€è¦å†æ¬¡ä¸ºæ–°å¼ é‡åˆ†é…æ˜¾å­˜æ—¶ï¼Œå°±å¯ä»¥ä»æ˜¾å­˜æ± çš„ç¼“å­˜ä¸­è¿›è¡Œåˆ†é…ï¼Œè€Œä¸éœ€è¦æ•ˆç‡ä½ä¸‹çš„GPUé©±åŠ¨æ¥ä»GPUå†…å­˜ä¸­ç”³è¯·ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312233317.png"></p><p>ä½†æ˜¯æ˜¾å­˜æ± ä¼šå¯¼è‡´PyTorchæ€»æ˜¯å ç”¨æ¯”å®é™…éœ€æ±‚æ›´å¤šçš„æ˜¾å­˜ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¾å­˜æ± é¢å¤–å ç”¨çš„æ˜¾å­˜ä¸ä¼šå¤ªå¤§ï¼Œä½†æ˜¯<strong>ä¸€æ—¦è¿›è¡Œäº†åˆ é™¤æ¨¡å‹ã€åˆ é™¤å¤§ä½“ç§¯å¼ é‡ç­‰é‡Šæ”¾å¤§é‡æ˜¾å­˜çš„æ“ä½œåï¼Œè¢«ç¼“å­˜ä¸‹æ¥è€Œæ— æ³•é‡Šæ”¾çš„æ˜¾å­˜é‡å°±éå¸¸å¤§äº†ï¼Œç”šè‡³ä¼šå½±å“ç¨‹åºçš„åç»­æ‰§è¡Œ</strong>ã€‚è¿™æ—¶éœ€è°ƒç”¨<strong>torch.cuda.empty_cache()</strong>æ¥å£ï¼Œå°½å¯èƒ½é‡Šæ”¾æ‰€æœ‰å®Œå…¨ç©ºé—²çš„æ˜¾å­˜æ®µã€‚</p><p>ä½†æ˜¯<strong>torch.cuda.empty_cache()</strong>æ¥å£åªèƒ½é‡Šæ”¾å®Œå…¨ç©ºé—²çš„æ˜¾å­˜æ®µï¼Œè€Œ<strong>æ˜¾å­˜æ± </strong>ä¸­è¿˜å¯ä»¥å­˜åœ¨ä¸€äº›ç¢ç‰‡æ®µï¼ˆæ•´ä¸ªæ˜¾å­˜æ®µä¸­åªæœ‰å°éƒ¨åˆ†ç©ºé—´è¢«å ç”¨ï¼‰ã€‚</p><p>é€šè¿‡è°ƒå°ç¯å¢ƒå˜é‡<strong>PYTORCH_CUDA_ALLOC_CONF</strong>æ¥æ‹’ç»PyTorchåˆ†å‰²æ¯”è¯¥å‚æ•°å¤§çš„æ˜¾å­˜æ®µï¼Œå¯ä»¥åœ¨æ˜¾å­˜æ®µå‰©ä½™ç©ºé—´å·²ç»å¾ˆå°æ—¶é˜»æ­¢PyTorchç»§ç»­åˆ†å‰²ï¼Œä»è€Œæœ‰æ•ˆé˜»æ­¢æ˜¾å­˜ç¢ç‰‡åŒ–ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">export PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128</code></pre><p></p><h2 id="æ˜¾å­˜çš„åˆ†ææ–¹æ³•">æ˜¾å­˜çš„åˆ†ææ–¹æ³•</h2><h3 id="pytorchæ˜¾å­˜åˆ†æapi">Pytorchæ˜¾å­˜åˆ†æAPI</h3><p>é™¤äº†ä½¿ç”¨nvidia-smiæŸ¥çœ‹æ˜¾å­˜å ç”¨ï¼ŒPytorchè¿˜æä¾›äº†ä¸€äº›APIæ¥æŸ¥è¯¢æ˜¾å­˜å®æ—¶æ•°æ®ï¼š<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312235550.png">reservedè¡¨ç¤ºPyTorchå®é™…é¢„ç•™çš„æ˜¾å­˜å¤§å°ï¼Œä½†è¿™äº›é¢„ç•™çš„æ˜¾å­˜ä¸ä¸€å®šä¼šç«‹å³ä½¿ç”¨ï¼›è€Œallocatedè¡¨ç¤ºå®é™…åˆ†é…ç»™å¼ é‡çš„æ˜¾å­˜ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torcht1 = torch.randn([1024, 1024], device="cuda:0")  # 4MBshape = [256, 1024, 1024, 1]  # 1024MBt2 = torch.randn(shape, device="cuda:0")print(    f"PyTorch reserved {torch.cuda.memory_reserved()/1024/1024}MB, allocated {torch.cuda.memory_allocated()/1024/1024}MB")# PyTorch reserved 1044.0MB, allocated 1028.0MB</code></pre><p></p><p>ä¸€èˆ¬æˆ‘ä»¬ä¼šæ›´åŠ å…³æ³¨å¦‚ä½•å°†å³°å€¼æ˜¾å­˜é™åˆ¶åœ¨OOMçš„è¾¹ç¼˜ï¼Œæ‰€ä»¥<code>cuda.max_memory_allocated()</code>å’Œ<code>cuda.max_memory_reserved()</code>è¿™ä¸¤ä¸ªAPIä¼šæ›´æœ‰å‚è€ƒä»·å€¼ã€‚</p><p>æ³¨æ„ä½¿ç”¨ä»¥ä¸ŠAPIåªèƒ½æŸ¥è¯¢Pytorchçš„æ˜¾å­˜å ç”¨ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–ç¬¬ä¸‰æ–¹åº“è°ƒç”¨æ¥CUDAAPIæ¥åˆ†é…ç®¡ç†æ˜¾å­˜ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨<code>nvidia-smi</code>æ¥æŸ¥çœ‹ã€‚</p><h3 id="pytorchæ˜¾å­˜åˆ†æå™¨">Pytorchæ˜¾å­˜åˆ†æå™¨</h3><p>æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨PyTorchçš„<code>torch.cuda.memory._record_memory_history()</code>å’Œ<code>torch.cuda.memory._dump_snapshot()</code>åŠŸèƒ½æ¥ç»˜åˆ¶æ˜¾å­˜å ç”¨åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„å˜åŒ–æ›²çº¿ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchtorch.cuda.memory._record_memory_history()with torch.inference_mode():      # ç¦ç”¨æ‰€æœ‰ä¸åå‘ä¼ æ’­ç›¸å…³çš„é¢å¤–æ˜¾å­˜åˆ†é…æ“ä½œ    shape = [256, 1024, 1024, 1]    x1 = torch.randn(shape, device="cuda:0")    x2 = torch.randn(shape, device="cuda:0")    # Multiplication    y = x1 * x2torch.cuda.memory._dump_snapshot("traces/vram_profile_example.pickle")</code></pre><p>å°†ç»“æœä¸Šä¼ åˆ°<a href="https://pytorch.org/memory_viz">PyTorch MemoryVisualization</a>ï¼Œå¯ä»¥å¾—åˆ°æ˜¾å­˜å ç”¨åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„å˜åŒ–æ›²çº¿ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313001506.png">ç‚¹å‡»æ¡å¹…è§¦å‘ç›¸åº”æ˜¾å­˜åˆ†é…çš„ç¨‹åºè°ƒç”¨æ ˆï¼Œä»è€Œäº†è§£è¯¥æ˜¾å­˜åˆ†é…ä¸å“ªäº›Pythonä»£ç å¯¹åº”ã€‚</p><h2 id="è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ˜¾å­˜å ç”¨">è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ˜¾å­˜å ç”¨</h2><p>è®­ç»ƒæ—¶çš„æ˜¾å­˜å ç”¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š -é™æ€å ç”¨ï¼šæ¨¡å‹å‚æ•°ã€ä¼˜åŒ–å™¨çŠ¶æ€ã€æ¢¯åº¦ç­‰å›ºå®šå ç”¨ -åŠ¨æ€å ç”¨ï¼šä¸´æ—¶æ˜¾å­˜å ç”¨ï¼ˆä¸­é—´æ¿€æ´»å€¼ç­‰ï¼‰</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchtorch.cuda.memory._record_memory_history()with torch.inference_mode():    shape = [256, 1024, 1024, 1]    weight = torch.randn(shape, device="cuda:0")  # (1)    data = torch.randn(shape, device="cuda:0")  # (2)    x = data * weight  # (3)    x = x * weight  # (4)    x = x.sum()torch.cuda.memory._dump_snapshot("traces/double_muls_inference.pickle")</code></pre><p>ç¤ºä¾‹ä»£ç çš„æ˜¾å­˜å ç”¨å›¾ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313002508.png"></p><p>å†ç»“åˆåå‘è¿‡ç¨‹çœ‹çœ‹å®Œæ•´çš„æ˜¾å­˜å ç”¨ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.optim as optimtorch.cuda.memory._record_memory_history()shape = [256, 1024, 1024, 1]weight = torch.randn(shape, requires_grad=True, device="cuda:0")data = torch.randn(shape, requires_grad=False, device="cuda:0")x = data * weightx = x * weightx = x.sum()torch.cuda.memory._dump_snapshot("triple_muls_fwd.pickle")optimizer = optim.SGD([weight], lr=0.01)optimizer.zero_grad()x.backward()optimizer.step()torch.cuda.memory._dump_snapshot("traces/double_muls_full.pickle")</code></pre><p></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313010941.png"></p><p>æ³¨æ„ä¸ä¹‹å‰ä¸åŒçš„æ˜¯ï¼Œçº¢è‰²æ¡å¹…åœ¨æ­¤è¿‡ç¨‹ä¸­çš„å­˜åœ¨æ—¶é—´æ›´é•¿ï¼Œä¸€ç›´æŒç»­åˆ°åå‘ä¼ æ’­çš„ä¸­æ®µæ‰ç»“æŸã€‚çº¢è‰²æ¡å¹…ä»£è¡¨x= x<em>weightä¸­ä¸´æ—¶è¾“å‡ºå˜é‡çš„æ˜¾å­˜ï¼Œæ²¡æœ‰åœ¨è¿ç®—ç»“æŸåç«‹åˆ»é‡Šæ”¾çš„åŸå› åœ¨äºï¼Œx =x</em>weighté‡Œçš„ä¹˜æ³•ç®—å­éœ€è¦ä¿å­˜è¾“å‡ºå¼ é‡çš„æ•°å€¼ä»¥è¿›è¡Œåå‘è®¡ç®—ï¼Œæ‰€ä»¥è¿™ä¸ªä¸´æ—¶å˜é‡è¢«ä¿å­˜åˆ°äº†åå‘ç®—å­çš„æˆå‘˜ä¸­ï¼ˆè§ä¸‹è¿°å…¬å¼ï¼‰ã€‚<span class="math display">\[[MulForward]out=x*y[MulBackward]d_x=d_out*y[MulBackward]d_y=d_out*x\]</span></p><h2 id="é€šç”¨æ˜¾å­˜å¤ç”¨æ–¹æ³•">é€šç”¨æ˜¾å­˜å¤ç”¨æ–¹æ³•</h2><h3 id="ä½¿ç”¨åŸä½æ“ä½œç®—å­">ä½¿ç”¨åŸä½æ“ä½œç®—å­</h3><p>PyTorchè¿˜æä¾›äº†ä¸€ç³»åˆ—çš„åŸä½æ“ä½œç®—å­ã€‚è¿™äº›ç®—å­çš„ç‰¹ç‚¹æ˜¯å®ƒä»¬ç›´æ¥å¯¹è¾“å…¥å¼ é‡çš„æ˜¾å­˜è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸éœ€è¦ä¸ºè¾“å‡ºå¼ é‡åˆ†é…é¢å¤–çš„æ˜¾å­˜ï¼Œä»è€Œæ˜¾è‘—é™ä½ç®—å­è°ƒç”¨çš„æ˜¾å­˜å ç”¨ã€‚</p><p>ä½†æ˜¯å¦‚æœåœ¨è®¡ç®—æ¢¯åº¦æ—¶ï¼Œåå‘ä¼ æ’­ç®—æ³•ä¾èµ–äºå‰å‘ä¼ æ’­ä¸­çš„æŸä¸ªå¼ é‡ï¼Œè€Œè¿™ä¸ªå¼ é‡è¢«åŸä½æ“ä½œä¿®æ”¹è¿‡ï¼Œé‚£ä¹ˆæ¢¯åº¦çš„è®¡ç®—å°±å¯èƒ½å‡ºç°é”™è¯¯ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼ŒPyTorchå¼•å…¥äº†ä¸€ç§åŸºäºç‰ˆæœ¬çš„æ£€æŸ¥æœºåˆ¶ã€‚æ¯å½“å¼ é‡çš„å€¼é€šè¿‡åŸä½æ“ä½œå‘ç”Ÿæ”¹å˜ï¼Œå®ƒçš„ç‰ˆæœ¬å·å°±ä¼šå¢åŠ ã€‚åœ¨è¿›è¡Œåå‘ä¼ æ’­æ—¶ï¼Œå¦‚æœå‘ç°æ‰€ä¾èµ–çš„å¼ é‡ç‰ˆæœ¬å·²ç»ä¸æ˜¯æœ€æ–°çš„ï¼Œåˆ™ä¼šç«‹å³åœæ­¢å¹¶æŠ›å‡ºé”™è¯¯ä¿¡æ¯ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æ¢¯åº¦è®¡ç®—çš„å‡†ç¡®æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><h3 id="ä½¿ç”¨å…±äº«å­˜å‚¨">ä½¿ç”¨å…±äº«å­˜å‚¨</h3><p>Pytorchåœ¨å°†ä¸€ä¸ªå¼ é‡èµ‹å€¼ç»™å¦ä¸€ä¸ªå¼ é‡æ—¶ï¼Œä¸€èˆ¬æ˜¯æµ…æ‹·è´ï¼Œå³å…±äº«åŒä¸€å—æ˜¾å­˜ã€‚</p><p>é™¤äº†èµ‹å€¼æ“ä½œå¤–ï¼ŒPyTorchè¿˜æä¾›äº†è§†å›¾(view)æ“ä½œï¼Œä¸èµ‹å€¼æ“ä½œä¸­ä»…ä»…åˆ›å»ºä¸€ä¸ªå¼ é‡çš„å¼•ç”¨ä¸åŒï¼Œè§†å›¾æ“ä½œè¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„å¼ é‡ï¼Œè¯¥å¼ é‡ä¸è¾“å…¥å¼ é‡å…±äº«åº•å±‚çš„æ˜¾å­˜æ•°æ®ï¼ˆå­é›†æ•°æ®ï¼‰ã€‚## æœ‰ä»£ä»·çš„æ˜¾å­˜ä¼˜åŒ–æŠ€å·§ ### è·¨æ‰¹æ¬¡æ¢¯åº¦ç´¯åŠ å¦‚æœå—é™äºç¡¬ä»¶èµ„æºï¼Œæ— æ³•è¾¾åˆ°ç†æƒ³çš„BatchSizeï¼Œå¯ä»¥é€šè¿‡ç‰ºç‰²ä¸€äº›è®­ç»ƒé€Ÿåº¦æ¥å¢åŠ BatchSizeï¼Œå³ä½¿ç”¨<strong>è·¨æ‰¹æ¬¡æ¢¯åº¦ç´¯åŠ (cross-batchgradient accumulation)</strong>ã€‚è¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ˜¯é™ä½ä¼˜åŒ–å™¨æ¢¯åº¦æ›´æ–°çš„é¢‘ç‡â€”â€”é€šè¿‡ç´¯ç§¯å¤šè½®è®­ç»ƒçš„æ¢¯åº¦ï¼Œæœ€åå†ä¸€èµ·æ›´æ–°ï¼Œä»è€Œå®ç°å¢å¤§BatchSizeçš„æ•ˆæœã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.optim as optimtorch.manual_seed(1000)N = 128Total_N = 512dataset = torch.randn([Total_N, 32, 1024], requires_grad=False)weight = torch.randn([1024, 32], requires_grad=True, device="cuda:0")optimizer = optim.SGD([weight], lr=0.01)num_iters = int(Total_N / 256)steps = 2for i in range(num_iters):    # ---------------æ¨¡æ‹Ÿä¸€ä¸ªæ‰¹æ¬¡çš„è®­ç»ƒstart---------------    optimizer.zero_grad()    for j in range(steps):        offset = i * 256 + N * j        input = dataset[offset : offset + N, :, :].to(torch.device("cuda:0"))        y = input.matmul(weight)        loss = y.sum()        loss.backward()    optimizer.step()    # ---------------æ¨¡æ‹Ÿä¸€ä¸ªæ‰¹æ¬¡çš„è®­ç»ƒend---------------print(weight.sum())print(f"æ˜¾å­˜åˆ†é…çš„å³°å€¼: {torch.cuda.max_memory_allocated()/1024/1024}MB")# è¾“å‡ºï¼š# tensor(2096.2283, device='cuda:0', grad_fn=&lt;SumBackward0&gt;)# æ˜¾å­˜åˆ†é…çš„å³°å€¼: 49.00048828125MB</code></pre><h3 id="å³ä½¿é‡ç®—å‰å‘å¼ é‡">å³ä½¿é‡ç®—å‰å‘å¼ é‡</h3><p>PyTorché€šå¸¸ä¼šå°†æŸäº›å‰å‘å¼ é‡ç›´æ¥å­˜å‚¨åˆ°åå‘ç®—å­ä¸­ï¼Œä»¥ä¾¿åœ¨åå‘ä¼ æ’­æ—¶ä½¿ç”¨ã€‚è¿™ä¼šå¯¼è‡´è¿™äº›å‰å‘å¼ é‡æ— æ³•è¢«é‡Šæ”¾ï¼ŒæŒç»­å ç”¨æ˜¾å­˜ç›´åˆ°ç›¸åº”çš„åå‘è®¡ç®—å®Œæˆä¸ºæ­¢ã€‚</p><p>æ­¤æ—¶å¯ä»¥é€šè¿‡<code>torch.utils.checkpoint</code>æ¥å£æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œåœ¨åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—è¿™äº›å‰å‘å¼ é‡ï¼Œè€Œä¸æ˜¯ç›´æ¥å­˜å‚¨å®ƒä»¬ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnfrom torch.utils.checkpoint import checkpoint_sequentialmodel = nn.Sequential(    nn.Linear(1000, 40000),    nn.ReLU(),    nn.Linear(40000, 1000),    nn.ReLU(),    nn.Linear(1000, 5),    nn.ReLU(),).to("cuda")input_var = torch.randn(10, 1000, device="cuda", requires_grad=True)segments = 2            modules = [module for k, module in model._modules.items()] # å°†æ¨¡å‹åˆ†æˆè‹¥å¹²æ®µï¼Œåœ¨æ¯æ®µçš„å‰å‘ä¼ æ’­ç»“æŸåä¸¢å¼ƒä¸­é—´æ¿€æ´»å€¼ï¼Œå¹¶åœ¨åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—è¿™äº›å€¼ã€‚# (1). ä½¿ç”¨checkpointæŠ€æœ¯out = checkpoint_sequential(modules, segments, input_var)     model.zero_grad()out.sum().backward()print(f"ä½¿ç”¨checkpointæŠ€æœ¯æ˜¾å­˜åˆ†é…å³°å€¼: {torch.cuda.max_memory_allocated()/1024/1024}MB")# ä½¿ç”¨checkpointæŠ€æœ¯æ˜¾å­˜åˆ†é…å³°å€¼: 628.63671875MBout_checkpointed = out.data.clone()grad_checkpointed = {}for name, param in model.named_parameters():    grad_checkpointed[name] = param.grad.data.clone()# (2). ä¸ä½¿ç”¨checkpointæŠ€æœ¯original = modelx = input_var.clone().detach_()out = original(x)out_not_checkpointed = out.data.clone()original.zero_grad()out.sum().backward()print(f"ä¸ä½¿ç”¨checkpointæŠ€æœ¯æ˜¾å­˜åˆ†é…å³°å€¼: {torch.cuda.max_memory_allocated()/1024/1024}MB")# ä¸ä½¿ç”¨checkpointæŠ€æœ¯æ˜¾å­˜åˆ†é…å³°å€¼: 936.17431640625MBgrad_not_checkpointed = {}for name, param in model.named_parameters():    grad_not_checkpointed[name] = param.grad.data.clone()# å¯¹æ¯”ä½¿ç”¨å’Œä¸ä½¿ç”¨checkpointæŠ€æœ¯è®¡ç®—å‡ºæ¥çš„æ¢¯åº¦éƒ½æ˜¯ä¸€æ ·çš„assert torch.allclose(out_checkpointed, out_not_checkpointed)for name in grad_checkpointed:    assert torch.allclose(grad_checkpointed[name], grad_not_checkpointed[name])</code></pre><h3 id="å°†gpuæ˜¾å­˜ä¸‹æ”¾è‡³cpuå†…å­˜">å°†GPUæ˜¾å­˜ä¸‹æ”¾è‡³CPUå†…å­˜</h3><ul><li>æ¨¡å‹å‚æ•°ä¸‹æ”¾ï¼šå½“æ¨¡å‹å¤ªå¤§è€Œæ— æ³•å®Œå…¨è£…å…¥æ˜¾å­˜æ—¶ï¼Œå¯ä»¥å°†éƒ¨åˆ†æ¨¡å‹å‚æ•°ã€ä¼˜åŒ–å™¨å‚æ•°æš‚æ—¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œåªåœ¨æœ‰éœ€è¦çš„æ—¶å€™ä¸´æ—¶åŠ è½½åˆ°æ˜¾å­˜é‡Œï¼Œè®¡ç®—å®Œæˆåé©¬ä¸Šä»æ˜¾å­˜ä¸­ç§»é™¤ã€‚</li><li>æ¿€æ´»å¼ é‡ä¸‹æ”¾ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ‰€æœ‰æ¿€æ´»å¼ é‡é»˜è®¤å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œåªåœ¨éœ€è¦å‚ä¸è®¡ç®—æ—¶æ‰åŠ è½½åˆ°æ˜¾å­˜é‡Œï¼Œè®¡ç®—å®Œæˆåå°†æ‰€æœ‰æ¿€æ´»å¼ é‡å†æ¬¡å­˜æ”¾å›å†…å­˜ã€‚</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnclass LargeModel(nn.Module):    def __init__(self):        super(LargeModel, self).__init__()        self.layer1 = nn.Linear(50000, 50000)        self.layer2 = nn.Linear(50000, 50000)    # OOM on a GPU with 24GB    # def forward(self, x):    #     x = self.layer1(x)    #     x = torch.relu(x)    #     x = self.layer2(x)    #     x = torch.relu(x)    #     return x    def forward(self, x):        self.layer1.to("cuda")        x = self.layer1(x)        x = torch.relu(x)        self.layer1.to("cpu")        self.layer2.to("cuda")        x = self.layer2(x)        x = torch.relu(x)        self.layer2.to("cpu")        return xmodel = LargeModel().to("cuda")input_data = torch.randn(10, 50000).to("cuda")output = model(input_data)print(f"å‰å‘è¿‡ç¨‹ä¸­GPUæ˜¾å­˜å ç”¨å³°å€¼: {torch.cuda.max_memory_allocated()/1024/1024/1024}GB")# å‰å‘è¿‡ç¨‹ä¸­GPUæ˜¾å­˜å ç”¨å³°å€¼: 9.328798770904541GBloss = output.sum()loss.backward()</code></pre><p>åŠ¨æ€ä¸‹æ”¾-åŠ è½½çš„ä¸»è¦æ€§èƒ½ç“¶é¢ˆæ˜¯CPUå’ŒGPUä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚å¦‚æœæ•°æ®ä¼ è¾“ä¸å¤Ÿé«˜æ•ˆï¼Œåˆ™ä¸€å®šä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¾ˆå¤§å½±å“ã€‚å› æ­¤éœ€è¦åœ¨æ•°æ®ä¼ è¾“å»¶è¿Ÿå’Œæ˜¾å­˜èŠ‚çº¦ä¹‹é—´åšå¥½å¹³è¡¡ã€‚PyTorchå’Œç›¸å…³çš„ç”Ÿæ€ç³»ç»Ÿï¼ˆå¦‚NVIDIAçš„Apexåº“ï¼‰æä¾›äº†ä¸€äº›å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·å®ç°ä¸Šè¿°åŠ¨æ€ä¸‹æ”¾-åŠ è½½èµ„æºçš„ç­–ç•¥ï¼Œä»¥ä¾¿åœ¨æœ‰é™çš„èµ„æºä¸‹è®­ç»ƒå¤§å‹æ¨¡å‹ã€‚</p><h3 id="é™ä½ä¼˜åŒ–å™¨çš„æ˜¾å­˜å ç”¨">é™ä½ä¼˜åŒ–å™¨çš„æ˜¾å­˜å ç”¨</h3><p>ä¼˜åŒ–å™¨å¾€å¾€ä¹Ÿæ˜¯æ˜¾å­˜å ç”¨çš„å¤§å¤´ï¼Œè¿™é‡Œä¸»è¦æ¥æºæœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ä¼˜åŒ–å™¨å†…ç½®çš„çŠ¶æ€å˜é‡ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ä¼˜åŒ–å™¨è¿›è¡Œå‚æ•°æ›´æ–°æ—¶çš„è¿è¡Œå†…å­˜å ç”¨ã€‚</p><p>å¯ä»¥é€šè¿‡optimizer.state_dict()æ¥å£æŸ¥çœ‹ä¼˜åŒ–å™¨ä¸ºæ¯ä¸ªå‚æ•°ä¿å­˜çš„çŠ¶æ€å˜é‡ã€‚å¯¹äºæ˜¾å­˜éå¸¸ç´§å¼ çš„æƒ…å†µï¼Œé€‰æ‹©å ç”¨é¢å¤–æ˜¾å­˜è¾ƒå°‘çš„ä¼˜åŒ–å™¨ï¼Œå¦‚SGDç­‰ï¼Œå¯ä»¥å¸®åŠ©å¿«é€Ÿçªç ´æ˜¾å­˜ç“¶é¢ˆï¼Œä½†ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ã€‚</p><p>å¦å¤–ï¼Œä¹‹å‰ä»‹ç»è¿‡<a href="https://baoblei.github.io/2025/03/12/da-mo-xing-dong-li-yin-qing-dan-qia-xing-neng-you-hua-zhuan-ti/#%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E7%89%B9%E5%8C%96%E7%9A%84%E4%BC%98%E5%8C%96%E5%99%A8">PyTorchä¼˜åŒ–å™¨çš„ä¸åŒè®¡ç®—æ¨¡å¼</a>ï¼Œä¹Ÿå°±æ˜¯for-loopã€for-eachã€fusedä¸‰ç§ä¸åŒçš„å®ç°æ–¹æ³•ã€‚è¿™ä¸‰ç§æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯åœ¨æ€§èƒ½å’Œæ˜¾å­˜ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ï¼Œå…¶ä¸­for-loopæ˜¾å­˜ç”¨é‡æœ€å°‘ï¼Œå½“ç„¶ä»£ä»·æ˜¯å…¶æ€§èƒ½ä¹Ÿæ˜¯ä¸‰ç§æ¨¡å‹é‡Œæœ€å·®çš„ã€‚</p><h2 id="ä¼˜åŒ–pythonä»£ç å‡å°‘æ˜¾å­˜å ç”¨">ä¼˜åŒ–Pythonä»£ç å‡å°‘æ˜¾å­˜å ç”¨</h2><h3 id="pythonåƒåœ¾å›æ”¶æœºåˆ¶">Pythonåƒåœ¾å›æ”¶æœºåˆ¶</h3><p>Pythonå­˜åœ¨ä¸¤å±‚åƒåœ¾å›æ”¶æœºåˆ¶ã€‚</p><p>ç¬¬ä¸€å±‚æœºåˆ¶é€šè¿‡<strong>å¼•ç”¨è®¡æ•°</strong>æ¥åˆ¤å®šå˜é‡æ˜¯å¦ä¸ºåƒåœ¾ã€‚ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªå˜é‡æ¯è¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œå…¶è®¡æ•°å¢ä¸€ï¼›æ¯æ¬¡ä½¿ç”¨å®Œæ¯•ï¼Œè®¡æ•°å‡ä¸€ã€‚å½“è®¡æ•°ä¸º0æ—¶ï¼Œè¯¥å˜é‡å°±ä¼šè¢«å›æ”¶ã€‚ç„¶è€Œï¼Œä¸€æ—¦å‡ºç°ç›¸äº’ä¹‹é—´å¾ªç¯å¼•ç”¨çš„å˜é‡æ—¶ï¼Œå®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¼šä¸‹é™åˆ°é›¶ï¼Œä¸ºæ­¤ï¼ŒPythonåˆå¼•å…¥äº†ç¬¬äºŒå±‚å¾ªç¯åƒåœ¾å›æ”¶æœºåˆ¶ã€‚</p><p><strong>å¾ªç¯åƒåœ¾å›æ”¶æœºåˆ¶</strong>å®ç°äº†æ£€æµ‹å¾ªç¯ä¾èµ–çš„ç®—æ³•ï¼Œèƒ½å¤Ÿæ‰“ç ´å¾ªç¯ä¾èµ–å¯¹å¼•ç”¨è®¡æ•°é€ æˆçš„ç ´åã€‚è¯¥æœºåˆ¶çš„è§¦å‘æ—¶æœºæ˜¯ä¸å›ºå®šçš„ï¼Œå®ƒä¾èµ–äºè‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶ä»¥æ¥åˆ†é…çš„æ–°å˜é‡æ•°é‡ã€‚å®é™…ä¸Šï¼Œè¯¥æœºåˆ¶è¿˜åŒ…æ‹¬å˜é‡å¹´é¾„ç»„å’Œä¸åŒçš„é˜ˆå€¼è®¾ç½®ï¼Œä½†è¿™äº›ç»†èŠ‚å·²ç»è¶…å‡ºäº†æœ¬ç« è®¨è®ºèŒƒå›´ã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“<strong>å¾ªç¯åƒåœ¾å›æ”¶æœºåˆ¶çš„è§¦å‘é¢‘ç‡ä¸é«˜ï¼Œä¸èƒ½ä¿è¯èµ„æºè¢«å³æ—¶é‡Šæ”¾æ‰</strong>ã€‚### é¿å…å‡ºç°å¾ªç¯ä¾èµ–å¾ªç¯ä¾èµ–å¸¸è§äºPyTorchç¼–ç¨‹ä¸­è‡ªå®šä¹‰Pythonç±»å‹çš„ç›¸äº’åµŒå¥—ï¼Œç‰¹åˆ«æ˜¯åœ¨å­èŠ‚ç‚¹æŒæœ‰å¯¹çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨æƒ…å†µã€‚ä»¥ä¸‹ä»£ç å±•ç¤ºäº†è¿™ç§æƒ…å†µï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport gcclass Module1(torch.nn.Module):    def __init__(self):        super(Module1, self).__init__()        self.saved = Module2(self)  # Module1å¯¹è±¡ä¿å­˜äº†å¯¹Module2å¯¹è±¡çš„å¼•ç”¨        self.tensor = torch.randn(1024, 1024, device="cuda")class Module2(torch.nn.Module):    def __init__(self, module):        super(Module2, self).__init__()        self.saved = module  # Module2å¯¹è±¡ä¹Ÿä¿å­˜äº†å¯¹Module1å¯¹è±¡çš„é¥®ç”¨        self.tensor = torch.randn(1024, 1024, device="cuda")net = Module1()print("Memory allocated: ", torch.cuda.memory_allocated(0))del net        # å³ä¾¿ä½¿ç”¨delå‘½ä»¤æ‰‹åŠ¨åˆ é™¤å˜é‡ï¼Œä¹Ÿä¸èƒ½ç«‹å³é‡Šæ”¾å…¶èµ„æºã€‚print("Memory allocated after delete: ", torch.cuda.memory_allocated(0))gc.collect()     # æ‰‹åŠ¨è§¦å‘å¾ªç¯åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œè¿™æ—¶æ‰èƒ½é‡Šæ”¾è¢«å·å…¥å¾ªç¯ä¾èµ–çš„å˜é‡ä»¬print("Memory allocated after gc: ", torch.cuda.memory_allocated(0))</code></pre><p></p><p>å†æ¥çœ‹çœ‹ä»¥ä¸‹è¿™ä¸ªä¾‹å­ï¼Œå¼€å‘è€…å¯èƒ½ä¼šä½¿ç”¨self.model =modelç­‰å†™æ³•ï¼Œè®©è‡ªå®šä¹‰ç±»å‹æŒæœ‰modelå˜é‡ï¼Œä»è€Œæ–¹ä¾¿éšæ—¶è®¿é—®ã€‚ç„¶è€Œï¼Œä¸€æ—¦ä½¿ç”¨ä¸å½“å°±ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchclass CustomLayer(torch.nn.Module):    def __init__(self, model):        super(CustomLayer, self).__init__()        self.model = model         # è‡ªå®šä¹‰ç±»å‹æŒæœ‰modelå˜é‡class MyModel(torch.nn.Module):    def __init__(self):        super(MyModel, self).__init__()        self.custom_layer = CustomLayer(self) # CustomLayerå¯¹è±¡æŒæœ‰MyModelå¯¹è±¡çš„å¼•ç”¨ï¼Œ è€ŒMyModelå¯¹è±¡åˆæŒæœ‰CustomLayerå¯¹è±¡çš„å¼•ç”¨ï¼Œ ä»è€Œå½¢æˆå¾ªç¯ä¾èµ–ã€‚model = MyModel()</code></pre><p></p><h3 id="è°¨æ…ä½¿ç”¨å…¨å±€ä½œç”¨åŸŸ">è°¨æ…ä½¿ç”¨å…¨å±€ä½œç”¨åŸŸ</h3><p>é™¤äº†å¾ªç¯ä¾èµ–ä»¥å¤–ï¼Œå…¨å±€ä½œç”¨åŸŸä¸­çš„å¼ é‡ä¹Ÿæ˜¯å¯¼è‡´æ˜¾å­˜èµ„æºä¸èƒ½è¢«é‡Šæ”¾çš„é‡è¦åŸå› ã€‚ä¸å±€éƒ¨å˜é‡ä¸åŒï¼Œå…¨å±€å˜é‡çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸å»¶ç»­è‡³ç¨‹åºç»“æŸï¼Œä»è€Œå¯¼è‡´æŒç»­çš„èµ„æºå ç”¨ï¼Œè¿™æ˜¯ä»»ä½•åƒåœ¾å›æ”¶æœºåˆ¶éƒ½ä¸èƒ½è§£å†³çš„ã€‚</p><p>å…¨å±€å˜é‡åŒ…æ‹¬å®šä¹‰åœ¨è„šæœ¬æœ€å¤–å±‚çš„å˜é‡ã€ä½¿ç”¨globalå…³é”®å­—å£°æ˜çš„å˜é‡ç­‰ã€‚</p><p>ä¸ºå‡å°‘å…¨å±€å˜é‡é€ æˆçš„èµ„æºå ç”¨ï¼Œåªèƒ½é€šè¿‡<code>del</code>æ‰‹åŠ¨æ¸…ç†è¿™äº›å˜é‡ï¼Œæ¸…ç†åæ˜¾å­˜å ç”¨æ‰èƒ½é™è‡³é›¶ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250313023036.png"></p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> å•å¡æ˜¾å­˜ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-å•å¡æ€§èƒ½ä¼˜åŒ–ä¸“é¢˜</title>
      <link href="/2025/03/12/da-mo-xing-dong-li-yin-qing-dan-qia-xing-neng-you-hua-zhuan-ti/"/>
      <url>/2025/03/12/da-mo-xing-dong-li-yin-qing-dan-qia-xing-neng-you-hua-zhuan-ti/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å•å¡GPUè®­ç»ƒç¯å¢ƒä¸­ï¼Œæ€§èƒ½é—®é¢˜ä¸»è¦åˆ†ä¸ºå››ç±»ï¼š -GPUè¢«é˜»å¡ï¼šè¿™æ˜¯ç”±äºæ•°æ®é¢„å¤„ç†æˆ–ä¼ è¾“ä»»åŠ¡ç­‰å‰ç½®ä¾èµ–æœªå®Œæˆï¼Œå¯¼è‡´GPUè®¡ç®—èµ„æºç©ºé—²ç­‰å¾…çš„æƒ…å†µã€‚-GPUè¿è¡Œæ•ˆç‡ä¸é«˜ï¼šè¿™é€šå¸¸æ˜¯å› ä¸ºGPUä¸Šçš„è®¡ç®—ä»»åŠ¡è®¾è®¡å¾—ä¸å¤Ÿå¥½ï¼Œæœªèƒ½å……åˆ†å‘æŒ¥ç¡¬ä»¶çš„è®¡ç®—èƒ½åŠ›ã€‚-ä¸å¿…è¦çš„GPUä¸CPUé—´åŒæ­¥ï¼šGPUä¸CPUä¹‹é—´çš„åŒæ­¥æ˜¯ä¸€ä¸ªæå…¶è´¹æ—¶çš„æ“ä½œï¼Œç”¨æˆ·æœ‰æ—¶ä¼šåœ¨æ— æ„ä¸­é¢‘ç¹ä½¿ç”¨åŒæ­¥æ“ä½œï¼Œè¿›è€Œä¸¥é‡é™ä½æ€§èƒ½ã€‚-æ•°æ®ä¼ è¾“å¸¦å®½ä¸è¶³ï¼šåœ¨GPUä¸CPUä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œå¦‚æœå¸¦å®½ä¸è¶³ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¼ è¾“é€Ÿåº¦å˜æ…¢ï¼Œè¿›è€Œå½±å“è®­ç»ƒæ€§èƒ½ã€‚</p><h2 id="æé«˜æ•°æ®ä»»åŠ¡çš„å¹¶è¡Œåº¦">æé«˜æ•°æ®ä»»åŠ¡çš„å¹¶è¡Œåº¦</h2><ul><li>CPUçš„é¢„å¤„ç†è¦è¶³å¤Ÿå¿«ï¼Œèƒ½å¤ŸåŠæ—¶ç»™GPUæäº¤è®¡ç®—ä»»åŠ¡ï¼Œç¡®ä¿GPUä¸Šæœ‰å¤§é‡è®¡ç®—ä»»åŠ¡åœ¨æ’é˜Ÿï¼Œå§‹ç»ˆæœ‰æ´»å¯ä»¥å¹²ã€‚</li><li>GPUä»»åŠ¡éœ€è¦çš„æ•°æ®æ€»èƒ½å¤Ÿåœ¨å®ƒå¼€å§‹æ‰§è¡Œå‰å°±ä¼ è¾“åˆ°æ˜¾å­˜ã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘GPUçš„ç©ºé—²æ—¶é—´ï¼Œè®©å…¶å§‹ç»ˆä¿æŒåœ¨è®¡ç®—çŠ¶æ€ã€‚</li></ul><h3 id="å¢åŠ æ•°æ®é¢„å¤„ç†çš„å¹¶è¡Œåº¦">å¢åŠ æ•°æ®é¢„å¤„ç†çš„å¹¶è¡Œåº¦</h3><p>é€šè¿‡å¢åŠ DataLoaderçš„num_workerså‚æ•°ï¼Œå¯ä»¥å¢åŠ æ•°æ®é¢„å¤„ç†çš„å¹¶è¡Œåº¦ã€‚</p><p>æ¡ˆä¾‹ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchfrom torch import nnfrom torch.profiler import profile, ProfilerActivityimport torchvision.transforms as transformsfrom torchvision.datasets import CIFAR10from torch.utils.data import DataLoaderclass SimpleNet(nn.Module):    def __init__(self):        super(SimpleNet, self).__init__()        self.fc1 = nn.Linear(512, 10000)        self.fc2 = nn.Linear(10000, 1000)        self.fc3 = nn.Linear(1000, 10)    def forward(self, x):        out = self.fc1(x)        out = self.fc2(out)        out = self.fc3(out)        return outassert torch.cuda.is_available()device = torch.device("cuda")model = SimpleNet().to(device)optimizer = torch.optim.SGD(model.parameters(), lr=0.01)def train(model, optimizer, trainloader, num_iters):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for i, batch in enumerate(trainloader, 0):            if i &gt;= num_iters:                break            #------åŒæ­¥æ¨¡å¼-------------------------#            data = batch[0].cuda()            #------éé˜»å¡æ¨¡å¼------------------------#            # data = batch[0].to("cuda", non_blocking=True)            # å‰å‘            optimizer.zero_grad()            output = model(data)            loss = output.sum()            # åå‘            loss.backward()            optimizer.step()    prof.export_chrome_trace(f"traces/PROF_workers_{trainloader.num_workers}.json")#-----------æé«˜æ•°æ®é¢„å¤„ç†å¹¶è¡Œåº¦---------------#num_workers = 0#-------------------------------------------#transform = transforms.Compose(    [transforms.ToTensor(), transforms.Resize([512, 512])])trainset = CIFAR10(root="./data", train=True, download=True, transform=transform)#----------é»˜è®¤åœ¨é¡µå†…å­˜ä¸­åŠ è½½æ•°æ®---------------#trainloader = DataLoader(trainset, batch_size=32, num_workers=num_workers)#------------åœ¨é”é¡µå†…å­˜ä¸­åŠ è½½æ•°æ®---------------##trainloader = DataLoader(trainset, batch_size=32, num_workers=num_workers, pin_memory=True)train(model, optimizer, trainloader, num_iters=20)</code></pre><p></p><p>å¦‚æœnum_workers=0ï¼Œæ€§èƒ½å›¾è°±å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312184417.png"></p><p>å¯ä»¥çœ‹å‡ºGPUåœ¨MemcpyHtoDçš„æ•°æ®æ‹·è´ä»»åŠ¡ä¹‹å‰åœ¨ç­‰å¾…CPUçš„æ•°æ®åŠ è½½ï¼Œå¯¼è‡´GPUç©ºé—²ã€‚</p><p>å¦‚æœnum_workers=4ï¼Œæ€§èƒ½å›¾è°±å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312184640.png">æ˜æ˜¾è§‚å¯Ÿåˆ°æ•°æ®åŠ è½½çš„è€—æ—¶å¤§å¹…ä¸‹é™ï¼Œä¸æ­¤åŒæ—¶GPUç­‰å¾…æ•°æ®åŠ è½½çš„æ—¶é—´ä¹Ÿç¼©çŸ­åˆ°äº†åªæœ‰40Î¼sï¼Œè¿œä½äºä¹‹å‰çš„10msï¼Œè¿™æ­£æ˜¯å¤šè¿›ç¨‹å¹¶è¡Œä»¥åŠæ•°æ®é¢„åŠ è½½å…±åŒä½œç”¨çš„ç»“æœã€‚</p><h3 id="ä½¿ç”¨å¼‚æ­¥æ¥å£æäº¤æ•°æ®ä¼ è¾“ä»»åŠ¡">ä½¿ç”¨å¼‚æ­¥æ¥å£æäº¤æ•°æ®ä¼ è¾“ä»»åŠ¡</h3><p>GPUåœ¨MemcpyHtoDçš„æ•°æ®æ‹·è´ä»»åŠ¡ä¹‹ååˆ°æ‰§è¡Œå…·ä½“çš„ç®—å­è®¡ç®—ä¹‹å‰ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªç©ºé—²æ—¶é—´ã€‚</p><p>CPUæ•°æ®ä¼ è¾“ä»»åŠ¡aten::toä¸­ï¼ŒåŒ…å«äº†ä¸€ä¸ªåŒæ­¥æ“ä½œï¼Œå³cudaStreamSynchronizeï¼Œè¿™æ„å‘³æ•°æ®ä»ä¸»å­˜åˆ°æ˜¾å­˜çš„æ‹·è´æ˜¯ä¼šé˜»å¡CPUçš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312185304.png"></p><p><strong>è¿™æ—¶å› ä¸ºä»£ç ä¸­ä½¿ç”¨äº†tensor.to(device)çš„æ–¹æ³•å°†å¼ é‡ä»CPUå¤åˆ¶åˆ°GPUï¼Œé»˜è®¤é‡‡å–çš„æ˜¯åŒæ­¥æ¨¡å¼ã€‚</strong></p><p>ä¸ºäº†å®ç°å¯ç”¨éé˜»å¡æ¨¡å¼çš„æ•°æ®ä¼ è¾“ï¼ˆå…è®¸åœ¨å‘GPUä¼ è¾“æ•°æ®çš„åŒæ—¶ï¼ŒCPUèƒ½å¤Ÿç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ï¼‰ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š- éœ€è¦ä¼ è¾“çš„æ•°æ®å¿…é¡»å­˜å‚¨åœ¨<strong>é”é¡µå†…å­˜(pinnedmemory)</strong>ä¸­ã€‚é”é¡µå†…å­˜çš„ç‰©ç†åœ°å€æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šè¢«æ“ä½œç³»ç»Ÿæ¢å‡ºåˆ°ç£ç›˜ï¼Œä»è€Œå…è®¸GPUç›´æ¥è®¿é—®è¿™éƒ¨åˆ†å†…å­˜ã€‚åœ¨PyTorchä¸­åˆ›å»ºçš„å¼ é‡é»˜è®¤æ˜¯å¸¸è§„çš„é¡µå†…å­˜(pageablememory)ï¼Œä½†å¯ä»¥é€šè¿‡<strong>DataLoaderçš„è®¾ç½®ç›´æ¥å°†æ•°æ®åŠ è½½åˆ°é”é¡µå†…å­˜</strong>ï¼Œæˆ–ä½¿ç”¨<strong>tensor.pin_memory()æ–¹æ³•æ‰‹åŠ¨å°†å¼ é‡ç§»åŠ¨åˆ°é”é¡µå†…å­˜</strong>ã€‚-åœ¨è°ƒç”¨æ•°æ®ä¼ è¾“æ—¶éœ€è¦è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¦‚<strong>tensor.to("cuda",non_blocking=True)</strong>ã€‚è¿™æ ·æ•°æ®ä¼ è¾“çš„ä»»åŠ¡ä¼šè¢«æäº¤åˆ°GPUçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒCPUåˆ™ä¸éœ€è¦ç­‰å¾…æ•°æ®ä¼ è¾“å®Œæˆå³å¯ç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312190638.png"></p><h3 id="æ•°æ®ä¼ è¾“ä¸gpuè®¡ç®—ä»»åŠ¡å¹¶è¡Œ">æ•°æ®ä¼ è¾“ä¸GPUè®¡ç®—ä»»åŠ¡å¹¶è¡Œ</h3><p>ç°åœ¨GPUåœ¨è¿›è¡Œæ•°æ®æ‹·è´ä¸è®¡ç®—æ—¶å¯ä»¥æ— ç¼è¡”æ¥äº†ï¼Œä½†æ˜¯æœ‰æ²¡æœ‰å¯èƒ½è®©è¿™ä¸ªä¸¤ä¸ªä»»åŠ¡å¹¶è¡Œèµ·æ¥å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥é‡‡å–ç±»ä¼¼CPUé¢„åŠ è½½æ•°æ®çš„ç­–ç•¥ï¼š<strong>åœ¨å½“å‰è®­ç»ƒè½®æ¬¡è¿›è¡Œçš„åŒæ—¶ï¼Œé¢„å…ˆæŠŠä¸‹ä¸€è½®è®­ç»ƒæ‰€éœ€çš„æ•°æ®ä»CPUå¤åˆ¶åˆ°GPUä¸Šã€‚</strong>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é…ç½®ä¸åŒçš„GPUè®¡ç®—æµ(CUDAStream)æ¥åˆ›å»ºä¸€ä¸ªå¹¶è¡Œçš„æ•°æ®æ‹·è´ä»»åŠ¡ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">def train(model, optimizer, trainloader, num_iters):    # Create two CUDA streams    stream1 = torch.cuda.Stream()    stream2 = torch.cuda.Stream()    submit_stream = stream1    running_stream = stream2    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for i, batch in enumerate(trainloader, 0):            if i &gt;= num_iters:                break            with torch.cuda.stream(submit_stream):                data = batch[0].cuda(non_blocking=True)                submit_stream.wait_stream(running_stream)                # Forward pass                optimizer.zero_grad()                output = model(data)                loss = output.sum()                # Backward pass and optimize                loss.backward()                optimizer.step()            # Alternate between the two streams            submit_stream = stream2 if submit_stream == stream1 else stream1            running_stream = stream2 if running_stream == stream1 else stream1    prof.export_chrome_trace(f"PROF_double_buffering_wait_after_data.json")</code></pre><p>å¼•å…¥äº†submit_stream.wait_stream(running_stream)æ¥è¿›è¡ŒGPUé˜Ÿåˆ—é—´çš„åŒæ­¥å’Œç­‰å¾…ï¼Œä¿è¯ä¸¤ä¸ªGPUé˜Ÿåˆ—çš„é‡å éƒ¨åˆ†ä»…é™äºæ•°æ®ä¼ è¾“ï¼Œè€Œè®¡ç®—éƒ¨åˆ†ä¸å‘ç”Ÿé‡å ã€‚</p><p>è¿™ä¸€æŠ€å·§ä¸æ¨ç†ä¸­å¸¸ç”¨çš„åŒé‡ç¼“å†²(double buffering)ä¼˜åŒ–æœ‰äº›ç›¸ä¼¼ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312192217.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒé‡ç¼“å†²ä¸»è¦æ˜¯åŠ å¿«æ•°æ®çš„æ‹·è´é€Ÿåº¦ï¼Œå› æ­¤åœ¨æ•°æ®é‡è¾ƒå°ã€æ•°æ®ä¼ è¾“ç”¨æ—¶è¾ƒçŸ­çš„åœºæ™¯ä¸­ï¼Œæ•ˆæœå¯èƒ½ä¸å¤ªæ˜æ˜¾ã€‚æ­¤å¤–ï¼Œå®ƒä¹Ÿå¯èƒ½å¸¦æ¥GPUé˜Ÿåˆ—é—´åŒæ­¥çš„é¢å¤–å¼€é”€ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ç•¥æœ‰ä¸‹é™ã€‚</p><h2 id="æé«˜gpuè®¡ç®—ä»»åŠ¡çš„æ•ˆç‡">æé«˜GPUè®¡ç®—ä»»åŠ¡çš„æ•ˆç‡</h2><p>æˆ‘ä»¬å¯ä»¥ç”¨æ¨¡å‹æµ®ç‚¹è¿ç®—åˆ©ç”¨ç‡(model FLOPSutilization,MFU)æ¥è¡¡é‡GPUçš„ä½¿ç”¨æ•ˆç‡ï¼š</p><p><span class="math display">\[MFU = \frac{å®é™…ä½¿ç”¨FLOPS}{GPUç†è®ºæœ€é«˜FLOPS}\]</span></p><p>å…³äºGPUè®¡ç®—ä¼˜åŒ–ï¼Œä¸»è¦åŒ…æ‹¬ï¼š -(1)GPUç®—å­æ‰§è¡Œæ—¶é—´å¤ªçŸ­ï¼Œæˆ–ç®—å­ä¸­çš„è®¡ç®—è¿‡äºç®€å•ï¼Œå¯¼è‡´ä¸ºè¯¥ç®—å­è°ƒåº¦çš„é¢å¤–å¼€é”€ç”šè‡³è¶…è¿‡äº†è®¡ç®—æœ¬èº«ï¼Œä½¿å¾—æ€§ä»·æ¯”è¾ƒä½ã€‚- (2)GPUç®—å­çš„å¹¶è¡Œåº¦ä¸è¶³ï¼Œæœªèƒ½å……åˆ†åˆ©ç”¨GPUä¸­å¤§é‡çš„çº¿ç¨‹å—èµ„æºå¯¼è‡´æµªè´¹ã€‚ -(3)GPUç®—å­ä½¿ç”¨äº†ä¸åˆé€‚çš„å†…å­˜å¸ƒå±€ï¼Œå¢åŠ äº†é¢å¤–çš„è®¿å­˜å¼€é”€ã€‚ -(4)GPUç®—å­çš„å…·ä½“å®ç°è¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ã€‚</p><p>æœ¬èŠ‚åªè®¨è®ºé’ˆå¯¹(1)å’Œ(2)è¿›è¡Œä¼˜åŒ–ã€‚</p><h3 id="æœ€å¤§batch-size">æœ€å¤§Batch Size</h3><p>ä¸€ä¸ªç®—å­çš„CUDAæ ¸å‡½æ•°å®ç°é€šå¸¸åªé’ˆå¯¹è¾“å…¥å¼ é‡çš„[C,H,W]ç»´åº¦ï¼Œè€Œä¸ä¼šç›´æ¥æ¶‰åŠBatchç»´åº¦çš„è®¡ç®—ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´<strong>BatchSizeä¸ç®—å­CUDAä»£ç çš„å®ç°æ˜¯ç‹¬ç«‹çš„</strong>ï¼Œæå‡BatchSizeå¹¶ä¸èƒ½ç›´æ¥æå‡CUDAæ ¸å‡½æ•°çš„æ€§èƒ½ã€‚ç„¶è€Œå®ƒå¯ä»¥<strong>å¢åŠ GPUä½¿ç”¨çš„çº¿ç¨‹å—(block)æ•°é‡</strong>ï¼Œä¸€æ¬¡æ€§å®Œæˆå¤šä¸ªæ ·æœ¬çš„è®¡ç®—ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒBatchSizeæ˜¯é€šè¿‡å¢åŠ è®¡ç®—å¹¶è¡Œåº¦çš„æ–¹å¼æ¥æé«˜ç®—å­è®¡ç®—æ•ˆç‡çš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312195951.png">ä»å›¾ä¸­çœ‹å‡ºBatchSizeé€šè¿‡å¢åŠ GPUçš„è®¡ç®—å¹¶è¡Œåº¦æ¥æé«˜æ€§èƒ½ï¼Œä½†è¿™ç§å¹¶è¡Œåº¦å—åˆ°GPUçº¿ç¨‹å—æ€»æ•°çš„é™åˆ¶ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312200042.png"></p><p>ä½†æ˜¯è¾ƒå¤§çš„BatchSizeå¯èƒ½ä¼šå½±å“æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå°½ç®¡è¿™ä¹Ÿå—åˆ°è®­ç»ƒé›†å¤§å°ã€ç»„æˆã€ç½‘ç»œç»“æ„å’Œè®­ç»ƒæ–¹æ³•ç­‰å› ç´ çš„å½±å“ã€‚</p><p>å®é™…ä¸Šï¼Œè®¸å¤šå¤§å‹æ¨¡å‹ä½¿ç”¨è¾ƒå¤§çš„BatchSizeï¼Œè¿™ä¹Ÿè¡¨æ˜åœ¨å¤§æ•°æ®é›†ä¸Šï¼Œè¾ƒå¤§çš„BatchSizeçš„è´Ÿé¢å½±å“å¯èƒ½ä¼šæœ‰æ‰€å‡è½»ã€‚é€‰æ‹©BatchSizeæ—¶ï¼Œéœ€è¦åœ¨æ¨¡å‹è´¨é‡å’Œè®­ç»ƒé€Ÿåº¦ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚</p><h3 id="ä½¿ç”¨èåˆç®—å­">ä½¿ç”¨èåˆç®—å­</h3><p>PyTorchçš„çµæ´»æ€§ä¹Ÿæ„å‘³ç€PyTorchä¸­çš„GPUç®—å­æ¯”è¾ƒè½»é‡ï¼Œæ¯ä¸ªç®—å­è°ƒç”¨éƒ½éœ€è¦ç»è¿‡ä¸€ç³»åˆ—å±‚çº§çš„è°ƒç”¨æµç¨‹ï¼šä»Pythonåˆ°C++ï¼Œå†åˆ°CUDAæ‰§è¡Œï¼Œç„¶åå°†ç»“æœè¿”å›C++ï¼Œæœ€åå›åˆ°Pythonã€‚</p><p>å› æ­¤ï¼Œæœ¬èŠ‚å°†ä¸“æ³¨äºå¦‚ä½•é€šè¿‡æ”¹å˜ä»£ç å†™æ³•ï¼Œåˆå¹¶ç›¸é‚»çš„ç®—å­è°ƒç”¨æ¥å‡å°‘è¿™äº›è°ƒåº¦å¼€é”€ã€‚</p><p>ä¸€ç§æœ‰æ•ˆçš„ç­–ç•¥æ˜¯<strong>æ‰‹åŠ¨åˆå¹¶ç®—å­</strong>ï¼Œè¿™é€šå¸¸éœ€è¦ä¸€å®šçš„æ•°å­¦æŠ€å·§æ¥å°†å¤šä¸ªç›¸é‚»çš„ç®—å­èåˆæˆä¸€ä¸ªå•ä¸€çš„ç®—å­ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯åˆå¹¶å¤šä¸ªè¿ç»­çš„é€å…ƒç´ æ“ä½œ(elementwise operations)ï¼Œä¾‹å¦‚ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchx = torch.rand(3, 3)y = torch.rand(3, 3)z = x * yz1 = z + x# å¯ä»¥å°†ä¸Šé¢çš„è®¡ç®—åˆå¹¶ä¸ºä¸€ä¸ªç®—å­ï¼Œç»“æœæ˜¯ç­‰ä»·çš„z2 = torch.addcmul(x, x, y) </code></pre> ä¸€äº›å¸¸è§çš„èåˆè¿˜åŒ…æ‹¬<strong>ç‚¹ç§¯ä¸åŠ æ³•åˆå¹¶</strong>ï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python">import torcha = torch.rand(4, 4)b = torch.rand(4, 4)c = torch.rand(4, 4)x = torch.matmul(a, b)x1 = x + c# å¯ä»¥å°†ä¸Šé¢çš„è®¡ç®—åˆå¹¶ä¸ºä¸€ä¸ªç®—å­ï¼Œç»“æœæ˜¯ç­‰ä»·çš„x2 = torch.addmm(c, a, b)</code></pre><p></p><p>é™¤äº†ä¾é æ•°å­¦çŸ¥è¯†æ‰‹åŠ¨èåˆå¤šä¸ªç®—å­ä¹‹å¤–ï¼ŒPyTorchè¿˜åœ¨<strong>torch.nn.utils.fusion</strong>æ¨¡å—ä¸‹æä¾›äº†ä¸€ç³»åˆ—å¸¸ç”¨çš„ç®—å­èåˆçš„æ¥å£ã€‚</p><p>ä¾‹å¦‚ï¼Œfuse_linear_bn_evalæ¥å£èƒ½å¤Ÿå°†ç›¸é‚»çš„Linearç®—å­å’ŒBatchNormç®—å­åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„Linearç®—å­ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnfrom torch.profiler import profile, ProfilerActivityclass SimpleModel(nn.Module):    def __init__(self):        super(SimpleModel, self).__init__()        self.linear = nn.Linear(100, 50)        self.bn = nn.BatchNorm1d(50)    def forward(self, x):        return self.bn(self.linear(x))@torch.no_grad()def run(data, model, num_iters, name):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for _ in range(num_iters):            original_output = model(input_tensor)    prof.export_chrome_trace(f"traces/PROF_cuda_{name}.json")model = SimpleModel().to(torch.device("cuda:0"))model.eval()input_tensor = torch.randn(4, 100, device="cuda:0")# èåˆå‰run(input_tensor, model, num_iters=20, name="no_fusion")# èåˆåfused_model = torch.nn.utils.fusion.fuse_linear_bn_eval(model.linear, model.bn)run(input_tensor, fused_model, num_iters=20, name="fusion")</code></pre><p></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312201356.png"></p><p>ç®—å­èåˆæ˜¯ä¼˜åŒ–æ·±åº¦å­¦ä¹ ç½‘ç»œçš„ä¸€ç§éå¸¸å¸¸è§çš„æ–¹æ³•ï¼Œå®ƒæœ‰åŠ©äºæå‡ç½‘ç»œè¿è¡Œæ•ˆç‡å’Œå‡å°‘èµ„æºæ¶ˆè€—ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒPyTorchçš„åŸç”Ÿæ¥å£ä¸­å¹¶æ²¡æœ‰æä¾›å¤ªå¤šå…³äºç®—å­èåˆçš„ç›´æ¥æ”¯æŒï¼Œé€šå¸¸éœ€è¦ä¾èµ–æ‰‹åŠ¨èåˆç®—å­ï¼Œè€Œè¿™ä¸€è¿‡ç¨‹å¯èƒ½è€—æ—¶è¾ƒé•¿ã€‚</p><p>åœ¨å®é™…è®­ç»ƒä¸­ï¼Œå¸¸è§çš„ç®—å­èåˆæ–¹æ³•åŒ…æ‹¬ä½¿ç”¨<strong>torch.compileå’Œå¼•å…¥é«˜æ€§èƒ½è‡ªå®šä¹‰ç®—å­</strong>ï¼Œä½†è¿™äº›æ–¹æ³•çš„åŸç†ç›¸å¯¹å¤æ‚ï¼Œæ›´è¯¦å°½çš„è®¨è®ºå’Œåº”ç”¨å°†åœ¨åé¢é«˜çº§ä¼˜åŒ–æ–¹æ³•ä¸­è¿›è¡Œã€‚</p><h2 id="å‡å°‘cpuå’Œgpué—´çš„åŒæ­¥">å‡å°‘CPUå’ŒGPUé—´çš„åŒæ­¥</h2><p>PyTorchä¸­çš„ä¸€äº›å†™æ³•ä¼šéšå¼åœ°è¿›è¡ŒåŒæ­¥ï¼Œè¿™å¸¸å¸¸æ˜¯PyTorchç¨‹åºæ€§èƒ½çš„â€œéšè—æ€æ‰‹â€â€‹ã€‚<strong>ç»å¤§å¤šæ•°éšå¼åŒæ­¥å…¶å®æœ‰ä¸€ä¸ªå…±æ€§ï¼Œé‚£ä¾¿æ˜¯æƒ³è¦åœ¨Pythonä¸­ä½¿ç”¨GPUå¼ é‡çš„å€¼ã€‚</strong><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312202357.png"></p><p>torch.nonzero()é€ æˆåŒæ­¥çš„ä¾‹å­ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnfrom torch.profiler import profile, ProfilerActivityclass Model(torch.nn.Module):    def __init__(self):        super(Model, self).__init__()        self.linear1 = nn.Linear(1000, 5000)        self.linear2 = nn.Linear(5000, 10000)        self.linear3 = nn.Linear(10000, 10000)        self.relu = nn.ReLU()    def forward(self, x):        output = self.relu(self.linear1(x))        output = self.relu(self.linear2(output))        output = self.relu(self.linear3(output))        #----------------éšå¼åŒæ­¥----------------#        nonzero = torch.nonzero(output)        return nonzerodef run(data, model):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for _ in range(10):            model(data)    prof.export_chrome_trace("traces/PROF_nonzero.json")data = torch.randn(1, 1000, device="cuda")model = Model().to(torch.device("cuda"))run(data, model)</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312203114.png"><p></p><p>cudaMemcpyAsyncï¼Œè¿™æ˜¯ä¸€ä¸ªGPUåˆ°CPUçš„æ•°æ®æ‹·è´(memcpy device to host)ã€‚torch.nonzero()ç®—å­ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¼ é‡ï¼Œå…¶ä¸­åŒ…å«è¾“å…¥å¼ é‡ä¸­æ‰€æœ‰éé›¶å…ƒç´ çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬åœ¨è¾“å…¥å¼ é‡ä¸­çš„ä½ç½®ã€‚éœ€è¦ç¡®ä¿nonzeroçš„è¾“å…¥å¼ é‡çš„å€¼è¿ç®—å®Œæ¯•ï¼Œè®¡ç®—å‡ºéé›¶å…ƒç´ çš„ä¸ªæ•°åå†å°†è¿™ä¸ªæ•°å­—ä»GPUä¼ å›CPUä¸Šã€‚</p><h2 id="é™ä½ç¨‹åºä¸­çš„é¢å¤–å¼€é”€">é™ä½ç¨‹åºä¸­çš„é¢å¤–å¼€é”€</h2><h3 id="pythonæ¥å£è°ƒç”¨å¼€é”€">Pythonæ¥å£è°ƒç”¨å¼€é”€</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨PyTorchçš„ä»»ä½•æ“ä½œæ—¶ï¼Œéƒ½ä¼šè§¦åŠä¸¤å±‚é€»è¾‘ï¼šä¸€æ˜¯ä¸Šå±‚çš„Pythonæ¥å£ï¼Œæä¾›çµæ´»æ€§å’Œæ˜“ç”¨æ€§ï¼›äºŒæ˜¯åº•å±‚çš„C++å®ç°ï¼Œç”¨äºä¿è¯è®¡ç®—æ•ˆç‡ã€‚ç”±äºç¬¬3ç« æåˆ°çš„PyTorchçš„CPUå’ŒGPUå¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œå¼€å‘è€…æœ‰æ—¶å¯èƒ½ä¸ä¼šæ„è¯†åˆ°è°ƒç”¨PyTorchAPIæ‰€éšå«çš„æ€§èƒ½å¼€é”€ã€‚</p><p>åœ¨å¯¹æ€§èƒ½æœ‰æé«˜è¦æ±‚çš„æ¨ç†åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘æ”¾å¼ƒä½¿ç”¨Pythonï¼Œè½¬è€Œç›´æ¥é‡‡ç”¨C++ç­‰é™æ€è¯­è¨€ï¼Œä»¥æœ€å°åŒ–è°ƒåº¦å¼€é”€ã€‚ç„¶è€Œï¼Œåœ¨æ›´åŠ æ³¨é‡çµæ´»æ€§å’Œæ˜“ç”¨æ€§çš„è®­ç»ƒåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†Pythonå±‚çš„é¢å¤–å¼€é”€è§†ä¸ºä¸€ç§â€œæ˜“ç”¨ç¨â€â€‹ï¼Œè¿™æ˜¯åœ¨å¼€å‘æ•ˆç‡å’Œç¨‹åºæ€§èƒ½ä¹‹é—´è¾¾æˆå¹³è¡¡çš„å¿…è¦æˆæœ¬ã€‚</p><h3 id="é¿å…å¼ é‡çš„åˆ›å»ºå¼€é”€">é¿å…å¼ é‡çš„åˆ›å»ºå¼€é”€</h3><p>å¼ é‡çš„åˆ›å»ºå’Œé”€æ¯ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ˜¾å­˜ç®¡ç†çš„æ“ä½œï¼Œè¿™äº›éƒ½æ˜¯å¼€é”€è¾ƒå¤§çš„æ“ä½œã€‚PyTorchå†…éƒ¨çš„ç¼“å­˜æ± æœºåˆ¶å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ”¹å–„ç”±åŠ¨æ€å¼ é‡åˆ†é…å¼•èµ·çš„æ€§èƒ½é—®é¢˜ï¼Œä½†å®ƒå¹¶ä¸èƒ½å®Œå…¨è§£å†³è¿™ä¸€é—®é¢˜ã€‚#### ç›´æ¥åœ¨GPUä¸Šåˆ›å»ºå¼ é‡è€Œä¸æ˜¯CPU æ¡ˆä¾‹ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnfrom torch.profiler import profile, ProfilerActivitydef tensor_creation(num_iters, create_on_gpu):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        shape = (10, 6400)        for i in range(num_iters):            #------------------------------------------------------------#            if create_on_gpu:                data = torch.randn(shape, device="cuda") # ç›´æ¥åœ¨GPUä¸Šåˆ›å»ºå¼ é‡            else:                data = torch.randn(shape).to("cuda") # å…ˆåœ¨CPUä¸Šåˆ›å»ºå¼ é‡ï¼Œç„¶åæ‹·è´åˆ°GPU            #------------------------------------------------------------#    prof.export_chrome_trace(        f"traces/PROF_tensor_creation_on_gpu_{create_on_gpu}.json"    )# æƒ…å†µ1. å…ˆåœ¨CPUä¸Šåˆ›å»ºTensorç„¶åæ‹·è´åˆ°GPUtensor_creation(20, create_on_gpu=False)# æƒ…å†µ2. ç›´æ¥åœ¨GPUä¸Šåˆ›å»ºTensortensor_creation(20, create_on_gpu=True)</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312204843.png"><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312204903.png">åœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨torch.randn().to("cuda")çš„å†™æ³•è€—æ—¶265Î¼sï¼Œè€Œä½¿ç”¨torch.randn(device="cuda")çš„å†™æ³•åˆ™åªéœ€è¦12Î¼sã€‚<p></p><h4 id="ä½¿ç”¨åŸä½æ“ä½œ">ä½¿ç”¨åŸä½æ“ä½œ</h4><p>å¤§éƒ¨åˆ†PyTorchæ“ä½œé»˜è®¤ä¼šä¸ºè¿”å›å¼ é‡åˆ›å»ºæ–°çš„å†…å­˜ï¼Œä½†å¤§éƒ¨åˆ†å¼ é‡åœ¨åˆ›é€ å‡ºæ¥ä¹‹ååªä½¿ç”¨ä¸€æ¬¡å³è¢«é”€æ¯ï¼Œè¿™æ ·å¤šå°‘ä¼šé€ æˆèµ„æºçš„æµªè´¹ã€‚</p><p>åŸä½æ“ä½œä½œä¸ä¼šç”Ÿæˆæ–°çš„è¾“å‡ºå¼ é‡ï¼Œè€Œæ˜¯ç›´æ¥åœ¨è¾“å…¥å¼ é‡ä¸Šè¿›è¡Œä¿®æ”¹ã€‚ç”±äºçœå»äº†å†…å­˜çš„åˆ›å»ºè¿‡ç¨‹ï¼ŒåŸä½æ“ä½œé€šå¸¸åœ¨æ€§èƒ½ä¸Šæ›´ä¸ºé«˜æ•ˆã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchfrom torch.profiler import profile, ProfilerActivitydef run(data, use_inplace):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for i in range(2):            #------------------------------------------------------------#            if use_inplace:                data.mul_(2) # åŸä½æ“ä½œï¼Œä¸€èˆ¬ä»¥_ç»“å°¾            else:                output = data.mul(2) # éåŸä½æ“ä½œ            #------------------------------------------------------------#    prof.export_chrome_trace(f"traces/PROF_use_inplace_{use_inplace}.json")shape = (32, 32, 256, 256)# Non-Inplacedata1 = torch.randn(shape, device="cuda:0")run(data1, use_inplace=False)# Inplacedata2 = torch.randn(shape, device="cuda:0")run(data2, use_inplace=True)</code></pre><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312205852.png"></p><h3 id="å…³é—­ä¸å¿…è¦çš„æ¢¯åº¦è®¡ç®—">å…³é—­ä¸å¿…è¦çš„æ¢¯åº¦è®¡ç®—</h3><p>åœ¨æŸäº›æ¨¡å‹å¾®è°ƒçš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹ä¸Šæ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„å°å‹æ¨¡å—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ä¼šè¢«å†»ç»“ï¼Œåªå¯¹æ–°å¢çš„è‡ªå®šä¹‰æ¨¡å—è¿›è¡Œè®­ç»ƒã€‚å¯¹äºè¿™éƒ¨åˆ†ä»…éœ€è¦å‰å‘ä¼ æ’­çš„ä»£ç ï¼Œé€šå¸¸ä½¿ç”¨<strong>torch.no_grad()</strong>è¿™ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„èŒƒå›´å†…ï¼Œæ‰€æœ‰åˆ›å»ºçš„å¼ é‡çš„requires_gradå±æ€§éƒ½è¢«æ ‡å¿—ä¸ºFalseï¼Œè¿™äº›å¼ é‡å‚ä¸çš„è®¡ç®—æ“ä½œä¸ä¼šè¢«è·Ÿè¸ªå†å²ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šåœ¨åå‘ä¼ æ’­ä¸­è®¡ç®—æ¢¯åº¦ã€‚</p><p>å¦ä¸€ç§ä¸éœ€è¦åå‘æ¢¯åº¦æ›´æ–°çš„åœºæ™¯æ˜¯çº¯æ¨ç†ä»£ç ï¼Œè¿™æ ·çš„ä½¿ç”¨åœºæ™¯ä¸‹å¾€å¾€æ‰€æœ‰çš„ä»£ç æ®µéƒ½åªæ‰¿æ‹…å‰å‘ä¼ æ’­çš„ä»»åŠ¡ï¼Œæ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­å®Œå…¨ä¸æ¶‰åŠåå‘ä¼ æ’­ã€‚ä¸€èˆ¬æ­¤æ—¶ä¼šå°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œå³è°ƒç”¨<strong>model.eval()</strong>ã€‚æ­¤æ“ä½œä¸»è¦æ”¹å˜æŸäº›å±‚çš„è¡Œä¸ºï¼šä¾‹å¦‚ï¼Œåœ¨æ¨ç†æ¨¡å¼ä¸‹ï¼ŒBatchNormalizationå±‚å°†ä¸ä¼šæ›´æ–°ç»Ÿè®¡æ•°æ®ï¼Œä¸”Dropoutå±‚ä¸ä¼šæ‰§è¡Œéšæœºä¸¢å¼ƒåŠŸèƒ½ã€‚è¿™æ˜¯ç¡®ä¿åœ¨æ¨ç†æ—¶è·å¾—å‡†ç¡®ç»“æœçš„å¿…è¦æ­¥éª¤ï¼Œå°½ç®¡å®ƒå¯¹æ€§èƒ½çš„æå‡å¹¶ä¸æ˜¾è‘—ã€‚</p><p>ä¸ºäº†åŠ é€Ÿæ¨ç†è¿‡ç¨‹ï¼ŒPyTorchæä¾›äº†<strong>torch.inference_mode()</strong>æ¥å£ï¼Œè¿™æ˜¯æ¯”torch.no_grad()æ›´ä¸ºæ¿€è¿›çš„é¢å‘æ¨ç†é¢„æµ‹ä»£ç çš„ä¼˜åŒ–ï¼Œé™¤äº†ä¸ç”Ÿæˆåå‘ç®—å­ä»¥å¤–ï¼Œè¿˜ä¼šå…³é—­ä¸€ç³»åˆ—åªåœ¨åå‘è¿‡ç¨‹èµ·ä½œç”¨çš„æ£€æŸ¥æˆ–è®¾ç½®ï¼Œæ¯”å¦‚åŸä½ç®—å­çš„ç‰ˆæœ¬æ£€æµ‹æœºåˆ¶ç­‰ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnimport timeclass SimpleCNN(nn.Module):    def __init__(self):        super(SimpleCNN, self).__init__()        self.conv1 = nn.Conv2d(3, 16, kernel_size=3, stride=1, padding=1)        self.relu = nn.ReLU()        self.conv2 = nn.Conv2d(16, 32, kernel_size=3, stride=1, padding=1)    def forward(self, x):        x = self.conv1(x)        x = self.relu(x)        x = self.conv2(x)        return xdef infer(input_data, num_iters, use_inference_mode):    start = time.perf_counter()    with torch.inference_mode(mode=use_inference_mode):        for _ in range(num_iters):            output = model(input_data)    torch.cuda.synchronize()    end = time.perf_counter()    return (end - start) * 1000model = SimpleCNN().to(torch.device("cuda:0"))input_data = torch.randn(1, 3, 224, 224, device="cuda:0")# ---------------------------------å¼€å¯Inference Mode---------------------------------#infer(input_data, num_iters=10, use_inference_mode=True)  # warm upruntime = infer(input_data, num_iters=100, use_inference_mode=True)print(f"å¼€å¯Inference Modeç”¨æ—¶: {runtime}s")# ---------------------------------å…³é—­Inference Mode---------------------------------#infer(input_data, num_iters=10, use_inference_mode=False)  # warm upruntime = infer(input_data, num_iters=100, use_inference_mode=False)print(f"å…³é—­Inference Modeç”¨æ—¶: {runtime}s")</code></pre><h2 id="æœ‰ä»£ä»·çš„æ€§èƒ½ä¼˜åŒ–">æœ‰ä»£ä»·çš„æ€§èƒ½ä¼˜åŒ–</h2><h3 id="ä½¿ç”¨ä½ç²¾åº¦æ•°æ®è¿›è¡Œæ‹·è´">ä½¿ç”¨ä½ç²¾åº¦æ•°æ®è¿›è¡Œæ‹·è´</h3><p>é‡‡ç”¨å¼‚æ­¥æ–¹å¼å¯ä»¥å‡å°‘GPUç­‰å¾…CPUæ•°æ®æ‹·è´çš„æ—¶é—´ï¼Œä½†æ˜¯æ²¡æœ‰åŠ é€Ÿæ‹·è´æœ¬èº«ï¼Œå¯¹äºå¤§å°ºå¯¸çš„è¾“å…¥å¼ é‡ï¼Œæˆ–è€…ä½¿ç”¨å¾ˆå¤§BatchSizeçš„åœºæ™¯ï¼Œæ•°æ®æ‹·è´æœ¬èº«ä¼šæ¶ˆè€—ç›¸å½“é•¿çš„æ—¶é—´ã€‚</p><p>å› æ­¤å¯ä»¥é‡‡ç”¨<strong>ä½ç²¾åº¦æ•°æ®è¿›è¡Œæ‹·è´</strong>ï¼Œå¯ä»¥å‚è€ƒå¸¸ç”¨çš„é‡åŒ–å‹ç¼©æ–¹æ³•æ¥å°†é«˜ç²¾åº¦æ•°æ®è½¬åŒ–ä¸ºä½ç²¾åº¦æ•°æ®ï¼Œè¯»å…¥åˆ°GPUåå†è½¬åŒ–å›é«˜ç²¾åº¦æ•°æ®å‚ä¸è®­ç»ƒï¼›æˆ–è€…ä½¿ç”¨å¯¹GPUå‹å¥½çš„ç¼–è§£ç ç®—æ³•â€”â€”è¯»å–ç¼–ç å‹ç¼©åçš„æ•°æ®ï¼Œç„¶ååœ¨GPUä¸Šè¿›è¡Œè§£ç ç­‰ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnfrom torch.profiler import profile, ProfilerActivitydef data_copy(data, dtype_name=""):    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for _ in range(10):            output = data.to("cuda:0", non_blocking=False)    prof.export_chrome_trace(f"traces/PROF_data_copy_{dtype_name}.json")# Float precisiondata1 = torch.randn(4, 32, 32, 1024, dtype=torch.float32)data_copy(data1, "float32")# Uint8 precisiondata2 = torch.randint(0, 255, (4, 32, 32, 1024), dtype=torch.uint8)data_copy(data2, "uint8")</code></pre><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312211943.png"></p><p>åœ¨æ¡ä»¶å…è®¸çš„æ—¶å€™åº”è¯¥å°½é‡ä½¿ç”¨æ— æŸçš„å‹ç¼©æŠ€æœ¯ï¼Œç„¶è€Œå®é™…åº”ç”¨ä¸­å¤§éƒ¨åˆ†é‡åŒ–å‹ç¼©ç®—æ³•ä»¥åŠéƒ¨åˆ†ç¼–è§£ç ç®—æ³•éƒ½æ˜¯æœ‰æŸå‹ç¼©ã€‚å› æ­¤åœ¨å†³å®šä½¿ç”¨ä½ç²¾åº¦æ•°æ®å‰è¿˜éœ€è¦ä»”ç»†éªŒè¯ã€‚<strong>å¯¹äºä¸€äº›æ²¡æœ‰æ˜ç¡®æ•°å€¼ç•Œé™çš„æ•°æ®æ¥è¯´ï¼Œé‡åŒ–å‹ç¼©åˆ°ä½ç²¾åº¦æ•°æ®å¯èƒ½å¯¹äºè®­ç»ƒç»“æœå’Œæ”¶æ•›æ€§æ˜¯æœ‰æŸä¼¤çš„ã€‚</strong></p><h3 id="ä½¿ç”¨æ€§èƒ½ç‰¹åŒ–çš„ä¼˜åŒ–å™¨">ä½¿ç”¨æ€§èƒ½ç‰¹åŒ–çš„ä¼˜åŒ–å™¨</h3><p>åœ¨è®­ç»ƒä»»åŠ¡ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šå°†åå‘ä¼ æ’­è®¡ç®—å‡ºæ¥çš„æ¢¯åº¦ç›´æ¥ç´¯åŠ åˆ°æ¨¡å‹å‚æ•°ä¸Šï¼Œè€Œæ˜¯é€šè¿‡ä¼˜åŒ–å™¨(optimizer)æ¥æ§åˆ¶å‚æ•°æ›´æ–°çš„æ•°å€¼ã€‚ä¸€èˆ¬æ¥è¯´<strong>ä¼˜åŒ–å™¨ä¼šå¯¹æ¢¯åº¦è¿›è¡Œä¸€ç³»åˆ—åŠ å·¥ï¼Œéšåè®¡ç®—å‡ºå‚æ•°æ›´æ–°çš„å…·ä½“æ•°å€¼</strong>ã€‚</p><p>PyTorché’ˆå¯¹æ¯ç§ä¼˜åŒ–å™¨ï¼Œæä¾›äº†ä¸‰ç§ä¸åŒçš„æ¢¯åº¦æ›´æ–°å®ç°ï¼šfor-loopã€for-eachã€fusedã€‚</p><h4 id="for-loop">for-loop</h4><p>or-loopæ˜¯æœ€ä¸ºåé‡äºèŠ‚çœæ˜¾å­˜çš„å®ç°ï¼Œä½†æ˜¯æ€§èƒ½æ¯”è¾ƒå·®ã€‚ä¸¾ä¾‹è¯´æ˜å…¶å®ç°åŸç†ï¼šå‡å¦‚ä½¿ç”¨SGDæ–¹æ³•æ›´æ–°10ä¸ªå‚æ•°â€”â€”ä»w1åˆ°w10ï¼Œåˆ™for-loopä¼šä½¿ç”¨Pythonä¸­çš„ä¸²è¡Œå¾ªç¯ï¼Œæ¯æ¬¡æ›´æ–°å…¶ä¸­ä¸€ä¸ªæƒé‡ï¼ŒSGDçš„æ¢¯åº¦æ›´æ–°æ–¹å¼é€šå¸¸åŒ…æ‹¬ä¸€æ¬¡ä¹˜æ³•å’Œä¸€æ¬¡åŠ æ³•ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># ä¼ªä»£ç for w in [w1, w2, ..., w10]:    w = w - lr * w.grad</code></pre><p></p><p>åœ¨PyTorchä¸­ï¼Œç”±äºåŠ¨æ€å›¾çš„å±€é™æ€§ï¼Œæ‰€æœ‰ç®—å­è®¡ç®—éƒ½ä¸èƒ½è‡ªåŠ¨èåˆï¼Œå› æ­¤æ›´æ–°æ‰€æœ‰å‚æ•°éœ€è¦è°ƒç”¨10æ¬¡ä¹˜æ³•ç®—å­å’Œ10æ¬¡åŠ æ³•ç®—å­ã€‚è¿™æ€»è®¡20æ¬¡ç®—å­çš„è°ƒç”¨æˆæœ¬å¯èƒ½è¿œå¤§äºåº•å±‚CUDAä¹˜æ³•ã€CUDAåŠ æ³•è®¡ç®—ã€‚ç‰¹åˆ«æ˜¯åœ¨å‚æ•°æ•°é‡éå¸¸å¤šçš„æ—¶å€™ï¼Œåå¤çš„ç®—å­è°ƒç”¨ä¼šæå¤§åœ°æŸè€—æ€§èƒ½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒPyTorchè¿›ä¸€æ­¥å¼•å…¥äº†for-eachæ–¹æ³•ã€‚</p><h4 id="for-eachå’Œfused">for-eachå’Œfused</h4><p>for-eachæ˜¯ç›¸å¯¹åé‡äºæ€§èƒ½çš„æ–¹æ³•ï¼Œä½†å…¶å ç”¨çš„æ˜¾å­˜ä¼šæ›´å¤šã€‚ç”±äºæ‰€æœ‰å‚æ•°æ›´æ–°éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠ10ä¸ªå‚æ•°åˆå¹¶åˆ°ä¸€ä¸ªå¼ é‡ä¸­ï¼Œè¿™æ ·å°±åªéœ€è¦å¯¹è¿™ä¸ªåˆå¹¶å¼ é‡è°ƒç”¨1æ¬¡ä¹˜æ³•ç®—å­å’Œ1æ¬¡åŠ æ³•ç®—å­å³å¯ã€‚è™½ç„¶å®é™…è®¡ç®—é‡æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯æå¤§åœ°é™ä½äº†ç®—å­åå¤è°ƒç”¨çš„æ¬¡æ•°ï¼Œæé«˜äº†æ€§èƒ½ã€‚</p><p>ä½†æ˜¯å¯¹ä¸€äº›æ›´å¤æ‚çš„ä¼˜åŒ–å™¨æ¥è¯´ï¼Œæ¯”å¦‚åŒ…å«äº†è‹¥å¹²ä¹˜æ³•ã€é™¤æ³•ã€åŠ å‡æ³•ã€å¹³æ–¹å¼€æ–¹ç­‰è¿ç®—çš„Adamä¼˜åŒ–å™¨è€Œè¨€ï¼Œå³ä½¿ä½¿ç”¨äº†for-eachæ–¹æ³•ä¹‹åä¾ç„¶è¿˜æœ‰å¾ˆå¤šç®—å­è°ƒç”¨ã€‚fusedæ–¹æ³•åœ¨for-eachçš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å°†ä¼˜åŒ–å™¨çš„æ‰€æœ‰è®¡ç®—éƒ½åˆå¹¶æˆä¸€ä¸ªç®—å­ï¼Œæ‰€ä»¥èƒ½å¤Ÿè¾¾åˆ°æœ€ä½³çš„è®¡ç®—æ€§èƒ½ï¼Œä½†æ˜¯å…¶æ˜¾å­˜å ç”¨ä¹Ÿæ¯”è¾ƒé«˜ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchfrom torch.profiler import profile, ProfilerActivityclass SimpleNet(torch.nn.Module):    def __init__(self):        super(SimpleNet, self).__init__()        self.fcs = torch.nn.ModuleList(torch.nn.Linear(200, 200) for i in range(20))    def forward(self, x):        for i in range(len(self.fcs)):            x = torch.relu(self.fcs[i](x))        return xdef train(net, optimizer, opt_name=""):    data = torch.randn(64, 200, device="cuda:0")    target = torch.randint(0, 1, (64,), device="cuda:0")    criterion = torch.nn.CrossEntropyLoss()    with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof:        for _ in range(5):            optimizer.zero_grad()            output = net(data)            loss = criterion(output, target)            loss.backward()            optimizer.step()    prof.export_chrome_trace(f"traces/PROF_perf_{opt_name}.json")# ----------------------For-loop----------------------#net = SimpleNet().to(torch.device("cuda:0"))adam_for_loop = torch.optim.Adam(    net.parameters(), lr=0.01, foreach=False, fused=False)train(net, adam_for_loop, opt_name="for_loop")# ----------------------For-each----------------------#net = SimpleNet().to(torch.device("cuda:0"))adam_for_each = torch.optim.Adam(    net.parameters(), lr=0.01, foreach=True, fused=False)train(net, adam_for_each, opt_name="for_each")# ----------------------Fused----------------------#net = SimpleNet().to(torch.device("cuda:0"))adam_fused = torch.optim.Adam(net.parameters(), lr=0.01, foreach=False, fused=True)train(net, adam_fused, opt_name="fused")</code></pre><p>for-loopæ¯æ¬¡åªæ›´æ–°ä¸€ä¸ªå‚æ•°ï¼Œå¦‚å›¾æ‰€ç¤ºfor-loopå®ç°ä¼šå¾ªç¯è°ƒç”¨addã€lerpã€mulã€addcmulç­‰ç®—å­:<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312213219.png"></p><p>for-eachå®ç°åˆ™ä¼šå°†addã€lerpã€mulã€addcmulâ€¦â€¦è¿™äº›ç‹¬ç«‹çš„è°ƒç”¨æŒ‰ç±»å‹åˆå¹¶ï¼Œæ‰€ä»¥GPUé˜Ÿåˆ—ä¸­åªä¼šçœ‹åˆ°7ä¸ªèåˆç®—å­å¯¹åº”çš„è®¡ç®—ä»»åŠ¡:<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312213328.png"></p><p>fusedåˆ™é‡‡ç”¨äº†æ›´ä¸ºæ¿€è¿›çš„èåˆç­–ç•¥ï¼Œå¯ä»¥çœ‹åˆ°ç®—å­è°ƒç”¨æ¬¡æ•°å‡å°‘åˆ°äº†ä¸¤æ¬¡ï¼Œåˆ†åˆ«ä¸ºä¸¤ä¸ªå·¨å¤§çš„èåˆç®—å­ï¼Œè¿™å¯¼è‡´ä¼˜åŒ–å™¨çš„CPUå»¶è¿Ÿè¢«å‹ç¼©åˆ°éå¸¸çŸ­ï¼Œåœ¨æ€§èƒ½ä¸Šæ›´å…·ä¼˜åŠ¿ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312213357.png"></p><h2 id="å°ç»“">å°ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250312213503.png">æœ¬ç« è®²è¿°çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œå…¶ä¼˜åŒ–ä¸Šé™æ˜¯å°†GPUé˜Ÿåˆ—ä¸­çš„â€œæ°”æ³¡â€å®Œå…¨æ¶ˆé™¤â€”â€”ä¹Ÿå°±æ˜¯è®©GPUè¾¾åˆ°æ»¡è½½çŠ¶æ€ï¼Œä½†è¿™å¹¶ä¸æ˜¯æ€§èƒ½ä¼˜åŒ–çš„ç»ˆç‚¹ã€‚</p><p>åœ¨GPUè¾¾åˆ°æ»¡è½½ä¹‹åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©é«˜çº§ä¼˜åŒ–æ–¹æ³•ä¸­çš„æŠ€å·§æ¥è¿›ä¸€æ­¥ä¼˜åŒ–GPUè®¡ç®—æ•ˆç‡ã€‚</p><p>æœ€åå½“æˆ‘ä»¬å°†è®­ç»ƒæ€§èƒ½ä¼˜åŒ–åˆ°æé™ä¹‹åï¼Œè¿˜å¯ä»¥é‡‡ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®å¹¶è¡Œçš„ç­–ç•¥å†æ¬¡å¯¹æ¨¡å‹è®­ç»ƒè¿›è¡ŒåŠ é€Ÿã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> å•å¡æ€§èƒ½ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-æ•°æ®åŠ è½½å’Œé¢„å¤„ç†</title>
      <link href="/2025/03/11/da-mo-xing-dong-li-yin-qing-shu-ju-jia-zai-he-yu-chu-li/"/>
      <url>/2025/03/11/da-mo-xing-dong-li-yin-qing-shu-ju-jia-zai-he-yu-chu-li/</url>
      
        <content type="html"><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311171922.png"></p><h2 id="æ•°æ®æ¥å…¥å‡†å¤‡">æ•°æ®æ¥å…¥å‡†å¤‡</h2><p>å¯¹äºä¸€äº›ç»å…¸ä»»åŠ¡å¯ä»¥ä»å…¬å…±æ•°æ®é›†ä¸­æŠ½å–å°è§„æ¨¡å­é›†æ¥å¿«é€Ÿè¿›è¡Œæ”¶æ•›æ€§éªŒè¯ï¼Œæ’é™¤ä»£ç é”™è¯¯ã€‚### å¸¸ç”¨å…¬å¼€æ•°æ®é›† <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311172108.png"></p><h2 id="æ•°æ®é›†çš„è·å–å’Œé¢„å¤„ç†">æ•°æ®é›†çš„è·å–å’Œé¢„å¤„ç†</h2><h3 id="è·å–åŸå§‹æ•°æ®">è·å–åŸå§‹æ•°æ®</h3><p>ä¸»è¦åŒ…å«ä¸¤ä¸ªæ¥æºï¼š - å…¬å¼€æ•°æ®é›† - è‡ªå®šä¹‰æ•°æ®é›†</p><h3 id="åŸå§‹æ•°æ®çš„æ¸…æ´—">åŸå§‹æ•°æ®çš„æ¸…æ´—</h3><p><strong>ä¸€ä¸ªç®—æ³•å·¥ç¨‹å¸ˆå¿…é¡»å…·å¤‡çš„å…³é”®èƒ½åŠ›ä¹‹ä¸€æ˜¯å¯¹æ•°æ®çš„æ•æ„Ÿåº¦</strong>ï¼šå¯¹äºç‰¹å®šä»»åŠ¡ï¼Œèƒ½å¤Ÿåˆ¤æ–­æ•°æ®é›†å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼ŒçŸ¥é“ç†æƒ³æ•°æ®åº”å‘ˆç°çš„å½¢æ€ï¼Œèƒ½ç»„ç»‡é«˜è´¨é‡çš„æ•°æ®é›†ï¼Œå¹¶èƒ½éªŒè¯æ•°æ®çš„è´¨é‡ã€‚</p><p>å¯¹äºæ·±åº¦å­¦ä¹ æ•°æ®æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®æŒ‰ç…§æœ‰æ— æ ‡ç­¾è¿›è¡Œåˆ†ç±»ã€‚</p><p><strong>æ— æ ‡ç­¾çš„æ•°æ®ä¸€èˆ¬ç”¨äºæ— ç›‘ç£å­¦ä¹ </strong>ï¼Œè¿™ç±»æ•°æ®çš„é—®é¢˜å¾€å¾€å‡ºåœ¨éƒ¨åˆ†æ•°æ®è‡ªèº«è´¨é‡è¾ƒå·®ã€‚è¿™é‡Œåªåˆ—ä¸¾ä¸€äº›å¸¸è§æƒ…å†µï¼š- å›¾ç‰‡/è§†é¢‘/å›¾å½¢ç±»æ•°æ®ï¼šä½åˆ†è¾¨ç‡ã€é«˜å™ªå£°ã€é«˜æ›å…‰ã€‚ -æ–‡æœ¬ç±»æ•°æ®ï¼šä¸ç¬¦åˆè‡ªç„¶è¯­è¨€ï¼Œå«æœ‰å¥‡æ€ªçš„ç¬¦å·ã€æ ‡ç‚¹ã€ç‰¹æ®Šæ•°å€¼ç­‰ã€‚</p><p><strong>æœ‰æ ‡ç­¾çš„æ•°æ®åˆ™å¾€å¾€ç”¨äºç›‘ç£å­¦ä¹ </strong>ï¼Œåœ¨æ•°æ®æœ¬èº«è´¨é‡å·®çš„åŸºç¡€ä¸Šï¼Œè¿˜ä¼šå‡ºç°æ ‡ç­¾å’Œæ•°æ®å¯¹ä¸ä¸Šçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œè´§ä¸å¯¹ç‰ˆâ€â€‹ï¼Œæ¯”å¦‚è¯´å›¾ç‰‡çš„åˆ†ç±»ä¸æ­£ç¡®ï¼Œæˆ–è€…å›¾ç‰‡çš„æè¿°ä¸åˆé€‚ã€‚é™¤æ­¤ä»¥å¤–ï¼Œè¿˜æœ‰å¯èƒ½å‡ºç°ä¸€å¯¹å¤šçš„é”™è¯¯ï¼Œæ¯”å¦‚åŒæ ·çš„å›¾ç‰‡è¢«è´´ä¸Šäº†ç›¸äº’å†²çªçš„æè¿°ç­‰ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311172950.png"></p><p>å¤§éƒ¨åˆ†æ•°æ®æ¸…æ´—å·¥ä½œéƒ½ä¾èµ–äºè„šæœ¬è¿›è¡Œã€‚ä¸ºäº†å†™ä½œè¿™æ ·çš„è„šæœ¬ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åšçš„æ˜¯ä¸ºè„æ•°æ®åˆ’å®šä¸€æ¡æ˜ç¡®çš„ç•Œé™ã€‚åœ¨å¯¹æ•°æ®è¿›è¡Œæ£€æŸ¥æ—¶ï¼Œæœ‰äº›æ ‡å‡†å¯ä»¥ç®€å•è¯»å–ï¼Œæ¯”å¦‚å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œä½†æ˜¯æŸäº›æ ‡å‡†å¯èƒ½éœ€è¦å€ŸåŠ©å…¶ä»–ç®—æ³•æˆ–è€…é¢„è®­ç»ƒæ¨¡å‹æ¥å¯¹æ•°æ®è¿›è¡Œåˆ¤æ–­ã€‚</p><p>å¦å¤–ï¼Œç›´æ¥é€šè¿‡é¢„è®­ç»ƒçš„å¤§æ¨¡å‹æ¥å¯¹æ•°æ®è¿›è¡Œç»¼åˆæ‰“åˆ†ä¹Ÿæ˜¯ä¸€ç§æ•°æ®æ¸…æ´—çš„æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šæ˜¯æ•°æ®è’¸é¦ï¼Œéœ€è¦ä¿è¯é¢„è®­ç»ƒæ¨¡å‹çš„ä¼˜è´¨æ€§ã€‚</p><h3 id="æ•°æ®çš„ç¦»çº¿é¢„å¤„ç†">æ•°æ®çš„ç¦»çº¿é¢„å¤„ç†</h3><p>æ•°æ®é¢„å¤„ç†ä¸»è¦æ˜¯ä¸ºäº†æ”¹å–„æ•°æ®çš„è´¨é‡å’Œç»“æ„ï¼Œä»¥åŠé’ˆå¯¹æ¨¡å‹å¯¹æ•°æ®è¿›è¡Œé€‚é…ã€‚ä¸€äº›å¸¸è§çš„ç¦»çº¿æ•°æ®é¢„å¤„ç†æ­¥éª¤åŒ…æ‹¬æ•°å€¼èŒƒå›´çš„æ ‡å‡†åŒ–ã€æ•°æ®ç¼–ç ã€æ•°æ®å¢å¼ºç­‰ã€‚</p><h4 id="æ•°å€¼èŒƒå›´çš„æ ‡å‡†åŒ–">æ•°å€¼èŒƒå›´çš„æ ‡å‡†åŒ–</h4><p>å¦‚æœ€å°-æœ€å¤§å½’ä¸€åŒ–(min-maxscaling)æˆ–è€…ç¼©æ”¾åˆ°æ­£æ€åˆ†å¸ƒçš„æ ‡å‡†åŒ–(standardization)ã€‚</p><p>éœ€è¦æ³¨æ„æœ€å°-æœ€å¤§å½’ä¸€åŒ–éœ€è¦è€ƒè™‘æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨æç«¯å€¼ï¼Œå¦åˆ™ä¼šä¸¥é‡å½±å“æ•°æ®åˆ†å¸ƒã€‚</p><h4 id="æ•°æ®ç¼–ç ">æ•°æ®ç¼–ç </h4><p>å°†éæ•°å€¼æ•°æ®è½¬æ¢ä¸ºæ•°å€¼æ ¼å¼çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚æ•°æ®é›†ä¸­çš„æ ‡ç­¾æ•°æ®ä¸€èˆ¬éƒ½éœ€è¦ç»è¿‡æ•°æ®ç¼–ç æ‰èƒ½è¾“å…¥åˆ°æ¨¡å‹ä¸­ã€‚</p><h4 id="å‡è¡¡æ•°æ®åˆ†å¸ƒ">å‡è¡¡æ•°æ®åˆ†å¸ƒ</h4><p>å½“æ•°æ®é›†ä¸­æŸäº›ç±»åˆ«çš„æ ·æœ¬æ•°é‡è¿œå°‘äºå…¶ä»–ç±»åˆ«ï¼Œè¿™ç§ä¸å¹³è¡¡æœ‰å¯èƒ½å¯¼è‡´æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¯¹å å¤šæ•°çš„ç±»åˆ«è¿‡åº¦æ‹Ÿåˆï¼Œè€Œæ— æ³•æœ‰æ•ˆå­¦ä¹ åˆ°å°‘æ•°ç±»åˆ«çš„ç‰¹å¾ã€‚</p><p>æ•°æ®å¢å¼ºå¯ä»¥é€šè¿‡å¯¹åŸå§‹æ•°æ®è¿›è¡Œä¸€äº›å˜æ¢ï¼Œç”Ÿæˆæ–°çš„æ•°æ®ï¼Œä»è€Œå¢åŠ æ•°æ®é›†çš„å¤šæ ·æ€§ï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚åœ¨æ–‡æœ¬å¤„ç†ä¸­ï¼Œæ•°æ®å¢å¼ºåŒ…æ‹¬åŒä¹‰è¯æ›¿æ¢ã€å¥å­é‡æ’ç­‰ï¼›åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œæ•°æ®å¢å¼ºåŒ…æ‹¬æ—‹è½¬ã€è£å‰ªã€ç¿»è½¬ã€æ”¹å˜äº®åº¦ã€å¯¹æ¯”åº¦ç­‰ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šæ–¹æ³•ï¼Œæ¯”å¦‚mixupã€cutoutã€cutmixã€mosaicç­‰ã€‚</p><h4 id="pythonæ•°æ®å¤„ç†åº“">Pythonæ•°æ®å¤„ç†åº“</h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311175426.png"></p><h3 id="æ•°æ®çš„å­˜å‚¨">æ•°æ®çš„å­˜å‚¨</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªæ•°æ®é›†ç”±ä¸‰ç§ç±»å‹çš„æ•°æ®ç»„æˆï¼š -æ ¸å¿ƒæ•°æ®ï¼šæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€æ–‡æœ¬ç­‰ï¼Œæ ¹æ®æ•°æ®é›†é¢å‘çš„è®­ç»ƒä»»åŠ¡è€Œå®šã€‚ -æ•°æ®æ ‡ç­¾æˆ–å…¶ä»–è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰â€‹ï¼šæ¯”å¦‚å›¾ç‰‡åˆ†ç±»æ•°æ®ä¸­ï¼Œæ¯å¼ å›¾ç‰‡å¯¹åº”çš„ç±»åˆ«æ ‡ç­¾ï¼›æ¯”å¦‚å›¾ç‰‡-æ–‡å­—æ•°æ®é›†ä¸­æ¯ä¸ªå›¾ç‰‡å¯¹åº”çš„æ–‡å­—æè¿°ã€‚- æ•°æ®é›†ä¿¡æ¯ï¼šæ¯”å¦‚æ•°æ®é›†çš„ç‰ˆæœ¬ã€åŸå§‹æ•°æ®æ¥æºã€é¢„å¤„ç†æ–¹æ³•ã€å‚æ•°ç­‰ã€‚</p><p>æ•°æ®çš„å­˜å‚¨æ ¼å¼å¤šç§å¤šæ ·ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311180157.png"></p><h3 id="pytorchä¸ç¬¬ä¸‰æ–¹åº“çš„äº¤äº’">PyTorchä¸ç¬¬ä¸‰æ–¹åº“çš„äº¤äº’</h3><p>é€šè¿‡Pythonåº“æˆ‘ä»¬å¯ä»¥å°†æ•°æ®ä»ç¡¬ç›˜æˆ–æœåŠ¡å™¨ä¸Šè¯»å–åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶è¯»å…¥å†…å­˜çš„æ•°æ®é€šå¸¸ä»¥ç¬¬ä¸‰æ–¹åº“æ•°æ®ç±»å‹å¦‚NumPyndarrayæˆ–PIL Imageå½¢å¼å­˜åœ¨ï¼ŒPyTorchæ— æ³•ç›´æ¥è§£æè¿™äº›ç±»å‹ã€‚</p><p>è€Œæ— è®ºæ˜¯ç¬¬ä¸‰æ–¹åº“çš„è¿˜æ˜¯PythonåŸç”Ÿçš„ï¼Œéƒ½å¿…é¡»è½¬åŒ–ä¸ºå¼ é‡åæ‰èƒ½ç”¨äºè®­ç»ƒã€‚PyTorchä¸ºäº†ä¾¿äºä½¿ç”¨NumPyæ•°æ®ï¼Œç‰¹åˆ«æä¾›äº†å°†NumPyndarrayè½¬æ¢ä¸ºå¼ é‡çš„æ¥å£ã€‚å¯¹äºå…¶ä»–æ— ç›´æ¥æ¥å£çš„åº“å¦‚Pandasç­‰ï¼Œå»ºè®®å…ˆè½¬æ¢ä¸ºNumPyndarrayå†å¯¼å…¥åˆ°PyTorchã€‚ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import numpy as npimport torchx = np.zeros((3, 3))y = torch.from_numpy(x)print(y, type(y))# tensor([[0., 0., 0.],#        [0., 0., 0.],#        [0., 0., 0.]], dtype=torch.float64) &lt;class 'torch.Tensor'&gt;</code></pre>å¯¹äºç¤ºä¾‹ä¸­çš„from_numpyè°ƒç”¨ï¼Œå…¶<strong>è¿”å›çš„PyTorchå¼ é‡å†…å­˜åœ°å€ä¸åŸå…ˆçš„numpy.ndarrayå®Œå…¨ç›¸åŒ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰åšé¢å¤–çš„æ•°æ®å¤åˆ¶æ“ä½œã€‚<p></p><p>ä½†æ˜¯å½“PyTorchæ— æ³•å¤ç”¨åŸå§‹numpy.ndarrayçš„å†…å­˜æ—¶ï¼Œfrom_numpyä¼šæŠ¥é”™ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import numpy as npimport torchx = np.random.random(size=(4, 4, 2))y = np.flip(x, axis=0) # ç¿»è½¬xçš„ç¬¬ä¸€ä¸ªç»´åº¦ï¼Œå¯¼è‡´strideä¸ºè´Ÿ# æŠ¥é”™# ValueError: At least one stride in the given numpy array is negative,# and tensors with negative strides are not currently supported.# (You can probably work around this by making a copy of your array  with array.copy().)torch.from_numpy(y)# åˆ›å»ºå‰¯æœ¬åèƒ½å¤Ÿæ­£å¸¸è¿è¡Œtorch.from_numpy(y.copy())</code></pre><p></p><h2 id="æ•°æ®é›†çš„åŠ è½½ä¸ä½¿ç”¨">æ•°æ®é›†çš„åŠ è½½ä¸ä½¿ç”¨</h2><p>ä¸€èˆ¬çš„ä¸²è¡ŒåŠ è½½æ–¹æ³•ï¼šä½¿ç”¨jsonã€csvç­‰åº“å‡½æ•°è¯»å–æ ‡ç­¾ä¿¡æ¯ï¼Œä½¿ç”¨PILç­‰åº“æ¥åŠ è½½å›¾ç‰‡æ•°æ®ï¼Œæœ€åå†ä½¿ç”¨å¦‚tensor.from_numpy()ç­‰æ¥å£å°†æ•°æ®è½¬åŒ–ä¸ºå¼ é‡æ•°æ®é€å…¥æ¨¡å‹ã€‚</p><p>ç„¶è€Œåœ¨è¿›è¡Œå¤§è§„æ¨¡è®­ç»ƒçš„æ—¶å€™ï¼Œä¸²è¡Œçš„æ•°æ®åŠ è½½å’Œé¢„å¤„ç†å°±ä¼šæ˜¾è‘—é˜»å¡æ¨¡å‹è¿ç®—ï¼Œä¸¥é‡å½±å“è®­ç»ƒæ•ˆç‡ï¼Œé«˜æ•ˆçš„æ–¹æ³•æ˜¯ï¼šåœ¨æ¨¡å‹è¿›è¡ŒGPUè¿ç®—çš„åŒæ—¶ï¼ŒCPUèƒ½å¼‚æ­¥å‡†å¤‡å¥½ä¸€ä¸‹è½®çš„è®­ç»ƒæ•°æ®ã€‚</p><p>PyTorchä¸­ä½¿ç”¨Datasetç±»å’ŒDataloaderç±»æ¥æ”¯æŒä¸Šè¿°æ•°æ®åŠ è½½è¿‡ç¨‹çš„ä¼˜åŒ–ã€‚</p><p>Datasetæè¿°äº†è¯»å–å•ä¸ªæ•°æ®çš„æ–¹æ³•ä»¥åŠå¿…è¦çš„é¢„å¤„ç†ï¼Œè¾“å‡ºçš„æ˜¯å•ä¸ªå¼ é‡ã€‚DataLoaderåˆ™å®šä¹‰äº†æ‰¹é‡è¯»å–æ•°æ®çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬BatchSizeã€é¢„è¯»å–ã€å¤šè¿›ç¨‹è¯»å–ç­‰ï¼Œè¾“å‡ºçš„ç»“æœæ˜¯ä¸€æ‰¹å¼ é‡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311202356.png"></p><h3 id="datasetå°è£…">Datasetå°è£…</h3><p>PyTorchæ¡†æ¶æä¾›äº†ä¸¤ç§ç±»å‹çš„æ•°æ®é›†æŠ½è±¡ï¼šæ˜ å°„å¼æ•°æ®é›†(map styledataset)å’Œè¿­ä»£å¼æ•°æ®é›†(iterable styledataset)ï¼Œå®ƒä»¬åœ¨æ•°æ®çš„è®¿é—®å’Œ<strong>é€‚ç”¨åœºæ™¯</strong>ä¸Šæœ‰æ‰€ä¸åŒã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311202525.png"></p><p>Pytorchå·²ç»å°†è®¸å¤šå¸¸è§æ•°æ®é›†é¢„å°è£…æˆDatasetç±»ï¼Œæ¯”å¦‚torchvision.datasets.CIFAR10ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchvision.datasets as datasetsimport torchvision.transforms as transformstransform = transforms.Compose([transforms.ToTensor()])train_dataset = datasets.CIFAR10(    root="./data", train=True, download=True, transform=transform)test_dataset = datasets.CIFAR10(    root="./data", train=False, download=True, transform=transform)</code></pre><p></p><p>å¯¹äºè‡ªå®šä¹‰æ•°æ®é›†åˆ™éœ€è¦è‡ªå·±å¯¹æ•°æ®è¿›è¡ŒDatasetå°è£…ï¼Œæˆ‘ä»¬ä»¥æœ¬åœ°ä¸‹è½½çš„Cifar10æ•°æ®é›†ä¸ºä¾‹ï¼Œè¿›è¡ŒDatasetå°è£…ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311203721.png"></p><p>å¤§æ¦‚æ–¹å¼æ˜¯ï¼šå®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ªDatasetç±»çš„CifarDatasetã€‚ç„¶åä¸ºCifarDatasetå®ç°ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼š-__init__æ–¹æ³•ï¼šæ„é€ æŒ‡å‘æ¯ä¸ªæ•°æ®è·¯å¾„çš„åˆ—è¡¨ï¼Œæ¯”å¦‚åœ¨ä¸Šä¾‹ä¸­æˆ‘ä»¬æ„é€ äº†â€œå›¾ç‰‡è·¯å¾„-æ ‡ç­¾â€çš„åˆ—è¡¨ã€‚æˆ‘ä»¬æ²¡æœ‰ç›´æ¥è¯»å–å›¾ç‰‡ï¼Œè¿™æ˜¯é˜²æ­¢å†…å­˜è¢«è¿‡å¤šæ•°æ®æŒ¤çˆ†ã€‚- __len__æ–¹æ³•ï¼šè¿”å›æ•°æ®é›†ä¸­çš„æ ·æœ¬æ•°ã€‚ -__getitem__æ–¹æ³•ï¼šæ ¹æ®ç´¢å¼•è¯»å–å›¾ç‰‡æ•°æ®ï¼Œå¹¶å°†æ•°æ®è½¬æ¢ä¸ºPyTorchå¼ é‡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311204632.png"></p><h3 id="dataloaderå°è£…">DataLoaderå°è£…</h3><p>ä¸æ¨¡å‹è®­ç»ƒç›¸å…³çš„æ•°æ®åŠ è½½æ“ä½œï¼Œå¦‚å¯¹æ•°æ®é›†è¿›è¡Œé‡‡æ ·å¹¶æ‰¹é‡åŠ è½½æ•°æ®ã€ä½¿ç”¨å¤šä¸ªå­è¿›ç¨‹æ¥å¹¶è¡ŒåŠ è½½æ•°æ®ç­‰éƒ½åœ¨Dataloaderç±»ä¸­æœ‰è‰¯å¥½çš„å®ç°å’Œå°è£…ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311205133.png">- batch_sizeï¼šæŒ‡å®šæ¯ä¸ªæ‰¹æ¬¡ä¸­çš„æ ·æœ¬æ•°é‡ã€‚ -shuffleï¼šæ˜¯samplerå‚æ•°çš„â€œå¿«æ·é”®â€â€‹ã€‚shuffle=Falseç›¸å½“äºé¡ºåºé‡‡æ ·ï¼Œå³sampler=SequentialSamplerï¼›è€Œshuffle=Trueç›¸å½“äºéšæœºé‡‡æ ·å³sampler=RandomSamplerã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰æ›´ä¸ºå¤æ‚çš„é‡‡æ ·ç­–ç•¥ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªSamplerç±»ï¼Œå¹¶æŒ‡å®šDataloaderçš„samplerå‚æ•°ã€‚- num_workersï¼šåŠ è½½æ•°æ®æ—¶ä½¿ç”¨çš„å­è¿›ç¨‹æ•°é‡ã€‚ -drop_lastï¼šå½“æ•°æ®é›†ä¸­çš„æ ·æœ¬æ•°é‡ä¸èƒ½è¢«batch_sizeæ•´é™¤æ—¶ï¼Œæ˜¯å¦å¿½ç•¥æœ€åä¸€ä¸ªä¸å®Œæ•´çš„æ‰¹æ¬¡ã€‚</p><h2 id="æ•°æ®åŠ è½½æ€§èƒ½åˆ†æ">æ•°æ®åŠ è½½æ€§èƒ½åˆ†æ</h2><p>é¦–å…ˆéœ€è¦æ˜ç¡®æ•°æ®éƒ¨åˆ†çš„æ€§èƒ½ä¼˜åŒ–ç›®æ ‡æ˜¯ä¿æŒGPUæŒç»­å·¥ä½œï¼Œé¿å…å› æ•°æ®ç­‰å¾…å¯¼è‡´GPUç©ºé—²ã€‚GPUç©ºé—²å¯èƒ½ç”±å¤šç§å› ç´ å¼•èµ·ï¼Œå¦‚ä»ç¡¬ç›˜è¯»å–æ•°æ®åˆ°å†…å­˜çš„å»¶æ—¶ã€CPUé¢„å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œæˆ–æ˜¯æ•°æ®ä»CPUä¼ è¾“åˆ°GPUçš„é€Ÿåº¦æ…¢ç­‰ã€‚</p><p>æ³¨æ„<strong>åªéœ€ä¼˜åŒ–åˆ°ç¡®ä¿GPUè¿è¡Œä¸è¢«é˜»å¡</strong>ï¼Œåœ¨GPUä»»åŠ¡å·²ç»æ’é˜Ÿçš„æƒ…å†µä¸‹ï¼Œè¿‡åº¦æäº¤ä»»åŠ¡ä¸ä»…ä¸ä¼šæå‡GPUçš„è¿è¡Œé€Ÿåº¦ï¼Œè¿˜å¯èƒ½å› CPUèµ„æºäº‰å¤ºè€Œå¼•èµ·æ€§èƒ½ä¸‹é™ã€‚</p><h3 id="å……åˆ†åˆ©ç”¨cpuçš„å¤šæ ¸èµ„æº">å……åˆ†åˆ©ç”¨CPUçš„å¤šæ ¸èµ„æº</h3><p>ä½¿ç”¨<code>htop</code>å‘½ä»¤æŸ¥çœ‹CPUæ´»åŠ¨çŠ¶æ€ï¼Œå¦‚æœæœ‰â€œä¸€æ ¸å·¥ä½œï¼Œå¤šæ ¸å›´è§‚â€çš„æƒ…å†µï¼Œåˆ™è¯´æ˜CPUçš„æ ¸æ•°æ²¡æœ‰å……åˆ†åˆ©ç”¨ï¼Œå¯ä»¥é€šè¿‡å¢åŠ <code>num_workers</code>æ¥å……åˆ†åˆ©ç”¨CPUçš„å¤šæ ¸èµ„æºã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„å­è¿›ç¨‹è¿‡å¤šå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šã€I/Oé˜»å¡ç­‰å‰¯ä½œç”¨ã€‚</p><h3 id="ä¼˜åŒ–cpuä¸Šçš„è®¡ç®—è´Ÿè½½">ä¼˜åŒ–CPUä¸Šçš„è®¡ç®—è´Ÿè½½</h3><p>å¦‚æœå¼€å¯å¤šè¿›ç¨‹ä¼˜åŒ–åï¼ŒGPUä»åœ¨ç­‰å¾…æ•°æ®ï¼Œä¸”CPUä¸Šçš„æ•°æ®åŠ è½½å’Œå¤„ç†æ—¶é—´è¿‡é•¿ï¼Œç‰¹åˆ«æ˜¯htopä¸­CPUæ ¸å¿ƒéƒ½è¾¾åˆ°æ»¡è½½çŠ¶æ€ï¼Œè¿™è¯´æ˜åœ¨CPUä¸Šè¿›è¡Œçš„æ•°æ®é¢„å¤„ç†å’Œè½¬æ¢çš„è®¡ç®—é‡è¿‡é‡ï¼Œåœ¨ä¸‰æ–¹åº“çš„å®ç°ä¸­å¾ˆå¸¸è§ã€‚</p><p>è¿™æ—¶ä¹Ÿè¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œæ¯”å¦‚ï¼š -ä½¿ç”¨æ›´é«˜æ•ˆçš„ç¬¬ä¸‰æ–¹ç®—æ³•æˆ–åº“ï¼Œå¦‚ä½¿ç”¨Pillow-SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰æ›¿æ¢Pillowï¼›- æŠŠè®¡ç®—å¯†é›†å‹çš„æ•°æ®å¤„ç†è½¬ä¸ºç¦»çº¿é¢„å¤„ç†ï¼ŒæŠŠè½¬æ¢åçš„æ•°æ®å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šå¤‡ç”¨ï¼›-å¦‚æœæœ‰ä¸€äº›ç¡®å®æ— æ³•é¢„å…ˆè¿›è¡Œå¤„ç†çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘å°†è¯¥æ“ä½œä»CPUç§»è‡³è®¡ç®—èƒ½åŠ›æ›´å¼ºå¤§çš„GPUè¿›è¡Œã€‚</p><h3 id="å‡å°‘ä¸å¿…è¦çš„cpuçº¿ç¨‹">å‡å°‘ä¸å¿…è¦çš„CPUçº¿ç¨‹</h3><h4 id="numpyçš„çº¿ç¨‹æ± ">Numpyçš„çº¿ç¨‹æ± </h4><p>Numpyçš„è®¡ç®—æ“ä½œé»˜è®¤ä¼šä½¿ç”¨CPUçš„å¤šçº¿ç¨‹ï¼Œå¾€å¾€ä¼šæŠŠCPUå…¨éƒ¨æ ¸å¿ƒé›†ä¸­åœ¨è‡ªå·±èº«ä¸Šï¼ŒæŒ¤å å…¶ä»–è¿›ç¨‹çš„è®¡ç®—èµ„æºã€‚</p><p>ä¸€ç§å¸¸è§æƒ…å†µæ˜¯<strong>NumPyä¸PyTorchDataLoaderçš„æ•°æ®åŠ è½½è¿›ç¨‹å‘ç”Ÿå†²çª</strong>ã€‚DataLoaderä½¿ç”¨å¤šä¸ªè¿›ç¨‹åŠ è½½æ•°æ®ï¼Œæ¯ä¸ªæ•°æ®åŠ è½½è¿›ç¨‹åœ¨importnumpyçš„æ—¶å€™éƒ½ä¼šä¸ºNumPyç‹¬ç«‹åœ°åˆ›å»ºNï¼ˆN =CPUæ ¸æ•°ï¼‰ä¸ªçº¿ç¨‹ï¼Œè¿‡å¤šçš„CPUçº¿ç¨‹ä¼šå¯¼è‡´å†…å­˜ä½¿ç”¨å¢åŠ ã€ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å’Œèµ„æºçš„äº‰ç”¨ï¼Œä»è€Œé™ä½ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å› æ­¤æˆ‘ä»¬å»ºè®®ä½¿ç”¨NumPyè¿›è¡Œé¢„å¤„ç†çš„è¯»è€…é€‚å½“åœ°é™åˆ¶NumPyçš„çº¿ç¨‹æ•°é‡ï¼Œè¿™å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥å®ç°ï¼Œä½†è¯·æ³¨æ„è¯¥æ“ä½œä¸€å®šè¦åœ¨importnumpyä¹‹å‰ï¼Œä»£ç å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from os import environ# æ§åˆ¶NumPyåº•å±‚åº“åˆ›å»ºçš„çº¿ç¨‹æ•°é‡N_THREADS = "4"environ["OMP_NUM_THREADS"] = N_THREADSenviron["OPENBLAS_NUM_THREADS"] = N_THREADSenviron["MKL_NUM_THREADS"] = N_THREADSenviron["VECLIB_MAXIMUM_THREADS"] = N_THREADSenviron["NUMEXPR_NUM_THREADS"] = N_THREADSimport numpy as npimport pdbpdb.set_trace()x = np.zeros((1024, 1024))</code></pre> #### I/Oä¼˜åŒ–æœ‰çš„æ—¶å€™CPUæœ¬èº«è®¡ç®—è´Ÿè½½å¹¶ä¸é«˜ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†å ç”¨CPUçš„è¿›ç¨‹çŠ¶æ€ä¸ºâ€œDâ€ï¼Œè¡¨ç¤ºå¤„äºä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ï¼Œé€šå¸¸äºæŸç§ç±»å‹çš„ç³»ç»Ÿè°ƒç”¨æœ‰å…³ï¼Œå¦‚ç­‰å¾…I/Oæ“ä½œå®Œæˆã€‚<p></p><p>å¯ä»¥é€šè¿‡<code>iostat</code>å·¥å…·æ£€æµ‹ç£ç›˜çš„I/Oè´Ÿè½½ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iostat -xtck 2             # æ¯éš”2ç§’è¾“å‡ºä¸€æ¬¡ç£ç›˜I/Oè´Ÿè½½</code></pre><p></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311214416.png"></p><p>I/Oå æ¯”è¿‡é«˜ï¼Œè¯´æ˜å­˜å‚¨è®¾å¤‡æˆä¸ºç“¶é¢ˆï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹æ€è·¯ç¼“è§£ï¼š -(1)<strong>ç”¨å†…å­˜æ¥æ¢å–æ˜¾è‘—æé«˜çš„æ•°æ®åŠ è½½é€Ÿåº¦</strong>ï¼šä¾‹å¦‚ä½¿ç”¨<strong>mmap</strong>å°†æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ç›´æ¥æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡æŒ‡é’ˆè®¿é—®æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè€Œæ— é¡»æ˜¾å¼çš„I/Oæ“ä½œã€‚è¿™å‡å°‘äº†I/Oæ“ä½œçš„å¼€é”€ï¼Œæé«˜äº†æ•°æ®è®¿é—®é€Ÿåº¦ã€‚ç‰¹åˆ«æ˜¯åœ¨éšæœºè®¿é—®æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†æ—¶ï¼Œmmapè¡¨ç°å‡ºè‰²ã€‚å½“ç„¶åœ¨å†…å­˜å®¹é‡å…è®¸çš„æƒ…å†µä¸‹ç”šè‡³å¯ä»¥è€ƒè™‘ä½¿ç”¨<strong>å†…å­˜ç›˜(RAMDisk)æŠ€æœ¯</strong>ï¼Œä½¿ç”¨RAMæ¥è™šæ‹Ÿç£ç›˜ï¼Œç”¨å†…å­˜æ¥æ¢å–æ˜¾è‘—æé«˜çš„æ•°æ®åŠ è½½é€Ÿåº¦ã€‚-(2)<strong>ä¼˜åŒ–ç¡¬ç›˜çš„è¯»å†™æ¨¡å¼</strong>ï¼šåœ¨2.2å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç¡¬ç›˜çš„ä¸¤ç§è¯»å†™æ¨¡å¼ï¼Œå…¶ä¸­<strong>è¿ç»­è¯»å†™æ¨¡å¼çš„æ€§èƒ½è¿œè¶…éšæœºè¯»å†™æ¨¡å¼</strong>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ç¦»æ•£æ•°æ®åˆå¹¶åˆ°å°‘é‡çš„äºŒè¿›åˆ¶æ–‡ä»¶æˆ–TFRecordä¸­ï¼Œå°†éšæœºè¯»å†™è½¬åŒ–ä¸ºè¿ç»­è¯»å†™ï¼Œä»è€Œæˆå€åœ°æé«˜è¯»å†™æ•ˆç‡ã€‚- (3)<strong>æ›´æ¢æ›´å¿«çš„SSDç¡¬ä»¶</strong>ï¼šå¦‚NVMe SSDç­‰ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311215250.png"></p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> æ•°æ®åŠ è½½å’Œé¢„å¤„ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-å®šä½æ€§èƒ½ç“¶é¢ˆçš„å·¥å…·</title>
      <link href="/2025/03/10/da-mo-xing-dong-li-yin-qing-ding-wei-xing-neng-ping-jing-de-gong-ju/"/>
      <url>/2025/03/10/da-mo-xing-dong-li-yin-qing-ding-wei-xing-neng-ping-jing-de-gong-ju/</url>
      
        <content type="html"><![CDATA[<h2 id="æ€§èƒ½ç“¶é¢ˆå®šä½å·¥å…·">æ€§èƒ½ç“¶é¢ˆå®šä½å·¥å…·</h2><p>ä¸ºäº†ä¿è¯åˆ†æç»“æœçš„å¯é æ€§ï¼Œå¯¹æµ‹è¯•ç¯å¢ƒçš„ç¨³å®šæ€§æœ‰ä¸€å®šè¦æ±‚ã€‚ç”±äºç¨‹åºè¿è¡Œçš„è½¯ä»¶å’Œç¡¬ä»¶ç¯å¢ƒä¸­å½±å“å› ç´ è¾ƒå¤šï¼Œæœ¬èŠ‚å°†æ ¹æ®é‡è¦æ€§æ’åºï¼Œä¾æ¬¡ä»‹ç»æå‡æµ‹è¯•ç¨³å®šæ€§çš„æ–¹æ³•ã€‚</p><h3 id="å‡å°‘æ— å…³ç¨‹åºçš„å¹²æ‰°">å‡å°‘æ— å…³ç¨‹åºçš„å¹²æ‰°</h3><p>ä¸ºäº†ä¿è¯åˆ†æç»“æœçš„å¯é æ€§ï¼Œå¯¹æµ‹è¯•ç¯å¢ƒçš„ç¨³å®šæ€§æœ‰ä¸€å®šè¦æ±‚ã€‚ç”±äºç¨‹åºè¿è¡Œçš„è½¯ä»¶å’Œç¡¬ä»¶ç¯å¢ƒä¸­å½±å“å› ç´ è¾ƒå¤šï¼Œæœ¬èŠ‚å°†æ ¹æ®é‡è¦æ€§æ’åºï¼Œä¾æ¬¡ä»‹ç»æå‡æµ‹è¯•ç¨³å®šæ€§çš„æ–¹æ³•ã€‚</p><h4 id="gpuä½¿ç”¨æƒ…å†µ">GPUä½¿ç”¨æƒ…å†µ</h4><p>é¦–å…ˆå¯ä»¥é€šè¿‡<code>nvidia-smi</code>ç›‘æ§GPUä½¿ç”¨æƒ…å†µï¼ˆ<code>nvtop</code>å‘½ä»¤æä¾›äº†æ›´å‹å¥½çš„äº¤äº’ç•Œé¢ï¼Œé€‚åˆç›‘ç£è®­ç»ƒè¿‡ç¨‹ï¼‰<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310190914.png"></p><p>æŸ¥çœ‹ç›¸åº”è¿›ç¨‹çš„æ›´å¤šä¿¡æ¯ï¼š<code>ps aux | grep &lt;PID&gt;</code></p><p>æ€æ‰è¿›ç¨‹ï¼š<code>kill -9 &lt;PID&gt;</code> ï¼ˆ-9è¡¨ç¤ºå¼ºåˆ¶æ€æ­»è¿›ç¨‹ï¼‰</p><p>æœ‰æ¡ä»¶çš„è¯»è€…è¿˜åº”<strong>é¿å…åœ¨GPUçš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ä¸­ä½¿ç”¨å›¾å½¢ç•Œé¢</strong>ï¼Œå› ä¸ºå›¾å½¢ç•Œé¢ä¹Ÿä¼šå ç”¨GPUèµ„æºï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­çš„/usr/bin/Xorg.binå°±å¯¹åº”äº†å›¾å½¢ç•Œé¢è¿›ç¨‹ã€‚å¯ä»¥è€ƒè™‘åœæ­¢UNIXç³»ç»Ÿçš„å›¾å½¢ç”¨æˆ·ç•Œé¢æœåŠ¡ï¼Œä¹‹åé€šè¿‡å¦ä¸€å°æœºå™¨è¿›è¡ŒSSHè¿œç¨‹ç™»å½•ã€‚</p><h4 id="cpuä½¿ç”¨æƒ…å†µ">CPUä½¿ç”¨æƒ…å†µ</h4><p>å¯ä»¥é€šè¿‡<code>htop</code>è¿™ä¸€ç³»ç»Ÿç›‘è§†å·¥å…·æ¥æŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µã€‚</p><p>å¦‚æœå‘ç°CPUä½¿ç”¨ç‡åé«˜â€”â€”æ¯”å¦‚å¤§éƒ¨åˆ†CPUæ ¸å¿ƒçš„å ç”¨ç‡é•¿æ—¶é—´åœ¨60%ï½70%ä»¥ä¸Šï¼Œè¿˜å¯ä»¥é€šè¿‡è¿›ç¨‹åˆ—è¡¨æ¥æŸ¥è¯¢ä½¿ç”¨CPUæœ€å¤šçš„è¿›ç¨‹ï¼Œå¹¶å†³å®šæ˜¯å¦å°†å…¶ç»ˆæ­¢ã€‚</p><h3 id="æå‡pytorchç¨‹åºçš„å¯é‡å¤æ€§">æå‡PyTorchç¨‹åºçš„å¯é‡å¤æ€§</h3><p>å‰é¢ç€é‡è®¨è®ºäº†å¦‚ä½•é¿å…å…¶ä»–ç¨‹åºçš„å¹²æ‰°ï¼Œå°½å¯èƒ½è®©ç›®æ ‡ç¨‹åºç‹¬å è®¡ç®—èµ„æºï¼Œé™ä½æ€§èƒ½æ³¢åŠ¨ã€‚ä½†æ˜¯ç¨‹åºå†…éƒ¨ä¹Ÿå­˜åœ¨ç€ä¸€å®šçš„éšæœºæ€§ï¼Œå¦‚æ¨¡å‹æƒé‡çš„éšæœºåˆå§‹åŒ–/Dropoutå±‚éšæœºå¤±æ´»ï¼Œåœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šä¸“é—¨ä»‹ç»çº¦æŸç¨‹åºéšæœºæ€§çš„æ–¹æ³•ã€‚</p><p>åœ¨Pythonç”Ÿæ€ç³»ç»Ÿä¸­ç¼ºä¹ä¸€ä¸ªç»Ÿä¸€çš„éšæœºæ•°ç”Ÿæˆæ ‡å‡†åº“ã€‚NumPyã€PyTorchå’ŒTensorFlowç­‰åº“åœ¨å¤„ç†éšæœºæ•°ç”Ÿæˆæ—¶ï¼Œå„è‡ªæœ‰ä¸åŒçš„å®ç°å’Œä¼˜åŒ–æ–¹å¼ï¼Œå› æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ–¹æ³•å¯ä»¥é›†ä¸­æ§åˆ¶Pythonç¨‹åºä¸­æ‰€æœ‰åº“çš„éšæœºæ•°ç§å­ï¼Œåœ¨å†™ç¨‹åºæ—¶ï¼Œéœ€è¦è€ƒè™‘ä¸åŒåº“çš„éšæœºæ•°ç”Ÿæˆæ–¹å¼ã€‚</p><p>è¿™é‡Œåªä»‹ç»Pytorchã€NumPyå’Œpythonæ ‡å‡†åº“randomçš„éšæœºæ•°ç§å­è®¾ç½®æ–¹æ³•ã€‚</p><h4 id="è®¾ç½®pytorchéšæœºæ•°ç§å­">è®¾ç½®PyTorchéšæœºæ•°ç§å­</h4><p>PyTorchæä¾›äº†ä¸€ä¸ª<code>torch.manual_seed()</code>æ¥å£å¯ä»¥â€œä¸€é”®è®¾ç½®â€æ‰€æœ‰åç«¯çš„éšæœºæ•°ç”Ÿæˆç§å­ï¼Œä»¥ç¡®ä¿æ¯æ¬¡è¿è¡Œä»£ç æ—¶ï¼Œç”Ÿæˆçš„éšæœºæ•°åºåˆ—éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchdef generate_random_seq(device):    return torch.rand((3, 3), device=device)print(    f"""ä¸è®¾ç½®éšæœºç§å­æ—¶ï¼Œæ¯æ¬¡è¿è¡Œç”Ÿæˆçš„åºåˆ—éƒ½æ˜¯ä¸åŒçš„CPU: {generate_random_seq('cpu')}CUDA: {generate_random_seq('cuda')}""")# ä¸ºæ‰€æœ‰PyTorchåç«¯è®¾ç½®ç”Ÿæˆéšæœºæ•°çš„ç§å­seed = 32torch.manual_seed(seed)print(    f"""è®¾ç½®éšæœºç§å­åï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šç”Ÿæˆç›¸åŒçš„åºåˆ—CPU: {generate_random_seq('cpu')}CUDA: {generate_random_seq('cuda')}""")</code></pre><p></p><h4 id="è®¾ç½®numpyéšæœºæ•°ç§å­">è®¾ç½®NumPyéšæœºæ•°ç§å­</h4><p>numpyæä¾›äº†<code>numpy.random.seed()</code>æ¥å£ï¼Œå¯ä»¥è®¾ç½®NumPyçš„éšæœºæ•°ç§å­ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import numpy as npdef generate_random_seq():    return ", ".join([f"{np.random.random():.2f}" for _ in range(10)])print(f"ä¸è®¾ç½®éšæœºç§å­æ—¶ï¼Œæ¯æ¬¡è¿è¡Œç”Ÿæˆçš„åºåˆ—éƒ½æ˜¯ä¸åŒçš„: {generate_random_seq()}")np.random.seed(32)print(f"è®¾ç½®éšæœºç§å­åï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šç”Ÿæˆç›¸åŒçš„åºåˆ—: {generate_random_seq()}")</code></pre><h4 id="è®¾ç½®pythonéšæœºæ•°ç§å­">è®¾ç½®pythonéšæœºæ•°ç§å­</h4><p>pythonçš„randomæ¨¡å—æä¾›äº†<code>random.seed()</code>æ¥å£ï¼Œå¯ä»¥è®¾ç½®pythonæ ‡å‡†åº“çš„éšæœºæ•°ç§å­ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import osimport randomdef generate_random_seq():    return ", ".join([f"{random.random():.2f}" for _ in range(10)])print(f"ä¸è®¾ç½®éšæœºç§å­æ—¶ï¼Œæ¯æ¬¡è¿è¡Œç”Ÿæˆçš„åºåˆ—éƒ½æ˜¯ä¸åŒçš„: {generate_random_seq()}")seed = 32random.seed(seed)print(f"è®¾ç½®éšæœºç§å­åï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šç”Ÿæˆç›¸åŒçš„åºåˆ—: {generate_random_seq()}")</code></pre><h4 id="å…¶ä»–éšæœºæ€§å› ç´ ">å…¶ä»–éšæœºæ€§å› ç´ </h4><p>è™½ç„¶è®¾ç½®éšæœºæ•°ç§å­èƒ½æ§åˆ¶ä¸€éƒ¨åˆ†Pythonä»£ç çš„éšæœºæ€§ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤éšæœºæ€§ã€‚å› ä¸ºéšæœºæ€§çš„æ¥æºå¾ˆå¤šï¼Œæ¯”å¦‚<strong>å“ˆå¸Œç®—æ³•å°±æ˜¯å…¶ä¸­ä¹‹ä¸€</strong>ã€‚å¦‚æœç”¨åˆ°äº†åŸºäºå“ˆå¸Œç®—æ³•çš„å¦‚hash()å‡½æ•°ï¼Œæˆ–è€…setçš„éå†ï¼Œä¸ºäº†ç¡®ä¿ç¨‹åºçš„å¯å¤ç°æ€§ï¼Œå°±éœ€è¦<strong>è®¾ç½®ç¯å¢ƒå˜é‡PYTHONHASHSEED</strong>ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python -c 'print(hash("hello"))' # è·‘å¤šæ¬¡ç»“æœæ˜¯ä¸ä¸€æ ·çš„PYTHONHASHSEED=0 python -c 'print(hash("hello"))' #è·‘å¤šæ¬¡ç»“æœæ˜¯ä¸€æ ·çš„</code></pre><p>ç”šè‡³æœ‰ä¸€äº›éšæœºæ€§æ˜¯æ— æ³•æ§åˆ¶çš„ï¼Œä¾‹å¦‚ä½¿ç”¨<strong>Pythonçš„globæ¨¡å—è·å–çš„æ–‡ä»¶åˆ—è¡¨é¡ºåºå¯èƒ½æ˜¯ä¸ç¡®å®šçš„</strong>ï¼Œè¿™ä¸ªé¡ºåºä¼šå—åˆ°æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿç±»å‹ç­‰å¤šç§å› ç´ çš„å½±å“ã€‚å¦‚æœåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éœ€è¦å¯å¤ç°æ€§ï¼Œè¦æ±‚æ–‡ä»¶ä»¥ç‰¹å®šé¡ºåºå‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦<strong>åœ¨è·å–æ–‡ä»¶åˆ—è¡¨åï¼Œæ‰‹åŠ¨å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œæ’åº</strong>ã€‚</p><h4 id="çº¦æŸgpuç®—å­çš„éšæœºæ€§">çº¦æŸGPUç®—å­çš„éšæœºæ€§</h4><p>GPUçš„è®¡ç®—ç‰¹ç‚¹ä¸CPUå­˜åœ¨ä¸€äº›å·®åˆ«ï¼Œè¿™å°¤å…¶ä½“ç°åœ¨æ•°å€¼ç²¾åº¦æ–¹é¢ã€‚</p><p>é¦–å…ˆåœ¨ç¡¬ä»¶åº•å±‚ï¼Œæµ®ç‚¹è¿ç®—çš„æœºåˆ¶åŠå…¶ç¡¬ä»¶å®ç°å¯èƒ½å¯¼è‡´ç»“åˆå¾‹åœ¨æŸäº›æƒ…å†µä¸‹ä¸é€‚ç”¨ï¼Œç”±äºå…¶å¹¶è¡Œå¤„ç†çš„ç‰¹æ€§ï¼Œè¿›è¡Œå¤§é‡çš„æ•°å€¼ç´¯åŠ æ—¶ï¼Œç´¯åŠ çš„é¡ºåºå¯èƒ½ä¸å›ºå®šï¼Œä»è€Œå¯èƒ½è¿›ä¸€æ­¥æ”¾å¤§è¿™ç§æ•°å€¼å·®å¼‚ã€‚</p><p>å…¶æ¬¡ï¼ŒNVIDIAæä¾›çš„cuDNNåŠ é€Ÿåº“è¿˜åœ¨è½¯ä»¶å±‚é¢ä¸Šè¿›ä¸€æ­¥åŠ é‡äº†æ•°å€¼çš„ä¸ç¡®å®šæ€§ã€‚ä»¥å·ç§¯ç®—æ³•ä¸ºä¾‹ï¼ŒcuDNNæä¾›äº†ä¸åŒç‰ˆæœ¬çš„å·ç§¯å®ç°æ–¹æ³•ï¼Œä¼šæ ¹æ®æƒ…å†µä¸´æ—¶é€‰æ‹©å…¶ä¸­æ€§èƒ½æœ€é«˜çš„ä¸€ç§è¿›è¡Œå·ç§¯è®¡ç®—ï¼Œè¿™å°±å¯¼è‡´å…¶è®¡ç®—ç»“æœæ›´åŠ çš„ä¸å¯æ§ã€‚é™¤æ­¤ä»¥å¤–ï¼Œå¦‚æœç®—å­å®ç°è¿‡ç¨‹ä¸­ç”¨åˆ°äº†éšæœºé‡‡æ ·çš„ç®—æ³•ï¼Œé‚£ä¹ˆé‡‡æ ·çš„éšæœºæ€§åŒæ ·ä¹Ÿä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ã€‚</p><p>ä¸è¿‡å¯¹äºcuDNNç›¸å…³çš„æ“ä½œï¼ŒPyTorchè¿˜æ˜¯æä¾›äº†<code>torch.backends.cudnn.deterministic</code>å’Œ<code>torch.backends.cudnn.benchmark</code>æ¥å£ï¼ŒäºŒè€…ç»“åˆä½¿ç”¨å¯ä»¥æœ€å¤§ç¨‹åº¦æé«˜GPUè®¡ç®—ç»“æœçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch.backends.cudnn.deterministic = True # ç¡®ä¿ç®—å­ä½¿ç”¨ç¡®å®šæ€§ç®—æ³•torch.backends.cudnn.benchmark = False # ç¦ç”¨è‡ªåŠ¨ä¼˜åŒ–ï¼ˆå¦‚å·ç§¯ç®—æ³•ï¼‰</code></pre><p>ä½†æ˜¯è¿™ä¸¤ä¸ªæ¥å£éƒ½å¯èƒ½å¯¼è‡´GPUè®¡ç®—æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥å°½é‡åªåœ¨éœ€è¦è°ƒè¯•ç¨‹åºæˆ–è€…è¿›è¡Œæ€§èƒ½åˆ†ææ—¶å¼€å¯ã€‚</p><h4 id="å®Œæ•´çš„éšæœºæ€§çº¦æŸè„šæœ¬">å®Œæ•´çš„éšæœºæ€§çº¦æŸè„šæœ¬</h4><p>ä½¿ç”¨ä»¥ä¸‹è„šæœ¬å¯ä»¥ä¸€é”®è®¾ç½®å‰æ–‡ä»‹ç»çš„æ‰€æœ‰éšæœºç§å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">def set_seed(seed: int = 37) -&gt; None:    np.random.seed(seed)    random.seed(seed)    torch.manual_seed(seed)  # é€‚ç”¨äºæ‰€æœ‰PyTorchåç«¯ï¼ŒåŒ…æ‹¬CPUå’Œæ‰€æœ‰CUDAè®¾å¤‡    torch.backends.cudnn.deterministic = True    torch.backends.cudnn.benchmark = False    os.environ["PYTHONHASHSEED"] = str(seed)    print(f"è®¾ç½®éšæœºæ•°ç§å­ä¸º{seed}")</code></pre><p></p><h3 id="æ§åˆ¶gpué¢‘ç‡">æ§åˆ¶GPUé¢‘ç‡</h3><p>GPUåœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ä¼šæ ¹æ®èŠ¯ç‰‡çŠ¶æ€åŠ¨æ€è°ƒæ•´æ˜¾å­˜é¢‘ç‡å’ŒåŸºç¡€é¢‘ç‡æ¥è‡ªåŠ¨å¹³è¡¡æ€§èƒ½å’ŒåŠŸè€—ã€‚å¯¹äºæ€§èƒ½åˆ†æè€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦<strong>GPUå§‹ç»ˆä¿æŒåœ¨ç›¸åŒçš„é¢‘ç‡è¿›è¡Œæµ‹è¯•ï¼Œä»è€Œé™ä½æ•°æ®æ³¢åŠ¨</strong>ã€‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤æ¥é”å®šGPUçš„é¢‘ç‡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># æŸ¥è¯¢ GPUæ˜¾å­˜é¢‘ç‡ã€æµå¤„ç†å™¨é¢‘ç‡ã€å›¾å½¢é¢‘ç‡nvidia-smi --query-gpu=pstate,clocks.mem,clocks.sm,clocks.gr --format=csv# clocks.current.memory [MHz], clocks.current.sm [MHz], clocks.current.graphics [MHz]# 9751 MHz, 1695 MHz, 1695 MHz# æŸ¥è¯¢GPUæ”¯æŒçš„clockç»„åˆnvidia-smi --query-supported-clocks=gpu_name,mem,gr --format=csv# è®¾ç½®persistent modeï¼Œå¯ä»¥å‡å°‘GPUåˆå§‹åŒ–å»¶è¿Ÿsudo nvidia-smi -pm 1# å›ºå®šGPUæ—¶é’Ÿnvidia-smi -ac 9751,1530 # &lt;memory, graphics&gt;</code></pre><p>æ³¨æ„AIGPUå¦‚V100ã€A100ç­‰æ˜¯æ”¯æŒé”é¢‘åŠŸèƒ½çš„ï¼Œä½†ä¸€äº›å®¶ç”¨çº§åˆ«GPUå¯èƒ½ä¸æ”¯æŒé”é¢‘ï¼ˆå¦‚RTX3090ã€4090ç³»åˆ—ï¼‰â€‹ï¼Œè¿™æ—¶é”é¢‘æŒ‡ä»¤ä¼šæ˜¾ç¤ºä¸‹è¿°ä¿¡æ¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Setting applications clocks is not supported for GPU 00000000:1A:00.0.Treating as warning and moving on.</code></pre><h3 id="æ§åˆ¶cpuçš„çŠ¶æ€å’Œé¢‘ç‡">æ§åˆ¶CPUçš„çŠ¶æ€å’Œé¢‘ç‡</h3><p>ä¸€ä¸ªCPUçš„æ€§èƒ½çŠ¶æ€è¢«åˆ’åˆ†ä¸ºä¸åŒçš„ç­‰çº§ï¼Œç§°ä¸ºæ€§èƒ½çŠ¶æ€(Performance state,P-state)ã€‚æ¯ä¸ªP-stateå¯¹åº”äºä¸€ç»„ç‰¹å®šçš„å·¥ä½œé¢‘ç‡å’Œç”µå‹ã€‚</p><p>åœ¨è¿›è¡Œæ€§èƒ½æµ‹é‡æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å›ºå®šP-stateå’ŒCPUé¢‘ç‡ï¼Œç¡®ä¿åœ¨æ¯æ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•æ—¶å¤„ç†å™¨ä»¥ç›¸åŒçš„æ€§èƒ½çŠ¶æ€è¿è¡Œã€‚</p><p>é¦–å…ˆéœ€è¦å®‰è£…<code>cpufrequtils</code>è½¯ä»¶åŒ…ï¼Œå¹¶é€šè¿‡è®¾ç½®æœ€å¤§ã€æœ€å°é¢‘ç‡æ¥é—´æ¥æ§åˆ¶ä½CPUçš„çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo apt-get install cpufrequtils# è®¾ç½®æœ€å¤§ã€æœ€å°é¢‘ç‡sudo cpufreq-set -r -g performance # è®¾ç½®ä¸ºæ€§èƒ½æ¨¡å¼ï¼Œ -r è¡¨ç¤ºæ‰€æœ‰CPUæ ¸å¿ƒ -g è¡¨ç¤ºæ€§èƒ½æ¨¡å¼sudo cpufreq-set -r -d 2Ghz # è®¾ç½®æœ€å°é¢‘ç‡ä¸º2GHzsudo cpufreq-set -r -u 2Ghz # è®¾ç½®æœ€å¤§é¢‘ç‡ä¸º2GHz</code></pre>ç„¶åå¯ä»¥æŸ¥è¯¢å½“å‰CPUçš„æ€§èƒ½ä¿¡æ¯å’Œå·¥ä½œçŠ¶æ€ï¼Œæ¥éªŒè¯æ”¹åŠ¨æ˜¯å¦ç”Ÿæ•ˆï¼Œä»£ç å¦‚ä¸‹ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># æŸ¥è¯¢cpufreq-info# æˆ–è€…cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freqcat /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freqcat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq</code></pre><p></p><p>å¦å¤–ï¼Œè¿˜å¯ä»¥åœ¨é©±åŠ¨æˆ–BIOSå±‚é¢è¿›ä¸€æ­¥å…³é—­ä¸€äº›å¯¹æ€§èƒ½æœ‰å½±å“çš„CPUç‰¹æ€§ï¼Œä¾‹å¦‚ï¼š-è®¾ç½®max_cstateä¸º1æ¥é˜»æ­¢CPUè¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­C-stateæ˜¯æŒ‡å¤„ç†å™¨çš„ä¸åŒåŠŸè€—çŠ¶æ€ï¼Œå…¶ä¸­C0è¡¨ç¤ºå¤„ç†å™¨å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œè€ŒC1ã€C2ã€C3ç­‰è¡¨ç¤ºä¸åŒçš„ç¡çœ çŠ¶æ€ï¼ŒåŠŸè€—é€æ¸é™ä½ã€‚- å¯ä»¥å…³é—­è¶…çº¿ç¨‹å’Œç¿é¢‘ç­‰é«˜çº§åŠŸèƒ½ã€‚ </p><pre class="line-numbers language-none"><code class="language-none"># æŸ¥è¯¢C_statecat /sys/module/intel_idle/parameters/max_cstate# æŸ¥è¯¢turboçŠ¶æ€cat /sys/devices/system/cpu/intel_pstate/no_turbo</code></pre><p></p><h2 id="ç²¾ç¡®æµ‹é‡ç¨‹åºè¿è¡Œæ—¶é—´">ç²¾ç¡®æµ‹é‡ç¨‹åºè¿è¡Œæ—¶é—´</h2><h3 id="è®¡é‡cpuç¨‹åºçš„è¿è¡Œæ—¶é—´--timeæ¨¡å—">è®¡é‡CPUç¨‹åºçš„è¿è¡Œæ—¶é—´--timeæ¨¡å—</h3><p>time.time()æˆ–è€…time.perf_counter()è®¡ç®—ä¸¤ä¸ªæ—¶é—´æˆ³çš„é—´éš”ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import timestart = time.perf_counter()# ç¨‹åºè¿è¡Œend = time.perf_counter()print(f"ç¨‹åºè¿è¡Œæ—¶é—´: {end - start}ç§’")</code></pre><h3 id="warmupå’Œå¤šæ¬¡è¿è¡Œå–å¹³å‡">warmupå’Œå¤šæ¬¡è¿è¡Œå–å¹³å‡</h3><p>è®¡ç®—æœºç¨‹åºå…·æœ‰<strong>å†·å¯åŠ¨æ•ˆåº”</strong>ã€‚å…·ä½“åˆ°è®­ç»ƒè¿‡ç¨‹æ¥è¯´ï¼Œä¸€èˆ¬æœ€åˆå‡ è½®è®­ç»ƒçš„å•è½®è€—æ—¶è¦æ˜¾è‘—å¤šäºå¹³ç¨³è¿è¡Œæ—¶æ¯è½®çš„è€—æ—¶ï¼Œè¿™ä¸»è¦æ˜¯è®¾å¤‡åˆå§‹åŒ–ã€ç¼“å­˜å‘½ä¸­ã€ä»£ç åˆæ¬¡åŠ è½½ç­‰è¯¸å¤šå› ç´ å¯¼è‡´çš„ã€‚å› æ­¤å¦‚æœå¸Œæœ›å¾—åˆ°ä¸€è‡´æ€§æ›´å¼ºçš„æ€§èƒ½æµ‹è¯•ç»“æœï¼Œå°±éœ€è¦åœ¨æ­£å¼æµ‹é‡å‰å…ˆè¿›è¡Œå‡ è½®çƒ­èº«(warmup)ï¼Œä»è€Œè®©ç³»ç»Ÿè¾¾åˆ°ç¨³å®šçŠ¶æ€ã€‚é™¤äº†ç¨‹åºé¢„çƒ­ä»¥å¤–ï¼Œè¿˜åº”è¯¥æµ‹è¯•å¤šè½®è®­ç»ƒå–å¹³å‡å€¼ï¼Œè¿›ä¸€æ­¥å¢åŠ æµ‹è¯•ç»“æœçš„ç¨³å®šæ€§ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import timeimport torchdef my_work():    # éœ€è¦è®¡æ—¶çš„æ“ä½œ    sz = 64    x = torch.randn((sz, sz))if __name__ == "__main__":    # çƒ­èº«    num_warmup = 5    for i in range(num_warmup):        start = time.perf_counter()        my_work()        end = time.perf_counter()        t = end - start        print(f"çƒ­èº«#{i}: {t * 1000 :.6f}ms")    # å¤šæ¬¡è¿è¡Œå–å¹³å‡    repeat = 30    start = time.perf_counter()    for _ in range(repeat):        my_work()    end = time.perf_counter()    t = (end - start) / repeat    print(f"{repeat}æ¬¡å–å¹³å‡: {t * 1000:.6f}ms")# çƒ­èº«#0: 0.317707ms# çƒ­èº«#1: 0.023586ms# çƒ­èº«#2: 0.016913ms# çƒ­èº«#3: 0.016409ms# çƒ­èº«#4: 0.015868ms# 30æ¬¡å–å¹³å‡: 0.014164ms</code></pre><h3 id="åˆ©ç”¨cpugpuåŒæ­¥è®¡é‡gpuçš„è¿è¡Œæ—¶é—´--torch.cuda.synchronize">åˆ©ç”¨CPU/GPUåŒæ­¥è®¡é‡GPUçš„è¿è¡Œæ—¶é—´--torch.cuda.synchronize()</h3><p>å¦‚<a href="https://baoblei.github.io/2025/03/07/da-mo-xing-dong-li-yin-qing-shen-du-xue-xi-bi-bei-de-pytorch">å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-PyTorch</a>æ‰€è¿°ï¼ŒCPUå’ŒGPUä¹‹é—´çš„æ“ä½œæ˜¯å¼‚æ­¥çš„ã€‚ç”±äºPythonè§£é‡Šå™¨åœ¨CPUä¸Šè¿è¡Œï¼Œä½¿ç”¨time.perf_counter()è®°å½•çš„æ—¶é—´å®é™…ä¸Šæ˜¯CPUçš„æ—¶é—´æˆ³ã€‚è‹¥CPUæ²¡æœ‰ç­‰å¾…GPUä»»åŠ¡å®Œæˆå°±è®°å½•æ—¶é—´çš„è¯ï¼Œæµ‹é‡ç»“æœå°±æ˜¯é”™çš„ï¼Œé€šå¸¸ä¼šæ¯”å®é™…ç¨‹åºè¿è¡Œæ—¶é—´çŸ­å¾ˆå¤šã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310224253.png"></p><p>å› æ­¤å¿…é¡»è®©CPUå…ˆç­‰å¾…GPUè¿è¡Œå®Œæˆï¼Œä¹Ÿå°±æ˜¯<code>è°ƒç”¨torch.cuda.synchronize()</code>ç»“æŸå†è®°å½•æ—¶é—´æˆ³ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import timeimport torchsz = 512N = 10shape = (sz, sz, sz)x = torch.randn(dtype=torch.float, size=shape, device="cuda")y = torch.randn(dtype=torch.float, size=shape, device="cuda")torch.cuda.synchronize()start = time.perf_counter()for _ in range(N):    z = x * y# åŒæ­¥torch.cuda.synchronize()end = time.perf_counter()print(f"{N}æ¬¡è¿è¡Œå–å¹³å‡: {(end - start) / N}s")</code></pre><h3 id="ç²¾ç¡®è®¡é‡gpuçš„è¿è¡Œæ—¶é—´--torch.cuda.event">ç²¾ç¡®è®¡é‡GPUçš„è¿è¡Œæ—¶é—´--torch.cuda.Event()</h3><p>è”åˆä½¿ç”¨torch.cuda.synchronize()å’Œtime.perf_counter()æ¥è®¡é‡GPUç¨‹åºçš„è¿è¡Œæ—¶é—´ä¼šå› ä¸ºåŒæ­¥è¿‡ç¨‹äº§ç”Ÿä¸€å®šå»¶è¿Ÿï¼Œæ‰€ä»¥ä½¿ç”¨ä¸Šé¢çš„CPUæ—¶é—´æˆ³é—´éš”æµ‹é‡çš„GPUè€—æ—¶æ˜¯è¦ç•¥é•¿äºGPUç®—å­å®é™…è¿è¡Œæ—¶é—´çš„ã€‚</p><p>å¯ä»¥é€šè¿‡å»ºç«‹<code>torch.cuda.Event()</code>å¯¹è±¡ï¼Œéšååˆ©ç”¨å…¶record()æ–¹æ³•åœ¨GPUé˜Ÿåˆ—ä¸­è¿›è¡Œæ ‡è®°ï¼Œæœ€åé€šè¿‡ä¸¤ä¸ªCUDAEventçš„æ—¶é—´é—´éš”æ¥æµ‹é‡GPUè¿è¡Œæ—¶é—´ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchsz = 512shape = (sz, sz, sz)x = torch.randn(dtype=torch.float, size=shape, device="cuda")y = torch.randn(dtype=torch.float, size=shape, device="cuda")start = torch.cuda.Event(enable_timing=True) # -enable_timing=True è¡¨ç¤ºå¯ç”¨æ—¶é—´æµ‹é‡end = torch.cuda.Event(enable_timing=True)start.record()z = x + yend.record()print(f"ç”¨æ—¶{start.elapsed_time(end)}ms")</code></pre><p></p><h2 id="pytorchçš„æ€§èƒ½åˆ†æå™¨--torch.profiler">PyTorchçš„æ€§èƒ½åˆ†æå™¨--torch.profiler</h2><p>PyTorchåŸç”Ÿçš„torch.profileråœ¨ä¸PerfettoUIè¿›è¡Œè”ç”¨ä¹‹åèƒ½å¤Ÿå¾ˆå¥½åœ°å…¼é¡¾ä½¿ç”¨çš„æ˜“ç”¨æ€§å’Œæ€§èƒ½æŒ‡æ ‡çš„ä¿¡æ¯é‡ã€‚</p><h3 id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torchvision.models as modelsfrom torch.profiler import profile, record_function, ProfilerActivitymodel = models.resnet18().cuda()inputs = torch.randn(5, 3, 224, 224, device="cuda")with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA]) as prof: # æŒ‡å®šåˆ†æCPUå’ŒGPU    with record_function("model_inference"): # å¯¹ä¸åŒä»£ç æ®µè¿›è¡Œæ ‡è®°        model(inputs)print(prof.key_averages().table(sort_by="cuda_time_total", row_limit=10)) # æ‰“å°åˆ†æç»“æœ</code></pre><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310231130.png"></p><h3 id="æ˜¾å­˜åˆ†æ">æ˜¾å­˜åˆ†æ</h3><p>torch.profilerå¯ä»¥è¿½è¸ªæ¯ä¸ªç®—å­åœ¨æ‰§è¡Œæ—¶åˆ†é…çš„æ˜¾å­˜å¤§å°ï¼Œå¯ä»¥é—´æ¥ç”¨æ¥å®šä½æ˜¾å­˜å³°å€¼å‡ºç°çš„ä½ç½®ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torchvision.models as modelsfrom torch.profiler import profile, record_function, ProfilerActivitymodel = models.resnet18().cuda()inputs = torch.randn(5, 3, 224, 224, device="cuda")with profile(activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA], profile_memory=True) as prof:    model(inputs)print(prof.key_averages().table(sort_by="self_cuda_memory_usage", row_limit=5))</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310231453.png"><p></p><p>ä¸è¿‡è¿™é‡Œçš„ä¿¡æ¯æ¯”è¾ƒç¬¼ç»Ÿï¼Œåªèƒ½å¯¹æ¯ä¸ªç®—å­çš„å†…å­˜å ç”¨æœ‰ä¸ªå¤§è‡´äº†è§£ï¼Œå¦‚æœæƒ³è¦ä¸“é—¨å¯¹æ˜¾å­˜è¿›è¡Œä¼˜åŒ–ï¼Œåˆ™æ¨èä½¿ç”¨PyTorchåŸç”Ÿçš„æ˜¾å­˜å·¥å…·torch.cuda.memory._record_memory_history()ã€‚(åç»­è®²è§£)</p><h3 id="å¯è§†åŒ–æ€§èƒ½å›¾è°±">å¯è§†åŒ–æ€§èƒ½å›¾è°±</h3><p>å¯¼å‡ºç”¨äºå¯è§†åŒ–åˆ†æçš„æ–‡ä»¶ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">prof.export_chrome_trace("profiler_export_trace.json")</code></pre> å¯¼å‡ºçš„æ–‡ä»¶å¯ä»¥é€šè¿‡PerfettoUIæ‰“å¼€æµè§ˆï¼šé€šè¿‡åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<a href="https://ui.perfetto.dev/">Perfetto UI</a>ï¼Œé€‰æ‹©â€œOpenTraceâ€ï¼Œç„¶åé€‰æ‹©å¯¼å‡ºçš„æ–‡ä»¶å³å¯ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310231914.png"><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310232334.png"><p></p><h3 id="å¦‚ä½•å®šä½æ€§èƒ½ç“¶é¢ˆ">å¦‚ä½•å®šä½æ€§èƒ½ç“¶é¢ˆ</h3><p>PyTorchProfilerè¿˜å¯ä»¥è®°å½•è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¯¹äºå°†é—®é¢˜å®šä½å›Pythonä»£ç éå¸¸æœ‰å¸®åŠ©ã€‚å¯¹äºç»å¤§å¤šæ•°åœºæ™¯è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ ‡å‡†æµç¨‹æ¥æŸ¥æ‰¾æ€§èƒ½ç“¶é¢ˆï¼š-<strong>(1)è§‚å¯ŸGPUé˜Ÿåˆ—ï¼Œå¦‚æœGPUé˜Ÿåˆ—æ•´ä½“éƒ½éå¸¸ç¨€ç–ï¼Œé‚£ä¹ˆæ€§èƒ½ç“¶é¢ˆåœ¨CPUä¸Šã€‚</strong>-<strong>(2)è§‚å¯ŸGPUé˜Ÿåˆ—ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—å¯†é›†ï¼Œè€Œæ²¡æœ‰æ˜¾è‘—ç©ºç™½åŒºåŸŸï¼Œè¯´æ˜GPUæ»¡è½½ï¼Œé‚£ä¹ˆæ€§èƒ½ç“¶é¢ˆåœ¨GPUç®—å­ã€‚</strong>-<strong>(3)è§‚å¯ŸGPUé˜Ÿåˆ—ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—å¯†é›†ï¼ŒåŒæ—¶å­˜åœ¨GPUç©ºé—²åŒºåŸŸï¼Œåˆ™éœ€è¦æ”¾å¤§ç©ºé—²åŒºåŸŸè¿›è¡Œè¿›ä¸€æ­¥è§‚å¯Ÿã€‚</strong>-<strong>(4)è§‚å¯ŸGPUç©ºé—²åŒºåŸŸï¼ŒæŸ¥çœ‹ç©ºé—²å‰åGPUä»»åŠ¡ä»¥åŠCPUä»»åŠ¡è¯¦æƒ…ï¼Œå¹¶ä»¥æ­¤æ¨æ–­å¯¼è‡´GPUé˜Ÿåˆ—é˜»å¡çš„åŸå› ã€‚</strong></p><blockquote><p>å®šä½ç“¶é¢ˆçš„ç¤ºä¾‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310232649.png"></p></blockquote><h2 id="gpuä¸“ä¸šåˆ†æå·¥å…·">GPUä¸“ä¸šåˆ†æå·¥å…·</h2><p>å¯¹äºç»å¤§å¤šæ•°æ€§èƒ½åˆ†æçš„åœºæ™¯ä½¿ç”¨PyTorchProfilerå°±ç»°ç»°æœ‰ä½™äº†ï¼Œç„¶è€Œå½“éœ€è¦è¿›è¡Œæ›´é«˜çº§çš„ä¼˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æ‹¿åˆ°æ›´åŠ æ·±å…¥åº•å±‚çš„æ€§èƒ½æ•°æ®ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è½¬å‘NVIDIAå®˜æ–¹æä¾›çš„æ›´ä¸ºä¸“ä¸šçš„æ€§èƒ½åˆ†æå·¥å…·ã€‚å› æ­¤åœ¨æœ¬èŠ‚æˆ‘ä»¬é‡ç‚¹ä»‹ç»NsightSystemså’ŒNsight Computeä¸¤ç§ä¸“ä¸šåˆ†æå·¥å…·ã€‚</p><h3 id="nsight-systems"><a href="https://developer.nvidia.com/nsight-systems">NsightSystems</a></h3><ul><li>NsightSystemsæ˜¯<strong>éä¾µå…¥å¼çš„æ€§èƒ½åˆ†æå·¥å…·</strong>ï¼Œä¸éœ€è¦å¯¹ä»£ç è¿›è¡Œä»»ä½•æ”¹åŠ¨ï¼›PyTorchProfileråˆ™éœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ torch.profilerç­‰å‡½æ•°ã€‚</li><li>Nsight Systemsèƒ½å¤Ÿæ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿã€CUDAAPIã€é€šä¿¡ç­‰å±‚é¢çš„ä¿¡æ¯ï¼Œå¯¹å¤šGPUæ€§èƒ½åˆ†æçš„æ”¯æŒä¹Ÿæ›´åŠ å®Œå–„ã€‚</li></ul><h3 id="nsight-compute"><a href="https://developer.nvidia.com/nsight-compute">NsightCompute</a></h3><p>Nsight Systemsæ˜¯å¯¹PyTorchProfilerçš„è¡¥å……ï¼ŒäºŒè€…è¿˜æ˜¯å±äºç›¸åŒå±‚çº§çš„åˆ†æå·¥å…·ï¼›<strong>NsightComputeåˆ™æ˜¯å®Œå…¨ä¸“æ³¨äºåº•å±‚GPUå†…æ ¸å‡½æ•°</strong>çš„æ€§èƒ½æŒ‡æ ‡çš„åˆ†æå·¥å…·ã€‚NsightComputeæä¾›çš„ä¿¡æ¯å¤šè€Œåºæ‚ï¼ŒåŒæ—¶æ”¶é›†æ€§èƒ½ä¿¡æ¯çš„é€Ÿåº¦éå¸¸æ…¢ï¼Œæ‰€ä»¥å¾€å¾€åªç”¨æ¥åˆ†æè¾ƒå°çš„ä»£ç æ®µã€‚å…·ä½“åˆ°è®­ç»ƒè¿‡ç¨‹æ¥è¯´ï¼Œä¸€èˆ¬åªæœ‰åœ¨ä¼˜åŒ–CUDAç®—å­æ—¶æ‰ä¼šè€ƒè™‘ä½¿ç”¨NsightComputeç”¨äºå®šä½ç®—å­å†…éƒ¨çš„æ€§èƒ½ç“¶é¢ˆã€‚</p><p>æˆ‘ä»¬ç”¨NsightComputeåˆ†æä¸€ä¸ªå®Œæ•´æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ï¼Œå°½ç®¡å®ƒå¤šç”¨äºåˆ†æå•ä¸ªç®—å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchimport torch.nn as nnimport torch.optim as optimclass SimpleCNN(nn.Module):    def __init__(self):        super(SimpleCNN, self).__init__()        self.conv1 = nn.Conv2d(1, 20, 5)        self.pool = nn.MaxPool2d(2, 2)        self.conv2 = nn.Conv2d(20, 50, 5)        self.fc1 = nn.Linear(50 * 4 * 4, 500)        self.fc2 = nn.Linear(500, 10)    def forward(self, x):        x = self.pool(torch.relu(self.conv1(x)))        x = self.pool(torch.relu(self.conv2(x)))        x = x.view(-1, 50 * 4 * 4)        x = torch.relu(self.fc1(x))        x = self.fc2(x)        return xnet = SimpleCNN().to("cuda")criterion = nn.CrossEntropyLoss()optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9)for i in range(10):    inputs = torch.randn(32, 1, 28, 28, device="cuda")    labels = torch.randint(0, 10, (32,), device="cuda")    optimizer.zero_grad()    outputs = net(inputs)    loss = criterion(outputs, labels)    loss.backward()    optimizer.step()</code></pre> ç›´æ¥ç”¨Nsight Computeçš„å›¾å½¢ç•Œé¢æ¥å¯åŠ¨PyTorchç¨‹åº: <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310234626.png"><p></p><p>å½“Nsight Computeå®Œæˆåˆ†æåï¼Œé¦–å…ˆå‡ºç°çš„ç•Œé¢æ˜¯ä¸€ä¸ªæ€»ç»“ç•Œé¢(summary):<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250310234748.png"></p><p>è®©æˆ‘ä»¬åŒå‡»å…¶ä¸­ä»»æ„ä¸€ä¸ªå‡½æ•°åç§°ï¼Œè¿›å…¥ç»†èŠ‚(details)è§†å›¾ï¼Œè¿™æ—¶æˆ‘ä»¬ä¼šçœ‹åˆ°å¤§é‡ç¡¬ä»¶ç›¸å…³çš„æ€§èƒ½ä¿¡æ¯:<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311000423.png">é¦–å…ˆæ˜¯æœ€ä¸Šæ–¹çš„åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸåæ˜ çš„æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒGPUä¸åŒç¡¬ä»¶å•å…ƒçš„ååé‡ã€‚ä¸€èˆ¬æ¥è¯´ååé‡æœ€é«˜çš„ç¡¬ä»¶å•å…ƒå°±æ˜¯è¯¥CUDAå‡½æ•°çš„æ€§èƒ½ç“¶é¢ˆï¼Œä»¥æ­¤å¯ä»¥åˆ¤æ–­CUDAå‡½æ•°å±äºè®¡ç®—å¯†é›†å‹è¿˜æ˜¯è®¿å­˜å¯†é›†å‹ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬è§‚å¯Ÿä¸€ä¸ªæ± åŒ–å‡½æ•°(pooling)çš„ç¡¬ä»¶ä½¿ç”¨ç‡æƒ…å†µï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œå°±ä¼šå‘ç°å…¶è®¡ç®—ååé‡(ComputeThroughput)è¦è¿œé«˜äºè®¿å­˜ååé‡(MemoryThroughput)ï¼Œè¯´æ˜å½“å‰è¿™ä¸ªæ± åŒ–å‡½æ•°æ˜¯è®¡ç®—å¯†é›†å‹çš„ï¼Œä½†è¿™æœ‰äº›åç›´è§‰ã€‚ä»è®¡ç®—ç‰¹ç‚¹æ¥çœ‹ï¼Œæ± åŒ–å‡½æ•°æ¯æ¬¡éœ€è¦è¯»å–ä¸€å—å¾ˆå¤§çš„æ•°æ®åŒºåŸŸï¼Œä½†æ˜¯å¯¹è¿™äº›æ•°æ®çš„è®¡ç®—å´æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ç†åº”æ˜¯è®¿å­˜å¯†é›†å‹ä¸ºä¸»ã€‚ä»è¿™ä¸ªä¾‹å­æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºNsightComputeå¸¦æ¥çš„ä»·å€¼ï¼Œå®ƒèƒ½å¤Ÿå®šä½è¡¨ç°å¼‚å¸¸çš„ç®—å­ã€æä¾›æ€§èƒ½åˆ†ææ•°æ®ï¼Œå¹¶æœ€ç»ˆå¸®åŠ©æˆ‘ä»¬å®Œæˆç®—å­ä¼˜åŒ–ï¼š<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311000651.png"></p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬å°†æ³¨æ„åŠ›ç§»åŠ¨åˆ°CUDAå‡½æ•°å¯åŠ¨ä¿¡æ¯(LaunchStatistics)éƒ¨åˆ†ï¼Œè¿™é‡Œå±•ç¤ºçš„æ˜¯æ¯ä¸ªCUDAå‡½æ•°åœ¨æ‰§è¡Œæ—¶çš„ç›¸å…³é…ç½®ï¼Œæ¯”å¦‚è¯´æ ¼ç‚¹æ•°é‡(GridSize)ã€çº¿ç¨‹å—å¤§å°(BlockSize)ã€æ€»çº¿ç¨‹æ•°(Threads)ç­‰ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å¯ä»¥ç”¨æ¥åæ˜ ç®—å­æ˜¯å¦å……åˆ†åˆ©ç”¨äº†GPUçš„èµ„æºï¼š<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311000749.png">æ¯”å¦‚è¯´å›¾ä¸­ç®—å­çš„é—®é¢˜å°±åœ¨äºé…ç½®çš„æ ¼ç‚¹æ•°é‡å¤ªå°‘ï¼Œæ²¡èƒ½å……åˆ†ä½¿ç”¨GPUçš„æµå¼å¤šå¤„ç†å™¨(SM)ã€‚åœ¨å›¾ä¸­è“è‰²æ¡†çš„ä½ç½®å¤„ï¼Œè¿˜å¯ä»¥çœ‹åˆ°NsightComputeå¯¹æ­¤ç»™å‡ºçš„æç¤ºï¼ŒGPUæ”¯æŒ128ä¸ªå¹¶è¡Œçš„å¤šå¤„ç†å™¨æ ¸å¿ƒï¼Œä½†æ˜¯è¿™ä¸ªCUDAå‡½æ•°åªè°ƒç”¨äº†40ä¸ªï¼Œæ‰€ä»¥è¿˜æœ‰æ€§èƒ½ä¼˜åŒ–çš„ç©ºé—´ã€‚</p><p>æœ€åè®©æˆ‘ä»¬è§‚å¯Ÿå ç”¨ç‡åŒºåŸŸ(WarpOccupancy)ã€‚è¿™éƒ¨åˆ†ä¿¡æ¯åæ˜ äº†å¤šçº¿ç¨‹åœ¨GPUä¸Šæ‰§è¡Œæ—¶ï¼Œå®é™…çš„å¹¶è¡Œç¨‹åº¦ã€‚æ¯”å¦‚å›¾ä¸­å­˜åœ¨çš„é—®é¢˜æ˜¯çº¿ç¨‹ä½¿ç”¨ç‡ä¸é«˜ï¼Œç†è®ºä¸Šå¯ä»¥åŒæ—¶å¹¶è¡Œ48ä¸ªçº¿ç¨‹ç»„ï¼Œå®é™…ä¸Šåªæœ‰10ä¸ªï¼Œä»…è¾¾åˆ°äº†ç†è®ºå¹¶è¡Œåº¦çš„20%ã€‚ä»æç¤ºä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¼è‡´è¯¥ç°è±¡çš„åŸå› å¯èƒ½æœ‰ä¸¤ç±»ã€‚ä¸€ç§å¯èƒ½æ˜¯æ¯ä¸ªçº¿ç¨‹ä¸­çš„è®¡ç®—ä»»åŠ¡è¿‡äºç®€å•ï¼Œå¯¼è‡´çº¿ç¨‹æŸçš„åˆ›å»ºå’Œè°ƒåº¦å¼€é”€è¦æ˜¾è‘—å¤§äºçº¿ç¨‹è®¡ç®—ä»»åŠ¡çš„å¼€é”€ï¼Œæ‰€ä»¥ä¼˜åŒ–æ–¹å‘æ˜¯è®©å¤šä¸ªç®€å•çº¿ç¨‹åˆå¹¶æˆä¸€ä¸ªè®¡ç®—é‡è¾ƒå¤§çš„çº¿ç¨‹ã€‚å¦ä¸€ç§å¯èƒ½æ€§åˆ™æ˜¯çº¿ç¨‹æŸçš„è´Ÿè½½ä¸å‡è¡¡ï¼Œæ¯”å¦‚CUDAä»£ç ä¸­å­˜åœ¨å¤§é‡çº¿ç¨‹å‘æ•£ï¼Œå¯¼è‡´ä¸åŒåˆ†æ”¯çš„çº¿ç¨‹æŸæ— æ³•åŒæ­¥æ‰§è¡Œâ€”â€”è¿™å°±éœ€è¦æˆ‘ä»¬ç»“åˆCUDAä»£ç è¿›è¡Œå…·ä½“åˆ†æã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311001135.png"></p><h2 id="cpuæ€§èƒ½åˆ†æå·¥å…·">CPUæ€§èƒ½åˆ†æå·¥å…·</h2><h3 id="py-spy">Py-Spy</h3><p>Py-Spyæ˜¯éä¾µå…¥å¼çš„ï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸€è¡ŒPythonä»£ç ï¼Œå³å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¼€å¯CPUåˆ†æï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">py-spy record -o profile.svg python train.py</code></pre> Py-Spyå¯ä»¥ç”Ÿæˆä¸€ç§åä¸ºç«ç„°å›¾(flamegraph)çš„å¯è§†åŒ–æ–‡ä»¶ã€‚å°†ä¸Šé¢æŒ‡ä»¤äº§ç”Ÿçš„profile.svgæ–‡ä»¶æ‹–åˆ°æµè§ˆå™¨ä¸­ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚å›¾æ‰€ç¤ºçš„ç«ç„°å›¾äº†ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311002144.png"><p></p><p>ç«ç„°å›¾çš„æ¯ä¸ªç«–æ¡éƒ½è¡¨ç¤ºä¸€ç»„è°ƒç”¨æ ˆï¼Œä¸Šé¢æ˜¯æ ˆåº•ã€ä¸‹é¢æ˜¯æ ˆé¡¶ã€‚ä¸€èˆ¬æ¥è¯´Pythonå‡½æ•°åç§°ä¼šå‡ºç°åœ¨é è¿‘æ ˆåº•çš„ä½ç½®ï¼Œè€Œæ ˆé¡¶ä¸€èˆ¬æ˜¯ä¸€äº›åº•å±‚çš„C++å‡½æ•°åç§°ã€‚å½“æŠŠé¼ æ ‡ç§»åŠ¨åˆ°ç«ç„°å›¾çš„æŸä¸ªå‡½æ•°ä¸Šæ—¶ï¼Œè¿˜ä¼šåœ¨åé¢æ˜¾ç¤ºè¯¥å‡½æ•°å¯¹åº”çš„ä»£ç ä½ç½®ä»¥åŠé‡‡æ ·æ•°ã€‚é‡‡æ ·æ•°æœ¬è´¨ä¸Šå’Œè¿è¡Œæ—¶é—´åªå·®ä¸€ä¸ªç³»æ•°ï¼Œè¿™ä¸ªç³»æ•°å°±æ˜¯é‡‡æ ·é—´éš”ï¼Œé»˜è®¤æƒ…å†µä¸‹é‡‡æ ·é—´éš”æ˜¯100samples/sï¼Œå› æ­¤é‡‡æ ·æ•°é™¤ä»¥100å°±æ˜¯å‡½æ•°å®é™…è¿è¡Œçš„æ—¶é—´äº†ã€‚ä»å›¾ä¸­å¯ä»¥å¿«é€Ÿæ‰¾åˆ°numpy_heavy_computationå¯¹åº”çš„è¿è¡Œæ—¶é—´ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä»£ç ä¸­NumPyè®¡ç®—å¯¹åº”çš„CPUè°ƒç”¨ã€‚Py-Spyæ˜¯å¯¹æ‰€æœ‰PythonåŸç”Ÿç¨‹åºä»¥åŠç¬¬ä¸‰æ–¹åº“éƒ½é€‚ç”¨çš„åˆ†æå·¥å…·ï¼Œéå¸¸é€‚åˆç”¨æ¥ä¸“é—¨å¯¹CPUä»»åŠ¡è¿›è¡Œåˆ†æã€‚</p><h3 id="strace">strace</h3><p>æœ‰æ—¶å€™åœ¨Py-Spyçš„ç«ç„°å›¾ä¸­å¯ä»¥è§‚æµ‹åˆ°ä¸€äº›å‡½æ•°æ˜æ˜¾å ç”¨äº†è¿‡é•¿çš„æ—¶é—´ï¼Œå´ä¸çŸ¥é“ç³»ç»Ÿåœ¨å¹²ä»€ä¹ˆã€‚è¿™æ—¶ï¼Œä½¿ç”¨straceæ¥æŸ¥çœ‹ç¨‹åºä¸æ“ä½œç³»ç»Ÿä¹‹é—´çš„å®æ—¶äº¤äº’ï¼Œå¦‚æ–‡ä»¶æ“ä½œã€å†…å­˜ç®¡ç†å’Œç½‘ç»œé€šä¿¡ç­‰ï¼Œé€šå¸¸èƒ½å¸¦æ¥æå¤§çš„å¸®åŠ©ã€‚<strong>straceæ˜¯ä¸€ä¸ªåœ¨Linuxç¯å¢ƒä¸­æå…¶å®ç”¨çš„è¯Šæ–­å’Œè°ƒè¯•å·¥å…·ï¼Œå®ƒèƒ½å¤Ÿè¿½è¸ªå¹¶è®°å½•ç¨‹åºæ‰§è¡Œçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼ŒåŒ…æ‹¬æ¯ä¸ªè°ƒç”¨çš„å‡½æ•°åã€ä¼ é€’çš„å‚æ•°ä»¥åŠè¿”å›å€¼ã€‚</strong>straceçš„ä½¿ç”¨æ–¹æ³•ä¹Ÿå¾ˆç›´æ¥ï¼Œæ—¢å¯ä»¥é€šè¿‡straceå¯åŠ¨ä¸€ä¸ªç¨‹åºï¼Œä¹Ÿå¯ä»¥è¿½è¸ªä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># é€šè¿‡straceè¿è¡Œä¸€ä¸ªç¨‹åºstrace python train.py# è¿½è¸ªä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹strace -p &lt;pid&gt;</code></pre><p></p><p>åœ¨ä½¿ç”¨straceè¿½è¸ªç¨‹åºæ—¶ï¼Œæœ‰ä¸€äº›å¸¸è§çš„ä¸æ€§èƒ½ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å€¼å¾—æˆ‘ä»¬ç‰¹æ®Šå…³æ³¨ï¼š- æ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚open/close/read/write/lseekç­‰ -ç½‘ç»œé€šä¿¡ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚socket/bind/listen/send/recvç­‰ -è¿›ç¨‹æ§åˆ¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚fork/execve/waitç­‰ -å†…å­˜ç®¡ç†ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚mmap/munmap/brkç­‰</p><p>straceå¯ä»¥æœ‰æ•ˆåœ°å¸®åŠ©å¼€å‘è€…äº†è§£ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯ç”¨äºè¯Šæ–­ç¨‹åºçš„æ€§èƒ½å¼‚å¸¸ç­‰ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>æœ¬ç« ä¸»è¦ä»‹ç»å¦‚ä½•å®šä½æ€§èƒ½ç“¶é¢ˆï¼Œå…·ä½“åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼š -é…ç½®ä¸€ä¸ªç¨³å®šä¸”å¯å¤ç°çš„è½¯ç¡¬ä»¶ç¯å¢ƒã€‚ -é€šè¿‡è®¡æ—¶æˆ–è§‚å¯ŸPyTorchæ€§èƒ½å›¾è°±æ¥å‘ç°æ€§èƒ½é—®é¢˜ã€‚ -ä½¿ç”¨åº•å±‚ç¡¬ä»¶å’Œç³»ç»Ÿç›¸å…³çš„æ€§èƒ½åˆ†æå·¥å…·æ¥å‰–æé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚ä¸€æ—¦æ‰¾åˆ°äº†æ€§èƒ½é—®é¢˜å¹¶ç†è§£å…¶åŸå› ï¼Œå°±å¯ä»¥å‚è€ƒç¬¬6ç« ä¸­çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•è¿›è¡Œä¼˜åŒ–ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥å‚è€ƒç¬¬9ç« ä¸­çš„é«˜çº§ä¼˜åŒ–æ–¹æ³•è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250311002659.png"></p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> æ€§èƒ½ç“¶é¢ˆ </tag>
            
            <tag> PyTorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿æ€§ä»£æ•°-åŠæ­£å®šä¸æ­£å®šçŸ©é˜µ</title>
      <link href="/2025/03/10/xian-xing-dai-shu-ban-zheng-ding-yu-zheng-ding-ju-zhen/"/>
      <url>/2025/03/10/xian-xing-dai-shu-ban-zheng-ding-yu-zheng-ding-ju-zhen/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬å®šä¹‰">åŸºæœ¬å®šä¹‰</h2><blockquote><p>æ­£å®šçŸ©é˜µï¼šä¸€ä¸ª nÃ—n çš„å®å¯¹ç§°çŸ©é˜µ <span class="math inline">\(A\)</span>ï¼Œå¦‚æœå¯¹äºä»»ä½•éé›¶å‘é‡ <span class="math inline">\(x \in \mathbb{R}^n\)</span>ï¼Œéƒ½æ»¡è¶³ï¼š<span class="math inline">\(x^TAx &gt; 0\)</span>ï¼Œåˆ™ç§° <span class="math inline">\(A\)</span> ä¸ºæ­£å®šçŸ©é˜µã€‚</p></blockquote><blockquote><p>åŠæ­£å®šçŸ©é˜µï¼šä¸€ä¸ª nÃ—n çš„å®å¯¹ç§°çŸ©é˜µ <span class="math inline">\(A\)</span>ï¼Œå¦‚æœå¯¹äºä»»ä½•å‘é‡ <span class="math inline">\(x \in \mathbb{R}^n\)</span>ï¼Œéƒ½æ»¡è¶³ï¼š<span class="math inline">\(x^TAx \geq 0\)</span>ï¼Œåˆ™ç§° <span class="math inline">\(A\)</span> ä¸ºåŠæ­£å®šçŸ©é˜µã€‚</p></blockquote><h3 id="ä¾‹1">ä¾‹1</h3><p>å•ä½çŸ©é˜µ <span class="math inline">\(I \in \mathbb{R}^{2 \times2}\)</span> æ˜¯å¦æ˜¯æ­£å®šçŸ©é˜µï¼Ÿ</p><p>è§£ï¼šè®¾å‘é‡ <span class="math inline">\(\boldsymbol{x} =\begin{bmatrix}x_1\\x_2\end{bmatrix} \in \mathbb{R}^2\)</span>ä¸ºéé›¶å‘é‡ï¼Œåˆ™ <span class="math display">\[\boldsymbol{x}^T I\boldsymbol{x} = \boldsymbol{x}^T\boldsymbol{x} =x_1^2 + x_2^2\]</span> ç”±äº <span class="math inline">\(\boldsymbol{x} \neq\boldsymbol{0}\)</span>ï¼Œæ•… <span class="math inline">\(\boldsymbol{x}^TI\boldsymbol{x} &gt; 0\)</span> æ’æˆç«‹ï¼Œå³å•ä½çŸ©é˜µ <span class="math inline">\(I \in \mathbb{R}^{2 \times 2}\)</span>æ˜¯æ­£å®šçŸ©é˜µã€‚</p><p>å•ä½çŸ©é˜µæ˜¯æ­£å®šçŸ©é˜µ (positive definite)ã€‚</p><h4 id="ç®€å•è¯æ˜">ç®€å•è¯æ˜</h4><p>å¯¹äºä»»æ„å•ä½çŸ©é˜µ <span class="math inline">\(I \in \mathbb{R}^{n\times n}\)</span> è€Œè¨€ï¼Œç»™å®šä»»æ„éé›¶å‘é‡ <span class="math inline">\(\boldsymbol{x} \in \mathbb{R}^n\)</span>ï¼Œæ’æœ‰$$\begin{align*}\boldsymbol{x}^T I\boldsymbol{x} &amp;= \boldsymbol{x}^T\boldsymbol{x}\\&amp;= x_1^2 + x_2^2 + \cdots + x_n^2 &gt; 0\end{align*}$$ ### ä¾‹2 å®å¯¹ç§°çŸ©é˜µ <span class="math inline">\(A =\begin{bmatrix}2&amp;-1&amp;0\\-1&amp;2&amp;-1\\0&amp;-1&amp;2\end{bmatrix}\in \mathbb{R}^{3 \times 3}\)</span> æ˜¯å¦æ˜¯æ­£å®šçŸ©é˜µï¼Ÿ</p><p>è§£ï¼šè®¾å‘é‡ <span class="math inline">\(\boldsymbol{x} =\begin{bmatrix}x_1\\x_2\\x_3\end{bmatrix} \in \mathbb{R}^3\)</span>ä¸ºéé›¶å‘é‡ï¼Œåˆ™ $$\begin{align*}\boldsymbol{x}^T A\boldsymbol{x} &amp;= \begin{bmatrix}(2x_1 - x_2)&amp;(-x_1 + 2x_2 - x_3)&amp;-x_2 + 2x_3\end{bmatrix}\begin{bmatrix}x_1\\x_2\\x_3\end{bmatrix}\\&amp;= x_1^2 + (x_1 - x_2)^2 + (x_2 - x_3)^2 + x_3^2 &gt; 0\end{align*}$$ å› æ­¤ï¼ŒçŸ©é˜µ <span class="math inline">\(A\)</span> æ˜¯æ­£å®šçŸ©é˜µã€‚</p><h2 id="ç»“åˆäºŒæ¬¡å‡½æ•°çš„è§£é‡Š">ç»“åˆäºŒæ¬¡å‡½æ•°çš„è§£é‡Š</h2><p>åœ¨åˆä¸­æˆ‘ä»¬å­¦è¿‡äºŒæ¬¡å‡½æ•°ï¼Œå½¢å¦‚ <span class="math inline">\(f(x) =ax^2\)</span>ï¼Œè¯¥å‡½æ•°çš„æ›²çº¿ä¼šç»è¿‡åæ ‡åŸç‚¹ï¼Œä¸”å¼€å£å‘ä¸Šï¼Œæ‰€æœ‰çš„å‡½æ•°å€¼éƒ½å¤§äºç­‰äº0ã€‚</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°† <span class="math inline">\(y=x^TAx\)</span>çœ‹ä½œæ˜¯äºŒæ¬¡å‡½æ•° <span class="math inline">\(f(x) = ax^2\)</span>çš„å¤šç»´æ¨å¹¿ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœå¸Œæœ› <span class="math inline">\(y=x^TAx\)</span>å¯¹æ‰€æœ‰å‘é‡ <span class="math inline">\(x\)</span> éƒ½å¤§äºç­‰äº0ï¼Œåˆ™éœ€è¦<span class="math inline">\(A\)</span> ä¸ºåŠæ­£å®šçŸ©é˜µã€‚</p><p>å¦å¤–åœ¨<span class="math inline">\(y=ax^2\)</span>ä¸­ï¼Œè‹¥<span class="math inline">\(a&gt;0\)</span>ï¼Œåˆ™å¯¹äºä»»æ„<span class="math inline">\(x!=0\)</span>ï¼Œæœ‰<span class="math inline">\(y&gt;0\)</span>æ’æˆç«‹ã€‚</p><p>åŒæ ·ï¼Œå¦‚æœå¸Œæœ› <span class="math inline">\(y=x^TAx\)</span>å¯¹æ‰€æœ‰éé›¶å‘é‡ <span class="math inline">\(x\)</span> éƒ½å¤§äº0ï¼Œåˆ™éœ€è¦<span class="math inline">\(A\)</span> ä¸ºæ­£å®šçŸ©é˜µã€‚</p><h2 id="ç›´è§‚è§£é‡Š">ç›´è§‚è§£é‡Š</h2><blockquote><p>è‹¥ç»™å®šä»»æ„ä¸€ä¸ªæ­£å®šçŸ©é˜µ<span class="math inline">\(A\in\mathbb{R}^{n\times n}\)</span> å’Œä¸€ä¸ªéé›¶å‘é‡<span class="math inline">\(x\in\mathbb{R}^n\)</span>ï¼Œåˆ™ä¸¤è€…ç›¸ä¹˜å¾—åˆ°çš„å‘é‡<span class="math inline">\(y=Ax \in \mathbb{R}^n\)</span> ä¸å‘é‡<span class="math inline">\(x\)</span> çš„å¤¹è§’æ’å°äºç­‰äº90åº¦ã€‚ï¼ˆç­‰ä»·äº<span class="math inline">\(x^TAx&gt;0\)</span>ï¼‰</p></blockquote><h3 id="ä¾‹3">ä¾‹3</h3><p>ç»™å®šå‘é‡ <span class="math inline">\(\boldsymbol{x} =\begin{bmatrix}2\\1\end{bmatrix} \in \mathbb{R}^2\)</span>ï¼Œå¯¹äºå•ä½çŸ©é˜µ<span class="math inline">\(I =\begin{bmatrix}1&amp;0\\0&amp;1\end{bmatrix} \in \mathbb{R}^{2 \times2}\)</span>ï¼Œåˆ™ <span class="math display">\[\boldsymbol{y} = I\boldsymbol{x} = \boldsymbol{x} =\begin{bmatrix}2\\1\end{bmatrix}\]</span> å‘é‡ <span class="math inline">\(\boldsymbol{x},\boldsymbol{y} \in \mathbb{R}^2\)</span> ä¹‹é—´çš„å¤¹è§’ä¸º $$\begin{align*}\cos\langle\boldsymbol{x}, \boldsymbol{y}\rangle &amp;= \frac{\boldsymbol{x}^T\boldsymbol{y}}{\|\boldsymbol{x}\|\cdot\|\boldsymbol{y}\|}\\&amp;= \frac{2\times2 + 1\times1}{\sqrt{2^2 + 1^2}\cdot\sqrt{2^2 + 1^2}}\\&amp;= 1\end{align*}$$å³ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ä¸º <span class="math inline">\(0^{\circ}\)</span>ã€‚</p><h3 id="ä¾‹4">ä¾‹4</h3><p>ç»™å®šå‘é‡ <span class="math inline">\(\boldsymbol{x} =\begin{bmatrix}2\\1\\1\end{bmatrix} \in\mathbb{R}^3\)</span>ï¼Œå¯¹äºå®å¯¹ç§°çŸ©é˜µ <span class="math inline">\(A =\begin{bmatrix}2&amp;-1&amp;0\\-1&amp;2&amp;-1\\0&amp;-1&amp;2\end{bmatrix}\in \mathbb{R}^{3 \times 3}\)</span>ï¼Œåˆ™ <span class="math display">\[\boldsymbol{y} = A\boldsymbol{x} = \begin{bmatrix}0\\2\\0\end{bmatrix}\]</span> å‘é‡ <span class="math inline">\(\boldsymbol{x},\boldsymbol{y} \in \mathbb{R}^3\)</span> ä¹‹é—´çš„å¤¹è§’ä¸º <span class="math display">\[\cos\langle\boldsymbol{x}, \boldsymbol{y}\rangle =\frac{\boldsymbol{x}^T\boldsymbol{y}}{\|\boldsymbol{x}\|\cdot\|\boldsymbol{y}\|}= \frac{\sqrt{6}}{3}\]</span> å³ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’å°äº <span class="math inline">\(\frac{\pi}{2}\)</span>ã€‚</p><h2 id="ä¸ºä»€ä¹ˆåæ–¹å·®çŸ©é˜µæ˜¯åŠæ­£å®šçŸ©é˜µ">ä¸ºä»€ä¹ˆåæ–¹å·®çŸ©é˜µæ˜¯åŠæ­£å®šçŸ©é˜µ</h2><p>åœ¨æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡ä¸­ï¼Œåæ–¹å·®çŸ©é˜µè¢«å®šä¹‰ä¸ºï¼š</p><blockquote><p>å¯¹äºä»»æ„å¤šå…ƒéšæœºå˜é‡ <span class="math inline">\(\boldsymbol{t}\)</span>ï¼Œåæ–¹å·®çŸ©é˜µä¸º <span class="math inline">\(C = \mathbb{E}[(\boldsymbol{t} -\overline{\boldsymbol{t}})(\boldsymbol{t} -\overline{\boldsymbol{t}})^T]\)</span></p></blockquote><p>ç°ç»™å®šä»»æ„ä¸€ä¸ªå‘é‡ <span class="math inline">\(\boldsymbol{x}\)</span>ï¼Œåˆ™ $$\begin{align*}\boldsymbol{x}^T C\boldsymbol{x} &amp;= \boldsymbol{x}^T\mathbb{E}[(\boldsymbol{t} - \overline{\boldsymbol{t}})(\boldsymbol{t} - \overline{\boldsymbol{t}})^T]\boldsymbol{x}\\&amp;= \mathbb{E}[\boldsymbol{x}^T(\boldsymbol{t} - \overline{\boldsymbol{t}})(\boldsymbol{t} - \overline{\boldsymbol{t}})^T\boldsymbol{x}]\\&amp;= \mathbb{E}(s^2) = \sigma_s^2\end{align*}$$ å…¶ä¸­ï¼Œ<span class="math inline">\(\sigma_s = \boldsymbol{x}^T(\boldsymbol{t} -\overline{\boldsymbol{t}}) = (\boldsymbol{t} -\overline{\boldsymbol{t}})^T\boldsymbol{x}\)</span></p><p>ç”±äº <span class="math inline">\(\sigma_s^2 \geq0\)</span>ï¼Œå› æ­¤ï¼Œ<span class="math inline">\(\boldsymbol{x}^TC\boldsymbol{x} \geq 0\)</span>ï¼Œåæ–¹å·®çŸ©é˜µ <span class="math inline">\(C\)</span> æ˜¯åŠæ­£å®šçš„ã€‚</p><p>å‚è€ƒ</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/44860862">æµ…è°ˆã€Œæ­£å®šçŸ©é˜µã€å’Œã€ŒåŠæ­£å®šçŸ©é˜µã€</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> çº¿æ€§ä»£æ•° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿æ€§ä»£æ•° </tag>
            
            <tag> æ­£å®š/åŠæ­£å®šçŸ©é˜µ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-æ·±åº¦å­¦ä¹ å¿…å¤‡çš„PyTorch</title>
      <link href="/2025/03/07/da-mo-xing-dong-li-yin-qing-shen-du-xue-xi-bi-bei-de-pytorch/"/>
      <url>/2025/03/07/da-mo-xing-dong-li-yin-qing-shen-du-xue-xi-bi-bei-de-pytorch/</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç« å°†ä»PyTorchçš„æ ¸å¿ƒæ¦‚å¿µâ€”â€”å¼ é‡å’Œç®—å­è®²èµ·ï¼Œé€æ­¥æ·±å…¥PyTorchçš„å†…å­˜åˆ†é…ã€åŸºäºåŠ¨æ€å›¾çš„è¿è¡Œæœºåˆ¶ï¼Œä»¥åŠä½œä¸ºè®­ç»ƒæ¡†æ¶çš„æ€æ‰‹é”çº§ç‰¹æ€§â€”â€”è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿçš„åº•å±‚åŸç†</p><h2 id="pytorchçš„å¼ é‡æ•°æ®ç»“æ„">PyTorchçš„å¼ é‡æ•°æ®ç»“æ„</h2><p>Pytorché€šè¿‡å¼ é‡(torch.Tensor)ä½œä¸ºæ•°æ®å®¹å™¨æä¾›äº†ç»Ÿä¸€çš„æ–¹å¼æ¥å¤„ç†ä¸åŒç»´åº¦å’Œå½¢çŠ¶çš„æ•°æ®(æ ‡é‡ã€å‘é‡ã€çŸ©é˜µã€å¼ é‡)ã€‚</p><h3 id="å¼ é‡çš„åŸºæœ¬å±æ€§åŠåˆ›å»º">å¼ é‡çš„åŸºæœ¬å±æ€§åŠåˆ›å»º</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchx = torch.tensor((3,2), dtype=torch.float32, device=torch.device('cuda'))print(x.dtype)   # torch.float32print(x.device)  # cuda:0print(x.shape)   # torch.Size([3,2])</code></pre><h3 id="è®¿é—®å¼ é‡çš„æ•°æ®">è®¿é—®å¼ é‡çš„æ•°æ®</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"># åˆ›å»ºä¸€ä¸ª10è¡Œ20åˆ—çš„è¿ç»­å¼ é‡, å¹¶ä½¿ç”¨contiguous()æ–¹æ³•ç¡®ä¿å¼ é‡åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„x = torch.arange(200).reshape(10,20).contiguous()# è®¿é—®å¼ é‡ä¸­çš„æ•°æ®print(x[0, 0])  # tensor(0)print(x[0, -1]) # tensor(19)print(x[2, :])  # tensor([40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59])print(x[0, 1:9:3]) # tensor([1, 4, 7])print(x[..., 1])   # tensor([1, 21, 41, 61, 81, 101, 121, 141, 161, 181])print(x[:, None, :]) # ä½¿ç”¨None æ’å…¥ä¸€ä¸ªæ–°ç»´åº¦ï¼Œè¿”å›ä¸€ä¸ªå½¢çŠ¶ä¸º(10, 1, 20)çš„å¼ é‡</code></pre><h3 id="å¼ é‡çš„å­˜å‚¨æ–¹å¼">å¼ é‡çš„å­˜å‚¨æ–¹å¼</h3><p>torch.Storageæ˜¯ç”¨äºè¡¨ç¤ºæ•°æ®åœ¨ç‰©ç†å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ï¼Œå…¶å®å°±æ˜¯ä¸€å—è¿ç»­çš„ä¸€ç»´å†…å­˜ç©ºé—´ã€‚æ¯ä¸ª<strong>torch.Storageå¯¹è±¡è´Ÿè´£ç»´æŠ¤å­˜å‚¨æ•°æ®çš„ç±»å‹å’Œæ€»é•¿åº¦ä¿¡æ¯</strong>ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œ<strong>torch.Tensoræ·»åŠ äº†å¦‚å½¢çŠ¶(shape)ã€æ­¥é•¿(stride)å’Œåç§»é‡(offset)ç­‰é¢å¤–çš„å±æ€§ï¼Œå®šä¹‰äº†torch.Tensorè®¿é—®åº•å±‚æ•°æ®çš„å…·ä½“æ–¹å¼</strong>ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307170840.png"></p><p><strong>æ­¥é•¿</strong>æŒ‡å®šäº†åœ¨éå†å¼ é‡æ•°æ®æ—¶ï¼Œå¿…é¡»åœ¨å†…å­˜ä¸­è·³è¿‡å¤šå°‘å…ƒç´ æ‰èƒ½åˆ°è¾¾ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜æ­¥é•¿å±æ€§æ¥å®ç°ä¸€ä¸ªé«˜æ•ˆçš„å¼ é‡è½¬ç½®æ“ä½œ: </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torch# åˆ›å»ºä¸€ä¸ª3*4çš„å¼ é‡, ä½¿ç”¨contiguous()ç¡®ä¿å…¶è¿ç»­æ€§x = torch.arange(12).reshape(3, 4).contiguous()print(f"x = {x}\nx.stride = {x.stride()}")# x = tensor([[ 0,  1,  2,  3],#         [ 4,  5,  6,  7],#         [ 8,  9, 10, 11]])# x.stride = (4, 1)y = torch.as_strided(x, size=(4, 3), stride=(1, 4))print(f"y = {y}\ny.stride = {y.stride()}")# y = tensor([[ 0,  4,  8],#         [ 1,  5,  9],#         [ 2,  6, 10],#         [ 3,  7, 11]])# y.stride = (1, 4)# å¼ é‡xå’Œyå…±äº«åŒä¸€å—åº•å±‚å­˜å‚¨assert id(x.untyped_storage()) == id(y.untyped_storage())</code></pre><strong>as_stridedå‡½æ•°</strong>çš„ä½œç”¨ç”±ä¸¤æ–¹é¢æ„æˆï¼šä¸€æ–¹é¢å®ƒé‡æ–°è§„å®šäº†xå¼ é‡çš„è®¿é—®æ–¹å¼ï¼Œå°†å…¶æ­¥é•¿ä»(4,1)æ”¹ä¸ºäº†(1, 4)ï¼Œå½¢çŠ¶ä¸º(4,3)ã€‚è¿™æ„å‘³ç€åœ¨éå†xçš„æ•°æ®æ—¶ï¼Œåœ¨ç¬¬äºŒä¸ªç»´åº¦ä¸Šæ¯è®¿é—®ä¸€ä¸ªæ•°æ®ä¼šå‘åè·³å››æ­¥å†è®¿é—®ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œè€Œåœ¨ç¬¬ä¸€ä¸ªç»´åº¦ä¸Šåˆ™æ¯è®¿é—®ä¸€ä¸ªæ•°æ®å‘åè·³ä¸€æ­¥ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307172705.png"><p></p><p>ä½¿ç”¨strideå±æ€§æ¥è®¿é—®å¼ é‡æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå› ä¸ºå®ƒæ— éœ€å¤åˆ¶ï¼Œç›´æ¥æ“ä½œåŒä¸€ä¸ªå¼ é‡çš„åº•å±‚æ•°æ®å­˜å‚¨ã€‚ä½†å®ƒä¹Ÿæ˜¯æŠŠåŒåˆƒå‰‘ï¼Œå› ä¸ºä¼šå¯¼è‡´â€œ<strong>å¼ é‡ä¸è¿ç»­</strong>â€â€‹ã€‚å…¶æ¬¡è®¸å¤šPyTorchç®—æ³•åœ¨è®¾è®¡æ—¶å°±é¢„è®¾äº†å¼ é‡åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œå¦‚æœé‡åˆ°ä¸è¿ç»­çš„å¼ é‡ï¼Œå¯èƒ½ä¼šæŠ›å‡ºé”™è¯¯æç¤ºç”šè‡³å¾—åˆ°é”™è¯¯çš„è®¡ç®—ç»“æœã€‚PyTorchæä¾›äº†<strong>tensor.is_contiguous()</strong>æ–¹æ³•ç”¨äºæ£€æµ‹å¼ é‡æ˜¯å¦ä¸ºè¿ç»­ã€‚å¯¹äºä¸è¿ç»­çš„å¼ é‡ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨<strong>tensor.contiguous()</strong>æ–¹æ³•ç”Ÿæˆä¸€ä¸ªè¿ç»­çš„å‰¯æœ¬ã€‚ç„¶è€Œå¤©ä¸‹æ²¡æœ‰å…è´¹çš„åˆé¤ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šå°†åŸå§‹æ•°æ®å¤åˆ¶åˆ°ä¸€å—æ–°çš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œå¢åŠ å†…å­˜å ç”¨ï¼Œå› æ­¤è¯»è€…åœ¨å¼€å‘æ—¶éœ€è¦æ—¶åˆ»æ³¨æ„å†…å­˜å’Œæ€§èƒ½ä¹‹é—´çš„å¹³è¡¡ã€‚</p><h3 id="å¼ é‡çš„è§†å›¾">å¼ é‡çš„è§†å›¾</h3><p>ä¸åŒçš„å¼ é‡å¯ä»¥å…±äº«åŒä¸€å—åº•å±‚å­˜å‚¨ï¼Œå½“è¿™äº›å…±äº«å­˜å‚¨çš„å¼ é‡äº’ä¸é‡å æ—¶ï¼Œå½±å“è¾ƒå°ã€‚ä½†å¦‚æœå®ƒä»¬<strong>ä¸ä»…å…±äº«åº•å±‚å­˜å‚¨ï¼Œè¿˜å­˜åœ¨é‡å ï¼Œæˆ‘ä»¬ç§°å…¶ä¸­ä¸€ä¸ªå¼ é‡ä¸ºå¦ä¸€ä¸ªå¼ é‡çš„è§†å›¾(view)</strong>ã€‚</p><p>ä»¥ä¸‹æ˜¯pytorchä¸­å¸¸è§çš„å‡ ç§<strong>è§†å›¾æ“ä½œ</strong>ï¼Œå®ƒä»¬éƒ½å…±äº«åŒä¸€å—åº•å±‚å­˜å‚¨ï¼Œä½†è¿”å›çš„å¼ é‡å½¢çŠ¶å¯èƒ½ä¸åŒã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307174015.png">åŸºäº<strong>åŸºç¡€ç´¢å¼•çš„å¼ é‡è¯»å–æ“ä½œ</strong>è¿”å›çš„ä¹Ÿæ˜¯è§†å›¾ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchx = torch.zeros(3,3)y = x[0]y[0] = 1print(f"x = {x}\ny = {y}")# x = tensor([[1., 0., 0.],#         [0., 0., 0.],#         [0., 0., 0.]])# y = tensor([1., 0., 0.])</code></pre><p></p><p>æ³¨æ„ä¸€äº›æ¥å£å¦‚ <strong>reshape()å’Œflatten()</strong>çš„è¡Œä¸ºè¾ƒä¸ºç‰¹æ®Šï¼Œå®ƒä»¬æ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºæ™¯è¿”å›ä¸€ä¸ªè§†å›¾å¼ é‡æˆ–ä¸€ä¸ªå…¨æ–°å†…å­˜çš„å¼ é‡ã€‚è¿™ç§è¡Œä¸ºçš„ä¸ç¡®å®šæ€§å¯¼è‡´è¿™äº›æ¥å£å¹¶ä¸æ˜¯æœ€ç†æƒ³çš„APIè®¾è®¡ã€‚</p><h2 id="pytorchä¸­çš„ç®—å­">Pytorchä¸­çš„ç®—å­</h2><h3 id="ç®—å­åº“">ç®—å­åº“</h3><p>PyTorchæä¾›äº†å¤§é‡ç”¨äºæ„å»ºç¥ç»ç½‘ç»œçš„ç®—å­ï¼Œè¿™äº›ç®—å­å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š -(1)åŸºç¡€æ•°å­¦è¿ç®—ï¼šæ¶µç›–äº†åŠ æ³•(+)ã€å‡æ³•(-)ã€ **ä¹˜æ³•(*/mul)<strong>ã€é™¤æ³•(/)ã€æŒ‡æ•°(exp)ã€å¹‚æ¬¡æ–¹(pow)ç­‰åŸºæœ¬æ•°å­¦æ“ä½œã€‚ï¼ˆ</strong>element-wiseæ“ä½œ<strong>ï¼‰-(2)çº¿æ€§ä»£æ•°è¿ç®—ï¼šåŒ…æ‹¬çŸ©é˜µä¹˜æ³•(</strong>matmul/@)**ã€ç‚¹ä¹˜(dot)ã€è½¬ç½®(t)ã€é€†çŸ©é˜µ(inverse)ç­‰çº¿æ€§ä»£æ•°ç›¸å…³çš„è¿ç®—ã€‚-(3)é€»è¾‘å’Œæ¯”è¾ƒè¿ç®—ï¼šä¾‹å¦‚é€»è¾‘ä¸(logical_and)ã€é€»è¾‘æˆ–(logical_or)ã€ç­‰äº(eq)ã€å¤§äº(gt)ã€å°äº(lt)ç­‰ç”¨äºæ¯”è¾ƒå’Œé€»è¾‘åˆ¤æ–­çš„æ“ä½œã€‚-(4)å¼ é‡æ“ä½œï¼šæ¶‰åŠå¼ é‡çš„ç´¢å¼•ã€åˆ‡ç‰‡ã€æ‹¼æ¥(cat)ã€è°ƒæ•´å½¢çŠ¶(reshape)ã€è°ƒæ•´ç»´åº¦(permute)ç­‰æ“ä½œï¼Œç”¨äºå¼ é‡çš„å½¢çŠ¶å’Œå†…å®¹è°ƒæ•´ã€‚-(5)å…¶ä»–ç‰¹æ®Šè¿ç®—ï¼šåŒ…æ‹¬æ·±åº¦å­¦ä¹ ä¸­ä½¿ç”¨çš„å„ç§å±‚ï¼ˆå¦‚å·ç§¯å±‚ã€æ± åŒ–å±‚ã€æ³¨æ„åŠ›å±‚ï¼‰ä»¥åŠæŸå¤±å‡½æ•°ç­‰ç‰¹å®šäºåº”ç”¨çš„å¤æ‚è¿ç®—ã€‚</p><p><strong>çŸ©é˜µä¹˜æ³•</strong>çŸ©é˜µä¹˜æ³•æ˜¯æ·±åº¦å­¦ä¹ ä¸­éå¸¸å¸¸è§çš„æ“ä½œï¼ŒPyTorchæä¾›äº†å¤šç§çŸ©é˜µä¹˜æ³•è¿ç®—ç¬¦ï¼ŒåŒ…æ‹¬ï¼š- dotï¼šç”¨äºè®¡ç®—ä¸¤ä¸ª1Då‘é‡ä¹‹é—´çš„ç‚¹ç§¯ï¼Œè¿”å›ä¸€ä¸ªæ ‡é‡ã€‚ -mmï¼šç”¨äºè®¡ç®—ä¸¤ä¸ª2DçŸ©é˜µä¹‹é—´çš„çŸ©é˜µä¹˜ç§¯ã€‚ -matmulï¼šç”¨äºè®¡ç®—ä¸¤ä¸ªå¼ é‡ä¹‹é—´çš„çŸ©é˜µä¹˜ç§¯ã€‚(1Dæ—¶ç­‰ä»·dotï¼Œ2Dæ—¶ç­‰ä»·mm) -bmmï¼šç”¨äºæ‰¹é‡è®¡ç®—çŸ©é˜µä¹˜ç§¯ã€‚</p><h3 id="pytorchç®—å­çš„è¿”å›å€¼å†…å­˜åˆ†é…">Pytorchç®—å­çš„è¿”å›å€¼å†…å­˜åˆ†é…</h3><p>PyTorchç®—å­æ“ä½œçš„è¾“å…¥å’Œè¿”å›å€¼éƒ½æ˜¯å¼ é‡ï¼Œä½†è¿”å›å€¼æ˜¯å¦åˆ›å»ºæ–°çš„å†…å­˜å–å†³äºå…·ä½“çš„ç®—å­ã€‚#### åŸåœ°æ“ä½œPyTorchä¹Ÿä¸ºä¸€äº›ç®—å­æä¾›äº†åŸä½(inplace)æ“ä½œï¼Œå®ƒä»¬ç›´æ¥ä¿®æ”¹è¾“å…¥å¼ é‡çš„æ•°æ®å¹¶è¿”å›åŒä¸€ä¸ªå¼ é‡ï¼Œæ— é¡»åˆ›å»ºæ–°çš„å†…å­˜ã€‚- åŸä½æ“ä½œé€šå¸¸åœ¨æ–¹æ³•åååŠ ä¸‹åˆ’çº¿<strong>(_)è¡¨ç¤ºï¼Œä¾‹å¦‚add_()æ˜¯add()çš„åŸä½ç‰ˆæœ¬</strong>ã€‚ -æŸäº›è¯­æ³•ä¹Ÿä¼šéšå¼åœ°è§¦å‘åŸä½æ“ä½œã€‚æ¯”å¦‚x+=yå°†è§¦å‘åŸä½åŠ æ³•æ“ä½œï¼Œè€Œx = x +yå°±åªæ˜¯æ™®é€šçš„åŠ æ³•æ“ä½œå’Œèµ‹å€¼æ“ä½œã€‚</p><h4 id="è§†å›¾æ“ä½œ">è§†å›¾æ“ä½œ</h4><p>è¾“å‡ºå¼ é‡ä¸è¾“å…¥å¼ é‡å…±äº«åº•å±‚å†…å­˜ï¼Œå› æ­¤ä¸ä¼šé€ æˆé¢å¤–çš„å†…å­˜åˆ†é…ã€‚</p><h4 id="è¯»å–æ“ä½œ">è¯»å–æ“ä½œ</h4><ul><li>åŸºç¡€ç´¢å¼•æ“ä½œï¼šè¿”å›çš„æ˜¯è§†å›¾ã€‚</li><li>é«˜çº§ç´¢å¼•æ“ä½œï¼šç±»ä¼¼äºNumPyçš„é«˜çº§ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨å¸ƒå°”æˆ–è€…æ•´æ•°å¼ é‡ä½œä¸ºç´¢å¼•ã€‚åŸºäºé«˜çº§ç´¢å¼•çš„è¯»å–æ“ä½œä¼šåˆ›å»ºæ–°çš„å†…å­˜å­˜å‚¨ã€‚<pre class="line-numbers language-python" data-language="python"><code class="language-python">import torch# åˆ›å»ºä¸€ä¸ª10*20çš„å¼ é‡, ä½¿ç”¨contiguous()ç¡®ä¿å…¶è¿ç»­æ€§x = torch.arange(200).reshape(10, 20).contiguous()# åŸºç¡€ç´¢å¼•ï¼Œè¯»å–xçš„ç¬¬0è¡Œy_basic_index = x[0]# (1) åŸºäºåŸºç¡€ç´¢å¼•è¿›è¡Œè¯»å–çš„è¿”å›å¼ é‡å’Œxå…±äº«åº•å±‚å­˜å‚¨assert y_basic_index.data_ptr() == x.data_ptr()# ä½¿ç”¨æ•´æ•°å¼ é‡å¯¹xè¿›è¡Œé«˜çº§ç´¢å¼•ï¼Œè¿”å›ä½ç½®åœ¨[0, 2], [1, 3], [2, 4]ä½ç½®çš„å…ƒç´ z_adv_index_int = x[torch.tensor([0, 1, 2]), torch.tensor([2, 3, 4])]# z_adv_index_int = tensor([ 2, 23, 44])# å¯¹å¼ é‡xä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…ƒç´ çš„å€¼å°äº10ï¼Œåˆ™å¯¹åº”ä½ç½®çš„indä¸ºTrueï¼Œå¦åˆ™ä¸ºFalseind = x &lt; 10# ä½¿ç”¨å¸ƒå°”å¼ é‡å¯¹xè¿›è¡Œé«˜çº§ç´¢å¼•ï¼Œè¿”å›xä¸­æ‰€æœ‰å¯¹åº”indä½ç½®ä¸ºTrueçš„å…ƒç´ z_adv_index_bool = x[ind]# z_adv_index_bool = tensor([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])# (2) åŸºäºé«˜çº§ç´¢å¼•è¿›è¡Œè¯»å–çš„è¿”å›å¼ é‡å’Œxçš„åº•å±‚å­˜å‚¨æ˜¯åˆ†å¼€çš„assert z_adv_index_int.data_ptr() != x.data_ptr()assert z_adv_index_bool.data_ptr() != x.data_ptr()</code></pre> #### èµ‹å€¼æ“ä½œå¼ é‡èµ‹å€¼æ“ä½œæ˜¯æŒ‡ä½¿ç”¨åŸºç¡€ç´¢å¼•ã€é«˜çº§ç´¢å¼•ã€å¹¿æ’­ç­‰æ–¹å¼å°†æ–°çš„å€¼èµ‹ç»™å¼ é‡çš„ç‰¹å®šä½ç½®ã€‚èµ‹å€¼æ“ä½œç›´æ¥ä¿®æ”¹è¾“å…¥å¼ é‡çš„å†…å®¹ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚<pre class="line-numbers language-python" data-language="python"><code class="language-python">import torch# åˆ›å»ºä¸€ä¸ª10*20çš„å¼ é‡, ä½¿ç”¨contiguous()ç¡®ä¿å…¶è¿ç»­æ€§x = torch.arange(200).reshape(10, 20).contiguous()# å¯¹å¼ é‡xä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…ƒç´ çš„å€¼å°äº10ï¼Œåˆ™å¯¹åº”ä½ç½®çš„indä¸º Trueï¼Œå¦åˆ™ä¸ºFalseind = x &lt; 10# é€šè¿‡é«˜çº§ç´¢å¼•å¯¹xçš„éƒ¨åˆ†å…ƒç´ è¿›è¡Œèµ‹å€¼x[ind] = 1.0print(x)  # xçš„å¯¹åº”ä½ç½®ä¹Ÿè¢«æ›´æ–°æˆ1.0</code></pre> ### ç®—å­çš„è°ƒç”¨ ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹åˆ†æä¸€ä¸‹PyTorchä¸­y = x1 @x2åœ¨æ•´ä¸ªè°ƒç”¨ä¸­å¤§è‡´ç»å†äº†å“ªäº›è¿‡ç¨‹ï¼š <pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchx1 = torch.rand(32, 32, dtype=torch.float32, device="cuda:0")x2 = torch.rand(32, 32, dtype=torch.float32, device="cuda:0")y = x1 @ x2</code></pre></li><li>(1)å‡½æ•°å…¥å£ï¼šè¿™ä¸ªè¡¨è¾¾å¼ä¼šé¦–å…ˆè°ƒç”¨Pythonä¸­Tensorç±»çš„__matmul__æ–¹æ³•ä½œä¸ºâ€œçŸ©é˜µä¹˜æ³•â€ç®—å­çš„å…¥å£ã€‚</li><li>(2)å®šä½ç®—å­ï¼šPyTorchæ ¸å¿ƒçš„<strong>åˆ†å‘ç³»ç»Ÿ(dispatcher)</strong>ä¼šæ ¹æ®ç®—å­ç±»å‹ã€è¾“å…¥å¼ é‡çš„æ•°æ®ç±»å‹ã€å­˜å‚¨åç«¯æ¥æ‰¾åˆ°å¯ä»¥æ‰¿æ‹…è¯¥ç®—å­è®¡ç®—çš„<strong>åº•å±‚ç®—å­å®ç°</strong>ã€‚æ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œåˆ†å‘ç³»ç»Ÿæ‰¾åˆ°GPUä¸Šfloat32ç±»å‹çŸ©é˜µä¹˜æ³•è®¡ç®—å¯¹åº”çš„CUDAå‡½æ•°å®ç°ã€‚</li><li>(3)åˆ›å»ºå¼ é‡ï¼šåˆ›å»ºæ‰€éœ€çš„è¾“å‡ºå¼ é‡ã€‚</li><li>(4)åº•å±‚è°ƒç”¨ï¼šè°ƒç”¨æˆ‘ä»¬æ‰¾åˆ°çš„ç®—å­å‡½æ•°ï¼Œè¿›è¡Œç±»å‹è½¬æ¢ã€è¾“å‡ºå¼ é‡çš„åˆ›å»ºç­‰å¿…è¦æ­¥éª¤ï¼Œè®¡ç®—å¹¶å°†ç»“æœå†™å…¥è¾“å‡ºå¼ é‡ã€‚</li><li>(5)å‡½æ•°è¿”å›ï¼šåˆ›å»ºè¾“å‡ºå¼ é‡çš„Pythonå¯¹è±¡å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307190932.png"></li></ul><p>å›¾3-5å±•ç¤ºäº†åœ¨PyTorchè°ƒç”¨ä¸€ä¸ªçŸ©é˜µä¹˜æ³•ç®—å­çš„è°ƒç”¨æ ˆï¼Œè¿™é‡Œé¢æœ€æ ¸å¿ƒçš„æ­¥éª¤æ˜¯åº•å±‚è°ƒç”¨ä¹Ÿå°±æ˜¯ç®—å­è®¡ç®—ï¼Œä½†æ˜¯å‰åè¿˜åšäº†ä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œï¼Œè¿™äº›å‡†å¤‡å·¥ä½œç»Ÿä¸€ç§°ä¸º<strong>è°ƒç”¨å»¶è¿Ÿ</strong>ã€‚è™½ç„¶å°‘æ•°ç®—å­çš„è°ƒç”¨å»¶è¿Ÿå¯ä»¥æ¥å—ï¼Œä½†å¦‚æœé¢‘ç¹è°ƒç”¨ç®—å­ï¼Œåˆ™ç´¯ç§¯èµ·æ¥çš„æ€»è°ƒç”¨å»¶è¿Ÿå°±ä¸èƒ½å¿½è§†äº†ã€‚åç»­é€šè¿‡<strong>CUDA Graph</strong>é™ä½è°ƒç”¨å»¶è¿Ÿã€‚</p><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­åº”è¯¥ç´§ç»·ä¸€æ ¹å¼¦ï¼Œå°½é‡å‡å°‘ä¸å¿…è¦çš„æ“ä½œï¼Œå¦‚<strong>èƒ½å¯¹å¼ é‡æ•´ä½“è¿›è¡Œæ“ä½œçš„æ—¶å€™å°½é‡é¿å…æ‰‹åŠ¨æ“ä½œæ•°ç»„ä¸­çš„å•ä¸ªå…ƒç´ </strong>ã€‚å› ä¸ºå•ä¸ªæ•°ç»„å…ƒç´ çš„è¯»å–å’Œèµ‹å€¼éƒ½æ˜¯ä¸€æ¬¡ç®—å­è°ƒç”¨ã€‚æ¯”å¦‚å¯¹äºå¼ é‡åŠ å’Œè¿ç®—ï¼Œå¦‚æœé€šè¿‡åœ¨Pythonä¸­æ‰‹å†™å¾ªç¯æ¥å®Œæˆâ€œè¯»å–å•ä¸ªå…ƒç´ â†’åŠ å’Œâ†’å­˜å‚¨å›å¼ é‡â€è¿™ä¸ªè¿‡ç¨‹ï¼Œæ‰€éœ€è¦çš„è®¡ç®—æ—¶é—´è¦è¿œè¿œé«˜äºç›´æ¥ä½¿ç”¨å¼ é‡çš„åŠ æ³•æ“ä½œã€‚è¿™æ˜¯å› ä¸ºå¼ é‡çš„åŠ æ³•å’Œå½’çº¦æ“ä½œèƒ½å¤Ÿå……åˆ†åœ°åˆ©ç”¨GPUçš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼Œåœ¨æ€§èƒ½ä¸Šä¼šæ˜¾è‘—ä¼˜äºå¯¹å•ä¸ªå¼ é‡å…ƒç´ è¿›è¡Œçš„ä¸²è¡Œæ“ä½œã€‚</p><h2 id="pytorchåŠ¨æ€å›¾æœºåˆ¶">PytorchåŠ¨æ€å›¾æœºåˆ¶</h2><h3 id="è®¡ç®—å›¾">è®¡ç®—å›¾</h3><p>è®¡ç®—å›¾æ˜¯æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­ç”¨äºæè¿°å’Œæ‰§è¡Œè®¡ç®—è¿‡ç¨‹çš„æŠ½è±¡æ¨¡å‹ï¼šä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼Œå…¶ä¸­çš„èŠ‚ç‚¹(node)ä»£è¡¨å„ç§ç®—å­æ“ä½œï¼Œæ¯”å¦‚åŠ æ³•ã€ä¹˜æ³•æˆ–æ›´å¤æ‚çš„æ“ä½œå¦‚å·ç§¯ç­‰ï¼Œè€Œè¾¹(edge)åˆ™ä»£è¡¨æ•°æ®ï¼ˆæŒ‡å¼ é‡æ•°æ®ï¼‰çš„æµåŠ¨ã€‚### åŠ¨æ€å›¾ä¸é™æ€å›¾çš„åŒºåˆ« - åŠ¨æ€å›¾ï¼šè¿è¡Œæ—¶æ„å»º </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchx = torch.tensor(2)  # å¯ä»¥å°è¯•ä¸åŒçš„å€¼ï¼Œå¦‚ torch.tensor(1.0)y = x % 2if y == 0:    z = x * 10else:    z = x + 10print(z)</code></pre> -é™æ€å›¾ï¼šè¿è¡Œå‰æ„å»ºï¼Œè¿è¡Œæ—¶ä¸èƒ½ä¿®æ”¹(TensorFlow æ—©æœŸç‰ˆæœ¬) <pre class="line-numbers language-python" data-language="python"><code class="language-python">import tensorflow.compat.v1 as tfx = tf.placeholder(tf.float32, shape=())def true_fn():    return tf.multiply(x, 10)def false_fn():    return tf.add(x, 10)y = x % 2z = tf.cond(tf.equal(y, 0), true_fn, false_fn)with tf.Session() as sess:    print(sess.run(z, feed_dict={x: 2}))  # è¾“å‡º 10 (2 * 10)    print(sess.run(z, feed_dict={x: 1}))  # è¾“å‡º 11 (1 + 10)</code></pre>å¯ä»¥æ³¨æ„åˆ°ï¼ŒTensorFlow1.0çš„ä»£ç é€»è¾‘éœ€è¦å®Œå…¨ç”±TensorFlowçš„æ¥å£æ‹¼æ¥è€Œæˆï¼Œä¸åŸç”Ÿçš„Pythonä»£ç å†™æ³•æœ‰å¾ˆå¤§å·®åˆ«â€”â€”å†™çš„è™½ç„¶æ˜¯Pythonè¯­è¨€ï¼Œä½†æ˜¯å´ä¸é‚£ä¹ˆâ€œPythonicâ€â€‹ã€‚é™¤æ­¤ä»¥å¤–ï¼Œä»£ç ä¸­çš„å¼ é‡yã€zåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œéƒ½åªæ˜¯å•çº¯çš„ç¬¦å·ï¼Œæ²¡æœ‰å…·ä½“çš„æ•°å€¼ï¼Œä¹Ÿå› æ­¤æ²¡æœ‰åŠæ³•æ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªæƒ…å†µä¸€ç›´æŒç»­åˆ°åœ¨TensorFlowçš„ä¼šè¯(tf.Session)ä¸­ï¼Œ<strong>é€šè¿‡sess.run()æ‰§è¡Œæ„å»ºå‡ºæ¥çš„è®¡ç®—å›¾ã€‚è®¡ç®—å›¾ä¸€æ—¦è¢«æ‰§è¡Œåæ‰ä¼šå¾€yã€zä¸­å¡«å…¥æ•°å€¼</strong>ã€‚ä½†æ˜¯è¿™æ—¶å€™è®¡ç®—å›¾å·²ç»å®Œå…¨å›ºå®šä¸‹æ¥äº†ï¼Œåç»­ä¸èƒ½å†ç»§ç»­å¯¹xã€yã€zè¿›è¡Œä»»ä½•ä¿®æ”¹äº†ã€‚<p></p><h4 id="å·®åˆ«">å·®åˆ«</h4><ul><li>(1)æ‰§è¡Œæ–¹å¼ï¼šé™æ€å›¾æœ‰æ˜ç¡®å›¾çš„å®šä¹‰å’Œå›¾çš„è¿è¡Œä¸¤ä¸ªé˜¶æ®µã€‚è€ŒåŠ¨æ€å›¾åˆ™æ˜¯åœ¨å®šä¹‰çš„åŒæ—¶å°±æ‰§è¡Œï¼Œç«‹å³å¾—åˆ°ç»“æœã€‚ä¾‹å¦‚ï¼Œåœ¨TensorFlowä¸­ï¼Œy= x %2åªæ˜¯å‘è®¡ç®—å›¾ä¸­æ·»åŠ ä¸€ä¸ªè¿ç®—èŠ‚ç‚¹ï¼Œè¯¥è¿ç®—ä¸ä¼šç«‹å³æ‰§è¡Œã€‚ä½†åœ¨åŠ¨æ€å›¾ä¸­ï¼Œè¿™ä¸ªè¯­å¥åœ¨æ·»åŠ èŠ‚ç‚¹çš„åŒæ—¶ä¹Ÿæ‰§è¡Œäº†è¯¥è¿ç®—ã€‚</li><li>(2)æ•°æ®è¡¨ç¤ºï¼šåœ¨é™æ€å›¾çš„å®šä¹‰é˜¶æ®µï¼Œxã€yã€zéƒ½æ˜¯ç¬¦å·ï¼Œä¸å«å…·ä½“æ•°æ®ã€‚åªæœ‰åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬æ‰å¯¹è¾“å…¥xèµ‹å€¼ã€‚è€Œåœ¨PyTorchçš„ä»£ç ä¸­ï¼Œxã€yã€zä¸€å¼€å§‹å°±æ˜¯å¸¦æœ‰å…·ä½“æ•°æ®çš„å¼ é‡ã€‚</li><li>(3)ä¸­æ–­ä¸è°ƒè¯•ï¼šé™æ€å›¾ä¸€æ—¦è¿è¡Œå°±ä¸èƒ½ä¸­æ–­ã€‚è¦åœ¨é™æ€å›¾ä¸­æ‰“å°ä¸­é—´å˜é‡yçš„å€¼è¿›è¡Œè°ƒè¯•ï¼Œ<strong>éœ€è¦æ’å…¥tf.Print()è¯­å¥å¹¶é‡æ–°è¿è¡Œå›¾</strong>ã€‚ä½†æ˜¯åœ¨PyTorchä¸­ï¼Œæ‰§è¡Œè¿‡ç¨‹å¯ä»¥ä¸­æ–­ï¼Œæ¯”å¦‚å¯ä»¥ç”¨importpdb; pdb.set_trace()ä½¿è¿è¡Œæš‚åœï¼Œå¹¶å¯ä»¥è‡ªç”±åœ°æ‰“å°æˆ–ä¿®æ”¹å¼ é‡çš„å†…å®¹ã€‚</li><li>(4)ä»£ç æ‰§è¡Œï¼šåœ¨TensorFlow1.0ä¸­ï¼Œè®¡ç®—å›¾çš„æ‰§è¡Œå…¨éƒ½æ˜¯ç”±TensorFlowçš„åº•å±‚è¿è¡Œå¤„ç†çš„â€”â€”åŒ…æ‹¬printè¯­å¥å’Œæ¡ä»¶è¯­å¥åœ¨å†…ã€‚è€Œåœ¨PyTorchä»£ç ä¸­ï¼Œæ¡ä»¶è¯­å¥å’Œprintè¯­å¥æ˜¯ç”±Pythonè§£é‡Šå™¨æ‰§è¡Œçš„ï¼Œåªæœ‰ä¸å¼ é‡ç›¸å…³çš„æ“ä½œæ˜¯ç”±PyTorchçš„è¿è¡Œå¤„ç†çš„ã€‚è¿™ç§è®¾è®¡ä¿æŒäº†Pythonä½œä¸ºè§£é‡Šå‹è¯­è¨€çš„çµæ´»æ€§ï¼Œä»è€Œå¯ä»¥æ”¯æŒåŠ¨æ€ä¿®æ”¹ä»£ç å’Œäº¤äº’å¼ç¼–ç¨‹ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307204736.png"></li></ul><p>ç”±äºé™æ€å›¾åœ¨æ‰§è¡Œå‰å°±è·å¾—äº†å®Œæ•´çš„å›¾ä¿¡æ¯ï¼Œä½¿å¾—å®ƒèƒ½å¤Ÿåº”ç”¨æ›´å¤æ‚çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¦‚ç§»é™¤æ— ç”¨æ“ä½œã€è¿›è¡Œè·¨æ“ä½œä¼˜åŒ–ï¼Œç”šè‡³æ‰§è¡Œç®—å­èåˆç­‰ã€‚å¯¹äºè¿½æ±‚æè‡´æ€§èƒ½çš„éƒ¨ç½²å·¥ç¨‹å¸ˆæ¥è¯´ï¼ŒåƒTensorFlow1.0è¿™æ ·çš„æ¡†æ¶ä»ç„¶æ˜¯é¦–é€‰ä¹‹ä¸€ã€‚è€Œå¯¹äºç ”ç©¶äººå‘˜ï¼Œå¿«é€Ÿè¿­ä»£å’Œæ˜“äºè°ƒè¯•çš„ç‰¹æ€§ä½¿å¾—PyTorchå…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ã€‚</p><h2 id="pytorch-çš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿ">Pytorch çš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿ</h2><h3 id="è‡ªåŠ¨å¾®åˆ†">è‡ªåŠ¨å¾®åˆ†</h3><ul><li><p>åŸºäºæœ‰é™å·®åˆ†çš„æ•°å€¼å¾®åˆ†æ³•ï¼šé€šè¿‡å¯¹è¾“å…¥å˜é‡æ·»åŠ ä¸€ä¸ªå¾®å°æ‰°åŠ¨ï¼Œæ¯”å¦‚è®¾å®šh=0.000001ï¼Œç„¶åè§‚å¯Ÿè¾“å‡ºçš„å˜åŒ–æ¥è¿‘ä¼¼è®¡ç®—æ¢¯åº¦å€¼ã€‚ç²¾åº¦ä¸é«˜ï¼Œä½†æ˜¯å®ç°ç®€å•ã€‚</p></li><li><p>åŸºäºç¬¦å·å¾®åˆ†çš„æ¢¯åº¦æ±‚å¯¼å…¬å¼ï¼šåŸºäºå°é—­å½¢å¼è¡¨è¾¾å¼(closed-formexpression)çš„æ¢¯åº¦æ±‚å¯¼å…¬å¼ã€‚ä½†æ˜¯å¯¹äºç¨‹åºä¸­æ¶‰åŠåŸºäºåŠ¨æ€è¾“å…¥æˆ–æ¡ä»¶å˜åŒ–çš„å¾ªç¯ã€å¤æ‚é€’å½’ã€åŠ¨æ€å†…å­˜åˆ†é…åŠæ¶‰åŠå¤§é‡éçº¿æ€§æ•°æ®å¤„ç†ç­‰å¤æ‚é€»è¾‘ï¼Œå°†å…¶è½¬åŒ–ä¸ºå°é—­å½¢å¼é€šå¸¸æ˜¯ä¸å¯èƒ½çš„ã€‚å› æ­¤ï¼Œå°½ç®¡ç¬¦å·å¾®åˆ†åœ¨è®¡ç®—æ•ˆç‡ä¸Šéå¸¸é«˜ï¼Œå…¶é€‚ç”¨æ€§å´å—åˆ°å¾ˆå¤§é™åˆ¶ã€‚</p></li></ul><p>è€Œè‡ªåŠ¨å¾®åˆ†(automaticdifferentiation)åˆ™æ˜¯ä¸€ç§ä»‹äºæ•°å€¼å¾®åˆ†å’Œç¬¦å·å¾®åˆ†ä¹‹é—´çš„æ–¹æ³•ï¼š -(1)å®ƒå®šä¹‰äº†ä¸€ç³»åˆ—çš„â€œåŸºæœ¬æ“ä½œâ€â€‹ï¼ˆå¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤ï¼‰â€‹ï¼Œå¹¶ä¸”æ ¹æ®æ‰‹åŠ¨æ¨å¯¼çš„ç»“æœå®šä¹‰äº†è¿™äº›æ“ä½œçš„æ¢¯åº¦ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰‹åŠ¨æ¨å¯¼z=yÃ—xçš„å¾®åˆ†å½¢å¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°<span class="math inline">\(\frac{\partial z}{\partial x} = y\)</span>ç±»ä¼¼è¿™æ ·çš„åŸºç¡€æ“ä½œæ¢¯åº¦å…¬å¼ä¼šè¢«ç¡¬ç¼–ç åœ¨è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿä¸­ï¼Œæ˜¯å®ƒçš„æ ¸å¿ƒç»„æˆå…ƒç´ ã€‚-(2)åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œè‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿä¼šåŸºäºé“¾å¼æ³•åˆ™å°†å¤æ‚è¿ç®—æ‹†è§£æˆåŸºç¡€æ“ä½œçš„ç»„åˆï¼Œä¸€æ­¥æ­¥è®¡ç®—æ‰€æœ‰ä¸­é—´ç»“æœçš„æ¢¯åº¦ï¼Œå¹¶æœ€ç»ˆè®¡ç®—å‡ºè¾“å…¥å‚æ•°çš„æ¢¯åº¦ã€‚æ³¨æ„åœ¨è¿ç®—è¿‡ç¨‹ä¸­å¯¹äºåŒä¸€ä¸ªå¼ é‡çš„æ¢¯åº¦æ˜¯ç´¯åŠ è€Œä¸æ˜¯è¦†å†™çš„ã€‚è€Œä¸”è¿™é‡Œç´¯åŠ çš„æ˜¯å…·ä½“æ•°å€¼è€Œéç¬¦å·è¡¨è¾¾å¼ï¼Œè¿™ä¸€ç‚¹è‡³å…³é‡è¦ï¼Œå®ƒä½¿å¾—è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿèƒ½å¤Ÿè‡ªç„¶åœ°å…¼å®¹ç¨‹åºä¸­å‡ºç°çš„é€»è¾‘åˆ¤æ–­ï¼Œå¦‚åˆ†æ”¯ã€å¾ªç¯å’Œé€’å½’ç­‰ï¼Œè€Œè¿™å¯¹ç¬¦å·å¾®åˆ†ç³»ç»Ÿæ˜¯éå¸¸å›°éš¾çš„ã€‚</p><h3 id="è‡ªåŠ¨å¾®åˆ†çš„å®ç°">è‡ªåŠ¨å¾®åˆ†çš„å®ç°</h3><p>PyTorchçš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿä¸­é»˜è®¤ä½¿ç”¨<strong>åå‘å¾®åˆ†æ¨¡å¼</strong>ã€‚å®ƒä»¥æŸä¸ªè¾“å‡ºå¼ é‡çš„æ¢¯åº¦ä½œä¸ºèµ·ç‚¹ï¼Œåå‘é€å±‚è®¡ç®—å‡ºæ¯ä¸ªè¾“å…¥å‚æ•°å¯¹åº”çš„æ¢¯åº¦ï¼Œè®¡ç®—å›¾çš„æ‰§è¡Œæ¬¡æ•°ä¸è¾“å‡ºå¼ é‡çš„æ•°é‡æœ‰å…³â€”â€”Mä¸ªè¾“å‡ºå¼ é‡å°±éœ€è¦æ‰§è¡ŒMæ¬¡è®¡ç®—å›¾ã€‚ç»å¤§å¤šæ•°æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„åœºæ™¯éƒ½æ˜¯æœ‰w1,w2,...,wNä¸ªæ¨¡å‹å‚æ•°ï¼Œä½†åªæœ‰æ•°ä¸ªç”šè‡³ä¸€ä¸ªæŸå¤±å‡½æ•°(loss)ã€‚</p><p>è¿˜æœ‰ä¸€ç§<strong>å‰å‘æ¨¡å¼çš„è‡ªåŠ¨å¾®åˆ†</strong>ã€‚å®ƒä»¥æŸä¸ªè¾“å…¥å‚æ•°çš„æ¢¯åº¦ä½œä¸ºèµ·ç‚¹ï¼Œå‘å‰é€å±‚è®¡ç®—å‡ºæ¯ä¸ªè¾“å‡ºå¼ é‡å¯¹åº”çš„æ¢¯åº¦ï¼Œè®¡ç®—å›¾çš„æ‰§è¡Œæ¬¡æ•°ä¸è¾“å…¥å‚æ•°çš„æ•°é‡æœ‰å…³â€”â€”Nä¸ªè¾“å…¥å‚æ•°å°±éœ€è¦æ‰§è¡ŒNæ¬¡è®¡ç®—å›¾ã€‚æ‰€ä»¥å‰å‘å¾®åˆ†é€‚åˆè¾“å…¥å‚æ•°å°‘è€Œè¾“å‡ºå¼ é‡å¤šçš„åœºæ™¯ï¼Œæ¯”å¦‚æ¨¡å‹åªæœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°wï¼Œä½†æ˜¯è¾“å‡ºMä¸ªlossçš„æƒ…å†µï¼Œè¿™ä¸€èˆ¬å¤šè§äºç§‘å­¦è®¡ç®—ç›¸å…³çš„åœºæ™¯ï¼Œå°¤å…¶åœ¨è®¡ç®—é«˜é˜¶å¯¼æ•°æ—¶ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307211040.png"></p><p>PyTorchè‡ªåŠ¨å¾®åˆ†æœºåˆ¶ä¾èµ–äºtorch.Tensorä¸Šçš„ä¸¤ä¸ªé¢å¤–å±æ€§ï¼Œå³gradå’Œrequires_gradã€‚- gradï¼šå­˜å‚¨äº†å¼ é‡å¯¹åº”çš„æ¢¯åº¦å€¼ï¼Œåˆå§‹å€¼ä¸ºNoneã€‚ -requires_gradï¼šè¡¨ç¤ºæ˜¯å¦éœ€è¦è®¡ç®—æ¢¯åº¦ã€‚</p><h3 id="ç¤ºä¾‹">ç¤ºä¾‹ï¼š</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torch# åˆ›å»ºä¸€ä¸ªéœ€è¦è®¡ç®—æ¢¯åº¦çš„å¼ é‡x = torch.tensor([1.0, 2.0, 3.0], requires_grad=True)# å‰å‘ä¼ æ’­ï¼š# 1. æ„å»ºå¹¶æ‰§è¡Œå‰å‘å›¾# 2. æ„å»ºåå‘å›¾t = x * 10z = t * tloss = z.mean()# åå‘ä¼ æ’­ï¼Œè®¡ç®—æ¢¯åº¦loss.backward()# æŸ¥çœ‹xçš„æ¢¯åº¦print(x.grad)</code></pre><p>æ³¨æ„æ¯ä¸€ä¸ªç®—å­åœ¨å‰å‘è°ƒç”¨æ—¶ï¼Œå°±ä¼šå½“åœºåœ¨åå‘å›¾ä¸­æ„å»ºä¸€ä¸ªåå‘ç®—å­ï¼Œå‰å‘è®¡ç®—å›¾æ˜¯å½“åœºæ„å»ºã€å½“åœºæ‰§è¡Œçš„ï¼Œä½†åå‘è®¡ç®—å›¾åˆ™æ˜¯å½“åœºæ„å»ºã€å»¶è¿Ÿæ‰§è¡Œçš„â€”â€”ç›´åˆ°æˆ‘ä»¬è°ƒç”¨loss.backward()æ—¶æ‰ä¼šå¼€å§‹æ‰§è¡Œåå‘å›¾ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307212745.png"></p><p>éœ€è¦æ³¨æ„æ¢¯åº¦æ˜¯ç´¯åŠ çš„ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨backward()ï¼Œæ¯æ¬¡è°ƒç”¨è®¡ç®—å‡ºçš„æ¢¯åº¦ä¹Ÿä¼šç´¯ç§¯åˆ°å¯¹åº”å¼ é‡çš„gradå±æ€§ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨æ¯è½®è®­ç»ƒå¾ªç¯å¼€å§‹å‰è°ƒç”¨optimizer.zero_grad()æ¥æ‰‹åŠ¨æ¸…é›¶æ¢¯åº¦çš„åŸå› ã€‚</p><h3 id="autogradæ‰©å±•è‡ªå®šä¹‰ç®—å­">Autogradæ‰©å±•è‡ªå®šä¹‰ç®—å­</h3><p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬é‡åˆ°éœ€è¦ä½¿ç”¨ä¸€äº›éæ ‡å‡†æˆ–ç‰¹æ®Šçš„æ•°å­¦æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œåˆä¸åœ¨PyTorchåº“çš„æ”¯æŒèŒƒå›´å†…æ—¶ï¼Œå¯ä»¥åˆ©ç”¨PyTorchè‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿæä¾›çš„æ‰©å±•æ¨¡å—æ¥è‡ªå®šä¹‰æ–°çš„ç®—å­ã€‚æ–°å®šä¹‰çš„æ“ä½œèƒ½å¤ŸåƒPyTorchä¸­çš„ä»»ä½•å…¶ä»–æ“ä½œä¸€æ ·è¢«ä½¿ç”¨ï¼Œå¹¶èƒ½è‡ªç„¶è€Œç„¶åœ°èå…¥PyTorchçš„è‡ªåŠ¨å¾®åˆ†æœºåˆ¶ä¸­ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡å¦‚æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªè®¡ç®— <span class="math inline">\(input1\times input1 \times input2\)</span> çš„ç®—å­ï¼Œå…¶å®ç°æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchclass MyMul(torch.autograd.Function):    @staticmethod    def forward(ctx, input1, input2):        ctx.save_for_backward(input1, input2)        return input1 * input1 * input2    @staticmethod    def backward(ctx, grad_output):        input1, input2 = ctx.saved_tensors        grad_input1 = grad_output * 2 * input1 * input2        grad_input2 = grad_output * input1 * input1        return grad_input1, grad_input2# ä½¿ç”¨è‡ªå®šä¹‰çš„ä¹˜æ³•æ“ä½œx = torch.tensor([2.0, 3.0], requires_grad=True)y = torch.tensor([3.0, 4.0], requires_grad=True)z = MyMul.apply(x, y)z.backward(torch.tensor([1.0, 1.0]))print(f"x.grad={x.grad}, y.grad={y.grad}")# x.grad=tensor([12., 24.]), y.grad=tensor([4., 9.])</code></pre><p></p><h3 id="pytorchçš„å¼‚æ­¥æ‰§è¡Œ">Pytorchçš„å¼‚æ­¥æ‰§è¡Œ</h3><p>PyTorchæ”¯æŒä¸åŒçš„è®¡ç®—åç«¯ï¼Œæ¨¡å‹è®­ç»ƒä¸»è¦ä¾èµ–å…¶ä¸­çš„CPUå’ŒGPUåç«¯ã€‚åœ¨ä½¿ç”¨PyTorchçš„ä¸åŒè®¡ç®—åç«¯æ—¶ï¼Œä¸»è¦ä¼šå½±å“ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š -<strong>å¼ é‡çš„å­˜å‚¨ä½ç½®</strong>ã€‚ - <strong>ç®—å­çš„æ‰§è¡Œç¡¬ä»¶</strong>ã€‚ -<strong>æ‰§è¡Œæœºåˆ¶</strong>ã€‚</p><p>å‰ä¸¤è€…æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼šä½¿ç”¨CPUåç«¯æ—¶å¼ é‡å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œç®—å­åœ¨CPUä¸Šæ‰§è¡Œï¼›è€Œä½¿ç”¨GPUåç«¯æ—¶å¼ é‡å­˜æ”¾åœ¨æ˜¾å­˜é‡Œï¼Œç®—å­åœ¨GPUä¸Šæ‰§è¡Œã€‚ä½†æ˜¯ç¬¬ä¸‰ç‚¹â€œæ‰§è¡Œæœºåˆ¶â€çš„å˜åŒ–åˆ™æ›´ä¸ºå¤æ‚ã€‚ #### CPUåç«¯æ‰§è¡Œæœºåˆ¶æ¯ä¸€ä¸ªPythonæŒ‡ä»¤éƒ½å¯¹åº”ä¸€ä¸ªCPUç®—å­ä»»åŠ¡ã€‚æ¯ä¸ªç®—å­åœ¨CPUä¸Šå®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼Œå¾—åˆ°è¾“å‡ºç»“æœåï¼Œæ‰è·³è½¬åˆ°ä¸‹ä¸€æ¡PythonæŒ‡ä»¤ï¼Œå¼€å§‹æ‰§è¡Œåç»­çš„ç®—å­ä»»åŠ¡ã€‚è¿™ç§æ‰§è¡Œæœºåˆ¶è¢«ç§°ä¸º<strong>åŒæ­¥æ‰§è¡Œæœºåˆ¶</strong>ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307224514.png">#### GPUåç«¯æ‰§è¡Œæœºåˆ¶PyTorchä¹Ÿåªä¼šæŠŠæ ¸å¿ƒçš„ç®—å­è®¡ç®—ä»»åŠ¡æ”¾åœ¨GPUä¸Šï¼Œè€Œç±»å‹æå‡ã€è¾“å‡ºä¿¡æ¯æ¨å¯¼ã€è¾“å‡ºå¼ é‡çš„åˆ›å»ºã€å®šä½ç®—å­ç­‰ä»»åŠ¡ä¾ç„¶è¿˜ç•™åœ¨CPUä¸Šã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307224705.png"></p><p>GPUå†…éƒ¨ç»´æŠ¤äº†ä¸€ç³»åˆ—ä»»åŠ¡é˜Ÿåˆ—(stream)ï¼ŒCPUä¼šå°†ç®—å­ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯ä¸€ä¸ªCUDAå‡½æ•°ï¼‰æäº¤åˆ°GPUçš„ä»»åŠ¡é˜Ÿåˆ—ä¸Šï¼Œä¹‹åå°±å¯ä»¥æ’’æ‰‹ä¸ç®¡äº†ï¼ŒGPUä¼šè‡ªè¡Œä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ä¾æ¬¡æ‹¿å‡ºè®¡ç®—ä»»åŠ¡ç„¶åæ‰§è¡Œã€‚ä¸ä»…å¦‚æ­¤ï¼ŒCPUå°†ç®—å­ä»»åŠ¡æäº¤ç»™GPUä¹‹åï¼Œä¸ä¼šç­‰GPUå®Œæˆè®¡ç®—ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å¹¶å¼€å§‹æ‰§è¡Œä¸‹ä¸€æ¡PythonæŒ‡ä»¤ã€‚è¿™ç§æ‰§è¡Œæœºåˆ¶è¢«ç§°ä¸º<strong>å¼‚æ­¥æ‰§è¡Œæœºåˆ¶</strong>ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307225018.png">#### è¿è¡Œæ—¶é—´é™·é˜±å¦‚æœæˆ‘ä»¬åœ¨CPUä»»åŠ¡ç»“æŸåç«‹å³åœæ­¢è®¡æ—¶ï¼Œå¹¶æƒŠè®¶åœ°å‘ç°ç¨‹åºè¿è¡Œå¾—å‡ºå¥‡åœ°å¿«ï¼Œè¿™å°±ä¸å…ä¸­äº†CPUçš„åœˆå¥—ã€‚å¦‚å›¾3-13æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬æ‰“å°å‡ºâ€œCPUFinishedâ€çš„æ—¶å€™ï¼ŒGPUè¿˜åœ¨åå°é»˜é»˜åœ°è´Ÿé‡å‰è¡Œå‘¢ã€‚ ä¸Šè¿°CPU -GPUååŒå·¥ä½œæœºåˆ¶è¢«ç§°ä¸ºå¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œå…¶æ ¸å¿ƒç‰¹ç‚¹åœ¨äºCPUæäº¤ä»»åŠ¡ç»™GPUåï¼Œä¸ç­‰å¾…GPUä»»åŠ¡å®Œæˆè€Œç›´æ¥è¿”å›ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªCPUä»»åŠ¡æˆ–ä¸‹ä¸€æ¡Pythonä»£ç ã€‚ç„¶è€Œåœ¨å¾ˆå¤šä»»åŠ¡ä¸­æˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›ç­‰å¾…GPUå®Œæˆè®¡ç®—çš„ï¼ŒåŒ…æ‹¬è€Œä¸é™äºæµ‹è¯•ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€æ‰“å°è®¡ç®—ç»“æœç­‰ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨è°ƒç”¨PyTorchæä¾›çš„CPU-GPUåŒæ­¥æ¥å£ï¼Œæ¯”å¦‚<strong>torch.cuda.synchronize()</strong>ï¼Œå¦‚å›¾3-14æ‰€ç¤ºã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250307225226.png"></p><p>é™¤äº†æ¥è‡ªç”¨æˆ·çš„æ‰‹åŠ¨æ˜¾å¼è°ƒç”¨åŒæ­¥æ“ä½œï¼ŒPyTorchçš„ä¸€äº›æ“ä½œä¹Ÿä¼šéšå¼åœ°è°ƒç”¨åŒæ­¥æ“ä½œã€‚æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬è°ƒç”¨torch.nn.functional.softmax()æ—¶ï¼ŒPyTorchä¼šè‡ªåŠ¨å°†è®¡ç®—ä»»åŠ¡æäº¤ç»™GPUï¼Œå¹¶éšå¼åœ°è°ƒç”¨torch.cuda.synchronize()ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> PyTorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“-æ·±åº¦å­¦ä¹ å¿…å¤‡ç¡¬ä»¶çŸ¥è¯†</title>
      <link href="/2025/03/06/da-mo-xing-dong-li-yin-qing-shen-du-xue-xi-bi-bei-ying-jian-zhi-shi/"/>
      <url>/2025/03/06/da-mo-xing-dong-li-yin-qing-shen-du-xue-xi-bi-bei-ying-jian-zhi-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="gpuä¸å†…å­˜">GPUä¸å†…å­˜</h2><p>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„åŸºç¡€è®¡ç®—å•å…ƒæ˜¯"ç®—å­"ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†è¾“å…¥æ˜ å°„ä¸ºè¾“å‡ºçš„è®¡ç®—è¿‡ç¨‹ï¼Œå¯¹äºå¤è€çš„CPU-å†…å­˜ä½“ç³»æ¥è¯´ï¼Œç®—å­éµå¾ªä¸€ä¸‹æ­¥éª¤ï¼š- ä»å†…å­˜ä¸­è¯»å–è¾“å…¥æ•°æ® - å¯¹ç‹¬åˆ°çš„æ•°æ®è°ƒç”¨CPUæŒ‡ä»¤ï¼Œå®Œæˆç®—å­è®¡ç®— -å°†è®¡ç®—ç»“æœå†™å›å†…å­˜</p><h3 id="å†…å­˜">å†…å­˜</h3><p>é€šå¸¸æŒ‡çš„æ˜¯éšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆRAMï¼‰ï¼Œâ€œéšæœºâ€æ„å‘³ç€è®¿é—®ä»»ä½•ä½ç½®çš„æ•°æ®æ‰€éœ€çš„æ—¶é—´æ˜¯ç›¸åŒçš„ï¼Œä¸ä½ç½®æ— å…³ã€‚RANå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š -é™æ€éšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆSRAMï¼‰ï¼šåŸºäºåŒç¨³æ€è§¦å‘å™¨ï¼ˆbistableflip-flopï¼‰ï¼Œè¯»å–æ—¶ä¸ä¼šä¸¢å¤±æ•°æ®ï¼ˆ<strong>éç ´åæ€§è¯»å–</strong>ï¼‰ã€‚å¸¸ç”¨äºCacheã€‚-åŠ¨æ€éšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆDRAMï¼‰ï¼šåŸºäºç”µå®¹å­˜å‚¨ï¼Œè¯»å–æ•°æ®ä¼šä¸¢å¤±æ•°æ®ï¼Œéœ€è¦é‡å†™ï¼ˆ<strong>ç ´åæ€§è¯»å–</strong>ï¼Œéœ€åˆ·æ–°ï¼‰ã€‚å¸¸ç”¨äºä¸»å­˜ã€‚</p><p>ä¸ç®¡æ˜¯SRAMè¿˜æ˜¯DRAMï¼Œéƒ½æ˜¯ä¸´æ—¶å­˜å‚¨ï¼Œæ–­ç”µåæ•°æ®ä¼šä¸¢å¤±çš„ï¼Œæ•°æ®ä¸ä¼šä¿ç•™ï¼ˆ<strong>æ˜“å¤±æ€§</strong>ï¼‰ã€‚</p><p>åœ¨é€‰ç”¨å†…å­˜æ—¶å¾€å¾€ä¼šçœ‹åˆ°DDR4ã€DDR5ç­‰å­—æ ·ï¼ŒæŒ‡çš„æ˜¯åŸºäºDDRçš„ç¬¬å‡ ä»£äº§å“ï¼Œæ¶‰åŠæŠ€æœ¯æ ‡å‡†ã€èŠ¯ç‰‡ç»“æ„åŠæ§åˆ¶ç®—æ³•çš„å‡çº§ï¼Œä½†æ˜¯è¦çœ‹ä¸»æ¿æ˜¯å¦æ”¯æŒæœ€æ–°ä¸€ä»£å†…å­˜è§„æ ¼ã€‚</p><h3 id="cpu">CPU</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306190238.png">CPUçš„æ ¸å¿ƒç»“æ„åŒ…æ‹¬è´Ÿè´£è®¡ç®—çš„ç®—æ•°é€»è¾‘å•å…ƒ(ALU)ã€è´Ÿè´£åŠ é€Ÿæ•°æ®è¯»å†™é€Ÿåº¦çš„å¤šçº§ç¼“å­˜ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿˜ä¼šé‡‡ç”¨CPUå¤šæ ¸å¿ƒè®¾è®¡æ¥å¢åŠ å¹¶è¡Œåº¦ã€‚</p><h2 id="ç¡¬ç›˜">ç¡¬ç›˜</h2><p>ä¸RAMä¸åŒï¼Œç¡¬ç›˜æ˜¯é•¿æœŸå­˜å‚¨è®¾å¤‡ï¼Œæ–­ç”µåæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæ•°æ®ä¼šä¿ç•™ï¼ˆ<strong>éæ˜“å¤±æ€§</strong>ï¼‰ã€‚ä¸€èˆ¬å¸¸ç”¨çš„ç¡¬ç›˜æœ‰æœºæ¢°ç¡¬ç›˜HDDå’Œå›ºæ€ç¡¬ç›˜SSDã€‚SSDçš„è¯»å†™é€Ÿåº¦è¿œé«˜äºHDDï¼Œä½†æ˜¯ä»·æ ¼ä¹Ÿæ›´é«˜ã€‚</p><p>ç¡¬ç›˜çš„è¯»å†™è¡Œä¸ºå¤§è‡´åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š -éšæœºè¯»å†™æ¨¡å¼ï¼šé«˜é¢‘ç‡è¯»å†™å°è§„æ¨¡æ•°æ®ã€‚IOPSï¼ˆInput/Output Operations PerSecondï¼‰æ˜¯è¡¡é‡ç¡¬ç›˜éšæœºè¯»å†™é€Ÿåº¦çš„æŒ‡æ ‡ã€‚ -è¿ç»­è¯»å†™æ¨¡å¼ï¼šéœ€è¦è¯»å–å¤§æ–‡ä»¶æˆ–é¡ºåºè®¿é—®æ•°æ®ã€‚MB/sï¼ˆMegabytes persecondï¼‰æ˜¯è¡¡é‡ç¡¬ç›˜è¿ç»­è¯»å†™é€Ÿåº¦çš„æŒ‡æ ‡ã€‚</p><p>å…¶ä¸­è¿ç»­è¯»å†™é€Ÿåº¦æœ‰ç¡¬ç›˜è¿ç»­è¯»å†™é€Ÿåº¦å’Œæ•°æ®ä¼ è¾“é€Ÿåº¦å…±åŒå†³å®šã€‚éšç€ç¡¬ç›˜è¯»å–æ•ˆç‡çš„ä¸æ–­æé«˜ï¼Œè¯»å†™æ•ˆç‡çš„ç“¶é¢ˆæ…¢æ…¢å¼€å§‹å‡ºç°åœ¨äº†æ•°æ®ä¼ è¾“é˜¶æ®µï¼Œæ‰€ä»¥åœ¨SATAå›ºæ€ç¡¬ç›˜çš„åŸºç¡€ä¸Šï¼Œåˆå‘å±•å‡ºäº†NVMeå›ºæ€ç¡¬ç›˜ã€‚<strong>NVMeå›ºæ€ç¡¬ç›˜ä½¿ç”¨ä¼ è¾“æ•ˆç‡æ›´é«˜çš„PCIeä¼ è¾“é€šé“</strong>ï¼Œåœ¨è¯»å†™æ€§èƒ½ä¸Šå¾€å¾€è¶…å‡ºSATAå›ºæ€ç¡¬ç›˜è®¸å¤šã€‚</p><h2 id="æ˜¾å¡">æ˜¾å¡</h2><h3 id="cpuå±€é™æ€§">CPUå±€é™æ€§</h3><p>CPUå¯ä»¥â€œå…¨èƒ½â€çš„å¤„ç†å„ç§æŒ‡ä»¤ï¼ˆè®¡ç®—æŒ‡ä»¤ã€è®¿å­˜æŒ‡ä»¤ï¼Œä¹Ÿèƒ½å¤Ÿå¤„ç†å¥½è·³è½¬ç­‰é€»è¾‘æŒ‡ä»¤ï¼‰ï¼Œä½†åœ¨å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ—¶ï¼ŒCPUçš„è®¡ç®—é€Ÿåº¦ä¸å¦‚GPUæˆ–å…¶ä»–å¼‚æ„èŠ¯ç‰‡é«˜æ•ˆã€‚</p><p>å› æ­¤é’ˆå¯¹è®¡ç®—å¯†é›†å‹çš„é¢ä»»åŠ¡ï¼Œåº”è¯¥è®©CPUå¤„ç†å¤æ‚çš„äº¤äº’é€»è¾‘ï¼Œè€Œé‡‡ç”¨ä¸€ä¸ªä¸“é—¨çš„èŠ¯ç‰‡å¤„ç†å¯†é›†çš„è®¡ç®—ï¼Œè¿™éœ€è¦æˆ‘ä»¬åœ¨è½¯ä»¶å±‚é¢ä¸Šå¯¹ç¨‹åºä»»åŠ¡è¿›è¡Œåˆ’åˆ†ï¼Œå°†ä¸€ä¸ªç¨‹åºæ¶‰åŠçš„æ‰€æœ‰ä»»åŠ¡éƒ½åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š- å¤–å›´ä»»åŠ¡ï¼šä¸šåŠ¡ä»£ç ã€APIæ¥å£ã€ç”¨æˆ·äº¤äº’ç­‰é€»è¾‘å¤æ‚çš„ä»»åŠ¡ã€‚ -å†…æ ¸ä»»åŠ¡ï¼šé«˜åº¦å†…èšçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œé€»è¾‘åˆ†æ”¯å¾ˆå°‘ã€‚</p><p>è€ŒGPUå¯ä»¥å¤„ç†å¯†é›†çš„è®¡ç®—ï¼Œä¾‹å¦‚ä¸€ä¸ª3Dæ¸¸æˆï¼Œå…¶ä¸­ç”¨æˆ·äº¤äº’ã€ç”¨æˆ·ç•Œé¢(UI)ã€éŸ³é¢‘ç­‰éƒ¨åˆ†ç”±CPUè´Ÿè´£å¤„ç†ï¼Œè€Œå›¾å½¢æ¸²æŸ“å’Œç‰©ç†ä»¿çœŸç­‰æ ¸å¿ƒè®¡ç®—ä»»åŠ¡åˆ™ç”±GPUæ‰§è¡Œã€‚åœ¨æ·±åº¦å­¦ä¹ é¢†åŸŸï¼Œæ ¸å¿ƒçš„è®¡ç®—ä»»åŠ¡è¢«å°è£…æˆç®—å­å¹¶åœ¨GPUä¸Šæ‰§è¡Œï¼Œè€Œå¤æ‚çš„é€»è¾‘è°ƒåº¦ã€æ•°æ®æ¬è¿ç­‰ä»»åŠ¡åˆ™ç”±CPUå®Œæˆã€‚</p><h3 id="gpuç¡¬ä»¶ç»“æ„">GPUç¡¬ä»¶ç»“æ„</h3><p>GPUçš„è®¡ç®—æ ¸å¿ƒå¹¶ä¸èƒ½ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼Œäºæ˜¯åœ¨äºŒè€…ä¹‹é—´åˆåŠ å…¥äº†<strong>æ˜¾å­˜(VRAM)</strong>è¿™ä¸ªé¢å¤–çš„å­˜å‚¨å…ƒä»¶ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306193624.png"></p><p>GPUè‡ªé¡¶å‘ä¸‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š - æœ€å¤–å±‚ï¼šæ˜¾å­˜ã€L2ç¼“å­˜ -é«˜å±‚å°è£…å•å…ƒï¼š<strong>æµå¼å¤šå¤„ç†å™¨(SM)</strong> - L1ç¼“å­˜ -å¤šä¸ª<strong>æµå¼å¤„ç†å™¨(SP)</strong>ï¼Œå…±äº«ä¸€ä¸ªSMçš„L1ç¼“å­˜ï¼Œæ¯ä¸ªSPåŒ…æ‹¬ï¼š -è‹¥å¹²æ ‡é‡è®¡ç®—æ ¸å¿ƒ(<strong>CUDA core</strong>) -è‹¥å¹²å¼ é‡è®¡ç®—æ ¸å¿ƒ(<strong>tensor core</strong>) - è‹¥å¹²å¯„å­˜å™¨ -çº¿ç¨‹æŸè°ƒåº¦å™¨(<strong>warp scheduler</strong>)</p><p>è¿™é‡Œé¢çœŸæ­£é‡è¦çš„æ˜¯å›¾ä¸­æ ‡è®°ä¸ºè“è‰²çš„å‡ ä¸ªç¡¬ä»¶å•å…ƒã€‚å…¶ä¸­å¼ é‡è®¡ç®—æ ¸å¿ƒã€æ ‡é‡è®¡ç®—æ ¸å¿ƒå†³å®šäº†GPUçš„æ•´ä½“è®¡ç®—æ•ˆç‡ï¼›L1ç¼“å­˜ã€æ˜¾å­˜å†³å®šäº†GPUå­˜å–æ•°æ®çš„æ•ˆç‡ï¼›çº¿ç¨‹æŸè°ƒåº¦å™¨åˆ™ä¸CUDAç¼–ç¨‹æ¨¡å‹ä¸­çš„çº¿ç¨‹æŸ(warp)æ¦‚å¿µç›´æ¥å¯¹åº”ï¼Œè´Ÿè´£çº¿ç¨‹é—´çš„é€šä¿¡å’Œè°ƒåº¦ã€‚</p><p>A100ï¼ˆAmpereæ¶æ„ï¼‰ä¸­çš„SMå¦‚ä¸‹å›¾ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306195211.png"></p><p>A100æ•´ä½“æ¶æ„å›¾ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306195334.png"></p><h3 id="gpuç¼–ç¨‹æ¨¡å‹åŠå…¶ç¡¬ä»¶å¯¹åº”">GPUç¼–ç¨‹æ¨¡å‹åŠå…¶ç¡¬ä»¶å¯¹åº”</h3><p>Pythonã€C++ç­‰ç¨‹åºèƒ½å¤Ÿåœ¨è®¡ç®—æœºä¸Šè¿è¡Œï¼Œæ˜¯å› ä¸ºå®ƒä»¬é€šè¿‡ç¼–è¯‘å™¨è½¬æ¢æˆç¡¬ä»¶èƒ½è¯†åˆ«çš„æŒ‡ä»¤ï¼Œä»è€Œåœ¨CPUä¸Šæ‰§è¡Œã€‚åŸºäºè¿™ä¸€é€»è¾‘ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªèƒ½å°†C++æˆ–Pythonç¼–è¯‘æˆGPUæŒ‡ä»¤çš„ç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨GPUä¸Šè¿è¡Œè¿™äº›ä»£ç ã€‚ç„¶è€Œï¼Œé—æ†¾çš„æ˜¯ï¼ŒNVIDIAæ²¡æœ‰æä¾›è¿™ç§ç›´æ¥çš„ç¼–è¯‘å™¨ã€‚ç›¸åï¼ŒNVIDIAå¼€å‘äº†ä¸€å¥—ä¸“é—¨çš„GPUç¼–ç¨‹æ¨¡å‹ï¼Œç§°ä¸ºCUDAè¯­è¨€ï¼Œæ¥æ”¯æŒåœ¨GPUä¸Šè¿›è¡Œç¼–ç¨‹ã€‚CUDAç¼–ç¨‹æ¨¡å‹æœ¬è´¨æ˜¯å¯¹GPUç¡¬ä»¶çš„æŠ½è±¡ã€‚</p><p>CUDAç¼–ç¨‹æ¨¡å‹çš„æ ¸å¿ƒæ˜¯è¦æ±‚ç¨‹åºå‘˜å°†ç®—æ³•çš„å®ç°ä»£ç ï¼Œæ‹†åˆ†æˆå¤šä¸ªå¯ä»¥ç‹¬ç«‹æ‰§è¡Œçš„è½¯ä»¶ä»»åŠ¡ã€‚æˆ‘ä»¬å°†ç®—æ³•æ‹†åˆ†å¾—åˆ°çš„æ¯ä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œç§°ä¸ºä¸€ä¸ª<strong>çº¿ç¨‹</strong>ã€‚çº¿ç¨‹æ˜¯è½¯ä»¶å±‚é¢æœ€å°çš„æ‰§è¡Œå•å…ƒã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306212256.png"></p><p>ä¸ºäº†å°½å¯èƒ½æé«˜å¹¶è¡Œåº¦ï¼ŒSPä¸­çš„çº¿ç¨‹æŸè°ƒåº¦å™¨(warpscheduler)ä¼šå°†æ¯32ä¸ªçº¿ç¨‹æ‰“åŒ…æˆä¸€ä¸ªçº¿ç¨‹æŸ(warp)ã€‚åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ¯ç»„çº¿ç¨‹æŸä¼šè¢«è°ƒåº¦åˆ°ä¸€ä¸ªæµå¼å¤„ç†å™¨ä¸Šï¼Œæ‰§è¡Œä¸€æ¡ç›¸åŒçš„GPUæŒ‡ä»¤ã€‚SMå¯¹åº”CUDAç¼–ç¨‹è¯­è¨€ä¸­çº¿ç¨‹å—(block)çš„æ¦‚å¿µã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306212820.png"></p><p>GPUçš„å¹¶è¡Œèƒ½åŠ›å…¶å®åˆ†ä¸ºè½¯ä»¶å¹¶è¡Œå’Œç¡¬ä»¶å¹¶è¡Œä¸¤å±‚ï¼š -è½¯ä»¶å¹¶è¡Œï¼šå°†ç®—å­æ‹†åˆ†æˆå¤šä¸ªå¯ä»¥ç‹¬ç«‹æ‰§è¡Œçš„çº¿ç¨‹ï¼Œä½¿ç”¨CUDAè¯­è¨€å®ç°ã€‚ -ç¡¬ä»¶å¹¶è¡Œï¼šå¯¹çº¿ç¨‹è¿›è¡Œåˆ†ç»„ï¼Œç„¶åä»¥çº¿ç¨‹æŸ(warp)æˆ–è€…çº¿ç¨‹å—(block)ä¸ºå•å…ƒï¼Œå¹¶è¡Œæ‰§è¡Œè¿™äº›çº¿ç¨‹ã€‚</p><h3 id="gpuçš„å…³é”®æŒ‡æ ‡">GPUçš„å…³é”®æŒ‡æ ‡</h3><ul><li>Tensor coreå’ŒCUDA coreæ€§èƒ½ï¼šå†³å®šäº†è®¡ç®—æ•ˆç‡ã€‚</li><li>æ˜¾å­˜å¤§å°ï¼šå†³å®šäº†å¯ä»¥æ‰¿è½½çš„æ¨¡å‹ã€æ•°æ®è§„æ¨¡ä¸Šé™ã€‚</li><li>æ˜¾å­˜å¸¦å®½ï¼šå†³å®šäº†æ˜¾å­˜è¯»å†™æ•ˆç‡ã€‚</li><li>å¡é—´é€šä¿¡å¸¦å®½ï¼šå†³å®šäº†å¤šå—GPUå¡ä¹‹é—´æ•°æ®é€šä¿¡çš„æ•ˆç‡ã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306213416.png"></p><h3 id="æ˜¾å­˜vramä¸å†…å­˜dramä¹‹é—´çš„æ•°æ®ä¼ è¾“">æ˜¾å­˜VRAMä¸å†…å­˜DRAMä¹‹é—´çš„æ•°æ®ä¼ è¾“</h3><p>ä¸€èˆ¬æ¥è¯´ï¼ŒVRAMä¸DRAMä¹‹é—´çš„ä¼ è¾“ä¾é CPUè¿›è¡Œè°ƒåº¦ï¼Œä½†æ˜¯å¦‚æœDRAMä¸­çš„æ•°æ®å­˜å‚¨åœ¨é”é¡µå†…å­˜ï¼ˆPinnedMemoryï¼‰ä¸­ï¼ŒCPUæ— æ³•ç›´æ¥è®¿é—®ï¼Œæ­¤æ—¶å°±éœ€è¦ä½¿ç”¨DMA(Direct MemoryAccess)æŠ€æœ¯ã€‚</p><p>å¦å¤–ï¼ŒNVIDIAè¿˜æä¾›äº†ä¾é DMAçš„VRAMä¸ç¡¬ç›˜/ç½‘ç»œä¹‹é—´æ•°æ®ä¼ è¾“ï¼š - GPUDirect StorageæŠ€æœ¯ï¼šå…è®¸GPUå€ŸåŠ©DMAç›´æ¥è®¿é—®NVMeå›ºæ€ç¡¬ç›˜ï¼› -RDMAæŠ€æœ¯ï¼šå…è®¸GPUå€ŸåŠ©DMAç›´æ¥è®¿é—®ç½‘ç»œå­˜å‚¨ã€‚</p><h2 id="åˆ†å¸ƒå¼ç³»ç»Ÿ">åˆ†å¸ƒå¼ç³»ç»Ÿ</h2><h3 id="å•æœºå¤šå¡">å•æœºå¤šå¡</h3><p>å¤šå¡åœ¨å•æœºä¸Šçš„é€šä¿¡æ–¹å¼æœ‰ä¸¤ç§ï¼š - é€šè¿‡<strong>PCIe</strong>æ€»çº¿è¿æ¥ -é€šè¿‡<strong>NVLink</strong>è¿æ¥</p><p>NVLinkæ˜¯NVIDIAå¼€å‘çš„ä¸€ç§é«˜é€Ÿäº’è¿æŠ€æœ¯ï¼Œä¸“é—¨ç”¨äºGPUä¹‹é—´çš„é€šä¿¡ï¼ˆCPUä¸GPUä¹‹é—´çš„é€šä¿¡ä½¿ç”¨PCIeæ€»çº¿ï¼‰ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306215759.png"></p><p>NVLinkç¬¬ä¸€ä»£åœ¨Pascalæ¶æ„ä¸­è¢«å¼•å…¥ï¼Œåé¢é€ä»£å‡çº§ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306215956.png"></p><h3 id="å¤šæœºå¤šå¡">å¤šæœºå¤šå¡</h3><p>åœ¨æ¶‰åŠå¤šæœºå¤šå¡çš„åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œä¸åŒæœºå™¨ä¸Šçš„GPUé€šä¿¡çš„ç¡¬ä»¶ä¸å†æ˜¯NVLinkæˆ–è€…PCIeè¿™ç§é«˜å¸¦å®½ä½å»¶è¿Ÿçš„äº’è”ï¼Œè€Œæ˜¯åŸºäºç½‘ç»œè®¾å¤‡çš„ä¼ è¾“ã€‚ä¸¤ç±»ä¸»æµçš„è§£å†³æ–¹æ¡ˆåˆ†åˆ«åŸºäº<strong>Ethernet</strong>ä»¥åŠ<strong>InfiniBand</strong>ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306220225.png"></p><h3 id="åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®å­˜å‚¨">åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®å­˜å‚¨</h3><p>å¯¹äºåˆ†å¸ƒå¼è®­ç»ƒç³»ç»Ÿæ¥è¯´ï¼Œé€šè¿‡æ¯å°æœåŠ¡å™¨çš„æœ¬åœ°ç¡¬ç›˜å­˜å‚¨å¤§è§„æ¨¡è®­ç»ƒæ•°æ®å¹¶ä¸ç°å®ã€‚åŸºäºç½‘ç»œçš„å­˜å‚¨æ–¹æ¡ˆåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ›´å—æ¬¢è¿ã€‚é€šå¸¸ä¹Ÿåˆ†ä¸ºä¸¤ç±»ï¼Œå³<strong>NFS</strong>ï¼ˆnetworkfile systemï¼Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰å’ŒåŸºäº<strong>äº‘æœåŠ¡</strong>çš„å­˜å‚¨æ–¹æ¡ˆã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306220724.png"></p><p>åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç¡¬ä»¶ç¤ºæ„å›¾: <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306220853.png"></p>]]></content>
      
      
      <categories>
          
          <category> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹é˜…è¯»ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> ã€Šå¤§æ¨¡å‹åŠ¨åŠ›å¼•æ“ã€‹ </tag>
            
            <tag> æ·±åº¦å­¦ä¹ ç¡¬ä»¶çŸ¥è¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3Dé‡å»º-æ·±åº¦å›¾/ç½‘æ ¼/ä½“ç´ /ç‚¹äº‘</title>
      <link href="/2025/03/06/3d-chong-jian-shen-du-tu-wang-ge-ti-su-dian-yun/"/>
      <url>/2025/03/06/3d-chong-jian-shen-du-tu-wang-ge-ti-su-dian-yun/</url>
      
        <content type="html"><![CDATA[<h2 id="æ·±åº¦å›¾">æ·±åº¦å›¾</h2><h3 id="å®šä¹‰">å®šä¹‰</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306162901.png">Depth mapæ·±åº¦å›¾æ˜¯ä¸€å¼ 2Då›¾ç‰‡ï¼Œæ¯ä¸ªåƒç´ éƒ½è®°å½•äº†ä»è§†ç‚¹ï¼ˆviewpointï¼‰åˆ°é®æŒ¡ç‰©è¡¨é¢ï¼ˆé®æŒ¡ç‰©å°±æ˜¯é˜´å½±ç”Ÿæˆç‰©ä½“ï¼‰çš„è·ç¦»ï¼Œè¿™äº›åƒç´ å¯¹åº”çš„é¡¶ç‚¹å¯¹äºè§‚å¯Ÿè€…è€Œè¨€æ˜¯â€œå¯è§çš„â€ã€‚</p><h3 id="z-buffer">Z-buffer</h3><p>Depthmapä¸­åƒç´ ç‚¹è®°å½•çš„æ·±åº¦å€¼ä¸ºlenth1ï¼›ç„¶åä»è§†ç‚¹å‡ºå‘ï¼Œè®¡ç®—ç‰©ä½“é¡¶ç‚¹våˆ°è§†ç‚¹çš„è·ç¦»ï¼Œè®°ä¸ºlenth2ï¼›æ¯”è¾ƒäºŒè€…å¤§å°ï¼Œæ¥ç¡®å®šâ€œvâ€æ˜¯å¦è¢«é®æŒ¡ã€‚è¯¥æœ¯è¯­çš„åŒä¹‰è¯æœ‰depthbuffer, Z-buffer, Z-buffering å’ŒZ-depthã€‚è¿™é‡Œçš„"Z"æ˜¯ç›¸å¯¹äºç›¸æœºï¼ˆå³è§†ç‚¹ï¼‰è§†å›¾ä¸­å¿ƒè½´çº¿è€Œè¨€çš„ï¼Œä¹Ÿå°±æ˜¯ç›¸æœºçš„zè½´çº¿ï¼Œè€Œä¸æ˜¯åœºæ™¯çš„ç»å¯¹åæ ‡ä¸­çš„zè½´çº¿ã€‚#### åº”ç”¨ -æ¨¡æ‹Ÿåœ¨ä¸€ä¸ªåœºæ™¯ä¸­çš„å¯†åº¦å‡åŒ€çš„åŠé€æ˜ä»‹è´¨æ•ˆæœ-å¦‚é›¾ï¼ŒçƒŸæˆ–å¤§é‡çš„æ°´ï¼› -æ¨¡æ‹Ÿåœºæ™¯è¡¨é¢çš„æ·±åº¦åŸŸï¼ˆdepth of field (DOF)ï¼‰ï¼› -å¯ç”¨äºé«˜æ•ˆçš„å˜å½¢ä½“ç¢°æ’æ£€æµ‹ã€‚</p><h2 id="ä½“ç´ ">ä½“ç´ </h2><p>ä½“ç´ æˆ–ç«‹ä½“åƒç´ (voxel)ï¼Œæ˜¯ä½“ç§¯åƒç´ (volumepixel)çš„ç®€ç§°ã€‚æ¦‚å¿µä¸Šç±»ä¼¼äºŒç»´ç©ºé—´çš„æœ€å°å•ä½â€”â€”åƒç´ ï¼Œåƒç´ ç”¨åœ¨äºŒç»´ç”µè„‘å›¾åƒçš„è§†é¢‘æ•°æ®ä¸Šã€‚ä½“ç§¯åƒç´ ä¸€å¦‚å…¶åï¼Œæ˜¯æ•°å­—æ•°æ®äºä¸‰ç»´ç©ºé—´åˆ†åŒºä¸Šçš„æœ€å°å•ä½ï¼Œåº”ç”¨äºä¸‰ç»´æˆåƒã€ç§‘å­¦æ•°æ®ä¸åŒ»å­¦è§†é¢‘ç­‰é¢†åŸŸã€‚æœ‰äº›çœŸæ­£çš„ä¸‰ç»´æ˜¾ç¤ºå™¨è¿ç”¨ä½“ç´ æ¥æè¿°å®ƒä»¬çš„åˆ†è¾¨ç‡ï¼Œä¸¾ä¾‹æ¥è¯´ï¼šå¯ä»¥æ˜¾ç¤º512Ã—512Ã—512ä½“ç´ çš„æ˜¾ç¤ºå™¨ã€‚</p><p><strong>å¦‚åŒåƒç´ ï¼Œä½“ç´ æœ¬èº«å¹¶ä¸å«æœ‰ç©ºé—´ä¸­ä½ç½®çš„æ•°æ®(å³å®ƒä»¬çš„åº§æ ‡)</strong>ï¼Œç„¶è€Œå´å¯ä»¥ä»å®ƒä»¬ç›¸å¯¹äºå…¶ä»–ä½“ç´ çš„ä½ç½®æ¥æ¨æ•²ï¼Œæ„å³å®ƒä»¬åœ¨æ„æˆå•ä¸€å¼ ä½“ç§¯è§†é¢‘çš„æ•°æ®ç»“æ„ä¸­çš„ä½ç½®ã€‚</p><h2 id="ç½‘æ ¼">ç½‘æ ¼</h2><h3 id="å®šä¹‰-1">å®šä¹‰</h3><p>å¤šè¾¹å½¢ç½‘æ ¼ï¼ˆPolygonmeshï¼‰æ˜¯ä¸‰ç»´è®¡ç®—æœºå›¾å½¢å­¦ä¸­è¡¨ç¤ºå¤šé¢ä½“å½¢çŠ¶çš„é¡¶ç‚¹ä¸å¤šè¾¹å½¢çš„é›†åˆï¼Œå®ƒä¹Ÿå«ä½œéç»“æ„ç½‘æ ¼ã€‚</p><p>è¿™äº›ç½‘æ ¼é€šå¸¸ç”±ä¸‰è§’å½¢ã€å››è¾¹å½¢æˆ–è€…å…¶å®ƒçš„ç®€å•å‡¸å¤šè¾¹å½¢ç»„æˆï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–æ¸²æŸ“è¿‡ç¨‹ã€‚ä½†æ˜¯ï¼Œç½‘æ ¼ä¹Ÿå¯ä»¥åŒ…æ‹¬å¸¦æœ‰ç©ºæ´çš„æ™®é€šå¤šè¾¹å½¢ç»„æˆçš„ç‰©ä½“ã€‚</p><h3 id="ç±»å‹">ç±»å‹</h3><ul><li>ä¸€ç»„é¡¶ç‚¹çš„ç®€å•åˆ—è¡¨ï¼Œå®ƒä»¬å¸¦æœ‰è¡¨ç¤ºé‚£äº›é¡¶ç‚¹ç»„æˆå¤šè¾¹å½¢çš„ä¿¡æ¯åˆ—è¡¨ï¼›å¦å¤–å¯èƒ½å¸¦æœ‰è¡¨ç¤ºç©ºæ´çš„é™„åŠ ä¿¡æ¯ã€‚</li><li>é¡¶ç‚¹åˆ—è¡¨ + è¾¹ç•Œåˆ—è¡¨ï¼ˆä¸€å¯¹ç´¢å¼•ä¿¡æ¯ï¼‰+ è¿æ¥è¾¹ç•Œçš„å¤šè¾¹å½¢åˆ—è¡¨</li><li>ç¿¼è¾¹æ•°æ®ç»“æ„</li></ul><p>æ ¹æ®åº”ç”¨ç¨‹åºçš„ä¸åŒæ‰€é€‰æ‹©çš„æ•°æ®ç»“æ„ä¹Ÿæœ‰æ‰€ä¸åŒï¼šä¸‰è§’å½¢çš„å¤„ç†è¦æ¯”æ™®é€šå¤šè¾¹å½¢çš„å¤„ç†æ›´åŠ ç®€å•ï¼Œå°¤å…¶æ˜¯åœ¨è®¡ç®—å‡ ä½•ä¸­æ›´æ˜¯è¿™æ ·ã€‚å¯¹äºä¼˜åŒ–çš„ç®—æ³•ï¼Œå¯èƒ½éœ€è¦å¿«é€Ÿè®¿é—®è¾¹çº¿æˆ–è€…ç›¸é‚»è¡¨é¢è¿™æ ·çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œè¿™æ ·å°±éœ€è¦å¦‚ç¿¼è¾¹è¡¨ç¤ºè¿™æ ·æ›´åŠ å¤æ‚çš„ç»“æ„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250306164354.png"></p><h2 id="ç‚¹äº‘">ç‚¹äº‘</h2><h3 id="å®šä¹‰-2">å®šä¹‰</h3><p>ç‚¹äº‘ï¼ˆpoint cloudï¼‰æ˜¯æŒ‡é€è¿‡3Dæ‰«æå™¨æ‰€å–å¾—ä¹‹èµ„æ–™å‹å¼ã€‚</p><p>æ‰«æèµ„æ–™ä»¥ç‚¹çš„å‹å¼è®°å½•ï¼Œæ¯ä¸€ä¸ªç‚¹åŒ…å«æœ‰ä¸‰ç»´åº§æ ‡ï¼Œæœ‰äº›å¯èƒ½å«æœ‰è‰²å½©èµ„è®¯ï¼ˆR,G,Bï¼‰æˆ–ç‰©ä½“åå°„é¢å¼ºåº¦ã€‚</p><p>ç‚¹äº‘æ•°æ®é™¤äº†å…·æœ‰å‡ ä½•ä½ç½®ä»¥å¤–ï¼Œè¿˜æœ‰å¼ºåº¦ï¼ˆIntensityï¼‰ä¿¡æ¯ï¼Œå¼ºåº¦ä¿¡æ¯çš„è·å–æ˜¯æ¿€å…‰æ‰«æä»ªæ¥å—è£…ç½®é‡‡é›†åˆ°çš„å›æ³¢å¼ºåº¦ï¼Œæ­¤å¼ºåº¦ä¿¡æ¯ä¸ç›®æ ‡çš„è¡¨é¢æè´¨ã€ç²—ç³™åº¦ã€å…¥å°„è§’æ–¹å‘ï¼Œä»¥åŠä»ªå™¨çš„å‘å°„èƒ½é‡ï¼Œæ¿€å…‰æ³¢é•¿æœ‰å…³ã€‚ç‚¹äº‘ä¹Ÿæ˜¯é€†å‘å·¥ç¨‹ä¸­é€šè¿‡ä»ªå™¨æµ‹é‡å¤–è¡¨çš„ç‚¹æ•°æ®é›†åˆã€‚</p><p>åœ¨ç”µè„‘åŠ¨ç”»é¢†åŸŸï¼Œçš®å…‹æ–¯çš„ç©å…·æ€»åŠ¨å‘˜3ä½¿ç”¨äº†ç‚¹äº‘æŠ€æœ¯[2]</p><h3 id="ç‚¹äº‘åº”ç”¨æ·±åº¦å­¦ä¹ é¢ä¸´çš„æŒ‘æˆ˜">ç‚¹äº‘åº”ç”¨æ·±åº¦å­¦ä¹ é¢ä¸´çš„æŒ‘æˆ˜ï¼š</h3><p>éç»“æ„åŒ–æ•°æ®ï¼Œ ä¸å˜æ€§æ’åˆ—ï¼Œç‚¹äº‘æ•°æ®é‡ä¸Šçš„å˜åŒ–(ä¸åŒä¼ æ„Ÿå™¨ä¸Šç‚¹äº‘çš„æ•°é‡å˜åŒ–å¾ˆå¤§)</p><p>ç‚¹äº‘æ•°æ®æ–¹é¢çš„æŒ‘æˆ˜ï¼š - ç¼ºå°‘æ•°æ®ï¼š æ‰«æçš„æ¨¡å‹é€šå¸¸è¢«é®æŒ¡ï¼Œéƒ¨åˆ†æ•°æ®ä¸¢å¤±- å™ªéŸ³ï¼šæ‰€æœ‰ä¼ æ„Ÿå™¨éƒ½æ˜¯å˜ˆæ‚çš„ã€‚æœ‰å‡ ç§ç±»å‹çš„å™ªå£°ï¼ŒåŒ…æ‹¬ç‚¹äº‘æ‰°åŠ¨å’Œå¼‚å¸¸å€¼ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªç‚¹æœ‰ä¸€å®šçš„æ¦‚ç‡ä½äºå®ƒè¢«é‡‡æ ·çš„åœ°æ–¹(æ‰°åŠ¨)é™„è¿‘çš„æŸä¸€åŠå¾„èŒƒå›´å†…ï¼Œæˆ–è€…å®ƒå¯èƒ½å‡ºç°åœ¨ç©ºé—´çš„ä»»æ„ä½ç½®(å¼‚å¸¸å€¼)- æ—‹è½¬ï¼š ä¸€è¾†è½¦å‘å·¦è½¬ï¼ŒåŒä¸€è¾†è½¦å‘å³è½¬ï¼Œä¼šæœ‰ä¸åŒçš„ç‚¹äº‘ä»£è¡¨åŒä¸€è¾†è½¦</p><p><strong>åœ¨ç‚¹äº‘ä¸Šç›´æ¥ç”¨æ·±åº¦å­¦ä¹ çš„æ–¹æ³•æ˜¯å°†æ•°æ®è½¬æ¢æˆä½“ç§¯è¡¨ç¤ºï¼Œæ¯”å¦‚ä½“ç´ ç½‘æ ¼ï¼Œç„¶åå°±å¯ä»¥ç”¨3Dæ»¤æ³¢å™¨æ¥è®­ç»ƒCNNï¼Œä½†æ˜¯ä½“ç§¯æ•°æ®ä¼šå˜å¾—éå¸¸å¤§</strong>ï¼Œ3DCNNå¤„ç†ä¼šéå¸¸æ…¢ï¼Œæ‰€ä»¥éœ€è¦å¦¥ååˆ°è¾ƒä½çš„åˆ†è¾¨ç‡ï¼Œå°±ä¼šå¸¦æ¥é‡åŒ–è¯¯å·®çš„ä»£ä»·</p><p>é’ˆå¯¹æ— åºç‚¹äº‘æ•°æ®çš„æ·±åº¦å­¦ä¹ æ–¹æ³•ç ”ç©¶è¿›å±•ç¼“æ…¢ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹é¢ï¼š -ç‚¹äº‘å…·æœ‰æ— åºæ€§ -ç‚¹äº‘å…·æœ‰ç¨€ç–æ€§:åœ¨KITTIæ•°æ®é›†ä¸­ï¼Œå¦‚æœæŠŠåŸå§‹çš„æ¿€å…‰é›·è¾¾ç‚¹äº‘æŠ•å½±åˆ°å¯¹åº”çš„å½©è‰²å›¾åƒä¸Šï¼Œå¤§æ¦‚åªæœ‰3%çš„åƒç´ æ‰æœ‰å¯¹åº”çš„é›·è¾¾ç‚¹ã€‚è¿™ç§æå¼ºçš„ç¨€ç–æ€§è®©åŸºäºç‚¹äº‘çš„é«˜å±‚è¯­ä¹‰æ„ŸçŸ¥å˜å¾—å°¤å…¶å›°éš¾ã€‚-ç‚¹äº‘ä¿¡æ¯é‡æœ‰é™:ç‚¹äº‘çš„æ•°æ®ç»“æ„å°±æ˜¯ä¸€äº›ä¸‰ç»´ç©ºé—´çš„ç‚¹åæ ‡æ„æˆçš„ç‚¹é›†ï¼Œæœ¬è´¨æ˜¯å¯¹ä¸‰ç»´ä¸–ç•Œå‡ ä½•å½¢çŠ¶çš„<strong>ä½åˆ†è¾¨ç‡é‡é‡‡æ ·</strong>ï¼Œå› æ­¤åªèƒ½æä¾›ç‰‡é¢çš„å‡ ä½•ä¿¡æ¯</p>]]></content>
      
      
      <categories>
          
          <category> 3Dé‡å»º </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 3Dé‡å»º </tag>
            
            <tag> æ·±åº¦å›¾ </tag>
            
            <tag> ç½‘æ ¼ </tag>
            
            <tag> ä½“ç´  </tag>
            
            <tag> ç‚¹äº‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>transformers-æºç å­¦ä¹ </title>
      <link href="/2025/01/21/transformers-yuan-ma-xue-xi/"/>
      <url>/2025/01/21/transformers-yuan-ma-xue-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>Huggingfaceçš„transformersåº“æ˜¯NLPé¢†åŸŸæœ€å¸¸ç”¨çš„åº“ä¹‹ä¸€ï¼Œå…¶å»ºç«‹åœ¨ Pytorchæ¡†æ¶ä¹‹ä¸Šï¼ˆTensorflow çš„ç‰ˆæœ¬åŠŸèƒ½å¹¶ä¸å®Œå–„ï¼‰ï¼ŒåŸºæœ¬ä¸Š æ‰€æœ‰çš„Transformeræ¨¡å‹éƒ½å¯ä»¥åœ¨ Hugging Face Hubä¸­æ‰¾åˆ°å¹¶ä¸”åŠ è½½ä½¿ç”¨ï¼ŒåŒ…æ‹¬è®­ç»ƒã€æ¨ç†ã€é‡åŒ–ç­‰ã€‚</p><p>Huggingfaceå®˜æ–¹æä¾›äº†<a href="https://transformers.run/">transformerså¿«é€Ÿå…¥é—¨</a>çš„å®˜æ–¹æ•™ç¨‹ï¼Œå¯ä»¥å¿«é€Ÿä¸Šæ‰‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250121004750.png"></p><h2 id="huggingfaceä¸»è¦éƒ¨åˆ†">HuggingFaceä¸»è¦éƒ¨åˆ†</h2><ul><li>Models Hubï¼šæ‰˜ç®¡å’Œåˆ†äº«æ¨¡å‹ã€‚</li><li>Datasets Hubï¼šæ‰˜ç®¡å’Œåˆ†äº«æ•°æ®é›†ã€‚</li><li>Spacesï¼šæ‰˜ç®¡å’Œè¿è¡Œåº”ç”¨ï¼ˆåŸºäº Gradio æˆ– Streamlitï¼‰ã€‚</li><li>Postsï¼šå¸–å­ï¼Œå¯ä»¥æŸ¥çœ‹æœ€æ–°çš„ä¸€äº›æ›´æ–°åŠ¨æ€ã€‚</li><li>Collectionsï¼šæ”¶è—å¤¹ï¼Œå¯ä»¥æŸ¥çœ‹æœ€æ–°çš„çƒ­é—¨æ”¶è—å†…å®¹ã€‚</li><li>Communityï¼šç¤¾åŒºï¼Œæä¾›ä¸€äº›å…è´¹å­¦ä¹ è¯¾ç¨‹å’Œåšå®¢ã€‚</li></ul><p>æ¯ä¸ªhubæä¾›äº†å¯¹åº”çš„æ ‡ç­¾ï¼ŒæŒ‰å†…å®¹åˆ†ä¸ºï¼š -tasksï¼šæŒ‰ç…§Multimodal/Computer Vision/Natural LanguageProcessing/Audio/Tabular/Reinforcement Learningç­‰å†…å®¹åˆåšäº†å…·ä½“çš„ç»†åˆ†ã€‚-librariesï¼šæŒ‡å‡ºæ”¹ä»“åº“ä½¿ç”¨äº†å“ªäº›åº“ï¼Œå¦‚Pytorchã€Transformersã€PEFTã€Diffusersç­‰ã€‚- datasetsï¼šæŒ‡å‡ºæ”¹ä»“åº“ä½¿ç”¨äº†å“ªäº›æ•°æ®é›†ï¼Œå¦‚GLUEã€SQuADã€CommonCrawlã€Wikipediaç­‰ã€‚ -languagesï¼šæŒ‡å‡ºæ”¹ä»“åº“ä½¿ç”¨äº†å“ªäº›è¯­è¨€ï¼Œå¦‚Englishã€Chineseã€Spanishã€Frenchç­‰ã€‚- licensesï¼šæŒ‡å‡ºæ”¹ä»“åº“ä½¿ç”¨äº†å“ªäº›è®¸å¯è¯ï¼Œå¦‚Apache 2.0ã€MITã€CC-BY-NC-SA4.0ç­‰ã€‚ - otherï¼šå¦‚inference statusï¼Œmiscæ‚é¡¹ç­‰</p><h2 id="transformersåº“">Transformersåº“</h2><p>ä¸€ä¸ªè‡ªç„¶è¯­è¨€å¤„ç†çš„åº“ï¼Œæä¾›äº†ç®€å•æ˜“ç”¨çš„APIï¼Œå¯ä»¥å¿«é€Ÿåœ°åŠ è½½ã€è®­ç»ƒå’Œéƒ¨ç½²æ¨¡å‹ã€‚å¹¶ä¸”æä¾›ç»Ÿä¸€çš„ä»£ç é£æ ¼æ¥ä½¿ç”¨BERTã€XLNetå’ŒGPTç­‰ç­‰å„ç§ä¸åŒçš„æ¨¡å‹ã€‚åŒ…å«configurationï¼Œmodelså’Œtokenizerä¸‰ä¸ªä¸»è¦ç±»ï¼Œå¹¶åŸºäºè¿™ä¸‰ä¸ªç±»æä¾›æ›´ä¸Šå±‚çš„pipelineå’ŒTrainerï¼Œä»è€Œç”¨æ›´å°‘çš„ä»£ç å®ç°æ¨¡å‹çš„é¢„æµ‹å’Œå¾®è°ƒã€‚</p><ul><li><strong>pipeline</strong> åœ¨åº•å±‚æ˜¯ç”± AutoModel å’Œ AutoTokenizerç±»æ¥å®ç°çš„ã€‚AutoClassï¼ˆå³åƒ AutoModel å’Œ AutoTokenizerè¿™æ ·çš„é€šç”¨ç±»ï¼‰æ˜¯åŠ è½½æ¨¡å‹çš„å¿«æ·æ–¹å¼ï¼Œå®ƒå¯ä»¥ä»å…¶åç§°æˆ–è·¯å¾„ä¸­è‡ªåŠ¨æ£€ç´¢é¢„è®­ç»ƒæ¨¡å‹ã€‚</li><li>éœ€è¦ä¸ºæ¯ä¸ªæ¨¡å‹ç³»åˆ—ä½¿ç”¨ç‰¹å®šçš„Transformerså’ŒTokenizerï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨T5æ¨¡å‹ç³»åˆ—ï¼Œåˆ™å¯¹åº”T5Tokenizerå’ŒT5ForConditionalGenerationï¼‰ï¼Œå¯¹äºæ‰€æœ‰é¢„è®­ç»ƒæ¨¡å‹ï¼Œæ‚¨å¯ä»¥å£°æ˜ä¸€ä¸ªç®€å•çš„è¯­å¥ï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python">from transformers import AutoTokenizer, AutoModelForCausalLMtokenizer = AutoTokenizer.from_pretrained("databricks/dolly-v2-3b")model = AutoModelForCausalLM.from_pretrained("databricks/dolly-v2-3b")</code></pre></li></ul><h2 id="ä¸‹è½½æ¨¡å‹æ–‡ä»¶">ä¸‹è½½æ¨¡å‹æ–‡ä»¶</h2><p>å¦‚æœç›´æ¥ä½¿ç”¨transformers åº“ï¼Œé»˜è®¤ä¿å­˜ä½ç½®åœ¨ï¼šï½/.cacheæ–‡ä»¶å¤¹ä¸‹ã€‚</p><p><a href="https://hf-mirror.com/">HF-Mirror</a>æä¾›äº†å›½å†…çš„é•œåƒä¸‹è½½ï¼Œæ¨èä½¿ç”¨â€œæ–¹æ³•ä¸‰ï¼šä½¿ç”¨hfdâ€æ›´åŠ ç¨³å®šå¹¶ä¸”ä¸‹è½½è¿›åº¦æ¡æ›´ç›´è§‚ã€‚ä¸‹è½½æ—¶è®°å¾—ä½¿ç”¨tmuxæˆ–screenç­‰å·¥å…·é˜²æ­¢ä¸‹è½½ä¸­æ–­ã€‚</p><h2 id="pipeline">pipeline</h2><p>å¼€ç®±å³ç”¨çš„ pipelinesï¼Œå®ƒå°è£…äº†é¢„è®­ç»ƒæ¨¡å‹å’Œå¯¹åº”çš„å‰å¤„ç†å’Œåå¤„ç†ç¯èŠ‚ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250124012049.png">1. é¢„å¤„ç†(preprocessing)ï¼Œ<strong>Transformeræ¨¡å‹æ— æ³•ç›´æ¥å¤„ç†åŸå§‹æ–‡æœ¬å­—ç¬¦ä¸²</strong>ï¼›å…·ä½“åœ°ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨æ¯ä¸ªæ¨¡å‹å¯¹åº”çš„åˆ†è¯å™¨(tokenizer) æ¥è¿›è¡Œã€‚ -å°†è¾“å…¥åˆ‡åˆ†ä¸ºè¯è¯­ã€å­è¯æˆ–è€…ç¬¦å·ï¼ˆä¾‹å¦‚æ ‡ç‚¹ç¬¦å·ï¼‰ï¼Œç»Ÿç§°ä¸º tokensï¼› -æ ¹æ®æ¨¡å‹çš„è¯è¡¨å°†æ¯ä¸ª token æ˜ å°„åˆ°å¯¹åº”çš„ tokenç¼–å·/idï¼›æ˜ å°„é€šå¸¸æ˜¯é€šè¿‡åˆ›å»ºæ–‡æœ¬è¯­æ–™åº“ä¸­æ ‡è®°çš„è¯æ±‡è¡¨ï¼Œå¹¶æ ¹æ®æ¯ä¸ªæ ‡è®°åœ¨è¯­æ–™åº“ä¸­çš„å‡ºç°é¢‘ç‡ä¸ºå…¶åˆ†é…ä¸€ä¸ªæ•´æ•°å€¼æ¥æ‰§è¡Œçš„(å¦‚BPE)ã€‚æœ€å¸¸è§çš„tokensè¢«åˆ†é…è¾ƒä½çš„æ•´æ•°å€¼ï¼Œè€Œä¸å¤ªå¸¸è§çš„æ ‡è®°è¢«åˆ†é…è¾ƒé«˜çš„å€¼ã€‚- æ ¹æ®æ¨¡å‹çš„éœ€è¦ï¼Œæ·»åŠ ä¸€äº›é¢å¤–çš„è¾“å…¥ã€‚ - [PAD] - ç”¨äºå¡«å……åºåˆ—åˆ°å›ºå®šé•¿åº¦- [CLS] - åˆ†ç±»ä»»åŠ¡ä¸­çš„èµ·å§‹æ ‡è®° - [SEP] - ç”¨äºåˆ†éš”ä¸åŒæ–‡æœ¬æ®µè½ - [MASK] -ç”¨äºæ©ç è¯­è¨€æ¨¡å‹é¢„è®­ç»ƒ - [BOS] / <s> - åºåˆ—å¼€å§‹æ ‡è®° - [EOS] / </s> -åºåˆ—ç»“æŸæ ‡è®° - [UNK] - è¡¨ç¤ºè¯è¡¨å¤–çš„æœªçŸ¥è¯</p><pre><code>PS:é™¤äº†ä¸Šè¿°è®­ç»ƒæ¨ç†æ—¶ç”¨åˆ°çš„ç‰¹æ®Štokenï¼Œåœ¨chatä»»åŠ¡æ—¶è¿˜æœ‰æœ‰å…¶ä»–çš„è¾“å…¥tokenï¼ˆçœ‹promt templateï¼‰ï¼š- "&lt;|system|&gt;"    # ç³»ç»Ÿæç¤º- "&lt;|user|&gt;"      # ç”¨æˆ·è¾“å…¥- "&lt;|assistant|&gt;" # AIåŠ©æ‰‹å›å¤- "&lt;|human|&gt;"     # äººç±»å¯¹è¯è€…è¿˜æœ‰ä¸€äº›æ§åˆ¶ç›¸å…³çš„tokenï¼ˆå¤šæ¨¡æ€ï¼‰ï¼š- "&lt;|endoftext|&gt;"  # æ–‡æœ¬ç»“æŸ- "&lt;|im_start|&gt;"   # å›¾åƒå¼€å§‹- "&lt;|im_end|&gt;"     # å›¾åƒç»“æŸ</code></pre><ol start="2" type="1"><li>å°†å¤„ç†å¥½çš„è¾“å…¥é€å…¥æ¨¡å‹ï¼›</li><li>å¯¹æ¨¡å‹çš„è¾“å‡ºè¿›è¡Œåå¤„ç†(postprocessing)ï¼Œå°†å…¶è½¬æ¢ä¸ºäººç±»æ–¹ä¾¿é˜…è¯»çš„æ ¼å¼ã€‚ <pre class="line-numbers language-python" data-language="python"><code class="language-python">from transformers import pipeline# ä½¿ç”¨pipelineåŠ è½½æ¨¡å‹pipeline = pipeline("text-generation", model="gpt2")# è¾“å…¥æ–‡æœ¬input_text = "Once upon a time"# ç”Ÿæˆæ–‡æœ¬output_text = pipeline(input_text)print(output_text)</code></pre></li></ol><h2 id="ä¸‰å¤§ç»„ä»¶">ä¸‰å¤§ç»„ä»¶</h2><ol type="1"><li>ã€ŒConï¬gurationã€ï¼šé…ç½®ç±»ï¼Œé€šå¸¸ç»§æ‰¿è‡ªã€ŒPretrainedConï¬gã€ï¼Œä¿å­˜modelæˆ–tokenizerçš„è¶…å‚æ•°ï¼Œä¾‹å¦‚è¯å…¸å¤§å°ï¼Œéšå±‚ç»´åº¦æ•°ï¼Œdropoutrateç­‰ã€‚é…ç½®ç±»ä¸»è¦å¯ç”¨äºå¤ç°æ¨¡å‹ã€‚</li><li>ã€ŒTokenizerã€ï¼šModelåªèƒ½å¤„ç†æ•°å­—ï¼Œå› æ­¤Tokenizeréœ€è¦å°†æˆ‘ä»¬çš„æ–‡æœ¬è¾“å…¥è½¬æ¢ä¸ºæ•°å­—ã€‚æ€»ä½“ä¸Šåšä¸‰ä»¶äº‹æƒ…ï¼šåˆ†è¯ï¼›æ‰©å±•è¯æ±‡è¡¨ï¼›è¯†åˆ«å¹¶å¤„ç†ç‰¹æ®Štokenã€‚<ol type="1"><li>é€šå¸¸ç»§æ‰¿è‡ªã€ŒPreTrainedTokenizerã€ï¼Œä¸»è¦å­˜å‚¨è¯å…¸ï¼ˆä¹Ÿå°±æ˜¯<code>from_pretrained()</code>çš„éƒ¨åˆ†ï¼‰ï¼Œtokenåˆ°indexæ˜ å°„å…³ç³»ç­‰ã€‚</li><li>æ­¤å¤–ï¼Œè¿˜ä¼šæœ‰ä¸€äº›model-specificçš„ç‰¹æ€§ï¼Œå¦‚ç‰¹æ®Štokenï¼Œ<code>[SEP]</code>,<code>[CLS]</code>ç­‰çš„å¤„ç†ï¼Œtokençš„typeç±»å‹å¤„ç†ï¼Œè¯­å¥æœ€å¤§é•¿åº¦ç­‰ï¼Œ<strong>å› æ­¤tokenizeré€šå¸¸å’Œæ¨¡å‹æ˜¯ä¸€å¯¹ä¸€é€‚é…çš„</strong>ã€‚</li></ol></li><li>ã€ŒModelã€:æ¨¡å‹ç±»ã€‚å°è£…äº†é¢„è®­ç»ƒæ¨¡å‹çš„è®¡ç®—å›¾è¿‡ç¨‹ï¼Œéµå¾ªç€ç›¸åŒçš„èŒƒå¼ï¼Œå¦‚æ ¹æ®tokenidsè¿›è¡Œembeddingmatrixæ˜ å°„ï¼ˆå°†tokençš„one-hotç¼–ç è½¬æ¢æˆæ›´denseçš„embeddingç¼–ç ï¼‰ï¼Œç´§æ¥ç€å¤šä¸ªself-attentionå±‚åšç¼–ç ï¼Œæœ€åä¸€å±‚task-specificåšé¢„æµ‹ã€‚</li></ol><p>é’ˆå¯¹ä¸Šè¿°ä¸‰å¤§ç±»ï¼Œtransformerè¿˜é¢å¤–å°è£…äº†AutoConfig,AutoTokenizer,AutoModelï¼Œå¯é€šè¿‡æ¨¡å‹çš„å‘½åæ¥å®šä½å…¶æ‰€å±çš„å…·ä½“ç±»ï¼Œæ¯”å¦‚â€™bert-base-casedâ€™ï¼Œå°±å¯ä»¥çŸ¥é“è¦åŠ è½½BERTæ¨¡å‹ç›¸å…³çš„é…ç½®ã€åˆ‡è¯å™¨å’Œæ¨¡å‹ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from transformers import BertConfig, BertModel# Building the configconfig = BertConfig()# Building the model from the config,ä½¿ç”¨éšæœºå€¼å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–model = BertModel(config)print(config)BertConfig {  [...]  "hidden_size": 768,               # å®šä¹‰äº†hiddençŠ¶æ€å‘é‡çš„å¤§å°  "intermediate_size": 3072,  "max_position_embeddings": 512,  "num_attention_heads": 12,  "num_hidden_layers": 12,          # å®šä¹‰äº†Transformeræ¨¡å‹çš„å±‚æ•°  [...]}# åŠ è½½å·²ç»è®­ç»ƒè¿‡çš„Transformersæ¨¡å‹model = BertModel.from_pretrained("bert-base-cased")</code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"># åŠ è½½ä¸ä¿å­˜åˆ†è¯å™¨from transformers import BertTokenizertokenizer = BertTokenizer.from_pretrained("bert-base-cased")tokenizer.save_pretrained("./models/bert-base-cased/")# åŠ è½½ä¸ä¿å­˜æ¨¡å‹from transformers import AutoModel# æ‰€æœ‰å­˜å‚¨åœ¨ HuggingFace Model Hub ä¸Šçš„æ¨¡å‹éƒ½å¯ä»¥é€šè¿‡ Model.from_pretrained() æ¥åŠ è½½æƒé‡ï¼Œå‚æ•°å¯ä»¥æ˜¯ checkpoint çš„åç§°ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°è·¯å¾„ï¼ˆé¢„å…ˆä¸‹è½½çš„æ¨¡å‹ç›®å½•ï¼‰model = AutoModel.from_pretrained("bert-base-cased")model.save_pretrained("./models/bert-base-cased/") # ä¿å­˜æ¨¡å‹inputs = tokenizer(["æ¥åˆ°ç¾ä¸½çš„å¤§è‡ªç„¶ï¼Œæˆ‘ä»¬å‘ç°"], return_tensors="pt")# {'input_ids': tensor([[    1, 68846, 68881, 67701, 67668, 98899, 91935]]), 'attention_mask': tensor([[1, 1, 1, 1, 1, 1, 1]])}gen_kwargs = {"max_length": 128, "top_p": 0.8, "temperature": 0.8, "do_sample": True, "repetition_penalty": 1.1}output = model.generate(**inputs, **gen_kwargs) # è¿™ç§ç”Ÿæˆæ–¹å¼æ›´åŠ å¯æ§ï¼Œç»“æœéœ€è¦decode# decode the new tokensoutput = tokenizer.decode(output[0].tolist(), skip_special_tokens=True)print(output)</code></pre><p>Transformersè¿˜å°†æ¨¡å‹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š 1.åŸºç¡€æ¶æ„ï¼šå°±åƒä¸€ä¸ªé€šç”¨çš„å¼•æ“ï¼Œè´Ÿè´£ç†è§£è¾“å…¥çš„æ–‡æœ¬ï¼Œå°†æ–‡æœ¬è½¬æ¢æˆè®¡ç®—æœºèƒ½ç†è§£çš„å‘é‡å½¢å¼ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½ç”¨ç›¸åŒçš„åŸºç¡€ç»“æ„ã€‚2.ä»»åŠ¡ç›¸å…³çš„headï¼šæ ¹æ®ä»»åŠ¡çš„ä¸åŒï¼Œå°†åŸºç¡€æ¶æ„çš„è¾“å‡ºè½¬æ¢ä¸ºä»»åŠ¡éœ€è¦çš„è¾“å‡ºå˜é‡ã€‚</p><p>tranformersä¸­å¸¸è§çš„æ¨¡å‹ç±»å‹ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># ä¸¾ä¾‹è¯´æ˜ä¸åŒä»»åŠ¡çš„æ¨¡å‹models = {    "*Model": "åªè¾“å‡ºåŸºç¡€ç†è§£ï¼ŒåƒåŸææ–™",    "*ForCausalLM": "é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼ˆåƒGPTï¼‰",    "*ForMaskedLM": "å®Œå½¢å¡«ç©ºï¼ˆåƒBERTï¼‰",    "*ForMultipleChoice": "é€‰æ‹©é¢˜",    "*ForQuestionAnswering": "å›ç­”é—®é¢˜",    "*ForSequenceClassification": "æ–‡æœ¬åˆ†ç±»",    "*ForTokenClassification": "æ ‡æ³¨è¯è¯­ï¼ˆå¦‚å®ä½“è¯†åˆ«ï¼‰"}</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250127032047.png"><p></p><h2 id="datasets">Datasets</h2><ol type="1"><li><p>ä»‹ç» </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from datasets import load_datasetraw_datasets = load_dataset("glue", "mrpc") # GLUEåŸºå‡†æµ‹è¯•ä¸­çš„MRPCä»»åŠ¡print(raw_datasets)# åŒ…å«è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ã€‚æ¯ä¸€ä¸ªé›†åˆéƒ½åŒ…å«å‡ ä¸ªåˆ—(sentence1, sentence2, label, and idx)ä»¥åŠä¸€ä¸ªä»£è¡¨è¡Œæ•°çš„å˜é‡#DatasetDict({#    train: Dataset({#        features: ['sentence1', 'sentence2', 'label', 'idx'],#        num_rows: 3668#    })#    validation: Dataset({#        features: ['sentence1', 'sentence2', 'label', 'idx'],#        num_rows: 408#    })#    test: Dataset({#        features: ['sentence1', 'sentence2', 'label', 'idx'],#        num_rows: 1725#    })#})</code></pre><p></p></li><li><p>ç®€å•ä½¿ç”¨ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># 1. åŠ è½½å†…ç½®æ•°æ®é›†dataset = load_dataset("glue", "mrpc")  # GLUEåŸºå‡†æµ‹è¯•ä¸­çš„MRPCä»»åŠ¡# 2. åŠ è½½æœ¬åœ°æ–‡ä»¶dataset = load_dataset("csv", data_files="my_file.csv")dataset = load_dataset("json", data_files="my_file.json")# 3. è®¿é—®æ•°æ®train_data = dataset['train']first_example = train_data[0]</code></pre><p></p></li><li><p>ä¸ºäº†é¢„å¤„ç†æ•°æ®é›†ï¼Œæˆ‘ä»¬éœ€è¦å°†æ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹èƒ½å¤Ÿç†è§£çš„æ•°å­—ï¼Œä½¿ç”¨Dataset.map()æ–¹æ³•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># example æ˜¯ä¸€ä¸ªdictï¼Œå¯¹åº”æ•°æ®é›†çš„æ¯ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«input_idsã€attention_mask å’Œtoken_type_idsä¸ºkeyçš„æ–°dict# åœ¨æœºå™¨å­¦ä¹ ä»»åŠ¡ä¸­ï¼Œä¸€ä¸ªexampleé€šå¸¸å®šä¹‰ä¸ºæ¨¡å‹çš„è¾“å…¥ï¼ˆä¹Ÿæˆä¸ºç‰¹å¾é›†åˆï¼‰def tokenize_function(example):    return tokenizer(example["sentence1"], example["sentence2"], truncation=True)tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)print(raw_datasets)#DatasetDict({#    train: Dataset({#        features: ['attention_mask', 'idx', 'input_ids', 'label', 'sentence1', 'sentence2', 'token_type_ids'],#        num_rows: 3668#    })#    validation: Dataset({#        features: ['attention_mask', 'idx', 'input_ids', 'label', 'sentence1', 'sentence2', 'token_type_ids'],#        num_rows: 408#    })#    test: Dataset({#        features: ['attention_mask', 'idx', 'input_ids', 'label', 'sentence1', 'sentence2', 'token_type_ids'],#        num_rows: 1725#    })#})</code></pre><p></p></li><li><p>ä¸ºäº†è§£å†³å¥å­é•¿åº¦ç»Ÿä¸€çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»å®šä¹‰ä¸€ä¸ªcollateå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†æ¯ä¸ªbatchå¥å­å¡«å……åˆ°æ­£ç¡®çš„é•¿åº¦ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from datasets import load_datasetfrom transformers import AutoTokenizer, DataCollatorWithPaddingraw_datasets = load_dataset("glue", "mrpc")tokenizer = AutoTokenizer.from_pretrained("bert-base-uncased")def tokenize_function(example):    return tokenizer(example["sentence1"], example["sentence2"], truncation=True)tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)data_collator = DataCollatorWithPadding(tokenizer=tokenizer)</code></pre><p></p></li><li><p>åŠ è½½æœ¬åœ°æ•°æ®é›† </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from datasets import load_dataset#{#    "data": [#        {#            "title": "Terremoto del Sichuan del 2008",#            "paragraphs": [{...}]#        }#    ],#     "version": "1.1"#}squad_it_dataset = load_dataset("json", data_files="SQuAD_it-train.json", field="data")print(squad_it_dataset) # åŠ è½½æœ¬åœ°æ–‡ä»¶ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰trainçš„DatasetDict å¯¹è±¡# DatasetDict({#    train: Dataset({#        features: ['title', 'paragraphs'],#        num_rows: 442#    })#})data_files = {"train": "SQuAD_it-train.json", "test": "SQuAD_it-test.json"}squad_it_dataset = load_dataset("json", data_files=data_files, field="data")print(squad_it_dataset) # åŒ…æ‹¬ train å’Œ test çš„ DatasetDict å¯¹è±¡#DatasetDict({#    train: Dataset({#        features: ['title', 'paragraphs'],#        num_rows: 442#    })#    test: Dataset({#        features: ['title', 'paragraphs'],#        num_rows: 48#    })#})</code></pre><p></p></li><li><p><code>streaming=True</code>ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">dataset = load_dataset("json", data_files="my_file.json", streaming=True)# è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¯ä»¥é€ä¸ªå¤„ç†æ•°æ®</code></pre><p></p></li></ol><h2 id="æºç åˆ†æ">æºç åˆ†æ</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">tokenizer = AutoTokenizer.from_pretrained(checkpoint)model = AutoModelForSequenceClassification.from_pretrained(checkpoint)sequences = ["I've been waiting for a HuggingFace course my whole life.", "So have I!"]tokens = tokenizer(sequences, padding=True, truncation=True, return_tensors="pt")print(tokens)#{#    'input_ids': tensor([#        [  101,  1045,  1005,  2310,  2042,  3403,  2005,  1037, 17662, 12172,2607,  2026,  2878,  2166,  1012,   102],#        [  101,  2061,  2031,  1045,   999,   102,     0,     0,     0,     0, 0,     0,     0,     0,     0,     0]#    ]),     #    'attention_mask': tensor([#        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],#        [1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]#    ])#}output = model(**tokens) # model(**tokens, labels=labels), å¦‚æœæä¾›labelsï¼Œåˆ™è®¡ç®—æŸå¤±print(output)# SequenceClassifierOutput(#     loss=None,  # æŸå¤±å€¼ï¼Œåœ¨æ²¡æœ‰æä¾›æ ‡ç­¾æ—¶ä¸ºNone#     logits=tensor([#         [-1.5607,  1.6123],  # ç¬¬ä¸€ä¸ªåºåˆ—çš„é¢„æµ‹åˆ†æ•°ï¼ˆä¸¤ä¸ªç±»åˆ«ï¼‰#         [-3.6183,  3.9137]   # ç¬¬äºŒä¸ªåºåˆ—çš„é¢„æµ‹åˆ†æ•°#     ]), #     hidden_states=None,  # éšè—çŠ¶æ€ï¼Œé»˜è®¤ä¸è¿”å›#     attentions=None      # æ³¨æ„åŠ›æƒé‡ï¼Œé»˜è®¤ä¸è¿”å›# )</code></pre><h3 id="tokenizer">tokenizer</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">tokens = tokenizer(    sequences,          # è¾“å…¥æ–‡æœ¬ï¼Œå¯ä»¥æ˜¯å•ä¸ªå­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²åˆ—è¡¨    padding=True,       # å¡«å……è®¾ç½®    truncation=True,    # æˆªæ–­è®¾ç½®    return_tensors="pt" # è¿”å›æ ¼å¼)</code></pre><ul><li><p>padding </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># ç›¸å…³å‚æ•°tokens = tokenizer(    ["Hello", "Hi there!"],    padding=True, # å¡«å……è®¾ç½®    max_length=10, # æœ€å¤§é•¿åº¦é™åˆ¶    padding_side='right' # å¡«å……ä½ç½®ï¼š'left'æˆ–'right')</code></pre><p></p></li><li><p>truncationï¼š æˆªæ–­è®¾ç½®</p></li><li><p>return_tensorsï¼š è¿”å›æ ¼å¼(pt, tf)</p></li><li><p>return_token_type_idsï¼š æ˜¯å¦è¿”å›token_type_ids(é»˜è®¤False,ç”¨äºåŒºåˆ†ä¸åŒå¥å­)</p></li></ul><p><code>output = model(**tokens)</code>å¯¹äºæ–‡æœ¬åˆ†ç±»æ¥è¯´ï¼Œæ•´æ®µæ–‡æœ¬è¾“å…¥è¿”å›ä¸€ä¸ªæ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯SequenceClassifierOutput.logitsï¼Œ</p><p>å¦‚æœæ˜¯æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼Œæ•´æ®µæ–‡æœ¬è¾“å…¥è¿”å›CausalLMOutputWithPastï¼Œ å¯¹äºinput_ids = [v1,v2,v3] è¾“å‡ºä¸º [v20,v30,v4]ã€‚ v20 æ˜¯æ ¹æ®v1ç”Ÿæˆçš„ä¸‹ä¸€ä¸ªtokenï¼ˆå¤§æ¦‚ç‡è·ŸçœŸå®çš„v2 ä¸ä¸€æ ·ï¼‰ï¼Œv4 æ˜¯æ ¹æ®v1,v2,v3 ç”Ÿæˆçš„ã€‚1. ç”Ÿæˆå¼æ¨¡å‹çš„è®­ç»ƒæ˜¯å¹¶è¡Œçš„ï¼Œé çš„attentionmaskæ“ä½œã€‚è®­ç»ƒçš„æ—¶å€™åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å³å¯ï¼Œå› ä¸ºattentionmaskçš„æœºåˆ¶å¯ä»¥ä¿è¯å½“å‰tokençš„lossä¸åŒ…å«åé¢çš„tokenã€‚inputsåˆ™æ˜¯ä¸€ä¸ªdictï¼ŒåŒ…å«input_ids å’Œ attention_maskã€‚ 2.æ¨ç†çš„æ—¶å€™ï¼Œåªèƒ½ä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„æ¨ç†ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨å¤šæ¬¡ã€‚ output =model(inputs) æˆ–è€… output = model.forward(inputs)çš„æ—¶å€™ï¼Œinputså…¶å®ä¹Ÿä¸éœ€è¦åŒ…å« attention_maskï¼Œinputs ä»…ä»…æ˜¯token å°±å¯ä»¥</p><p>model(xx) ==&gt; <code>Module.__call__</code> ==&gt;Module.forward/model.forwardï¼Œå‡ ä¹æ¯ä¸€ä¸ªllm éƒ½ä¼šè‡ªå®šä¹‰forwardæ–¹æ³•ï¼Œå¦‚æœå‘forward æ–¹æ³•ä¼ å…¥ labelsï¼Œè¿˜ä¼šè‡ªåŠ¨è®¡ç®—lossã€‚</p>]]></content>
      
      
      <categories>
          
          <category> transformer </category>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> transformer </tag>
            
            <tag> huggingface </tag>
            
            <tag> qwen </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode å¿«æ·é”®</title>
      <link href="/2025/01/16/vscode-kuai-jie-jian/"/>
      <url>/2025/01/16/vscode-kuai-jie-jian/</url>
      
        <content type="html"><![CDATA[<p>MacOS ç³»ç»Ÿä¸Š Visual Studio Code (VSCode) ä¸€äº›å¸¸ç”¨çš„å¿«æ·é”®</p><p>å‚è€ƒï¼š</p><p>https://www.dute.org/vscode-shortcut</p><p>https://hughfenghen.github.io/posts/2023/03/29/vscode-shortcut/</p><p>å› ä¸ºä¸€èˆ¬éƒ½ä¼šæ­é…vimä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰äº›æ“ä½œæ›´ä¹ æƒ¯é€šè¿‡vimæ–¹å¼ï¼Œå¯¹äºä¸€äº›vimä¸æ–¹ä¾¿å®Œæˆçš„å¸¸ç”¨å¿«æ·é”®ä½¿ç”¨åŠ ç²—æ ‡è®°ã€‚</p><ul><li><code>command + p</code><ul><li>æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åœ¨æ–°æ ‡ç­¾é¡µä¸­</li><li><code>+ &gt;</code> å‘½ä»¤</li><li><code>+ @</code> è½¬åˆ°æœ¬æ–‡ä»¶ä¸­çš„ç¬¦å·</li><li><code>+ #</code> æ˜¾ç¤ºæ‰€æœ‰ç¬¦å·</li></ul></li></ul><h2 id="å¸¸ç”¨å¿«æ·é”®">å¸¸ç”¨å¿«æ·é”®</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><strong><code>Command + Shift + N</code></strong></td><td>æ–°å»ºçª—å£/å®ä¾‹</td></tr><tr class="even"><td><code>Command + W</code></td><td>å…³é—­çª—å£/å®ä¾‹</td></tr><tr class="odd"><td><code>Command + ,</code></td><td>ç¼–è¾‘å™¨è®¾ç½®</td></tr><tr class="even"><td><code>Command + Shift + j</code></td><td>è®¾ç½®(cursor è®¾ç½®)</td></tr><tr class="odd"><td><code>Command + F</code></td><td>æœç´¢</td></tr><tr class="even"><td><strong><code>Command + Shift + F</code></strong></td><td>å…¨å±€æœç´¢</td></tr><tr class="odd"><td><code>Command + Option + F</code></td><td>æ›¿æ¢</td></tr><tr class="even"><td><strong><code>Option + ç‚¹å‡»é¼ æ ‡</code></strong></td><td>åœ¨æ‰€ç‚¹å‡»ä½ç½®æ’å…¥å…‰æ ‡</td></tr><tr class="odd"><td><strong><code>Command + N</code></strong></td><td>æ–°å»ºæ–‡ä»¶</td></tr><tr class="even"><td><strong><code>Command + O</code></strong></td><td>æ‰“å¼€æ–‡ä»¶...</td></tr><tr class="odd"><td><strong><code>Command + S</code></strong></td><td>ä¿å­˜æ–‡ä»¶</td></tr><tr class="even"><td><strong><code>Command + Shift + S</code></strong></td><td>æ–‡ä»¶å¦å­˜ä¸º...</td></tr><tr class="odd"><td><code>Command + Option + S</code></td><td>ä¿å­˜å…¨éƒ¨</td></tr><tr class="even"><td><strong><code>Command + Shift + Space</code></strong></td><td>è§¦å‘å‚æ•°æç¤º</td></tr><tr class="odd"><td><code>Ctrl + number</code></td><td>è·³è½¬æ ‡ç­¾</td></tr><tr class="even"><td><code>Ctrl + tab</code></td><td>æŸ¥çœ‹ç¼–è¾‘å†å²</td></tr><tr class="odd"><td><code>Alt + left</code></td><td>è·³è½¬ä»£ç ä½ç½®(win?)</td></tr><tr class="even"><td><strong><code>Control + -</code></strong></td><td>åé€€</td></tr><tr class="odd"><td><strong><code>Control + Shift + -</code></strong></td><td>å‰è¿›</td></tr></tbody></table><h2 id="å…‰æ ‡æ“ä½œ">å…‰æ ‡æ“ä½œ</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><strong><code>Option + ç‚¹å‡»é¼ æ ‡</code></strong></td><td>åœ¨æ‰€ç‚¹å‡»ä½ç½®æ’å…¥å…‰æ ‡</td></tr><tr class="even"><td><code>Command + Option + â†‘</code></td><td>åœ¨ä¸Šæ–¹æ’å…¥å…‰æ ‡</td></tr><tr class="odd"><td><code>Command + Option + â†“</code></td><td>åœ¨ä¸‹æ–¹æ’å…¥å…‰æ ‡</td></tr><tr class="even"><td><code>Command + U</code></td><td>æ’¤æ¶ˆä¸Šä¸€ä¸ªå…‰æ ‡æ“ä½œ</td></tr><tr class="odd"><td><code>Shift + Option + I</code></td><td>åœ¨æ‰€é€‰çš„æ¯ä¸€è¡Œçš„æœ«å°¾æ’å…¥å…‰æ ‡</td></tr><tr class="even"><td><code>Command + L</code></td><td>é€‰æ‹©å½“å‰è¡Œ</td></tr><tr class="odd"><td><code>Command + F2</code></td><td>é€‰æ‹©æ‰€æœ‰å‡ºç°çš„å½“å‰å•è¯</td></tr><tr class="even"><td><code>Command + Control + Shift + â†’</code></td><td>æ‰©å±•é€‰æ‹©</td></tr><tr class="odd"><td><code>Command + Control + Shift + â†</code></td><td>æ”¶ç¼©é€‰æ‹©</td></tr><tr class="even"><td><code>Shift + Option + æ‹–æ‹½é¼ æ ‡</code></td><td>åˆ—ï¼ˆæ¡†ï¼‰é€‰æ‹©</td></tr><tr class="odd"><td><code>Command + Shift + Option + â†‘</code></td><td>å‘ä¸Šåˆ—ï¼ˆæ¡†ï¼‰é€‰æ‹©</td></tr><tr class="even"><td><code>Command + Shift + Option + â†“</code></td><td>å‘ä¸‹åˆ—ï¼ˆæ¡†ï¼‰é€‰æ‹©</td></tr></tbody></table><h2 id="ä»£ç ç¼–è¾‘">ä»£ç ç¼–è¾‘</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><strong><code>Command + Shift + Space</code></strong></td><td>è§¦å‘å‚æ•°æç¤º</td></tr><tr class="even"><td><code>Shift + Option + F</code></td><td>æ ¼å¼åŒ–æ–‡ä»¶</td></tr><tr class="odd"><td><code>Command + K, Command + F</code></td><td>æ ¼å¼åŒ–é€‰æ‹©</td></tr><tr class="even"><td><strong><code>F12</code></strong></td><td>è½¬åˆ°å®šä¹‰</td></tr><tr class="odd"><td><strong><code>Option + F12</code></strong></td><td>æŸ¥çœ‹å®šä¹‰</td></tr><tr class="even"><td><code>Command + K, F12</code></td><td>åœ¨ä¾§é¢æ‰“å¼€å®šä¹‰</td></tr><tr class="odd"><td><code>Command + .</code></td><td>å¿«é€Ÿä¿®å¤</td></tr><tr class="even"><td><code>Shift + F12</code></td><td>æ˜¾ç¤ºå‚è€ƒ</td></tr><tr class="odd"><td><code>F2</code></td><td>é‡å‘½åç¬¦å·</td></tr></tbody></table><h2 id="çª—å£æ˜¾ç¤º">çª—å£æ˜¾ç¤º</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><code>Command + Control + F</code></td><td>åˆ‡æ¢å…¨å±</td></tr><tr class="even"><td><code>Command + Option + 0</code></td><td>åˆ‡æ¢ç¼–è¾‘å™¨å¸ƒå±€ï¼ˆæ°´å¹³/å‚ç›´ï¼‰</td></tr><tr class="odd"><td><code>Command + =</code></td><td>æ”¾å¤§ç¼–è¾‘å™¨</td></tr><tr class="even"><td><code>Command + -</code></td><td>ç¼©å°ç¼–è¾‘å™¨</td></tr><tr class="odd"><td><code>Command + B</code></td><td>æ˜¾ç¤º/éšè—ä¾§è¾¹æ </td></tr></tbody></table><h2 id="ç»ˆç«¯">ç»ˆç«¯</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><code>Command + j</code></td><td>æ‰“å¼€/å…³é—­ç»ˆç«¯</td></tr></tbody></table><h2 id="å¯¼èˆª">å¯¼èˆª</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><code>F8</code></td><td>è½¬åˆ°ä¸‹ä¸€ä¸ªé”™è¯¯æˆ–è­¦å‘Š</td></tr><tr class="even"><td><code>Shift + F8</code></td><td>è½¬åˆ°ä¸Šä¸€ä¸ªé”™è¯¯æˆ–è­¦å‘Š</td></tr><tr class="odd"><td><code>Control + Shift + Tab</code></td><td>æ˜¾ç¤ºç¼–è¾‘å™¨å†å²è®°å½•</td></tr><tr class="even"><td><strong><code>Control + -</code></strong></td><td>åé€€</td></tr><tr class="odd"><td><strong><code>Control + Shift + -</code></strong></td><td>å‰è¿›</td></tr><tr class="even"><td><code>Control + M</code></td><td>åˆ‡æ¢æ ‡ç­¾å¯ç§»åŠ¨ç„¦ç‚¹</td></tr></tbody></table><h2 id="åŸºæœ¬ç¼–è¾‘vimä¸ºä¸»vscodeä¸æ€ä¹ˆç”¨">åŸºæœ¬ç¼–è¾‘(vimä¸ºä¸»ï¼Œvscodeä¸æ€ä¹ˆç”¨)</h2><table><thead><tr class="header"><th>å¿«æ·é”®</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td><code>Option + â†‘</code></td><td>æŠŠå½“å‰è¡Œå¾€ä¸Šç§»åŠ¨</td></tr><tr class="even"><td><code>Option + â†“</code></td><td>æŠŠå½“å‰è¡Œå¾€ä¸‹ç§»åŠ¨</td></tr><tr class="odd"><td><code>Shift + Option + â†‘</code></td><td>åœ¨ä¸Šé¢å¤åˆ¶è¡Œ</td></tr><tr class="even"><td><code>Shift + Option + â†“</code></td><td>åœ¨ä¸‹é¢å¤åˆ¶è¡Œ</td></tr><tr class="odd"><td><code>Command + Shift + K</code></td><td>åˆ é™¤ä¸€è¡Œ</td></tr><tr class="even"><td><code>Command + Enter</code></td><td>åœ¨ä¸‹é¢æ’å…¥è¡Œ</td></tr><tr class="odd"><td><code>Command + Shift + Enter</code></td><td>åœ¨ä¸Šæ–¹æ’å…¥è¡Œ</td></tr><tr class="even"><td><code>Command + Shift + \</code></td><td>è·³è½¬åˆ°åŒ¹é…çš„æ‹¬å·, vimä¸­å¯ä»¥ä½¿ç”¨<code>%</code></td></tr><tr class="odd"><td><code>Command + ]</code></td><td>å¢åŠ ç¼©è¿›</td></tr><tr class="even"><td><code>Command + [</code></td><td>å‡å°‘ç¼©è¿›</td></tr><tr class="odd"><td><code>Home</code></td><td>è½¬åˆ°è¡Œé¦–</td></tr><tr class="even"><td><code>End</code></td><td>è½¬åˆ°è¡Œå°¾</td></tr><tr class="odd"><td><code>Command + â†‘</code></td><td>è½¬åˆ°æ–‡ä»¶å¼€å¤´</td></tr><tr class="even"><td><code>Command + â†“</code></td><td>è½¬åˆ°æ–‡ä»¶æœ«å°¾</td></tr><tr class="odd"><td><code>Control + Fn + â†‘</code></td><td>å‘ä¸Šæ»šåŠ¨è¡Œ</td></tr><tr class="even"><td><code>Control + Fn + â†“</code></td><td>å‘ä¸‹æ»šåŠ¨è¡Œ</td></tr><tr class="odd"><td><code>Command + Fn + â†‘</code></td><td>å‘ä¸Šæ»šåŠ¨é¡µé¢</td></tr><tr class="even"><td><code>Command + Fn + â†“</code></td><td>å‘ä¸‹æ»šåŠ¨é¡µé¢</td></tr><tr class="odd"><td><code>Command + Option + [</code></td><td>æŠ˜å åŒºåŸŸ</td></tr><tr class="even"><td><code>Command + Option + ]</code></td><td>å±•å¼€åŒºåŸŸ</td></tr><tr class="odd"><td><code>Command + K, Command + 0</code></td><td>æŠ˜å æ‰€æœ‰åŒºåŸŸ</td></tr><tr class="even"><td><code>Command + K, Command + J</code></td><td>å±•å¼€æ‰€æœ‰åŒºåŸŸ</td></tr><tr class="odd"><td><code>Command + K, Command + C</code></td><td>æ·»åŠ è¡Œæ³¨é‡Š</td></tr><tr class="even"><td><code>Command + K, Command + U</code></td><td>åˆ é™¤è¡Œæ³¨é‡Š</td></tr><tr class="odd"><td><code>Command + /</code></td><td>æ³¨é‡Š</td></tr><tr class="even"><td><code>Option + Z</code></td><td>åˆ‡æ¢ç¼–è¾‘å™¨çš„è‡ªåŠ¨æ¢è¡Œ</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> vscode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vscode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Otsu é˜ˆå€¼ç®—æ³•</title>
      <link href="/2025/01/15/otsu-yu-zhi-suan-fa/"/>
      <url>/2025/01/15/otsu-yu-zhi-suan-fa/</url>
      
        <content type="html"><![CDATA[<p>Otsu é˜ˆå€¼ç®—æ³•çš„ç®€å•å®ç°</p><h2 id="ä»€ä¹ˆæ˜¯-otsu-é˜ˆå€¼ç®—æ³•">1. ä»€ä¹ˆæ˜¯ Otsu é˜ˆå€¼ç®—æ³•</h2><p>Otsué˜ˆå€¼ç®—æ³•æ˜¯ä¸€ç§è‡ªé€‚åº”é˜ˆå€¼åˆ†å‰²ç®—æ³•ï¼Œç”¨äºå°†å›¾åƒåˆ†å‰²ä¸ºå‰æ™¯å’ŒèƒŒæ™¯ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æœ€å¤§åŒ–ç±»é—´æ–¹å·®æ¥ç¡®å®šæœ€ä½³é˜ˆå€¼ã€‚</p><p>Otsué˜ˆå€¼ç®—æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šé€šè¿‡è®¡ç®—å›¾åƒçš„ç°åº¦ç›´æ–¹å›¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªé˜ˆå€¼ï¼Œä½¿å¾—å‰æ™¯å’ŒèƒŒæ™¯çš„ç±»é—´æ–¹å·®æœ€å¤§ã€‚</p><h2 id="ç®—æ³•æ­¥éª¤">2. ç®—æ³•æ­¥éª¤</h2><ol type="1"><li>è®¡ç®—å›¾åƒçš„ç°åº¦ç›´æ–¹å›¾:<ul><li>å›¾åƒçš„åƒç´ å€¼è¢«åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªç°åº¦çº§ï¼Œè®¡ç®—æ¯ä¸ªç°åº¦çº§çš„åƒç´ æ•°ã€‚</li><li>è®¡ç®—æ¯ä¸ªç°åº¦çº§çš„åƒç´ æ•°å æ€»åƒç´ æ•°çš„æ¯”ä¾‹ã€‚</li></ul></li><li>è®¡ç®—å‰æ™¯å’ŒèƒŒæ™¯çš„ç±»é—´æ–¹å·®<ul><li>å¯¹æ¯ä¸ªå¯èƒ½çš„é˜ˆå€¼ï¼Œå°†å›¾åƒçš„åƒç´ å€¼åˆ’åˆ†ä¸ºå‰æ™¯å’ŒèƒŒæ™¯ã€‚</li><li>è®¡ç®—è¿™ä¸¤éƒ¨åˆ†çš„ç°åº¦å‡å€¼ã€åƒç´ æ¯”ä¾‹å’Œç±»é—´æ–¹å·®ã€‚</li><li>å¯»æ‰¾ä½¿ç±»é—´æ–¹å·®æœ€å¤§çš„é˜ˆå€¼ã€‚</li></ul></li></ol><h2 id="æ•°å­¦è¡¨è¾¾">3. æ•°å­¦è¡¨è¾¾</h2><ul><li>å‡è®¾æ€»åƒç´ æ•°ä¸º <span class="math inline">\(N\)</span>ï¼Œç°åº¦å€¼çš„èŒƒå›´ä¸º <span class="math inline">\([0, L-1]\)</span>ï¼Œç°åº¦çº§ <span class="math inline">\(k\)</span> çš„åƒç´ æ•°ä¸º <span class="math inline">\(n_k\)</span>ï¼Œç°åº¦çº§ <span class="math inline">\(k\)</span> çš„åƒç´ æ•°å æ€»åƒç´ æ•°çš„æ¯”ä¾‹ä¸º <span class="math inline">\(p_k\)</span>ã€‚</li><li>å¯¹äºxç»™å®šçš„é˜ˆå€¼<span class="math inline">\(t\)</span>ï¼Œç°åº¦å€¼è¢«åˆ†ä¸ºä¸¤ç±»ï¼š<ul><li>å‰æ™¯ç±»<span class="math inline">\(C_1\)</span>ï¼Œç°åº¦å€¼åœ¨<span class="math inline">\([0, t]\)</span>ä¹‹é—´</li><li>èƒŒæ™¯ç±»<span class="math inline">\(C_2\)</span>ï¼Œç°åº¦å€¼åœ¨<span class="math inline">\([t+1, L-1]\)</span>ä¹‹é—´</li></ul></li><li>å‰æ™¯ç±»çš„åƒç´ æ•°æ¯”ä¾‹ï¼š<span class="math inline">\(w_1 = \sum_{i=0}^{t}p_i\)</span></li><li>èƒŒæ™¯ç±»çš„åƒç´ æ•°æ¯”ä¾‹ï¼š<span class="math inline">\(w_2 =\sum_{i=t+1}^{L-1} p_i\)</span></li><li>å‰æ™¯ç±»çš„ç°åº¦å‡å€¼ï¼š<span class="math inline">\(u_1 = \sum_{i=0}^{t} ip_i / w_1\)</span></li><li>èƒŒæ™¯ç±»çš„ç°åº¦å‡å€¼ï¼š<span class="math inline">\(u_2 =\sum_{i=t+1}^{L-1} i p_i / w_2\)</span></li><li>ç±»é—´æ–¹å·®ï¼š<span class="math inline">\(\sigma_b^2 = w_1 w_2 (u_1 -u_2)^2\)</span></li></ul><h2 id="ä»£ç å®ç°">4. <a href="https://github.com/baoblei/otsu">ä»£ç å®ç°</a></h2><ul><li><p>ç®€æ´å®ç°ï¼Œä½¿ç”¨opencvè®¡ç®—ç°åº¦ç›´æ–¹å›¾ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">def otsu_threshold(image):    # è®¡ç®—ç°åº¦ç›´æ–¹å›¾    hist = cv2.calcHist([image], [0], None, [256], [0, 256]) # è®¡ç®—ç°åº¦ç›´æ–¹å›¾    hist = hist.ravel() / hist.sum() # è®¡ç®—ç°åº¦ç›´æ–¹å›¾çš„æ¦‚ç‡    # è®¡ç®—å‰æ™¯å’ŒèƒŒæ™¯çš„ç±»é—´æ–¹å·®    max_var = 0    best_threshold = 0    for threshold in range(256):        w1 = np.sum(hist[:threshold])        w2 = np.sum(hist[threshold+1:])        u1 = np.sum(hist[:threshold] * np.arange(256)) / w1        u2 = np.sum(hist[threshold+1:] * np.arange(threshold+1, 256)) / w2        var = w1 * w2 * (u1 - u2) ** 2        if var &gt; max_var:            max_var = var            best_threshold = thresholdreturn best_threshold</code></pre><p></p></li><li><p>ä¸€èˆ¬æ•°æ®çš„åˆ†å‰² </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">def _otsu_threshold(data):    hist, bins = np.histogram(data, bins=50) # å¯ä»¥æŒ‡å®šbinsçš„æ•°é‡t    bin_centers = (bins[:-1] + bins[1:]) / 2        # OTSUç®—æ³•å®ç°    total = hist.sum()    sum_total = sum(bin_centers * hist)        max_variance = 0    threshold = 0        sum_b = 0    count_b = 0        for i in range(len(hist)):        count_b += hist[i]        if count_b == 0:            continue                    count_f = total - count_b        if count_f == 0:            break                    sum_b += bin_centers[i] * hist[i]        mean_b = sum_b / count_b        mean_f = (sum_total - sum_b) / count_f                variance = count_b * count_f * (mean_b - mean_f) ** 2        if variance &gt; max_variance:            max_variance = variance            threshold = bin_centers[i]                return threshold</code></pre><p></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> image-processing </category>
          
      </categories>
      
      
        <tags>
            
            <tag> otsu </tag>
            
            <tag> threshold </tag>
            
            <tag> image-processing </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¡¬èœæ”¶é›†</title>
      <link href="/2025/01/11/ying-cai-shou-ji/"/>
      <url>/2025/01/11/ying-cai-shou-ji/</url>
      
        <content type="html"><![CDATA[<h2 id="èœè‚´">èœè‚´</h2><h3 id="é…±æ±æ‰’é¸¡">é…±æ±æ‰’é¸¡</h3><p>(6.97 F@u.Sl 03/28 Rxs:/2025å¹´å¤œé¥­ç¬¬äºŒé“ï¼šé…±æ±æ‰’é¸¡ï¼åƒè‚‰åˆå–æ±¤ä¸æµªè´¹ä¸€ç‚¹ç‚¹ï¼ä¸»é¡µæœâ€œé…±æ±æ‰’é¸¡â€æœ‰æ›´è¯¦ç»†çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬æ›´é€‚åˆä¸‹è½½è½¬å‘åˆ°â€œä¸€å®¶äº²â€å“¦~#è€é¥­éª¨ # èˆŒå°–ä¸Šçš„æŠ–éŸ³ # åŒ—æ–¹ç¾é£Ÿ https://v.douyin.com/iysoJKdm/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼) <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250111202836.png"></p><h4 id="é£Ÿæ">é£Ÿæ</h4><ul><li>é¸¡è‚‰</li><li>ç”œé¢é…±</li><li>è‘±å§œè’œã€å…«è§’ã€ç›ã€ç³–</li><li>é¦™æ²¹</li></ul><h4 id="åšæ³•">åšæ³•</h4><ul><li>ç‚–<ul><li>é¸¡æ´—å‡€åˆ‡å—ï¼ŒåŠ å…¥ä¸¤ç‰‡å§œæ”¾å…¥é”…ä¸­ç‚–ä¸€å°æ—¶ã€‚</li><li>ç‚–å¥½çš„é¸¡è‚‰æå‡ºï¼Œé¸¡æ±¤ç•™ç€ï¼Œé¸¡è¿›è¡Œæ‹†éª¨</li></ul></li><li>è’¸<ul><li>å‡†å¤‡é…±æ–™ï¼šç”œé¢é…±+é¸¡æ±¤+ç³– æ··åˆå‡åŒ€</li><li>é¸¡è‚‰æ”¾å…¥å‡†å¤‡å¥½çš„é…±æ–™ä¸­è£…ç›˜ï¼Œå†æ”¾å…¥ä¸¤ç‰‡å§œã€ä¸¤å—è‘±ã€å…«è§’ã€é¦™æ²¹ã€ç›å°‘è®¸ï¼ˆæ ¹æ®ä¹°çš„ç”œé¢é…±çš„å’¸åº¦ï¼‰</li><li>æ”¾å…¥é”…ä¸­è’¸15-20åˆ†é’Ÿ</li></ul></li><li>ç…<ul><li>å°†è’¸å¥½çš„é¸¡è‚‰å–å‡ºæ‹¿æ‰å…¶ä¸­çš„å¤§æ–™</li><li>æ”¾å…¥é”…ä¸­æ”¶æ±ï¼Œå¯ä»¥åŠ å…¥é€‚é‡çš„æ°´æ·€ç²‰å‹¾èŠ¡ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä¸€äº›é¦™æ²¹ï¼Œå°½é‡ä¸è¦æ‹¿å‹ºå­ç‚’</li><li>ä¸€é¢ç…å¥½åç¿»é¢ç»§ç»­ç…ï¼Œç…åˆ°ä¸¤é¢é‡‘é»„å³å¯</li></ul></li><li>è£…ç›˜ï¼šå¯ä»¥å†åŠ å…¥ä¸€äº›é’è’œç‚¹ç¼€ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250111202744.png"></li></ul><h3 id="è’œè“‰ç²‰ä¸è™¾">è’œè“‰ç²‰ä¸è™¾</h3><p>7.12 odN:/ 06/30 J@i.pqå¹´å¤œé¥­å¤§èœï¼è’œè“‰ç²‰ä¸è™¾ï¼Œå¯“æ„è…°ç¼ ä¸‡è´¯ï¼å®¶é‡Œæ¥å®¢äººä¸€å®šå°‘ä¸äº†ï¼# è’œè“‰ç²‰ä¸è™¾# å¹´å¤œé¥­ # å¹´å¤œé¥­èœè°± # è…°ç¼ ä¸‡è´¯è™¾ https://v.douyin.com/iyGesNSt/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250111205942.png">#### é£Ÿæ - åŸºå›´è™¾ - ç²‰ä¸ - è’œè“‰é…±ï¼ˆä¹Ÿå¯ä»¥è‡ªåˆ¶ï¼‰ - è’¸é±¼è±‰æ²¹ -è‘±èŠ±ã€ç›ã€ç™½ç³–ã€æ–™é…’ã€ç™½èƒ¡æ¤’ç²‰</p><h4 id="åšæ³•-1">åšæ³•</h4><ul><li>è’œè“‰é…±åšæ³•<ul><li>è’œå‰ç¢</li><li>ä¸€åŠæ”¾å…¥æ°´ä¸­æµ¸æ³¡</li><li>å‰©ä¸‹ä¸€åŠå¤§è’œä¸­æ”¾ä¸€ç‚¹ç›è¿›è¡Œè…Œåˆ¶ï¼ˆè¿™ä¸ªæ—¶å€™å¯ä»¥å…ˆå»å¤„ç†è™¾äº†ï¼‰</li><li>é”…ä¸­æ”¾æ²¹ï¼ˆéœ€è¦æ²¡è¿‡å‡†å¤‡çš„è’œè“‰ï¼‰ï¼Œçƒ§è‡³ä¸‰æˆçƒ­</li><li>æ°´ä¸­æµ¸æ³¡çš„è’œè“‰å…ˆæå‡ºä¸‹é”…ï¼Œå¤§ç«æ…åŠ¨è‡³è’œè“‰å˜è‰²ï¼Œæå‡º</li><li>ç›è…Œè¿‡çš„è’œè“‰ä¸æ”¾é”…ç‚’ï¼ŒåŠ å…¥ä¸€ä¸‹ç™½ç³–ã€ç™½èƒ¡æ¤’ç²‰</li><li>ç‚¸é”…çš„è’œæ”¾å…¥è…Œè¿‡çš„è’œä¸­ï¼ŒæŠ„æ‹Œ</li><li>æ²¹é‡æ–°çƒ§çƒ­ï¼Œå€’å…¥è’œä¸­</li></ul></li><li>ç™½è™¾å¤„ç†ï¼š<ul><li>å»å¤´ï¼ŒåèƒŒå¹³ç‰‡ä¸€åˆ€ï¼Œå°¾å·´å¯ä»¥é¡ºç€è…¹éƒ¨ä¼ è¿‡æ¥åšä¸ªé€ å‹</li><li>æ”¾å…¥å°‘è®¸ç›ã€æ–™é…’ã€ç™½ç³–ã€ç™½èƒ¡æ¤’ç²‰ç®€å•è…Œåˆ¶ä¸€ä¸‹</li></ul></li><li>è’¸ï¼š<ul><li>ç²‰ä¸æ³¡è½¯ï¼Œå‰ªçŸ­</li><li>ç²‰ä¸å¯ä»¥å·æˆåœˆï¼Œåœˆä¸­é—´éƒ¨åˆ†æ”¾è™¾</li><li>è’œè“‰é…±æµ‡åœ¨è™¾ä¸Š</li><li>è’¸é”…ä¸­è’¸10åˆ†é’Ÿ</li></ul></li><li>è£…ç›˜ï¼šæ’’ä¸Šè‘±èŠ±ã€å€’å…¥è’¸é±¼è±‰æ²¹ï¼Œæœ€åæµ‡ä¸Šçƒ­æ²¹</li></ul><h3 id="çº¢çƒ§è‚‰">çº¢çƒ§è‚‰</h3><p>9.41 n@q.eb fod:/ 06/01çº¢çƒ§è‚‰ä¸€æ¬¡æˆåŠŸï¼ä¸­ç§‹èŠ‚å›¢åœ†èœå•ï¼æœ€å¥½åƒçš„å®¶å¸¸èœåšæ³•ï¼ä¸ç”¨ç‚’ç³–è‰²ï¼è¶…ä¸‹é¥­çš„çº¢çƒ§äº”èŠ±è‚‰ï¼#å¦ˆå‘€å¤ªé¦™äº† # çº¢çƒ§è‚‰ # å®¶å¸¸èœ # ä¸‹é¥­èœ # æŠ–éŸ³ç¾é£Ÿæ¨èå®˜ #é‡è§æ‡‚ä½ çš„å¿ƒåŠ¨å¥½å‘³ # ç¾å¥½ç”Ÿæ´»å°½åœ¨æŠ–éŸ³ç”µå•† # æå‰ç¥å¤§å®¶ä¸­ç§‹èŠ‚å¿«ä¹ #ä¸­ç§‹èŠ‚ <span class="citation" data-cites="æŠ–éŸ³å°åŠ©æ‰‹">@æŠ–éŸ³å°åŠ©æ‰‹</span><span class="citation" data-cites="DOU+å°åŠ©æ‰‹">@DOU+å°åŠ©æ‰‹</span>https://v.douyin.com/iyGNQA37/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼</p><h4 id="é£Ÿæ-1">é£Ÿæ</h4><ul><li>äº”èŠ±ä¸‰å±‚ç˜¦å…­è‚¥å››è‚‰</li><li>å¤§è‘±ã€è‘±å§œ</li><li>å†°ç³–</li><li>è€æŠ½ã€ç”ŸæŠ½ã€é»„é…’</li><li>å…«è§’ã€é¦™å¶ã€æ¡‚çš®</li></ul><h4 id="åšæ³•-2">åšæ³•</h4><ul><li>çŒªè‚‰å¤„ç†<ul><li>æŠŠè‚‰çš®éƒ¨åˆ†æ”¾å…¥çƒ­é”…é‡Œï¼Œåœ¨é”…åº•çƒ«çš®ï¼Œå¤§çº¦ä¸¤åˆ†é’Ÿåæ‹¿å‡º</li><li>ç”¨åˆ€æŠŠçƒ«çš®åˆ®å¹²å‡€</li><li>è‚‰å€’å…¥å†·æ°´çš„é”…é‡Œå®šå‹ï¼Œæ”¾å…¥è‘±å§œã€é»„é…’ç­‰æ°´æ²¸è…¾åäº”åˆ†é’Ÿåå–å‡º</li><li>è‚‰è¿›è¡Œåˆ‡å—</li></ul></li><li>çº¢çƒ§<ul><li>é”…ä¸­å°‘è®¸æ²¹ï¼ˆæŠ¹åœ¨é”…é¢å°±è¡Œï¼‰ï¼Œäº”èŠ±è‚‰å—å¤§ç«ç…è‡³å››é¢é‡‘é»„ï¼Œç…å‡ºæ¥çš„æ²¹å€’å‡º</li><li>ä¸€ç‚¹èŠ±ç”Ÿæ²¹æ”¾å…¥å†°ç³–ï¼ˆ10é¢—å·¦å³ï¼Œå‹‡æ•¢æ”¾ç”œå£çš„å¥½åƒï¼‰ï¼Œæœ€å°ç«ç‚’åˆ°çº¢è‰²å†’æ³¡</li><li>æŠŠè‚‰æ”¾å…¥é”…ä¸­ï¼Œç¨å¾®ç‚’ä¸ªç³–è‰²ï¼Œå†åŠ å…¥åŠç¢—é»„é…’ï¼Œä»¥åŠä¸‰å‹ºç”ŸæŠ½ã€ä¸‰å‹ºè€æŠ½</li><li>åŠ å…¥é¦™æ–™ï¼šå…«è§’3ä¸ªã€æ¡‚çš®ä¸€æ®µã€é¦™å¶2ç‰‡ã€å§œç‰‡å’Œä¸€ä¸ªè‘±ç»“</li><li>å€’å…¥å†·æ°´ï¼ˆåŸºæœ¬æ»¡é”…ï¼‰ç›–ä¸Šé”…ç›–ç„–ç…®45åˆ†é’Ÿï¼Œä¸­é—´å¦‚æœæ°´å¹²äº†è¦å†åŠ å…¥æ°´é˜²æ­¢ç…®å¹²äº†</li></ul></li><li>æ”¶æ±<ul><li>æŠŠé¦™æ–™å–å‡ºï¼ŒåŠ å°‘è®¸ç›æå‘³</li><li>å¤§ç«æ”¶æ±</li><li>æœ€åè½¬å°ç«æ…¢ç‚’</li></ul></li></ul><h3 id="å¯ä¹é¸¡ç¿…">å¯ä¹é¸¡ç¿…</h3><p>2.56 y@t.eb 11/30 Wzt:/ çˆ·ä¿©å„¿ç‰ˆçš„å¯ä¹é¸¡ç¿…ï¼Œçœ‹çœ‹å’Œä½ åšçš„æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ#ç¾é£Ÿè¶£èƒƒè®¡åˆ’# å¯ä¹é¸¡ç¿…# æŠ–éŸ³å°åŠ©æ‰‹ https://v.douyin.com/iyG6DNCv/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼</p><h4 id="é£Ÿæ-2">é£Ÿæ</h4><ul><li>é¸¡ç¿…</li><li>å¯ä¹</li><li>å§œ</li><li>ç”ŸæŠ½ã€è€æŠ½ã€é»„é…’</li><li>ç›ã€ç™½ç³–</li><li>èŠéº»</li></ul><h4 id="åšæ³•-3">åšæ³•</h4><ul><li>é¸¡ç¿…æ”¹åˆ€ï¼ˆç‰‡åˆ‡æˆ–è€…ç‰™ç­¾æ‰æ´ï¼‰</li><li>ç…é¸¡ç¿…è‡³åŒé¢å¾®é»„</li><li>æ”¾å…¥å§œç‰‡ï¼Œå¤§ç«ï¼Œæ”¾å…¥äº›è®¸é»„é…’å»è…¥</li><li>å€’å…¥ä¸€ç“¶å¯ä¹ï¼Œä¸¤å‹ºç”ŸæŠ½ï¼ŒåŠå‹ºç›ï¼Œä¸€å‹ºç™½ç³–</li><li>ç…®æ²¸åæ’‡å»æµ®æ²«ï¼Œç›–ä¸Šç›–å­ä¸­å°ç«ç„–20åˆ†é’Ÿ</li><li>å¼€é”…æ‹¿æ‰å§œç‰‡ï¼Œä¸­å°ç«æ”¶æ±ï¼Œæœ€åä¹Ÿå¯ä»¥æ’’ä¸Šä¸€æŠŠèŠéº»ï¼Œç„¶åå‡ºé”…</li></ul><h3 id="è¾£æ¤’ç‚’è‚‰">è¾£æ¤’ç‚’è‚‰</h3><p>2.02 m@d.nq 10/26 Kjp:/ ä½ ä»¬è§‰å¾—è¿™æ ·ç‚’çš„è¾£æ¤’ç‚’è‚‰æ­£å®—ä¸å’¯#ç¾é£Ÿè¶£èƒƒè®¡åˆ’ # æç‚¹æ–°å“778 https://v.douyin.com/iyoUW8dj/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼</p><h4 id="é£Ÿæ-3">é£Ÿæ</h4><ul><li>äº”èŠ±è‚‰</li><li>å‰åè…¿ç˜¦è‚‰</li><li>èºä¸æ¤’ï¼Œå°½é‡å«©ä¸€ç‚¹çš„</li><li>è’œã€è±†è±‰</li><li>ç”ŸæŠ½ã€è€æŠ½ã€èšæ²¹ã€å‘³ç²¾ã€ç›</li></ul><h4 id="åšæ³•-4">åšæ³•</h4><ul><li>å¤„ç†è‚‰<ul><li>äº”èŠ±è‚‰åˆ‡è–„ç‰‡ï¼Œç˜¦è‚‰åˆ‡è–„ç‰‡</li><li>ç˜¦è‚‰åŠ èšæ²¹é…±æ²¹æ…æ‹Œè…Œåˆ¶</li><li>é”…ä¸­åŠ æ²¹ï¼Œäº”èŠ±è‚‰ç…¸å‡ºæ²¹ï¼ŒåŠ å…¥å››äº”ç“£è’œï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä¸€ç‚¹è±†è±‰ï¼Œæœ€åä¸Šé…±æ²¹</li><li>é”…ä¸­åŠ å…¥è…Œå¥½çš„ç˜¦è‚‰ï¼Œä¹æˆç†Ÿä¸€èµ·æå‡º</li></ul></li><li>ç‚’<ul><li>è¾£æ¤’æ»šåˆ€åˆ‡ï¼Œé”…ä¸­åŠ æ²¹ï¼ˆå°‘é‡æˆ–è€…ä¸åŠ ï¼‰ï¼Œè¾£æ¤’åœ¨é”…ä¸­é•­ï¼ˆç”¨å‹ºå­å‹ç‚’ï¼‰å¹²æ°´æ±½</li><li>å†æ”¾å…¥ç‚’è‚‰ä¸­çš„æ²¹ï¼Œç¿»ç‚’å…¥å‘³</li><li>å€’å…¥ç‚’å¥½çš„è‚‰ï¼ŒåŠ ä¸€ç‚¹å‘³ç²¾å’Œç›ï¼Œç¿»ç‚’å‡åŒ€ï¼Œå‡ºé”…</li></ul></li></ul><h2 id="ç³•ç‚¹">ç³•ç‚¹</h2><h3 id="æˆšé£è›‹ç³•ç©ºæ°”ç‚¸é”…ç‰ˆ">æˆšé£è›‹ç³•ï¼ˆç©ºæ°”ç‚¸é”…ç‰ˆï¼‰</h3><p>3.33 dNj:/ D@h.Ox 12/03æƒ³åšè›‹ç³•åˆæ²¡çƒ¤ç®±çš„çœ‹è¿‡æ¥å•¦ï¼ä»Šå¤©åšçš„æ˜¯ç©ºæ°”ç‚¸é”…ç‰ˆæˆšé£ï¼å¾ˆè¯¦ç»†çš„æ­¥éª¤åˆ†äº«ç»™å¤§å®¶ï¼#æˆšé£è›‹ç³• # çƒ˜ç„™æ–°æ‰‹ # å®¶åº­çƒ˜ç„™ https://v.douyin.com/iyGhDMX4/å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼ #### å‡†å¤‡ - ç©ºæ°”ç‚¸é”… -ç”µåŠ¨æ‰“è›‹å™¨ã€åˆ®åˆ€ã€è›‹æŠ½ - é¸¡è›‹ã€é¢ç²‰ã€ç™½ç³–ã€é£Ÿç”¨æ²¹ -ä¸¤ä¸ªå™¨çš¿ï¼Œä¸€ä¸ªè›‹ç³•æ¨¡å…·ï¼ˆ4å¯¸/6å¯¸ï¼‰ #### åšæ³• -25å…‹ç‰ç±³æ²¹ã€35å…‹ç‰›å¥¶æ…æ‹Œè‡³ä¹³åŒ– - ä½ç­‹é¢ç²‰45gåŠ å…¥å…¶ä¸­ï¼Œæ…æ‹Œè‡³æ— å¹²ç²‰çš„çŠ¶æ€-åˆ†ç¦»ä¸‰ä¸ªè›‹æ¸…è›‹é»„ï¼Œè›‹é»„åŠ å…¥åˆšåˆšçš„é¢ç³Šä¸­æ…æ‹Œå‡åŒ€ï¼Œè‡³æ»´è½æœ‰æµåŠ¨æ€§ï¼Œä½†æ»´è½ä¸‹å»å½¢çŠ¶ä¸ä¼šç«‹åˆ»æ¶ˆå¤±- ç©ºæ°”ç‚¸é”…æ”¾å…¥ä¸€ç¢—æ¸©æ°´ï¼Œ140åº¦é¢„çƒ­15minã€‚ -è›‹æ¸…ä¸­åŠ å…¥30å…‹ç³–ï¼Œæ‰“å‘ï¼Œè¦æ±‚æœ€åæèµ·åæœ‰ç›´ç«‹çš„å°–è§’ -å»ä¸€éƒ¨åˆ†è›‹ç™½å’Œè›‹ç³Šæ··åˆå‡åŒ€ï¼Œæ··åˆå¥½åå€’å…¥å‰©ä½™çš„è›‹ç™½éœœä¸­ -<strong>ç¿»æ‹Œï¼ˆä¸èƒ½æ…ï¼‰</strong>ï¼Œå€’å…¥æ¨¡å…·ä¸­ï¼Œæ•´ç†è¡¨é¢å¹³æ•´ -åŒ…ä¸Šé”¡çº¸ï¼Œä¸Šæ–¹ç”¨ç‰™ç­¾æ‰å‡ ä¸ªæ´ï¼Œæ”¾å…¥ç‚¸é”…ï¼Œ200åº¦çƒ¤40minï¼Œç„¶åå¿«é€Ÿæ­æ‰é”¡çº¸180åº¦å†çƒ¤5åˆ†é’Ÿè¡¨é¢ä¸Šè‰²- çƒ¤å¥½åæ‹¿å‡ºå€’æ‰£ï¼Œå‡‰äº†åå†è„±æ¨¡</p>]]></content>
      
      
      <categories>
          
          <category> ç”Ÿæ´» </category>
          
          <category> ç¾é£Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> èœè°± </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pipå’Œcondaçš„é•œåƒé…ç½®</title>
      <link href="/2025/01/10/pip-he-conda-de-jing-xiang-pei-zhi/"/>
      <url>/2025/01/10/pip-he-conda-de-jing-xiang-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="pip">pip</h2><ul><li>æ–‡ä»¶è·¯å¾„ï¼š<code>~/.pip/pip.conf</code></li><li>é…ç½®å†…å®¹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[global]index-url = https://pypi.tuna.tsinghua.edu.cn/simple[install]trusted-host = https://pypi.tuna.tsinghua.edu.cn</code></pre></li><li>æŸ¥çœ‹ é•œåƒåœ°å€ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip config list</code></pre></li></ul><h2 id="conda">conda</h2><ul><li>æ–‡ä»¶è·¯å¾„ï¼š<code>~/.condarc</code></li><li>é…ç½®å†…å®¹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">channels:  - defaultsshow_channel_urls: truedefault_channels:  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2custom_channels:  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud  deepmodeling: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/</code></pre></li><li>æŸ¥çœ‹ é•œåƒåœ°å€ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda config --show</code></pre></li></ul><p><strong>æ³¨æ„</strong></p><p>é•œåƒåœ°å€æœ‰å¯èƒ½ä¼šå˜åŒ–ï¼Œå½“æ— æ³•ä½¿ç”¨æ—¶è®°å¾—æœ€æ–°çš„é•œåƒåœ°å€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pip </tag>
            
            <tag> conda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨dockerå®¹å™¨ä¸­ä½¿ç”¨å®¿ä¸»æœºå¯†é’¥</title>
      <link href="/2025/01/10/zai-docker-rong-qi-zhong-shi-yong-su-zhu-ji-mi-yao/"/>
      <url>/2025/01/10/zai-docker-rong-qi-zhong-shi-yong-su-zhu-ji-mi-yao/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ Docker å®¹å™¨ä¸­ä¸è¿œç¨‹ GitHub å»ºç«‹å®‰å…¨è¿æ¥æ—¶ï¼Œç›´æ¥åœ¨å®¹å™¨å†…ç”Ÿæˆæ–°çš„SSHå¯†é’¥å­˜åœ¨ä¸€å®šçš„æ³„æ¼é£é™©ï¼Œç‰¹åˆ«æ˜¯å¦‚æœå®¹å™¨ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­æˆ–éœ€è¦å…±äº«å®¹å™¨çš„æƒ…å†µä¸‹ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å®‰å…¨çš„æ–¹æ³•æ¥å¤„ç†è¿™ç§åœºæ™¯ï¼š## 1. ä½¿ç”¨å®¿ä¸»æœºå·²æœ‰çš„ SSH å¯†é’¥ å°†å®¿ä¸»æœºä¸­å·²ç»é…ç½®å¥½çš„ SSHå¯†é’¥æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯åœ¨å®¹å™¨å†…ç”Ÿæˆæ–°çš„å¯†é’¥ã€‚è¿™ç§æ–¹å¼å¯ä»¥é¿å…å¯†é’¥æ³„æ¼ã€‚- åœ¨å®¿ä¸»æœºä¸Šç¡®è®¤å·²æœ‰çš„ SSH å¯†é’¥ï¼Œé€šå¸¸è·¯å¾„æ˜¯ ~/.ssh/id_rsa å’Œ~/.ssh/id_rsa.pubã€‚ - åœ¨å¯åŠ¨å®¹å™¨æ—¶å°†å®¿ä¸»æœºçš„ SSH å¯†é’¥æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -it \    -v ~/.ssh:/root/.ssh:ro \     your_image_name</code></pre> -v ~/.ssh:/root/.ssh:roï¼šå°†å®¿ä¸»æœºçš„ .sshç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„/root/.sshï¼Œå¹¶è®¾ç½®ä¸ºåªè¯»ï¼ˆroï¼‰ï¼Œé¿å…å®¹å™¨ç¯¡æ”¹å¯†é’¥æ–‡ä»¶ã€‚ - åœ¨å®¹å™¨ä¸­éªŒè¯SSH è¿æ¥ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh -T git@github.com</code></pre> ## 2. ä½¿ç”¨ SSH Agent Forwarding é€šè¿‡ SSH Agentè½¬å‘ï¼ˆSSH_AUTH_SOCKï¼‰ï¼Œè®©å®¹å™¨ä½¿ç”¨å®¿ä¸»æœºçš„ SSHAgentï¼Œè€Œä¸ç›´æ¥æš´éœ²å¯†é’¥æ–‡ä»¶ã€‚ - å¯åŠ¨ SSH Agentï¼Œç¡®ä¿å®¿ä¸»æœºä¸­ SSH Agentæ­£åœ¨è¿è¡Œï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">eval "$(ssh-agent -s)"ssh-add ~/.ssh/id_rsa</code></pre> - æ·»åŠ å¯†é’¥åˆ° SSH Agentï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-add ~/.ssh/id_rsa</code></pre> -å¯åŠ¨å®¹å™¨æ—¶ï¼Œå°†å®¿ä¸»æœºçš„ SSH Agent Socket æŒ‚è½½åˆ°å®¹å™¨ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -it --rm \    -v $SSH_AUTH_SOCK:/ssh-agent \    -e SSH_AUTH_SOCK=/ssh-agent \    your_image_name</code></pre><p></p><h2 id="ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’-git-token">3.ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’ GIT Token</h2><p>å¦‚æœåªéœ€è¦ä½¿ç”¨ Git è€Œä¸éœ€è¦å®Œæ•´çš„ SSH åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ GitHub æä¾›çš„Personal Access Token (PAT)ã€‚ - Settings &gt; Developer settings &gt;Personal access tokensã€‚åœ¨ GitHub ä¸Šç”Ÿæˆ Personal Access Tokenï¼Œå‹¾é€‰repo æƒé™ã€‚ - åœ¨è¿è¡Œå®¹å™¨æ—¶ï¼Œå°† Token ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -it --rm \    -e GITHUB_TOKEN=your_personal_access_token \    your_image_name</code></pre> -åœ¨å®¹å™¨ä¸­ï¼Œä½¿ç”¨ HTTPS URL ç»“åˆ Tokenï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git clone https://&lt;your_username&gt;:${GITHUB_TOKEN}@github.com/&lt;repo_owner&gt;/&lt;repo_name&gt;.git</code></pre><p></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> git </tag>
            
            <tag> github </tag>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git&amp;GitHubæ—¥å¸¸ä½¿ç”¨æ–¹æ³•</title>
      <link href="/2025/01/09/git-github-ri-chang-shi-yong-fang-fa/"/>
      <url>/2025/01/09/git-github-ri-chang-shi-yong-fang-fa/</url>
      
        <content type="html"><![CDATA[<p>åº”è¯¥å­¦è¿‡è®¡ç®—æœºçš„äººéƒ½çŸ¥é“gitå’Œgithubï¼ŒåŸºæœ¬ä¸Šä¼´éšæˆ‘ä»¬çš„æ•´ä¸ªç¼–ç¨‹ç”Ÿæ¶¯ã€‚ä½†æ˜¯åšä¸»ç”±äºå¹¶éç§‘ç­å‡ºèº«ï¼Œè™½ç„¶æ—¥å¸¸éƒ½åœ¨ç”¨ï¼Œä½†æ˜¯ä¸€ç›´å¯¹é‡Œé¢çš„ä¸€äº›æ¦‚å¿µå’Œæ“ä½œä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ¯æ¬¡é‡åˆ°é—®é¢˜éƒ½æ˜¯ç™¾åº¦ä¸€ä¸‹ï¼Œè§£å†³äº†å°±å¿˜è®°äº†ã€‚æ‰€ä»¥æƒ³é€šè¿‡è¿™ç¯‡æ–‡ç« æ¥æ¢³ç†è®°å½•ä¸€ä¸‹gitå’Œgithubçš„æ—¥å¸¸ä½¿ç”¨æ–¹æ³•ï¼Œæ–¹ä¾¿è‡ªå·±æŸ¥é˜…ï¼Œä¹Ÿå¸Œæœ›èƒ½å¸®åŠ©åˆ°æœ‰éœ€è¦çš„äººã€‚</p><h2 id="gitå’Œgithubçš„æ¦‚å¿µ">Gitå’ŒGitHubçš„æ¦‚å¿µ</h2><ul><li>Git æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç”¨äºç®¡ç†ä»£ç ç‰ˆæœ¬å’Œåä½œå¼€å‘ã€‚</li><li>GitHub æ˜¯ä¸€ä¸ªåŸºäº Gitçš„ä»£ç æ‰˜ç®¡å¹³å°ï¼Œæä¾›äº†ä»£ç æ‰˜ç®¡ã€ç‰ˆæœ¬ç®¡ç†ã€åä½œå¼€å‘ç­‰åŠŸèƒ½ã€‚åŒæ—¶å¢åŠ äº†ç•Œé¢åŒ–çš„åŠŸèƒ½ï¼Œå¦‚Pull Requestsã€Issues å’Œ Wikiã€‚</li></ul><h2 id="gitä¸githubçš„è”åˆé…ç½®">gitä¸githubçš„è”åˆé…ç½®</h2><ol type="1"><li>å®‰è£…Git</li></ol><ul><li>è®¿é—® <a href="https://git-scm.com/">Git å®˜æ–¹ç½‘ç«™</a>ä¸‹è½½å¹¶å®‰è£…é€‚åˆæ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ã€‚</li><li>éªŒè¯å®‰è£…ï¼šåœ¨å‘½ä»¤è¡Œè¾“å…¥<code>git --version</code>ï¼Œæ˜¾ç¤ºç‰ˆæœ¬å·åˆ™å®‰è£…æˆåŠŸã€‚</li></ul><ol start="2" type="1"><li>é…ç½®Git</li></ol><ul><li>é…ç½®ç”¨æˆ·åï¼š<code>git config --global user.name "Your Name"</code></li><li>é…ç½®é‚®ç®±ï¼š<code>git config --global user.email "your_email@example.com"</code></li></ul><ol start="3" type="1"><li>åˆ›å»º GitHub è´¦æˆ·å¹¶è®¾ç½® SSH å¯†é’¥</li></ol><ul><li>æ³¨å†Œ GitHub è´¦æˆ·</li><li>ç”Ÿæˆ SSHå¯†é’¥ï¼š<code>ssh-keygen -t ed25519 -C "your_email@example.com"</code></li><li>å°† SSH å¯†é’¥æ·»åŠ åˆ° GitHub è´¦æˆ·ï¼šå°† <code>~/.ssh/id_ed25519.pub</code>æ–‡ä»¶ä¸­çš„å†…å®¹æ·»åŠ åˆ° GitHub è´¦æˆ·çš„ SSH keys ä¸­ã€‚</li><li>éªŒè¯GitHubè¿æ¥ï¼š<code>ssh -T git@github.com</code><strong>å¦‚æœä½ æ˜¯åœ¨dockerå®¹å™¨ä¸­è¿æ¥githubï¼Œä¸ºäº†é¿å…SSHå¯†é’¥çš„æ³„æ¼é£é™©åº”è¯¥<a href="">ä½¿ç”¨å®¿ä¸»æœºå·²æœ‰çš„ SSH å¯†é’¥</a></strong><strong>æ³¨æ„.sshç›®å½•ä¸­çš„æƒé™ä¸èƒ½ä¿®æ”¹ï¼Œå¦‚æœå‡ºç°æƒé™å¤ªè¿‡å¼€æ”¾ï¼Œåˆ™éœ€è¦ä¿®æ”¹.sshç›®å½•çš„æƒé™</strong><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">chmod 700 ~/.sshchmod 600 ~/.ssh/id_ed25519chmod 644 ~/.ssh/id_ed25519.pub</code></pre></li></ul><ol start="4" type="1"><li>Git ä¸ GitHub çš„è¿æ¥</li></ol><ul><li>åœ¨ GitHub ä¸Šåˆ›å»ºä»“åº“ï¼Œè·å–ä»“åº“åœ°å€ï¼ˆhttpsæˆ–sshåœ°å€ï¼‰</li><li>åœ¨é¡¹ç›®çš„æœ¬åœ°ç›®å½•ä¸­åˆå§‹åŒ–ä»“åº“ï¼š<code>git init</code></li><li>æ·»åŠ è¿œç¨‹ä»“åº“åœ°å€ï¼š<code>git remote add origin &lt;ä»“åº“åœ°å€&gt;  # æ·»åŠ è¿œç¨‹ä»“åº“</code></li><li>åŸºæœ¬å‘½ä»¤ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git add .          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒºgit commit -m "æäº¤ä¿¡æ¯"  # æäº¤åˆ°æœ¬åœ°ä»“åº“git push origin main  # æ¨é€åˆ°è¿œç¨‹ä»“åº“</code></pre> ### submodule åœ¨ Gitä¸­ï¼Œå­æ¨¡å—ï¼ˆsubmoduleï¼‰ æ˜¯ä¸€ä¸ª Git ä»“åº“åµŒå¥—åœ¨å¦ä¸€ä¸ª Gitä»“åº“ä¸­çš„å·¥å…·ã€‚å°†å¦ä¸€ä¸ªä»“åº“çš„ç‰¹å®šåˆ†æ”¯ä½œä¸ºå­æ¨¡å—åŠ å…¥å½“å‰ä»“åº“çš„æµç¨‹å¦‚ä¸‹ï¼š</li><li>åœ¨ä¸»ä»“åº“ä¸­æ·»åŠ å­æ¨¡å—ï¼š<code>git submodule add -b &lt;åˆ†æ”¯å&gt; &lt;ç›®æ ‡ä»“åº“åœ°å€&gt; &lt;å­æ¨¡å—è·¯å¾„&gt;</code><ul><li>-b &lt;åˆ†æ”¯å&gt;: æŒ‡å®šç›®æ ‡ä»“åº“çš„åˆ†æ”¯ã€‚</li><li>&lt;ç›®æ ‡ä»“åº“åœ°å€&gt;: å¦‚ï¼šhttps://github.com/example/target-repo.gitsubmodules/target-repo</li><li>&lt;å­æ¨¡å—è·¯å¾„&gt;ï¼šå­æ¨¡å—åœ¨å½“å‰ä»“åº“ä¸­çš„å­˜å‚¨è·¯å¾„,å¦‚submodules/target-repo</li></ul></li><li>åˆå§‹åŒ–å¹¶æ›´æ–°å­æ¨¡å—ï¼š<code>git submodule update --init --recursive</code></li><li>æäº¤æ›´æ”¹ï¼Œæ·»åŠ å­æ¨¡å—åï¼Œéœ€è¦æäº¤å­æ¨¡å—çš„å…ƒä¿¡æ¯åˆ°ä¸»ä»“åº“ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git add .gitmodules submodules/target-repogit commit -m "Add submodule target-repo"</code></pre></li><li>å¦‚æœç›®æ ‡ä»“åº“çš„æŒ‡å®šåˆ†æ”¯å‘ç”Ÿæ›´æ”¹ï¼Œä½ å¯ä»¥æ›´æ–°å­æ¨¡å—åˆ°æœ€æ–°çŠ¶æ€ï¼š<code>git submodule update --remote</code></li><li>å¦‚æœä½ æ˜¯å…‹éš†ä¸€ä¸ªåŒ…å«å­æ¨¡å—çš„ä»“åº“ï¼Œå¯ä»¥ä½¿ç”¨<code>git clone --recurse-submodules &lt;ä»“åº“åœ°å€&gt;</code>é€‰é¡¹æ¥è‡ªåŠ¨åˆå§‹åŒ–å’Œæ›´æ–°å­æ¨¡å—ã€‚æˆ–è€…åœ¨æ­£å¸¸å…‹éš†åæ‰§è¡Œ<code>git submodule update --init --recursive</code>ã€‚</li><li>å­æ¨¡å—ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ†æ”¯ï¼Œéœ€è¦è¿›å…¥å­æ¨¡å—ç›®å½•ï¼Œæ‰§è¡Œï¼š<code>git checkout &lt;è‡ªæ¨¡å—çš„åˆ†æ”¯å&gt;</code></li></ul><h3 id="å…¸å‹å·¥ä½œæµç¨‹">å…¸å‹å·¥ä½œæµç¨‹</h3><ol type="1"><li>å…‹éš†ä»“åº“ï¼š<code>git clone &lt;ä»“åº“åœ°å€&gt;</code></li><li>åŒæ­¥æ›´æ–°ï¼š<code>git pull origin main</code></li><li>åˆ†æ”¯ç®¡ç†ï¼š<ul><li>åˆ›å»ºåˆ†æ”¯ï¼š<code>git branch &lt;åˆ†æ”¯å&gt;</code></li><li>åˆ‡æ¢åˆ†æ”¯ï¼š<code>git checkout &lt;åˆ†æ”¯å&gt;</code></li><li>åˆå¹¶åˆ†æ”¯ï¼š<code>git merge &lt;åˆ†æ”¯å&gt;</code> #è¦å…ˆåˆ‡æ¢åˆ°ä¸»åˆ†æ”¯</li><li>åˆ é™¤åˆ†æ”¯ï¼š<code>git branch -d &lt;åˆ†æ”¯å&gt;</code></li></ul></li><li>æäº¤æ›´æ”¹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git add .git commit -m "æäº¤ä¿¡æ¯"git push origin main</code></pre></li></ol><h2 id="githubé«˜çº§åŠŸèƒ½">GitHubé«˜çº§åŠŸèƒ½</h2><h3 id="fork">fork</h3><p>åœ¨ GitHubä¸Šï¼Œå¦‚æœä½ ç›´æ¥cloneäº†ä¸€ä¸ªåˆ«äººçš„ä»“åº“ï¼Œä¼šæ²¡æœ‰åŸä»“åº“çš„å†™å…¥æƒé™ï¼ˆä¾‹å¦‚ä¸ºä»–äººå¼€æºé¡¹ç›®è´¡çŒ®ä»£ç ï¼‰ã€‚å³ä½¿æœ‰æƒé™ï¼Œä½†å›¢é˜Ÿé¡µä¹Ÿå¯èƒ½æœ‰æ˜ç¡®è¦æ±‚æˆ–æƒ³é¿å…åœ¨åŸä»“åº“ä¸­ç›´æ¥åˆ›å»ºåˆ†æ”¯ã€‚æ‰€ä»¥forkå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œforkçš„ä½œç”¨æ˜¯åœ¨ä½ çš„ä»“åº“ä¸­åˆ›å»ºä¸€ä¸ªåŸä»“åº“çš„å‰¯æœ¬ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå‰¯æœ¬ä¸Šè‡ªç”±ä¿®æ”¹ï¼Œç„¶åé€šè¿‡pullrequestå‘åŸä»“åº“æäº¤ä¿®æ”¹ã€‚ 1. åœ¨ GitHub ä¸Šç‚¹å‡»ä»“åº“é¡µé¢å³ä¸Šè§’çš„ ForkæŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ªä½ çš„å‰¯æœ¬ä»“åº“ã€‚ 2. å°† Fork çš„ä»“åº“å…‹éš†åˆ°æœ¬åœ°ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git clone &lt;ä½ çš„ Fork ä»“åº“åœ°å€&gt;</code></pre>3. åˆ›å»ºæ–°åˆ†æ”¯ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git checkout -b feature-branch # -b è¡¨ç¤ºåˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯</code></pre> 4. æäº¤æ›´æ”¹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git add .git commit -m "æ·»åŠ æ–°åŠŸèƒ½"git push origin feature-branch</code></pre> 5. åœ¨ GitHubä¸Šè¿›å…¥ä½ çš„ Fork ä»“åº“ï¼Œç‚¹å‡» â€œNew PullRequestâ€ï¼Œé€‰æ‹©å°†ä½ çš„åˆ†æ”¯åˆå¹¶åˆ°åŸä»“åº“çš„ä¸»åˆ†æ”¯ï¼ˆå¦‚ mainï¼‰ã€‚<p></p><p><strong>Fork çš„ä»“åº“èƒ½å¦è·Ÿè¸ªåŸä»“åº“çš„æ›´æ”¹ï¼Ÿ</strong> Forkä»“åº“å¯ä»¥è·Ÿè¸ªåŸä»“åº“çš„æ›´æ”¹ï¼Œä½†éœ€è¦æ‰‹åŠ¨åŒæ­¥æ›´æ–°ã€‚ 1. æ·»åŠ åŸä»“åº“çš„è¿œç¨‹åœ°å€ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git remote add upstream &lt;åŸä»“åº“åœ°å€&gt;</code></pre> 2. éªŒè¯æ˜¯å¦æ·»åŠ æˆåŠŸï¼š<code>git remote -v</code> è¾“å‡ºç±»ä¼¼ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">origin    &lt;ä½ çš„ Fork ä»“åº“åœ°å€&gt; (fetch)upstream  &lt;åŸä»“åº“åœ°å€&gt; (fetch)</code></pre> 3. åŒæ­¥åŸä»“åº“çš„æ›´æ–°ï¼š - ä» upstream æ‹‰å–æœ€æ–°ä»£ç ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git fetch upstream</code></pre> - åˆå¹¶åŸä»“åº“çš„ä¸»åˆ†æ”¯ä»£ç åˆ°ä½ çš„ä¸»åˆ†æ”¯ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git checkout maingit merge upstream/main</code></pre> -æ¨é€æ›´æ–°åˆ°ä½ çš„ Fork ä»“åº“ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git push origin main</code></pre> <strong>å¦‚æœ Forkä»“åº“æ˜¯ç”¨ä½œå®Œå…¨ç‹¬ç«‹çš„é¡¹ç›®ï¼Œä¸”ä¸å†éœ€è¦åŸä»“åº“çš„æ›´æ–°æˆ–æäº¤å†å²ï¼Œå¯ä»¥æ¸…é™¤.gité‡æ–°åˆå§‹åŒ–</strong>ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rm -rf .gitgit initgit remote add origin &lt;ä½ çš„ Fork ä»“åº“åœ°å€&gt;git add .git commit -m "åˆå§‹åŒ–"git push origin main# æ­¤æ—¶Fork ä»“åº“å·²ç»æ˜¯ä¸€ä¸ªå…¨æ–°çš„ä»“åº“ï¼Œä½ æ²¡æœ‰åŠæ³•å†è·Ÿè¸ªåŸä»“åº“çš„æ›´æ–°äº†ï¼Œä¹Ÿä¸èƒ½æäº¤pull request</code></pre><p></p><h3 id="pull-requests">Pull Requests</h3><p>Pull Request (PR)æ˜¯åä½œå¼€å‘çš„é‡è¦å·¥å…·ï¼Œç”¨äºåœ¨åˆ†æ”¯ä¹‹é—´æˆ–ä¸åŒå¼€å‘è€…çš„ä»“åº“ä¹‹é—´åˆå¹¶ä»£ç æ”¹åŠ¨ï¼ŒåŒæ—¶æä¾›å®¡é˜…ã€è®¨è®ºå’Œæµ‹è¯•çš„æœºä¼šã€‚1. åˆ›å»º Pull Request - ç¡®ä¿ä½ çš„æ”¹åŠ¨å·²ç»æ¨é€åˆ°è¿œç¨‹ä»“åº“ä¸­çš„æŸä¸ªåˆ†æ”¯ï¼ˆå¦‚feature-branchï¼‰ã€‚ - åœ¨ GitHub ç½‘ç«™ä¸Šï¼Œè¿›å…¥ç›®æ ‡ä»“åº“ï¼Œç‚¹å‡» â€œPullRequestsâ€ã€‚ - ç‚¹å‡» â€œNew Pull Requestâ€ã€‚ - é€‰æ‹©ï¼š - BaseBranchï¼šè¦åˆå¹¶åˆ°çš„ä¸»åˆ†æ”¯ï¼ˆå¦‚ mainï¼‰ - Compare Branchï¼šä½ çš„å¼€å‘åˆ†æ”¯ï¼ˆå¦‚feature-branchï¼‰ 2. å®¡é˜…å’Œè®¨è®º - ä»£ç å®¡é˜…è€…ä¼šçœ‹åˆ°ä½ çš„PRï¼Œæå‡ºè¯„è®ºæˆ–ä¿®æ”¹å»ºè®®ã€‚ -ä½ å¯ä»¥æ ¹æ®åé¦ˆè¿›è¡Œæ”¹åŠ¨ï¼Œå¹¶é€šè¿‡æäº¤æ–°çš„ä»£ç åˆ°åˆ†æ”¯è‡ªåŠ¨æ›´æ–° PRã€‚ 3. åˆå¹¶ PR- å®¡é˜…é€šè¿‡åï¼Œä»“åº“ç®¡ç†å‘˜æˆ– PR åˆ›å»ºè€…å¯ä»¥ç‚¹å‡» â€œMerge Pull Requestâ€ã€‚ -GitHub æä¾›å¤šç§åˆå¹¶æ–¹å¼ï¼š - Merge Commitï¼ˆé»˜è®¤æ–¹å¼ï¼‰ï¼šä¿ç•™æ‰€æœ‰æäº¤å†å²ã€‚- Squash and Mergeï¼šå°†æ‰€æœ‰æäº¤åˆå¹¶ä¸ºä¸€ä¸ªæäº¤ã€‚ - Rebase andMergeï¼šå°†åˆ†æ”¯å†å²ä¸ä¸»åˆ†æ”¯åˆå¹¶ï¼Œä¿ç•™çº¿æ€§å†å²ã€‚ 4. å…³é—­ PR - å¦‚æœ PRä¸å†éœ€è¦ï¼Œå¯ä»¥é€‰æ‹©å…³é—­ PRï¼Œè€Œä¸åˆå¹¶æ”¹åŠ¨ã€‚</p><h3 id="issues">Issues</h3><p>Issues æ˜¯ç”¨äºè·Ÿè¸ªä»»åŠ¡ã€è®°å½• Bugæˆ–å»ºè®®æ–°åŠŸèƒ½çš„å·¥å…·ã€‚å®ƒæ˜¯åä½œå’Œé¡¹ç›®ç®¡ç†çš„é‡è¦éƒ¨åˆ†ã€‚</p><ol type="1"><li>åˆ›å»º Issue</li></ol><ul><li>åœ¨ä»“åº“ä¸»é¡µï¼Œç‚¹å‡» â€œIssuesâ€ã€‚</li><li>ç‚¹å‡» â€œNew Issueâ€ã€‚</li><li>å¡«å†™ Issue æ ‡é¢˜å’Œæè¿°ã€‚</li><li>æ·»åŠ æ ‡ç­¾ï¼ˆLabelsï¼‰æ ‡è®°ç±»å‹ï¼ˆå¦‚Bugã€Enhancementï¼‰ã€åˆ†é…äººå‘˜ï¼ˆAssigneesï¼‰å’Œé‡Œç¨‹ç¢‘ï¼ˆMilestonesï¼‰ã€‚</li></ul><ol start="2" type="1"><li>ç®¡ç† Issue</li></ol><ul><li>å¯ä»¥å¯¹ Issue è¿›è¡Œè¯„è®ºå’Œè®¨è®ºã€‚</li><li>å¯ä»¥å°† Issue å…³è”åˆ° PR æˆ–è€… Issueã€‚</li></ul><ol start="3" type="1"><li>å…³é—­ Issue</li></ol><ul><li>å½“ Issue è§£å†³åï¼Œå¯ä»¥ç‚¹å‡» â€œClose Issueâ€ å…³é—­ã€‚</li><li>å¦‚æœä¸ PR å…³è”ï¼ŒPR åˆå¹¶æ—¶å¯ä»¥è‡ªåŠ¨å…³é—­ Issueï¼ˆåœ¨ PR æè¿°ä¸­å†™ Fixes#<issueç¼–å·>ï¼‰ã€‚</issueç¼–å·></li></ul><h3 id="actions">Actions</h3><p>GitHub Actions æ˜¯ GitHubæä¾›çš„æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹ã€‚1. åˆ›å»º Workflow - åœ¨ä»“åº“ä¸­åˆ›å»º <code>.github/workflows</code> ç›®å½•ã€‚ -åœ¨ç›®å½•ä¸­åˆ›å»º <code>.yml</code> æ–‡ä»¶ï¼Œå®šä¹‰ Workflowã€‚ç¤ºä¾‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">name: CIon:push:    branches:    - mainjobs:build:    runs-on: ubuntu-latest    steps:    - name: Checkout code        uses: actions/checkout@v2    - name: Set up Node.js        uses: actions/setup-node@v3        with:        node-version: 16    - name: Install dependencies        run: npm install    - name: Run tests        run: npm test</code></pre> 2. è§¦å‘ Workflow - æ¯æ¬¡æ¨é€ä»£ç æˆ–åˆ›å»º PRï¼ŒActionsä¼šè‡ªåŠ¨è¿è¡Œã€‚ - è¿è¡Œç»“æœå¯ä»¥åœ¨ä»“åº“çš„ â€œActionsâ€ æ ‡ç­¾é¡µä¸­æŸ¥çœ‹ã€‚ 3.ä½¿ç”¨ç°æˆæ¨¡æ¿ - GitHub æä¾›äº†è®¸å¤šç°æˆçš„ Workflowæ¨¡æ¿ï¼Œå¦‚ä»£ç æ ¼å¼æ£€æŸ¥ã€æ„å»ºéƒ¨ç½²ç­‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚<p></p><h3 id="projects">Projects</h3><p>Projects æ˜¯ GitHub æä¾›çš„é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œç”¨äºç»„ç»‡å’Œè·Ÿè¸ªä»»åŠ¡ã€Issue å’ŒPRã€‚ - åˆ›å»ºé¡¹ç›® - åœ¨ä»“åº“é¡µé¢ï¼Œç‚¹å‡» â€œProjectsâ€ - ç‚¹å‡» â€œNew Projectâ€ã€‚ -é€‰æ‹©æ¨¡æ¿ï¼ˆå¦‚ Kanban Boardï¼‰æˆ–è‡ªå®šä¹‰é¡¹ç›®å¸ƒå±€ã€‚ - æ·»åŠ ä»»åŠ¡ - å°† Issues æˆ–Pull Requests ç›´æ¥æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚ -å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹–åŠ¨ä»»åŠ¡ï¼Œè°ƒæ•´ä»»åŠ¡çŠ¶æ€æˆ–ä¼˜å…ˆçº§ã€‚ - ç®¡ç†ä»»åŠ¡ -é€šè¿‡æ‹–æ”¾æ“ä½œç§»åŠ¨ä»»åŠ¡åˆ°ä¸åŒé˜¶æ®µï¼ˆå¦‚ â€œTo Doâ€ -&gt; â€œIn Progressâ€ -&gt;â€œDoneâ€ï¼‰ã€‚ - è®¾ç½®ä¼˜å…ˆçº§ã€æˆªæ­¢æ—¥æœŸå’Œè´£ä»»äººã€‚</p><h3 id="wiki">Wiki</h3><p>Wiki æ˜¯ä¸€ä¸ªä»“åº“é™„å¸¦çš„æ–‡æ¡£å­˜å‚¨å·¥å…·ï¼Œé€‚ç”¨äºè®°å½•é¡¹ç›®æ–‡æ¡£ã€APIè¯´æ˜æˆ–å›¢é˜Ÿåä½œæŒ‡å—ã€‚</p><ul><li>åœ¨ä»“åº“é¡µé¢ï¼Œç‚¹å‡» â€œWikiâ€ã€‚</li><li>ç‚¹å‡» â€œCreate the first pageâ€ã€‚</li><li>ç¼–è¾‘é¡µé¢å†…å®¹ï¼Œæ”¯æŒ Markdown è¯­æ³•ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerå¸¸è§å‘½ä»¤</title>
      <link href="/2025/01/09/docker-chang-jian-ming-ling/"/>
      <url>/2025/01/09/docker-chang-jian-ming-ling/</url>
      
        <content type="html"><![CDATA[<ol type="1"><li><p>æ‹‰å–é•œåƒ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker pull [é•œåƒåœ°å€]#ã€é•œåƒåœ°å€]ä¸€èˆ¬ç”±[é•œåƒå]:[æ ‡ç­¾]ç»„æˆï¼Œæ ‡ç­¾ä¸€èˆ¬æŒ‡çš„ç‰ˆæœ¬å·ï¼Œé»˜è®¤ä¸ºlatestã€‚ä¾‹å¦‚ï¼šubuntu:20.04</code></pre><p></p></li><li><p>åˆ›å»ºå¹¶è¿è¡Œæ–°å®¹å™¨</p></li></ol><p>ä½¿ç”¨æ‹‰å–çš„é•œåƒåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -d --name &lt;å®¹å™¨å&gt; --gpus all -p &lt;ä¸»æœºç«¯å£&gt;:&lt;å®¹å™¨ç«¯å£&gt; -v &lt;å®¿ä¸»æœºç›®å½•æˆ–å·å&gt;:&lt;å®¹å™¨ç›®å½•&gt; &lt;é•œåƒå&gt; sleep infinity# -d: åå°è¿è¡Œå®¹å™¨# --name: æŒ‡å®šå®¹å™¨åç§°# --gpus: æŒ‡å®šGPU# -p: å°†ä¸»æœºç«¯å£æ˜ å°„åˆ°å®¹å™¨ç«¯å£ï¼Œæ ¼å¼ä¸º ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£# -v: å°†å®¿ä¸»æœºç›®å½•æˆ–æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨ç›®å½•ã€‚å®¿ä¸»æœºç›®å½•ç”¨äºç›´æ¥æŒ‚è½½æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ•°æ®å·æä¾›æ›´é«˜çš„çµæ´»æ€§å’Œéš”ç¦»æ€§ã€‚# sleep infinity: ä¿æŒå®¹å™¨è¿è¡Œ# å¦‚æœå®¹å™¨ä»¥åˆ›å»ºå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼šdocker start &lt;å®¹å™¨åæˆ–ID&gt;</code></pre><p></p><ol start="3" type="1"><li><p>æŸ¥çœ‹å®¹å™¨ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker ps # æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨docker ps -a # æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ŒåŒ…æ‹¬å·²åœæ­¢çš„</code></pre><p></p></li><li><p>è¿›å…¥å®¹å™¨ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker exec -it &lt;å®¹å™¨å&gt; /bin/bash # æˆ–è€… /bin/sh # it: æ˜¯ä¸¤ä¸ªé€‰é¡¹çš„ç»„åˆ: --interactive --tty# -i: äº¤äº’å¼æ“ä½œ# -t: ä¸ºå®¹å™¨åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯</code></pre><p></p></li><li><p>åœæ­¢å’Œåˆ é™¤å®¹å™¨ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker stop &lt;å®¹å™¨åæˆ–ID&gt;docker rm &lt;å®¹å™¨åæˆ–ID&gt;docker stop $(docker ps -aq) # åœæ­¢æ‰€æœ‰å®¹å™¨docker rm $(docker ps -aq) # åˆ é™¤æ‰€æœ‰å®¹å™¨</code></pre><p></p></li><li><p>ä¿å­˜å®¹å™¨çŠ¶æ€ä¸ºæ–°é•œåƒ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker commit &lt;å®¹å™¨åæˆ–ID&gt; &lt;æ–°é•œåƒå&gt;:&lt;æ ‡ç­¾&gt;</code></pre><p></p></li><li><p>æŸ¥çœ‹é•œåƒ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker images</code></pre><p></p></li><li><p>åˆ é™¤é•œåƒ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker rmi &lt;é•œåƒåæˆ–ID&gt;docker rmi -f &lt;é•œåƒåæˆ–ID&gt; # å¼ºåˆ¶åˆ é™¤</code></pre><p></p></li><li><p>å¯¼å‡ºå’Œå¯¼å…¥é•œåƒ</p></li></ol><ul><li>å¯¼å‡ºé•œåƒä¸ºæ–‡ä»¶ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker save -o &lt;æ–‡ä»¶å&gt;.tar &lt;é•œåƒåæˆ–ID&gt;</code></pre></li><li>ä»æ–‡ä»¶å¯¼å…¥é•œåƒï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker load -i &lt;æ–‡ä»¶å&gt;.tar</code></pre></li></ul><ol start="10" type="1"><li>æ£€æŸ¥å®¹å™¨æ—¥å¿—</li></ol><ul><li>æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker logs &lt;å®¹å™¨åæˆ–ID&gt;</code></pre></li><li>å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker logs -f &lt;å®¹å™¨åæˆ–ID&gt;</code></pre></li><li>æŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker top &lt;å®¹å™¨åæˆ–ID&gt;</code></pre></li><li>æ£€æŸ¥å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker inspect &lt;å®¹å™¨åæˆ–ID&gt;</code></pre></li></ul><ol start="11" type="1"><li>æ¸…ç†æ— ç”¨çš„èµ„æº</li></ol><ul><li>æ¸…ç†æœªä½¿ç”¨çš„é•œåƒã€å®¹å™¨ã€ç½‘ç»œå’Œå·ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker system prune</code></pre></li><li>æ¸…ç†æœªä½¿ç”¨çš„å·ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker volume prune</code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerçš„å­˜å‚¨</title>
      <link href="/2025/01/09/docker-de-cun-chu/"/>
      <url>/2025/01/09/docker-de-cun-chu/</url>
      
        <content type="html"><![CDATA[<p><a href="https://docs.docker.com/engine/storage/">Dockerçš„å­˜å‚¨åŠŸèƒ½</a>åˆ†ä¸ºå‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ä¸åŒçš„ä½œç”¨å’Œé€‚ç”¨åœºæ™¯ï¼Œä»¥ä¸‹æ˜¯å¯¹è¿™äº›éƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜ï¼š## Volumesï¼ˆå·ï¼‰ Volumes æ˜¯ Dockeræ¨èçš„æŒä¹…åŒ–å­˜å‚¨æ–¹å¼ï¼Œå¯ä»¥å°†å®¹å™¨æ•°æ®ç‹¬ç«‹å­˜å‚¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å³ä½¿å®¹å™¨è¢«åˆ é™¤ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚<strong>è®¾ç½®å·çš„å­˜å‚¨ä½ç½®</strong> å·ä¼šè¢«å­˜å‚¨åœ¨ Docker çš„é»˜è®¤æ•°æ®ç›®å½•ä¸­ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/var/lib/docker/volumes/&lt;volume_name&gt;/_data # LinuxC:\ProgramData\Docker\volumes\&lt;volume_name&gt;\_data # Windows</code></pre> è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æŸä¸ªå·çš„å…·ä½“è·¯å¾„ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker volume inspect my_volume</code></pre>å¦‚æœå¸Œæœ›å°†å·å­˜å‚¨åˆ°éé»˜è®¤è·¯å¾„ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ Docker çš„é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸ä½äº/etc/docker/daemon.jsonï¼Œæ²¡æœ‰çš„è¯å¯ä»¥æ–°å»ºï¼‰æ¥å®ç°ï¼š <pre class="line-numbers language-json" data-language="json"><code class="language-json">{    # å°† Docker æ•°æ®ç›®å½•ä¿®æ”¹ä¸º /home/dockerã€‚    "data-root": "/home/docker"}</code></pre>å…¶å®è¿™é‡Œæœ¬è´¨ä¸Šæ˜¯ä¿®æ”¹äº† Dockerçš„æ•°æ®ç›®å½•ï¼Œå·çš„æ•°æ®ä¹Ÿä¼šå­˜å‚¨åœ¨è¿™ä¸ªç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>docker info</code>æŸ¥çœ‹Docker çš„æ ¹ç›®å½•ã€‚<p></p><p><strong>åˆ‡è®°</strong>å¦‚æœä¹‹å‰å·²ç»æœ‰æ•°æ®ï¼Œéœ€è¦å°†æ•°æ®ä»<code>/var/lib/docker</code>è¿ç§»åˆ°æ–°çš„ç›®å½•<code>/home/docker</code>ä¸­ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl stop docker # åœæ­¢ Docker æœåŠ¡rsync -avz /var/lib/docker /home/docker # è¿ç§»æ•°æ®systemctl start docker # å¯åŠ¨ Docker æœåŠ¡</code></pre><p></p><p>è®¾ç½®åé‡å¯ DockeræœåŠ¡:<code>sudo systemctl restart docker</code>ï¼Œæ‰€æœ‰æ–°åˆ›å»ºçš„å·éƒ½ä¼šå­˜å‚¨åœ¨æ–°çš„æ•°æ®ç›®å½•<code>/home/docker/volumes</code>ä¸­ã€‚å¯ä»¥åœ¨é€šè¿‡<code>docker volume inspect my_volume</code>æŸ¥çœ‹å·çš„å…·ä½“è·¯å¾„ï¼Œæˆ–è€…<code>docker info</code>æŸ¥çœ‹Docker çš„æ ¹ç›®å½•ã€‚</p><p><strong>å·å¯ä»¥è¢«ä¸åŒçš„å®¹å™¨å…±äº«ï¼Œä¹Ÿå¯ä»¥åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</strong></p><p><strong>æ³¨æ„</strong> 1.ä¸è¦ç›´æ¥ä¿®æ”¹å·ç›®å½•ä¸­çš„æ–‡ä»¶ï¼šå¦‚æœç›´æ¥ä¿®æ”¹ä¸»æœºä¸Šçš„å·ç›®å½•ä¸­çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æŸåæˆ–æ— æ³•è¢«å®¹å™¨è¯†åˆ«ã€‚2. å¤‡ä»½ä¸è¿ç§»ï¼šå¯ä»¥é€šè¿‡ä¸»æœºä¸Šçš„è·¯å¾„å¯¹å·æ•°æ®è¿›è¡Œå¤‡ä»½æˆ–è¿ç§»ã€‚</p><p><strong>ä½¿ç”¨æ–¹å¼</strong> - åˆ›å»ºä¸€ä¸ª volume </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker volume create my_volume</code></pre><p></p><ul><li>åœ¨å®¹å™¨ä¸­æŒ‚è½½volumeï¼Œ<strong>é€šè¿‡æŒ‚è½½å·å¯ä»¥å®ç°æ•°æ®æŒä¹…åŒ–ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤ï¼Œå·ä¸­çš„æ•°æ®ä»ç„¶ä¿ç•™ã€‚</strong><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -d --name my_container -v my_volume:/app/data my_image# -d: åˆ†ç¦»æ¨¡å¼ï¼Œåå°è¿è¡Œå®¹å™¨# --name: å®¹å™¨åç§°# -v: æŒ‚è½½ volume# my_image: é•œåƒåç§°</code></pre></li><li>æŸ¥çœ‹ volume <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker volume ls</code></pre></li><li>åˆ é™¤ volume <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker volume rm my_volume</code></pre></li></ul><h2 id="bind-mountsç»‘å®šæŒ‚è½½">Bind mountsï¼ˆç»‘å®šæŒ‚è½½ï¼‰</h2><p>Bind Mountå°†ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•ç›´æ¥æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œä¸»æœºä¸Šçš„æ•°æ®å¯ä»¥å®æ—¶æ›´æ–°åˆ°å®¹å™¨ä¸­ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p><strong>ä½¿ç”¨æ–¹å¼</strong>-åœ¨è¿è¡Œå®¹å™¨æ—¶æŒ‡å®šç»‘å®šæŒ‚è½½ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -d --name my_container -v /path/on/host:/path/in/container my_image</code></pre><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š 1. å¼€å‘ç¯å¢ƒä¸­éœ€è¦å®æ—¶åŒæ­¥ä¸»æœºå’Œå®¹å™¨æ•°æ®ã€‚ 2.åœ¨ä¸»æœºä¸Šæœ‰ç‰¹å®šç›®å½•éœ€è¦å®¹å™¨è®¿é—®ï¼ˆå¦‚é…ç½®æ–‡ä»¶ï¼‰ã€‚<p></p><p><strong>æ³¨æ„</strong>ï¼šç»‘å®šæŒ‚è½½æ²¡æœ‰å·çš„éš”ç¦»æ€§å’Œå®‰å…¨æ€§ï¼Œéœ€è°¨æ…æ“ä½œä¸»æœºæ–‡ä»¶ã€‚</p><h2 id="tmpfs-mountsä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½">tmpfsMountsï¼ˆä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼‰</h2><p>tmpfsæŒ‚è½½å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯ç£ç›˜ä¸Šã€‚æ•°æ®æ˜¯ä¸´æ—¶çš„ï¼Œå®¹å™¨åœæ­¢åæ•°æ®ä¼šä¸¢å¤±ã€‚</p><p><strong>ä½¿ç”¨æ–¹å¼</strong>-åœ¨è¿è¡Œå®¹å™¨æ—¶ä½¿ç”¨ --tmpfs é€‰é¡¹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker run -d --name my_container --tmpfs /app/data my_image# /app/data æ˜¯å®¹å™¨å†…éƒ¨çš„è·¯å¾„ï¼Œåº”ç”¨ç¨‹åºåœ¨è¯¥è·¯å¾„ä¸‹æ“ä½œæ•°æ®ã€‚</code></pre> <strong>é€‚ç”¨åœºæ™¯ï¼š</strong> 1.ä¸´æ—¶æ•°æ®å­˜å‚¨ï¼Œä¾‹å¦‚ç¼“å­˜æˆ–ä¸´æ—¶æ–‡ä»¶ã€‚ 2.å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ä¸”æ•°æ®æ— éœ€æŒä¹…åŒ–çš„åœºæ™¯ã€‚<p></p><h2 id="storage-driverså­˜å‚¨é©±åŠ¨">Storage Driversï¼ˆå­˜å‚¨é©±åŠ¨ï¼‰</h2><p>å­˜å‚¨é©±åŠ¨ç®¡ç†å®¹å™¨å’Œé•œåƒçš„åº•å±‚å­˜å‚¨ã€‚æ¯ç§å­˜å‚¨é©±åŠ¨é€‚ç”¨äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå’Œæ“ä½œåœºæ™¯ã€‚å¯ä»¥è¯¦æƒ…æŸ¥çœ‹<a href="https://docs.docker.com/engine/storage/drivers/">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæœ‰å…·ä½“çš„å›¾ç¤ºå’Œè¯´æ˜ï¼Œå¯¹é•œåƒå’Œå®¹å™¨çš„å­˜å‚¨æ–¹å¼æœ‰æ›´æ·±å…¥çš„äº†è§£ã€‚</p><p><strong>å¸¸ç”¨é©±åŠ¨ï¼š</strong> 1. OverlayFSï¼šé»˜è®¤é©±åŠ¨ï¼Œé€‚ç”¨äºå¤§å¤šæ•°Linux å‘è¡Œç‰ˆã€‚ 2. BTRFSï¼šæ”¯æŒé«˜çº§åŠŸèƒ½ï¼Œå¦‚å¿«ç…§å’Œå‹ç¼©ã€‚ 3.ZFSï¼šé«˜æ€§èƒ½å­˜å‚¨é©±åŠ¨ï¼Œé€‚ç”¨äºå¤æ‚å­˜å‚¨éœ€æ±‚ã€‚ 4. Device Mapper å’ŒAUFSï¼šè¾ƒè€çš„å­˜å‚¨é©±åŠ¨ã€‚</p><p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong>- æ£€æŸ¥å½“å‰å­˜å‚¨é©±åŠ¨ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker info | grep Storage</code></pre><p></p><h2 id="å»ºè®®">å»ºè®®</h2><p>Docker æä¾›äº†ä¸€äº›å­˜å‚¨ç®¡ç†çš„å»ºè®®ï¼š 1. ä¼˜å…ˆä½¿ç”¨ Volumesï¼šæ¨èç”¨ Volumesæ¥æ›¿ä»£ Bind Mountï¼Œç¡®ä¿æ•°æ®éš”ç¦»æ€§å’Œå®‰å…¨æ€§ã€‚ 2.é¿å…ç›´æ¥ä½¿ç”¨å®¹å™¨å±‚å­˜å‚¨ï¼šå®¹å™¨å±‚çš„å­˜å‚¨æ˜¯ä¸´æ—¶çš„ï¼Œé€‚ç”¨äºçŸ­æœŸä»»åŠ¡ï¼Œä¸å»ºè®®ç”¨äºæŒä¹…åŒ–æ•°æ®ã€‚3. å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„å·ï¼š<code>docker volume prune</code>å‘½ä»¤å¯ä»¥æ¸…ç†æœªä½¿ç”¨çš„å·ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨CodeWithGPUå®ç°æ¨¡å‹çš„å¼€ç®±å³ç”¨</title>
      <link href="/2025/01/08/shi-yong-codewithgpu-shi-xian-mo-xing-de-kai-xiang-ji-yong/"/>
      <url>/2025/01/08/shi-yong-codewithgpu-shi-xian-mo-xing-de-kai-xiang-ji-yong/</url>
      
        <content type="html"><![CDATA[<h2 id="codewithgpuç®€ä»‹">CodeWithGPUç®€ä»‹</h2><p><a href="https://www.codewithgpu.com/image">CodeWithGPU</a>æ˜¯ä¸€ä¸ªAIé•œåƒã€æ¨¡å‹æŠ€æœ¯ç¤¾åŒºï¼ˆä»Šåæ–‡æ¡£ä¸­ç®€ç§°CG)ï¼Œå®ƒä»¥GitHubä¸ºåŸºç¡€ï¼Œåœ¨GitHubæ‰˜ç®¡çš„ä»£ç ä¸‹æ¸¸ï¼Œæä¾›é¢å¤–çš„é•œåƒç¯å¢ƒã€ç®—æ³•æ¨¡å‹ç­‰ï¼Œè§£å†³ä»¥å¾€æ„å»ºç¯å¢ƒéš¾ã€ç®¡ç†ä¸åˆ†äº«æ¨¡å‹éš¾çš„é—®é¢˜ï¼Œä¸ºç®—æ³•å¼€å‘è€…ã€ç ”ç©¶è€…ç­‰æä¾›å¼€ç®±å³ç”¨çš„å†…å®¹ä½“éªŒã€‚&gt;CodeWithGPUå’ŒAutoDLåŒå±äºè§†æ‹“äº‘ç ”å‘å’Œè¿è¥çš„äº§å“ï¼Œä¸¤è€…è´¦æˆ·é€šç”¨ï¼Œå¯ä»¥äº’ç›¸ç™»å½•ä½¿ç”¨ã€‚### é•œåƒ CGä¸Šçš„é•œåƒæŒ‡èƒ½è¿è¡ŒGithubä¸ŠæŸä¸€å…·ä½“é¡¹ç›®ä»£ç æ‰€éœ€çš„dockerimageç¯å¢ƒã€‚ä¸»è¦ç›®çš„ä¸ºæ–¹ä¾¿å…¶ä»–ç”¨æˆ·å…å»æ„å»ºç¯å¢ƒå®‰è£…ä¾èµ–çš„è¿‡ç¨‹ï¼Œè€Œç›´æ¥åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šè®­ç»ƒæ¨¡å‹ã€‚é•œåƒæ¥è‡ªç”¨æˆ·åœ¨AutoDLä¸Šä¿å­˜çš„dockerimageã€‚(AutoDLæ˜¯ä¸€ä¸ªGPUç®—åŠ›ç§Ÿç”¨å¹³å°ï¼Œå®ƒå’ŒCGå…±ç”¨è´¦æˆ·ï¼Œå³ä¸€ä¸ªå¸å·å¯åœ¨ä¸¤ä¸ªå¹³å°ä¸­ç™»å½•)</p><h3 id="æ¨¡å‹">æ¨¡å‹</h3><p>CGä¸Šçš„æ¨¡å‹æŒ‡ç”¨æˆ·ä½¿ç”¨ç®—æ³•åœ¨æŸæ•°æ®é›†ä¸Šè®­ç»ƒå‡ºæ¥çš„æ¨¡å‹æ–‡ä»¶ã€‚ä½¿ç”¨çš„è¯é¦–å…ˆéœ€è¦å®‰è£…ï¼š<code>pip install codewithgpu</code>å¯ä»¥ç”±ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¸‹è½½æ¨¡å‹ï¼š 1. cli </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cg down GuoFeng3/GuoFeng3.3.safetensors</code></pre> 2. ä»£ç ä¸­é›†æˆ<pre class="line-numbers language-python" data-language="python"><code class="language-python">import codewithgpu as cg cg.model.download("æ¨¡å‹æ–‡ä»¶çš„KEY", target_directory="ä¸‹è½½ç›®æ ‡è·¯å¾„ï¼Œå¯é€‰"))</code></pre><p></p><h2 id="å®‰è£…">å®‰è£…</h2><h3 id="cudaæ£€æŸ¥">cudaæ£€æŸ¥</h3><p>æ£€æŸ¥ç”µè„‘çš„nvidiaé©±åŠ¨ä»¥åŠcuda toolkitã€‚ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvidia-sminvcc -V</code></pre>å¦‚æœæ˜¾ç¤ºæœ‰ï¼š<code>Failed to initialize NVML: Driver/library version mismatchã€‚</code>åˆ™è¯´æ˜é©±åŠ¨å’Œcudatoolkitç‰ˆæœ¬ä¸åŒ¹é…ï¼Œéœ€è¦é‡æ–°å®‰è£…é©±åŠ¨æˆ–è€…cuda toolkitã€‚<p></p><p>æˆ–è€…ä½ çš„cudaç‰ˆæœ¬è¿‡ä½ï¼Œå»ºè®®ä¹Ÿå‡çº§ä¸€ä¸‹ï¼Œä¸ç„¶CGå¾ˆå¤šæ–°çš„é•œåƒéƒ½æ— æ³•ä½¿ç”¨ã€‚</p><p>å¦‚æœä½ çš„cudaç‰ˆæœ¬okä¸”é©±åŠ¨éƒ½æ­£å¸¸çš„è¯ï¼Œé‚£ä¹ˆè·³è¿‡è¿™é‡Œç›´æ¥çœ‹ä¸‹é¢çš„å®‰è£…cg-clientã€‚</p><h3 id="å¸è½½æ—§ç‰ˆæœ¬nvidaé©±åŠ¨å’Œcuda-toolkit">å¸è½½æ—§ç‰ˆæœ¬nvidaé©±åŠ¨å’Œcudatoolkit</h3><ul><li><p>å¸è½½nvidiaé©±åŠ¨ï¼š<code>sudo nvidia-uninstall</code></p></li><li><p>å¸è½½cuda toolkitï¼šæ‰¾åˆ° CUDA å·¥å…·åŒ…çš„å®‰è£…ç›®å½•ï¼ˆä¾‹å¦‚/usr/local/cuda-10.1/ï¼‰ï¼Œç„¶åæ‰§è¡Œï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cd /usr/local/cuda-10.1/bin/sudo ./cuda-uninstaller</code></pre> å¦‚æœä½ å¿˜è®°äº† CUDAå·¥å…·åŒ…çš„å®‰è£…ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">where nvcc</code></pre>æˆ–è€…é€šè¿‡ä¹‹å‰å®‰è£…cudaè®¾ç½®çš„ç¯å¢ƒå˜é‡æŸ¥çœ‹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">echo $PATH | tr ':' '\n' | grep cudaecho $LD_LIBRARY_PATH | tr ':' '\n' | grep cuda</code></pre>å¦‚æœæ²¡æœ‰æ‰¾åˆ°cuda-uninstallerï¼Œå¯ä»¥æ‰‹åŠ¨åˆ é™¤ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo rm -rf /usr/local/cuda-11.8/   # åˆ é™¤ç›®å½•# æ¸…ç†å…¶ä»–æ®‹ç•™æ–‡ä»¶ï¼šsudo apt-get remove --purge '^nvidia-.*'sudo apt-get remove cuda*sudo apt-get autoremove# æŸ¥çœ‹å‰©ä½™æ®‹ç•™sudo dpkg -l |grep cuda# ç»§ç»­å¸è½½å“ˆå“ˆsudo dpkg -P æ®‹ç•™æ–‡ä»¶å…¨ç§°# ç¯å¢ƒå˜é‡åˆ é™¤ï¼šç¼–è¾‘ï½/.bashrc æˆ–è€…  /etc/profileæ–‡ä»¶ä¸­æ˜¯å¦æœ‰ CUDA ç›¸å…³è·¯å¾„ï¼Œ åˆ é™¤ä»¥ä¸‹å†…å®¹export PATH=/usr/local/cuda-11.8/bin:$PATHexport LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH# ä¿å­˜source ~/.bashrc</code></pre><p></p></li><li><p>å®Œæˆå¸è½½åï¼Œåˆ é™¤ CUDA å·¥å…·åŒ…çš„ç›®å½•ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo rm -rf /usr/local/cuda-10.1/</code></pre> ###å®‰è£…æ–°ç‰ˆæœ¬nvidiaé©±åŠ¨<p></p></li><li><p>å‰å¾€ NVIDIA <a href="https://www.nvidia.cn/Download/index.aspx">å®˜æ–¹ç½‘ç«™</a>ï¼Œæ ¹æ®æ˜¾å¡å‹å·ï¼ˆä¾‹å¦‚2080Tiï¼‰ä¸‹è½½æœ€æ–°çš„é©±åŠ¨ç¨‹åºã€‚</p></li><li><p>å°†ä¸‹è½½çš„é©±åŠ¨ç¨‹åºï¼ˆä¾‹å¦‚NVIDIA-Linux-x86_64-550.54.14.runï¼‰ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æŸä¸ªç›®å½•ï¼Œç„¶åæ‰§è¡Œï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo sh NVIDIA-Linux-x86_64-550.54.14.run</code></pre><p></p></li><li><p>å®‰è£…å®Œæˆåï¼Œé‡å¯æœåŠ¡å™¨ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo reboot</code></pre><p></p></li><li><p>é‡å¯åï¼Œæ£€æŸ¥é©±åŠ¨æ˜¯å¦å®‰è£…æˆåŠŸï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvidia-smi</code></pre><p></p></li></ul><h3 id="å®‰è£…æ–°ç‰ˆæœ¬cuda-toolkit">å®‰è£…æ–°ç‰ˆæœ¬cuda toolkit</h3><p>æ³¨æ„å®‰è£…çš„cuda toolkitç‰ˆæœ¬è¦å’Œnvidiaé©±åŠ¨ç‰ˆæœ¬åŒ¹é…ï¼š </p><pre class="line-numbers language-none"><code class="language-none">- nvidia-smiå±äºdriver APIã€nvccå±äºruntime APIã€‚- ç”¨äºæ”¯æŒdriver APIçš„å¿…è¦æ–‡ä»¶(å¦‚libcuda.so)æ˜¯ç”±GPU driver installerå®‰è£…çš„ã€‚- ç”¨äºæ”¯æŒruntime APIçš„å¿…è¦æ–‡ä»¶(å¦‚libcudart.soä»¥åŠnvcc)æ˜¯ç”±CUDA Toolkit installerå®‰è£…çš„ã€‚- å¦‚æœåªå®‰è£…driver APIï¼Œä¸å®‰è£…runtime APIï¼ˆcuda toolkitï¼‰ï¼Œä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨pytorchï¼Œä½†æ¶‰åŠåˆ°ä¸€äº›éœ€è¦ç¼–è¯‘å®‰è£…çš„æ›´åº•å±‚çš„å·¥å…·ï¼Œæ¯”å¦‚apexã€deepspeedï¼Œå°±ä¼šæŠ¥é”™ï¼Œè¿™æ—¶è¿˜éœ€è¦åºŠruntime APIã€‚</code></pre> -å‰å¾€ NVIDIA <a href="https://developer.nvidia.com/cuda-downloads">å¼€å‘è€…ç½‘ç«™</a>ï¼Œæ ¹æ®æ“ä½œç³»ç»Ÿå’Œéœ€æ±‚ä¸‹è½½ä¸æ–°é©±åŠ¨å…¼å®¹çš„CUDA å·¥å…·åŒ…ï¼ˆä¾‹å¦‚ CUDA 12.1.1ï¼‰ã€‚ - å°†ä¸‹è½½çš„ CUDA å®‰è£…åŒ…ï¼ˆä¾‹å¦‚cuda_12.1.1_530.30.02_linux.runï¼‰ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æŸä¸ªç›®å½•ï¼Œç„¶åæ‰§è¡Œï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo sh cuda_12.1.1_530.30.02_linux.run</code></pre> <strong>æ³¨æ„</strong>ï¼šç”±äºå·²ç»æœ‰CUDADriver12.4äº†ï¼Œå› æ­¤åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¸éœ€è¦å‹¾é€‰CUDA Driverã€‚ -å®‰è£…å®Œæˆåï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼šï¼ˆå¦‚æœä¹‹å‰å®‰è£…è¿‡æ—§ç‰ˆæœ¬è®°å¾—åˆ é™¤æ—§ç‰ˆæœ¬çš„ç¯å¢ƒå˜é‡ï¼‰ <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">echo 'export PATH=/usr/local/cuda-12.1/bin:$PATH' &gt;&gt; ~/.bashrcecho 'export LD_LIBRARY_PATH=/usr/local/cuda-12.1/lib64:$LD_LIBRARY_PATH' &gt;&gt; ~/.bashrcsource ~/.bashrc</code></pre> -æ£€æŸ¥CUDAæ˜¯å¦å®‰è£…æˆåŠŸï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvcc -V</code></pre><p></p><h3 id="cg-client">cg-client</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># ä¸‹è½½å®¢æˆ·ç«¯å¹¶æ·»åŠ å¯æ‰§è¡Œæƒé™wget -O cg-client https://codewithgpu.ks3-cn-beijing.ksyuncs.com/cg-clientchmod +x cg-client# å¯åŠ¨å®¢æˆ·ç«¯ï¼Œéœ€è¦ä½¿ç”¨åˆ°sudoæƒé™å¦åˆ™æœ‰dockerä½¿ç”¨ä¸Šçš„å¼‚å¸¸sudo ./cg-client</code></pre><h3 id="webä¸Šä½¿ç”¨">webä¸Šä½¿ç”¨</h3><p>å¯åŠ¨<code>cg-client</code>åä¼šè¾“å‡ºç±»ä¼¼å¦‚ä¸‹åŒ…å«è®¿é—®åœ°å€çš„æ—¥å¿—ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">**************cg-client is running on http://localhost:2022/container?token=E5PR11vT9MMbrpwFeIdLcltRNnUmaY**************</code></pre>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥åœ°å€åï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦æœ‰Dockerç¯å¢ƒï¼Œç‚¹å‡»å®‰è£…nvidia-dockeræŒ‰é’®è‡ªåŠ¨å®‰è£…ç›¸å…³ç¯å¢ƒ<p></p><p><strong>dockerçš„æƒé™é…ç½®</strong></p><p>åœ¨ä½¿ç”¨dockeræ—¶ï¼Œå¦‚æœä¸æƒ³æ¯æ¬¡éƒ½ä½¿ç”¨sudoï¼Œå¯ä»¥å°†å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo groupadd docker # æ·»åŠ dockerç»„sudo gpasswd -a ${USER} docker # å°†å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„sudo systemctl restart docker # é‡å¯dockeræœåŠ¡sudo chmod a+rw /var/run/docker.sock # ä¿®æ”¹docker.sockæƒé™</code></pre><p></p><p><strong>å¦‚æœä½¿ç”¨sshè¿æ¥çš„æœåŠ¡å™¨ä½¿ç”¨åˆ™éœ€è¦è®¾ç½®ç«¯å£è½¬å‘</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh -CNg -L 2022:localhost:2022 user@host -p port</code></pre> å‚æ•°è¯´æ˜ï¼š -C:å¯ç”¨å‹ç¼©ã€‚è¿™å¯¹äºå‡å°‘ä¼ è¾“æ•°æ®é‡æœ‰å¸®åŠ©ï¼Œç‰¹åˆ«æ˜¯åœ¨å¸¦å®½è¾ƒä½çš„æƒ…å†µä¸‹ã€‚<p></p><p>-N: ä¸æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œåªå»ºç«‹éš§é“ã€‚é€‚åˆä»…ç”¨äºç«¯å£è½¬å‘çš„åœºæ™¯ã€‚</p><p>-g: å…è®¸å…¶ä»–ä¸»æœºé€šè¿‡æœ¬æœºï¼ˆè¿è¡Œæ­¤å‘½ä»¤çš„æœºå™¨ï¼‰çš„ 7890 ç«¯å£è®¿é—®éš§é“ã€‚å¦‚æœä¸éœ€è¦å…¶ä»–æœºå™¨è®¿é—®ï¼Œå¯ä»¥çœç•¥è¿™ä¸ªå‚æ•°ã€‚</p><p>-L: æœ¬åœ°ç«¯å£è½¬å‘ã€‚æ ¼å¼ä¸º -L [æœ¬åœ°ç«¯å£]:[ç›®æ ‡åœ°å€]:[ç›®æ ‡ç«¯å£]</p><p>CGå¼€å§‹ä½¿ç”¨æ—¶éœ€è¦å®‰è£…docker/nvidia-dockerç¯å¢ƒï¼Œwebç•Œé¢ä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦æœ‰Dockerç¯å¢ƒï¼Œç‚¹å‡»å®‰è£…nvidia-dockeræŒ‰é’®è‡ªåŠ¨å®‰è£…ç›¸å…³ç¯å¢ƒï¼Œä½†æ˜¯æˆ‘ä½¿ç”¨æ—¶å‘ç°æˆ‘åŸæœ¬å®‰è£…çš„dockerç¯å¢ƒåœ¨ä½¿ç”¨CGæä¾›çš„è„šæœ¬å®‰è£…åå°±å¤±æ•ˆäº†ï¼Œæ‰€ä»¥å»ºè®®è¿˜æ˜¯å¸è½½åŸæœ‰çš„dockerç¯å¢ƒåå†ä½¿ç”¨CGæä¾›çš„è„šæœ¬å®‰è£…</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250108033158.png">è¿™æ ·å°±æˆåŠŸå•¦</p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>åœ¨webç•Œé¢å¯ä»¥å®ç°å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ç­‰æ“ä½œï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ æ–‡ä»¶åˆ°å®¹å™¨ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨å®¹å™¨ä¸­æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œå‘½ä»¤ï¼ŒæŸ¥çœ‹æ—¥å¿—ç­‰æ“ä½œã€‚</p><h3 id="dockerçš„å­˜å‚¨">dockerçš„å­˜å‚¨</h3><p>åœ¨å®¹å™¨å†…æˆ‘ä»¬ä¼šå‘ç°ç³»ç»Ÿç›˜å¤§å°ä¸ºæœ¬åœ°æ ¹ç›®å½•çš„å¤§å°ï¼Œè¿™æ˜¯å› ä¸ºDockeré»˜è®¤å®‰è£…çš„æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨<code>/var/lib/docker/</code>ç›®å½•ä½œä¸ºå­˜å‚¨ç›®å½•ï¼Œç”¨ä»¥å­˜æ”¾æ‹‰å–çš„é•œåƒå’Œåˆ›å»ºçš„å®¹å™¨ç­‰ã€‚</p><p>è€Œautodl-tmpæœªæŒ‚è½½ï¼Œè™½ç„¶CGæä¾›äº†ç½‘ç›˜çš„æ”¯æŒï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³é€‚ç”¨å®¿ä¸»æœºä¸­çš„ç£ç›˜åˆ†åŒºçš„è¯ï¼Œè¿˜å¾—ä¼šä¸€äº›dockerçš„å­˜å‚¨çŸ¥è¯†ï¼ˆè§åšå®¢-<a href="https://baoblei.github.io/2025/01/09/docker-de-cun-chu/">dockerçš„å­˜å‚¨</a>ï¼‰</p><p>åœ¨äº†è§£äº†dockerçš„å­˜å‚¨åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>docker run</code>å‘½ä»¤çš„<code>-v</code>å‚æ•°æ¥æŒ‚è½½å®¿ä¸»æœºçš„ç£ç›˜åˆ†åŒºåˆ°å®¹å™¨ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨å®¿ä¸»æœºçš„ç£ç›˜åˆ†åŒºäº†ã€‚åœ¨webç•Œé¢åˆ›å»ºå®¹å™¨æ—¶ä¹Ÿæä¾›äº†æŒ‚è½½çš„é€‰é¡¹ï¼Œå¯ä»¥ç›´æ¥åœ¨webç•Œé¢ä¸­æŒ‚è½½ã€‚</p><h3 id="é•œåƒä¸å®¹å™¨çš„åŸºæœ¬ç”¨æ³•">é•œåƒä¸å®¹å™¨çš„åŸºæœ¬ç”¨æ³•</h3><p>å…·ä½“è§åšå®¢-<a href="https://baoblei.github.io/2025/01/09/docker-chang-jian-ming-ling/">dockerçš„å¸¸è§å‘½ä»¤</a>ï¼Œè¿™é‡Œç®€å•é€šè¿‡æœ¬åœ°ç»ˆç«¯åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨æ¥è¯´æ˜ï¼š- æ‹‰å–é•œåƒ </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker pull registry.cn-beijing.aliyuncs.com/codewithgpu2/hvision-nku-storydiffusion:n3iFx8w7UJ</code></pre> - æŸ¥çœ‹é•œåƒ <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker images</code></pre> - åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo docker run -d --name quizzical_wilson --gpus all -v data80:/root/autodl-tmp registry.cn-beijing.aliyuncs.com/codewithgpu2/hvision-nku-storydiffusion:n3iFx8w7UJ sleep infinity# è¿™é‡Œæˆ‘æŒ‚è½½äº†ä¸€ä¸ªå·data80åˆ°å®¹å™¨çš„/root/autodl-tmpç›®å½•sudo docker exec -it quizzical_wilson /bin/bash</code></pre>åˆ°è¿™é‡Œå°±å¯ä»¥åœ¨å®¹å™¨ä¸­è¿›è¡Œæ“ä½œäº†ï¼Œå¯ä»¥ä½¿ç”¨<code>exit</code>é€€å‡ºå®¹å™¨ã€‚ -åœæ­¢å®¹å™¨ <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker stop quizzical_wilson</code></pre><p></p><p><strong>å‚è€ƒ:</strong> &gt;CGå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.codewithgpu.com/docs/</p><blockquote><p>docker engineæ–‡æ¡£ï¼šhttps://docs.docker.com/engine/</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CG </category>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> CG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡å…¬ç½‘è®¿é—®å±€åŸŸç½‘å†…æœåŠ¡å™¨</title>
      <link href="/2025/01/07/tong-guo-gong-wang-fang-wen-ju-yu-wang-nei-fu-wu-qi/"/>
      <url>/2025/01/07/tong-guo-gong-wang-fang-wen-ju-yu-wang-nei-fu-wu-qi/</url>
      
        <content type="html"><![CDATA[<p>åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š ## æ‹¥æœ‰è·¯ç”±å™¨ç®¡ç†æƒé™ 1.MACåœ°å€ç»‘å®šï¼šåœ¨è·¯ç”±å™¨ä¸­ç»‘å®šæœåŠ¡å™¨çš„MACåœ°å€ï¼Œä½¿å…¶è·å¾—å›ºå®šçš„å†…ç½‘IPåœ°å€ã€‚</p><ol start="2" type="1"><li>ç«¯å£æ˜ å°„ï¼šåœ¨è·¯ç”±å™¨ä¸­è®¾ç½®ç«¯å£æ˜ å°„ï¼Œå°†å…¬ç½‘IPçš„æŸä¸ªç«¯å£æ˜ å°„åˆ°æœåŠ¡å™¨çš„å†…ç½‘IPçš„æŸä¸ªç«¯å£ä¸Šã€‚</li></ol><ul><li>æ‰¾åˆ°è·¯ç”±å™¨ç®¡ç†é¡µé¢ä¸­çš„ è½¬å‘è§„åˆ™ã€NAT è®¾ç½®æˆ–ç±»ä¼¼é€‰é¡¹ï¼ˆåç§°å› å“ç‰Œè€Œå¼‚ï¼‰ã€‚</li><li>æ·»åŠ ä¸€æ¡æ–°çš„ç«¯å£è½¬å‘è§„åˆ™ï¼š<ul><li>å¤–éƒ¨ç«¯å£ï¼ˆExternal Portï¼‰ï¼šåœ¨å…¬ç½‘è®¿é—®æ—¶ä½¿ç”¨çš„ç«¯å£ï¼ˆä¾‹å¦‚ 80ï¼‰ã€‚</li><li>å†…éƒ¨ç«¯å£ï¼ˆInternal Portï¼‰ï¼šæœåŠ¡å™¨ç›‘å¬çš„ç«¯å£ï¼ˆä¾‹å¦‚ 80ï¼‰ã€‚</li><li>å†…éƒ¨ IP åœ°å€ï¼ˆInternal IPï¼‰ï¼šæœåŠ¡å™¨çš„ IP åœ°å€ï¼ˆä¾‹å¦‚</li><li>åè®®ç±»å‹ï¼ˆProtocolï¼‰ï¼šé€‰æ‹© TCPã€UDP æˆ– TCP/UDPï¼ˆé€šå¸¸é€‰æ‹© TCP æˆ–TCP/UDPï¼‰ã€‚</li><li>ä¿å­˜è®¾ç½®ã€‚</li></ul></li></ul><ol start="3" type="1"><li><p>æŸ¥çœ‹å…¬ç½‘ipåœ°å€ï¼šåœ¨è·¯ç”±å™¨çŠ¶æ€é¡µæˆ–é€šè¿‡IP æ£€æµ‹ç½‘ç«™æŸ¥çœ‹è·¯ç”±å™¨çš„å…¬ç½‘IP åœ°å€ã€‚</p></li><li><p>æµ‹è¯•ï¼Œä¾‹å¦‚sshç™»å½•ï¼š<code>ssh -p &lt;å…¬ç½‘ç«¯å£&gt; user@&lt;å…¬ç½‘IP&gt;</code>ï¼ˆç«¯å£è½¬å‘è®¾ç½®çš„å†…ç½‘ç«¯å£ä¸º22ï¼‰ã€‚</p></li></ol><p><strong>æ³¨æ„</strong> - å¦‚æœä½ çš„å…¬ç½‘IPæ˜¯ä¸€ä¸ªç§æœ‰IPåœ°å€ï¼ˆå¦‚192.168.x.xã€172.16.x.xã€10.x.x.xï¼‰ï¼Œé‚£ä¹ˆä½ çš„è·¯ç”±å™¨å¯èƒ½å¤„äºåŒé‡ NATç¯å¢ƒä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦æ‹¥æœ‰å…¬ç½‘IPåœ°å€çš„è·¯ç”±å™¨æ‰èƒ½è¿›è¡Œç«¯å£æ˜ å°„ã€‚ -ä¸€èˆ¬è·¯ç”±å™¨é‡å¯åå…¬ç½‘ipä¼šå˜åŒ–ã€‚å¯ä»¥ä½¿ç”¨åŠ¨æ€åŸŸåè§£ææœåŠ¡ï¼ˆDDNSï¼‰æˆ–è€…è”ç³»äº’è”ç½‘æä¾›å•†ISPæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ–è€…é€šè¿‡ä¸€ä¸ªè„šæœ¬å®šæœŸæ£€æŸ¥å…¬ç½‘IPåœ°å€å¹¶é€šè¿‡æŸä¸ªå¤–éƒ¨æœåŠ¡å™¨æˆ–é‚®ä»¶é€šçŸ¥è‡ªå·±ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bashIP=$(curl -s ifconfig.me) # è·å–å…¬ç½‘IPecho "å½“å‰å…¬ç½‘IPæ˜¯ï¼š$IP"# å‘é€é‚®ä»¶æˆ–æ›´æ–°å¤–éƒ¨æœåŠ¡curl -X POST -d "ip=$IP" http://yourserver.com/update_ip</code></pre><p></p><blockquote><p>åŠ¨æ€åŸŸåè§£æï¼ˆDDNSï¼‰æœåŠ¡ åŠ¨æ€åŸŸåè§£æï¼ˆDDNSï¼‰å…è®¸ä½ å°†åŠ¨æ€å…¬ç½‘ IPç»‘å®šåˆ°ä¸€ä¸ªå›ºå®šçš„åŸŸåï¼Œå½“ IP å˜åŒ–æ—¶ï¼ŒDDNS æœåŠ¡ä¼šè‡ªåŠ¨æ›´æ–°åŸŸåæŒ‡å‘çš„ IPåœ°å€ã€‚</p></blockquote><p>é…ç½®æ­¥éª¤ï¼š 1. æ³¨å†Œ DDNS æœåŠ¡ - é€‰æ‹©ä¸€ä¸ª DDNSæä¾›å•†ï¼ˆé€šå¸¸æ˜¯å…è´¹çš„æˆ–é™„å¸¦åœ¨è·¯ç”±å™¨æœåŠ¡ä¸­ï¼‰ï¼Œå¦‚ï¼š - No-IP - DynDNS -è·¯ç”±å™¨å“ç‰Œè‡ªå¸¦çš„ DDNS æœåŠ¡ï¼ˆå¦‚ TP-Linkã€åä¸ºç­‰ï¼‰ã€‚ - æ³¨å†Œä¸€ä¸ªåŸŸåï¼Œä¾‹å¦‚myserver.ddns.netã€‚</p><ol start="2" type="1"><li>é…ç½®è·¯ç”±å™¨çš„ DDNS</li></ol><ul><li>ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢ã€‚</li><li>æ‰¾åˆ° DDNS è®¾ç½®ï¼ˆé€šå¸¸åœ¨ç½‘ç»œæˆ–é«˜çº§è®¾ç½®ä¸‹ï¼‰ã€‚</li><li>è¾“å…¥ DDNS æä¾›å•†ä¿¡æ¯ï¼š<ul><li>æœåŠ¡æä¾›å•†ï¼ˆä¾‹å¦‚ No-IPã€DynDNSï¼‰ã€‚</li><li>æ³¨å†Œçš„åŸŸåï¼ˆä¾‹å¦‚ myserver.ddns.netï¼‰ã€‚</li><li>ç™»å½•å‡­æ®ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼‰ã€‚</li><li>å¯ç”¨ DDNSã€‚</li></ul></li></ul><ol start="3" type="1"><li>éªŒè¯é…ç½®</li></ol><ul><li>æ£€æŸ¥DDNSçŠ¶æ€ï¼Œç¡®è®¤åŸŸåå·²æˆåŠŸç»‘å®šåˆ°å½“å‰å…¬ç½‘IPã€‚</li><li>ä¹‹åï¼Œé€šè¿‡ http://myserver.ddns.net:&lt;ç«¯å£å·&gt; è®¿é—®ä½ çš„æœåŠ¡å™¨ã€‚</li></ul><h2 id="æ— è·¯ç”±å™¨ç®¡ç†æƒé™">æ— è·¯ç”±å™¨ç®¡ç†æƒé™</h2><p><strong>ä½¿ç”¨ç¬¬ä¸‰æ–¹å†…ç½‘ç©¿é€æœåŠ¡</strong>ï¼Œç»•è¿‡å…¬ç½‘ IP é™åˆ¶ã€‚ä¾‹å¦‚ï¼š -<strong>Ngrok</strong>ï¼šé€šè¿‡åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„å…¬ç½‘åœ°å€ï¼Œå°†æµé‡è½¬å‘åˆ°ä½ çš„æœåŠ¡å™¨ã€‚- <strong>Cloudflare Tunnelï¼ˆArgo Tunnelï¼‰</strong>ï¼šç›´æ¥é€šè¿‡ Cloudflareæä¾›çš„åŸŸåè®¿é—®ä½ çš„æœåŠ¡å™¨ã€‚ - <strong>Tailscale /ZeroTier</strong>ï¼šåˆ›å»ºè™šæ‹Ÿç§æœ‰ç½‘ç»œï¼ˆVPNï¼‰å®ç°è¿œç¨‹è®¿é—®ã€‚è¿™äº›æœåŠ¡å¯ä»¥å¸®åŠ©ä½ åœ¨æ— æ³•è®¿é—®è·¯ç”±å™¨è®¾ç½®çš„æƒ…å†µä¸‹ï¼Œå®ç°å…¬ç½‘è®¿é—®å†…ç½‘æœåŠ¡å™¨çš„éœ€æ±‚ã€‚ä½†ä¸€èˆ¬éœ€è¦æ”¶è´¹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç½‘ç»œé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç«¯å£è½¬å‘ </tag>
            
            <tag> å†…ç½‘ç©¿é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæ–‡ä»¶ã€ç£ç›˜ä»¥åŠæ‰©å®¹æ–¹å¼</title>
      <link href="/2025/01/07/linux-wen-jian-ci-pan-yi-ji-kuo-rong-fang-shi/"/>
      <url>/2025/01/07/linux-wen-jian-ci-pan-yi-ji-kuo-rong-fang-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="é¢„å¤‡çŸ¥è¯†">é¢„å¤‡çŸ¥è¯†</h2><h3 id="æ–‡ä»¶ç³»ç»Ÿç±»å‹">æ–‡ä»¶ç³»ç»Ÿç±»å‹</h3><p>é€šè¿‡<code>df -T /home</code>æˆ–è€…<code>lsblk -f</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</p><ul><li><strong>ext4</strong>ï¼šLinuxå¸¸ç”¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå¤§æ–‡ä»¶å’Œé«˜æ€§èƒ½ã€‚</li><li><strong>XFS</strong>ï¼šç”¨äºé«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„åœºæ™¯ã€‚</li><li><strong>btrfs</strong>ï¼šæ”¯æŒé«˜çº§åŠŸèƒ½ï¼Œå¦‚å¿«ç…§å’Œå­å·ã€‚</li><li><strong>FAT32 å’ŒNTFS</strong>ï¼šå¯ç”¨ä½œè·¨å¹³å°å…¼å®¹ï¼Œä½†é€šå¸¸ç”¨äºå¤–éƒ¨è®¾å¤‡ã€‚</li></ul><h3 id="æŒ‚è½½ç‚¹">æŒ‚è½½ç‚¹</h3><ul><li><strong>æŒ‚è½½ç‚¹</strong>ï¼šå°†ç£ç›˜åˆ†åŒºä¸ç›®å½•å…³è”ï¼Œä½¿å¾—ç›®å½•ä¸­çš„æ–‡ä»¶å®é™…å­˜å‚¨åœ¨å¯¹åº”çš„ç£ç›˜åˆ†åŒºä¸­ã€‚#### æŒ‚è½½ä¸å¸è½½</li><li><strong>æŒ‚è½½</strong>ï¼š<code>sudo mount /dev/sdXn /mnt/new_home</code>,/dev/sdXn æ˜¯åˆ†åŒºè·¯å¾„ï¼Œ/mnt/new_home æ˜¯ä¸´æ—¶æŒ‚è½½ç‚¹ã€‚</li><li><strong>å¸è½½</strong>ï¼š<code>sudo umount /mnt/new_home</code>ã€‚</li></ul><h4 id="æŸ¥çœ‹å½“é’±æŒ‚è½½æƒ…å†µ">æŸ¥çœ‹å½“é’±æŒ‚è½½æƒ…å†µ</h4><p><code>mount | grep /home</code></p><p><code>lsblk</code></p><h4 id="æŒä¹…åŒ–æŒ‚è½½é…ç½®">æŒä¹…åŒ–æŒ‚è½½é…ç½®</h4><p>ç¼–è¾‘ /etc/fstabï¼Œæ·»åŠ æ–°åˆ†åŒºçš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">UUID=xxxxx-xxxxx-xxxxx /home ext4 defaults 0 2</code></pre> ä½¿ç”¨<code>blkid</code> è·å–åˆ†åŒº UUIDã€‚ UUID=xxxxx-xxxxx-xxxxx æ˜¯åˆ†åŒºçš„UUIDï¼Œ/home æ˜¯æŒ‚è½½ç‚¹ï¼Œext4 æ˜¯æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œdefaults æ˜¯é»˜è®¤æŒ‚è½½é€‰é¡¹ï¼Œ0æ˜¯å¤‡ä»½çº§åˆ«ï¼Œ2 æ˜¯æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥é¡ºåºã€‚<p></p><h3 id="åˆ†åŒºè¡¨ç±»å‹">åˆ†åŒºè¡¨ç±»å‹</h3><p>åˆ†åŒºè¡¨ç±»å‹å†³å®šäº†ç£ç›˜åˆ†åŒºçš„å¸ƒå±€æ–¹å¼ - MBRï¼ˆMaster Boot Recordï¼‰ï¼š -æ”¯æŒæœ€å¤§ 2TB ç£ç›˜ï¼Œåˆ†åŒºæ•°é‡é™åˆ¶ä¸º 4 ä¸ªä¸»åˆ†åŒºï¼ˆæˆ–ä½¿ç”¨æ‰©å±•åˆ†åŒºï¼‰ã€‚ -è¾ƒæ—§çš„ç³»ç»Ÿä¸­å¸¸è§ã€‚ - GPTï¼ˆGUID Partition Tableï¼‰ï¼š - æ”¯æŒå¤§äº 2TBçš„ç£ç›˜ï¼Œåˆ†åŒºæ•°é‡å‡ ä¹æ— é™åˆ¶ã€‚ - æ¨èä½¿ç”¨GPTï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿå’Œå¤§å®¹é‡ç£ç›˜ã€‚</p><p>å¦‚ä½•æŸ¥çœ‹åˆ†åŒºè¡¨ç±»å‹ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo fdisk -l</code></pre>è¾“å‡ºä¸­ä¼šæ˜¾ç¤ºç£ç›˜ä½¿ç”¨çš„åˆ†åŒºè¡¨ç±»å‹ï¼ˆMBR æˆ– GPTï¼‰ã€‚<p></p><h3 id="é€»è¾‘å·ç®¡ç†lvm">é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰</h3><p>LVMï¼ˆLogical Volume Managerï¼‰æä¾›äº†çµæ´»çš„å­˜å‚¨ç®¡ç†èƒ½åŠ›ï¼Œæ˜¯ç°ä»£ Linuxç³»ç»Ÿæ¨èçš„å­˜å‚¨ç®¡ç†å·¥å…·ã€‚ #### LVM ç»„æˆï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250107042326.png">- Physical Volume (PV)ï¼šç‰©ç†å·ï¼Œå¯¹åº”å®é™…ç£ç›˜åˆ†åŒºï¼ˆå¦‚ /dev/sda1ï¼‰ã€‚ -Volume Group (VG)ï¼šå·ç»„ï¼Œå°†å¤šä¸ª PV ç»„åˆæˆä¸€ä¸ªå­˜å‚¨æ± ã€‚ - Logical Volume(LV)ï¼šé€»è¾‘å·ï¼Œåœ¨å·ç»„ä¸­åˆ’åˆ†å‡ºçš„å­˜å‚¨å—ï¼Œç±»ä¼¼äºåˆ†åŒºã€‚ #### LVM çš„ä¼˜åŠ¿ï¼š -<strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´ï¼ˆæ‰©å±•æˆ–ç¼©å°ï¼‰é€»è¾‘å·ã€‚ -<strong>å­˜å‚¨æ± </strong>ï¼šå¯ä»¥å°†å¤šä¸ªç‰©ç†ç£ç›˜ç»„åˆæˆä¸€ä¸ªé€»è¾‘å­˜å‚¨æ± ã€‚ -<strong>å¿«ç…§å’Œå¤‡ä»½</strong>ï¼šæä¾›å¿«ç…§å’Œå¤‡ä»½åŠŸèƒ½ã€‚ #### å¦‚ä½•æŸ¥çœ‹ LVM é…ç½®</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo vgdisplaysudo lvdisplay</code></pre><p></p><h3 id="å—è®¾å¤‡è·¯å¾„">å—è®¾å¤‡è·¯å¾„</h3><p>å—è®¾å¤‡è·¯å¾„æ˜¯ Linux ç”¨äºæ ‡è¯†ç£ç›˜å’Œåˆ†åŒºçš„åç§°ã€‚ #### è·¯å¾„æ ¼å¼ -/dev/sdXï¼šä¼ ç»Ÿç£ç›˜è·¯å¾„ï¼ŒX æ˜¯ç£ç›˜åºå·ã€‚ - /dev/nvmeXnYï¼šNVMe ç£ç›˜è·¯å¾„ï¼ŒXæ˜¯è®¾å¤‡å·ï¼ŒY æ˜¯åˆ†åŒºå·ã€‚ - /dev/mapper/vg_name-lv_nameï¼šLVM çš„é€»è¾‘å·è·¯å¾„ã€‚#### å¦‚ä½•æŸ¥çœ‹å—è®¾å¤‡è·¯å¾„ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblk æŸ¥çœ‹ç£ç›˜å’Œåˆ†åŒºçš„ç»“æ„ã€‚blkid æŸ¥çœ‹åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿå’Œ UUIDã€‚</code></pre>å¯ä»¥é€šè¿‡<code>fdisk / parted</code> ç­‰å·¥å…·ç®¡ç†åˆ†åŒºã€‚<p></p><h2 id="linuxå’Œwindowsåœ¨ç£ç›˜åˆ†åŒºç®¡ç†ä¸Šçš„åŒºåˆ«">Linuxå’ŒWindowsåœ¨ç£ç›˜åˆ†åŒºç®¡ç†ä¸Šçš„åŒºåˆ«</h2><h3 id="åˆ†åŒºç±»å‹å’Œå¸ƒå±€">åˆ†åŒºç±»å‹å’Œå¸ƒå±€</h3><table><colgroup><col style="width: 3%"><col style="width: 29%"><col style="width: 38%"><col style="width: 28%"></colgroup><thead><tr class="header"><th><strong>ç³»ç»Ÿ</strong></th><th><strong>åˆ†åŒºç±»å‹</strong></th><th><strong>åˆ†åŒºç»“æ„</strong></th><th><strong>æŒ‚è½½ç‚¹</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Linux</strong></td><td>-ä½¿ç”¨ä¸»åˆ†åŒºï¼ˆPrimaryï¼‰ã€æ‰©å±•åˆ†åŒºï¼ˆExtendedï¼‰å’Œé€»è¾‘åˆ†åŒºï¼ˆLogicalï¼‰çš„ç»“æ„<br>-GPTï¼ˆGUIDåˆ†åŒºè¡¨ï¼‰æ”¯æŒ 128 ä¸ªä»¥ä¸Šçš„åˆ†åŒº</td><td>- åˆ†åŒºé€šå¸¸ç”¨è®¾å¤‡æ–‡ä»¶è¡¨ç¤ºï¼Œå¦‚<code>/dev/sda1</code>ï¼ˆè¡¨ç¤ºç¬¬ä¸€ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒºï¼‰<br>-æ–‡ä»¶ç³»ç»Ÿå¯ä»¥è·¨è¶Šå¤šä¸ªåˆ†åŒºï¼ˆå¦‚é€šè¿‡ LVM å®ç°é€»è¾‘å·ç®¡ç†ï¼‰</td><td>- æ— å›ºå®šçš„é©±åŠ¨å™¨ç¬¦å·ï¼ˆå¦‚ Windows çš„ C:ã€D:ï¼‰<br>-æ‰€æœ‰åˆ†åŒºæ•´åˆåˆ°ä¸€ä¸ªç›®å½•æ ‘ä¸‹ï¼Œä¾‹å¦‚æ ¹ç›®å½• <code>/</code></td></tr><tr class="even"><td><strong>Windows</strong></td><td>- æ”¯æŒ MBRï¼ˆæœ€å¤š 4 ä¸ªä¸»åˆ†åŒºï¼‰å’Œ GPTï¼ˆæ”¯æŒæ›´å¤šåˆ†åŒºï¼‰</td><td>- åˆ†åŒºé€šå¸¸è¡¨ç¤ºä¸ºç‹¬ç«‹çš„é©±åŠ¨å™¨ç¬¦å·ï¼Œå¦‚ C:ã€D:</td><td>- æ¯ä¸ªåˆ†åŒºæ˜¯ç‹¬ç«‹çš„é€»è¾‘å•å…ƒ<br>- æ”¯æŒé€šè¿‡æŒ‚è½½ç‚¹åŠŸèƒ½å°†åˆ†åŒºæŒ‚è½½ä¸º NTFSæ–‡ä»¶ç³»ç»Ÿä¸‹çš„æ–‡ä»¶å¤¹ï¼Œä½†ä¸å¸¸ç”¨</td></tr></tbody></table><h3 id="æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</h3><table><colgroup><col style="width: 5%"><col style="width: 52%"><col style="width: 41%"></colgroup><thead><tr class="header"><th><strong>ç³»ç»Ÿ</strong></th><th><strong>å¸¸è§æ–‡ä»¶ç³»ç»Ÿ</strong></th><th><strong>çµæ´»æ€§</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Linux</strong></td><td>- <strong>ext4</strong>: ç°ä»£ Linuxçš„é»˜è®¤æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå¤§æ–‡ä»¶å’Œé«˜æ€§èƒ½<br>- <strong>XFS</strong>:ç”¨äºé«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„åœºæ™¯<br>- <strong>btrfs</strong>:æ”¯æŒé«˜çº§åŠŸèƒ½ï¼Œå¦‚å¿«ç…§å’Œå­å·<br>- <strong>FAT32 å’Œ NTFS</strong>:å¯ç”¨ä½œè·¨å¹³å°å…¼å®¹ï¼Œä½†é€šå¸¸ç”¨äºå¤–éƒ¨è®¾å¤‡</td><td>- å¤šç§æ–‡ä»¶ç³»ç»Ÿå¯é€‰ï¼Œæ”¯æŒæ ¼å¼åŒ–ä¸ºå‡ ä¹ä»»ä½•æ–‡ä»¶ç³»ç»Ÿ<br>-æ”¯æŒç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NFSã€CIFSï¼‰</td></tr><tr class="even"><td><strong>Windows</strong></td><td>- <strong>NTFS</strong>: é»˜è®¤çš„ä¸»æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒé«˜æ€§èƒ½å’Œå®‰å…¨åŠŸèƒ½<br>-<strong>FAT32 å’Œ exFAT</strong>: ç”¨äºå¤–éƒ¨è®¾å¤‡æˆ–æŸäº›ç‰¹æ®Šç”¨é€”</td><td>- ä¸æ”¯æŒç›´æ¥æ ¼å¼åŒ–ä¸º Linux åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext4ï¼‰<br>-æ–‡ä»¶ç³»ç»Ÿé€‰é¡¹ç›¸å¯¹è¾ƒå°‘</td></tr></tbody></table><h3 id="å¼•å¯¼åŠ è½½">å¼•å¯¼åŠ è½½</h3><table><colgroup><col style="width: 9%"><col style="width: 90%"></colgroup><thead><tr class="header"><th><strong>ç³»ç»Ÿ</strong></th><th><strong>ç‰¹ç‚¹</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Linux</strong></td><td>- ä½¿ç”¨ GRUBï¼ˆæˆ–å…¶ä»–å¼•å¯¼ç¨‹åºï¼‰ç®¡ç†å¯åŠ¨é¡¹<br>-æ”¯æŒä»å¤šç§åˆ†åŒºæˆ–ç³»ç»Ÿå¯åŠ¨ï¼Œçµæ´»æ€§é«˜<br>- æ ¹åˆ†åŒºï¼ˆ/ï¼‰å’Œå¼•å¯¼åˆ†åŒºï¼ˆå¦‚/bootï¼‰å¯ä»¥åˆ†ç¦»<br>- æ”¯æŒåŒç³»ç»Ÿæˆ–å¤šç³»ç»Ÿå¹¶å­˜</td></tr><tr class="even"><td><strong>Windows</strong></td><td>- ä½¿ç”¨ Windows Boot Manager ç®¡ç†å¼•å¯¼<br>-é€šå¸¸ä¾èµ–ç‰¹å®šçš„ç³»ç»Ÿåˆ†åŒºï¼ˆSystem Reserved æˆ– EFI åˆ†åŒºï¼‰<br>-åŒç³»ç»Ÿæ”¯æŒæœ‰é™ï¼Œéœ€ç¬¬ä¸‰æ–¹å¼•å¯¼ç®¡ç†å™¨ï¼ˆå¦‚ GRUBï¼‰ååŠ©</td></tr></tbody></table><h3 id="åˆ†åŒºå·¥å…·">åˆ†åŒºå·¥å…·</h3><table><colgroup><col style="width: 8%"><col style="width: 91%"></colgroup><thead><tr class="header"><th><strong>ç³»ç»Ÿ</strong></th><th><strong>ç‰¹ç‚¹</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Linux</strong></td><td>- å‘½ä»¤è¡Œå·¥å…·ä¸°å¯Œï¼š<br> - <strong>fdisk</strong>: é€‚ç”¨äº MBRåˆ†åŒºè¡¨<br> - <strong>gdisk</strong>: é€‚ç”¨äº GPT åˆ†åŒºè¡¨<br> -<strong>parted å’Œ gparted</strong>: é«˜çº§åˆ†åŒºç®¡ç†å·¥å…·<br>-çµæ´»æ”¯æŒå‘½ä»¤è¡Œå’Œå›¾å½¢ç•Œé¢<br>- æä¾›LVMï¼ˆé€»è¾‘å·ç®¡ç†ï¼‰æ”¯æŒï¼Œä¾¿äºåŠ¨æ€è°ƒæ•´åˆ†åŒºå¤§å°</td></tr><tr class="even"><td><strong>Windows</strong></td><td>- å›¾å½¢åŒ–å·¥å…·ä¸ºä¸»ï¼š<br> - <strong>ç£ç›˜ç®¡ç†</strong>ï¼ˆDiskManagementï¼‰æ˜¯ä¸»è¦çš„åˆ†åŒºå·¥å…·<br> - å‘½ä»¤è¡Œå·¥å…·å¦‚<strong>diskpart</strong><br>- ç›¸è¾ƒLinuxï¼ŒåŠ¨æ€è°ƒæ•´åˆ†åŒºå¤§å°çš„çµæ´»æ€§è¾ƒä½</td></tr></tbody></table><h3 id="æ–‡ä»¶è·¯å¾„å’Œç¬¦å·">æ–‡ä»¶è·¯å¾„å’Œç¬¦å·</h3><table><colgroup><col style="width: 9%"><col style="width: 90%"></colgroup><thead><tr class="header"><th><strong>ç³»ç»Ÿ</strong></th><th><strong>ç‰¹ç‚¹</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Linux</strong></td><td>- æ–‡ä»¶è·¯å¾„åŒºåˆ†å¤§å°å†™ï¼Œä¾‹å¦‚ <code>/home</code> å’Œ <code>/Home</code>æ˜¯ä¸åŒçš„è·¯å¾„<br>- ä½¿ç”¨æ­£æ–œæ  <code>/</code> ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦<br>-æ”¯æŒç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥</td></tr><tr class="even"><td><strong>Windows</strong></td><td>- æ–‡ä»¶è·¯å¾„ä¸åŒºåˆ†å¤§å°å†™ï¼Œä¾‹å¦‚ <code>C:\Users</code> å’Œ<code>C:\users</code> æ˜¯åŒä¸€è·¯å¾„<br>- ä½¿ç”¨åæ–œæ  <code>\</code>ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦<br>- æ”¯æŒå¿«æ·æ–¹å¼ï¼ˆåŠŸèƒ½ç±»ä¼¼äºç¬¦å·é“¾æ¥ï¼‰</td></tr></tbody></table><h2 id="linux-æ ¹ç›®å½•">Linux æ ¹ç›®å½•</h2><p>æ ¹æ® <strong>Filesystem Hierarchy Standard (FHS)</strong>ï¼ŒLinuxçš„æ ¹ç›®å½• <code>/</code>ä¸‹å­˜åœ¨ä¸€ç³»åˆ—æ ‡å‡†åŒ–çš„ç›®å½•ï¼Œä»¥ä¸‹æ˜¯å¸¸è§ç›®å½•åŠå…¶ä½œç”¨è¯´æ˜ã€‚</p><h3 id="bin-binary">1. <code>/bin</code> ï¼ˆBinaryï¼‰</h3><ul><li>å­˜æ”¾ç³»ç»Ÿå¯åŠ¨æ—¶æˆ–å•ç”¨æˆ·æ¨¡å¼ä¸‹çš„åŸºæœ¬ç”¨æˆ·å‘½ä»¤ã€‚</li><li>åŒ…æ‹¬å¸¸ç”¨çš„å‘½ä»¤ï¼Œå¦‚<code>ls</code>ã€<code>cp</code>ã€<code>mv</code>ã€<code>cat</code>ç­‰ã€‚</li><li>å¯ä¾›æ‰€æœ‰ç”¨æˆ·è®¿é—®ã€‚</li><li><hr></li></ul><h3 id="boot-boot">2. <code>/boot</code> ï¼ˆBootï¼‰</h3><ul><li>å­˜æ”¾ç³»ç»Ÿå¯åŠ¨æ‰€éœ€çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆå¦‚GRUBï¼‰çš„é…ç½®æ–‡ä»¶å’Œå†…æ ¸æ–‡ä»¶ã€‚</li><li>å¸¸è§æ–‡ä»¶ï¼š<ul><li><code>vmlinuz</code>ï¼šå‹ç¼©å†…æ ¸æ–‡ä»¶ã€‚</li><li><code>initrd.img</code>ï¼šåˆå§‹ RAM ç£ç›˜é•œåƒã€‚</li><li><code>grub</code> ç›®å½•ï¼šGRUB å¼•å¯¼åŠ è½½ç¨‹åºçš„é…ç½®æ–‡ä»¶ã€‚</li></ul></li></ul><hr><h3 id="dev-device">3. <code>/dev</code> ï¼ˆDeviceï¼‰</h3><ul><li>åŒ…å«è®¾å¤‡æ–‡ä»¶ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­çš„ç¡¬ä»¶è®¾å¤‡ã€‚</li><li>è®¾å¤‡æ–‡ä»¶é€šå¸¸é€šè¿‡ <code>/dev</code> æä¾›æ¥å£ï¼Œä¾‹å¦‚ï¼š<ul><li><code>/dev/sda</code>ï¼šç¬¬ä¸€ä¸ª SATA ç¡¬ç›˜ã€‚</li><li><code>/dev/null</code>ï¼šç©ºè®¾å¤‡ã€‚</li><li><code>/dev/tty</code>ï¼šç»ˆç«¯æ¥å£ã€‚</li></ul></li></ul><hr><h3 id="etc-et-cetera">4. <code>/etc</code> ï¼ˆEt Ceteraï¼‰</h3><ul><li>å­˜æ”¾ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€‚</li><li>é€šå¸¸åªç”±ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆ<code>root</code> ç”¨æˆ·ï¼‰ä¿®æ”¹ã€‚</li><li>å¸¸è§æ–‡ä»¶å’Œç›®å½•ï¼š<ul><li><code>/etc/passwd</code>ï¼šç”¨æˆ·ä¿¡æ¯ã€‚</li><li><code>/etc/fstab</code>ï¼šæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¿¡æ¯ã€‚</li><li><code>/etc/network/interfaces</code>ï¼šç½‘ç»œé…ç½®ã€‚</li></ul></li></ul><hr><h3 id="home">5. <code>/home</code></h3><ul><li>å­˜æ”¾æ™®é€šç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œæ¯ä¸ªç”¨æˆ·ä¸€ä¸ªå­ç›®å½•ã€‚</li><li>ç¤ºä¾‹ï¼š<ul><li><code>/home/user1</code>ï¼šç”¨æˆ· <code>user1</code> çš„ä¸»ç›®å½•ã€‚</li></ul></li><li>ç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸»ç›®å½•ä¸­å­˜å‚¨æ–‡ä»¶ã€é…ç½®æ•°æ®ç­‰ã€‚</li></ul><hr><h3 id="lib-library">6. <code>/lib</code> ï¼ˆLibraryï¼‰</h3><ul><li>å­˜æ”¾ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„å…±äº«åº“ï¼ˆç±»ä¼¼äº Windows çš„ <code>.dll</code>æ–‡ä»¶ï¼‰ã€‚</li><li>åŒ…æ‹¬ <code>/bin</code> å’Œ <code>/sbin</code>ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶æ‰€ä¾èµ–çš„åº“ã€‚</li></ul><hr><h3 id="media">7. <code>/media</code></h3><ul><li>æŒ‚è½½ç‚¹ç›®å½•ï¼Œç”¨äºè‡ªåŠ¨æŒ‚è½½å¤–éƒ¨è®¾å¤‡ï¼ˆå¦‚ USB é©±åŠ¨å™¨ã€å…‰ç›˜ï¼‰ã€‚</li><li>å½“æ’å…¥å¤–éƒ¨å­˜å‚¨è®¾å¤‡æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ <code>/media</code>ä¸‹åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚</li></ul><hr><h3 id="mnt">8. <code>/mnt</code></h3><ul><li>ä¸´æ—¶æŒ‚è½½ç‚¹ç›®å½•ã€‚</li><li>ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåˆ°è¯¥ç›®å½•ä¸‹ã€‚</li><li>ç”¨äºä¸´æ—¶æŒ‚è½½è€Œéè‡ªåŠ¨åŒ–ã€‚</li></ul><hr><h3 id="opt-optional">9. <code>/opt</code> ï¼ˆOptionalï¼‰</h3><ul><li>å­˜æ”¾å¯é€‰çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ã€‚</li><li>ä¸€äº›è½¯ä»¶ä¼šå®‰è£…åœ¨ <code>/opt</code> ä¸‹ï¼Œä¾‹å¦‚<code>/opt/myapp</code>ã€‚</li></ul><hr><h3 id="proc">10. <code>/proc</code></h3><ul><li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå­˜å‚¨ç³»ç»Ÿå†…æ ¸å’Œè¿›ç¨‹ç›¸å…³ä¿¡æ¯ã€‚</li><li>åŠ¨æ€ç”Ÿæˆï¼Œä¸å ç”¨å®é™…ç£ç›˜ç©ºé—´ã€‚</li><li>ç¤ºä¾‹ï¼š<ul><li><code>/proc/cpuinfo</code>ï¼šCPU ä¿¡æ¯ã€‚</li><li><code>/proc/meminfo</code>ï¼šå†…å­˜ä½¿ç”¨ä¿¡æ¯ã€‚</li></ul></li></ul><hr><h3 id="root">11. <code>/root</code></h3><ul><li><code>root</code> ç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œä¸æ™®é€šç”¨æˆ·çš„<code>/home/username</code> å¯¹åº”ã€‚</li><li>é€šå¸¸åªæœ‰ <code>root</code> ç”¨æˆ·æœ‰æƒé™è®¿é—®ã€‚</li><li>éœ€è¦é€šè¿‡<code>sudo passwd root</code>è®¾ç½®å¯†ç æ‰èƒ½ç™»å½•ã€‚</li></ul><hr><h3 id="run">12. <code>/run</code></h3><ul><li>ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè¿è¡Œæ—¶ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆå¦‚è¿›ç¨‹ IDæ–‡ä»¶ã€å¥—æ¥å­—ï¼‰ã€‚</li><li>ç³»ç»Ÿé‡å¯åè¯¥ç›®å½•ä¼šè¢«æ¸…ç©ºã€‚</li></ul><hr><h3 id="sbin-system-binary">13. <code>/sbin</code> ï¼ˆSystemBinaryï¼‰</h3><ul><li>å­˜æ”¾ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨çš„åŸºæœ¬å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š<ul><li><code>fsck</code>ï¼šæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ã€‚</li><li><code>reboot</code>ï¼šé‡å¯ç³»ç»Ÿã€‚</li></ul></li><li>ä¸€èˆ¬æ™®é€šç”¨æˆ·æ— æƒç›´æ¥æ‰§è¡Œã€‚</li></ul><hr><h3 id="srv-service">14. <code>/srv</code> ï¼ˆServiceï¼‰</h3><ul><li>å­˜å‚¨ä¸ç³»ç»Ÿæä¾›çš„æœåŠ¡ï¼ˆå¦‚ HTTPã€FTPï¼‰ç›¸å…³çš„æ•°æ®ã€‚</li><li>ç¤ºä¾‹ï¼š<code>/srv/www</code> å¯èƒ½å­˜æ”¾ä¸€ä¸ª Web æœåŠ¡å™¨çš„æ•°æ®ã€‚</li></ul><hr><h3 id="sys">15. <code>/sys</code></h3><ul><li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›å†…æ ¸å’Œç¡¬ä»¶è®¾å¤‡çš„ä¿¡æ¯ã€‚</li><li>å’Œ <code>/proc</code> ç±»ä¼¼ï¼Œä½†æ›´æ³¨é‡è®¾å¤‡ç›¸å…³çš„ä¿¡æ¯ã€‚</li></ul><hr><h3 id="tmp-temporary">16. <code>/tmp</code> ï¼ˆTemporaryï¼‰</h3><ul><li>ç”¨äºå­˜å‚¨ä¸´æ—¶æ–‡ä»¶ã€‚</li><li>æ–‡ä»¶é€šå¸¸ä¼šåœ¨ç³»ç»Ÿé‡å¯æ—¶æ¸…ç©ºã€‚</li></ul><hr><h3 id="usr-user-system-resources">17. <code>/usr</code> ï¼ˆUser SystemResourcesï¼‰</h3><ul><li>åŒ…å«ä¸ç”¨æˆ·ç›¸å…³çš„æ–‡ä»¶å’Œèµ„æºï¼š<ul><li><code>/usr/bin</code>ï¼šç”¨æˆ·å¯ç”¨çš„å‘½ä»¤ã€‚</li><li><code>/usr/lib</code>ï¼šå…±äº«åº“ã€‚</li><li><code>/usr/share</code>ï¼šå…±äº«æ•°æ®ï¼ˆå¦‚æ–‡æ¡£ã€å›¾æ ‡ï¼‰ã€‚</li><li><code>/usr/local</code>ï¼šæœ¬åœ°å®‰è£…çš„è½¯ä»¶ã€‚</li></ul></li></ul><hr><h3 id="var-variable">18. <code>/var</code> ï¼ˆVariableï¼‰</h3><ul><li>å­˜æ”¾ç»å¸¸å˜åŒ–çš„æ–‡ä»¶ã€‚</li><li>ç¤ºä¾‹ï¼š<ul><li><code>/var/log</code>ï¼šæ—¥å¿—æ–‡ä»¶ã€‚</li><li><code>/var/spool</code>ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚æ‰“å°ä»»åŠ¡ï¼‰ã€‚</li></ul></li></ul><hr><h2 id="ubuntu-ç³»ç»Ÿåˆ†åŒºå»ºè®®">Ubuntu ç³»ç»Ÿåˆ†åŒºå»ºè®®</h2><h3 id="åŸºæœ¬åˆ†åŒºæ–¹æ¡ˆ">åŸºæœ¬åˆ†åŒºæ–¹æ¡ˆ</h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå»ºè®®ä»¥ä¸‹å‡ ä¸ªåˆ†åŒºï¼š</p><h4 id="æ ¹åˆ†åŒº">1. <code>/</code>ï¼ˆæ ¹åˆ†åŒºï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜æ”¾æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ–‡ä»¶å’Œé»˜è®¤å®‰è£…çš„è½¯ä»¶ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li><strong>20-30GB</strong>ï¼šæ™®é€šæ¡Œé¢ç”¨æˆ·ã€‚</li><li><strong>40-50GB</strong>ï¼šéœ€è¦å®‰è£…å¤§é‡è½¯ä»¶æˆ–å¼€å‘ç¯å¢ƒçš„ç”¨æˆ·ã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>ext4</code>ï¼ˆæ¨èï¼‰ã€‚</li><li><strong>æ³¨æ„</strong>ï¼šæ‰€æœ‰æœªåˆ†é…åˆ°å…¶ä»–åˆ†åŒºçš„å†…å®¹éƒ½ä¼šé»˜è®¤å­˜å‚¨åœ¨æ ¹åˆ†åŒºä¸­ã€‚</li></ul><h4 id="swapäº¤æ¢åˆ†åŒº">2. <code>swap</code>ï¼ˆäº¤æ¢åˆ†åŒºï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šè™šæ‹Ÿå†…å­˜ï¼Œç”¨äºå†…å­˜ä¸è¶³æ—¶æä¾›ä¸´æ—¶å­˜å‚¨ï¼›ä¹Ÿç”¨äºä¼‘çœ åŠŸèƒ½ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li>å¦‚æœ <strong>ä¸ä½¿ç”¨ä¼‘çœ åŠŸèƒ½</strong>ï¼š<ul><li>RAM &lt; 4GBï¼š<strong>ç­‰äº2å€RAMå¤§å°</strong>ã€‚</li><li>RAM åœ¨ 4-8GBï¼š<strong>ç­‰äºRAMå¤§å°</strong>ã€‚</li><li>RAM &gt; 8GBï¼š<strong>4-8GB</strong> é€šå¸¸è¶³å¤Ÿã€‚</li></ul></li><li>å¦‚æœ <strong>ä½¿ç”¨ä¼‘çœ åŠŸèƒ½</strong>ï¼š<ul><li>è‡³å°‘ç­‰äºRAMå¤§å°ã€‚</li></ul></li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼šä¸“ç”¨äº¤æ¢ç©ºé—´ï¼Œæ— æ–‡ä»¶ç³»ç»Ÿã€‚</li><li><strong>æ³¨æ„</strong>ï¼šç°ä»£ Ubuntuæ”¯æŒä½¿ç”¨äº¤æ¢æ–‡ä»¶ï¼ˆæ— éœ€å•ç‹¬åˆ†åŒºï¼‰ï¼Œå¯åœ¨å®‰è£…åé…ç½®ã€‚</li></ul><h4 id="homeç”¨æˆ·ç›®å½•">3. <code>/home</code>ï¼ˆç”¨æˆ·ç›®å½•ï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜å‚¨ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æ–‡æ¡£ã€é…ç½®ã€ä¸‹è½½ç­‰ï¼‰ï¼Œä¾¿äºç³»ç»Ÿé‡è£…æ—¶ä¿ç•™ç”¨æˆ·æ•°æ®ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li>æ™®é€šæ¡Œé¢ç”¨æˆ·ï¼š<strong>50GB æˆ–æ›´å¤š</strong>ã€‚</li><li>å¦‚æœç¡¬ç›˜ç©ºé—´å……è£•ï¼Œå¯åˆ†é…<strong>100GB+</strong>ï¼Œä»¥æ”¯æŒé•¿æœŸä½¿ç”¨ã€‚</li><li>æœåŠ¡å™¨æˆ–å¼€å‘ç”¨æˆ·ï¼šæŒ‰å®é™…éœ€æ±‚åˆ†é…ã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>ext4</code>ï¼ˆæ¨èï¼‰ã€‚</li></ul><h4 id="bootå¯é€‰">4. <code>/boot</code>ï¼ˆå¯é€‰ï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜æ”¾å¼•å¯¼åŠ è½½ç¨‹åºå’Œå†…æ ¸æ–‡ä»¶ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li><strong>500MB-1GB</strong>ï¼šæ™®é€šç”¨æˆ·ã€‚</li><li><strong>1-2GB</strong>ï¼šå¦‚æœéœ€è¦ä¿ç•™å¤šä¸ªå†…æ ¸ç‰ˆæœ¬ã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>ext4</code>ã€‚</li></ul><h4 id="efiå¦‚æœæ˜¯-uefi-ç³»ç»Ÿ">5. <code>/efi</code>ï¼ˆå¦‚æœæ˜¯ UEFIç³»ç»Ÿï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜æ”¾ UEFI å¼•å¯¼ç¨‹åºã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li><strong>300-500MB</strong> é€šå¸¸è¶³å¤Ÿã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>FAT32</code>ã€‚</li><li><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ˜¯å¤šç³»ç»Ÿç¯å¢ƒï¼ŒEFI åˆ†åŒºå¯ä»¥å…±äº«ã€‚</li></ul><h4 id="varå¯é€‰">6. <code>/var</code>ï¼ˆå¯é€‰ï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜æ”¾æ—¥å¿—æ–‡ä»¶ã€ç¼“å­˜æ•°æ®ã€é‚®ä»¶é˜Ÿåˆ—ç­‰ï¼ˆç‰¹åˆ«æ˜¯æœåŠ¡å™¨ç¯å¢ƒï¼‰ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li><strong>5-10GB</strong>ï¼šæ™®é€šç”¨æˆ·ã€‚</li><li><strong>20-50GB</strong>ï¼šå¦‚æœè¿è¡Œæ•°æ®åº“ã€WebæœåŠ¡å™¨æˆ–å…¶ä»–é«˜æ—¥å¿—ç”ŸæˆæœåŠ¡ã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>ext4</code>ã€‚</li></ul><h4 id="tmpå¯é€‰">7. <code>/tmp</code>ï¼ˆå¯é€‰ï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼š<ul><li><strong>2-4GB</strong>ï¼šæ™®é€šç”¨æˆ·ã€‚</li><li><strong>10GBæˆ–æ›´å¤š</strong>ï¼šéœ€è¦å¤„ç†å¤§é‡ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚è§†é¢‘ç¼–è¾‘ã€ç¼–è¯‘å¤§å‹é¡¹ç›®ï¼‰ã€‚</li></ul></li><li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š<code>ext4</code> æˆ–<code>tmpfs</code>ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</li></ul><h4 id="æ•°æ®åˆ†åŒºå¯é€‰">8. æ•°æ®åˆ†åŒºï¼ˆå¯é€‰ï¼‰</h4><ul><li><strong>ç”¨é€”</strong>ï¼šç‹¬ç«‹å­˜å‚¨å¤§æ–‡ä»¶æˆ–å…±äº«æ•°æ®ï¼ˆå¦‚<code>/mnt/data</code>ï¼‰ã€‚</li><li><strong>å»ºè®®å¤§å°</strong>ï¼šæ ¹æ®éœ€æ±‚è°ƒæ•´ã€‚</li></ul><hr><h3 id="åˆ†åŒºå»ºè®®">åˆ†åŒºå»ºè®®</h3><ol type="1"><li><strong>æ ¹åˆ†åŒºå¤§å°è¦åˆç†</strong>ï¼š<ul><li>æ ¹åˆ†åŒºå­˜æ”¾ç³»ç»Ÿå’Œè½¯ä»¶æ–‡ä»¶ï¼Œé™¤å•ç‹¬åˆ†é…ç©ºé—´çš„æŒ‚è½½ç‚¹ï¼Œå…¶ä½™å†…å®¹éƒ½å­˜å‚¨åœ¨æ ¹åˆ†åŒºä¸­ã€‚</li><li>å¦‚æœç©ºé—´ä¸è¶³ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿæ— æ³•æ›´æ–°æˆ–å®‰è£…æ–°è½¯ä»¶ã€‚</li></ul></li><li><strong>ä¼˜å…ˆä¸º <code>/home</code> ç•™å‡ºç©ºé—´</strong>ï¼š<ul><li><code>/home</code>æ˜¯ç”¨æˆ·æ•°æ®çš„ä¸»è¦å­˜å‚¨ä½ç½®ï¼Œå»ºè®®åˆ†é…å°½å¯èƒ½å¤§çš„ç©ºé—´ã€‚</li></ul></li><li><strong>ä½¿ç”¨ LVM</strong>ï¼š<ul><li>å¦‚æœç£ç›˜ä½¿ç”¨é‡ä¸ç¡®å®šï¼Œä½¿ç”¨ LVM ä¾¿äºåç»­æ‰©å±•ã€‚</li></ul></li><li><strong>EFI åˆ†åŒºå…±äº«</strong>ï¼š<ul><li>å¦‚æœæœ‰å¤šç³»ç»Ÿï¼ˆå¦‚ Windows å’Œ Linuxï¼‰ï¼Œå¯ä»¥å…±äº«ä¸€ä¸ª<code>/boot/efi</code> åˆ†åŒºã€‚</li></ul></li><li><strong>æ ¹æ®ç”¨é€”ä¼˜åŒ–åˆ†åŒº</strong>ï¼š<ul><li>æ¡Œé¢ç”¨æˆ·å¯ä»¥ç®€åŒ–åˆ†åŒºç»“æ„ã€‚</li><li>æœåŠ¡å™¨æˆ–å¼€å‘ç¯å¢ƒå¯ä»¥æ ¹æ®éœ€è¦ç»†åŒ–åˆ†åŒºã€‚</li></ul></li></ol><hr><h1 id="æ‰©å®¹æ–¹å¼">æ‰©å®¹æ–¹å¼</h1><h2 id="æ–°å»ºç£ç›˜åˆ†åŒºå¹¶æŒ‚è½½åˆ°æ–°çš„æŒ‚è½½ç‚¹ä¸Š">æ–°å»ºç£ç›˜åˆ†åŒºå¹¶æŒ‚è½½åˆ°æ–°çš„æŒ‚è½½ç‚¹ä¸Š</h2><p>ä¸»è¦ä½¿ç”¨çš„å‘½ä»¤ï¼š<code>fdisk</code>ã€<code>mkfs</code>ã€<code>mount</code>ã€<code>umount</code>ã€<code>df</code>ã€<code>lsblk</code>1. <strong>æŸ¥çœ‹ç£ç›˜</strong>ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblk</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250107172719.png">å¯ä»¥çœ‹å‡ºé‡Œé¢æœ‰ä¸‰ä¸ªç¡¬ç›˜ï¼šsda/nvme0n1/nvme1n1ï¼Œç›®å‰æˆ‘çš„Linuxæ–‡ä»¶ç³»ç»Ÿå…¨éƒ¨éƒ½åœ¨sdaä¸­çš„éƒ¨åˆ†åˆ†åŒºä¸­ï¼Œå¦å¤–nvme0n1åªè®¾ç½®äº†ä¸€ä¸ª/boot/efiçš„æŒ‚è½½ç‚¹ã€‚ç°åœ¨æˆ‘æƒ³ä»nvme1n1ä¸­åˆ†é…ä¸€éƒ¨åˆ†ç©ºé—´ç»™sda/ada6çš„/homeåˆ†åŒºã€‚2. <strong>ç£ç›˜åˆ†åŒºå¹¶æŒ‚è½½</strong>ï¼š é¦–å…ˆå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç£ç›˜çš„ä½¿ç”¨æƒ…å†µ<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo fdisk -l /dev/nvme1n1</code></pre> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20250107173236.png">è¿™ä¸ªç›˜ä¹‹å‰åœ¨windowsç³»ç»Ÿä¸Šä½¿ç”¨ï¼Œç›®å‰çš„åˆ†åŒºä¹Ÿå·²ç»å æ»¡äº†å…¨éƒ¨ç©ºé—´ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤ä¸€äº›åˆ†åŒºæˆ–è€…ç›´æ¥ä½¿ç”¨ä¹‹å‰çš„åˆ†åŒºï¼Œå¦‚æœè¦åˆ é™¤çš„è¯æˆ‘ä»¬å¯ä»¥é‡æ–°å¯¹è¿™ä¸ªç›˜è¿›è¡Œåˆ†åŒºï¼Œå€ŸåŠ©fdiskæˆ–è€…partedåº”è¯¥éƒ½å¯ä»¥ï¼š- åˆ é™¤åˆ†åŒºï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo fdisk /dev/nvme1n1</code></pre> - è¾“å…¥ dï¼Œ é€ä¸€åˆ é™¤æ‰€æœ‰åˆ†åŒºã€‚ - è¾“å…¥ wä¿å­˜æ›´æ”¹ã€‚ - æ–°å»ºåˆ†åŒº <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo fdisk /dev/nvme1n1</code></pre> - è¾“å…¥ n åˆ›å»ºæ–°åˆ†åŒº -æŒ‰æç¤ºé€‰æ‹©åˆ†åŒºç±»å‹ï¼ˆé€šå¸¸æ˜¯ä¸»åˆ†åŒºï¼‰ã€‚ -æä¾›èµ·å§‹æ‰‡åŒºå’Œç»“æŸæ‰‡åŒºï¼ˆé»˜è®¤å€¼å³å¯ä½¿ç”¨æœªåˆ†é…çš„å…¨éƒ¨ç©ºé—´ï¼‰ã€‚ -ç¡®è®¤å¹¶å®Œæˆåˆ›å»ºã€‚ - æ ¼å¼åŒ–åˆ†åŒº <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo mkfs.ext4 /dev/nvme1n1p1</code></pre> - æŒ‚è½½åˆ†åŒº <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo mount /dev/nvme1n1 /mnt/new_home</code></pre>æ³¨æ„å‰é¢æˆ‘ä»¬è¯´è¿‡/mntæ˜¯ä¸´æ—¶æŒ‚è½½ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ª/home/dataæŒ‚è½½ç‚¹æ¥å®ç°å¯¹/homeç›®å½•çš„æ‰©å®¹ï¼Œä½†æ˜¯å…¶å®è¿™æ ·åœ¨ç³»ç»Ÿé‡å¯åä¾æ—§æ˜¯ä¸´æ—¶çš„ï¼Œæ¯æ¬¡éƒ½é‡å¯éœ€è¦æ‰‹åŠ¨æŒ‚è½½æ‰èƒ½æ­£å¸¸ä½¿ç”¨åˆ†åŒºå†…å®¹ã€‚- æŒä¹…åŒ–æŒ‚è½½ - è·å–åˆ†åŒº UUIDï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo blkid /dev/nvme1n1p1</code></pre> - ç¼–è¾‘ /etc/fstab æ–‡ä»¶ï¼šæ·»åŠ ä»¥ä¸‹è¡Œï¼Œå°†æ–°åˆ†åŒºæŒ‚è½½åˆ° /home/dataï¼š <pre class="line-numbers language-none"><code class="language-none">UUID=xxxx-xxxx-xxxx-xxxx /home/data ext4 defaults 0 2</code></pre> - æµ‹è¯• /etc/fstabé…ç½®ï¼š <pre class="line-numbers language-none"><code class="language-none">sudo mount -a</code></pre> - éªŒè¯æ˜¯å¦æŒ‚è½½ï¼š<code>df -h</code> 3.æ–°æŒ‚è½½ç‚¹æƒé™è®¾ç½® ä¸Šé¢çš„æ¡ˆä¾‹ä¸­/home ä¸‹çš„å­ç›®å½•ï¼ˆ/home/dataï¼‰ä¼šç‹¬ç«‹ä½¿ç”¨æ–°åˆ†åŒºçš„å­˜å‚¨ç©ºé—´ï¼Œä¸ä¼šç›´æ¥æ‰©å±• /homeä¸»ç›®å½•çš„å¯ç”¨ç©ºé—´ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŒ‚è½½åçš„ /home/data å¯èƒ½ç”± rootç”¨æˆ·æ‹¥æœ‰ã€‚æ ¹æ®éœ€è¦ä¿®æ”¹ç›®å½•æƒé™ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo chown -R &lt;username&gt;:&lt;group&gt; /home/data æˆ–è€…chmod -R æƒé™ /home/data   ï¼ˆæƒé™ç”±ä¸‰ä½æ•°å­—ç»„æˆï¼Œåˆ†åˆ«å¯¹åº”æ‰€æœ‰è€…/ç»„/å…¶ä»–ç”¨æˆ·çš„æƒé™ï¼Œå•ä¸ªæ•°å­—æƒé™ä¸ºr=4ï¼Œw=2ï¼Œx=1çš„å’Œï¼‰</code></pre><p></p><ol start="4" type="1"><li>æ•°æ®è¿ç§» å¦‚æœ /home ä¸­å·²æœ‰éœ€è¦è¿ç§»åˆ° /home/data çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨rsync è¿›è¡Œè¿ç§»ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo rsync -av /home/old_data /home/data</code></pre></li></ol><h2 id="lvmæ‰©å®¹">LVMæ‰©å®¹</h2><p>æ›´æ–°ä¸­ã€‚ã€‚ã€‚ã€‚</p><h2 id="ç›´æ¥æ‰©å®¹ç°æœ‰åˆ†åŒº">ç›´æ¥æ‰©å®¹ç°æœ‰åˆ†åŒº</h2><h3 id="å‡†å¤‡">å‡†å¤‡</h3><ul><li>å¤‡ä»½æ•°æ®</li></ul><p>è°ƒæ•´åˆ†åŒºå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œå»ºè®®å¤‡ä»½ /home åˆ†åŒºå’Œå…¶ä»–é‡è¦æ•°æ®ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo rsync -aXS /home/ /backup/home/</code></pre> - æŸ¥çœ‹åˆ†åŒºå¸ƒå±€ <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsblksudo fdisk -l</code></pre> çœ‹çœ‹ /home åˆ†åŒºï¼ˆå¦‚/dev/sda6ï¼‰çš„åæ–¹å­˜åœ¨æœªåˆ†é…ç©ºé—´ã€‚ - ç¡®ä¿åˆ†åŒºæœªæŒ‚è½½ï¼š - å¦‚æœ /homeæ˜¯æ´»åŠ¨åˆ†åŒºï¼Œéœ€è¦åœ¨å•ç”¨æˆ·æ¨¡å¼æˆ–é€šè¿‡ Live CD/USB æ‰§è¡Œæ“ä½œã€‚ - åœ¨ Liveç¯å¢ƒä¸­æŒ‚è½½æ ¹åˆ†åŒºï¼Œå¹¶ä½¿ç”¨ chroot è¿›å…¥ç³»ç»Ÿç¯å¢ƒã€‚<p></p><h3 id="å¦‚æœhome-åˆ†åŒºå¦‚-devsda6çš„åæ–¹ä½ç½®å­˜åœ¨æœªåˆ†é…ç©ºé—´">å¦‚æœ/homeåˆ†åŒºï¼ˆå¦‚ /dev/sda6ï¼‰çš„åæ–¹ä½ç½®å­˜åœ¨æœªåˆ†é…ç©ºé—´</h3><p>å› ä¸ºæˆ‘æ˜¯æƒ³åœ¨åœ¨å¦ä¸€ä¸ªç£ç›˜ä¸Šæ‰©å……ï¼Œæ‰€ä»¥åé¢çš„æ–¹æ³•ä¸é€‚ç”¨äºæˆ‘çš„è¿™ä¸ªéœ€æ±‚ï¼Œå¦‚æœæ»¡è¶³æŒ‚è½½/homeçš„åæ–¹è¿˜æœ‰è¿ç»­ç©ºé—´çš„è¯ä¼˜å…ˆæ¨èè¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥æ‰©å®¹/dev/sda6 åˆ†åŒºå¤§å°å³å¯ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š #### ä½¿ç”¨gpartedï¼ˆå›¾å½¢åŒ–ç•Œé¢ï¼‰gparted æ˜¯è°ƒæ•´åˆ†åŒºçš„å›¾å½¢åŒ–å·¥å…·ï¼Œæ“ä½œç®€å•ä¸”æ›´å®‰å…¨ã€‚ -å®‰è£…ï¼š<code>sudo apt install gparted</code> -å¯åŠ¨ï¼š<code>sudo gparted</code> - é€‰æ‹© /dev/sda6 åˆ†åŒºï¼Œå³é”®é€‰æ‹©Resize/Moveã€‚</p><h4 id="ä½¿ç”¨fdisk">ä½¿ç”¨fdisk</h4><ul><li>å¯åŠ¨ fdiskï¼š <code>sudo fdisk /dev/sda</code></li><li>åˆ é™¤å¹¶é‡æ–°åˆ›å»ºåˆ†åŒºï¼š<ul><li>è¾“å…¥ dï¼Œé€‰æ‹© /dev/sda6 åˆ†åŒºã€‚</li><li>è¾“å…¥nï¼Œåˆ›å»ºæ–°åˆ†åŒºï¼Œèµ·å§‹æ‰‡åŒºä¸æ—§åˆ†åŒºç›¸åŒï¼Œç»“æŸæ‰‡åŒºæ‰©å¤§åˆ°æœªåˆ†é…ç©ºé—´æœ«å°¾ã€‚</li><li>è¾“å…¥ w ä¿å­˜æ›´æ”¹ã€‚</li></ul></li><li>åˆ·æ–°åˆ†åŒºè¡¨ï¼š <code>sudo partprobe</code> #### æ‰©å±•æ–‡ä»¶ç³»ç»Ÿåœ¨é‡‡ç”¨ä¸Šé¢çš„æŸä¸€ç§æ–¹å¼åè°ƒæ•´åˆ†åŒºåï¼Œæ–‡ä»¶ç³»ç»Ÿå¤§å°ä»ç„¶æ˜¯åŸæ¥çš„å¤§å°ï¼Œéœ€è¦æ‰©å±•æ–‡ä»¶ç³»ç»Ÿä»¥ä½¿ç”¨æ–°çš„ç©ºé—´ã€‚</li><li>æ‰©å±• ext4 æ–‡ä»¶ç³»ç»Ÿ</li></ul><p>å¦‚æœ /home åˆ†åŒºæ˜¯ ext4ï¼Œä½¿ç”¨ resize2fs æ‰©å±•ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo resize2fs /dev/sda6```   - æ‰©å±• xfs æ–‡ä»¶ç³»ç»Ÿå¦‚æœ /home åˆ†åŒºæ˜¯ xfsï¼Œç¡®ä¿åˆ†åŒºå·²æŒ‚è½½ï¼Œç„¶åä½¿ç”¨ xfs_growfs æ‰©å±•ï¼š```shellsudo mount /dev/sda6 /homesudo xfs_growfs /home</code></pre><p></p><h4 id="éªŒè¯">éªŒè¯</h4><ul><li>æ£€æŸ¥åˆ†åŒºå¤§å°æ˜¯å¦æ‰©å±•æˆåŠŸï¼š<code>df -h /home</code></li><li>ç¡®è®¤åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿå¥åº·çŠ¶æ€ï¼š<code>sudo fsck /dev/sda6</code></li></ul><h3 id="å¦‚æœhome-åˆ†åŒºå¦‚-devsda6çš„åæ–¹ä½ç½®ä¸å­˜åœ¨æœªåˆ†é…ç©ºé—´">å¦‚æœ/homeåˆ†åŒºï¼ˆå¦‚ /dev/sda6ï¼‰çš„åæ–¹ä½ç½®ä¸å­˜åœ¨æœªåˆ†é…ç©ºé—´</h3><p>å¦‚æœåŸæœ‰çš„ç•™ç»™/homeæŒ‚è½½ç‚¹çš„åˆ†åŒºå·²ç»ç©ºé—´ä¸è¶³ä¸”åŸæ¥ç©ºé—´å¾ˆå°ï¼Œå¯ä»¥è€ƒè™‘æ¢ä¸€ä¸ªæ›´å¤§çš„ç¡¬ç›˜ç„¶åå¯¹/homeè¿›è¡Œè¿ç§»ã€‚#### åˆ‡æ¢ç”¨æˆ·å› ä¸ºæˆ‘ä»¬ç°åœ¨è¦æ‰©å……/homeåˆ†åŒºï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootç”¨æˆ·ä¸‹è¿›è¡Œæ“ä½œï¼Œä½¿ç”¨å‘½ä»¤<code>sudo -i</code>åˆ‡æ¢åˆ°rootç”¨æˆ·ã€‚</p><p>å¦å¤–ï¼ŒLiveç¯å¢ƒæˆ–è€…å•ç”¨æˆ·æ¨¡å¼ä¹Ÿéƒ½å¯ä»¥ã€‚</p><h4 id="å‡†å¤‡æ–°åˆ†åŒº">å‡†å¤‡æ–°åˆ†åŒº</h4><ul><li>å¦‚æœæ–°ç¡¬ç›˜è¿˜æ²¡æœ‰æ–°åˆ†åŒºçš„è¯å¯ä»¥æ–°å»ºä¸€ä¸ªåˆ†åŒºï¼š<code>sudo fdisk /dev/nvme1n1</code>,è¾“å…¥næ–°å»ºåˆ†åŒºï¼Œè¾“å…¥wä¿å­˜æ›´æ”¹ã€‚</li><li>æ ¼å¼åŒ–åˆ†åŒºï¼š<code>sudo mkfs.ext4 /dev/nvme1n1p1</code></li><li>æŒ‚è½½åˆ†åŒºï¼š<code>sudo mount /dev/nvme1n1p1 /mnt/new_home</code>,å°†å…¶æŒ‚è½½åˆ°/mnt/new_homeç›®å½•ä¸‹ã€‚ #### è¿ç§»æ•°æ®</li><li>è¿ç§»æ•°æ®ï¼š<code>sudo rsync -aXS /home/ /mnt/new_home/</code><strong>éå¸¸é‡è¦ï¼Œè¿ç§»å®Œæˆåä¸€å®šè¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®æ˜¯å¦å®Œæ•´ï¼Œç¡®è®¤æ— è¯¯åå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</strong>-aï¼šå½’æ¡£æ¨¡å¼ï¼Œä¿ç•™æƒé™ã€æ—¶é—´æˆ³ç­‰ã€‚-Xï¼šä¿ç•™æ‰©å±•å±æ€§ã€‚-Sï¼šå¤„ç†ç¨€ç–æ–‡ä»¶ã€‚</li></ul><h4 id="æ›´æ–°æŒ‚è½½ç‚¹">æ›´æ–°æŒ‚è½½ç‚¹</h4><ul><li>å¸è½½åŸæœ‰ /home åˆ†åŒºï¼š<code>sudo umount /home</code><ul><li>æ­¤æ—¶å¯èƒ½é‡åˆ°/homeå¿™ç¢Œçš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨<code>lsof /home</code>æŸ¥çœ‹ä¸€ä¸‹/homeç›®å½•ä¸‹çš„è¿›ç¨‹ï¼Œä½†æ˜¯å¦‚æœæœ‰ç³»ç»Ÿè¿›ç¨‹çš„è¯å°±æ— æ³•å¸è½½äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯Liveç¯å¢ƒæˆ–è€…å•ç”¨æˆ·æ¨¡å¼æ¯”è¾ƒæ–¹ä¾¿ã€‚</li></ul></li><li>å¦‚æœä¹‹å‰ä¸´æ—¶æŒ‚è½½ç‚¹è®¾ç½®äº†æ°¸ä¹…æŒ‚è½½ï¼Œéœ€è¦å¸è½½ä¸´æ—¶çš„new_homeï¼š<code>sudo umount /mnt/new_home</code>ï¼Œè¿™ä¸ªå¦‚æœä¸å¸è½½çš„è¯ä¼šå¯èƒ½å¯¼è‡´/homeå’Œnew_homeéƒ½åœ¨åŒä¸€ä¸ªåˆ†åŒºä¸‹ï¼Œéå¸¸ä¸å®‰å…¨ã€‚</li><li>æŒ‚è½½æ–°åˆ†åŒºåˆ°/homeï¼š<code>sudo mount /dev/nvme1n1p1 /home</code></li><li>è·å–æ–°åˆ†åŒº UUIDï¼š<code>sudo blkid /dev/nvme1n1p1</code></li><li>æŒä¹…åŒ–æŒ‚è½½ï¼šç¼–è¾‘ /etc/fstabï¼Œæ·»åŠ æ–°åˆ†åŒºçš„ UUID ä¿¡æ¯ã€‚ <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">UUID=xxxx-xxxx-xxxx-xxxx /home ext4 defaults 0 2</code></pre>#### éªŒè¯</li><li>/home åˆ†åŒºæ˜¯å¦æ­£å¸¸æŒ‚è½½ï¼š<code>df -h /home</code> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo mount -adf -h /home</code></pre></li><li>æ—§çš„ä¸´æ—¶ç›®å½•ä¸‹å†…å®¹å’Œæ–°çš„/homeç›®å½•ä¸‹å†…å®¹æ˜¯å¦æ˜¯åœ¨ä¸€ä¸ªåˆ†åŒºä¸‹ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">df /mnt/new_home</code></pre> æ£€æŸ¥æ¸…æ¥šåå¯ä»¥åˆ é™¤/mnt/new_homeç›®å½•ä¸‹çš„å†…å®¹ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ç£ç›˜ </tag>
            
            <tag> æ‰©å®¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python-æ¨¡å—/åŒ…çš„å¯¼å…¥</title>
      <link href="/2024/12/27/python-mo-kuai-bao-de-dao-ru/"/>
      <url>/2024/12/27/python-mo-kuai-bao-de-dao-ru/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¨¡å—moduleå’ŒåŒ…package">æ¨¡å—Moduleå’ŒåŒ…Package</h2><p>åœ¨Pythonä¸­ï¼Œä¸€ä¸ª <strong>.pyæ–‡ä»¶</strong>å°±ç§°ä¹‹ä¸ºä¸€ä¸ªæ¨¡å—ï¼ˆModuleï¼‰ã€‚Moduleçš„ç›®çš„æ˜¯ä»£ç çš„åˆ’åˆ†ã€ç®¡ç†ä»¥åŠä»£ç é‡ç”¨ï¼Œåœ¨ä¸€ä¸ªModuleä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç±»ã€å‡½æ•°ç”šè‡³æ˜¯éœ€è¦é¢„æ‰§è¡Œçš„è„šæœ¬ã€‚æ¨¡å—ä¸€å…±ä¸‰ç§ï¼špythonæ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ã€åº”ç”¨ç¨‹åºè‡ªå®šä¹‰æ¨¡å—ã€‚ç›¸åŒåå­—çš„å‡½æ•°å’Œå˜é‡å®Œå…¨å¯ä»¥åˆ†åˆ«å­˜åœ¨ä¸åŒçš„æ¨¡å—ä¸­ï¼Œä¸å¿…è€ƒè™‘åå­—ä¼šä¸å…¶ä»–æ¨¡å—å†²çªã€‚ä½†æ˜¯<strong>ä¸è¦ä¸å†…ç½®å‡½æ•°åå­—å†²çª</strong>ã€‚</p><p>ç›¸å…³æ¦‚å¿µï¼š -<code>_pycache__</code>ï¼šPython3.2ç‰ˆæœ¬å¼•å…¥çš„ï¼Œç”¨äºå­˜æ”¾æ¨¡å—çš„ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä»¥æé«˜æ¨¡å—çš„åŠ è½½é€Ÿåº¦ã€‚-<code>__init__.py</code>ï¼šæ¨¡å—çš„åˆå§‹åŒ–æ–‡ä»¶ï¼Œå¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥æœ‰ä»£ç ã€‚**å½“ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹æœ‰__init__.pyæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å°±ä¼šè¢«å½“ä½œä¸€ä¸ªåŒ…æ¥å¤„ç†ã€‚**- <code>dir()</code>ï¼šæŸ¥çœ‹æ¨¡å—çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚æ¯”å¦‚ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import mathprint(dir(math))</code></pre> -<code>__name__</code>ï¼šæ¨¡å—çš„å†…ç½®å±æ€§ï¼Œç”¨äºåˆ¤æ–­æ¨¡å—æ˜¯è¢«å¯¼å…¥è¿˜æ˜¯ç›´æ¥å½“ä½œè„šæœ¬æ‰§è¡Œã€‚æ¯”å¦‚ï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python">if __name__ == '__main__':    print('This is a module')</code></pre><p></p><h3 id="æ¨¡å—çš„æŸ¥æ‰¾è·¯å¾„">æ¨¡å—çš„æŸ¥æ‰¾è·¯å¾„</h3><p>åœ¨ Python ä¸­ï¼Œå½“è¿è¡Œä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œæ¨¡å—çš„æŸ¥æ‰¾è·¯å¾„éµå¾ªç‰¹å®šçš„é¡ºåºã€‚è¿™æ˜¯ç”±<code>sys.path</code> åˆ—è¡¨å®šä¹‰çš„ï¼Œè¯¥åˆ—è¡¨æŒ‰é¡ºåºåˆ—å‡ºäº† Pythonåœ¨æŸ¥æ‰¾æ¨¡å—æ—¶ä¼šæœç´¢çš„è·¯å¾„ã€‚</p><p>æ¨¡å—æŸ¥æ‰¾è·¯å¾„çš„é¡ºåº -å½“å‰ç›®å½•ï¼šè¿è¡Œè„šæœ¬æ‰€åœ¨çš„ç›®å½•ã€‚å¦‚æœä½ æ‰§è¡Œäº†ä¸€ä¸ªè„šæœ¬ï¼Œé‚£ä¹ˆ Pythonä¼šé¦–å…ˆå°è¯•ä»è¯¥è„šæœ¬æ‰€åœ¨çš„ç›®å½•åŠ è½½æ¨¡å—ã€‚ - ç¯å¢ƒå˜é‡ PYTHONPATHæŒ‡å®šçš„ç›®å½•ï¼šå¦‚æœè®¾ç½®äº† PYTHONPATHç¯å¢ƒå˜é‡ï¼Œå…¶å€¼ä¸­åˆ—å‡ºçš„ç›®å½•å°†è¢«åŠ å…¥æŸ¥æ‰¾è·¯å¾„ã€‚ - æ ‡å‡†åº“ç›®å½•ï¼šPythonè‡ªå¸¦çš„æ ‡å‡†åº“è·¯å¾„ï¼ˆä¾‹å¦‚ lib æˆ– Lib ç›®å½•ï¼‰ã€‚ - ç¬¬ä¸‰æ–¹åŒ…è·¯å¾„ï¼šé€šå¸¸æ˜¯å®‰è£…åœ¨site-packages ç›®å½•ä¸‹çš„è·¯å¾„ã€‚ - å†…ç½®æ¨¡å—ï¼šå¦‚æœä»¥ä¸Šè·¯å¾„éƒ½æ‰¾ä¸åˆ°ï¼ŒPythonä¼šå°è¯•åŠ è½½å†…ç½®æ¨¡å—ï¼ˆå¦‚ sysã€osï¼‰ã€‚</p><p>ç¤ºä¾‹åŠè¯¦ç»†è§£é‡Š: æ¯”å¦‚ä¸€ä¸ªé¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">project/â”‚â”œâ”€â”€ script.py          # ä¸»è¿è¡Œè„šæœ¬â”œâ”€â”€ module1.py         # è‡ªå®šä¹‰æ¨¡å—â””â”€â”€ subdir/    â”œâ”€â”€ module2.py     # è‡ªå®šä¹‰æ¨¡å—    â””â”€â”€ __init__.py    # å°† subdir æ ‡è®°ä¸ºåŒ…</code></pre><p></p><p>å…¶ä¸­ <code>script.py</code> ä»£ç å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import sysprint("Module search paths:")for path in sys.path:    print(path)import module1         # è‡ªå®šä¹‰æ¨¡å—ï¼Œä½äºå½“å‰ç›®å½•from subdir import module2  # ä»å­ç›®å½•ä¸­å¯¼å…¥æ¨¡å—</code></pre><p></p><p>æ¨¡å—æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š 1. å½“å‰ç›®å½•ï¼š - è¿è¡Œ python script.py æ—¶ï¼ŒPythoné¦–å…ˆæŸ¥çœ‹å½“å‰ç›®å½•ï¼ˆproject/ï¼‰ã€‚ - æ‰¾åˆ° module1.pyï¼Œå¹¶æˆåŠŸå¯¼å…¥ã€‚ 2.å­ç›®å½•å¯¼å…¥ï¼š - å¯¹äº from subdir import module2ï¼ŒPython è¿›å…¥project/subdir/ å¹¶æ‰¾åˆ° module2.pyã€‚ - å› ä¸º subdir åŒ…å«<strong>init</strong>.pyï¼Œå®ƒè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªåŒ…ã€‚ 3. æ ‡å‡†åº“ï¼š -å¦‚æœä½ å°è¯•å¯¼å…¥å¦‚ osã€sys ç­‰æ¨¡å—ï¼ŒPython ä¼šä»æ ‡å‡†åº“è·¯å¾„ä¸­åŠ è½½ã€‚ 4.ç¬¬ä¸‰æ–¹åŒ…ï¼š - å¦‚æœå°è¯•å¯¼å…¥ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ numpyï¼‰ï¼ŒPython ä¼šåœ¨ site-packagesç›®å½•ä¸­æŸ¥æ‰¾ã€‚</p><h3 id="ä¿®æ”¹æ¨¡å—æŸ¥æ‰¾è·¯å¾„">ä¿®æ”¹æ¨¡å—æŸ¥æ‰¾è·¯å¾„</h3><p>å¯ä»¥åŠ¨æ€ä¿®æ”¹ sys.path æ¥å½±å“æ¨¡å—çš„æŸ¥æ‰¾è·¯å¾„ã€‚ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import sysimport os# æŸ¥çœ‹å½“å‰è·¯å¾„print("Before modification:", sys.path)# æ·»åŠ æ–°è·¯å¾„new_path = os.path.join(os.getcwd(), 'subdir')sys.path.insert(0, new_path)print("After modification:", sys.path)# å¯¼å…¥æ¨¡å—import module2</code></pre><p></p><h3 id="ä¸åŒ…packageçš„å…³ç³»">ä¸åŒ…packageçš„å…³ç³»</h3><p>åŒ…æ‰€åœ¨çš„ç›®å½•éœ€è¦åŒ…å«ä¸€ä¸ªç©ºæ–‡ä»¶__init__.pyæ¥è¡¨æ˜è¿™ä¸ªæ˜¯ä¸€ä¸ªåŒ…ï¼Œæ‰€ä»¥è¯´<strong>åŒ…æ˜¯ä¸€ä¸ªåŒ…å«äº†å¤šä¸ªæ¨¡å—çš„ç›®å½•</strong>ã€‚åŒ…çš„ç›®çš„æ˜¯ä¸ºäº†ç»„ç»‡æ¨¡å—ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ä»£ç ã€‚</p><p>åœ¨<code>__init__.py</code>æ–‡ä»¶ä¸­å¯ä»¥å£°æ˜ä¸€äº›æè¿°æ€§çš„ä»£ç æ¥å˜æ›´packageçš„ç‰¹æ€§ã€‚æ¯”å¦‚é’ˆå¯¹import*çš„__all__ï¼Œå¦‚æœæŸä¸ªpackageä¸‹æœ‰ä½ æ˜ç¡®ä¸å¸Œæœ›è¢«å¼•ç”¨çš„pyæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡__all__æ˜ç¡®è¯´æ˜å“ªäº›æ˜¯å¸Œæœ›å¼•å…¥çš„ï¼Œè¿™æ ·åœ¨pythonå¤„ç†import*æ—¶ä¼šå¿½ç•¥æ‰ä¸åœ¨__all__åˆ—è¡¨çš„å†…å®¹ã€‚æ¯”å¦‚ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">__all__ = ['module1', 'module2'] # åªå…è®¸å¯¼å…¥module1å’Œmodule2</code></pre> ### æ¨¡å—çš„å¯¼å…¥#### åŒçº§ç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥å¦‚æœä½ è¦ä½¿ç”¨çš„æ¨¡å—ï¼ˆpyæ–‡ä»¶ï¼‰å’Œå½“å‰æ¨¡å—åœ¨åŒä¸€ç›®å½•ï¼Œåªè¦importç›¸åº”çš„æ–‡ä»¶åå°±å¥½ï¼Œæ¯”å¦‚åœ¨å½“å‰ç›®å½•ä¸‹æœ‰ä¸€ä¸ªmodule1.pyæ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨importmodule1æ¥å¯¼å…¥ã€‚ -<strong>ä¸€ä¸ªæ¨¡å—å¯ä»¥åœ¨å½“å‰ä½ç½®importå¤šæ¬¡ï¼Œä½†æ˜¯åªæœ‰ç¬¬ä¸€æ¬¡å¯¼å…¥ä¼šæ‰§è¡Œå†…å®¹ï¼Œå…¶ä»–çš„éƒ½ä¸ºå¼•ç”¨å†…å­˜</strong>- <strong>æ›´æ”¹è°ƒç”¨åç§°ï¼š<code>import module1 as m1</code></strong> -<strong>åªå¯¼å…¥æ¨¡å—ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼š<code>from module1 import func1</code></strong><p></p><h4 id="ä¸åŒç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥">ä¸åŒç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥</h4><h5 id="å­ç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥">å­ç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥</h5><p>å‡è®¾ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">project/â”œâ”€â”€ main.pyâ”œâ”€â”€ subdir/â”‚   â”œâ”€â”€ module2.pyâ”‚   â””â”€â”€ __init__.py</code></pre> æ–¹æ³•1ï¼šç›´æ¥å¯¼å…¥ï¼ˆå¦‚æœå­ç›®å½•æ˜¯ä¸€ä¸ªåŒ…ï¼‰ å¦‚æœå­ç›®å½•åŒ…å«<code>__init__.py</code> æ–‡ä»¶ï¼ˆå³è¢«è§†ä¸ºåŒ…ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¯¼å…¥ï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyfrom subdir import module2  # å¯¼å…¥å­ç›®å½•ä¸­çš„æ¨¡å—module2.some_function()    # è°ƒç”¨ module2 ä¸­çš„å‡½æ•°</code></pre><p></p><p>æ–¹æ³• 2ï¼šä¿®æ”¹ sys.path å¦‚æœå­ç›®å½•ä¸­æ²¡æœ‰<code>__init__.py</code>ï¼Œæˆ–è€…å¸Œæœ›åœ¨æ²¡æœ‰åŒ…çš„æƒ…å†µä¸‹å¯¼å…¥ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ å­ç›®å½•åˆ°sys.pathï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyimport sysimport os# å°†å­ç›®å½•è·¯å¾„æ·»åŠ åˆ° sys.pathsys.path.append(os.path.join(os.getcwd(), 'subdir'))import module2  # ç°åœ¨å¯ä»¥ç›´æ¥å¯¼å…¥module2.some_function()</code></pre><p></p><h5 id="çˆ¶ç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥">çˆ¶ç›®å½•ä¸‹çš„æ¨¡å—å¯¼å…¥</h5><p>å‡è®¾ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">project/â”œâ”€â”€ parent_module.pyâ””â”€â”€ subdir/    â”œâ”€â”€ main.py    â”œâ”€â”€ module3.py    â””â”€â”€ __init__.py</code></pre> æ–¹æ³• 1ï¼šä½¿ç”¨ sys.path<pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyimport sysimport os# å°†çˆ¶ç›®å½•è·¯å¾„æ·»åŠ åˆ° sys.pathsys.path.append(os.path.dirname(os.getcwd()))import parent_module  # ç°åœ¨å¯ä»¥å¯¼å…¥çˆ¶ç›®å½•çš„æ¨¡å—parent_module.some_function()</code></pre><p></p><p>æ–¹æ³• 2ï¼šç›¸å¯¹å¯¼å…¥ï¼ˆä»…é€‚ç”¨äºåŒ…ç»“æ„ï¼‰</p><p>å¦‚æœ subdir æ˜¯ä¸€ä¸ªåŒ…ï¼ˆåŒ…å«<strong>init</strong>.pyï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ï¼š </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyfrom .. import parent_module  # ç›¸å¯¹å¯¼å…¥çˆ¶ç›®å½•çš„æ¨¡å—parent_module.some_function()</code></pre><strong>æ³¨æ„ï¼šç›¸å¯¹å¯¼å…¥ä»…åœ¨åŒ…ç»“æ„ä¸­æœ‰æ•ˆï¼Œä¸”ä¸èƒ½ç›´æ¥è¿è¡Œè¯¥è„šæœ¬ï¼ˆéœ€è¦é€šè¿‡python -m çš„æ–¹å¼è¿è¡Œï¼‰ã€‚</strong><p></p><h2 id="å…¶ä»–">å…¶ä»–</h2><ol type="1"><li><strong>å½“ä½¿ç”¨ <code>from module import func_b</code>æ—¶ï¼Œæ•´ä¸ªæ¨¡å—ä¼šè¢«åŠ è½½å’Œæ‰§è¡Œä¸€æ¬¡(åŒ…æ‹¬ä¸‹åˆ’çº¿å¼€å¤´çš„ç§æœ‰å¯¹è±¡)ï¼Œä½†åªæœ‰ä½ å¯¼å…¥çš„éƒ¨åˆ†ä¼šè¢«ç»‘å®šåˆ°å½“å‰çš„å‘½åç©ºé—´</strong>ä¾‹å¦‚ï¼š <pre class="line-numbers language-python" data-language="python"><code class="language-python"># module.pyvalue = 1def func_a():    print("Function func_a is being executed")    return 0def func_b():    print("Function func_b is being executed")    b = func_a()    return b</code></pre></li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyfrom module import func_bprint("Calling func_b() in main.py")result = func_b()print(f"Result: {result}")</code></pre><p>æ‰§è¡Œè¿‡ç¨‹ï¼š 1.<br>from module import func_b</p><p>Python ä¼šå…ˆæ‰¾åˆ° module.py æ–‡ä»¶å¹¶åŠ è½½æ•´ä¸ªæ¨¡å—ï¼š - Python ä¼šè§£é‡Šå¹¶æ‰§è¡Œmodule.py æ–‡ä»¶çš„é¡¶å±‚ä»£ç ã€‚ - value = 1 ä¼šè¢«æ‰§è¡Œå¹¶å­˜å‚¨åˆ° moduleçš„å‘½åç©ºé—´ä¸­ã€‚ - å‡½æ•° func_a å’Œ func_b çš„å®šä¹‰ä¼šè¢«åŠ è½½ï¼Œå¹¶ç»‘å®šåˆ° moduleçš„å‘½åç©ºé—´ã€‚ - ç„¶åï¼Œfunc_bä¼šè¢«ç»‘å®šåˆ°å½“å‰æ¨¡å—ï¼ˆmain.pyï¼‰çš„å‘½åç©ºé—´ã€‚</p><p><strong>æ³¨æ„ï¼š</strong> - è™½ç„¶æ•´ä¸ªæ¨¡å—è¢«åŠ è½½ï¼Œä½†åªæœ‰ func_b è¢«ç»‘å®šåˆ°main.py çš„å‘½åç©ºé—´ä¸­ã€‚ - åœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œmoduleçš„é¡¶å±‚ä»£ç ï¼ˆå¦‚èµ‹å€¼è¯­å¥ã€ç±»å®šä¹‰ç­‰ï¼‰éƒ½ä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚</p><ol start="2" type="1"><li>è°ƒç”¨ func_b()</li></ol><ul><li>Python è·³è½¬åˆ° module.py ä¸­ func_bçš„å®šä¹‰ï¼Œå¹¶å¼€å§‹æ‰§è¡Œè¯¥å‡½æ•°çš„å†…å®¹ã€‚</li><li>åœ¨ func_b ä¸­ï¼Œfunc_a è¢«è°ƒç”¨ï¼Œå¯¼è‡´ func_a çš„ä»£ç è¢«æ‰§è¡Œã€‚ å®Œæ•´è¾“å‡ºï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Calling func_b() in main.pyFunction func_b is being executedFunction func_a is being executedResult: 0</code></pre></li></ul><ol start="2" type="1"><li><strong><strong>init</strong>.pyæ–‡ä»¶çš„çš„è§„èŒƒ</strong>åŠ å…¥å­˜åœ¨ä»¥ä¸‹ç›®å½•ç»“æ„ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">project/â”œâ”€â”€ my_package/â”‚   â”œâ”€â”€ module1.pyâ”‚   â”œâ”€â”€ module2.pyâ”‚   â””â”€â”€ __init__.pyâ””â”€â”€ main.py</code></pre> <code>__init__.py</code>æ–‡ä»¶çš„ä¸€äº›å†™æ³•çš„è§£é‡Šï¼š</li></ol><ul><li>ç©ºï¼šä»…æ ‡è®°ä¸ºåŒ…ï¼Œå¯¼å…¥éœ€è¦æ˜¾å¼åœ°æŒ‡æ˜æ¨¡å—å’Œå†…å®¹ã€‚æ‰€ä»¥ä½¿ç”¨æ—¶ä¹Ÿæ˜¯<code>import my_package.module1</code>ï¼Œæœ¬è´¨ä¸Šæ˜¯æ¨¡å—ï¼ŒåŒ…ä¸­çš„å®šä¹‰çš„__all__åˆ—è¡¨ä¸ä¼šç”Ÿæ•ˆã€‚</li><li><code>from . import module2</code>:å¯¼å…¥å®Œæ•´æ¨¡å—åˆ°åŒ…å‘½åç©ºé—´ï¼Œä½¿ç”¨æ—¶éœ€é€šè¿‡æ¨¡å—åè®¿é—®ï¼Œæœ¬è´¨ä¸Šæ˜¯æ¨¡å—ï¼ŒåŒ…ä¸­çš„å®šä¹‰çš„__all__åˆ—è¡¨ä¸ä¼šç”Ÿæ•ˆã€‚</li><li><code>from my_package import *</code>:å¯¼å…¥å®Œæ•´æ¨¡å—åˆ°åŒ…å‘½åç©ºé—´ï¼Œä½¿ç”¨æ—¶æ— éœ€æ¨¡å—åè®¿é—®ï¼Œ</li><li><code>from .module2 import *</code>:å°†æ•´ä¸ªæ¨¡å—å†…å®¹å¯¼å…¥åˆ°åŒ…å‘½åç©ºé—´ï¼Œä½¿ç”¨æ—¶æ— éœ€æ¨¡å—åã€‚</li><li><code>from my_package.module2 import *</code>:å°†æ•´ä¸ªæ¨¡å—å†…å®¹å¯¼å…¥åˆ°åŒ…å‘½åç©ºé—´ï¼Œä½¿ç”¨æ—¶æ— éœ€æ¨¡å—åã€‚</li><li><code>from module2 import *</code>:è¿™æ˜¯ç§é”™è¯¯å†™æ³•ï¼Œæ— æ³•æ‰¾åˆ°æ¨¡å—ã€‚</li></ul><ol start="3" type="1"><li><code>__all__</code>åœ¨<code>__init__.py</code>ä¸­çš„ä½œç”¨ï¼š</li></ol><ul><li>å½“ä½ ä½¿ç”¨ from my_package import * æ—¶ï¼Œ<code>__all__</code>å®šä¹‰äº†å“ªäº›åç§°ä¼šè¢«å¯¼å…¥åˆ°å½“å‰å‘½åç©ºé—´ã€‚</li><li>å¦‚æœ__all__æ²¡æœ‰å®šä¹‰ï¼Œé‚£ä¹ˆé»˜è®¤ä¼šå¯¼å…¥æ‰€æœ‰éä»¥ä¸‹åˆ’çº¿ _å¼€å¤´çš„å¯¹è±¡ã€‚</li></ul><p>è°ƒç”¨æ—¶çš„åŒºåˆ«ï¼š - å¦‚æœåœ¨ <code>main.py</code> ä¸­éœ€è¦å†™æ¨¡å—åï¼ˆä¾‹å¦‚my_package.module2.func2()ï¼‰ï¼Œé‚£ä¹ˆ<code>__all__</code>ä¸ä¼šé™åˆ¶æ¨¡å—ä¸­çš„å†…å®¹ã€‚ - <code>__all__</code> åªåœ¨from my_package import * æ—¶ç”Ÿæ•ˆï¼Œè€Œä¸ä¼šå½±å“æ˜¾å¼å¯¼å…¥ ä¾‹å¦‚ï¼š ç›®å½•ç»“æ„ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">my_package/â”œâ”€â”€ __init__.pyâ”œâ”€â”€ module1.pyâ”œâ”€â”€ module2.py # åŒ…å« func2 å‡½æ•°</code></pre> <pre class="line-numbers language-python" data-language="python"><code class="language-python">#__init__.pyï¼šfrom .module2 import *__all__ = []  # ä¸å¯¹å¤–æš´éœ²ä»»ä½•å†…å®¹</code></pre> <pre class="line-numbers language-python" data-language="python"><code class="language-python"># main.pyfrom my_package import *func2()  # æŠ¥é”™ï¼Œå› ä¸º __all__=[] é™åˆ¶äº†å¯¼å‡ºçš„å†…å®¹from my_package.module2 import func2 func2()  # æ­£å¸¸è¿è¡Œfrom my_package import func2func2()  # æ­£å¸¸è¿è¡Œï¼Œ æ¯”è¾ƒå¥‡æ€ªå“ˆï¼Œä½†æ˜¯æµ‹è¯•äº†è¿™æ ·å­æ˜¯å¯ä»¥çš„</code></pre><p></p><ol start="4" type="1"><li><strong>é€šè¿‡<code>-m</code>è¿è¡Œä¸€ä¸ªæ¨¡å—</strong>å¯¹äºä¸€äº›é¡¹ç›®ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦é€šè¿‡å‘½ä»¤è¡Œæ¥è¿è¡Œä¸€ä¸ªæ¨¡å—ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>-m</code>å‚æ•°ï¼Œä»¥æ”¯æŒæ¨¡å—çš„ç›¸å¯¹å¯¼å…¥ã€‚<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">project/â”œâ”€â”€ my_package/â”‚   â”œâ”€â”€ module1.pyâ”‚   â”œâ”€â”€ module2.pyâ”‚   â””â”€â”€ __init__.pyâ””â”€â”€ subdir/    â”œâ”€â”€ module3.py    â””â”€â”€ __init__.py</code></pre> å¯¹äºmoulde3.pyä¸­çš„å†…å®¹ï¼Œå¦‚æœå†™æˆï¼š <pre class="line-numbers language-python" data-language="python"><code class="language-python">from my_package import func1 # module1.pyä¸­çš„å‡½æ•° func1()</code></pre>éœ€è¦é€šè¿‡<code>-m</code>å‚æ•°æ¥è¿è¡Œï¼š<code>python -m subdir.module3</code>ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®å¯¼å…¥my_packageä¸­çš„å†…å®¹ã€‚</li></ol><p>å‚è€ƒï¼š &gt;https://blog.csdn.net/Uncle_GUO/article/details/80867086</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> ImportError </tag>
            
            <tag> pythonæ¨¡å— </tag>
            
            <tag> pythonåŒ… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¥½ç”¨çš„å¤§æ¨¡å‹promptåˆ†äº«</title>
      <link href="/2024/12/21/hao-yong-de-da-mo-xing-prompt-fen-xiang/"/>
      <url>/2024/12/21/hao-yong-de-da-mo-xing-prompt-fen-xiang/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸­æ–‡å†™ä½œ">ä¸­æ–‡å†™ä½œ</h1><h2 id="æ¶¦è‰²">æ¶¦è‰²</h2><pre class="line-numbers language-none"><code class="language-none">ä½œä¸ºä¸€åä¸­æ–‡å­¦æœ¯è®ºæ–‡å†™ä½œæ”¹è¿›åŠ©ç†ï¼Œè¯·ç”¨å­¦æœ¯åŒ–çš„è¯­è¨€é‡å†™ä»¥ä¸‹å¥å­ï¼Œè¯·åˆ†æ¡é˜è¿°ï¼Œä½ çš„ä»»åŠ¡æ˜¯æ”¹è¿›æ‰€æä¾›æ–‡æœ¬çš„æ‹¼å†™ã€è¯­æ³•ã€æ¸…æ™°ã€ç®€æ´å’Œæ•´ä½“å¯è¯»æ€§ï¼ŒåŒæ—¶åˆ†è§£é•¿å¥ï¼Œå‡å°‘é‡å¤ï¼Œå¹¶æä¾›æ”¹è¿›å»ºè®®ã€‚è¯·åªæä¾›æ–‡æœ¬çš„æ›´æ­£ç‰ˆæœ¬ï¼Œé¿å…åŒ…æ‹¬è§£é‡Šã€‚ä¸”è¦æ±‚é‡æ–°ç»„ç»‡æ®µè½ä¸­çš„å¥å­ï¼Œä½¿å…¶å…·æœ‰é€»è¾‘æ€§ï¼Œå¹¶åˆ†æ¡é˜è¿°ã€‚è¯·ç¼–è¾‘ä»¥ä¸‹æ–‡æœ¬ï¼š</code></pre><h2 id="æ ¡å¯¹ä¸å®Œå–„">æ ¡å¯¹ä¸å®Œå–„</h2><pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯ä¸€ä½ä¸“æ³¨äºå­¦æœ¯å†™ä½œçš„æ ¡å®¡ä¸“å®¶ã€‚ä½ çš„ä¸»è¦å·¥ä½œæ˜¯æ£€æŸ¥å’Œä¿®æ”¹ä¸€ç¯‡é¢˜ä¸ºâ€œ[PAPER TITLE]â€çš„è®ºæ–‡æ®µè½ï¼Œç›®æ ‡æ˜¯è®©è®ºæ–‡çš„è¡¨è¾¾æ›´åŠ æ¸…æ™°ã€æ¡ç†æ¸…æ¥šã€‚æ‰¾å‡ºæ‰€æœ‰ä¸æ˜ç¡®ã€å¤æ‚æˆ–å†—ä½™çš„å¥å­æˆ–çŸ­è¯­ï¼Œå¹¶æä¾›æ›´åŠ ç²¾ç¡®å’Œç®€æ´çš„é€‰æ‹©æ–¹æ¡ˆã€‚ç‰¹åˆ«æ³¨æ„æ–‡ç« çš„é€»è¾‘æµåŠ¨ï¼Œç¡®ä¿æ¯ä¸ªå¥å­éƒ½èƒ½æœ‰æ•ˆæ”¯æŒä¸»æ—¨æˆ–å™è¿°ã€‚å…¨æ–‡è¦ä¿æŒæœ¯è¯­ã€é£æ ¼å’Œè¯­è°ƒçš„ç»Ÿä¸€ã€‚å¯¹äºå¯èƒ½éœ€è¦å¯¹é¢„æœŸè¯»è€…è¿›è¡Œè¯´æ˜çš„è¡Œä¸šæœ¯è¯­æˆ–ä¸“ä¸šè¯æ±‡ï¼Œè¦ç»™å‡ºæ¸…æ™°çš„è§£é‡Šã€‚å®Œæˆæ ¡å®¡åï¼Œç¡®ä¿è¯¥æ®µè½ç¬¦åˆå­¦æœ¯è§„èŒƒï¼Œä½¿å¾—è®ºæ–‡æ•´ä½“ä¸Šæ›´åŠ æ˜“è¯»ï¼Œä»è€Œæé«˜å…¶å½±å“åŠ›ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šé€ä¸ªç»™ä½ å±•ç¤ºè¿™ç¯‡è®ºæ–‡çš„æ®µè½ï¼Œä½ éœ€è¦æ ¹æ®ä¸Šè¿°è¦æ±‚å¯¹æ¯ä¸ªæ®µè½è¿›è¡Œæ ¡å®¡ï¼Œæ³¨æ„ä½ è¦ä¿ç•™åŸæœ‰çš„å¼•ç”¨ã€‚è¯·åœ¨æ¯ä¸ªæ®µè½çš„ä¸‹æ–¹å†™ä¸‹ä½ çš„ä¿®æ”¹å»ºè®®ã€‚</code></pre><h2 id="å…¬å¼åˆ†æç”Ÿæˆ">å…¬å¼åˆ†æç”Ÿæˆ</h2><pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯ä¸€åå­¦æœ¯ç ”ç©¶è€…ï¼Œè¯·ä½¿ç”¨å­¦æœ¯åŒ–çš„ç”¨è¯­ï¼Œå°½é‡ä½¿ç”¨æ•°å­¦å…¬å¼è¡¨è¾¾ï¼Œè¯·å¸®æˆ‘åˆ†æä»¥ä¸‹å…¬å¼å…·æœ‰ä»€ä¹ˆæ€§è´¨ï¼Œæœ‰ä»€ä¹ˆæ·±å…¥æ¨å¯¼ã€‚è¯·ä¸€æ­¥ä¸€æ­¥é˜è¿°ï¼š</code></pre><h2 id="æ”¹å†™æŸ¥é‡åç”¨">æ”¹å†™ï¼ˆæŸ¥é‡åç”¨ï¼‰</h2><ul><li>ç¤ºä¾‹ä¸€ï¼š <pre class="line-numbers language-none"><code class="language-none">1.å‡è®¾ä½ æ˜¯ä¸€ä¸ªè®ºæ–‡æ¶¦è‰²å†™ä½œå‘˜ï¼Œå…·æœ‰å­¦æœ¯ç ”ç©¶ç›¸å…³çŸ¥è¯†ã€‚è¯·ç»™æ”¹å†™ä»¥ä¸‹æ–‡æ®µï¼Œè¦æ±‚ç»™å‡ºçš„æ–‡æ®µä¸åŸæ–‡æ®µé‡å¤ç‡ä½äº10%ï¼Œè¦æ±‚æ–°æ–‡æ®µçš„ä»»æ„è¿ç»­40ä¸ªå­—ä¸åŸæ–‡æ®µä¸­ä»»æ„è¿ç»­40ä¸ªå­—ä¸­é‡å¤çš„å­—å°äº5ä¸ªã€‚è¦æ±‚å°½å¯èƒ½æ›¿æ¢æ–‡æ®µä¸­è¯æ±‡ä½¿å…¶æ›´ç¬¦åˆå­¦æœ¯è®ºæ–‡è¡¨è¾¾ï¼Œè¦æ±‚å°½å¯èƒ½æ›´æ¢è¯´æ³•é¿å…ä¸åŸæ–‡æ®µçš„é‡å¤ä½†æ˜¯è¦ä¿ç•™åŸæ–‡æ®µçš„å«ä¹‰ï¼Œå…è®¸é‡æ–°ç»„ç»‡å¥å­é¡ºåºã€è¯è¯­é¡ºåºã€æ®µè½é¡ºåºï¼Œå…è®¸æ”¹å†™æ—¶å¯¹å¥å­æ‰©å†™æˆ–ç¼©å‡ã€‚è¯·ç»™å‡ºæ”¹å®Œåçš„æ–‡æ®µã€ç»™å‡ºä¸åŸæ–‡æ®µçš„å¯¹æ¯”ï¼Œè¯·ä¸€æ­¥ä¸€æ­¥é˜è¿°ã€‚æ–‡æ®µå¦‚ä¸‹ï¼š</code></pre></li><li>ç¤ºä¾‹äºŒï¼š <pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯ç ”ç©¶è€…ï¼Œæ­£åœ¨æ’°å†™æ¯•ä¸šè®ºæ–‡ï¼Œå…·æœ‰å­¦æœ¯ç ”ç©¶ç›¸å…³çŸ¥è¯†ã€‚è¯·ç®€è¦æ€»ç»“ä»¥ä¸‹æ–‡æ®µçš„ä¸»è¦å†…å®¹è§‚ç‚¹ï¼Œå¹¶æŒ‰æ¡ç›®è¾“å‡ºï¼Œå†æ ¹æ®æ¯æ¡æ€»ç»“æ‰©å†™å¥å­ï¼Œæœ€åç»„åˆæˆæ–°æ–‡æ®µï¼Œè¦æ±‚ç»™å‡ºçš„æ–‡æ®µä¸åŸæ–‡æ®µé‡å¤ç‡ä½äº5%ï¼Œè¦æ±‚è¾“å‡ºçš„æ–°æ–‡æ®µä¸­ä»»æ„æŠ½å–è¿ç»­40ä¸ªå­—ä¸åŸæ–‡æ®µä¸­ä»»æ„è¿ç»­40ä¸ªå­—æ¯”è¾ƒï¼Œé‡å¤çš„å­—å°äº5ä¸ªã€‚å…è®¸é‡æ–°ç»„ç»‡å¥å­é¡ºåºã€è¯è¯­é¡ºåºã€æ®µè½é¡ºåºï¼Œå…è®¸æ”¹å†™æ—¶å¯¹å¥å­æ‰©å†™æˆ–ç¼©å‡ã€‚è¯·ç»™å‡ºæ”¹å®Œåçš„æ–‡æ®µã€ç»™å‡ºä¸åŸæ–‡æ®µçš„å¯¹æ¯”ï¼Œè¯·ä¸€æ­¥ä¸€æ­¥é˜è¿°ã€‚æ–‡æ®µå¦‚ä¸‹ï¼š</code></pre> ## ç»¼è¿°ååŠ©</li><li>å…¨èŒç‰ˆ <pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯æ­£åœ¨å¯¹æŸä¸€å­¦æœ¯é¢†åŸŸçš„[RESEARCH TOPIC]è¿›è¡Œæ·±å…¥ç ”ç©¶çš„ç ”ç©¶è€…ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»å¹¿æ³›çš„æ–‡çŒ®ä¸­è¯†åˆ«ã€åˆ†æå’Œç»¼åˆå…³é”®çš„å‘ç°ã€ç†è®ºå’Œç ”ç©¶æ–¹æ³•ã€‚é¦–å…ˆï¼Œç¡®å®šä¸€ä¸ªç®€å•çš„ç ”ç©¶é—®é¢˜æˆ–è®ºç‚¹ï¼Œä»¥æ­¤ä¸ºåŸºç¡€æŒ‡å¯¼ä½ çš„æ–‡çŒ®å›é¡¾ã€‚å¯»æ‰¾ç›¸å…³çš„å­¦æœ¯æœŸåˆŠã€ä¼šè®®è®ºæ–‡ã€ä¹¦ç±ä»¥åŠå¯é çš„ç½‘ç»œèµ„æºã€‚å¯¹æ¯é¡¹èµ„æºçš„å¯ä¿¡åº¦ã€ç›¸å…³æ€§å’Œå¯¹é¢†åŸŸè´¡çŒ®è¿›è¡Œè¯„ä¼°ã€‚æ‘˜è¦æ¯ä¸ªèµ„æºçš„ä¸»è¦è®ºç‚¹ã€è¯æ®å’Œç»“è®ºï¼Œæ³¨æ„è§‚å¯Ÿæ–‡çŒ®ä¸­çš„ä¸€è‡´æ€§ã€å·®å¼‚æˆ–ç©ºç¼ºã€‚æ‰¹åˆ¤æ€§åœ°å®¡è§†æ‰€ç ”ç©¶çš„æ–¹æ³•ã€å…¶å±€é™æ€§åŠå…¶å‘ç°çš„æ„ä¹‰ã€‚æ ¹æ®ä¸»é¢˜æˆ–æ—¶é—´é¡ºåºå®‰æ’æ–‡çŒ®ç»¼è¿°ï¼Œç¡®ä¿é€»è¾‘è¿è´¯ï¼Œå›´ç»•ç ”ç©¶ä¸»é¢˜æ„å»ºå‡ºä¸€ç¯‡æœ‰æ¡ç†çš„ç»¼è¿°æ–‡ç« ã€‚æœ€åï¼Œå¼ºè°ƒä½ çš„ç ”ç©¶æ˜¯å¦‚ä½•å¡«è¡¥å·²è¯†åˆ«çš„ç©ºç™½æˆ–å¯¹è¯¥å­¦ç§‘é¢†åŸŸæä¾›æ–°è§è§£çš„ã€‚ç¡®ä¿ä½ çš„æ–‡çŒ®ç»¼è¿°éµå¾ªæ‰€åœ¨æœºæ„è¦æ±‚çš„å¼•ç”¨é£æ ¼å’Œå­¦æœ¯å†™ä½œæ ‡å‡†ã€‚</code></pre></li><li>æ¶¦è‰²ç‰ˆ <pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯æ­£åœ¨å¯¹æŸä¸€å­¦æœ¯é¢†åŸŸçš„[RESEARCH TOPIC]è¿›è¡Œæ·±å…¥ç ”ç©¶çš„ç ”ç©¶è€…ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æˆ‘ç»™ä½ çš„ç›¸å…³æ®µè½è¿›è¡Œå®Œå–„ä¸å±•å¼€ã€‚ä½ éœ€è¦æ‰¹åˆ¤æ€§åœ°å®¡è§†æ‰€ç ”ç©¶çš„æ–¹æ³•ã€å…¶å±€é™æ€§åŠå…¶å‘ç°çš„æ„ä¹‰ï¼Œç¡®ä¿é€»è¾‘è¿è´¯ï¼Œä¿æŒæœ¯è¯­ã€é£æ ¼å’Œè¯­è°ƒçš„ç»Ÿä¸€ã€‚å¯¹äºå¯èƒ½éœ€è¦å¯¹é¢„æœŸè¯»è€…è¿›è¡Œè¯´æ˜çš„è¡Œä¸šæœ¯è¯­æˆ–ä¸“ä¸šè¯æ±‡ï¼Œè¦ç»™å‡ºæ¸…æ™°çš„è§£é‡Šã€‚</code></pre></li></ul><h1 id="è‹±æ–‡å†™ä½œ">è‹±æ–‡å†™ä½œ</h1><h2 id="ä¸­ç¿»è‹±">ä¸­ç¿»è‹±</h2><pre class="line-numbers language-none"><code class="language-none">å‡è®¾ä½ æ˜¯ä¸€åç¾å¼è‹±è¯­ä¸ºæ¯è¯­çš„ç¿»è¯‘å‘˜ï¼ŒåŒæ—¶ä½ è¿˜æ˜¯ä¸€åç†å­¦çš„å­¦æœ¯ç ”ç©¶è€…ï¼Œä½ çš„ä»»åŠ¡æ˜¯å°†ä»¥ä¸‹ä¸­æ–‡å­¦æœ¯è®ºæ–‡æ®µè½ç¿»è¯‘ä¸ºè‹±æ–‡ã€‚è¦æ±‚ä¸¥æ ¼ä¿æŒè¯­æ³•æ­£ç¡®ï¼Œè¦æ±‚è‹±æ–‡è¯è¯­æ‹¼å†™æ­£ç¡®ï¼Œè¦æ±‚å•å¤æ•°ä½¿ç”¨æ­£ç¡®ï¼Œè¦æ±‚é‡‡ç”¨å­¦æœ¯çš„è¡¨è¾¾ï¼Œä¸ä½¿ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼Œå‚è€ƒå…¶ä»–ç±»ä¼¼æ–‡çŒ®ä¸­çš„å¥å­å’Œæ®µè½ç»“æ„ï¼Œå‚è€ƒå…¶ä»–ç±»ä¼¼æ–‡çŒ®ä¸­çš„ä¸“æœ‰åè¯å’Œä¹ æƒ¯ç”¨è¯ï¼Œå¯ä»¥æ ¹æ®å¥å­å†…å®¹æ‰©å±•æ·»åŠ è¯æ±‡ä½¿å¥å­ç»“æ„å®Œæ•´ï¼Œå¯ä»¥æ ¹æ®å¥å­å†…å®¹è°ƒæ•´å¥å­çš„å…ˆåä½ç½®ã€‚æœ€åæä¾›æœ€åç¿»è¯‘å®Œçš„è‹±æ–‡æ–‡æ®µä»¥åŠè°ƒæ•´åçš„ä¸­æ–‡æ–‡æ®µï¼ŒåŒæ—¶å±•ç¤ºè°ƒæ•´åçš„ä¸­æ–‡æ–‡æ®µä¸åŸæ–‡æ®µå¯¹æ¯”åœ¨å“ªäº›ä½ç½®åšäº†ä¿®æ”¹ã€‚è¯·ä¸€æ­¥ä¸€æ­¥é˜è¿°ã€‚è¯·ç¿»è¯‘ä»¥ä¸‹æ–‡æ®µï¼š</code></pre><blockquote><p>https://domyweb.org/chatgpt/#act-as-an-essay-writer</p></blockquote><blockquote><p>https://zhuanlan.zhihu.com/p/654520254</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Prompt </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> Prompt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨å®‡å®™æœ€å¼ºç¼–è¾‘å™¨ä¸Šä½¿ç”¨latex</title>
      <link href="/2024/12/18/zai-yu-zhou-zui-qiang-bian-ji-qi-shang-shi-yong-latex/"/>
      <url>/2024/12/18/zai-yu-zhou-zui-qiang-bian-ji-qi-shang-shi-yong-latex/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…å‡†å¤‡">å®‰è£…å‡†å¤‡</h2><ul><li>TeXLive / MacTeX / MiKTeXç­‰LaTeXå‘è¡Œç‰ˆ</li><li>VSCode</li></ul><h2 id="vscode-é…ç½®">Vscode é…ç½®</h2><h3 id="å®‰è£…æ’ä»¶">å®‰è£…æ’ä»¶ï¼š</h3><ul><li><p>LaTeX Workshop ï¼ˆå¿…è£…ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241218201018.png">LaTeX Workshop æ”¯æŒ LaTeX çš„ç¼–è¯‘ã€é¢„è§ˆã€è¯­æ³•æ£€æŸ¥ç­‰åŠŸèƒ½ã€‚</p></li><li><p>English Word Hint</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241218201116.png">English Word Hintæ˜¯ä¸€ä¸ªè‹±è¯­å•è¯æç¤ºæ’ä»¶ï¼Œå¯ä»¥åœ¨ç¼–å†™è‹±è¯­æ–‡æ¡£æ—¶ï¼Œè‡ªåŠ¨æç¤ºç›¸å…³è‹±è¯­å•è¯ï¼Œå¹¶æ˜¾ç¤ºå¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘ï¼Œæé«˜è‹±æ–‡æ–‡æ¡£ç¼–å†™æ•ˆç‡ã€‚</p></li><li><p>Path Auto Complete</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241218201156.png">Path Auto Complete å¯ä»¥è‡ªåŠ¨è¡¥å…¨è·¯å¾„ï¼Œæ–¹ä¾¿å¿«é€Ÿæ’å…¥å›¾ç‰‡ã€‚</p></li><li><p>indent rainbow</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241218201245.png">indent rainbow å¯ä»¥ä¸ºä¸åŒå±‚çº§çš„ç¼©è¿›æ·»åŠ ä¸åŒçš„é¢œè‰²ï¼Œæ–¹ä¾¿é˜…è¯»ã€‚</p></li><li><p>Word Count CJK</p><p>Word Count CJK å¯ä»¥ç»Ÿè®¡ä¸­æ–‡æ–‡æ¡£çš„å­—æ•°ã€‚</p></li><li><p>Material Icon Theme</p><p>Material Icon Themeå¯ä»¥ä¸ºä¸åŒç±»å‹çš„æ–‡ä»¶æ·»åŠ ä¸åŒçš„å›¾æ ‡ï¼Œæ–¹ä¾¿åŒºåˆ†ã€‚</p></li></ul><h3 id="latex-workshop-é…ç½®">LaTeX Workshop é…ç½®</h3><h4 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json">// é¼ æ ‡æ‚¬åœï¼Œé¢„è§ˆå…¬å¼æ—¶ï¼Œæ”¯æŒ boldsymbol å®"latex-workshop.hover.preview.mathjax.extensions": [    "boldsymbol"],// æ˜¯å¦å¯ç”¨ IntelliSenseï¼Œè‡ªåŠ¨è¡¥å…¨å¼•ç”¨çš„åŒ…ä¸­çš„ç¯å¢ƒå’Œå‘½ä»¤"latex-workshop.intellisense.package.enabled": true,// ç¼–è¯‘åçš„æ–‡ä»¶è¾“å‡ºç›®å½•"latex-workshop.latex.outDir": "./tmp",// é»˜è®¤ç¼–è¯‘å¼•æ“ä¸ºä¸Šæ¬¡ä½¿ç”¨çš„"latex-workshop.latex.recipe.default": "lastUsed",// é¢„è§ˆå¤æ‚å…¬å¼ï¼Œä½¿ç”¨æ—¶éœ€è¦é€šè¿‡ command palette (å‘½ä»¤é¢æ¿) æ‰“å¼€"latex-workshop.mathpreviewpanel.cursor.enabled": true,// ä¸å…è®¸å¼¹çª—æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯"latex-workshop.message.error.show": false,// ä¸å…è®¸å¼¹çª—æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯"latex-workshop.message.warning.show": false,// é¢„è§ˆ PDF æ—¶ï¼Œåè½¬é¢œè‰²"latex-workshop.view.pdf.invert": 1,// é¢„è§ˆ PDF æ—¶ï¼Œè‡ªåŠ¨æ£€æµ‹æ˜¯å¦éœ€è¦åè½¬é¢œè‰²"latex-workshop.view.pdf.invertMode.enabled": "auto",</code></pre><h4 id="ç¼–è¯‘å·¥å…·é“¾é…ç½®">ç¼–è¯‘å·¥å…·é“¾é…ç½®</h4><p>æ¨èä½¿ç”¨ latexmk è¿›è¡Œç¼–è¯‘ï¼Œlatexmkå¯ä»¥è‡ªåŠ¨æ£€æµ‹æ–‡æ¡£ä¸­çš„å˜åŒ–ï¼Œè‡ªåŠ¨è¿›è¡Œç¼–è¯‘ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒå¤šç§ç¼–è¯‘å¼•æ“ï¼ŒåŒ…æ‹¬XeLaTeXã€PdfLaTeXã€‚</p><p>åœ¨ settings.json æ–‡ä»¶ä¸­æ‰¾åˆ° latex-workshop.latex.tools å’Œlatex-workshop.latex.recipes é…ç½®é¡¹ï¼Œå°†å…¶å…¨éƒ¨åˆ é™¤ï¼Œå¹¶ä¿®æ”¹ä¸ºå¦‚ä¸‹é…ç½®</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">"latex-workshop.latex.recipes": [    {        "name": "XeLaTeX",        "tools": [            "xelatexmk"        ]    },    {        "name": "PdfLaTeX",        "tools": [            "pdflatexmk"        ]    }],"latex-workshop.latex.tools": [    {        "args": [            "-synctex=1",            "-pdfxe",            "-interaction=nonstopmode",            "-file-line-error",            "-outdir=%OUTDIR%",            "%DOC%"        ],        "command": "latexmk",        "env": {},        "name": "xelatexmk"    },    {        "args": [            "-synctex=1",            "-pdf",            "-interaction=nonstopmode",            "-file-line-error",            "-outdir=%OUTDIR%",            "%DOC%"        ],        "command": "latexmk",        "env": {},        "name": "pdflatexmk"    }],</code></pre><h4 id="é¢„è§ˆä¸åŒæ­¥tex">é¢„è§ˆä¸åŒæ­¥TeX</h4><p>https://github.com/James-Yu/LaTeX-Workshop/wiki/View#internal-pdf-viewerï¼Œå®˜ç½‘ä¸Šæœ‰è¯¦ç»†é…ç½®è¯´æ˜ï¼Œè¿™é‡Œç®€å•ä»‹ç»é€šè¿‡å†…ç½®çš„pdfé¢„è§ˆå™¨çš„å‰å‘ä¸åå‘æœç´¢çš„å¿«æ·é”®ï¼š- Forward/Direct search:åœ¨ç¼–è¾‘å™¨ä¸­ç‚¹å‡»æŸä¸ªä½ç½®ï¼Œwindowé€šè¿‡<code>ctrl+alt+j</code>è·³è½¬ï¼Œmacé€šè¿‡<code>cmd+option+j</code> è·³è½¬ã€‚</p><ul><li>Backward/Inverse search: ä½¿ç”¨å†…éƒ¨æŸ¥çœ‹å™¨æ—¶ï¼ŒæŒ‡å‘ pdfé¢„è§ˆä¸­çš„å…ƒç´ çš„é»˜è®¤é”®ç»‘å®šæ˜¯ <code>ctrl+click</code>ã€‚å¯ä»¥ä½¿ç”¨è®¾ç½®<code>latex-workshop.view.pdf.internal.synctex.keybinding</code>å°†å…¶æ›´æ”¹ä¸º<code>double-click</code> ã€‚ <pre class="line-numbers language-json" data-language="json"><code class="language-json">"latex-workshop.view.pdf.internal.synctex.keybinding": "double-click"</code></pre></li></ul><p>å‚è€ƒï¼š</p><blockquote><p>åœ¨ VSCode ä¸­é…ç½® LaTeX ç¯å¢ƒhttps://github.com/shinyypig/latex-vscode-config</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Latex </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Latex </tag>
            
            <tag> VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥æœ¬-æ¶ˆå¤±çš„ä¸‰åå¹´-å¯ç¤ºä¸å€Ÿé‰´</title>
      <link href="/2024/12/10/ri-ben-xiao-shi-de-san-shi-nian-qi-shi-yu-jie-jian/"/>
      <url>/2024/12/10/ri-ben-xiao-shi-de-san-shi-nian-qi-shi-yu-jie-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="äºŒæˆ˜åæ—¥æœ¬ç»æµå¥‡è¿¹">äºŒæˆ˜åæ—¥æœ¬ç»æµå¥‡è¿¹</h2><p>äºŒæˆ˜åï¼Œä¸–ç•Œè¿æ¥äº†å†·æˆ˜æ—¶æœŸï¼Œæ—¥æœ¬ä½œä¸ºç¾å›½æŠµå¾¡è‹è”å½±å“çš„æ¡¥å¤´å ¡ï¼Œå› æ­¤å—åˆ°äº†ç¾å›½æå¤§çš„ç»æµæ´åŠ©ã€‚</p><p>ç¾å›½è®¤ä¸ºï¼Œç»æµå‘å±•ä¸ä»…å¯ä»¥é˜²æ­¢æ—¥æœ¬å†æ¬¡å‡ºç°å†›å›½ä¸»ä¹‰ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢å…±äº§ä¸»ä¹‰ã€‚</p><p>1950å¹´ï¼Œç”±äºæœé²œæˆ˜äº‰çš„çˆ†å‘ï¼Œæ—¥æœ¬æˆä¸ºç¾å†›å†›éœ€ç”Ÿäº§å’Œç»´ä¿®çš„åŸºåœ°ï¼Œç¾å›½æ”¿åºœæ”¯ä»˜å·¨é¢çš„ç‰¹æ®Šé‡‡è´­ï¼Œè¿™äº›ç‰¹æ®Šé‡‡è´­å å½“å¹´æ—¥æœ¬å‡ºå£è´¸æ˜“çš„27%ã€‚1950å¹´ä»£åæœŸï¼Œæ—¥æœ¬çš„ç»æµå®Œå…¨æ¢å¤ã€‚</p><p>æ—¥æœ¬æ”¿åºœçš„ä¸€ç³»åˆ—ç»æµæ”¿ç­–ï¼ŒåŠ ä¸Šæ²¡æœ‰å…»å†›é˜Ÿçš„æŸç¼šï¼ˆã€Šæ—¥æœ¬å›½å®ªæ³•ã€‹ç¬¬ä¹æ¡ï¼‰ä¹Ÿä¸ºæ—¥æœ¬ç»æµçš„å¿«é€Ÿå‘å±•å¥ å®šäº†åŸºç¡€ã€‚</p><p>1956å¹´ï¼Œæ—¥æœ¬æ”¿åºœåˆ¶å®šâ€œç”µåŠ›äº”å¹´è®¡åˆ’â€ï¼Œå»ºç«‹ç”µåŠ›å·¥ä¸šå’Œç”¨çŸ³æ²¹å–ä»£ç…¤ç‚­ï¼Œç”±æ­¤å¸¦æ¥çš„è‰¯å¥½å½±å“å¸¦åŠ¨äº†è€ç”¨å“æ¶ˆè´¹ï¼Œå‡ºç°æˆ˜åç¬¬ä¸€æ¬¡ç»æµå‘å±•é«˜æ½®ï¼Œæ—¶ç§°<strong>ç¥æ­¦æ™¯æ°”</strong>ã€‚</p><p>1958å¹´åï¼Œæ—¥æœ¬æ”¿åºœå¼€å§‹å¼•å¯¼ä¼ä¸šç”Ÿäº§å¦‚æ±½è½¦ã€ç”µè§†ç­‰å®¶ç”¨ç”µå™¨å’Œé’¢é“ï¼Œå‡ºç°äº†ç¬¬äºŒæ¬¡ç»æµå‘å±•é«˜æ½®ï¼Œç§°ä¸º<strong>å²©æˆ·æ™¯æ°”</strong>ã€‚</p><p>1960å¹´ï¼Œ1960å¹´ä»£æ—¥æœ¬é¦–ç›¸æ± ç”°å‹‡äººæå‡ºäº†å›½æ°‘æ”¶å…¥å€å¢è®¡åˆ’ï¼Œ10å¹´çš„æ—¶é—´è®©æ—¥æœ¬çš„å›½æ°‘ç”Ÿäº§æ€»å€¼å¢åŠ åˆ°26å…†æ—¥åœ†ï¼Œä½†å®é™…çš„ç»æµæˆé•¿è¿œè¶…è¿‡é¢„æœŸï¼šä»…å…­å¹´çš„æ—¶é—´ï¼Œå›½æ°‘å¹³å‡æ”¶å…¥å°±è¾¾åˆ°äº†å€å¢çš„è®¡åˆ’ã€‚</p><p>1964å¹´ï¼Œæ—¥æœ¬æˆåŠŸä¸¾åŠä¸œäº¬å¥¥è¿ä¼šï¼Œæ—¥æœ¬ä¸ºäº†ä¸œäº¬å¥¥è¿çš„ç›´æ¥åœºé¦†æŠ•èµ„ä¸º295äº¿æ—¥å…ƒï¼Œé—´æ¥æŠ•èµ„ï¼ˆå…¬è·¯ã€åœ°ä¸‹é“ç­‰äº¤é€šå»ºè®¾ï¼Œä¸Šä¸‹æ°´é“é“ºå»ºç­‰ï¼‰åˆ™è¾¾9,600äº¿æ—¥å…ƒã€‚æˆ¿åœ°äº§å¸‚åœºè¿…é€Ÿå‘å±•ï¼Œå†ä¸€æ¬¡æ‹‰åŠ¨äº†ç»æµï¼Œæ—¶ç§°<strong>å¥¥è¿ä¼šæ™¯æ°”</strong>ã€‚</p><p>ä½†å¥¥è¿ä¼šç»“æŸåæ—¥æœ¬ç»æµå‡ºç°äº†æ”¾ç¼“ï¼Œäºæ˜¯æ—¥æœ¬æ”¿åºœå†³å®šå‘è¡Œæˆ˜åçš„ç¬¬ä¸€æ¬¡å»ºè®¾å›½å€ºåˆºæ¿€ç»æµã€‚åœ¨è¿™æœŸé—´ï¼Œæœ‰ä¸å°‘å¤§ä¼ä¸šåˆå¹¶ï¼ŒåŒæ—¶ç§å®¶è½¦å’Œå½©è‰²ç”µè§†å¿«é€Ÿæ™®åŠï¼Œå›½æ°‘çš„æ”¶å…¥æ°´å¹³å¿«é€Ÿæé«˜ï¼Œæ—¶ç§°<strong>ä¼Šå¥˜è¯ºæ™¯æ°”</strong>ã€‚</p><h2 id="ç¾å›½è´¸æ˜“é€†å·®ä¸å¹¿åœºåè®®">ç¾å›½è´¸æ˜“é€†å·®ä¸å¹¿åœºåè®®</h2><p>åœ¨ç¾å›½æ‰¶æŒä¸‹ï¼Œæ—¥æœ¬åˆ¶é€ ä¸šè¿æ¥é£é€Ÿå‘å±•ï¼Œå¾ˆå¤šäº§å“å‡ºå£åˆ°ç¾å›½ï¼ŒæŠ¢å å…¶æœ¬åœŸäº§å“å¸‚åœºã€‚</p><p>1ã€1957-1972å¹´ï¼šæ—¥æœ¬ çººç»‡å“å¤§é‡è¿›å…¥ç¾å›½ï¼Œç¾å›½å¯†é›†å‡ºå°é™åˆ¶æ—¥æœ¬çººç»‡å“çš„æ³•æ¡ˆï¼›</p><p>2ã€1968-1978å¹´ï¼šæ—¥æœ¬ é’¢é“è¡Œä¸šæ¥æ£’çººç»‡ä¸šï¼Œæˆä¸ºå¯¹ç¾å‡ºå£çš„ä¸»åŠ›ï¼Œéšåé­åˆ°ç¾å›½é’¢é“è¡Œä¸šå·¥ä¼šçš„é˜»å‡»ï¼›</p><p>3ã€1970-1980å¹´ï¼šæ—¥æœ¬ å®¶ç”µè¡Œä¸šå´›èµ·ï¼Œç‰¹åˆ«æ˜¯å½©ç”µï¼Œå·…å³°æœŸç¾å›½å¸‚åœºä¸‰æˆçš„å½©ç”µéƒ½æ˜¯æ—¥æœ¬äº§å“ï¼›</p><p>4ã€1979-1987å¹´ï¼šæ—¥æœ¬ æ±½è½¦è¡Œä¸šå´›èµ·ï¼Œæˆä¸ºæ—¥æœ¬èµšå–ç¾å…ƒçš„ä¸»åŠ›ï¼Œå¯¼è‡´å…¨ç¾èŒƒå›´å†…çš„æŠ—è®®æ½®ã€‚</p><p>ä¸ºé˜»æ­¢è´¸æ˜“é€†å·®æ‰©å¤§ï¼Œç¾å›½å¯¹æ—¥å‡ºå°ä¸€ç³»åˆ—é™åˆ¶æ”¿ç­–ï¼Œå¯æƒœæ•ˆæœä¸€ç›´ä¸å¤§ï¼Œç›´åˆ°1985å¹´çš„å¹¿åœºåè®®ã€‚</p><p>ç¾å›½ã€æ—¥æœ¬ã€è‹±å›½ã€æ³•å›½åŠå¾·å›½5ä¸ªå·¥ä¸šå‘è¾¾å›½å®¶ä»£è¡¨äººåœ¨çº½çº¦çš„å¹¿åœºé¥­åº—ä¼šæ™¤åï¼Œäº1985å¹´9æœˆç­¾ç½²è¯¥åè®®ï¼Œåè®®è¦æ±‚å¹²é¢„å¤–æ±‡å¸‚åœºï¼Œä½¿ç¾å…ƒå¯¹æ—¥å…ƒã€å¾·å›½é©¬å…‹ç­‰ä¸»è¦è´§å¸è´¬å€¼ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210195705.png"></p><p>ç­¾å®Œåè®®å¤´ä¸€å¹´ï¼Œæ—¥å…ƒä»…ç›¸å¯¹ç¾å…ƒå‡å€¼20%ï¼Œè¿˜åœ¨å¯æ§èŒƒå›´ï¼Œæ—¥æœ¬åˆ¶é€ ä¼ä¸šçœçœé’±ï¼Œè£è£å‘˜ï¼Œè¿˜æ’‘å¾—ä¸‹å»ï¼Œåˆ°äº†1987å¹´ç›´æ¥å¤±æ§ï¼Œæ—¥å…ƒç›¸å¯¹ç¾å…ƒå‡å€¼åˆ°100%ï¼Œä»1ç¾å…ƒå…‘240æ—¥å…ƒå·¦å³ä¸Šå‡åˆ°ä¸€å¹´åçš„1ç¾å…ƒå…‘120æ—¥å…ƒï¼Œç”±äºæ±‡ç‡çš„å‰§çƒˆå˜åŠ¨ï¼Œç”±ç¾å›½å›½å€ºç»„æˆçš„èµ„äº§å‘ç”Ÿè´¦é¢äºæŸï¼Œå› æ­¤å¤§é‡èµ„é‡‘ä¸ºäº†èº²é¿æ±‡ç‡é£é™©è€Œè¿›å…¥æ—¥æœ¬å›½å†…å¸‚åœºã€‚ä½†æ˜¯æ—¥æœ¬å‡ºå£ä¼ä¸šå—åˆ°äº†é‡åˆ›ã€‚</p><h2 id="æ³¡æ²«ç»æµä¸ç ´ç­">æ³¡æ²«ç»æµä¸ç ´ç­</h2><h3 id="è™šå‡çš„ç¹è£">è™šå‡çš„ç¹è£</h3><p>ä¸ºäº†ç¼“è§£æ—¥å…ƒå‡å€¼çš„é€Ÿåº¦ï¼Œæ—¥æœ¬æ”¿åºœé‡‡å–çš„åŠæ³•æ˜¯<strong>é™æ¯</strong>ï¼Œæ—¥æœ¬æ”¿åºœè®¤ä¸ºåªè¦å­˜æ¬¾åˆ©æ¯å‡å°‘ï¼Œå¤§å®¶çš„é’±å­˜é“¶è¡Œä¸åˆ’ç®—ï¼Œå¸‚åœºä¸ŠæµåŠ¨çš„æ—¥å…ƒä¼šå¤§å¤§å¢å¤šï¼Œåˆºæ¿€å›½æ°‘æ¶ˆè´¹ï¼Œæ‰©å¤§å†…éœ€ï¼Œå®ç°ä¸€ç§å‡ºå£è½¬å†…é”€çš„æ•ˆæœï¼ŒåŒæ—¶ç¼“è§£æ—¥å…ƒå‡å€¼çš„é€Ÿåº¦ã€‚</p><p>äºæ˜¯1986å¹´å®£å¸ƒå°†é“¶è¡Œåˆ©ç‡ä»5%é™åˆ°4.5%ï¼Œåˆ°1987å¹´ç›´æ¥é™åˆ°2.5%ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210200859.png"></p><p>æ±‡ç‡æ˜¯ç¨³ä¸‹æ¥ï¼Œä»æ±‡ç‡è¡¨å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å…ƒå‡å€¼åˆ°1987å¹´å°±åœä¸‹æ¥ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210201032.png"></p><p>ä½†æ²¡æƒ³åˆ°çš„æ˜¯ï¼Œé™ä½åˆ©ç‡å¯¹å›½å†…åŸºæœ¬æ¶ˆè´¹éœ€æ±‚æ²¡æœ‰åˆºæ¿€ä½œç”¨ï¼Œä½†å¯¹æŠ•æœºã€ç‰¹åˆ«æ˜¯æŠ•èµ„æˆ¿åœ°äº§è¡Œä¸ºå´èƒ½èµ·å¾ˆå¤§çš„ä¿ƒè¿›çš„ä½œç”¨ï¼Œå¸‚åœºä¸Šå¤šå‡ºæ¥çš„æ—¥å…ƒæ²¡æœ‰è¿›å…¥åˆ¶é€ ä¸šï¼Œè€Œæ˜¯<strong>æŠ•åˆ°è‚¡å¸‚å’Œæˆ¿å¸‚ä¸Š</strong>ï¼Œå½“æ—¶é‡‡å–è¿™æ ·çš„æ”¿ç­–ï¼Œæœ¬èº«å°±æ˜¯ä»¥è™šå‡çš„ç»æµæ³¡æ²«å»ç²‰é¥°ç»æµå¢é•¿çš„æ•°æ®ï¼Œæ³¡æ²«æ’‘èµ·æ—¥æœ¬GDPè‡ª1987å¹´åçš„é«˜é€Ÿå¢é•¿ã€‚æ—¥ç»å¹³å‡è‚¡ä»·ä»85å¹´çš„13000ï¼Œä¸€è·¯é£™æ¶¨åˆ°90å¹´çš„38000ç‚¹å·¦å³ï¼Œæ¥è¿‘3å€ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210201556.png"></p><p>æˆ¿ä»·ä»83å¹´çš„37ä¸‡æ—¥å…ƒä¸€å¹³ç±³ï¼Œæ¶¨åˆ°91å¹´çš„278ä¸‡æ—¥å…ƒä¸€å¹³ç±³ï¼Œå¦‚æœæŒ‰ç›®å‰1:0.05 çš„äººæ°‘å¸æ—¥å…ƒæ±‡ç‡ç®—ï¼Œç›¸å½“äº 14ä¸‡äººæ°‘å¸ä¸€å¹³ç±³ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210201624.png"></p><p>å½“æ—¶ä¸œäº¬23ä¸ªåŒºçš„åœ°ä»·æ€»å’Œç”šè‡³è¾¾åˆ°äº†å¯ä»¥è´­ä¹°ç¾å›½å…¨éƒ¨å›½åœŸçš„æ°´å¹³ï¼Œè€Œé“¶è¡Œåˆ™ä»¥ä¸æ–­å‡å€¼çš„åœŸåœ°ä½œä¸ºæ‹…ä¿ï¼Œå‘å€ºåŠ¡äººå¤§é‡æ”¾æ¬¾ã€‚æ­¤å¤–åœ°ä»·ä¸Šå‡ä¹Ÿä½¿å¾—åœŸåœ°æ‰€æœ‰è€…çš„è´¦é¢è´¢äº§å¢åŠ ï¼Œåˆºæ¿€äº†æ¶ˆè´¹æ¬²æœ›ï¼Œä»è€Œå¯¼è‡´äº†å›½å†…æ¶ˆè´¹éœ€æ±‚å¢é•¿ã€‚ç”±äºæ—¥å…ƒæ€¥é€Ÿå‡å€¼å¯¼è‡´å›½å¤–èµ„äº§å˜å¾—ä¾¿å®œï¼Œå½“æ—¶å¾ˆå¤šäººå–å¥¢ä¾ˆå“å’Œä¹°èœä¸€æ ·å¹³å¸¸ã€‚å½“æ—¶æ—¥æœ¬åª’ä½“ä¸ºäº†ç»™è¿™ç§ç»æµç¹è£çŠ¶å†µå‘½åï¼Œè¿˜å¸Œæœ›å‹Ÿé›†åƒå²©æˆ·æ™¯æ°”ã€ç¥æ­¦æ™¯æ°”ç±»ä¼¼çš„åç§°ã€‚</p><h3 id="æ³¡æ²«ç»æµçš„ç ´ç­">æ³¡æ²«ç»æµçš„ç ´ç­</h3><p>éšç€è¶Šæ¥è¶Šå¤šçš„èµ„æœ¬æµå‘è‚¡å¸‚å’Œæˆ¿å¸‚ï¼Œè€Œä¸æ˜¯å®ä½“äº§ä¸šï¼ŒåŠ ä¸Šç”±äºç¾å›½å‘åŠ¨äº†ä¼Šæ‹‰å…‹æˆ˜äº‰ï¼ŒçŸ³æ²¹ä»·æ ¼é£™å‡ï¼Œæ—¥æœ¬å›½å†…åˆ¶é€ ä¸šæˆæœ¬æ¿€å¢ï¼Œäºæ˜¯å¤§é‡åˆ¶é€ ä¸šå€’é—­ã€‚</p><p>1989å¹´ï¼Œæ—¥æœ¬å¤®è¡Œå¼€å§‹åŠ æ¯ï¼Œå¸Œæœ›é€šè¿‡åŠ æ¯æ¥æŠ‘åˆ¶è‚¡å¸‚å’Œæˆ¿å¸‚çš„æŠ•æœºçƒ­æƒ…ï¼Œä½†æ˜¯è¿™ä¸€ä¸¾æªå´å¼•èµ·äº†å¤–èµ„çš„æŠ›å”®ï¼Œè‚¡å¸‚åœ¨1989å¹´12æœˆè¾¾åˆ°38957.44ç‚¹åå¼€å§‹ä¸‹è·Œï¼Œæ³¡æ²«ç»æµå¼€å§‹æ­£å¼ç ´è£‚ã€‚</p><p>1991å¹´ä¸€æœˆï¼Œæ—¥æœ¬æ”¿åºœå‘ç°äº‹æƒ…ä¸å¯¹ï¼Œåˆå¼€å§‹å¤§å¹…é™æ¯ï¼Œæƒ³ä»¥æ­¤ç¨³ä½è‚¡å¸‚ï¼Œä½†ä¾æ—§æ— æ³•æŒ½æ•‘è‚¡å¸‚ï¼Œå¤–èµ„æŒç»­å‡ºé€ƒã€‚</p><p>æ¯”è‚¡å¸‚æ›´æƒ¨çš„æ˜¯æ¥¼å¸‚ï¼Œ1991å¹´9æœˆï¼ŒåœŸåœ°å¼€å§‹æš´è·Œï¼Œ1992å¹´æ—¥æœ¬å‡ºå°â€œåœ°ä»·ç¨â€æ”¿ç­–ï¼Œè¦æ±‚æ‰€æœ‰æŒæœ‰åœŸåœ°çš„äººäº¤çº³åœ°ä»·ç¨ï¼Œå¯¼è‡´å¤§é‡äººå¼€å§‹æŠ›å”®æˆ¿äº§ï¼Œé™·å…¥äº†ä¾›å¤§äºæ±‚çš„å±€é¢ã€‚éšç€æˆ¿ä»·æš´è·Œï¼Œè¶Šæ¥è¶Šå¤šçš„äººå‘ç°è‡ªå·±æŒæœ‰çš„æˆ¿å­çš„ä»·å€¼æ¯”è‡ªå·±çš„è´·æ¬¾è¿˜ä½ï¼Œäºæ˜¯å¤§é‡äººè¿çº¦ï¼Œæ—¥æœ¬é“¶è¡Œå‡ºç°å¤§é‡ä¸è‰¯èµ„äº§ï¼Œé“¶è¡Œå¼€å§‹å€’é—­ï¼Œè®¸å¤šæ—¥æœ¬å±…æ°‘çš„å­˜æ¬¾ä¸€å¤œå½’é›¶ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå¤§å®¶éƒ½æ²¡é’±äº†ï¼Œæ•´ä½“ç»æµæ–­å´–å¼ä¸‹è·Œï¼Œä¹°äº†æˆ¿çš„äººï¼Œå¤±ä¸šåè¿˜è¦è¿˜æˆ¿è´·ï¼Œæ²¡ä¹°æˆ¿çš„äººï¼Œä¹Ÿå¤±å»äº†ä¹°æˆ¿æ‹¼æçš„åŠ¨åŠ›ã€‚å¹´è½»äººé€æ¸å¼€å§‹èµ°å‘ä½›ç³»ï¼Œé€‰æ‹©ä½æ¬²æœ›ç”Ÿæ´»ï¼Œä»–ä»¬ä¸ä¸Šç­ï¼Œåœ¨å®¶å•ƒè€ï¼Œæ²‰è¿·äºŒæ¬¡å…ƒå’Œç½‘ç»œæ¸¸æˆï¼Œè¢«ç§°ä¸ºâ€œå¹³æˆåºŸç‰©â€ã€‚</p><h2 id="å¯ç¤ºä¸å€Ÿé‰´">å¯ç¤ºä¸å€Ÿé‰´</h2><h3 id="å½“å‰ä¸­å›½ç»æµå‘å±•ä¸æ—¥æœ¬æˆ˜åç»æµå‘å±•çš„æ¯”è¾ƒ">å½“å‰ä¸­å›½ç»æµå‘å±•ä¸æ—¥æœ¬æˆ˜åç»æµå‘å±•çš„æ¯”è¾ƒ</h3><ol type="1"><li>å¿«é€Ÿå·¥ä¸šåŒ–</li></ol><ul><li>æ—¥æœ¬æˆ˜åé€šè¿‡æ”¿åºœè§„åˆ’å’Œæ”¿ç­–æ”¯æŒå®ç°äº†é«˜é€Ÿå·¥ä¸šåŒ–ï¼Œä¸­å›½è‡ªæ”¹é©å¼€æ”¾ä»¥æ¥ä¹Ÿç»å†äº†ç±»ä¼¼çš„å·¥ä¸šåŒ–è¿›ç¨‹ï¼Œé€æ­¥ä»å†œä¸šç»æµè½¬å‘åˆ¶é€ ä¸šå’ŒæœåŠ¡ä¸šä¸ºä¸»ã€‚</li><li>ä¸¤å›½éƒ½é€šè¿‡åŸºç¡€è®¾æ–½å»ºè®¾å’Œå‡ºå£å¯¼å‘æ”¿ç­–ï¼Œæ‹‰åŠ¨ç»æµå¢é•¿ã€‚</li></ul><ol start="2" type="1"><li>é«˜å‚¨è“„ç‡ä¸é«˜æŠ•èµ„ç‡</li></ol><ul><li>æ—¥æœ¬æˆ˜åå‚¨è“„ç‡é«˜ï¼Œèµ„é‡‘ä¸»è¦æµå‘å·¥ä¸šå’ŒåŸºç¡€è®¾æ–½æŠ•èµ„ï¼›ä¸­å›½è¿‘å¹´æ¥ä¹Ÿä¿æŒç€é«˜å‚¨è“„ç‡å’ŒæŠ•èµ„ç‡ï¼Œå¤§é‡èµ„é‡‘ç”¨äºåŸºå»ºã€æˆ¿åœ°äº§å’Œç§‘æŠ€äº§ä¸šã€‚</li><li>åœ¨é«˜æŠ•èµ„é©±åŠ¨ä¸‹ï¼Œç»æµå¢é•¿è¿…é€Ÿï¼Œä½†ä¹Ÿå­˜åœ¨æŠ•èµ„è¿‡å‰©çš„é£é™©ã€‚</li></ul><ol start="3" type="1"><li>æ”¿åºœä¸»å¯¼ç»æµ</li></ol><ul><li>æ—¥æœ¬æˆ˜åç»æµå—åˆ°æ”¿åºœå¼ºçƒˆå¹²é¢„ï¼Œå®æ–½äº§ä¸šæ”¿ç­–æ”¯æŒå…³é”®é¢†åŸŸï¼Œä¸­å›½åŒæ ·é€šè¿‡äº”å¹´è§„åˆ’å’Œæ”¿ç­–å¯¼å‘è°ƒæ§ç»æµå‘å±•ã€‚</li><li>æ”¿åºœå¯¹å¸‚åœºçš„å¹²é¢„åœ¨æŸç§ç¨‹åº¦ä¸ŠåŠ å‰§äº†å¸‚åœºçš„å¤±è¡¡ï¼Œå¸¦æ¥æ½œåœ¨é£é™©ã€‚</li></ul><ol start="4" type="1"><li>å¿«é€ŸåŸå¸‚åŒ–å’Œæˆ¿åœ°äº§å¸‚åœºç¹è£</li></ol><ul><li>æ—¥æœ¬æˆ˜ååŸå¸‚åŒ–è¿›ç¨‹è¿…é€Ÿï¼Œæˆ¿åœ°äº§å¸‚åœºç»å†äº†é«˜é€Ÿå¢é•¿ï¼›ä¸­å›½ä¹Ÿåœ¨è¿‘å¹´æ¥å¿«é€ŸåŸå¸‚åŒ–ï¼Œæˆ¿åœ°äº§è¡Œä¸šæˆä¸ºç»æµå¢é•¿çš„é‡è¦å¼•æ“ã€‚</li><li>æˆ¿åœ°äº§æ³¡æ²«åœ¨æ—¥æœ¬æ›¾é€ æˆä¸¥é‡çš„ç»æµé—®é¢˜ï¼Œä¸­å›½å½“å‰ä¹Ÿé¢ä¸´ç±»ä¼¼çš„æ³¡æ²«é£é™©ã€‚</li></ul><ol start="5" type="1"><li>å€ºåŠ¡é—®é¢˜</li></ol><ul><li>æ—¥æœ¬æˆ˜åç»æµé«˜é€Ÿå¢é•¿æ—¶æœŸï¼Œä¼ä¸šå€ºåŠ¡è¿…é€Ÿè†¨èƒ€ï¼Œæ”¿åºœå€ºåŠ¡ä¹Ÿä¸æ–­æ”€å‡ã€‚ä¸­å›½ç›®å‰åœ°æ–¹æ”¿åºœå€ºåŠ¡å’Œä¼ä¸šå€ºåŠ¡åŒæ ·å¢é•¿è¿…é€Ÿï¼Œæ½œåœ¨é£é™©å€¼å¾—å…³æ³¨ã€‚</li></ul><h3 id="æ³¡æ²«ç»æµçš„æ½œåœ¨å±æœºä¸­å›½æ˜¯å¦ä¼šé‡è¹ˆæ—¥æœ¬è¦†è¾™">æ³¡æ²«ç»æµçš„æ½œåœ¨å±æœºï¼šä¸­å›½æ˜¯å¦ä¼šé‡è¹ˆæ—¥æœ¬è¦†è¾™ï¼Ÿ</h3><ol type="1"><li>æˆ¿åœ°äº§å¸‚åœºé£é™©</li></ol><ul><li>æ—¥æœ¬ç»éªŒï¼š1980å¹´ä»£æ—¥æœ¬æˆ¿åœ°äº§ä»·æ ¼æš´æ¶¨ï¼Œä½†éšç€æ”¿åºœæ”¶ç´§è´§å¸æ”¿ç­–ï¼Œæ³¡æ²«ç ´è£‚ï¼Œå¯¼è‡´é‡‘èç³»ç»Ÿå´©æºƒã€‚</li><li>ä¸­å›½ç°çŠ¶ï¼šæˆ¿åœ°äº§è¡Œä¸šåœ¨ä¸­å›½ç»æµä¸­å æ®é‡è¦åœ°ä½ï¼Œä½†å­˜åœ¨è¿‡åº¦ä¾èµ–çš„é—®é¢˜ã€‚ç›®å‰æˆ¿åœ°äº§å¸‚åœºé¢ä¸´é«˜æ æ†å’Œéœ€æ±‚ç–²è½¯çš„åŒé‡å‹åŠ›ï¼Œéƒ¨åˆ†åŸå¸‚å·²ç»æ˜¾ç°æ³¡æ²«ç ´è£‚è¿¹è±¡ã€‚</li></ul><ol start="2" type="1"><li>å€ºåŠ¡ç§¯ç´¯</li></ol><ul><li>æ—¥æœ¬ç»éªŒï¼šæ³¡æ²«æ—¶æœŸä¼ä¸šè¿‡åº¦å€Ÿè´·ï¼Œæœ€ç»ˆå› èµ„äº§ä»·æ ¼ä¸‹è·Œå’Œç»æµè¡°é€€å¯¼è‡´å¤§è§„æ¨¡å€ºåŠ¡è¿çº¦ã€‚</li><li>ä¸­å›½ç°çŠ¶ï¼šåœ°æ–¹æ”¿åºœéšæ€§å€ºåŠ¡å’Œä¼ä¸šå€ºåŠ¡é£é™©æŒç»­ä¸Šå‡ï¼Œéƒ¨åˆ†å€ºåŠ¡å·²ç»éš¾ä»¥æŒç»­å¿è¿˜ï¼Œä¸€æ—¦ç»æµä¸‹è¡Œå¯èƒ½è§¦å‘å€ºåŠ¡å±æœºã€‚</li></ul><ol start="3" type="1"><li>é‡‘èç³»ç»Ÿç¨³å®šæ€§</li></ol><ul><li>æ—¥æœ¬ç»éªŒï¼šæ³¡æ²«ç ´è£‚åï¼Œé“¶è¡Œå› ä¸è‰¯è´·æ¬¾å¢åŠ è€Œé™·å…¥å›°å¢ƒï¼Œé‡‘èç³»ç»Ÿå´©æºƒæˆä¸ºé•¿æœŸç»æµä½è¿·çš„ä¸»è¦åŸå› ã€‚</li><li>ä¸­å›½ç°çŠ¶ï¼šä¸­å›½é‡‘èç³»ç»Ÿä¸­å­˜åœ¨ä¸è‰¯è´·æ¬¾ç‡ä¸Šå‡çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨æˆ¿åœ°äº§å’Œåœ°æ–¹æ”¿åºœèèµ„å¹³å°é¢†åŸŸï¼Œå¯èƒ½å¯¹é“¶è¡Œä½“ç³»æ„æˆå¨èƒã€‚</li></ul><ol start="4" type="1"><li>äººå£ä¸æ¶ˆè´¹é—®é¢˜</li></ol><ul><li>æ—¥æœ¬ç»éªŒï¼šæ³¡æ²«ç»æµç ´è£‚åï¼Œäººå£è€é¾„åŒ–å’Œæ¶ˆè´¹ç–²è½¯å¯¼è‡´ç»æµéš¾ä»¥å¤è‹ã€‚</li><li>ä¸­å›½ç°çŠ¶ï¼šäººå£å¢é€Ÿæ”¾ç¼“ã€è€é¾„åŒ–é—®é¢˜æ˜¾ç°ï¼Œå†…éœ€ä¸è¶³å¯èƒ½è¿›ä¸€æ­¥åˆ¶çº¦ç»æµå¢é•¿ï¼Œå½¢æˆé•¿æœŸæ€§ç»“æ„é—®é¢˜ã€‚</li></ul><p>å†å²è¯æ˜ï¼Œ<strong>å½“ç»æµä»¥è¶…å‡ºæ½œåœ¨ç»æµå¢é•¿ç‡çš„é€Ÿåº¦å¥”è·‘æ—¶ï¼Œå‘ç”Ÿèµ„äº§æ³¡æ²«ä¹ƒè‡³æˆä¸ºæ³¡æ²«ç»æµå‡ ä¹æ˜¯ä¸å¯é¿å…çš„äº‹æƒ…</strong>ã€‚</p><h3 id="ä¸­å›½ä¼šä¸ä¼šé‡è¹ˆå¤è¾™">ä¸­å›½ä¼šä¸ä¼šé‡è¹ˆå¤è¾™ï¼Ÿ</h3><p>ä¸­å›½ç»æµå‘å±•ä¸æ—¥æœ¬æˆ˜åæœ‰è¯¸å¤šç›¸ä¼¼ä¹‹å¤„ï¼Œä½†ä¸­å›½çš„ç»æµè§„æ¨¡æ›´å¤§ã€æ”¿ç­–å¼¹æ€§æ›´å¼ºï¼Œå¹¶ä¸”å…·å¤‡åº”å¯¹å±æœºçš„ç»éªŒã€‚ç„¶è€Œï¼Œä¸­å›½å½“å‰é¢ä¸´çš„æˆ¿åœ°äº§æ³¡æ²«ã€å€ºåŠ¡é—®é¢˜å’Œäººå£è€é¾„åŒ–ç­‰æŒ‘æˆ˜ï¼Œç¡®å®å¯èƒ½å¼•å‘ç±»ä¼¼äºæ—¥æœ¬çš„ç»æµæ³¡æ²«å±æœºã€‚å¦‚æœä¸èƒ½å¦¥å–„å¤„ç†ï¼Œè¿™äº›é—®é¢˜å¯èƒ½æˆä¸ºç»æµå‘å±•çš„é‡å¤§éšœç¢ã€‚å› æ­¤ï¼Œç»§ç»­æ¨è¿›ç»æµç»“æ„æ”¹é©å’Œé£é™©é˜²æ§æ˜¯é¿å…é™·å…¥æ³¡æ²«ç»æµå›°å¢ƒçš„å…³é”®ã€‚</p><h3 id="é€†åŠ¿ä¸Šæ¶¨çš„è¡Œä¸šæœºä¼š">é€†åŠ¿ä¸Šæ¶¨çš„è¡Œä¸šæœºä¼š</h3><p>ç»æµè¶Šä¸å¥½ï¼Œä»€ä¹ˆè¡Œä¸šåè€Œè¶Šå¥½å‘¢ï¼Ÿå…¶å®æ—¥æœ¬â€œæ¶ˆå¤±çš„ä¸‰åå¹´â€æ—©å°±å†™å¥½äº†ç­”æ¡ˆã€‚å½“æ—¶çš„å¹´è½»äººä¹Ÿæ˜¯æƒ³ç€å»è€ƒå…¬è€ƒç¼–ï¼Œå»é“¶è¡Œå·¥ä½œï¼Œç»“æœæ—¥æœ¬çš„å…¬åŠ¡å‘˜å¹´å¹´ç¼©ç¼–ï¼Œ153å®¶é“¶è¡Œç›´æ¥å€’é—­äº†ã€‚æ¶ˆè´¹é™çº§ï¼Œå¹´è½»äººèººå¹³ï¼Œè·Ÿæˆ‘ä»¬å½“ä¸‹å¦‚å‡ºä¸€è¾™ã€‚é‚£å½“æ—¶çš„æ—¥æœ¬ä»€ä¹ˆè¡Œä¸šåè€Œå¥½å‘¢ï¼Ÿä¸»è¦æœ‰ä¸‰ä¸ªæ–¹å‘ã€‚ä¸€ã€å¤šå·´èƒºç»æµï¼Œå°±æ˜¯é‚£ç§èŠ±ç‚¹å°é’±èƒ½ä¹°åˆ°å¤§å¿«ä¹çš„ã€‚ä¸‰å¾—åˆ©å½“æ—¶å°±æ˜¯é ç€å–èŒ¶å’Œå’–å•¡ä¸€æ³¢å´›èµ·çš„ã€‚äºŒã€å¹³ä»·ç»æµã€‚æ—¥æœ¬è¿ç»­ä¸ƒå¹´çš„é¦–å¯Œå°±æ˜¯ä¼˜è¡£åº“ã€‚é‚£å’±ä»¬çš„èœœé›ªå†°åŸã€æ‹¼å¤šå¤šã€ååˆ›ä¼˜å“æ˜¯ä¸æ˜¯ä¹Ÿå¾ˆç±»ä¼¼å‘¢ï¼Ÿæœ€åå°±æ˜¯é€ æ¢¦ç»æµã€‚é€šä¿—ç‚¹è¯´ï¼Œå°±æ˜¯èƒ½è®©äººçŸ­æš‚åœ°å¿˜è®°ç—›è‹¦ï¼Œé€ƒé¿ç°å®çš„è¡Œä¸šã€‚æ¯”å¦‚20å¹´å‰æ—¥æœ¬çš„ç´¢å°¼å’Œä»»å¤©å ‚ï¼Œä»¥åŠå›½å†…çˆ†ç«çš„ã€Šé»‘ç¥è¯ï¼šæ‚Ÿç©ºã€‹ï¼Œéƒ½æ˜¯å› ä¸ºæ¶ˆè´¹é™çº§äº†ï¼Œå¤§å®¶ä¸çˆ±å‡ºé—¨ï¼Œå®æ„¿èŠ±ç‚¹å°é’±åœ¨å®¶ç©æ¸¸æˆï¼Œä¸»æ‰“çš„å°±æ˜¯å¿˜è®°ç—›è‹¦ï¼Œè¿‡å¾—å¿«ä¹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ‚è°ˆ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç»æµå‘å±• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹ä¼˜åŒ–-FlashAttention-v2/v3</title>
      <link href="/2024/12/10/da-mo-xing-you-hua-flashattention-v2-v3/"/>
      <url>/2024/12/10/da-mo-xing-you-hua-flashattention-v2-v3/</url>
      
        <content type="html"><![CDATA[<h2 id="flashattention-v1å›é¡¾">FlashAttention-v1å›é¡¾</h2><p>æˆ‘ä»¬å…ˆå¿«é€Ÿå›é¡¾ä¸€ä¸‹V1çš„è¿ä½œæµç¨‹ï¼šä»¥Kï¼ŒVä¸ºå¤–å¾ªç¯ï¼ŒQä¸ºå†…å¾ªç¯ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210021847.png"></p><h2 id="flashattention-v2">FlashAttention-v2</h2><p>FlashAttention V2 å‡ºè‡ªè®ºæ–‡(ã€ŠFlashAttention-2: Faster Attention withBetter Parallelism and WorkPartitioningã€‹)[https://arxiv.org/pdf/2307.08691]ï¼Œ ä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š</p><ul><li>ä¼˜åŒ–è®¡ç®—æ¬¡åºï¼Œå‡å°‘éçŸ©é˜µè®¡ç®—é‡ã€‚</li><li>å¢åŠ  seq_len ç»´åº¦çš„å¹¶è¡Œè®¡ç®—ï¼Œæå‡ SM åˆ©ç”¨ç‡ã€‚</li><li>ä¼˜åŒ– warp çº§å·¥ä½œæ¨¡å¼ï¼Œå‡å°‘å†…éƒ¨é€šä¿¡å’Œ shared memory è®¿é—®ã€‚</li></ul><h2 id="flashattention-v3">FlashAttention-v3</h2><p>Flash Attention V3 å‡ºè‡ªè®ºæ–‡(ã€ŠFlashAttention-3: Fast and AccurateAttention with Asynchrony andLow-precisionã€‹)[https://arxiv.org/pdf/2407.08608]ï¼Œä¸»è¦æ”¹è¿›å¦‚ä¸‹ï¼š</p><p>å¼•å…¥ç”Ÿäº§è€…-æ¶ˆè´¹è€…å¼‚æ­¥æœºåˆ¶ï¼Œæå‡å¹¶è¡Œåº¦ã€‚ ä¼˜åŒ– GEMM å’Œ Softmaxæ“ä½œçš„é‡å è®¡ç®—ã€‚ æ”¯æŒ FP8 ä½ç²¾åº¦ç¡¬ä»¶åŠ é€Ÿï¼Œæå‡ååé‡å¹¶å‡å°‘ç²¾åº¦æŸå¤±ã€‚</p><p>å‚è€ƒï¼š &gt; å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlash AttentionV2ï¼Œä»åŸç†åˆ°å¹¶è¡Œè®¡ç®—: https://zhuanlan.zhihu.com/p/691067658</p>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> FlashAttention </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoæ­£ç¡®æ¸²æŸ“md/latexå…¬å¼</title>
      <link href="/2024/12/07/hexo-zheng-que-xuan-ran-md-latex-gong-shi/"/>
      <url>/2024/12/07/hexo-zheng-que-xuan-ran-md-latex-gong-shi/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨markdownå†™æ–‡æ¡£çš„æ—¶å€™ï¼Œå…ä¸äº†ä¼šç¢°åˆ°æ•°å­¦å…¬å¼ï¼Œå¥½åœ¨æœ‰å¼ºå¤§çš„Mathjaxï¼Œå¯ä»¥è§£æç½‘é¡µä¸Šçš„æ•°å­¦å…¬å¼ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯Markdwonæœ¬èº«çš„ç‰¹æ®Šç¬¦å·ä¸Latexä¸­çš„ç¬¦å·ä¼šå‡ºç°å†²çªçš„æ—¶å€™:</p><ul><li><code>_</code>çš„è½¬ä¹‰ï¼Œåœ¨markdownä¸­ï¼Œ<code>_æ–œä½“_</code>æ˜¯<em>æ–œä½“</em>ï¼Œä½†æ˜¯åœ¨latexä¸­ï¼Œå´æœ‰ä¸‹æ ‡çš„æ„æ€ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚</li><li><code>\\</code>çš„æ¢è¡Œï¼Œåœ¨markdownä¸­ï¼Œ<code>\\</code>ä¼šè¢«è½¬ä¹‰ä¸º<code>\</code>è¿™æ ·ä¹Ÿä¼šå½±å“å½±å“mathjaxå¯¹å…¬å¼ä¸­çš„<code>\\</code>è¿›è¡Œæ¸²æŸ“</li></ul><p>æˆ‘ä»ç½‘ä¸Šæ‰¾åˆ°çš„è§£å†³åŠæ³•å¤§å¤šéƒ½æ˜¯ä½¿ç”¨pandocææ¢markdownçš„æ¸²æŸ“å¼•æ“ï¼š</p><h2 id="hexo-render-pandoc">hexo-render-pandoc</h2><p>ä½¿ç”¨ hexo-render-pandoc, å¯ä»¥é¿å…ä¸Šè¿°æåˆ°çš„å¾ˆå¤šæ­§ä¹‰é—®é¢˜æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol type="1"><li>å®‰è£…é…ç½®hexo-render-pandoc</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npm un hexo-renderer-marked --save#or npm un hexo-renderer-kramed --save (å¦‚æœå®‰è£…çš„æ˜¯kramedçš„è¯)# åœ¨å®‰è£…ä¹‹å‰ï¼Œå»ºè®®å…ˆåˆ é™¤node_modulesæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶# å¹¶è¿è¡Œå‘½ä»¤ npm installnpm i hexo-renderer-pandoc --save</code></pre><p>å‰å»å®˜ç½‘å®‰è£…pandocï¼Œå¹¶ä¿è¯èƒ½åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ pandoc -v.</p><ol start="2" type="1"><li>ä¸»é¢˜é…ç½®æ‰“å¼€mathjaxå¼€å…³</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"># MathJax Supportmathjax:  enable: true  cdn: https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML   # ä½¿ç”¨cloudflareçš„cdn</code></pre><ol start="3" type="1"><li>æ–‡ç« çš„Front-matteré‡Œæ‰“å¼€mathjaxå¼€å…³(ä¸€å®šè¦æ‰“å¼€ï¼Œä¸ç„¶ä¸ä¼šæ¸²æŸ“)<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">---title: index.htmldate: 2016-12-28 21:01:30tags:mathjax: true---</code></pre></li></ol><p>ä½†æ˜¯pandocæ¯”è¾ƒç¬¨é‡ï¼Œéœ€è¦é¦–å…ˆå®‰è£…Pandoc,ä¸è¿‡çš„ç¡®å¯ä»¥å®Œç¾è§£å†³ä¸Šè¿°çš„ä¸å…¼å®¹é—®é¢˜ï¼Œå¦å¤–å®ƒçš„è¯­æ³•ä¸markdownæœ‰äº›å¾®çš„å·®å¼‚ï¼Œéœ€è¦æ³¨æ„ã€‚</p><h2 id="åˆ†ç¦»markdownå’Œlatex">åˆ†ç¦»markdownå’Œlatex</h2><h3 id="ä½¿ç”¨divæˆ–è€…spanæ ‡ç­¾">ä½¿ç”¨<code>&lt;div&gt;</code>æˆ–è€…<code>&lt;span&gt;</code>æ ‡ç­¾</h3><p>é’ˆå¯¹æœ‰å¯èƒ½è¢«è½¬ä¹‰çš„å…¬å¼ï¼ˆå¦‚å¸¦æ¢è¡Œç¬¦çš„ï¼‰ï¼Œç”¨<code>&lt;span&gt;</code>æˆ–è€…<code>&lt;div&gt;</code>æ ‡ç­¾å°†LaTeXå…¬å¼åŒ…è£¹èµ·æ¥ï¼Œè¿™æ ·å…¬å¼å†…å®¹å°±ä¸ä¼šè¢«markdownæ¸²æŸ“å™¨è¯†åˆ«ä¸ºè½¬ä¹‰å­—ç¬¦ã€‚</p><p>æ¯”å¦‚ï¼š </p><pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">$$\begin{pmatrix}    a_{11} &amp; a_{12} &amp; a_{13} \\    a_{21} &amp; a_{22} &amp; a_{23} \\    a_{31} &amp; a_{32} &amp; a_{33}  \end{pmatrix} $$</code></pre><code>\\</code>ä¼šæ— æ³•è¯†åˆ«å¯¼è‡´ä¸èƒ½æ¢è¡Œï¼Œå¯ä»¥å†™æˆï¼š <pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">&lt;span&gt;$$\begin{pmatrix}    a_{11} &amp; a_{12} &amp; a_{13} \\    a_{21} &amp; a_{22} &amp; a_{23} \\    a_{31} &amp; a_{32} &amp; a_{33}  \end{pmatrix}$$&lt;/span&gt;</code></pre>æ¸²æŸ“ç»“æœå°±æ­£å¸¸äº†ã€‚<p></p><h3 id="ä½¿ç”¨hexoè‡ªå¸¦çš„åˆ†ç¦»æ ‡è®°æ¨èç®€å•">ä½¿ç”¨hexoè‡ªå¸¦çš„åˆ†ç¦»æ ‡è®°ï¼ˆæ¨èï¼Œç®€å•ï¼‰</h3><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°äº†å¯ä»¥ä¸ºhexoæä¾›æ ‡è®°ï¼Œé˜»æ­¢å…¶æŒ‰ç…§è‡ªå·±çš„è§„åˆ™è§£é‡Šæˆ‘ä»¬çš„å­—ç¬¦ä¸²ï¼Œæ˜¾ç¤ºå…¶åŸæœ¬çš„å«ä¹‰</p><pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">{% raw %}...{% endraw %}</code></pre><p>è¿™æ ·å°±å¯ä»¥é¿å…markdownè§£é‡Šå™¨å¯¹æˆ‘ä»¬çš„å­—ç¬¦ä¸²è¿›è¡Œè½¬ä¹‰ï¼Œè€Œæ˜¯ç›´æ¥è¾“å‡ºåŸæœ¬çš„å­—ç¬¦ä¸²ã€‚</p><p>æ¯”å¦‚ï¼š </p><pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">{% raw %}$$\begin{align*}a &amp;= b + c \\    &amp;= d + e \\    &amp;= f + g\end{align*}$${% endraw %}</code></pre><p></p><p>æˆ‘æµ‹è¯•ä½¿ç”¨<code>&lt;div&gt;</code>æˆ–è€…<code>&lt;span&gt;</code>åœ¨å¤šè¡Œå…¬å¼æ¸²æŸ“æ—¶ä¾æ—§ä¼šå‡ºç°å¼‚å¸¸ï¼Œè€Œä½¿ç”¨<code></code>åˆ™å¯ä»¥æ­£å¸¸æ¸²æŸ“ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> hexoå…¬å¼æ¸²æŸ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹ä¼˜åŒ–-FlashAttention-v1</title>
      <link href="/2024/12/07/da-mo-xing-you-hua-flashattention-v1/"/>
      <url>/2024/12/07/da-mo-xing-you-hua-flashattention-v1/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨ä¼ ç»Ÿçš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œæ³¨æ„åŠ›çŸ©é˜µçš„<strong>è®¡ç®—å¤æ‚åº¦ä¸ºO(NÂ²)</strong>ï¼Œå…¶ä¸­ Næ˜¯åºåˆ—çš„é•¿åº¦ã€‚å¯¹äºé•¿åºåˆ—çš„è¾“å…¥ï¼ˆå¦‚æ–‡æœ¬æˆ–å›¾åƒä¸­çš„åƒç´ ç‚¹ï¼‰ï¼Œè¿™ç§è®¡ç®—ä»£ä»·æé«˜ï¼Œç‰¹åˆ«æ˜¯åœ¨è®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹æˆ–è§†è§‰æ¨¡å‹æ—¶ï¼Œå†…å­˜å ç”¨å’Œè®¡ç®—å¼€é”€éšç€åºåˆ—é•¿åº¦çš„å¢åŠ è€Œæ€¥å‰§ä¸Šå‡ã€‚æ­¤å¤–ï¼Œ<strong>æ³¨æ„åŠ›çŸ©é˜µçš„å¤§å°ä¸ºNÃ—N</strong>ï¼Œè¿™ä¹Ÿå¯¹ GPUå†…å­˜æ¶ˆè€—æå¤§ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸ä»…åœ¨è®¡ç®—æ—¶æ¶ˆè€—å¤§é‡å†…å­˜ï¼Œè¿˜éœ€è¦å­˜å‚¨æ‰€æœ‰ä¸­é—´å˜é‡ï¼ˆå¦‚Qã€Kã€V çŸ©é˜µåŠæ³¨æ„åŠ›æƒé‡ï¼‰ï¼Œä»¥æ”¯æŒåç»­çš„åå‘ä¼ æ’­ã€‚</p><p>å› æ­¤ï¼Œæ‰¾åˆ°æœ‰æ•ˆé™ä½ Transformer æ¨¡å‹ O(NÂ²)å¤æ‚åº¦çš„æ–¹æ¡ˆè‡³å…³é‡è¦ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè‹¥èƒ½å°†å¤æ‚åº¦é™è‡³O(N)ï¼Œå°†å¤§å¤§æå‡æ¨¡å‹æ•ˆç‡ã€‚å³ä½¿æ— æ³•å®Œå…¨å®ç°O(N)ï¼Œé€¼è¿‘è¿™ä¸€å¤æ‚åº¦ä¹Ÿæ˜¯ååˆ†æœ‰ä»·å€¼çš„ã€‚åœ¨è¿™ä¸€èƒŒæ™¯ä¸‹ï¼ŒFlash Attentionåº”è¿è€Œç”Ÿï¼Œæˆä¸ºè§£å†³è¯¥é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆã€‚</p><p>ä» Flash Attentionï¼ˆFast and Memory Efficient Exact Attention withIO-Awarenessï¼‰çš„å‘½åå¯è§å…¶ä¼˜åŠ¿ï¼š</p><ul><li>Fastï¼šåœ¨FlashAttentionä¹‹å‰ï¼Œä¹Ÿå‡ºç°è¿‡ä¸€äº›åŠ é€ŸTransformerè®¡ç®—çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•çš„ç€çœ¼ç‚¹æ˜¯â€œå‡å°‘è®¡ç®—é‡FLOPsâ€ï¼Œä¾‹å¦‚ç”¨ä¸€ä¸ªç¨€ç–attentionåšè¿‘ä¼¼è®¡ç®—ã€‚è€ŒFlashAttentionå‘ç°ï¼š<strong>è®¡ç®—æ…¢çš„å¡ç‚¹ä¸åœ¨è¿ç®—èƒ½åŠ›ï¼Œè€Œæ˜¯åœ¨è¯»å†™é€Ÿåº¦ä¸Šã€‚</strong>æ‰€ä»¥å®ƒé€šè¿‡é™ä½å¯¹æ˜¾å­˜ï¼ˆHBMï¼‰çš„è®¿é—®æ¬¡æ•°æ¥åŠ å¿«æ•´ä½“è¿ç®—é€Ÿåº¦ï¼Œè¿™ç§æ–¹æ³•åˆè¢«ç§°ä¸º<strong>O-Awareness</strong>ã€‚</li><li>Memory Efficientï¼šåœ¨ Flash Attention ä¸­ï¼Œå†…å­˜ä½¿ç”¨å‹åŠ›ä» O(NÂ²) é™è‡³O(N)ï¼Œæ˜¾è‘—èŠ‚çœå†…å­˜ã€‚</li><li>Exact Attentionï¼šä¸ç¨€ç– Attention ä¸åŒï¼ŒFlash Attentionå®Œå…¨ç­‰æ•ˆäºæ ‡å‡† Attentionã€‚</li></ul><h2 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</h2><h3 id="è®¡ç®—é™åˆ¶ä¸å†…å­˜é™åˆ¶">è®¡ç®—é™åˆ¶ä¸å†…å­˜é™åˆ¶</h3><h4 id="å—é™åŸå› åˆ†æ">å—é™åŸå› åˆ†æ</h4><p>é¦–å…ˆä»‹ç»å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ul><li><span class="math inline">\(\pi\)</span>ï¼š<strong>ç¡¬ä»¶ç®—åŠ›ä¸Šé™</strong>ï¼Œè¡¨ç¤ºä¸€ä¸ªè®¡ç®—å¹³å°åœ¨å…¨è´Ÿè·æƒ…å†µä¸‹æ¯ç§’èƒ½å¤Ÿæ‰§è¡Œçš„æµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼Œå•ä½ä¸ºFLOPSï¼ˆæµ®ç‚¹è¿ç®—æ¬¡æ•°æ¯ç§’ï¼‰ã€‚</li><li><span class="math inline">\(\beta\)</span>ï¼š<strong>ç¡¬ä»¶å¸¦å®½ä¸Šé™</strong>ï¼Œè¡¨ç¤ºä¸€ä¸ªè®¡ç®—å¹³å°åœ¨å…¨è´Ÿè·æƒ…å†µä¸‹æ¯ç§’èƒ½å¤Ÿå®Œæˆçš„æ•°æ®äº¤æ¢é‡ï¼Œå•ä½ä¸ºByte/sã€‚</li><li><span class="math inline">\(\pi_t\)</span>ï¼š<strong>æŸç®—æ³•æ‰€éœ€çš„æ€»è¿ç®—é‡</strong>ï¼Œå•ä½ä¸ºFLOPsã€‚ï¼ˆt è¡¨ç¤º totalï¼‰</li><li><span class="math inline">\(\beta_t\)</span>ï¼š<strong>æŸç®—æ³•æ‰€éœ€çš„æ€»æ•°æ®è¯»å–å’Œå­˜å‚¨é‡</strong>ï¼Œå•ä½ä¸ºByteã€‚</li></ul><blockquote><p>è¿™é‡Œå¼ºè°ƒä¸€ä¸‹å¯¹FLOPSå’ŒFLOPsçš„è§£é‡Šï¼š</p></blockquote><p>FLOPSï¼šç­‰åŒäºFLOP/sï¼Œè¡¨ç¤ºFloating Point Operations PerSecondï¼Œå³æ¯ç§’æ‰§è¡Œçš„æµ®ç‚¹æ•°æ“ä½œæ¬¡æ•°ï¼Œç”¨äºè¡¡é‡ç¡¬ä»¶è®¡ç®—æ€§èƒ½ã€‚</p><p>FLOPsï¼šè¡¨ç¤ºFloating PointOperationsï¼Œè¡¨ç¤ºæŸä¸ªç®—æ³•çš„æ€»è®¡ç®—é‡ï¼ˆå³æ€»æµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼‰ï¼Œç”¨äºè¡¡é‡ä¸€ä¸ªç®—æ³•çš„å¤æ‚åº¦ã€‚</p><p>åœ¨å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ—¶é—´ä¸ä»…æ¶ˆè€—åœ¨è®¡ç®—ä¸Šï¼Œä¹Ÿæ¶ˆè€—åœ¨æ•°æ®è¯»å–å’Œå­˜å‚¨ä¸Šã€‚å› æ­¤ï¼Œæˆ‘ä»¬å®šä¹‰ï¼š</p><ul><li><span class="math inline">\(T_{cal}\)</span>ï¼šç®—æ³•æ‰§è¡Œæ‰€éœ€çš„è®¡ç®—æ—¶é—´ï¼Œå…¶å…¬å¼ä¸º<span class="math inline">\(\pi_t / \pi\)</span>ã€‚</li><li><span class="math inline">\(T_{load}\)</span>ï¼šç®—æ³•æ‰§è¡Œæ‰€éœ€çš„æ•°æ®è¯»å–ä¸å­˜å‚¨æ—¶é—´ï¼Œå…¬å¼ä¸º<span class="math inline">\(\beta_t / \beta\)</span>ã€‚</li></ul><p>ç”±äºè®¡ç®—å’Œæ•°æ®ä¼ è¾“å¯ä»¥åŒæ—¶è¿›è¡Œï¼Œæˆ‘ä»¬å®šä¹‰ç®—æ³•çš„æ€»æ‰§è¡Œæ—¶é—´ï¼š<span class="math inline">\(T = max(T_{cal}, T_{load})\)</span></p><ul><li>å½“ <span class="math inline">\(T_{cal}&gt;T_{load}\)</span>æ—¶ï¼Œç®—æ³•çš„ç“¶é¢ˆåœ¨è®¡ç®—éƒ¨åˆ†ï¼Œç§°ä¸º<strong>è®¡ç®—é™åˆ¶ï¼ˆmath-boundï¼‰ã€‚</strong>æ­¤æ—¶ï¼Œ<span class="math inline">\(\pi_t / \pi &gt; \beta_t / \beta\)</span>ï¼Œå³<span class="math inline">\(\pi_t/\beta_t &gt; \pi/\beta\)</span>ã€‚</li><li>å½“ <span class="math inline">\(T_{cal}&lt;T_{load}\)</span>æ—¶ï¼Œç“¶é¢ˆåœ¨æ•°æ®è¯»å–éƒ¨åˆ†ï¼Œç§°ä¸º<strong>å†…å­˜é™åˆ¶</strong>ï¼ˆmemory-boundï¼‰ã€‚æ­¤æ—¶ï¼Œ<span class="math inline">\(\pi_t / \pi &lt; \beta_t / \beta\)</span>ï¼Œå³<span class="math inline">\(\pi_t/\beta_t &lt; \pi/\beta\)</span>ã€‚</li></ul><p>ç®—æ³•çš„<strong>è®¡ç®—å¼ºåº¦</strong>ï¼ˆOperational Intensityï¼‰å®šä¹‰ä¸º <span class="math inline">\(\pi_t/\beta_t\)</span>ï¼Œè¡¨ç¤ºæ¯ä¸ªæ•°æ®è¯»å–æ“ä½œå¯¹åº”çš„è®¡ç®—é‡ã€‚å½“ç®—æ³•çš„è®¡ç®—å¼ºåº¦è¶Šé«˜ï¼Œè¯´æ˜è®¡ç®—éƒ¨åˆ†çš„å·¥ä½œé‡è¶Šå¤§ï¼Œåä¹‹åˆ™è¯´æ˜æ•°æ®è¯»å–éƒ¨åˆ†çš„å·¥ä½œé‡è¶Šå¤§ã€‚</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨é‡‡ç”¨çš„ç¡¬ä»¶ä¸ºA100-40GBSXMï¼ŒåŒæ—¶é‡‡ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆå¯ç†è§£ä¸ºè®­ç»ƒè¿‡ç¨‹ä¸­çš„è®¡ç®—å’Œå­˜å‚¨éƒ½æ˜¯fp16å½¢å¼çš„ï¼Œä¸€ä¸ªå…ƒç´ å ç”¨2byteï¼‰ï¼Œåˆ™ï¼š<span class="math display">\[ \pi/\beta = 312*10^{12} / 1555*10^9 = 201FLOPs/Bytes \]</span></p><p>å¯¹äºä¸€ä¸ªæ¨¡å‹ï¼Œ<span class="math inline">\(Q, K \in \mathbb{R}^{n\times d}\)</span>ï¼Œå…¶ä¸­Nä¸ºåºåˆ—é•¿åº¦ï¼Œdä¸ºembedding dimã€‚ç°åœ¨è®¡ç®—<span class="math inline">\(S = QK^T\)</span>ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[\frac{\pi_t}{\beta_t} = \frac{2N^2d}{2Nd + 2Nd + 2N^2} = \frac{N^2d}{2Nd+ N^2}\]</span></p><p>ä¸‹è¡¨è®°å½•äº†ä¸åŒçš„Nï¼Œdä¸‹çš„å—é™ç±»å‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241207024735.png"></p><p>æ ¹æ®è¿™ä¸ªè¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥æ¥åšä¸‹æ€»ç»“ï¼š -è®¡ç®—é™åˆ¶ï¼ˆmath-boundï¼‰ï¼šå¤§çŸ©é˜µä¹˜æ³•ï¼ˆNå’Œdéƒ½éå¸¸å¤§ï¼‰ã€é€šé“æ•°å¾ˆå¤§çš„å·ç§¯è¿ç®—ã€‚ç›¸å¯¹è€Œè¨€ï¼Œè¯»å¾—å¿«ï¼Œç®—å¾—æ…¢ã€‚-å†…å­˜é™åˆ¶ï¼ˆmemory-boundï¼‰ï¼šé€ç‚¹è¿ç®—æ“ä½œã€‚ä¾‹å¦‚ï¼šæ¿€æ´»å‡½æ•°ã€dropoutã€maskã€softmaxã€BNå’ŒLNã€‚ç›¸å¯¹è€Œè¨€ï¼Œç®—å¾—å¿«ï¼Œè¯»å¾—æ…¢ã€‚</p><p>æ‰€ä»¥ï¼Œâ€œTransformerè®¡ç®—å—é™äºæ•°æ®è¯»å–â€ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œè¦ç»¼åˆç¡¬ä»¶æœ¬èº«å’Œæ¨¡å‹å¤§å°æ¥ç»¼åˆåˆ¤æ–­ã€‚ä½†ä»è¡¨ä¸­çš„ç»“æœæˆ‘ä»¬å¯çŸ¥ï¼Œmemory-boundçš„æƒ…å†µè¿˜æ˜¯æ™®éå­˜åœ¨çš„ï¼Œæ‰€ä»¥Flashattentionçš„æ”¹è¿›æ€æƒ³åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ä¾ç„¶é€‚ç”¨ã€‚</p><p>åœ¨Flashattentionä¸­ï¼Œ<strong>è®¡ç®—æ³¨æ„åŠ›çŸ©é˜µæ—¶çš„softmaxè®¡ç®—å°±å—åˆ°äº†å†…å­˜é™åˆ¶ï¼Œè¿™ä¹Ÿæ˜¯flashattentionçš„é‡ç‚¹ä¼˜åŒ–å¯¹è±¡</strong>ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹æ–‡æ¥è¯¦ç»†çœ‹è¿™ä¸€ç‚¹ã€‚</p><h4 id="roof-line-æ¨¡å‹">roof-line æ¨¡å‹</h4><p>ä¸€ä¸ªç®—æ³•è¿è¡Œçš„æ•ˆç‡æ˜¯ç¦»ä¸å¼€ç¡¬ä»¶æœ¬èº«çš„ã€‚æˆ‘ä»¬å¾€å¾€æƒ³çŸ¥é“ï¼šå¯¹äºä¸€ä¸ªè¿ç®—é‡ä¸º<span class="math inline">\(\pi_t\)</span>ï¼Œæ•°æ®è¯»å–å­˜å‚¨é‡ä¸º <span class="math inline">\(\beta_t\)</span> çš„ç®—æ³•ï¼Œå®ƒåœ¨ç®—åŠ›ä¸Šé™ä¸º <span class="math inline">\(\pi\)</span>ï¼Œå¸¦å®½ä¸Šé™ä¸º <span class="math inline">\(\beta\)</span> çš„ç¡¬ä»¶ä¸Šï¼Œèƒ½è¾¾åˆ°çš„æœ€å¤§æ€§èƒ½ <span class="math inline">\(P\)</span>ï¼ˆAttanable Performanceï¼‰æ˜¯å¤šå°‘ï¼Ÿ</p><p>è¿™é‡Œæœ€å¤§æ€§èƒ½ <span class="math inline">\(P\)</span>æŒ‡çš„æ˜¯å½“å‰ç®—æ³•å®é™…è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šæ—¶ï¼Œæ¯ç§’æœ€å¤šèƒ½è¾¾åˆ°çš„è®¡ç®—æ¬¡æ•°ï¼Œå•ä½æ˜¯FLOP/sã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241207025413.png"></p><p>ä»å›¾ä¸­å¯ä»¥ç›´è§‚çš„çœ‹å‡ºï¼Œå½“è®¡ç®—å¼ºåº¦è¾¾åˆ°äº†ç¡¬ä»¶çš„ä¸Šé™æ—¶ï¼Œç®—æ³•çš„æ€§èƒ½è¾¾åˆ°æœ€å¤§å€¼ã€‚è€Œåœ¨ä¹‹å‰çš„è®¡ç®—å¼ºåº¦èŒƒå›´å†…ï¼Œéƒ½å±äºå†…å­˜é™åˆ¶ã€‚</p><h3 id="gpuå­˜å‚¨ä¸è®¡ç®—">GPUå­˜å‚¨ä¸è®¡ç®—</h3><h4 id="gpuå­˜å‚¨åˆ†ç±»">GPUå­˜å‚¨åˆ†ç±»</h4><p>é€šå¸¸ï¼ŒGPU å­˜å‚¨åˆ†ä¸ºç‰‡ä¸Šå†…å­˜ï¼ˆon-chip memoryï¼‰å’Œç‰‡ä¸‹å†…å­˜ï¼ˆoff-chipmemoryï¼‰ï¼Œè¿™ä¸»è¦å–å†³äºå­˜å‚¨å•å…ƒæ˜¯å¦ä½äºèŠ¯ç‰‡å†…éƒ¨ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241207030019.png"></p><ul><li><strong>ç‰‡ä¸Šå†…å­˜</strong>ï¼šç”¨äºç¼“å­˜ç­‰ï¼Œå®¹é‡å°ä½†å¸¦å®½æé«˜ã€‚å¦‚ä¸Šå›¾ä¸­çš„<strong>SRAM</strong>ï¼Œå®¹é‡ä»… 20MBï¼Œå¸¦å®½å´è¾¾ 19TB/sã€‚</li><li><strong>ç‰‡ä¸‹å†…å­˜</strong>ï¼šç”¨äºå…¨å±€å­˜å‚¨ï¼ˆå³æ˜¾å­˜ï¼‰ï¼Œå®¹é‡å¤§ä½†å¸¦å®½ç›¸å¯¹è¾ƒå°ã€‚å¦‚HBMï¼Œå®¹é‡å¯è¾¾ 40GBï¼Œå¸¦å®½ä¸º 1.5TB/sã€‚</li></ul><h4 id="gpuçš„è®¡ç®—">GPUçš„è®¡ç®—</h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md/20240826055530.png">å¦‚å›¾ï¼Œè´Ÿè´£GPUè®¡ç®—çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶å«SMï¼ˆStreamingMultiprocessorsï¼Œæµå¼å¤šå¤„ç†å™¨ï¼‰ï¼Œå¯ä»¥å°†å…¶ç†è§£æˆGPUçš„è®¡ç®—å•å…ƒï¼Œä¸€ä¸ªSMåˆå¯ä»¥ç”±è‹¥å¹²ä¸ªSMPï¼ˆSMPartitionï¼‰ç»„æˆï¼Œä¾‹å¦‚å›¾ä¸­å°±ç”±4ä¸ªSMPç»„æˆã€‚SMå°±å¥½æ¯”CPUä¸­çš„ä¸€ä¸ªæ ¸ï¼Œä½†ä¸åŒçš„æ˜¯ä¸€ä¸ªCPUæ ¸ä¸€èˆ¬è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä¸€ä¸ªSMå´å¯ä»¥è¿è¡Œå¤šä¸ªè½»é‡çº§çº¿ç¨‹ï¼ˆç”±WarpScheduleræ§åˆ¶ï¼Œä¸€ä¸ªWarp Schedulerä¼šæŠ“ä¸€æŸçº¿ç¨‹ï¼ˆ32ä¸ªï¼‰æ”¾å…¥cudacoreï¼ˆå›¾ä¸­ç»¿è‰²å°å—ï¼‰ä¸­è¿›è¡Œè®¡ç®—ï¼‰ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†GPUçš„è®¡ç®—æ ¸å¿ƒSMåŠä¸åŒå±‚çº§GPUå­˜å‚¨ç»“æ„ç»¼åˆèµ·æ¥ï¼Œç»˜åˆ¶ä¸€å¼ ç®€åŒ–å›¾ï¼š<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241207030737.png">- HBM2ï¼šå³æ˜¯æˆ‘ä»¬çš„æ˜¾å­˜ã€‚ - L1ç¼“å­˜/sharedmemoryï¼šæ¯ä¸ªSMéƒ½æœ‰è‡ªå·±çš„L1ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨SMå†…çš„æ•°æ®ï¼Œè¢«SMå†…æ‰€æœ‰çš„cudacoreså…±äº«ã€‚SMé—´ä¸èƒ½äº’ç›¸è®¿é—®å½¼æ­¤çš„L1ã€‚NV Voltaæ¶æ„åï¼ŒL1å’Œsharedmemoryåˆå¹¶ï¼ˆVoltaæ¶æ„å‰åªæœ‰Kepleråšè¿‡åˆå¹¶ï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†è¿›ä¸€æ­¥é™ä½å»¶è¿Ÿã€‚åˆå¹¶è¿‡åï¼Œç”¨æˆ·èƒ½å†™ä»£ç ç›´æ¥æ§åˆ¶çš„ä¾ç„¶æ˜¯sharedmemoryï¼ŒåŒæ—¶å¯æ§åˆ¶ä»L1ä¸­åˆ†é…å¤šå°‘å­˜å‚¨ç»™shared memoryã€‚<strong>Flashattentionä¸­SRAMæŒ‡çš„å°±æ˜¯L1 cache/shared memory</strong>ã€‚ -L2ç¼“å­˜ï¼šæ‰€æœ‰SMå…±äº«L2ç¼“å­˜ã€‚L2ç¼“å­˜ä¸ç›´æ¥ç”±ç”¨æˆ·ä»£ç æ§åˆ¶ã€‚L1/L2ç¼“å­˜çš„å¸¦å®½éƒ½è¦æ¯”æ˜¾å­˜çš„å¸¦å®½è¦å¤§ï¼Œä¹Ÿå°±æ˜¯è¯»å†™é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å®ƒä»¬çš„å­˜å‚¨é‡æ›´å°ã€‚</p><p>GPU çš„è®¡ç®—æµç¨‹å¯ä»¥ç†è§£ä¸ºï¼šæ•°æ®ä»æ˜¾å­˜ï¼ˆHBMï¼‰åŠ è½½åˆ°ç‰‡ä¸Šå†…å­˜ï¼ˆSRAMï¼‰ï¼Œç”±SMï¼ˆStreaming Multiprocessorï¼‰è¯»å–å¹¶è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—ç»“æœå†é€šè¿‡ SRAMè¿”å›æ˜¾å­˜ã€‚å…·ä½“å¯å‚è€ƒï¼š<a href="https://www.yidoo.xyz/nvidia-gpu-principles">NVIDIA GPUåŸç†è¯¦è§£</a>ã€‚</p><p>æ˜¾å­˜å¸¦å®½è¿œä½äºSRAMï¼Œå› æ­¤ä»æ˜¾å­˜è¯»å–æ•°æ®å¾€å¾€è¾ƒè€—æ—¶ã€‚ä¸ºäº†ä¼˜åŒ–è¯»å–æ•ˆç‡ï¼Œæˆ‘ä»¬ä¼š<strong>å°½é‡å°†æ•°æ®å¡«æ»¡SRAMï¼Œä»è€Œå‡å°‘é¢‘ç¹è¯»å–</strong>ã€‚</p><h4 id="kernel-fusion">kernel fusion</h4><p>ä¸ºå‡å°‘æ˜¾å­˜è¯»å–æ¬¡æ•°ï¼Œè‹¥ SRAMå®¹é‡å…è®¸ï¼Œå¤šä¸ªè®¡ç®—æ­¥éª¤å¯åˆå¹¶åœ¨ä¸€æ¬¡æ•°æ®åŠ è½½ä¸­å®Œæˆã€‚è¿™è¢«ç§°ä¸ºkernelèåˆã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ç°åœ¨è¦åšè®¡ç®—Aå’Œè®¡ç®—Bã€‚åœ¨è€æ–¹æ³•é‡Œï¼Œæˆ‘åšå®ŒAåå¾—åˆ°ä¸€ä¸ªä¸­é—´ç»“æœï¼Œå†™å›æ˜¾å­˜ï¼Œç„¶åå†ä»æ˜¾å­˜ä¸­æŠŠè¿™ä¸ªç»“æœåŠ è½½åˆ°SRAMï¼Œåšè®¡ç®—Bã€‚ä½†æ˜¯ç°åœ¨æˆ‘å‘ç°SRAMå®Œå…¨æœ‰èƒ½åŠ›å­˜ä¸‹æˆ‘çš„ä¸­é—´ç»“æœï¼Œé‚£æˆ‘å°±å¯ä»¥æŠŠAå’ŒBæ”¾åœ¨ä¸€èµ·åšäº†ï¼Œè¿™æ ·å°±èƒ½èŠ‚çœå¾ˆå¤šè¯»å–æ—¶é—´ï¼Œæˆ‘ä»¬ç®¡è¿™æ ·çš„æ“ä½œå«kernelèåˆã€‚</p><p>å¯¹äºkernelå¯ä»¥ç²—çŠ·åœ°ç†è§£æˆæ˜¯â€œå‡½æ•°â€ï¼Œå®ƒåŒ…å«å¯¹çº¿ç¨‹ç»“æ„ï¼ˆgrid-block-threadï¼‰çš„å®šä¹‰ï¼Œä»¥åŠç»“æ„ä¸­å…·ä½“è®¡ç®—é€»è¾‘çš„å®šä¹‰ã€‚ç†è§£åˆ°è¿™ä¸€å±‚å·²ä¸å¦¨ç¢æˆ‘ä»¬å¯¹flashattentionçš„è§£è¯»äº†ï¼Œæƒ³è¦æ›´è¿‘ä¸€æ­¥äº†è§£çš„æœ‹å‹ï¼Œæ¨èé˜…è¯»è¿™ç¯‡<a href="https://zhuanlan.zhihu.com/p/34587739">å°å°å°†ï¼šCUDAç¼–ç¨‹å…¥é—¨æç®€æ•™ç¨‹</a>ã€‚</p><h3 id="æ ‡å‡†attentionè®¡ç®—">æ ‡å‡†Attentionè®¡ç®—</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208192423.png">å…¶ä¸­ï¼Œ <span class="math inline">\(S=QK^T,P=softmax(S)\)</span>ã€‚åœ¨GPTç±»çš„æ¨¡å‹ä¸­ï¼Œè¿˜éœ€è¦å¯¹<span class="math inline">\(P\)</span>åšmaskå¤„ç†ã€‚ä¸ºäº†è¡¨è¾¾æ–¹ä¾¿ï¼Œè¯¸å¦‚maskã€dropoutä¹‹ç±»çš„æ“ä½œï¼Œæˆ‘ä»¬éƒ½å¿½ç•¥æ‰ï¼Œä¸‹æ–‡ä¹Ÿæ˜¯åŒç†ã€‚</p><h3 id="æ ‡å‡†safe-softmax">æ ‡å‡†safe softmax</h3><p>åœ¨<span class="math inline">\(softmax(x_i) =\frac{e^{x_i}}{\sum_{j=1}^d e^{x_j}}\)</span>çš„è®¡ç®—ä¸­ï¼Œå¦‚æœ<span class="math inline">\(x_i\)</span>çš„å€¼å¾ˆå¤§ï¼Œé‚£ä¹ˆ<span class="math inline">\(e^{x_i}\)</span>ä¼šå˜å¾—éå¸¸å¤§ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æ•°å€¼æº¢å‡ºã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹<span class="math inline">\(x_i\)</span>åšä¸€ä¸ªå¹³ç§»ï¼Œå³<span class="math inline">\(x_i - max(x)\)</span>ï¼Œè¿™æ ·å°±èƒ½ä¿è¯<span class="math inline">\(e^{x_i}\)</span>ä¸ä¼šæº¢å‡ºã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†safe softmaxçš„è¿‡ç¨‹ï¼Œè¿™é‡Œ <span class="math inline">\(\tilde{P}, P\)</span>åˆ†åˆ«è¡¨ç¤ºå¹³ç§»å‰åçš„softmaxç»“æœã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208194350.png"></p><h2 id="flash-attention">Flash Attention</h2><h3 id="flash-attentionçš„æ ¸å¿ƒæ€æƒ³">Flash Attentionçš„æ ¸å¿ƒæ€æƒ³</h3><ul><li><strong>åˆ†å—è®¡ç®—</strong>ï¼šå°†è¾“å…¥çŸ©é˜µåˆ’åˆ†ä¸ºå°å—ï¼Œå¹¶é€å—åœ¨ SRAMä¸Šè®¡ç®—æ³¨æ„åŠ›ï¼Œé¿å…å°†æ•´ä¸ª NÃ—N çŸ©é˜µå­˜å‚¨äºæ˜¾å­˜ã€‚</li><li><strong>é‡è®¡ç®—</strong>ï¼šé€šè¿‡å‰å‘ä¼ æ’­æ—¶ä¿å­˜å½’ä¸€åŒ–å› å­ï¼Œé¿å…åœ¨åå‘ä¼ æ’­ä¸­å­˜å‚¨ä¸­é—´ç»“æœï¼Œè€Œæ˜¯é€šè¿‡é‡è®¡ç®—å¾—å‡ºæ³¨æ„åŠ›çŸ©é˜µã€‚è¿™è™½ç„¶å¢åŠ äº†æµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼Œä½†é€šè¿‡å‡å°‘HBM è®¿é—®ï¼Œæå‡äº†æ•´ä½“æ•ˆç‡ã€‚</li></ul><h3 id="å‰å‘è®¡ç®—">å‰å‘è®¡ç®—</h3><h4 id="åˆ†å—è®¡ç®—tiling">åˆ†å—è®¡ç®—tiling</h4><p>æˆ‘ä»¬å…ˆæ¥äº†è§£åˆ†å—è®¡ç®—çš„æ•´ä½“æµç¨‹ï¼ˆå¸®åŠ©å¤§å®¶ç†è§£æ•°æ®å—æ˜¯æ€ä¹ˆæµè½¬çš„ï¼‰ï¼Œç„¶åæˆ‘ä»¬å†é’ˆå¯¹å…¶ä¸­çš„ç»†èŠ‚åšä¸€ä¸€è®²è§£ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208195502.png"></p><p>åœ¨è®¡ç®—è¿™äº›åˆ†å—æ—¶ï¼ŒGPUæ˜¯å¯ä»¥åšå¹¶è¡Œè®¡ç®—çš„ï¼Œè¿™ä¹Ÿæå‡äº†è®¡ç®—æ•ˆç‡ã€‚</p><p>å¥½ï¼ç°åœ¨ä½ å·²ç»çŸ¥é“äº†å•å—çš„è®¡ç®—æ–¹å¼ï¼Œç°åœ¨è®©æˆ‘ä»¬æŠŠæ•´ä¸ªæµç¨‹æµè½¬èµ·æ¥æŠŠã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æ³¨æ˜äº†j æ˜¯å¤–å¾ªç¯ï¼Œ iæ˜¯å†…å¾ªç¯ï¼Œåœ¨è®ºæ–‡é‡Œï¼Œåˆç§°ä¸ºKï¼ŒVæ˜¯å¤–å¾ªç¯ï¼ŒQæ˜¯å†…å¾ªç¯ã€‚å†™æˆä»£ç å°±æ˜¯:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"># ---------------------# Tc: Kå’ŒVçš„åˆ†å—æ•°# Tr: Qçš„åˆ†å—æ•°é‡# ---------------------for 1 &lt;= j &lt;= Tc:    for 1 &lt;= i &lt;= Tr:        do....</code></pre><p></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208201454.png"><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208201509.png"></p><p>è¿™é‡Œçš„ <span class="math inline">\(O\)</span>è¿˜éœ€è¦ç»è¿‡ä¸€å®šçš„å¤„ç†ï¼Œæ‰èƒ½å’Œä¸åˆ†å—åœºæ™¯ä¸‹çš„ <span class="math inline">\(O\)</span>å®Œå…¨ç­‰ä»·ã€‚è¿™é‡Œæˆ‘ä»¬å°†æ¯ä¸€å—çš„ <span class="math inline">\(O\)</span>å•ç‹¬ç”»å‡ºï¼Œæ˜¯ä¸ºäº†å¸®åŠ©å¤§å®¶æ›´å¥½ç†è§£åˆ†å—è®¡ç®—çš„æ•´ä½“æµç¨‹ï¼Œä¸ä»£è¡¨å®ƒæ˜¯æœ€ç»ˆçš„è¾“å‡ºç»“æœã€‚</p><h4 id="tiliingä¸­çš„safe-softmax">tiliingä¸­çš„safe softmax</h4><p>å›é¡¾ä¹‹å‰ç»˜åˆ¶çš„æ ‡å‡†safe softmaxæµç¨‹å›¾ï¼Œæˆ‘ä»¬çŸ¥é“mã€léƒ½æ˜¯é’ˆå¯¹å®Œæ•´çš„ä¸€è¡Œåšrowmaxã€rowsumåçš„ç»“æœï¼Œé‚£ä¹ˆåœ¨åˆ†å—åœºæ™¯ä¸‹ï¼Œä¼šå˜æˆä»€ä¹ˆæ ·å‘¢ï¼Ÿ<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241208201852.png">ä»¥ä¸Šå›¾çº¢åœˆå†…çš„æ•°æ®ä¸ºä¾‹ï¼Œåœ¨æ ‡å‡†åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¯¹çº¢åœˆå†…çš„æ¯ä¸€è¡Œåšrowmaxã€rowsumåå¾—åˆ°<span class="math inline">\(\tilde{P}\)</span>çš„ã€‚è€Œåˆ†å—åè¿™éƒ¨åˆ†æ•°æ®ä¼šè¢«åˆ†åˆ°ä¸åŒçš„å—ä¸­ã€‚</p><p>æ‰€ä»¥Flash Attentionä¸­é‡‡ç”¨å¦‚ä¸‹æ–¹å¼å®ç°safe softmaxï¼š</p><ol type="1"><li><p>æˆ‘ä»¬å‡è®¾æ ‡å‡†åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(S\)</span>çŸ©é˜µæŸä¸€è¡Œçš„å‘é‡ä¸º <span class="math inline">\(x = [x_1, x_2, \dots,x_d]\)</span>ï¼Œå› ä¸ºåˆ†å—çš„åŸå› ï¼Œ å®ƒè¢«æˆ‘ä»¬åˆ‡æˆäº†ä¸¤éƒ¨åˆ† <span class="math inline">\(x = \begin{bmatrix} x^{(1)}, x^{(2)}\end{bmatrix}\)</span>ã€‚</p></li><li><p>æˆ‘ä»¬å®šä¹‰ï¼š</p></li></ol><ul><li><span class="math inline">\(m(x)\)</span>ï¼šæ ‡å‡†åœºæ™¯ä¸‹ï¼Œè¯¥è¡Œçš„å…¨å±€æœ€å¤§å€¼</li><li><span class="math inline">\(m(x^{(1)})\)</span>ï¼šåˆ†å—1çš„å…¨å±€æœ€å¤§å€¼</li><li><span class="math inline">\(m(x^{(2)})\)</span>ï¼šåˆ†å—2çš„å…¨å±€æœ€å¤§å€¼</li></ul><p>é‚£ä¹ˆæ˜“çŸ¥ï¼š <span class="math inline">\(m(x) = m\left( \begin{bmatrix}x^{(1)}, x^{(2)} \end{bmatrix} \right) = \max \left( m(x^{(1)}),m(x^{(2)}) \right)\)</span></p><ol start="3" type="1"><li>æˆ‘ä»¬å®šä¹‰ï¼š</li></ol><ul><li><span class="math inline">\(f(x)\)</span>ï¼šæ ‡å‡†åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\exp(x - m(x))\)</span> çš„ç»“æœ</li><li><span class="math inline">\(f(x^{(1)})\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\exp(x^{(1)} - m(x^{(1)}))\)</span> çš„ç»“æœ</li><li><span class="math inline">\(f(x^{(2)})\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\exp(x^{(2)} - m(x^{(2)}))\)</span> çš„ç»“æœ</li></ul><p>é‚£ä¹ˆæ˜“çŸ¥ï¼š<span class="math inline">\(f(x) = \left[ e^{m(x^{(1)}) -m(x)} f(x^{(1)}), e^{m(x^{(2)}) - m(x)} f(x^{(2)}) \right]\)</span></p><p>è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œè¯¦ç»†çš„è¯æ˜è¿‡ç¨‹å°±ä¸å†™äº†ã€‚</p><ol start="4" type="1"><li>æˆ‘ä»¬å®šä¹‰ï¼š</li></ol><ul><li><span class="math inline">\(l(x)\)</span>ï¼šæ ‡å‡†åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\text{rowsum}[f(x)]\)</span> çš„ç»“æœ</li><li><span class="math inline">\(l(x^{(1)})\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\text{rowsum}[f(x^{(1)})]\)</span> çš„ç»“æœ</li><li><span class="math inline">\(l(x^{(2)})\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\text{rowsum}[f(x^{(2)})]\)</span> çš„ç»“æœ</li></ul><p>é‚£ä¹ˆç”±ï¼ˆ3ï¼‰æ˜“çŸ¥ï¼š<span class="math inline">\(l(x) = e^{m(x^{(1)}) -m(x)} l(x^{(1)}) + e^{m(x^{(2)}) - m(x)} l(x^{(2)})\)</span></p><ol start="5" type="1"><li>ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨åˆ†å—è®¡ç®—çš„ç»“æœï¼Œæ¥è¡¨ç¤ºæ ‡å‡†åœºæ™¯ä¸‹ safe softmaxçš„ç»“æœäº†ï¼š <span class="math display">\[softmax(x) = \frac{f(x)}{l(x)} =\frac{\left[e^{m(x^{(1)}) - m(x)} f(x^{(1)}), e^{m(x^{(2)}) - m(x)}f(x^{(2)})\right]}{e^{m(x^{(1)}) - m(x)} l(x^{(1)}) + e^{m(x^{(2)}) -m(x)} l(x^{(2)})}\]</span></li></ol><p>æˆ‘ä»¬é…åˆä¸Šé¢çš„å›¾ä¾‹å’Œflashattentionè®ºæ–‡ä¸­çš„ä¼ªä»£ç ï¼Œå†æ¥è¿›ä¸€æ­¥ç†è§£ä¸€ä¸‹åˆ†å—è®¡ç®—safesoftmaxçš„ï¼ˆ1ï¼‰ï½ï¼ˆ5ï¼‰æ­¥éª¤ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209021146.png"></p><p>æˆ‘ä»¬ç”¨ <span class="math inline">\(S_{00}\)</span>ï¼ˆå›¾ä¸­æµ…ç»¿è‰²æ–¹å—ï¼‰æ›¿æ¢æ‰ï¼ˆ1ï¼‰<span class="math inline">\(\sim\)</span>ï¼ˆ5ï¼‰æ­¥éª¤ä¸­çš„ <span class="math inline">\(x^{(1)}\)</span>ï¼Œç”¨ <span class="math inline">\(S_{01}\)</span>ï¼ˆå›¾ä¸­æ·±ç»¿è‰²æ–¹å—ï¼‰æ›¿æ¢æ‰ <span class="math inline">\(x^{(2)}\)</span>ã€‚æˆ‘ä»¬å…³æ³¨ç‚¹åœ¨ä¼ªä»£ç éƒ¨åˆ†çš„ 6 <span class="math inline">\(\sim\)</span> 11 è¡Œã€‚</p><p>ç”±äºä¼ªä»£ç ä¸­çš„è¡¨è¾¾ç¬¦å·è¾ƒå¤šï¼Œå®¹æ˜“é˜»ç¢å¤§å®¶çš„ç†è§£ï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ˜ç¡®å„ä¸ªæ•°å­¦ç¬¦å·è¡¨è¾¾çš„å«ä¹‰ï¼š</p><ul><li><span class="math inline">\(S_{ij}\)</span>ï¼šå¯¹åº”åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œå°±æ˜¯ <span class="math inline">\(S_{00}\)</span> å’Œ <span class="math inline">\(S_{01}\)</span>ï¼Œå³ <span class="math inline">\(Q_i K_j^\top\)</span> çš„ç»“æœã€‚</li><li><span class="math inline">\(m_{ij}\)</span>ï¼šå¯¹äºå½“å‰åˆ†å— <span class="math inline">\(S_{ij}\)</span>æ¥è¯´ï¼Œæ¯è¡Œçš„å±€éƒ¨æœ€å¤§å€¼ã€‚ç›¸å½“äºå‰é¢æ­¥éª¤ï¼ˆ2ï¼‰ä¸­å¯¹ <span class="math inline">\(m(x^{(1)})\)</span>, <span class="math inline">\(m(x^{(2)})\)</span> çš„å®šä¹‰ã€‚</li><li><span class="math inline">\(\tilde{P}_{ij}\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œå„å—çš„ <span class="math inline">\(p\)</span>çŸ©é˜µï¼ˆå½’ä¸€åŒ–å‰ï¼‰ç»“æœã€‚ç›¸å½“äºæ­¥éª¤ï¼ˆ3ï¼‰ä¸­å¯¹ <span class="math inline">\(f(x^{(1)})\)</span>, <span class="math inline">\(f(x^{(2)})\)</span> çš„å®šä¹‰ã€‚</li><li><span class="math inline">\(l_{ij}\)</span>ï¼šåˆ†å—åœºæ™¯ä¸‹ï¼Œ<span class="math inline">\(\text{rowsum}\)</span> çš„ç»“æœã€‚ç›¸å½“äºæ­¥éª¤ï¼ˆ4ï¼‰ä¸­å¯¹<span class="math inline">\(l(x^{(1)})\)</span>, <span class="math inline">\(l(x^{(2)})\)</span> çš„å®šä¹‰ã€‚</li><li><span class="math inline">\(m\)</span>ï¼šæ ‡å‡†åœºæ™¯ä¸‹ï¼Œå¯¹ <span class="math inline">\(S\)</span>çŸ©é˜µè€Œè¨€ï¼Œæ¯è¡Œçš„æœ€å¤§å€¼ï¼Œè¿™é‡Œæ˜¯å…¨å±€æœ€å¤§å€¼ï¼ˆ<span class="math inline">\(m\)</span> é¦–æ¬¡å®šä¹‰åœ¨ä¼ªä»£ç ç¬¬ 2è¡Œï¼‰ï¼Œç›¸å½“äºå‰é¢æ­¥éª¤ï¼ˆ2ï¼‰ä¸­å¯¹ <span class="math inline">\(m(x)\)</span>çš„å®šä¹‰ã€‚</li><li><span class="math inline">\(l\)</span>ï¼šæ ‡å‡†åœºæ™¯ä¸‹ï¼Œå…¨å±€ <span class="math inline">\(\text{rowsum}\)</span> çš„ç»“æœï¼ˆ<span class="math inline">\(l\)</span> é¦–æ¬¡å®šä¹‰åœ¨ä¼ªä»£ç ç¬¬ 2è¡Œï¼‰ï¼Œç›¸å½“äºå‰é¢æ­¥éª¤ï¼ˆ4ï¼‰ä¸­å¯¹ <span class="math inline">\(l(x)\)</span>çš„å®šä¹‰ã€‚</li><li><span class="math inline">\(m_i\)</span>ï¼šè¡¨ç¤º <span class="math inline">\(\max(m_{i0}, m_{i1}, \dots,m_{i(j-1)})\)</span>ã€‚å¦‚æœå½“å‰åˆ†å—æ˜¯ <span class="math inline">\(S_{ij}\)</span>ï¼Œåˆ™ <span class="math inline">\(m_i\)</span> è¡¨ç¤ºå›ºå®š <span class="math inline">\(i\)</span> æ—¶ï¼Œå‰ <span class="math inline">\(j -1\)</span> ä¸ªåˆ†å—ä¸­çš„å±€éƒ¨æœ€å¤§å€¼ã€‚å®¹æ˜“æ¨å‡ºï¼Œå½“å›ºå®š <span class="math inline">\(i\)</span>ï¼Œéå†å®Œæˆ <span class="math inline">\(S_{00}, S_{01}\)</span> åï¼Œ<span class="math inline">\(m_i\)</span> çš„ç»“æœå°±æ˜¯å…¨å±€æœ€å¤§å€¼ <span class="math inline">\(m_0\)</span>ã€‚</li><li><span class="math inline">\(m_i^{\text{new}}\)</span>ï¼šè¡¨ç¤º <span class="math inline">\(\max(m_{i0}, m_{i1}, \dots, m_{i(j-1)},m_{ij})\)</span>ã€‚å¦‚æœå½“å‰åˆ†å—ä¸º <span class="math inline">\(S_{ij}\)</span>ï¼Œåˆ™ <span class="math inline">\(m_i^{\text{new}}\)</span> è¡¨ç¤ºå›ºå®š <span class="math inline">\(i\)</span>æ—¶ï¼Œæˆªæ­¢åˆ°å½“å‰åˆ†å—ä¸ºæ­¢çš„å±€éƒ¨æœ€å¤§å€¼ã€‚</li><li><span class="math inline">\(l_i\)</span>ï¼šå’Œ <span class="math inline">\(m_i^{\text{new}}\)</span>å¯¹åº”ï¼Œç›¸å½“äºæ­¥éª¤ï¼ˆ4ï¼‰ä¸­ç”¨åˆ†å—æ›´æ–° <span class="math inline">\(l(x)\)</span> çš„æ­¥éª¤ã€‚</li><li><span class="math inline">\(l_i\)</span>ï¼šå’Œ <span class="math inline">\(m_i\)</span> åŒç†ï¼Œå³å½“æˆ‘ä»¬å°† <span class="math inline">\(j\)</span> éå†å®Œåï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°é’ˆå¯¹ <span class="math inline">\(i\)</span> çš„å…¨å±€ rowmax å’Œå…¨å±€ rowsumã€‚</li></ul><p>è€Œæ ¹æ®å‰é¢çš„å®šä¹‰ï¼Œ<span class="math inline">\(m_i^{\text{new}}\)</span> å’Œ <span class="math inline">\(l_i^{\text{new}}\)</span> æ˜¯éå†å®Œæˆæœ€æ–°çš„ <span class="math inline">\(S_{ij}\)</span> åå¾—åˆ°çš„ rowmax å’Œ rowsum ç»“æœï¼Œæ‰€ä»¥æ¯éå†å®Œä¸€å— <span class="math inline">\(S_{ij}\)</span>ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ªä»£ç çš„ç¬¬ 13è¡Œï¼Œåšä¸€æ¬¡æ›´æ–°ã€‚</p><p>ä»ä¼ªä»£ç  5-13 è¡Œä¸­ï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ <span class="math inline">\(m_i, l_i, O_i\)</span> è¢«ä» on-chip çš„ SRAMä¸­å†™å›åˆ°æ˜¾å­˜ï¼ˆHBMï¼‰ä¸­ã€‚ æŠŠ <span class="math inline">\(i\)</span>éƒ½éå†å®Œæˆåï¼Œè¯»å†™é‡ä¹Ÿä¸è¿‡æ˜¯ <span class="math inline">\(m, l,O\)</span>ã€‚ç›¸æ¯”äºæ ‡å‡†åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è¦è¯»å†™çš„æ˜¯ <span class="math inline">\(S, P,O\)</span>ï¼Œè¯»å†™é‡æ˜¯ä¸æ˜¯ä¸€ä¸‹å°±å°‘å¾ˆå¤šï¼Œè¿™ä¸å°±èƒ½è§£å†³ memory-boundçš„é—®é¢˜äº†å—ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>åˆ†å—è®¡ç®— safe softmax çš„æ„ä¹‰ï¼Œå°±æ˜¯æŠ¹å»å¯¹ <span class="math inline">\(S, P\)</span> çš„è¯»å†™</strong>ã€‚</p><h4 id="åˆ†å—è®¡ç®—ä¸­çš„o">åˆ†å—è®¡ç®—ä¸­çš„<span class="math inline">\(O\)</span></h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209024821.png">ä¸Šå›¾ä¸­ç”»çš„6ä¸ª<span class="math inline">\(O\)</span>å¹¶ä¸æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ç»“æœã€‚æˆ‘ä»¬æœŸæœ›ç»´æŠ¤å¹¶æ›´æ–°<span class="math inline">\(O_i\)</span>ï¼Œå½“è¯¥ <span class="math inline">\(i\)</span>ä¸‹çš„æ‰€æœ‰ <span class="math inline">\(j\)</span> éå†å®Œæ¯•åï¼Œæˆ‘ä»¬çš„ <span class="math inline">\(O_i\)</span>å°±åº”è¯¥å’Œæ ‡å‡†åœºæ™¯ä¸‹çš„ <span class="math inline">\(O_i\)</span>å®Œå…¨ç›¸ç­‰ã€‚</p><p>åœ¨å›¾ä¸­ï¼Œ<span class="math inline">\(O_i\)</span>åº”è¯¥æ˜¯çº¢åœˆéƒ¨åˆ†çš„ä¹˜ç§¯ï¼Œä½†æ˜¯æˆ‘ä»¬åªå­˜äº†<span class="math inline">\(m_i, l_i, O\)</span>ï¼Œä½†æ˜¯æ²¡æœ‰å­˜<span class="math inline">\(S,P\)</span>ï¼Œæ‰€ä»¥åˆ°äº†æœ€åä¸€å—æˆ‘ä»¬ä¹Ÿæ— æ³•è®¡ç®—å‡º<span class="math inline">\(O_i\)</span>ã€‚</p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ¢ä¸ªæ€è·¯ï¼š <span class="math inline">\(O_i\)</span>ä¸æ˜¯æ¯éå†ä¸€å—å°±æ›´æ–°ä¸€æ¬¡å—ï¼Ÿé‚£æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œ<strong>ä¸æ–­ç”¨å½“å‰æœ€æ–°çš„rowmaxå’Œrowsumå»æ›´æ–°<span class="math inline">\(O_i\)</span>ï¼Œç›´åˆ°éå†å®Œæœ€åä¸€å—ï¼Œè¿™æ—¶çš„<span class="math inline">\(O_i\)</span>ä¸å°±å’Œæ ‡å‡†åœºæ™¯ä¸‹çš„ç»“æœå®Œå…¨ä¸€è‡´äº†å—ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³æ„é€ å½¢å¦‚ä¸‹é¢è¿™æ ·çš„æ›´æ–°ç­‰å¼ï¼š</strong><span class="math display">\[O_i = O_i + å½“å‰æœ€æ–°ç»“æœ\]</span></p><p>å› æ­¤æˆ‘ä»¬æœ‰äº†ä¼ªä»£ç ä¸­12è¡Œçš„æ¨å¯¼ï¼š $$\begin{aligned}O_i^{(j+1)} &amp;= P_{i, j+1} V_{:j+1} \\            &amp;= \text{softmax}(S_{i, :j+1}) V_{:j+1} \\            &amp;= \text{diag}(l^{(j+1)})^{-1} \left[ \exp\left([S_{i, :j}, S_{i(j+1)}] - m^{(j+1)}\right) \right]             \begin{bmatrix}                 V_{:j} \\                 V_{j+1}            \end{bmatrix} \\            &amp;= \text{diag}(l^{(j+1)})^{-1} \left[\exp(S_{i, :j} - m^{(j+1)})V_{:j} + \exp(S_{i(j+1)} - m^{(j+1)})V_{j+1}\right] \\            &amp;= \text{diag}(l^{(j+1)})^{-1} \left[\exp(S_{i, :j} - m^{(j)})V_{:j} + e^{-m^{(j+1)}}\exp(S_{i(j+1)})V_{j+1}\right] \\             &amp;= \text{diag}(l^{(j+1)})^{-1} \left[\text{diag}(l^{(j)})e^{m^{(j)} - m^{(j+1)}}O_i^{(j)} + e^{-m^{(j+1)}}\exp(S_{i(j+1)})V_{j+1}\right] \\             &amp;= \text{diag}(l^{(j+1)})^{-1} \left[\text{diag}(l^{(j)})e^{m^{(j)} - m^{(j+1)}}O_i^{(j)} + e^{m^{(j)} - m^{(j+1)}} \tilde{P}_{i(j+1)} V_{j+1}\right]\end{aligned}$$</p><p>æ¨å¯¼è¿‡ç¨‹ä¸­çš„ç¬¦å·ä¸Šä¸‹æ ‡çš„å«ä¹‰ï¼š - <span class="math inline">\(i\)</span>ï¼šè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ã€‚ä¾‹å¦‚å›¾ä¾‹ä¸­ï¼Œ<span class="math inline">\(i=0, 1, 2\)</span>åˆ†åˆ«å¯¹åº”ç€æ·±æµ…ç»¿ã€æ·±æµ…è“ã€æ·±æµ…é»„å—ã€‚ - <span class="math inline">\((j+1)\)</span>ï¼šè¡¨ç¤ºå½“å‰åˆ†å—çš„ç›¸å…³ç»“æœã€‚ - <span class="math inline">\(i,:j+1\)</span>ï¼šè¡¨ç¤ºæˆªæ­¢åˆ°å½“å‰åˆ†å—ï¼ˆåŒ…å«å½“å‰åˆ†å—ï¼‰çš„ç›¸å…³ç»“æœã€‚<span class="math inline">\(i, :j\)</span>è¡¨ç¤ºæˆªæ­¢åˆ°å‰ä¸€åˆ†å—ï¼ˆåŒ…å«å‰ä¸€åˆ†å—ï¼‰çš„ç›¸å…³ç»“æœã€‚</p><h3 id="åå‘è®¡ç®—">åå‘è®¡ç®—</h3><h4 id="softmaxçš„æ±‚å¯¼">softmaxçš„æ±‚å¯¼</h4><p>è®¾ <span class="math display">\[\begin{cases}    y = \text{softmax}(z) \\    L = f(y)\end{cases}\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(L\)</span> è¡¨ç¤º Lossï¼Œ<span class="math inline">\(f(\cdot)\)</span> è¡¨ç¤º Loss å‡½æ•°ï¼Œ<span class="math inline">\(y = [y_1 \; y_2 \; y_3]\)</span>ï¼Œ<span class="math inline">\(z = [z_1 \; z_2 \; z_3]\)</span>ï¼Œè‹¥ç°åœ¨æˆ‘ä»¬æƒ³æ±‚<span class="math inline">\(\frac{\partial L}{\partialz_j}\)</span>ï¼Œè¦æ€ä¹ˆè®¡ç®—å‘¢ï¼Ÿ</p><p>æ ¹æ®é“¾å¼æ³•åˆ™ï¼Œæˆ‘ä»¬æœ‰ï¼š <span class="math display">\[\frac{\partial L}{\partial z_j} = \frac{\partial L}{\partial y}\frac{\partial y}{\partial z_j}\]</span> æ‰€ä»¥æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹è¿™ä¸¤é¡¹ã€‚</p><ol type="1"><li><p><span class="math inline">\(\frac{\partial L}{\partialy}\)</span> æˆ‘ä»¬ç°åœ¨ä¸è€ƒè™‘å…·ä½“çš„ Loss å‡½æ•°ï¼Œç›´æ¥å‡è®¾è¿™ä¸€é¡¹çš„ç»“æœä¸º <span class="math inline">\([m_1 \; m_2 \; m_3]\)</span>ã€‚</p></li><li><p><span class="math inline">\(\frac{\partial y}{\partialz_j}\)</span> æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºæŸä¸ª <span class="math inline">\(z_j\)</span> æ¥è¯´ï¼Œåœ¨ <span class="math inline">\(\text{softmax}\)</span> çš„æ“ä½œä¸‹ï¼Œå®ƒå‚ä¸äº† <span class="math inline">\(y_1, y_2, y_3\)</span> ä¸‰è€…çš„è®¡ç®—ï¼Œå› æ­¤å®ƒçš„åå¯¼å’Œè¿™ä¸‰è€…å¯†åˆ‡åˆ‡ç›¸å…³ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†æˆä¸¤ç§æƒ…å†µï¼š <span class="math display">\[\begin{cases}\frac{\partial y_i}{\partial z_j} = y_i (1 - y_i), &amp; \text{å½“ } i =j \\\frac{\partial y_i}{\partial z_j} = -y_i y_j, &amp; \text{å½“ } i \neq j\end{cases}\]</span></p></li></ol><p>å…·ä½“çš„æ¨å€’è¿‡ç¨‹å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/wuliytTaotao/p/10787510.html">å¯¹ softmaxå’Œ cross-entropy æ±‚å¯¼</a></p><p>æœ‰äº†è¿™ä¸ªç†è§£ï¼Œæˆ‘ä»¬å†æ¥è°ˆè°ˆåŸºäº <span class="math inline">\(y =softmax(z)\)</span> çš„ Jacobian çŸ©é˜µ <span class="math inline">\(diag(y)- y^T y\)</span>ï¼š</p>$$\begin{aligned}diag(y) - y^T y &amp;=\begin{bmatrix}y_1 &amp; 0 &amp; 0 \\0 &amp; y_2 &amp; 0 \\0 &amp; 0 &amp; y_3\end{bmatrix}-\begin{bmatrix}y_1 \\ y_2 \\ y_3\end{bmatrix}*\begin{bmatrix}y_1 &amp; y_2 &amp; y_3\end{bmatrix} \\&amp;=\begin{bmatrix}y_1 - y_1^2 &amp; -y_1 y_2 &amp; -y_1 y_3 \\-y_2 y_1 &amp; y_2 - y_2^2 &amp; -y_2 y_3 \\-y_3 y_1 &amp; -y_3 y_2 &amp; y_3 - y_3^2\end{bmatrix}\end{aligned}$$<p>å¾ˆå®¹æ˜“å‘ç°åªè¦æŠŠæ¯è¡Œ/æ¯åˆ—ç›¸åŠ ï¼Œå°±èƒ½å¾—åˆ°å¯¹åº” <span class="math inline">\(z\)</span>çš„åå¯¼ã€‚åˆ«ç€æ€¥æ±‚å’Œï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p><ol start="3" type="1"><li>$ = $</li></ol><p>æœ‰äº† (1) (2) çš„ç»“æœï¼Œç°åœ¨å°±å¯ä»¥æ¥æ¨å¯¼ <span class="math inline">\(\frac{\partial L}{\partial z_j}\)</span>ï¼Œæˆ‘ä»¬æœ‰ï¼š<span class="math display">\[\frac{\partial L}{\partial z_j} = \frac{\partial L}{\partial y}\frac{\partial y}{\partial z_j}= \sum_{i=1}^l \frac{\partial L}{\partial y_i} \frac{\partialy_i}{\partial z_j} = y_j (d y_j - \sum_{j=1}^l y_j d y_j)\]</span></p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè‹¥æˆ‘ä»¬ç°åœ¨æƒ³æ±‚ <span class="math inline">\(\frac{\partialL}{\partial z_1}\)</span>ï¼Œæˆ‘ä»¬å°† <span class="math inline">\(\frac{\partial L}{\partial y} = [m_1 \; m_2 \;m_3]\)</span> ä»£å…¥ä¸Šé¢å…¬å¼ï¼Œåˆ™æœ‰ï¼š</p><p><span class="math display">\[\frac{\partial L}{\partial z_1} = m_1 (y_1 - y_1^2) - m_2 y_1 y_2 - m_3y_1 y_3\]</span></p><p>ç°åœ¨ï¼Œé’ˆå¯¹æ‰€æœ‰çš„ <span class="math inline">\(z\)</span>ï¼Œæˆ‘ä»¬å°† <span class="math inline">\(\frac{\partial L}{\partial z}\)</span>å†™æˆçŸ©é˜µè¡¨è¾¾å¼æœ‰ï¼š</p>$$\begin{aligned}\frac{\partial L}{\partial z} &amp;= \frac{\partial L}{\partial y} \frac{\partial y}{\partial z} = dy(diag(y) - y^T y) \\&amp;= [m_1 \; m_2 \; m_3]\begin{bmatrix}y_1 &amp; 0 &amp; 0 \\0 &amp; y_2 &amp; 0 \\0 &amp; 0 &amp; y_3\end{bmatrix}-\begin{bmatrix}y_1 \\ y_2 \\ y_3\end{bmatrix}\begin{bmatrix}y_1 &amp; y_2 &amp; y_3\end{bmatrix} \\ &amp;= [m_1 \; m_2 \; m_3]\begin{bmatrix}y_1 - y_1^2 &amp; -y_1 y_2 &amp; -y_1 y_3 \\-y_2 y_1 &amp; y_2 - y_2^2 &amp; -y_2 y_3 \\-y_3 y_1 &amp; -y_3 y_2 &amp; y_3 - y_3^2\end{bmatrix}\end{aligned}$$<p><strong>è‡³æ­¤ï¼Œå¤§å®¶è®°ä½è¿™ä¸¤ä¸ªé‡è¦çš„ç»“è®ºï¼š</strong></p><p><span class="math display">\[\frac{\partial L}{\partial z} = \frac{\partial L}{\partial y}\frac{\partial y}{\partial z} = dy(diag(y) - y^T y)\]</span></p><p><span class="math display">\[\frac{\partial L}{\partial z_j} = y_j \left( dy_j - \sum_{j=1}^l y_jdy_j \right)\]</span></p><h4 id="æ ‡å‡†åå‘è®¡ç®—">æ ‡å‡†åå‘è®¡ç®—</h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209041228.png">é¦–å…ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹æ ‡å‡†å‰å‘è¿‡ç¨‹ï¼š <span class="math display">\[S = QK^T\]</span></p><p><span class="math display">\[P = \text{softmax}(S)\]</span></p><p><span class="math display">\[O = PV\]</span></p><p><span class="math display">\[L = f(O)\]</span></p><p>å¯¹äºæ ‡å‡†backwardæ¥è¯´ï¼Œåœ¨è®¡ç®—å¼€å§‹æ—¶ï¼Œæ˜¾å­˜ï¼ˆHBMï¼‰ä¸Šå·²ç»å­˜æ”¾æœ‰<span class="math inline">\(Q, K, V, O, S, P\)</span>è¿™äº›æ•°æ®ã€‚</p><h4 id="åˆ†å—åå‘è®¡ç®—">åˆ†å—åå‘è®¡ç®—</h4><p>é¦–å…ˆå›é¡¾ä¸€ä¸‹ç»è¿‡åˆ†å— Forwardè®¡ç®—åï¼Œæ˜¾å­˜ï¼ˆHBMï¼‰ä¸Šéƒ½å­˜äº†å“ªäº›æ•°æ®ï¼š</p><ul><li><strong><span class="math inline">\(m\)</span></strong>ï¼šå…¨å±€rowmax</li><li><strong><span class="math inline">\(l\)</span></strong>ï¼šå…¨å±€rowsum</li><li><strong><span class="math inline">\(Q, K,V\)</span></strong>ï¼šç­‰åŒäºæ ‡å‡† attention åœºæ™¯ä¸‹çš„ç»“æœ</li><li><strong><span class="math inline">\(O\)</span></strong>ï¼šç­‰åŒäºæ ‡å‡†attention åœºæ™¯ä¸‹çš„è¾“å‡ºç»“æœ <span class="math inline">\(O\)</span></li><li><strong><span class="math inline">\(dO\)</span></strong>ï¼šæœ‰äº†å®Œæ•´çš„<span class="math inline">\(O\)</span>ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰æ­£å¸¸çš„ backwardæ­¥éª¤å…ˆæ±‚å‡ºå®ƒçš„æ¢¯åº¦ï¼Œä¹Ÿå­˜æ”¾åœ¨æ˜¾å­˜ä¸Šã€‚ç„¶åæˆ‘ä»¬å°±èƒ½æŒ‰ç…§é“¾å¼æ³•åˆ™ï¼Œåˆ†å—åœ°å»æ±‚åˆ—çš„çŸ©é˜µçš„æ¢¯åº¦äº†ã€‚</li></ul><p>æ—¢ç„¶æœ‰äº†å…¨å±€çš„ <span class="math inline">\(m,l\)</span>ï¼Œé‚£ä¹ˆç°åœ¨å¯¹ä»»æ„ä¸€å— <span class="math inline">\(S_{ij}\)</span>ï¼Œæˆ‘ä»¬å°±èƒ½åŸºäº <span class="math inline">\(m, l\)</span> ç®—å‡ºå’Œæ ‡å‡†åœºæ™¯ä¸‹å®Œå…¨ä¸€è‡´çš„ <span class="math inline">\(P_{ij}\)</span> äº†ã€‚ <strong>å› æ­¤ï¼Œåœ¨ backwardçš„è¿‡ç¨‹ä¸­ï¼Œflash attention å°†é‡‡ç”¨é‡è®¡ç®—çš„æ–¹å¼ï¼Œé‡æ–°ç®—å‡º <span class="math inline">\(S_{ij}, P_{ij}\)</span>ï¼Œ å¹¶å°†å®ƒä»¬è¿ç”¨åˆ° backwardçš„è®¡ç®—ä¸­å»</strong>ï¼Œæ‰€ä»¥åœ¨æ¥ä¸‹æ¥çš„è®²è§£ä¸­ï¼Œå¤§å®¶å°±å¯ä»¥æŠŠ <span class="math inline">\(S, P\)</span> ç†è§£æˆå®Œå…¨ç­‰åŒäºæ ‡å‡†åœºæ™¯ä¸‹çš„ç»“æœï¼Œè€Œä¸æ˜¯åƒåˆ†å—è®¡ç®— forward ä¸­é‚£æ ·çš„ <span class="math inline">\(S,P\)</span>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209042346.png"></p><ol type="1"><li>æ±‚ <span class="math inline">\(V_j\)</span> æ¢¯åº¦</li></ol><p>ç”± Forward è¿‡ç¨‹æˆ‘ä»¬çŸ¥ï¼š<span class="math inline">\(O =PV\)</span>ï¼Œå› æ­¤æœ‰äº† <span class="math inline">\(dO\)</span>åï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆæ¥æ±‚ <span class="math inline">\(dP\)</span> å’Œ <span class="math inline">\(dV\)</span> äº†ã€‚è§‚å¯Ÿä¸‹æ–¹çš„å›¾ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ­¤æ—¶æ‰€æœ‰çš„ <span class="math inline">\(P\)</span>éƒ½æ˜¯ä¸å¸¦æ³¢æµªå·çš„ï¼Œå†å¼ºè°ƒä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸ºç»è¿‡äº†é‡è®¡ç®—ï¼Œ æ­¤å¤„ <span class="math inline">\(S, P\)</span>çš„ç»“æœéƒ½ç­‰åŒäºæ ‡å‡†åœºæ™¯ä¸‹çš„ç»“æœï¼Œè€Œä¸æ˜¯ forward ä¸­æ‰€ä»£è¡¨çš„å«ä¹‰ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209042743.png"></p><p>å‡è®¾ç°åœ¨ <span class="math inline">\(j = 0\)</span>ï¼Œé‚£æˆ‘ä»¬è¦æ€ä¹ˆæ±‚<span class="math inline">\(dV_0\)</span> å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <span class="math inline">\(V_0\)</span> éƒ½å‚ä¸äº† <span class="math inline">\(O\)</span>å“ªäº›éƒ¨åˆ†çš„è®¡ç®—ï¼Œä»¥åŠæ˜¯æ€ä¹ˆå‚ä¸çš„ï¼šç”±å›¾å¯çŸ¥ï¼Œ<span class="math inline">\(P_{00}\)</span> å’Œ <span class="math inline">\(V_0\)</span> å‚ä¸äº† <span class="math inline">\(O_0\)</span> çš„è®¡ç®—ï¼Œ <span class="math inline">\(P_{10}\)</span> å’Œ <span class="math inline">\(V_0\)</span> å‚ä¸äº† <span class="math inline">\(O_1\)</span> çš„è®¡ç®—ï¼Œ<span class="math inline">\(P_{20}\)</span> å’Œ <span class="math inline">\(V_0\)</span> å‚ä¸äº† <span class="math inline">\(O_2\)</span> çš„è®¡ç®—ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[dV_0 = (P_{00})^T dO_0 + (P_{10})^T dO_1 + (P_{20})^T dO_2\]</span></p><p>è¿›è€Œæ¨çŸ¥ï¼š <span class="math display">\[dV_j = \sum_i (P_{ij})^T dO_i\]</span></p><p>åœ¨ä¼ªä»£ç  11ï½15 è¡Œä¸­ï¼Œåšçš„éƒ½æ˜¯ <span class="math inline">\(S,P\)</span> é‡è®¡ç®—çš„è¿‡ç¨‹ï¼Œä¼ªä»£ç çš„ç¬¬ 16 è¡Œï¼Œå°±æ˜¯åœ¨æŒ‰è¿™ä¸ªæ–¹æ³•åˆ†å—è®¡ç®—å¹¶ç´¯ç§¯ <span class="math inline">\(dV_j\)</span>ã€‚</p><ol start="2" type="1"><li>æ±‚ <span class="math inline">\(P_{ij}\)</span> æ¢¯åº¦</li></ol><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209043105.png"></p><p>è§‚å¯Ÿä¸Šå›¾ï¼Œå¯ä»¥å‘ç° <span class="math inline">\(P_{ij}\)</span> åªä¸<span class="math inline">\(V_j, O_i\)</span> ç›¸å…³ï¼Œä¾‹å¦‚ <span class="math inline">\(P_{10}\)</span> åªä¸ <span class="math inline">\(V_0, O_1\)</span> ç›¸å…³ã€‚å› æ­¤æˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[dP_{ij} = dO_i V_j^T\]</span></p><p>è¿™å°±æ˜¯ä¼ªä»£ç ç¬¬ 17 è¡Œåšçš„äº‹æƒ…ã€‚</p><ol start="3" type="1"><li>æ±‚ <span class="math inline">\(S_{ij}\)</span> æ¢¯åº¦</li></ol><p>è¿™ä¸€å—æ˜¯ä»¤è®¸å¤šäººæ„Ÿåˆ°è¿·æƒ‘çš„ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹ â€œsoftmax æ±‚å¯¼â€éƒ¨åˆ†è®©å¤§å®¶è®°ä½çš„ä¸€ä¸ªé‡è¦ç»“è®ºï¼š</p><p><span class="math display">\[\frac{\partial L}{\partial z} = \frac{\partial L}{\partial y}\frac{\partial y}{\partial z} = dy(diag(y) - y^T y)\]</span></p><p>æˆ‘ä»¬å‡è®¾ <span class="math inline">\(s_i, p_i, o_i\)</span>åˆ†åˆ«ä¸ºçŸ©é˜µ <span class="math inline">\(S, P, O\)</span>çš„æŸä¸€è¡Œï¼ˆæ³¨æ„è¿™é‡Œ <span class="math inline">\(i\)</span> ä¸æ˜¯è¡¨ç¤ºç¬¬<span class="math inline">\(i\)</span> å—çš„æ„æ€ï¼Œæ˜¯è¡¨ç¤ºç¬¬ <span class="math inline">\(i\)</span> è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨å°å†™çš„ <span class="math inline">\(s, p, o\)</span>è¡¨ç¤ºï¼‰ï¼Œé‚£ä¹ˆæ ¹æ®è¿™ä¸ªç»“è®ºï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[\begin{aligned}ds_i &amp;= dp_i \left( diag(p_i) - p_i^T p_i \right) \\&amp;= dp_i diag(p_i) - dp_i p_i^T p_i \\&amp;= dp_i diag(p_i) - dO_i V_j^T p_i \\&amp;= dp_i diag(p_i) - dO_i o_i^T p_i \\&amp;= p_i \circ \left[ dp_i - \text{rowsum}(dO_i \cdot o_i) \right]\end{aligned}\]</span> ä½ å¯èƒ½å¯¹è¿™ä¸ªæ¨å¯¼çš„æœ€åä¸€æ­¥æœ‰ç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆè¦å¤§è´¹å‘¨ç« ï¼Œå°† <span class="math inline">\(ds_i\)</span>æ”¹å†™æˆè¿™ä¹ˆå¤æ‚çš„å½¢å¼å‘¢ï¼Ÿå› ä¸ºåœ¨æœ€åä¸€æ­¥ä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½æ˜¯é’ˆå¯¹â€œæŸä¸€è¡Œâ€æ¥æ±‚å¯¼ï¼Œè€Œå¼•å…¥æœ€åä¸€æ­¥çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†å»¶å±•è‡³å¯¹â€œæŸä¸€å—ï¼ˆå¤šè¡Œï¼‰â€çš„æ±‚å¯¼ï¼Œä¹Ÿå°±æ˜¯è¯´é’ˆå¯¹æŸä¸€å—<span class="math inline">\(dS_i\)</span>ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯å¤§å†™çš„ <span class="math inline">\(S\)</span>ï¼Œ<span class="math inline">\(i\)</span>çš„å«ä¹‰ä¹Ÿå›å½’è‡³â€œç¬¬å‡ å—â€ï¼‰ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[dS_i = P_i \circ \left[dP_i - \text{rowsum}(dO_i \circ O_i)\right]\]</span></p><p>å¦‚æœå®åœ¨éš¾ä»¥ç†è§£æ¨å¯¼è¿‡ç¨‹ï¼Œå»ºè®®å¤§å®¶å¯ä»¥å¸¦ä¸€äº›å…·ä½“çš„å€¼è¿›å»ï¼Œå°±èƒ½ç†è§£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å†™æˆè¿™ç§å½¢å¼äº†ã€‚è¿›è€Œï¼Œæˆ‘ä»¬å¯ä»¥æ¨çŸ¥ï¼š</p><p><span class="math display">\[dS_{ij} = P_{ij} \circ \left[dP_{ij} - \text{rowsum}(dO_i \circO_i)\right]\]</span></p><p>è¿™å°±æ˜¯ä¼ªä»£ç ç¬¬ 19ï½20 è¡Œåšçš„äº‹æƒ…ã€‚</p><ol start="4" type="1"><li>æ±‚ <span class="math inline">\(Q_i\)</span> æ¢¯åº¦</li></ol><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209043616.png"></p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ <span class="math inline">\(dS_{ij}\)</span>ï¼Œé‚£ä¹ˆç°åœ¨å°±å¯ä»¥æ ¹æ®é“¾å¼æ³•åˆ™ç»§ç»­æ±‚<span class="math inline">\(dQ_i\)</span> äº†ã€‚</p><p>å¯¹ç…§ä¸Šå›¾ï¼Œæˆ‘ä»¬æŠŠç›®å…‰èšç„¦åœ¨ <span class="math inline">\(Q_0\)</span>èº«ä¸Šï¼Œç”± forward è¿‡ç¨‹å¯çŸ¥ï¼š</p><p><span class="math display">\[S_{00} = Q_0 K_0^T\]</span></p><p><span class="math display">\[S_{01} = Q_0 K_1^T\]</span></p><p>å› æ­¤ï¼Œé’ˆå¯¹ <span class="math inline">\(Q_0\)</span>ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[dQ_0 = dS_{00} K_0 + dS_{01} K_1\]</span></p><p>æ¨å¹¿åˆ°ä»»æ„ <span class="math inline">\(Q_i\)</span>ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p><span class="math display">\[dQ_i = \sum_j dS_{ij} K_j\]</span></p><p>è¿™å°±æ˜¯ä¼ªä»£ç ç¬¬ 21 è¡Œåšçš„äº‹æƒ…ã€‚</p><ol start="5" type="1"><li>æ±‚ <span class="math inline">\(K_j\)</span> æ¢¯åº¦ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209043830.png"></li></ol><p>è¿™ä¸€æ­¥å°±å¾ˆç®€å•å•¦ï¼Œå¦‚æœä½ è¢«å¤æ‚çš„åˆ†å—æ¨å¯¼å¼„å¾—æ™•äº†è„‘è¢‹ï¼Œé‚£ä¸å¦¨å†å¤ä¹ ä¸€ä¸‹æˆ‘ä»¬å‰é¢æè¿‡çš„trickï¼š å¯¹ç…§ä¸Šå›¾ï¼Œå–å‡ºæŸä¸€å— <span class="math inline">\(K_j\)</span>ã€‚ç”±äºæˆ‘ä»¬æ˜¯ä» <span class="math inline">\(dS_{ij}\)</span> é“¾å¼æ¨å‘ <span class="math inline">\(K_j\)</span>ï¼Œæ‰€ä»¥è¿™é‡Œåªè¦ææ˜ç™½è¿™å— <span class="math inline">\(K_j\)</span> å’Œå“ªäº› <span class="math inline">\(Q_i\)</span> ä¸€èµ·è®¡ç®—å‡ºäº†å“ªäº› <span class="math inline">\(S_{ij}\)</span> å†æŠŠç›¸å…³ç»“æœç›¸åŠ å³å¯ã€‚</p><p>åªè¦çœ‹äº†æµç¨‹å›¾ï¼Œå°±ä¸éš¾å¾—çŸ¥ï¼šæŸå— <span class="math inline">\(K_j\)</span> å’Œå¯¹åº”çš„ <span class="math inline">\(Q_i\)</span> å…±åŒè®¡ç®—å‡ºäº†å¯¹åº”çš„ <span class="math inline">\(S_{ij}\)</span>ï¼Œå› æ­¤æœ‰ï¼š</p><p><span class="math display">\[dK_j = \sum_i dS_{ij}^T Q_i\]</span></p><p>è¿™å°±æ˜¯ä¼ªä»£ç ç¬¬ 22 è¡Œåšçš„äº‹æƒ…ã€‚</p><h2 id="è®¡ç®—é‡ä¸æ˜¾å­˜å ç”¨">è®¡ç®—é‡ä¸æ˜¾å­˜å ç”¨</h2><h3 id="çŸ©é˜µç›¸ä¹˜çš„è®¡ç®—é‡">çŸ©é˜µç›¸ä¹˜çš„è®¡ç®—é‡</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå‰ç½®çŸ¥è¯†ï¼šä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ï¼Œè¦æ€ä¹ˆç»Ÿè®¡å®ƒä»¬çš„è®¡ç®—é‡ï¼Ÿ</p><p>æˆ‘ä»¬ä¸€èˆ¬ç”¨<strong>FLOPsï¼ˆfloating pointoperationsï¼Œæµ®ç‚¹è¿ç®—æ¬¡æ•°ï¼‰</strong>æ¥è¡¨ç¤ºè¿ç®—é‡çš„å¤§å°ã€‚å¯¹äºâ€œä¸¤çŸ©é˜µç›¸ä¹˜â€è¿™ä¸ªæ“ä½œè€Œè¨€ï¼Œå…¶<strong>è¿ç®—é‡ = </strong>ä¹˜æ³•è¿ç®—çš„æ¬¡æ•° + åŠ æ³•è¿ç®—çš„æ¬¡æ•°**ã€‚</p><p>æ¥çœ‹ä¸€ä¸ªå…·ä½“ä¾‹å­ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209224248.png"></p><p>ä¸¤çŸ©é˜µç›¸ä¹˜ï¼Œä¸ºäº†è·å–å›¾ä¸­æ·±æ©˜è‰²éƒ¨åˆ†çš„å…ƒç´ ï¼Œæˆ‘ä»¬ä¸€å…±éœ€è¦è¿›è¡Œ<strong>næ¬¡ä¹˜æ³•è¿ç®—å’Œn-1æ¬¡åŠ æ³•è¿ç®—</strong>ã€‚</p><p>å¯¹äºç¤ºä¾‹çŸ©é˜µï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œï¼š<span class="math inline">\(mp \cdot (n +n - 1)\)</span> æ¬¡æµ®ç‚¹è®¡ç®—ã€‚</p><p>å†è¿›ä¸€æ­¥ï¼Œå‡è®¾æ­¤æ—¶åœ¨è“è‰²å’Œç»¿è‰²çš„çŸ©é˜µå¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªbiasçŸ©é˜µï¼Œæ„å‘³ç€è®¡ç®—å•ä¸ªæ©˜è‰²æ–¹å—æ—¶æˆ‘ä»¬éœ€è¦è¿›è¡Œ<em>næ¬¡ä¹˜æ³•å’Œn-1+1æ¬¡åŠ æ³•è¿ç®—</em>ï¼Œé‚£ä¹ˆæ­¤æ—¶æ€»è®¡ç®—é‡ä¸ºï¼š<span class="math inline">\(mp \cdot (n+n) =2mnp\)</span>ã€‚å½“ç„¶ï¼Œå³ä½¿ä¸åŠ è¿™ä¸ªbiasï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ-1é¡¹ç»™å¿½ç•¥ï¼Œå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼š - å‡è®¾æœ‰ä¸¤ä¸ªçŸ©é˜µAå’ŒBï¼Œå®ƒä»¬çš„ç»´åº¦åˆ†åˆ«ä¸º(m, n)å’Œ(n,p)ï¼Œåˆ™è¿™ä¸¤çŸ©é˜µç›¸ä¹˜çš„è¿ç®—é‡ä¸º<strong>2mnp</strong>ã€‚ -ç”±äºä¹˜æ³•è¿ç®—çš„æ—¶é—´è¦é«˜äºåŠ æ³•è¿ç®—çš„æ—¶é—´ï¼Œå› æ­¤æœ‰æ—¶åœ¨ç»Ÿè®¡è¿ç®—é‡æ—¶ï¼Œæˆ‘ä»¬åªè€ƒè™‘ä¹˜æ³•è¿ç®—çš„æ¬¡æ•°ï¼Œåˆ™æ­¤æ—¶ä¸¤çŸ©é˜µç›¸ä¹˜çš„è¿ç®—é‡å¯è¿‘ä¼¼ä¸º<strong>mnp</strong>ã€‚</p><h3 id="flash-attentionçš„è®¡ç®—é‡">Flash Attentionçš„è®¡ç®—é‡</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209021146.png"></p><p>æˆ‘ä»¬çŸ¥é“çŸ©é˜µç›¸ä¹˜è¿ç®—å æ®äº†è¿ç®—é‡çš„å¤§å¤´ï¼Œå› æ­¤æˆ‘ä»¬æŠŠåˆ†æç›®å…‰é›†ä¸­åˆ°æ‰€æœ‰çš„çŸ©é˜µè¿ç®—ä¸Šæ¥ã€‚</p><ol type="1"><li><p>åœ¨ä»£ç ç¬¬ 9 è¡Œï¼Œæˆ‘ä»¬æœ‰ <span class="math inline">\(S_{ij} = Q_iK_j^T\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(Q_i \in \mathbb{R}^{B_r\times d}\)</span>ï¼Œ<span class="math inline">\(K_j^T \in \mathbb{R}^{d\times B_c}\)</span>ã€‚æ ¹æ®å‰ç½®çŸ¥è¯†ï¼Œæ±‚ <span class="math inline">\(S_{ij}\)</span> çš„è®¡ç®—é‡ä¸º <span class="math inline">\(O(B_r B_c d)\)</span>ã€‚</p></li><li><p>åœ¨ä»£ç ç¬¬ 12 è¡Œï¼Œæˆ‘ä»¬æœ‰ <span class="math inline">\(\tilde{P}_{ij}V_j\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(\tilde{P}_{ij} \in\mathbb{R}^{B_r \times B_c}\)</span>ï¼Œ<span class="math inline">\(V_j\in \mathbb{R}^{B_c \times d}\)</span>ã€‚åˆ™è¿™é‡Œçš„è®¡ç®—é‡åŒæ ·ä¸º <span class="math inline">\(O(B_r B_c d)\)</span>ã€‚</p></li><li><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€å…±è®¡ç®—äº†å¤šå°‘æ¬¡ (1) å’Œ(2)ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº†å¤šå°‘æ¬¡å†…å¾ªç¯ï¼š</p></li></ol><p><span class="math display">\[T_c T_r = \frac{N}{B_c} \cdot \frac{N}{B_r}\]</span></p><ol start="4" type="1"><li>ç»¼åˆä»¥ä¸Šä¸‰ç‚¹ï¼Œ<strong>flash attention çš„ forwardè®¡ç®—é‡ä¸º</strong>ï¼š</li></ol><p><span class="math display">\[O\left(\frac{N^2}{B_r B_c} B_r B_c d \right) = O(N^2 d)\]</span></p><p>æ³¨æ„ï¼Œå› ä¸ºè®¡ç®—é‡æ˜¯ç”¨å¤§ O é˜¶è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠå¸¸æ•°é¡¹éƒ½çœç•¥äº†ã€‚</p><p>åŒç†å¤§å®¶å¯ä»¥è‡ªè¡Œæ¨ä¸€ä¸‹ backward ä¸­çš„è®¡ç®—é‡ï¼Œåœ¨è®ºæ–‡é‡Œç»™å‡ºçš„ç»“è®ºæ˜¯<span class="math inline">\(O(N^2)\)</span>ï¼Œd è¿œå°äº Nï¼Œå› æ­¤ dä¹Ÿå¯ä»¥ç•¥å»ä¸è¡¨è¿°ã€‚</p><h3 id="flash-attentionçš„æ˜¾å­˜å ç”¨">Flash Attentionçš„æ˜¾å­˜å ç”¨</h3><p>å’Œæ ‡å‡† attention ç›¸æ¯”ï¼Œå¦‚æœä¸è€ƒè™‘ <span class="math inline">\(O\)</span> çš„è¯ï¼ŒFlash Attention åªéœ€è¦å­˜å‚¨ <span class="math inline">\(m, l\)</span>ï¼Œå…¶æ˜¾å­˜éœ€æ±‚ä¸º <span class="math inline">\(O(N)\)</span>ã€‚</p><p>è€Œæ ‡å‡† attention éœ€è¦å­˜å‚¨ <span class="math inline">\(S,P\)</span>ï¼Œå…¶æ˜¾å­˜éœ€æ±‚ä¸º <span class="math inline">\(O(N^2)\)</span>ã€‚</p><p>FlashAttention å°†æ˜¾å­˜éœ€æ±‚é™ä½åˆ°O(N)ï¼Œé€šè¿‡åˆ†å—å¤„ç†å’Œé‡è®¡ç®—ï¼Œ<strong>æ˜¾è‘—å‡å°‘äº†æ˜¾å­˜ä½¿ç”¨</strong>ã€‚å®éªŒæ˜¾ç¤ºï¼Œå…¶æ˜¾å­˜æ¶ˆè€—å¯å‡å°‘è‡³æ ‡å‡†Attention çš„ 1/20ã€‚</p><h2 id="ioå¤æ‚åº¦åˆ†æ">IOå¤æ‚åº¦åˆ†æ</h2><p>flashattentionç›¸æ¯”äºæ ‡å‡†attentionçš„æœ€å¤§ä¼˜åŠ¿ï¼Œå°±æ˜¯å…¶<strong>å‡å°‘äº†å¯¹æ˜¾å­˜ï¼ˆHBMï¼‰çš„è®¿é—®æ¬¡æ•°</strong>ï¼Œä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†memoryboundçš„é—®é¢˜ã€‚æ‰€ä»¥è¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥å…·ä½“åˆ†æè¿™ä¸¤è€…å¯¹æ˜¾å­˜çš„è®¿é—®æ¬¡æ•°ï¼ˆåŒæ ·éƒ½æ˜¯ä»¥forwardä¸ºä¾‹ï¼Œbackwardéƒ¨åˆ†è®ºæ–‡ä¸­ä¹Ÿæœ‰ç»™å‡ºç›¸å…³æ¨å¯¼è¿‡ç¨‹ï¼Œå¤§å®¶å¯ä»¥ç±»æ¯”forwardè‡ªè¡Œé˜…è¯»ï¼‰ã€‚### æ ‡å‡†Attentionçš„IOå¤æ‚åº¦</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241209233647.png"></p><ol type="1"><li><strong>ä» HBM ä¸­è¯»å– <span class="math inline">\(Q, K \in\mathbb{R}^{N \times d}\)</span>ï¼Œè®¡ç®— <span class="math inline">\(S = QK^T\)</span>ï¼Œ<span class="math inline">\(S \in \mathbb{R}^{N \timesN}\)</span> å¹¶å°† <span class="math inline">\(S\)</span> å†™å›HBM</strong>ã€‚<ul><li>ä¸€è¯»ä¸€å†™çš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(2Nd +N^2)\)</span>ã€‚</li></ul></li><li><strong>ä» HBM ä¸­è¯»å– <span class="math inline">\(S \in\mathbb{R}^{N \times N}\)</span>ï¼ŒåŒæ—¶è®¡ç®— <span class="math inline">\(P\in \mathbb{R}^{N \times N}\)</span> å¹¶å°†å…¶å†™å› HBM</strong>ã€‚<ul><li>ä¸€è¯»ä¸€å†™çš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(2N^2)\)</span>ã€‚</li></ul></li><li><strong>ä» HBM ä¸­è¯»å– <span class="math inline">\(P \in\mathbb{R}^{N \times N}, V \in \mathbb{R}^{N \times d}\)</span>ï¼Œè®¡ç®—<span class="math inline">\(O = P V, O \in \mathbb{R}^{N \timesd}\)</span> å¹¶å°† <span class="math inline">\(O\)</span> å†™å›HBM</strong>ã€‚<ul><li>ä¸¤è¯»ä¸€å†™çš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O((N^2 + Nd) +Nd)\)</span>ã€‚</li></ul></li></ol><p><strong>å› æ­¤ï¼Œæ€»ä½“æ¥è¯´æ ‡å‡† attention çš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(Nd + N^2)\)</span>ã€‚</strong></p><h3 id="flash-attentionçš„ioå¤æ‚åº¦">Flash Attentionçš„IOå¤æ‚åº¦</h3><ol type="1"><li><p>æˆ‘ä»¬æ¥çœ‹ä¼ªä»£ç çš„ç¬¬ 6 è¡Œï¼Œåœ¨æ¯ä¸ªå¤–å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¼šåŠ è½½ <span class="math inline">\(K, V\)</span> çš„blockã€‚æ‰€æœ‰å¤–å¾ªç¯ç»“æŸåï¼Œç›¸å½“äºæˆ‘ä»¬åŠ è½½äº†å®Œæ•´çš„ <span class="math inline">\(K, V \in \mathbb{R}^{N \timesd}\)</span>ï¼Œå› æ­¤è¿™é‡Œçš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(2Nd)\)</span>ã€‚</p></li><li><p>å†çœ‹ä¼ªä»£ç ç¬¬ 8 è¡Œï¼Œåœ¨æ¯ä¸ªå†…å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬éƒ½åŠ è½½éƒ¨åˆ† <span class="math inline">\(Q, O, m, l\)</span> blockã€‚ç”±äº <span class="math inline">\(m, l\)</span> æœ¬èº«æ¯”è¾ƒå°ï¼ˆIO å¤æ‚åº¦æ˜¯ <span class="math inline">\(O(N)\)</span>ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æš‚æ—¶å¿½ç•¥å®ƒä»¬ï¼Œåªè€ƒè™‘<span class="math inline">\(Q, O\)</span>ï¼ˆåŸè®ºæ–‡ä¹Ÿæ˜¯è¿™ä¹ˆåˆ†æçš„ï¼‰ã€‚å›ºå®šæŸä¸ªå°å¾ªç¯ï¼Œå¯¹äºæ‰€æœ‰å†…å¾ªç¯ç»“æŸåï¼Œæˆ‘ä»¬ç›¸å½“äºå®Œæ•´éå†äº† <span class="math inline">\(Q, O \in \mathbb{R}^{N \timesd}\)</span>ã€‚åŒæ—¶æˆ‘ä»¬ç»å†äº† <span class="math inline">\(T_c\)</span>æ¬¡å¤–å¾ªç¯ã€‚å› æ­¤è¿™é‡Œæœ€ç»ˆçš„ IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(T_cNd)\)</span>ã€‚</p></li><li><p><strong>å°† <span class="math inline">\(O, m, l\)</span> å†™å›HBM</strong>ï¼Œè¿™é‡Œè¿‘ä¼¼å IO å¤æ‚åº¦ä¸ºï¼š<span class="math inline">\(O(Nd)\)</span>ã€‚</p></li></ol><p>ä¸è¿‡åœ¨åŸè®ºæ–‡çš„åˆ†æä¸­å¹¶æ²¡æœ‰è€ƒè™‘å†™å›çš„å¤æ‚åº¦ï¼Œä¸è¿‡çœç•¥ä¸€äº›å¸¸æ•°é¡¹ä¸ä¼šå½±å“æˆ‘ä»¬æœ€ç»ˆçš„åˆ†æã€‚</p><p>æ€»ä½“æ¥è¯´ï¼Œ<strong>flash attention çš„ IO å¤æ‚åº¦ä¸º</strong>ï¼š <span class="math display">\[O(T_c Nd + Nd) = O\left(\frac{N}{B_c} Nd \right) = O\left(\frac{4Nd}{M}Nd \right) = O\left(N^2 d \frac{d}{M} \right)\]</span> åœ¨æ–‡ç« ä¸­æåˆ°ï¼Œä¸€èˆ¬çš„ <span class="math inline">\(d\)</span>å–å€¼åœ¨ 64ï½128ï¼Œ<span class="math inline">\(M\)</span> çš„å–å€¼åœ¨ 100KBå·¦å³ï¼Œå› æ­¤æœ‰ <span class="math inline">\(\frac{d^2}{M} \ll1\)</span>ã€‚å› æ­¤å¯ä»¥çœ‹å‡ºï¼Œ<strong>Flash Attention çš„ IOå¤æ‚åº¦æ˜¯æ˜¾è‘—å°äºæ ‡å‡† attention çš„ IO å¤æ‚åº¦çš„</strong>ã€‚</p><h3 id="å¤æ‚åº¦æ€»ç»“">å¤æ‚åº¦æ€»ç»“</h3><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210000354.png"></p><h2 id="å®éªŒ">å®éªŒ</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241210000654.png"></p><p>Flash attention çš„ä½œè€…å°† <span class="math inline">\(N =1024\)</span>, <span class="math inline">\(d = 64\)</span>, <span class="math inline">\(B = 64\)</span> çš„ GPT2-medium éƒ¨ç½²åœ¨ A100 GPUä¸Šï¼Œæ¥è§‚å¯Ÿé‡‡ç”¨ flash attention å‰åçš„æ¨¡å‹çš„è®¡ç®—æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹æœ€å·¦ä¾§å›¾è¡¨ï¼Œæ ‡å‡† attention ä¸‹ï¼Œ<strong>è®¡ç®—å¼ºåº¦ <span class="math inline">\(I = \frac{66.6}{40.3} \approx 1.6 &lt;201\)</span></strong>ï¼Œè¯´æ˜ GPT2 åœ¨ A100ä¸Šçš„è®­ç»ƒæ˜¯å—åˆ°å†…å­˜é™åˆ¶çš„ã€‚è€Œåœ¨é‡‡ç”¨ flash attentionåå¾—åˆ°æ˜æ˜¾æ”¹å–„ï¼Œruntime ä¹Ÿå‘ˆç°äº†æ˜¾è‘—ä¸‹é™ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸­é—´çš„å›¾è¡¨ï¼Œå®ƒè¡¨ç¤ºåœ¨ä½¿ç”¨ flash attention çš„å‰æä¸‹ï¼Œä»¥forward è¿‡ç¨‹ä¸ºä¾‹ï¼Œæ¯ä¸ªæ•°æ®å—çš„å¤§å°å¯¹ HBMè¯»å†™æ¬¡æ•°ï¼ˆç»¿è‰²ï¼‰å’Œè€—æ—¶ï¼ˆè“è‰²ï¼‰çš„å½±å“ã€‚å¯ä»¥å‘ç°ï¼Œæ•°æ®å—è¶Šå¤§ï¼Œè¯»å†™æ¬¡æ•°è¶Šå°‘ï¼Œè€Œéšç€è¯»å†™æ¬¡æ•°çš„å‡å°‘ï¼Œruntimeä¹Ÿæ•´ä½“ä¸‹é™äº†ï¼ˆå¤ä¹ ä¸€ä¸‹ï¼Œè¯»å†™å¤æ‚åº¦ä¸º <span class="math inline">\(O(T_cNd)\)</span>ï¼Œæ•°æ®å—è¶Šå¤§æ„å‘³ç€ <span class="math inline">\(T_c\)</span>è¶Šå°ï¼‰ã€‚<strong>ä½†æœ‰è¶£çš„æ˜¯ï¼Œå½“æ•°æ®å—å¤§å° <span class="math inline">\(&gt; 256\)</span> åï¼Œruntimeçš„ä¸‹é™ä¸æ˜æ˜¾äº†ï¼Œè¿™æ˜¯å› ä¸ºéšç€çŸ©é˜µçš„å˜å¤§ï¼Œè®¡ç®—è€—æ—¶ä¹Ÿæ›´å¤§äº†ï¼Œä¼šæŠµå¹³è¯»å†™èŠ‚çœä¸‹æ¥çš„æ—¶é—´</strong>ã€‚</p><p>å‚è€ƒèµ„æ–™ &gt; å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlashAttentionV1ï¼Œä»ç¡¬ä»¶åˆ°è®¡ç®—é€»è¾‘:https://zhuanlan.zhihu.com/p/669926191 &gt;å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlash AttentionV2ï¼Œä»åŸç†åˆ°å¹¶è¡Œè®¡ç®—:https://zhuanlan.zhihu.com/p/691067658</p>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> FlashAttention </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ªäººåšå®¢åŠ å…¥è°·æ­Œå…ƒæ ‡è®°ä¸ç«™ç‚¹åœ°å›¾</title>
      <link href="/2024/12/04/ge-ren-bo-ke-jia-ru-gu-ge-yuan-biao-ji-yu-zhan-dian-di-tu/"/>
      <url>/2024/12/04/ge-ren-bo-ke-jia-ru-gu-ge-yuan-biao-ji-yu-zhan-dian-di-tu/</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><p>åœ¨å»ºç«‹å¥½æˆ‘ä»¬çš„åšå®¢æˆ–è€…ä¸ªäººç½‘ç«™åï¼Œéœ€è¦å†è®©è‡ªå·±çš„é“¾æ¥è¢«æœç´¢å¼•æ“æ‰€æ”¶å½•ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•èƒ½å¤Ÿè¢«æœç´¢å¼•æ“æ·»åŠ è‡ªå·±ç½‘ç«™çš„ç´¢å¼•ã€‚ä¸€ä¸ªæ˜¯è‡ªå·±åŠªåŠ›æé«˜è‡ªå·±çš„ç½‘ç«™çŸ¥ååº¦ï¼Œè®©æœç´¢å¼•æ“ä¸»åŠ¨å»æ·»åŠ ç´¢å¼•ã€‚å¦å¤–ä¸€ç§å°±æ˜¯è‡ªå·±æŠŠè‡ªå·±çš„é“¾æ¥æ·»åŠ åˆ°æœç´¢å¼•æ“çš„ç´¢å¼•å½“ä¸­ã€‚</p><h2 id="æŸ¥çœ‹æ˜¯å¦æ”¶å½•">æŸ¥çœ‹æ˜¯å¦æ”¶å½•</h2><p>åœ¨googleæˆ–è€…ç™¾åº¦ç­‰æœç´¢å¼•æ“ä¸­æœç´¢<code>site:website addres</code>ï¼ŒæŸ¥çœ‹æ˜¯å¦å·²ç»è¢«æ”¶å½•ã€‚</p><p>å¦‚æœæœç´¢ä¸å‡ºæ¥è‡ªå·±ç­‰ç½‘ç«™ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªå·±æ·»åŠ åˆ°æœç´¢å¼•æ“çš„ç´¢å¼•å½“ä¸­ã€‚ä¸‹é¢ä»¥googleä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•æ·»åŠ è‡ªå·±çš„ç½‘ç«™åˆ°googleçš„ç´¢å¼•å½“ä¸­ã€‚</p><h2 id="æ·»åŠ è°·æ­Œå…ƒæ ‡è®°">æ·»åŠ è°·æ­Œå…ƒæ ‡è®°</h2><p>é¦–å…ˆä½ éœ€è¦ä¸€ä¸ªè°·æ­Œè´¦å·ï¼Œç„¶åä½¿ç”¨<a href="https://search.google.com/search-console/about">Google SearchConsole</a>æœåŠ¡ï¼Œç‚¹å‡»ç«‹å³ä½¿ç”¨ï¼</p><p>æ¥ä¸‹æ¥ä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„éªŒè¯ç•Œé¢: <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205035222.png"></p><p>è¿™é‡Œé€‰æ‹©å‰ç¼€ï¼Œç„¶åè¾“å…¥è‡ªå·±ç½‘ç«™åœ°å€ã€‚ä¹‹åæŒ‰ç…§æç¤ºæ·»åŠ metaæ ‡ç­¾åˆ°è‡ªå·±çš„ç½‘ç«™ä¸­ã€‚å¯¹äºhexoåšå®¢ï¼Œå¯ä»¥åœ¨<code>themes/next/layout/_partials/head.ejs</code>æ–‡ä»¶ä¸­æ·»åŠ ã€‚</p><p>åœ¨æ·»åŠ å®Œå…ƒæ ‡è®°åï¼Œè¿›è¡Œç½‘å€æ£€æŸ¥ï¼Œå¦‚æœæ˜¾ç¤ºç½‘å€æœªæ”¶å½•ï¼Œç‚¹å‡»å³ä¸‹è§’çš„è¯·æ±‚ç¼–å…¥ç´¢å¼•ï¼Œåˆ«ç€æ€¥ï¼Œä¸€èˆ¬æ¥è¯´ä¸€åˆ°ä¸¤å¤©åGoogleå°±ä¼šæ”¶å½•ã€‚</p><h2 id="æ·»åŠ ç«™ç‚¹åœ°å›¾">æ·»åŠ ç«™ç‚¹åœ°å›¾</h2><h3 id="ç”Ÿæˆç«™ç‚¹åœ°å›¾">ç”Ÿæˆç«™ç‚¹åœ°å›¾</h3><ul><li>å®‰è£…sitemapæ’ä»¶ï¼š<code>npm install hexo-generator-sitemap --save</code></li><li>ç”Ÿæˆç«™ç‚¹åœ°å›¾ï¼š<code>hexo generate</code>ï¼Œç„¶ååœ¨<code>public</code>ç›®å½•ä¸‹ä¼šç”Ÿæˆ<code>sitemap.xml</code>æ–‡ä»¶</li><li>ä¿®æ”¹é…ç½®ï¼š<ul><li>åœ¨<code>_config.yml</code>æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½® <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">Plugins:    - hexo-generator-sitemapsitemap:    path: /sitemap.xml</code></pre></li><li>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½® <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">menu:...sitemap: /sitemap.xml || fa fa-sitemap...</code></pre> #### æäº¤ç«™ç‚¹åœ°å›¾è¿˜æ˜¯Google SearchConsoleï¼Œç‚¹å‡»å·¦ä¾§è¾¹æ ä¸­çš„ç«™ç‚¹åœ°å›¾ï¼Œæ·»åŠ æ–°çš„ç«™ç‚¹åœ°å›¾ï¼Œåœ¨ä¸»ç«™åœ°å€åé¢å¡«å…¥sitemap.xmlï¼Œå³ä¸å‰é¢ç”Ÿæˆçš„ç«™ç‚¹åœ°å›¾æ–‡ä»¶åç§°ç›¸åŒï¼</li></ul></li></ul><p>ç­‰å¾…Googlecå¤„ç†ï¼Œä¸€èˆ¬æ¥è¯´ä¸€åˆ°ä¸¤å¤©åGoogleå°±ä¼šæ”¶å½•ã€‚</p><blockquote><p>https://blog.csdn.net/tzhuwb/article/details/125477001https://mizeri.github.io/2021/04/18/hexo-sitemap-google/</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> google search console </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> sitemap </tag>
            
            <tag> google search console </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹é«˜æ•ˆå¾®è°ƒæ–¹æ³•PEFT--LoRA/QLoRA</title>
      <link href="/2024/12/04/da-mo-xing-gao-xiao-wei-diao-fang-fa-peft-lora-qlora/"/>
      <url>/2024/12/04/da-mo-xing-gao-xiao-wei-diao-fang-fa-peft-lora-qlora/</url>
      
        <content type="html"><![CDATA[<h2 id="å‚æ•°é«˜æ•ˆå¾®è°ƒpeft">å‚æ•°é«˜æ•ˆå¾®è°ƒPEFT</h2><h4 id="å¾®è°ƒ">å¾®è°ƒ</h4><p>å¾®è°ƒï¼ˆFine-tuningï¼‰æ˜¯ä¸€ç§è¿ç§»å­¦ä¹ çš„æŠ€æœ¯ï¼Œç”¨äºåœ¨ä¸€ä¸ªå·²ç»é¢„è®­ç»ƒå¥½çš„æ¨¡å‹åŸºç¡€ä¸Šï¼Œé€šè¿‡è¿›ä¸€æ­¥è®­ç»ƒæ¥é€‚åº”ç‰¹å®šçš„ä»»åŠ¡æˆ–æ•°æ®é›†ã€‚å¾®è°ƒå¯ä»¥åœ¨å…·æœ‰ç›¸ä¼¼ç‰¹å¾çš„ä»»åŠ¡ä¹‹é—´å…±äº«çŸ¥è¯†ï¼Œä»è€ŒåŠ å¿«è®­ç»ƒé€Ÿåº¦å¹¶æé«˜æ¨¡å‹æ€§èƒ½ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€èˆ¬çš„å¾®è°ƒæ­¥éª¤ï¼š</p><ul><li><strong>é€‰æ‹©æ‹©é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼šé€‰æ‹©ä¸€ä¸ªåœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¦‚ImageNetä¸Šçš„é¢„è®­ç»ƒçš„å·ç§¯ç¥ç»ç½‘ç»œï¼ˆå¦‚ResNetã€VGGç­‰ï¼‰ã€‚è¿™äº›æ¨¡å‹é€šå¸¸å…·æœ‰è‰¯å¥½çš„ç‰¹å¾æå–èƒ½åŠ›ã€‚</li><li><strong>å†»ç»“åº•å±‚æƒé‡</strong>ï¼šå°†é¢„è®­ç»ƒæ¨¡å‹çš„åº•å±‚æƒé‡ï¼ˆé€šå¸¸æ˜¯å·ç§¯å±‚ï¼‰å›ºå®šä½ï¼Œä¸è¿›è¡Œè®­ç»ƒã€‚è¿™æ˜¯å› ä¸ºåº•å±‚æƒé‡é€šå¸¸å­¦ä¹ åˆ°äº†é€šç”¨çš„ç‰¹å¾ï¼Œå¯ä»¥è¢«ç”¨äºè®¸å¤šä¸åŒçš„ä»»åŠ¡ã€‚</li><li><strong>æ›¿æ¢é¡¶å±‚åˆ†ç±»å™¨</strong>ï¼šå°†é¢„è®­ç»ƒæ¨¡å‹çš„é¡¶å±‚åˆ†ç±»å™¨ï¼ˆé€šå¸¸æ˜¯å…¨è¿æ¥å±‚ï¼‰æ›¿æ¢ä¸ºé€‚åˆç‰¹å®šä»»åŠ¡çš„æ–°çš„åˆ†ç±»å™¨ã€‚æ–°çš„åˆ†ç±»å™¨çš„è¾“å‡ºèŠ‚ç‚¹æ•°é‡åº”è¯¥ä¸ä»»åŠ¡çš„ç±»åˆ«æ•°ç›¸åŒ¹é…ã€‚</li><li><strong>è§£å†»éƒ¨åˆ†æƒé‡ï¼ˆå¯é€‰ï¼‰</strong>ï¼šæ ¹æ®ä»»åŠ¡çš„å¤æ‚æ€§å’Œå¯ç”¨çš„è®­ç»ƒæ•°æ®é‡ï¼Œå¯ä»¥é€‰æ‹©è§£å†»ä¸€äº›åº•å±‚æƒé‡ï¼Œä»¥ä¾¿æ›´å¥½åœ°é€‚åº”æ–°çš„ä»»åŠ¡ã€‚è¿™æ ·å¯ä»¥å…è®¸åº•å±‚æƒé‡è¿›è¡Œå¾®å°çš„è°ƒæ•´ï¼Œä»¥æ›´å¥½åœ°é€‚åº”æ–°ä»»åŠ¡çš„ç‰¹å¾ã€‚</li><li><strong>è¿›è¡Œè®­ç»ƒ</strong>ï¼šä½¿ç”¨ç‰¹å®šä»»åŠ¡çš„è®­ç»ƒæ•°æ®é›†å¯¹æ–°çš„åˆ†ç±»å™¨è¿›è¡Œè®­ç»ƒã€‚å¯ä»¥ä½¿ç”¨<strong>è¾ƒå°çš„å­¦ä¹ ç‡</strong>è¿›è¡Œè®­ç»ƒï¼Œä»¥é¿å…å¯¹é¢„è®­ç»ƒæ¨¡å‹çš„æƒé‡è¿›è¡Œè¿‡å¤§çš„æ›´æ–°ã€‚</li><li><strong>è¯„ä¼°å’Œè°ƒæ•´</strong>ï¼šåœ¨è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨éªŒè¯é›†æˆ–æµ‹è¯•é›†è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½ã€‚æ ¹æ®è¯„ä¼°ç»“æœï¼Œå¯ä»¥è¿›è¡Œè°ƒæ•´ï¼Œå¦‚è°ƒæ•´å­¦ä¹ ç‡ã€è°ƒæ•´æ¨¡å‹ç»“æ„ç­‰ã€‚</li></ul><p>å¾®è°ƒçš„å…³é”®æ˜¯åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šè¿›è¡Œè®­ç»ƒï¼Œä»è€Œå°†æ¨¡å‹çš„çŸ¥è¯†è¿ç§»åˆ°ç‰¹å®šä»»åŠ¡ä¸Šã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥åœ¨è¾ƒå°‘çš„æ•°æ®å’Œè®¡ç®—èµ„æºä¸‹ï¼Œå¿«é€Ÿæ„å»ºå’Œè®­ç»ƒé«˜æ€§èƒ½çš„æ¨¡å‹ã€‚</p><h4 id="peft">PEFT</h4><p>PEFTï¼ˆParameter-EfficientFine-Tuningï¼Œå‚æ•°é«˜æ•ˆå¾®è°ƒï¼‰æ˜¯ä¸€ç§åœ¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLarge LanguageModelï¼ŒLLMï¼‰ä¸Šè¿›è¡Œå¾®è°ƒçš„æ–°æŠ€æœ¯ï¼Œæ—¨åœ¨é™ä½å¾®è°ƒå¤§æ¨¡å‹çš„è®¡ç®—å’Œå­˜å‚¨æˆæœ¬ï¼Œä½¿å¾—å¾®è°ƒè¿‡ç¨‹æ›´ä¸ºé«˜æ•ˆã€‚ä¸ä¼ ç»Ÿçš„å¾®è°ƒæŠ€æœ¯ç›¸æ¯”ï¼ŒPEFTå¯ä»¥æ˜¾è‘—å‡å°‘è®­ç»ƒæ‰€éœ€çš„å‚æ•°é‡ï¼Œå¹¶ä¿æŒä¸æ ‡å‡†å¾®è°ƒç›¸ä¼¼çš„æ€§èƒ½ã€‚PEFTæŠ€æœ¯åœ¨ä¼˜åŒ–èµ„æºæ•ˆç‡ã€é™ä½ç¡¬ä»¶éœ€æ±‚ã€å¹¶æé«˜å¼€å‘çµæ´»æ€§æ–¹é¢æœ‰æ˜¾è‘—ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦é¢‘ç¹å¾®è°ƒä»¥é€‚åº”ä¸åŒä»»åŠ¡æˆ–é¢†åŸŸçš„åœºæ™¯ä¸­å°¤ä¸ºæœ‰ç”¨ã€‚</p><p>ç›®å‰ä¸»æµçš„æ–¹æ³•åŒ…æ‹¬2019å¹´ Houlsby N ç­‰äººæå‡ºçš„ AdapterTuningï¼Œ2021å¹´å¾®è½¯æå‡ºçš„ LORAï¼Œæ–¯å¦ç¦æå‡ºçš„ Prefix-Tuningï¼Œè°·æ­Œæå‡ºçš„Prompt Tuningï¼Œ2022å¹´æ¸…åæå‡ºçš„ P-tuning v2ã€‚</p><ul><li>Adapter Tuningåœ¨æ¨¡å‹çš„æŸäº›å±‚ä¹‹é—´æ’å…¥å°çš„é€‚é…å™¨æ¨¡å—ï¼Œè€Œä¸å¯¹åŸæœ‰çš„å¤§é‡å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚é€‚é…å™¨æ¨¡å—é€šå¸¸åŒ…å«ä¸€å°éƒ¨åˆ†å¯è®­ç»ƒçš„å‚æ•°ï¼Œå¹¶é€šè¿‡è¿™äº›å‚æ•°æ¥è°ƒæ•´æ¨¡å‹çš„è¾“å‡ºï¼›ä½†æ˜¯å¢åŠ äº†æ¨¡å‹å±‚æ•°ï¼Œå¼•å…¥äº†é¢å¤–çš„æ¨ç†å»¶è¿Ÿ</li><li>Prefix-Tuning æ¯ä¸ª Transformerå±‚å‰é¢æ·»åŠ ä¸€ä¸ªå¯å­¦ä¹ çš„å‰ç¼€ï¼ˆprefixï¼‰æ¥å®ç°æ¨¡å‹çš„è°ƒæ•´ã€‚è¿™ä¸ªå‰ç¼€æ˜¯å›ºå®šé•¿åº¦çš„ï¼Œå¯è§†ä½œç‰¹å®šä»»åŠ¡çš„æç¤ºï¼ˆpromptï¼‰ï¼›ä½†æ˜¯é¢„ç•™ç»™Prompt çš„åºåˆ—æŒ¤å äº†ä¸‹æ¸¸ä»»åŠ¡çš„è¾“å…¥åºåˆ—ç©ºé—´ï¼Œå½±å“æ¨¡å‹æ€§èƒ½</li><li>P-tuning v2ä½¿ç”¨å¯å­¦ä¹ çš„åµŒå…¥æ¥æ›¿ä»£ç¡¬ç¼–ç çš„æç¤ºæ–‡æœ¬ï¼›ä½†æ˜¯å¾ˆå®¹æ˜“å¯¼è‡´æ—§çŸ¥è¯†é—å¿˜ï¼Œå¾®è°ƒä¹‹åçš„æ¨¡å‹ï¼Œåœ¨ä¹‹å‰çš„é—®é¢˜ä¸Šè¡¨ç°æ˜æ˜¾å˜å·®</li><li>åŸºäºä¸Šè¿°èƒŒæ™¯ï¼ŒLORA å¾—ç›Šäºå‰äººçš„ä¸€äº›å…³äºå†…åœ¨ç»´åº¦ï¼ˆintrinsicdimensionï¼‰çš„å‘ç°ï¼š</li></ul><blockquote><p>æ¨¡å‹æ˜¯è¿‡å‚æ•°åŒ–çš„ï¼Œå®ƒä»¬æœ‰æ›´å°çš„å†…åœ¨ç»´åº¦ï¼Œæ¨¡å‹ä¸»è¦ä¾èµ–äºè¿™ä¸ªä½çš„å†…åœ¨ç»´åº¦ï¼ˆlowintrinsic dimensionï¼‰å»åšä»»åŠ¡é€‚é…ã€‚</p></blockquote><p>å‡è®¾æ¨¡å‹åœ¨ä»»åŠ¡é€‚é…è¿‡ç¨‹ä¸­æƒé‡çš„æ”¹å˜é‡æ˜¯ä½ç§©ï¼ˆlowrankï¼‰çš„ï¼Œç”±æ­¤æå‡º<strong>ä½ç§©è‡ªé€‚åº”</strong>ï¼ˆLoRAï¼‰æ–¹æ³•ã€‚</p><p>LoRAå…è®¸æˆ‘ä»¬é€šè¿‡ä¼˜åŒ–é€‚åº”è¿‡ç¨‹ä¸­å¯†é›†å±‚å˜åŒ–çš„ç§©åˆ†è§£çŸ©é˜µï¼Œæ¥é—´æ¥è®­ç»ƒç¥ç»ç½‘ç»œä¸­çš„ä¸€äº›å¯†é›†å±‚ï¼ŒåŒæ—¶ä¿æŒé¢„å…ˆè®­ç»ƒçš„æƒé‡ä¸å˜ã€‚</p><h2 id="lora">LoRA</h2><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204190635.png">LoRA çš„æ€æƒ³å¾ˆç®€å•:</p><ul><li><p>åœ¨åŸå§‹ PLM (Pre-trained Language Model)æ—è¾¹å¢åŠ ä¸€ä¸ªæ—è·¯ï¼Œåšä¸€ä¸ªé™ç»´å†å‡ç»´çš„æ“ä½œï¼Œæ¥æ¨¡æ‹Ÿæ‰€è°“çš„intrinsicrankã€‚</p></li><li><p>è®­ç»ƒçš„æ—¶å€™å›ºå®š PLM çš„å‚æ•°ï¼Œåªè®­ç»ƒé™ç»´çŸ©é˜µä¸å‡ç»´çŸ©é˜µã€‚è€Œæ¨¡å‹çš„è¾“å…¥è¾“å‡ºç»´åº¦ä¸å˜ï¼Œè¾“å‡ºæ—¶å°†ä¸ PLMçš„å‚æ•°å åŠ ã€‚</p></li><li><p>ç”¨éšæœºé«˜æ–¯åˆ†å¸ƒåˆå§‹åŒ– Aï¼Œç”¨ 0 çŸ©é˜µåˆå§‹åŒ–Bï¼Œä¿è¯è®­ç»ƒçš„å¼€å§‹æ­¤æ—è·¯çŸ©é˜µä¾ç„¶æ˜¯ 0 çŸ©é˜µã€‚ &gt;ä¸ºä»€ä¹ˆAç”¨éšæœºé«˜æ–¯åˆ†å¸ƒåˆå§‹åŒ–ï¼ŒBç”¨0çŸ©é˜µåˆå§‹åŒ–å‘¢ï¼Ÿ</p></li><li><p>é¦–å…ˆå¢é‡çŸ©é˜µ<span class="math inline">\(\Delta W = BA\)</span>åœ¨è®­ç»ƒåˆšå¼€å§‹è‚¯å®šæ˜¯è¦ç”¨0æ¥åˆå§‹åŒ–ã€‚</p></li><li><p>å¦‚æœAç”¨0çŸ©é˜µåˆå§‹åŒ–ï¼Œåœ¨è®¡ç®—æ¢¯åº¦æ—¶ç”±äºBçš„æ¢¯åº¦æœ‰ä¸€ä¸ªå› å­Aï¼Œå¯¼è‡´Bçš„æ¢¯åº¦å§‹ç»ˆä¸º0ï¼Œæ— æ³•è¢«æ›´æ–°ï¼Œå¯¼è‡´æ¢¯åº¦ä¼ æ’­å—é˜»ã€‚</p></li></ul><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸ºå› ä¸ºAæ˜¯é™ç»´çŸ©é˜µï¼Œæ‰€ä»¥å®ƒèƒ½å¤Ÿå­¦åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ç”¨éšæœºé«˜æ–¯åˆ†å¸ƒåˆå§‹åŒ–ï¼›è€ŒBæ˜¯å‡ç»´çŸ©é˜µï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿä¿æŒåŸå§‹ä¿¡æ¯ï¼Œæ‰€ä»¥ç”¨0çŸ©é˜µåˆå§‹åŒ–ã€‚</p><p><strong>ç§©çš„é€‰æ‹©</strong> åœ¨ Transformer ä¸­ï¼ŒLoRA ä¸»è¦ä½œç”¨åœ¨attention è¿‡ç¨‹çš„å››ä¸ªæƒé‡çŸ©é˜µW_Q, W_K, W_V,W_Oï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä¸­éƒ¨åˆ†ï¼‰ã€‚Aï¼ŒBçŸ©é˜µçš„ç§©rä¹Ÿæ—¶è¿œè¿œå°äºåŸå§‹çš„æƒé‡å¤§å°ã€‚å¯¹äºä¸€èˆ¬çš„ä»»åŠ¡ï¼Œr=1ï¼Œ2ï¼Œ4ï¼Œ8å°±è¶³å¤Ÿäº†ã€‚è€Œä¸€äº›é¢†åŸŸå·®è·æ¯”è¾ƒå¤§çš„ä»»åŠ¡å¯èƒ½éœ€è¦æ›´å¤§çš„rã€‚åŒæ—¶ï¼Œå¢åŠ rå€¼å˜å¤§å¹¶ä¸èƒ½æå‡å¾®è°ƒçš„æ•ˆæœï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå‚æ•°é‡å¢åŠ éœ€è¦æ›´å¤šçš„è¯­æ–™.<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204204545.png"></p><p><strong>å®ç°</strong> huggingface:https://huggingface.co/docs/peft/main/conceptual_guides/lorallama_factory:https://llamafactory.readthedocs.io/zh-cn/latest/getting_started/sft.htmlå…³é”®å‚æ•°ï¼š - lora_rï¼šç§©ï¼Œæ§åˆ¶ä½ç§©çŸ©é˜µçš„è¡¨ç¤ºèƒ½åŠ›ã€‚ -lora_alphaï¼šç¼©æ”¾å› å­ï¼Œæ§åˆ¶ LoRA çš„å½±å“åŠ›ã€‚ - lora_dropoutï¼šdropoutæ¦‚ç‡ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚ - lora_target_modulesï¼šæŒ‡å®šå¾®è°ƒçš„ç›®æ ‡å±‚ã€‚ -lora_trainable_onlyï¼šæ˜¯å¦åªè®­ç»ƒ LoRA å¢åŠ çš„éƒ¨åˆ†ã€‚ -lora_init_scaleï¼šæ§åˆ¶ä½ç§©çŸ©é˜µåˆå§‹åŒ–çš„å°ºåº¦ã€‚ -lora_layers_to_freezeï¼šæŒ‡å®šå†»ç»“å“ªäº›å±‚ã€‚ - lora_lrï¼šè®¾ç½® LoRA çš„å­¦ä¹ ç‡ã€‚- lora_warmup_stepsï¼šæŒ‡å®šçƒ­èº«é˜¶æ®µçš„æ­¥æ•°ã€‚</p><h2 id="qlora">QLoRA</h2><p>QLoRAï¼ˆQuantized Low-Rank Adapterï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ï¼Œæ˜¯ LoRAçš„é‡åŒ–ç‰ˆæœ¬ï¼ˆä»€ä¹ˆæ˜¯ LoRAï¼Ÿï¼‰ã€‚è¯¥è°ƒä¼˜æ–¹æ³•ç”±åç››é¡¿å¤§å­¦å‘è¡¨äºè®ºæ–‡ã€ŠQLORA:Efficient Finetuning of Quantized LLMsã€‹ã€‚é€šè¿‡é™ä½å†…å­˜ä½¿ç”¨ï¼Œå®ç°åœ¨å•ä¸ªGPU ä¸Šå¯¹å¤§å‹è¯­è¨€æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚å®ƒå¯ä»¥åœ¨å•ä¸ª 48GB GPU ä¸Šå¾®è°ƒ 650äº¿ä¸ªå‚æ•°çš„æ¨¡å‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¿æŒå®Œæ•´çš„ 1 6 ä½å¾®è°ƒä»»åŠ¡æ€§èƒ½ã€‚</p><p>QLoRA æ ¸å¿ƒæ˜¯ä½¿ç”¨é‡åŒ–è¿›è¡Œå¾®è°ƒã€‚å…¶æˆæœæœ‰ä¸‰ä¸ªã€‚ - 4ä½æ ‡å‡†æµ®ç‚¹æ•°é‡åŒ–ï¼ˆ4-bit NormalFloat Quantizationï¼‰ - åŒé‡é‡åŒ–ï¼ˆDoubleQuantizationï¼‰ - åˆ†é¡µä¼˜åŒ–ï¼ˆPagedOptimizerï¼‰å°±æ˜¯æ˜¾å­˜ä¸è¶³æ—¶å°†éƒ¨åˆ†æ¢¯åº¦æ£€æŸ¥ç‚¹è½¬ç§»åˆ°å†…å­˜ä¸Šã€‚</p><p>ä¸ºäº†é™ä½æç«¯çš„é‡åŒ–å¯¹å¾®è°ƒé€ æˆçš„ä¸åˆ©å½±å“ï¼Œ<strong>QLoRA å€ŸåŠ© LoRAå¯¹åŸæ¨¡å‹æƒé‡è¿›è¡Œæ›´æ–°</strong>ï¼Œä¸” LoRA ä¾§çš„æƒé‡ä¿æŒé«˜ç²¾åº¦ã€‚è¿™å°±æ˜¯ QLoRAä¸ LoRA çš„å…³ç³»ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204231609.png">### åŸºç¡€çŸ¥è¯† #### é‡åŒ–<strong>é‡åŒ–</strong>æŒ‡çš„æ˜¯å°†è¿ç»­æˆ–é«˜ç²¾åº¦çš„æ•°å€¼è½¬æ¢ä¸ºè¾ƒä½ç²¾åº¦ï¼ˆæ¯”å¦‚è¾ƒå°‘çš„ä½æ•°ï¼‰çš„è¡¨ç¤ºå½¢å¼çš„è¿‡ç¨‹ã€‚è¿™é€šå¸¸ç”¨äºå‡å°‘æ¨¡å‹çš„å­˜å‚¨éœ€æ±‚å’ŒåŠ å¿«å…¶è¿ç®—é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªFP32 çš„ tensor è½¬æˆ Int8: <span class="math display">\[X^{\text{Int8}} =\text{round}\left(\frac{127}{\text{absmax}(X^{\text{FP32}})} \cdotX^{\text{FP32}}\right)=round(c^{\text{FP32}} \cdotX^{\text{FP32}})\]</span></p><p>å…¶ä¸­ï¼Œcä¸ºé‡åŒ–å¸¸æ•°ï¼Œé€šå¸¸æ˜¯è¿™ä¸ªå¼ é‡çš„ç‰¹å¾çš„ç»å¯¹å€¼çš„æœ€å¤§å€¼ã€‚é€†é‡åŒ–å…¬å¼åˆ™ä¸ºï¼š <span class="math display">\[\text{dequant}(c^{\text{FP32}}, X^{\text{Int8}})= \frac{X^{\text{Int8}}}{c^{\text{FP32}}}\]</span></p><p>æŒ‰ç…§é‡åŒ–è¿‡ç¨‹æ˜¯å¦ä»¥0ç‚¹ä¸ºå¯¹ç§°ç‚¹é‡åŒ–åˆå¯ä»¥åˆ†ä¸ºå¯¹ç§°é‡åŒ–å’Œéå¯¹ç§°é‡åŒ–ã€‚å…¶ä¸­å¯¹ç§°é‡åŒ–å°†åŸæµ®ç‚¹æ•°çš„æœ€å°æˆ–æœ€å¤§å€¼çš„ç»å¯¹å€¼ä½œä¸ºæ˜ å°„å€¼çš„èŒƒå›´ï¼Œè€Œéå¯¹ç§°é‡åŒ–æ˜¯å°†åŸæµ®ç‚¹æ•°çš„æœ€å°å’Œæœ€å¤§å€¼æ˜ å°„ä¸ºé‡åŒ–æ•°æ®çš„æœ€å°å’Œæœ€å¤§å€¼ã€‚åœ¨éå¯¹ç§°é‡åŒ–ä¸­ï¼Œ0çš„æ˜ å°„ä¹Ÿå¯èƒ½ä¼šæœ‰åç§»ï¼Œå› æ­¤ä¸ä¸€å®šä¼šè¢«æ˜ å°„åˆ°0ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205004225.png"></p><h4 id="åˆ†ä½æ•°é‡åŒ–">åˆ†ä½æ•°é‡åŒ–</h4><p>åˆ†ä½æ•°é‡åŒ–ï¼ˆQuantileQuantizationï¼‰æ˜¯éš¶å±äºéçº¿æ€§é‡åŒ–ã€‚åˆ†ä½æ•°ï¼ˆQuantileï¼‰åœ¨æ•°å­¦ä¸Šçš„å®šä¹‰æŒ‡çš„æ˜¯æŠŠé¡ºåºæ’åˆ—çš„ä¸€ç»„æ•°æ®åˆ†å‰²ä¸ºè‹¥å¹²ä¸ªç›¸ç­‰å—çš„åˆ†å‰²ç‚¹çš„æ•°å€¼ã€‚åœ¨æ ‡å‡†æ­£æ€åˆ†å¸ƒä¸­ï¼Œå¯¹äºåˆ†å¸ƒXç»™å®šçš„æ¦‚ç‡<span class="math inline">\(\alpha\)</span>ï¼Œå¦‚æœå­˜åœ¨<span class="math inline">\(\mu_\alpha\)</span>ä½¿å¾—å®ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCDFï¼‰<span class="math inline">\(P(X &lt; \mu_\alpha)= \alpha\)</span>ï¼Œåˆ™ç§°<span class="math inline">\(\mu_\alpha\)</span>æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ <span class="math inline">\(\alpha\)</span>åˆ†ä½æ•°ï¼Œå› ä¸ºCDFè¡¨ç¤ºçš„æ˜¯æ¦‚ç‡å€¼å°äº<span class="math inline">\(\mu_\alpha\)</span>çš„é˜´å½±éƒ¨åˆ†çš„é¢ç§¯ï¼Œå› æ­¤å…·æœ‰ä¸¥æ ¼é€’å¢çš„ç‰¹æ€§ï¼Œæ‰€ä»¥å®ƒä¸€å®šå­˜åœ¨åå‡½æ•°ã€‚CDFçš„åå‡½æ•°çš„ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯ç”¨æ¥ç”Ÿæˆæœä»è¯¥éšæœºåˆ†å¸ƒçš„éšæœºå˜é‡ã€‚å‡è®¾aæ˜¯[0,1)åŒºé—´ä¸Šå‡åŒ€åˆ†å¸ƒçš„ä¸€ä¸ªéšæœºå˜é‡ï¼Œé‚£ä¹ˆ<span class="math inline">\(F_{X}^{-1}(a)\)</span>æœä»åˆ†å¸ƒ<span class="math inline">\(X\)</span>ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205004852.png"></p><p><strong>åˆ†ä½æ•°é‡åŒ–æ˜¯é€šè¿‡åˆ†ä½æ•°å°†å¼ é‡åˆ†æˆäº†å¤§å°ç›¸åŒçš„è‹¥å¹²ä¸ªå—ï¼Œè¿™æ ·æˆ‘ä»¬å¾—åˆ°æ›´åŠ å‡åŒ€çš„é‡åŒ–ç‰¹å¾</strong>ï¼Œå¯¹äº4æ¯”ç‰¹é‡åŒ–ï¼Œæˆ‘ä»¬å¸Œæœ›éœ€è¦æ‰¾åˆ°15ä¸ªåˆ†ä½æ•°æ¥å°†è¿™ä¸ªæ›²çº¿ä¸‹é¢çš„é¢ç§¯ï¼ˆç§¯åˆ†ï¼‰ç­‰åˆ†æˆ16ä»½ã€‚ä¸¤ä¸ªåˆ†ä½æ•°çš„ä¸­ç‚¹ä¾¿æ˜¯æ¨¡å‹é‡åŒ–åˆ°è¿™ä¸ªåŒºé—´æ˜ å°„çš„å€¼<span class="math inline">\(q_i\)</span>ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205005255.png"></p><p>ç”±äºå¤§æ¨¡å‹å‚æ•°é€šå¸¸æœä»æ­£æ€åˆ†å¸ƒï¼Œå› æ­¤æœ‰ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205015121.png">å…¶ä¸­<span class="math inline">\(Q\)</span>æ˜¯CSFçš„åå‡½æ•°ã€‚</p><h4 id="åˆ†å—kä½é‡åŒ–">åˆ†å—kä½é‡åŒ–</h4><p>å¸¸è§„çš„é‡åŒ–æ–¹æ³•çš„å±€é™æ€§æ˜¯å½“ tensor ä¸­æœ‰ä¸€ä¸ªéå¸¸å¤§çš„æ•°å­—ï¼ˆä¸€èˆ¬ç§°ä¸ºoutlierï¼‰æ—¶ï¼Œå¯¼è‡´å¤§å¤šæ•°å€¼è¢«å‹ç¼©åˆ°è¾ƒå°çš„èŒƒå›´ï¼Œç²¾åº¦æŸå¤±å¤§ï¼Œå½±å“æœ€ç»ˆçš„é‡åŒ–ç»“æœã€‚</p><p>å› æ­¤ï¼ŒBlock-wise k-bit Quantization æ–¹æ³•å°±æ˜¯æŠŠ tensor åˆ†å‰²æˆ Bå—ï¼Œæ¯å—æœ‰è‡ªå·±çš„é‡åŒ–å¸¸æ•°cï¼Œç‹¬è‡ªé‡åŒ–ã€‚ä»è€Œè§£å†³æ¨¡å‹å‚æ•°çš„æå¤§æå°çš„å¼‚å¸¸å€¼çš„é—®é¢˜ã€‚åˆ†å—é‡åŒ–çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯å‡å°‘äº†æ ¸ä¹‹é—´çš„é€šä¿¡ï¼Œå¯ä»¥å®ç°æ›´å¥½çš„å¹¶è¡Œæ€§ï¼Œå¹¶å……åˆ†åˆ©ç”¨ç¡¬ä»¶çš„å¤šæ ¸çš„èƒ½åŠ›ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205010158.png"></p><h3 id="ä½æ ‡å‡†æµ®ç‚¹é‡åŒ–---nf4">4ä½æ ‡å‡†æµ®ç‚¹é‡åŒ–---NF4</h3><p>4-bit NormlFLoat é‡åŒ–æ˜¯ç»“åˆäº†åˆ†ä½æ•°é‡åŒ–å’Œåˆ†å—é‡åŒ–ï¼Œä½¿ç”¨ä¸Šé¢ä»‹ç»çš„åˆ†ä½æ•°é‡åŒ–æ–¹æ³•æˆ‘ä»¬å¯ä»¥å°†FP2ç²¾åº¦é‡åŒ–åˆ°4bitçš„ç²¾åº¦ï¼Œä½†æ˜¯ç›´æ¥è¿™ä¹ˆç”¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä¸èƒ½ä¿è¯é«˜ç²¾åº¦çš„0ä¸€å®šè¢«æ˜ å°„åˆ°ä½ç²¾åº¦çš„0ï¼Œä½†æ˜¯0ç‚¹åˆæ˜¯æ·±åº¦å­¦ä¹ ä¸­ä¸€ä¸ªé‡è¦çš„å€¼ï¼Œä¾‹å¦‚åœ¨æ¨¡å‹ç¨€ç–åŒ–ï¼Œæ•°æ®paddingçš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨0æ¥å®Œæˆã€‚</p><p>å‡è®¾offsetçš„å€¼æ˜¯0.99ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ç‰‡æ®µè®¡ç®—å‡ºå®ƒçš„16ä¸ª <span class="math inline">\(q_i\)</span>ã€‚ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">offset = 0.99num_bins = 16quantile = norm.ppf(torch.linspace(1 - offset, offset, num_bins + 1)).tolist() # å°†[1-offset,offset]åŒºé—´ç­‰åˆ†ä¸º16ä»½tmp = [(quantile[1:][idx] + val) / 2 for idx, val in enumerate(quantile[:-1])] # è®¡ç®—åˆ†ä½æ•°r_max, r_min = tmp[-1], tmp[0]S = (r_max - r_min)/(1 - (-1))Z = 1 - r_max / SQ = [x/S + Z for x in tmp] # åˆ†ä½æ•°é‡åŒ–åˆ°[-1,1]print (Q)&gt;&gt;&gt; Q = [-1.0, -0.680534899946304, -0.5217156169574965, -0.4015399993912077, -0.299784167882981, -0.20835410767681603, -0.12291223249970012, -0.040639059218818274, 0.04063881956774142, 0.12291199284862328, 0.20835391124150712, 0.2997839714476721, 0.40153976366883704, 0.5217154126647753, 0.6805348056573558, 1.0]</code></pre><p></p><p>è¿™ç§æ–¹å¼çš„ä¸€ä¸ªé—®é¢˜æ˜¯0çš„æ˜ å°„å€¼ä¸æ˜¯0ï¼Œå¦‚æœæˆ‘ä»¬è€ƒè™‘å¥‡æ•°ä¸ªbinï¼Œ0æ˜¯å¯ä»¥æœ‰ä¸ªæ˜ å°„å€¼ä½†æ˜¯å´æ— æ³•å……åˆ†åˆ©ç”¨4æ¯”ç‰¹çš„16ä½çš„ä¿¡æ¯ã€‚ä¸ºäº†ç¡®ä¿é›¶ç‚¹æ˜ å°„åˆ°0å¹¶ä¸”ä½¿ç”¨4ä½æ•°æ®ç±»å‹çš„å…¨éƒ¨16ä½ï¼Œæˆ‘ä»¬é€šè¿‡ä¼°è®¡æ­£è´Ÿä¸¤ä¸ªèŒƒå›´çš„åˆ†ä½æ•°æ¥åˆ›å»ºä¸€ä¸ªéå¯¹ç§°çš„æ•°æ®ç±»å‹ï¼šè´Ÿæ•°éƒ¨åˆ†æ˜ å°„å…¶ä¸­7ä½ï¼Œæ­£æ•°éƒ¨åˆ†æ˜ å°„8ä½ï¼Œ0å æ®1ä½ï¼Œæ€»å…±ç”¨æ»¡äº†4ä½æ•°çš„16ä½ã€‚å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹ç§°çš„é‡åŒ–ï¼Œå…¶ä¸­æ­£æ•°å’Œè´Ÿæ•°å‡ä½¿ç”¨7ä½ï¼Œ0å ç”¨2ä¸ªä½ã€‚æˆ‘è¿™é‡Œå’Œè®ºæ–‡ä»‹ç»çš„ç•¥æœ‰ä¸åŒï¼Œè®ºæ–‡è¯´çš„æ˜¯æ­£æ•°éƒ¨åˆ†å–9ä¸ªå€¼ï¼Œè´Ÿæ•°éƒ¨åˆ†å–8ä¸ªå€¼ï¼Œä¸è¿‡å®ƒä»¬éƒ½ä¼šå–åˆ°0ï¼Œæ‰€ä»¥åˆå¹¶æ—¶å†å»æ‰ä¸€ä¸ªé‡å¤çš„0ï¼Œè¿™ä¸¤ä¸ªè¯´æ³•å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ç°æ–¹å¼ç•¥æœ‰å·®å¼‚ã€‚</p><p>æ¥ä¸‹æ¥æ ¹æ®ä½œè€…çš„æºç æ¥çœ‹ä¸‹é‡åŒ–åˆ†ä½æ•°å¦‚ä½•è®¡ç®—çš„ã€‚å…¶ä¸­æ ¸å¿ƒä»£ç ç‰‡æ®µæ‘˜æŠ„å¦‚ä¸‹ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">from scipy.stats import normimport torchdef create_normal_map(offset=0.9677083, use_extra_value=True, num_bins=16):    # INT8 : num_bins = 256    # INT4 : num_bins = 16    if use_extra_value:        # one more positive value, this is an asymmetric type        v1 = norm.ppf(torch.linspace(offset, 0.5, 9)[:-1]).tolist() # æ­£æ•°éƒ¨åˆ†        v2 = [0]*(num_bins-15) ## we have 15 non-zero values in this data type        v3 = (-norm.ppf(torch.linspace(offset, 0.5, 8)[:-1])).tolist() #è´Ÿæ•°éƒ¨åˆ†        v = v1 + v2 + v3    else:        v1 = norm.ppf(torch.linspace(offset, 0.5, 8)[:-1]).tolist()        v2 = [0]*(num_bins-14) ## we have 14 non-zero values in this data type        v3 = (-norm.ppf(torch.linspace(offset, 0.5, 8)[:-1])).tolist()        v = v1 + v2 + v3    values = torch.Tensor(v)    values = values.sort().values    values /= values.max()    assert values.numel() == num_bins    return values    Q = create_normal_map()&gt;&gt;&gt; Q = [-1.0, -0.6961928009986877, -0.5250730514526367, -0.39491748809814453, -0.28444138169288635, -0.18477343022823334, -0.09105003625154495, 0.0, 0.07958029955625534, 0.16093020141124725,0.24611230194568634, 0.33791524171829224, 0.44070982933044434, 0.5626170039176941, 0.7229568362236023, 1.0]å‡½æ•°create_normal_mapæœ‰ä¸¤ä¸ªå…¥å‚ï¼šoffsetå’Œuse_extra_valueã€‚å…¶ä¸­offsetçš„ä½œç”¨æ˜¯ç¡®å®šåˆ†ä½æ•°çš„å§‹æœ«å€¼ã€‚use_extra_valueç”¨æ¥æ§åˆ¶æ˜¯ä½¿ç”¨å¯¹ç§°é‡åŒ–è¿˜æ˜¯éå¯¹ç§°é‡åŒ–ã€‚v1è®¡ç®—æ­£æ•°éƒ¨åˆ†ï¼Œv3è®¡ç®—è´Ÿæ•°éƒ¨åˆ†ã€‚v2ç›´æ¥å°†0æ˜ å°„åˆ°0ï¼Œå¹¶ä¸”æ ¹æ®è¦é‡åŒ–çš„å•ä½è®¡ç®—0çš„ä¸ªæ•°ã€‚æºç æ˜¯ä½¿ç”¨NF4æ¥è¡¨ç¤º8æ¯”ç‰¹çš„é‡åŒ–ï¼Œå¦‚æœæ˜¯ä½¿ç”¨4æ¯”ç‰¹çš„é‡åŒ–ï¼Œæˆ‘ä»¬å°†é‡Œé¢çš„256æ”¹æˆ16å°±è¡Œã€‚æ¥ä¸‹æ¥æœ€åå‡ è¡Œç”¨æ¥å°†é‡åŒ–å€¼å½’ä¸€åŒ–åˆ°[-1,1]ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸€ä¸ªå…·ä½“çš„å®ä¾‹ã€‚å‡è®¾ä¸€ä¸ªå¼ é‡æœ‰16ä¸ªå€¼ï¼Œå®ƒçš„è¢«åˆ†æˆäº†4å—ï¼š```pythoninput_blocked_tensor = [[-1.28645003578589, -1.817660483275528, 9.889441349505042, 0.010208034676132627], [ -15.009014631551885, 1.4136255086268115, -7.815595761491153, 10.766760590950263],  [-0.731406153917959, 3.468224595908726, 2.445252541840315, -8.970824523299282],  [-9.641638854625175, 7.696158363188889, -5.323939281255154, 5.97160401402024]]</code></pre>æ ¹æ®æ¯ä¸ªå—çš„ç‰¹å¾çš„ç»å¯¹å€¼çš„æœ€å¤§å€¼ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªå—ä¿å­˜ä¸€ä¸ªé‡åŒ–å¸¸æ•°ï¼Œå®ƒçš„è®¡ç®—æ–¹å¼æ˜¯æ¯ä¸ªå—ä¸­ç‰¹å¾çš„ç»å¯¹å€¼ä¸­æœ€å¤§çš„é‚£ä¸ªï¼š<pre class="line-numbers language-python" data-language="python"><code class="language-python">c1 = max(|-1.28645003578589|, |-1.817660483275528|, |9.889441349505042|, |0.010208034676132627|) = 9.889441349505042c2 = max(|-15.009014631551885|, |1.4136255086268115|, |-7.815595761491153|, |10.766760590950263|) = 15.009014631551885c3 = max(|-0.731406153917959|, |3.468224595908726|, |2.445252541840315|, |-8.970824523299282|) = 8.970824523299282c4 = max(|-9.641638854625175|, |7.696158363188889|, |-5.323939281255154|, |5.97160401402024|) = 9.641638854625175</code></pre><p></p><p>æœ€åæˆ‘ä»¬ä¾¿å¯ä»¥è®¡ç®—è¿™ä¸ªå¼ é‡çš„é‡åŒ–å€¼äº†ã€‚ä¾‹å¦‚ç¬¬ä¸€ä¸ªå€¼-1.28645003578589ï¼Œå®ƒé™¤ä»¥è¿™ä¸ªå—çš„é‡åŒ–å¸¸æ•°c1åå¾—åˆ°-0.13008318572517502ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦æŒ‰ç…§åˆ†ä½æ•°çš„å€¼æ¥é‡åŒ–è¿™ä¸ªå€¼ã€‚-0.13008318572517502åœ¨Qä¸­æœ€æ¥è¿‘çš„å€¼æ˜¯-0.12291223249970012ï¼Œè¿™ä¸ªå€¼åœ¨Qä¸­å¯¹åº”çš„ç´¢å¼•æ˜¯6ï¼Œå› æ­¤è¿™ä¸ªå€¼è¢«é‡åŒ–åçš„å€¼æ˜¯6ã€‚åŒç†æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™ä¸ªè¾“å…¥å¼ é‡æ‰€æœ‰çš„å€¼é‡åŒ–åçš„ç»“æœã€‚<strong>åœ¨æ¨¡å‹ä¿å­˜æ—¶ï¼Œé™¤äº†è¦ä¿å­˜é‡åŒ–åçš„å€¼ï¼Œæˆ‘ä»¬è¿˜è¦ä¿å­˜æ¯ä¸ªå—å¯¹åº”çš„é‡åŒ–å¸¸æ•°c_i</strong>ï¼Œå› ä¸ºè¿™ä¸ªå€¼åœ¨æˆ‘ä»¬è¿›è¡Œåé‡åŒ–æ—¶éœ€è¦ç”¨åˆ°ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">[[6, 5, 15, 7],[0, 8, 2, 14],[6, 11, 10, 0],[0, 14, 2, 13]]</code></pre>åœ¨åé‡åŒ–æ—¶ï¼Œæˆ‘ä»¬ä»¥é‡åŒ–ç»“æœä½œä¸ºç´¢å¼•ï¼Œä»Qä¸­æŸ¥æ‰¾åˆ°å®ƒå¯¹åº”çš„åˆ†ä½æ•°ï¼Œå†ä¹˜ä»¥ä¸ºæ¯ä¸ªå—ä¿å­˜çš„é‡åŒ–å¸¸æ•°c_iï¼Œä¾¿å¯ä»¥å¾—åˆ°æœ€ç»ˆç»“æœã€‚<pre class="line-numbers language-python" data-language="python"><code class="language-python">[[-0.9004339933799617, -1.8273060011889755, 9.889441349505042, 0.0], [-15.009014631551885, 1.1944218804231184,  -7.880829111886221,  10.850869732860506], [-0.816793898052648, 3.0313783372030603, 2.2078302737800004, -8.970824523299282], [-9.641638854625175, 6.970488722350373, -5.062564734402345, 5.424549965245643]]</code></pre><p></p><h3 id="åŒé‡åŒ–">åŒé‡åŒ–</h3><p>åœ¨ä¸Šé¢æˆ‘ä»¬ä»‹ç»åˆ°ï¼Œå½“æˆ‘ä»¬ä¿å­˜æ¨¡å‹æ—¶æˆ‘ä»¬ä¸ä»…è¦ä¿å­˜é‡åŒ–åçš„ç»“æœï¼Œè¿˜è¦ä¿å­˜æ¯ä¸ªå—çš„é‡åŒ–å¸¸æ•°ã€‚è™½ç„¶é‡åŒ–åçš„å‚æ•°åªæœ‰4bitçš„ç²¾åº¦ï¼Œä½†æ˜¯è¿™ä¸ªé‡åŒ–å¸¸é‡çš„ç²¾åº¦æ˜¯float32ã€‚</p><p>**åœ¨QLoRAä¸­ï¼Œæ¯ä¸ªå—çš„å¤§å°æ˜¯64ï¼Œå—ä¸­çš„æ¯ä¸ªå€¼å 4æ¯”ç‰¹ã€‚è¿™ç›¸å½“äºä¸ºäº†å­˜å‚¨é‡åŒ–å¸¸æ•°ï¼Œæ¨¡å‹è¦é¢å¤–å ç”¨32/ï¼ˆ64*4ï¼‰=12.5% çš„æ˜¾å­˜ã€‚**</p><p>QLoRAçš„åŒé‡é‡åŒ–å°±æ˜¯å¯¹è¿™ä¸ªé‡åŒ–å¸¸æ•°å†åšä¸€æ¬¡8bitçš„é‡åŒ–ï¼Œåœ¨è¿›è¡Œé‡åŒ–å¸¸æ•°çš„é‡åŒ–æ—¶ï¼ŒQLoRAä»¥æ¯256ä¸ªé‡åŒ–å¸¸æ•°ä¸ºä¸€ç»„å†åšä¸€æ¬¡é‡åŒ–ã€‚å› æ­¤å®ƒé¢å¤–å¢åŠ çš„å†…å­˜æ¶ˆè€—æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯é‡åŒ–åçš„8bitçš„ç¬¬ä¸€å±‚çš„é‡åŒ–å¸¸æ•°ï¼Œå®ƒé¢å¤–å¢åŠ çš„æ˜¾å­˜å æ¯”æ˜¯8/ï¼ˆ64x4ï¼‰= 3.125%ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ä¸ºé‡åŒ–å¸¸æ•°åšé‡åŒ–çš„ç¬¬äºŒå±‚çš„32bitçš„é‡åŒ–å¸¸æ•°ï¼Œå®ƒé¢å¤–å¢åŠ çš„æ˜¾å­˜å æ¯”æ˜¯32/ï¼ˆ256x64x4ï¼‰=0.049%ï¼Œé¢å¤–æ˜¾å­˜å¢åŠ åªæœ‰3.17%ã€‚</p><h3 id="åˆ†é¡µä¼˜åŒ–å™¨">åˆ†é¡µä¼˜åŒ–å™¨</h3><p>åˆ†é¡µä¼˜åŒ–æ˜¯é’ˆå¯¹æ¢¯åº¦æ£€æŸ¥ç‚¹åšçš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä»¥é˜²æ­¢åœ¨æ˜¾å­˜ä½¿ç”¨å³°å€¼æ—¶å‘ç”Ÿæ˜¾å­˜OOMçš„é—®é¢˜ã€‚QLoRAåˆ†é¡µä¼˜åŒ–å…¶å®å°±æ˜¯å½“æ˜¾å­˜ä¸è¶³æ˜¯ï¼Œå°†ä¿å­˜çš„éƒ¨åˆ†æ¢¯åº¦æ£€æŸ¥ç‚¹è½¬ç§»åˆ°CPUå†…å­˜ä¸Šï¼Œå’Œè®¡ç®—æœºçš„å†…å­˜æ•°æ®è½¬ç§»åˆ°ç¡¬ç›˜ä¸Šçš„å¸¸è§„å†…å­˜åˆ†é¡µä¸€ä¸ªé“ç†ã€‚</p><h3 id="å®ç°">å®ç°</h3><p>è¦ä½¿ç”¨ HuggingFace è¿›è¡Œ QLoRA å¾®è°ƒï¼Œæ‚¨éœ€è¦å®‰è£…BitsandBytes åº“å’Œ PEFTåº“ã€‚BitsandBytes åº“è´Ÿè´£ 4 ä½é‡åŒ–ä»¥åŠæ•´ä¸ªä½ç²¾åº¦å­˜å‚¨å’Œé«˜ç²¾åº¦è®¡ç®—éƒ¨åˆ†ã€‚PEFTåº“å°†ç”¨äº LoRA å¾®è°ƒéƒ¨åˆ†ã€‚ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">import torchfrom peft import prepare_model_for_kbit_training, LoraConfig, get_peft_modelfrom transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfigmodel_id = "EleutherAI/gpt-neox-20b"bnb_config = BitsAndBytesConfig(    load_in_4bit=True,    bnb_4bit_use_double_quant=True,    bnb_4bit_quant_type="nf4",    bnb_4bit_compute_dtype=torch.bfloat16) # setup bits and bytes configmodel = AutoModelForCausalLM.from_pretrained(model_id, quantization_config=bnb_config, device_map={"":0})model.gradient_checkpointing_enable()model = prepare_model_for_kbit_training(model) # prepares the whole model for kbit trainingconfig = LoraConfig(    r=8,     lora_alpha=32,     target_modules=["query_key_value"],     lora_dropout=0.05,     bias="none",     task_type="CAUSAL_LM")model = get_peft_model(model, config) # Now you get a model ready for QLoRA training</code></pre>åœ¨æ¨¡å‹çš„å¾®è°ƒè¿‡ç¨‹ä¸­ï¼Œè™½ç„¶ä¸»å¹²å‚æ•°ä»¥ 4-bitç²¾åº¦å­˜å‚¨ï¼Œä½†è®¡ç®—ï¼ˆä¾‹å¦‚å‰å‘ä¼ æ’­ã€åå‘ä¼ æ’­å’Œæ¢¯åº¦è®¡ç®—ï¼‰å¯ä»¥ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æ•°æ®ç±»å‹<code>bnb_4bit_compute_dtype</code>ï¼Œä»¥å‡å°‘ç”±äºä½ç²¾åº¦å­˜å‚¨å¼•èµ·çš„ç´¯ç§¯è¯¯å·®ã€‚<p></p><p>å‚è€ƒèµ„æ–™ï¼š &gt; https://arxiv.org/pdf/2106.09685</p><blockquote><p>https://arxiv.org/abs/2305.14314</p></blockquote><blockquote><p>https://zhuanlan.zhihu.com/p/623543497</p></blockquote><blockquote><p>https://mingchao.wang/ShYWOOwr/</p></blockquote><blockquote><p>https://zhuanlan.zhihu.com/p/690739797</p></blockquote><blockquote><p>https://zhuanlan.zhihu.com/p/666234324</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> LoRA </tag>
            
            <tag> PEFT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹ä¼˜åŒ–--PagedAttention</title>
      <link href="/2024/12/03/da-mo-xing-you-hua-pagedattention/"/>
      <url>/2024/12/03/da-mo-xing-you-hua-pagedattention/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åŸºäºKV Cacheçš„å¤§æ¨¡å‹æ¨ç†è¿‡ç¨‹é€šå¸¸åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šPrefill å’ŒDecodingã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205200821.png"></p><p>åœ¨ Prefill é˜¶æ®µï¼Œæ¨ç†å¼•æ“å°†æ•´æ®µ promptè¾“å…¥æ¨¡å‹è¿›è¡Œå‰å‘è®¡ç®—ã€‚å¦‚æœå¼•å…¥äº† KV Cache æŠ€æœ¯ï¼Œprompt ç» Wk å’Œ Wvè®¡ç®—å¾—åˆ°çš„ç»“æœï¼ˆå³ K å’Œ Vï¼‰ä¼šè¢«å­˜å‚¨åˆ° K Cache å’Œ V Cacheä¸­ã€‚è¿™æ ·ï¼Œåœ¨åç»­ token çš„ Attention è®¡ç®—ä¸­ï¼Œæ— éœ€é‡å¤è®¡ç®— K å’ŒVï¼Œä»è€Œæ˜¾è‘—èŠ‚çº¦è®¡ç®—æ—¶é—´ã€‚</p><p>è¿›å…¥ Decoding é˜¶æ®µåï¼Œæ¨ç†å¼•æ“ä¼šåŸºäº Prefillé˜¶æ®µçš„ç»“æœï¼Œé€æ­¥ç”Ÿæˆå“åº”ï¼Œæ¯æ¬¡è¾“å‡ºä¸€ä¸ª tokenã€‚å¦‚æœåŒæ ·ä½¿ç”¨äº† KVCacheï¼Œæ¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œéƒ½ä¼šå°†å…¶å¯¹åº”çš„ K å’Œ Vå€¼å­˜å…¥ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ¨ç†ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ª13Bçš„æ¨¡å‹åœ¨A10040GBçš„gpuä¸Šåšæ¨ç†æ—¶çš„æ˜¾å­˜å ç”¨åˆ†é…ï¼ˆothersè¡¨ç¤ºforwardè¿‡ç¨‹ä¸­äº§ç”Ÿçš„activationçš„å¤§å°ï¼Œè¿™äº›activationä½ å¯ä»¥è®¤ä¸ºæ˜¯è½¬ç¬å³é€çš„ï¼Œå³ç”¨å®Œåˆ™åºŸï¼Œå› æ­¤å®ƒä»¬å æ®çš„æ˜¾å­˜ä¸å¤§ï¼‰ï¼Œä»è¿™å¼ å›¾ä¸­æˆ‘ä»¬å¯ä»¥ç›´è§‚æ„Ÿå—åˆ°æ¨ç†ä¸­KVcacheå¯¹æ˜¾å­˜çš„å ç”¨ã€‚å› æ­¤ï¼Œ<strong>å¦‚ä½•ä¼˜åŒ–KVcacheï¼ŒèŠ‚çœæ˜¾å­˜ï¼Œæé«˜æ¨ç†ååé‡ï¼Œå°±æˆäº†LLMæ¨ç†æ¡†æ¶éœ€è¦è§£å†³çš„é‡ç‚¹é—®é¢˜ã€‚</strong><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205201020.png"></p><h2 id="kv-cacheçš„å¸¸è§„å­˜å‚¨åˆ†é…">KV Cacheçš„å¸¸è§„å­˜å‚¨åˆ†é…</h2><p>ç”±äºæ¨ç†æ‰€ç”Ÿæˆçš„åºåˆ—é•¿åº¦å¤§å°æ— æ³•äº‹å…ˆé¢„çŸ¥ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ¨ç†æ¡†æ¶éƒ½ä¼šæŒ‰batch_size x max_seq_lenè¿™æ ·çš„å›ºå®šå°ºå¯¸æ¥åˆ†é…ã€‚åœ¨è¯·æ±‚åˆ°æ¥æ—¶ï¼Œé¢„å…ˆåœ¨æ˜¾å­˜ä¸­ç”³è¯·ä¸€å—è¿ç»­çš„åŒºåŸŸã€‚ç„¶è€Œï¼Œè¿™ç§â€œé™æ€â€æ˜¾å­˜åˆ†é…ç­–ç•¥ï¼Œæ˜¾å­˜åˆ©ç”¨ç‡æ˜¯å¾ˆä½çš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205201213.png"></p><p>æˆ‘ä»¬å‡è®¾ max_seq_len =8ï¼Œæ‰€ä»¥å½“ç¬¬1æ¡è¯·æ±‚(prompt1)è¿‡æ¥æ—¶ï¼Œæˆ‘ä»¬çš„æ¨ç†æ¡†æ¶ä¸ºå®ƒå®‰æ’äº†(1,8)å¤§å°çš„è¿ç»­å­˜å‚¨ç©ºé—´ã€‚</p><p>å½“ç¬¬2æ¡è¯·æ±‚ï¼ˆprompt2ï¼‰è¿‡æ¥æ—¶ï¼ŒåŒæ ·ä¹Ÿéœ€è¦1å—(1,8)å¤§å°çš„å­˜å‚¨ç©ºé—´ã€‚ä½†æ­¤æ—¶prompt1æ‰€åœ¨çš„ä½ç½®ä¸Šï¼Œåªå‰©3ä¸ªç©ºæ ¼å­äº†ï¼Œæ‰€ä»¥å®ƒåªèƒ½å¦èµ·ä¸€è¡Œåšå­˜å‚¨ã€‚å¯¹prompt3ä¹Ÿæ˜¯åŒç†ã€‚</p><p>é—®é¢˜ï¼š</p><ul><li>æµ…è‰²å—ï¼šprefillé˜¶æ®µpromptçš„KVcacheï¼Œæ˜¯æ— è®ºå¦‚ä½•éƒ½ä¼šè¢«ä½¿ç”¨çš„ç©ºé—´ï¼Œå®ƒä¸å­˜åœ¨æµªè´¹ã€‚</li><li>ä¸­è‰²å—ï¼šdecodeé˜¶æ®µçš„KVcacheï¼Œå…¶ä¸­<eos>è¡¨ç¤ºåºåˆ—ç”Ÿæˆçš„æˆªæ­¢ç¬¦ã€‚è™½ç„¶è¿™äº›ä¸­è‰²å—æœ€ç»ˆéƒ½ä¼šè¢«æˆ‘ä»¬ç”¨ä¸Šï¼Œä½†æ˜¯åœ¨decodeé˜¶æ®µä¸€ä¸ªä¸ªtokenç”Ÿæˆæ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½é¢„çŸ¥å“ªäº›å—ä¼šè¢«æœ€ç»ˆç”¨ä¸Šï¼Œå¯¼è‡´ä¸€ç§â€œæ½œåœ¨çš„æµªè´¹â€ï¼Œç§°ä¸º<strong>é¢„ç•™ç¢ç‰‡ï¼ˆreservation fragmentï¼‰</strong>ã€‚</eos></li><li>æ·±è‰²å—ï¼šdecodeé˜¶æ®µé¢„ç•™ç©ºé—´ä½†æ˜¯æœ€ç»ˆæ²¡æœ‰ç”¨ä¸Šï¼Œç§°ä¸º<strong>å†…éƒ¨ç¢ç‰‡ï¼ˆinternalfragmentï¼‰</strong>ã€‚</li><li>ç°è‰²å—ï¼šä¸æ˜¯é¢„ç•™çš„KVcacheçš„ä¸€éƒ¨åˆ†ï¼Œä¸”æœ€ç»ˆä¹Ÿæ²¡æœ‰è¢«ç”¨ä¸Šï¼Œç§°è¿™äº›ç°è‰²å—ä¸º<strong>å¤–éƒ¨ç¢ç‰‡ï¼ˆexternalfragmentï¼‰</strong>ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæ­¤æ—¶æ–°æ¥äº†ä¸€æ¡prompt4ï¼Œå®ƒä¹Ÿè¦æ±‚æ˜¾å­˜ä¸­çš„8ä¸ªæ ¼å­ä½œä¸ºKVcacheã€‚æ­¤æ—¶ä½ çš„æ˜¾å­˜ä¸Šæ˜æ˜æœ‰9ä¸ªç©ºæ ¼å­ï¼Œä½†å› ä¸ºå®ƒä»¬æ˜¯ä¸è¿ç»­çš„ç¢ç‰‡ï¼Œæ‰€ä»¥æ— æ³•è¢«prompt4æ‰€ä½¿ç”¨ã€‚è¿™æ—¶prompt4çš„è¿™æ¡è¯·æ±‚åªå¥½åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°gpuä¸Šæœ‰è¶³å¤Ÿæ˜¾å­˜èµ„æºæ—¶å†è¿›è¡Œæ¨ç†ã€‚</li></ul><p>è§‚å¯Ÿæ•´ä¸ªKV cacheæ’å¸ƒï¼Œä½ ä¼šå‘ç°å®ƒä»¬çš„æ¯›ç—…åœ¨äºå¤ªè¿‡<strong>â€œé™æ€åŒ–â€</strong>ã€‚å½“ä½ æ— æ³•é¢„çŸ¥åºåˆ—å¤§å°æ—¶ï¼Œä½ ä¸ºä»€ä¹ˆä¸€å®šè¦æ­»æ¿åœ°ä¸ºæ¯ä¸ªåºåˆ—é¢„ç•™KVcacheç©ºé—´å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½åšå¾—æ›´åŠ¨æ€åŒ–ä¸€äº›ï¼Œå³â€œç”¨å¤šå°‘å å¤šå°‘â€å‘¢ï¼Ÿè¿™æ ·æˆ‘ä»¬å°±èƒ½å‡å°‘ä¸Šè¿°è¿™äº›å­˜å‚¨ç¢ç‰‡ï¼Œä½¿å¾—æ¯ä¸€æ—¶åˆ»æ¨ç†æœåŠ¡èƒ½å¤„ç†çš„è¯·æ±‚æ›´å¤šï¼Œæé«˜ååé‡ï¼Œè¿™å°±æ˜¯vLLMåœ¨åšçš„æ ¸å¿ƒäº‹æƒ…ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ä¸€å¼ å®éªŒå›¾æ¥æ„Ÿå—ä¸‹vLLMåœ¨æ˜¾å­˜åˆ©ç”¨ä¸Šçš„æ”¹è¿›æ•ˆæœï¼ˆVSå…¶å®ƒæ¨ç†æ¡†æ¶ï¼‰ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205202611.png"></p><p>ä¸éš¾å‘ç°ï¼Œç›¸æ¯”äºåˆ«çš„æ¨ç†æ¡†æ¶ï¼ŒvLLMå‡ ä¹èƒ½åšåˆ°å°†æ˜¾å­˜å®Œå…¨æ‰“æ»¡ã€‚</p><h2 id="pagedattention">PagedAttention</h2><p>vLLMé€šè¿‡ä¸€ç§åä¸ºPagedAttentionçš„æŠ€æœ¯ï¼ŒåŠ¨æ€åœ°ä¸ºè¯·æ±‚åˆ†é…KVcacheæ˜¾å­˜ï¼Œæå‡æ˜¾å­˜åˆ©ç”¨ç‡ã€‚</p><p>æ•´ä½“ä¸Šæ¥è¯´ï¼ŒPagedAttentionçš„è®¾è®¡çµæ„Ÿæ¥è‡ªæ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿå†…å­˜çš„åˆ†é¡µç®¡ç†æŠ€æœ¯ã€‚</p><h3 id="æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜">æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜</h3><p>è™šæ‹Ÿå†…å­˜åˆ†é¡µæ˜¯ä¸€ç§æ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜çš„æŠ€æœ¯ï¼Œå®ƒå°†ç‰©ç†å†…å­˜æŠ½è±¡ä¸ºä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿æ¯ä¸ªè¿›ç¨‹éƒ½åƒæ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ã€‚åˆ†é¡µé€šè¿‡å°†å†…å­˜åˆ’åˆ†ä¸º<strong>å›ºå®šå¤§å°çš„é¡µï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰å’Œé¡µæ¡†ï¼ˆç‰©ç†å†…å­˜ï¼‰è¿›è¡Œç®¡ç†</strong>ã€‚é¡µè¡¨è®°å½•è™šæ‹Ÿé¡µåˆ°ç‰©ç†é¡µæ¡†çš„æ˜ å°„å…³ç³»ã€‚è‹¥è™šæ‹Ÿé¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œä¼šå‘ç”Ÿé¡µç¼ºå¤±ï¼ˆPageFaultï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¼šä»ç£ç›˜è°ƒå…¥å¯¹åº”é¡µã€‚åˆ†é¡µæé«˜äº†å†…å­˜åˆ©ç”¨ç‡ï¼Œå¹¶æ”¯æŒè¿›ç¨‹éš”ç¦»ä¸åŠ¨æ€å†…å­˜æ‰©å±•ã€‚</p><h4 id="åˆ†æ®µå¼å†…å­˜ç®¡ç†">åˆ†æ®µå¼å†…å­˜ç®¡ç†</h4><p>åœ¨åˆ†æ®µå¼å†…å­˜ç®¡ç†ä¸­ï¼Œè™šæ‹Ÿå†…å­˜ä¼šå°½é‡ä¸ºæ¯ä¸ªè¿›ç¨‹åœ¨ç‰©ç†å†…å­˜ä¸Šæ‰¾åˆ°ä¸€å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ï¼Œè®©è¿›ç¨‹åŠ è½½è‡ªå·±çš„å…¨éƒ¨ä»£ç ã€æ•°æ®ç­‰å†…å®¹ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205213618.png"></p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ3ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å„è‡ªä¸ºå®ƒä»¬åœ¨ç‰©ç†å†…å­˜ä¸Šæ˜ å°„äº†ä¸€å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œæˆ‘é‡Šæ”¾äº†è¿›ç¨‹2ï¼ŒåŒæ—¶æƒ³è¿è¡Œè¿›ç¨‹4ã€‚è¿™æ—¶æˆ‘å°´å°¬åœ°å‘ç°ï¼Œè™½ç„¶ç‰©ç†å†…å­˜ä¸Šæœ‰640Mçš„ç©ºé—´å‰©ä½™ï¼Œä½†å› ä¸ºæ˜¯ç¢ç‰‡åŒ–çš„ï¼Œæˆ‘çš„è¿›ç¨‹4æ— æ³•åŠ è½½è¿›å»ï¼Œå› æ­¤å®ƒåªèƒ½ç­‰å¾…ã€‚</p><p>åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ç¡¬è¦è¿è¡Œè¿›ç¨‹4ï¼Œä¹Ÿæ˜¯æœ‰åŠæ³•çš„ï¼šæˆ‘å¯ä»¥å…ˆæŠŠè¿›ç¨‹3ä»ç‰©ç†å†…å­˜ä¸Šäº¤æ¢ï¼ˆswapï¼‰åˆ°ç£ç›˜ä¸Šï¼Œç„¶åæŠŠè¿›ç¨‹4è£…è¿›æ¥ï¼Œç„¶åå†æŠŠè¿›ç¨‹3ä»ç£ç›˜ä¸ŠåŠ è½½å›æ¥ã€‚é€šè¿‡è¿™ç§æ–¹æ³•æˆ‘é‡æ–°æ•´åˆäº†ç¢ç‰‡ï¼Œè®©è¿›ç¨‹4èƒ½å¤Ÿè¿è¡Œã€‚</p><p>ä½†è¿™ç§åŠæ³•çš„æ˜¾è‘—ç¼ºç‚¹æ˜¯ï¼šå¦‚æœè¿›ç¨‹3è¿‡å¤§ï¼ŒåŒæ—¶å†…å­˜åˆ°ç£ç›˜çš„å¸¦å®½åˆä¸å¤Ÿï¼Œæ•´ä¸ªäº¤æ¢çš„è¿‡ç¨‹å°±ä¼šéå¸¸å¡é¡¿ã€‚è¿™å°±æ˜¯åˆ†æ®µå¼å†…å­˜ç®¡ç†çš„ç¼ºé™·ã€‚</p><h4 id="åˆ†é¡µå¼å†…å­˜ç®¡ç†">åˆ†é¡µå¼å†…å­˜ç®¡ç†</h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205213826.png"></p><p>è™šæ‹Ÿå†…å­˜çš„åˆ†é¡µç®¡ç†æŠ€æœ¯æ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><ul><li>å°†ç‰©ç†å†…å­˜åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„å—ï¼Œæˆ‘ä»¬ç§°æ¯ä¸€å—ä¸ºé¡µï¼ˆpageï¼‰ã€‚ä»ç‰©ç†å†…å­˜ä¸­æ¨¡æ‹Ÿå‡ºæ¥çš„è™šæ‹Ÿå†…å­˜ä¹ŸæŒ‰ç›¸åŒçš„æ–¹å¼åšåˆ’åˆ†</li><li>å¯¹äº1ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦é™æ€åŠ è½½å®ƒçš„å…¨éƒ¨ä»£ç ã€æ•°æ®ç­‰å†…å®¹ã€‚æˆ‘ä»¬æƒ³ç”¨å“ªéƒ¨åˆ†ï¼Œæˆ–è€…å®ƒå½“å‰è·‘åˆ°å“ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬å°±åŠ¨æ€åŠ è½½è¿™éƒ¨åˆ†åˆ°è™šæ‹Ÿå†…å­˜ä¸Šï¼Œç„¶åç”±è™šæ‹Ÿå†…å­˜å¸®æˆ‘ä»¬åšç‰©ç†å†…å­˜çš„æ˜ å°„ã€‚</li><li>å¯¹äº1ä¸ªè¿›ç¨‹ï¼Œè™½ç„¶å®ƒåœ¨ç‰©ç†å†…å­˜ä¸Šçš„å­˜å‚¨ä¸è¿ç»­ï¼ˆå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„pageä¸­ï¼‰ï¼Œä½†å®ƒåœ¨è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ä¸Šæ˜¯è¿ç»­çš„ã€‚é€šè¿‡æ¨¡æ‹Ÿè¿ç»­å†…å­˜çš„æ–¹å¼ï¼Œæ—¢è§£å†³äº†ç‰©ç†å†…å­˜ä¸Šçš„ç¢ç‰‡é—®é¢˜ï¼Œä¹Ÿæ–¹ä¾¿äº†è¿›ç¨‹çš„å¼€å‘å’Œè¿è¡Œã€‚</li></ul><h3 id="pagedattention-å·¥ä½œæµç¨‹">PagedAttention å·¥ä½œæµç¨‹</h3><p>å‡è®¾ç°åœ¨ä½ å‘æ¨ç†å¼•æ“å‘é€è¯·æ±‚ï¼Œprompt ä¸º Four score and seven yearsago ourï¼Œä½ å¸Œæœ›æ¨¡å‹è¿›è¡Œç»­å†™ã€‚PagedAttention çš„è¿ä½œæµç¨‹å¦‚ä¸‹ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241206002752.png"></p><h4 id="prefill-é˜¶æ®µ">Prefill é˜¶æ®µï¼š</h4><p><strong>åˆ’åˆ†é€»è¾‘å—</strong>ï¼švLLM åœ¨æ¥æ”¶åˆ°è¿™æ¡ promptåï¼Œä¼šæ ¹æ®è®¾å®šçš„å—å¤§å° Bï¼ˆæœ¬ä¾‹ä¸­ B=4ï¼‰ï¼Œå°† promptåˆ’åˆ†ä¸ºè‹¥å¹²é€»è¾‘å—ï¼ˆLogical KV Blocksï¼‰ã€‚ç”±äºè¯¥ prompt åŒ…å« 7 ä¸ªtokenï¼Œå› æ­¤ vLLM ä½¿ç”¨ä¸¤ä¸ªé€»è¾‘å—ï¼ˆblock 0 å’Œ block 1ï¼‰æ¥å­˜å‚¨å®ƒä»¬çš„ KVå€¼ã€‚åœ¨é€»è¾‘å— 1 ä¸­ï¼Œç›®å‰ä»…å­˜å‚¨äº† "years"ã€"ago" å’Œ "hour" è¿™ 3 ä¸ª tokençš„ KV å€¼ï¼Œè¿˜æœ‰ 1 ä¸ªä½ç½®ä¸ºç©ºï¼Œç§°ä¸ºä¿ç•™ä½ï¼ˆReservationï¼‰ã€‚</p><p><strong>åˆ’åˆ†ç‰©ç†å—</strong>ï¼šå®Œæˆé€»è¾‘å—çš„åˆ’åˆ†åï¼Œè¿™äº›é€»è¾‘å—ä¼šæ˜ å°„åˆ°ç‰©ç†å—ï¼Œå³å®é™…å­˜å‚¨KV å€¼çš„ç©ºé—´ã€‚æ˜ å°„å…³ç³»é€šè¿‡ä¸€å¼  block tableï¼ˆå—è¡¨ï¼‰è®°å½•ï¼Œå…¶ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š- <strong>é€»è¾‘å—ä¸ç‰©ç†å—çš„æ˜ å°„å…³ç³»</strong>ï¼ˆPhysical BlockNumberï¼‰ï¼šä¾‹å¦‚ï¼Œé€»è¾‘å— 0 æ˜ å°„åˆ°ç‰©ç†å— 7ã€‚ -<strong>ç‰©ç†å—å·²å¡«æ»¡çš„æ§½ä½æ•°é‡</strong>ï¼ˆ# Filledï¼‰ï¼šä¾‹å¦‚ï¼Œåœ¨ Prefillé˜¶æ®µï¼Œç‰©ç†å— 7 çš„ 4 ä¸ªæ§½ä½å·²å¡«æ»¡ï¼Œè€Œç‰©ç†å— 1 çš„ 4 ä¸ªæ§½ä½ä¸­å¡«æ»¡äº† 3ä¸ªã€‚</p><p>ç³»ç»Ÿæ­£å¸¸è®¡ç®— prompt çš„ KVå€¼åï¼Œæ ¹æ®ä¸Šè¿°åˆ’åˆ†å…³ç³»ï¼Œå°†è¿™äº›å€¼å¡«å…¥å¯¹åº”çš„ç‰©ç†å—ä¸­ã€‚</p><h4 id="decode-é˜¶æ®µ">Decode é˜¶æ®µï¼š</h4><p>åœ¨ä½¿ç”¨ KV cache è®¡ç®— attention å¹¶ç”Ÿæˆç¬¬ä¸€ä¸ªè¯ "fathers"æ—¶ï¼Œä¸éš¾å‘ç°ï¼Œè®¡ç®—è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯<strong>é€»è¾‘å—</strong>ï¼Œå³ä»å½¢å¼ä¸Šçœ‹ï¼Œè¿™äº›token æ˜¯è¿ç»­çš„ã€‚ä¸æ­¤åŒæ—¶ï¼ŒvLLM é€šè¿‡åå°çš„ block tableæ˜ å°„å…³ç³»ï¼Œä»å¯¹åº”çš„ç‰©ç†å—ä¸­è·å–æ•°æ®ä»¥å®Œæˆå®é™…è®¡ç®—ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½èƒ½è®¤ä¸ºè‡ªå·±æ˜¯åœ¨ä¸€ä¸ªè¿ç»­ä¸”å……è¶³çš„å­˜å‚¨ç©ºé—´ä¸Šæ“ä½œï¼Œå°½ç®¡è¿™äº›æ•°æ®åœ¨ç‰©ç†å­˜å‚¨ä¸Šå¹¶ä¸æ˜¯è¿ç»­çš„ã€‚</p><p>åŸºäºæ–°ç”Ÿæˆçš„è¯ï¼Œç³»ç»Ÿä¼šå¯¹é€»è¾‘å—ã€ç‰©ç†å—å’Œ block tableè¿›è¡Œæ›´æ–°ã€‚ä¾‹å¦‚ï¼Œå¯¹äº block tableï¼ŒvLLM å°†å…¶ filled å­—æ®µä» 3 æ›´æ–°ä¸º4ã€‚</p><p>å½“ "fathers" è¢«å†™å…¥åï¼Œå½“å‰é€»è¾‘å—å·²è£…æ»¡ï¼Œå› æ­¤ vLLMä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„é€»è¾‘å—ï¼ˆé€»è¾‘å— 2ï¼‰ï¼Œå¹¶åŒæ­¥æ›´æ–° block tableå’Œå¯¹åº”çš„ç‰©ç†å—ï¼Œä»¥ç¡®ä¿åç»­ç”Ÿæˆè¿‡ç¨‹èƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œã€‚</p><h4 id="pagedattentionåœ¨ä¸åŒè§£ç ç­–ç•¥ä¸‹çš„è¿ä½œ">PagedAttentionåœ¨ä¸åŒè§£ç ç­–ç•¥ä¸‹çš„è¿ä½œ</h4><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ ¹æ®å®é™…éœ€æ±‚ï¼Œå¤§æ¨¡å‹çš„è§£ç æ–¹å¼ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œä¾‹å¦‚ï¼š</p><ul><li><strong>ParallelSampling</strong>ï¼šæˆ‘ç»™æ¨¡å‹å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¸Œæœ›å®ƒå¯¹promptåšç»­å†™ï¼Œå¹¶ç»™å‡ºä¸‰ç§ä¸åŒçš„å›ç­”ã€‚æˆ‘ä»¬ç®¡è¿™ä¸ªåœºæ™¯å«parallelsamplingã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†promptå¤åˆ¶3æ¬¡åæ‹¼æ¥æˆ1ä¸ªbatchå–‚ç»™æ¨¡å‹ï¼Œè®©å®ƒåšæ¨ç†ã€‚ä½†æˆ‘ä»¬ä¹Ÿéœ€æ³¨æ„åˆ°ï¼Œè¿™ç§æ–¹å¼ä¼šäº§ç”Ÿpromptéƒ¨åˆ†KVcacheçš„é‡å¤å­˜å‚¨ã€‚</li><li><strong>Beam SearchæŸæœç´¢</strong>ï¼šè¿™æ˜¯LLMå¸¸ç”¨çš„deocdeç­–ç•¥ä¹‹ä¸€ï¼Œå³åœ¨æ¯ä¸ªdecodeé˜¶æ®µï¼Œæˆ‘ä¸æ˜¯åªäº§ç”Ÿ1ä¸ªtokenï¼Œè€Œæ˜¯äº§ç”Ÿtopkä¸ªtokenï¼ˆè¿™é‡Œkä¹Ÿè¢«ç§°ä¸ºæŸå®½ï¼‰ã€‚top kä¸ªtokenå¿…ç„¶å¯¹åº”ç€æ­¤åˆ»çš„topkä¸ªåºåˆ—ã€‚æˆ‘æŠŠè¿™topkä¸ªåºåˆ—å–‚ç»™æ¨¡å‹ï¼Œå‡è®¾è¯è¡¨çš„å¤§å°ä¸º|V|ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ—¶åˆ»ï¼Œæˆ‘å°±è¦åœ¨k*|V|ä¸ªå€™é€‰è€…ä¸­å†é€‰å‡ºtopkï¼Œä»¥æ­¤ç±»æ¨ã€‚ä¸éš¾æƒ³è±¡æ¯ä¸€æ—¶åˆ»æˆ‘æŠŠtopkåºåˆ—å–‚ç»™æ¨¡å‹æ—¶ï¼Œå®ƒä»¬çš„å‰ç½®tokenä¸­æœ‰å¤§é‡çš„KV cacheæ˜¯é‡å¤çš„ã€‚</li><li><strong>Sharedprefix</strong>ï¼šåœ¨æŸäº›å¤§æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰è¯·æ±‚å¯èƒ½éƒ½ä¼šå…±äº«ä¸€ä¸ªå‰ç½®ä¿¡æ¯ï¼ˆæ¯”å¦‚systemmessage:â€œå‡è®¾ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹...."ï¼‰ï¼Œè¿™äº›å‰ç½®ä¿¡æ¯æ²¡æœ‰å¿…è¦é‡å¤å­˜å‚¨KVcache</li><li><strong>å…¶ä½™ä¸€èˆ¬åœºæ™¯</strong>ï¼šåœ¨ä¸€äº›æ›´é€šç”¨çš„åœºæ™¯ä¸­ï¼Œè™½ç„¶ä¸¤ä¸ªpromptå¯èƒ½å®Œå…¨æ²¡æœ‰å…³ç³»ï¼Œä½†å®ƒä»¬ä¸­æŸäº›KVcacheå´æ˜¯å¯ä»¥å…±ç”¨çš„ã€‚ä¾‹å¦‚ä¸¤ä¸ªpromptçš„ç›¸åŒä½ç½®ï¼ˆpositionï¼‰æ°å¥½å‡ºç°äº†å®Œå…¨ä¸€æ ·çš„åºåˆ—ï¼Œæ¯”å¦‚å®ƒä»¬çš„ç»“å°¾éƒ½æ˜¯å¥½æƒ³ä¸‹ç­ã€‚å‡è®¾è¿™ä¸ªç›¸åŒåºåˆ—å·²ç»å­˜åœ¨äºKVcacheä¸­ï¼Œé‚£ä¹Ÿæ²¡æœ‰å¿…è¦é‡å¤è®¡ç®—å’Œå­˜å‚¨äº†ã€‚ <strong>çº æ­£ï¼šå¯¹äºéƒ¨åˆ†åºåˆ—éƒ¨åˆ†ç›¸åŒçš„æƒ…å†µï¼Œåº”è¯¥æ˜¯åªèƒ½ä½œç”¨åœ¨layer1çš„KVcacheä¸Šï¼Œè€Œä¸èƒ½ä½œç”¨åœ¨ååºçš„KVcacheä¸Šã€‚å› ä¸ºè®¡ç®—å®Œlayer1çš„attentionåï¼Œåé¢çš„åºåˆ—å·²ç»ä¸é‡å¤äº†ã€‚</strong></li></ul><h5 id="parallel-sampling">Parallel Sampling</h5><p><strong>ä¼ ç»ŸKV cacheæ€ä¹ˆåš</strong>ï¼š å‡è®¾æ¨¡å‹çš„max_seq_len =2048ã€‚ä¼ ç»ŸKVcacheå¯èƒ½åœ¨æ˜¾å­˜ä¸­åˆ†é…ä¸¤å—é•¿åº¦æ˜¯2048çš„ç©ºé—´ã€‚ç”±äºpromptä¸€è‡´ï¼Œè¿™ä¸¤å—2048çš„ç©ºé—´ä¸­å­˜åœ¨å¤§é‡é‡å¤çš„KVcacheã€‚</p><p><strong>vLLMæ€ä¹ˆåš</strong>ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241206004803.png">å‡å®šæˆ‘ä»¬å‘ç»™æ¨¡å‹1ä¸ªrequestï¼Œè¿™ä¸ªrequestä¸­åŒ…å«2ä¸ªprompt/sampleï¼Œè®°ä¸ºSampleA1å’ŒSample A2ï¼Œè¿™ä¸¤ä¸ªpromptå®Œå…¨ä¸€è‡´ï¼Œéƒ½ä¸ºFour score and seven years agoourï¼Œæˆ‘ä»¬å¸Œæœ›æ¨¡å‹å¯¹è¿™ä¸¤ä¸ªpromptåˆ†åˆ«åšç»­å†™ä»»åŠ¡ã€‚ - Prefillé˜¶æ®µï¼š -åˆ†é…é€»è¾‘å—ï¼šå¯¹äºA1ï¼ŒvLLMä¸ºå…¶åˆ†é…é€»è¾‘å—block0å’Œblock1ï¼›å¯¹äºA2ï¼ŒvLLMä¸ºå…¶åˆ†é…é€»è¾‘å—block0å’Œblock1ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒA1çš„é€»è¾‘å—å’ŒA2çš„é€»è¾‘å—æ˜¯ç‹¬ç«‹çš„ï¼ˆå°½ç®¡å®ƒä»¬éƒ½å«block0å’Œblock1ï¼‰ï¼Œä½ å¯ä»¥å°†A1å’ŒA2è§†ä½œæ“ä½œç³»ç»Ÿä¸­ä¸¤ä¸ªç‹¬ç«‹è¿è¡Œçš„è¿›ç¨‹ã€‚-åˆ†é…ç‰©ç†å—ï¼šå¯¹äºA1å’ŒA2ï¼Œè™½ç„¶é€»è¾‘å—ç‹¬ç«‹ï¼Œä½†å› ä¸ºå®ƒä»¬çš„æ–‡å­—å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç‰©ç†å†…å­˜ä¸Šå…±äº«ç›¸åŒçš„ç©ºé—´ã€‚æ‰€ä»¥A1çš„é€»è¾‘å—block0/1åˆ†åˆ«æŒ‡å‘ç‰©ç†å—block7/1ï¼›A2çš„é€»è¾‘å—block0/1åˆ†åˆ«æŒ‡å‘ç‰©ç†å—block7/1ã€‚æˆ‘ä»¬è®¾æ¯ä¸ªç‰©ç†å—ä¸‹æ˜ å°„çš„é€»è¾‘å—æ•°é‡ä¸º<strong>refcount</strong>ï¼Œæ‰€ä»¥å¯¹ç‰©ç†å—block7/1æ¥è¯´ï¼Œå®ƒä»¬çš„ref countéƒ½ä¸º2ã€‚ -decodeé˜¶æ®µï¼šA1å’ŒA2å„è‡ªåšæ¨ç†ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªtokenï¼Œåˆ†åˆ«ä¸ºfatherså’Œmothersã€‚-å°†ç”Ÿæˆçš„tokenè£…å…¥é€»è¾‘å—ï¼šå¯¹äºA1å’ŒA2æ¥è¯´ï¼Œå°†å…¶ç”Ÿæˆçš„tokenè£…å…¥å„è‡ªçš„é€»è¾‘å—block1ã€‚-è§¦å‘ç‰©ç†å—<strong>copy-on-write</strong>æœºåˆ¶ï¼šç”±äºfathers/mothersæ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„tokenï¼Œå› æ­¤å¯¹ç‰©ç†å—block1è§¦å‘å¤åˆ¶æœºåˆ¶ï¼Œå³åœ¨ç‰©ç†å†…å­˜ä¸Šæ–°å¼€è¾Ÿä¸€å—ç©ºé—´ã€‚æ­¤æ—¶ç‰©ç†å—block1åªå’ŒA2çš„é€»è¾‘å—block1æ˜ å°„ï¼Œå°†å…¶refcountå‡å»1ï¼›ç‰©ç†å—block3åªå’ŒA1çš„é€»è¾‘å—block1æ˜ å°„ï¼Œå°†å…¶refcountè®¾ä¸º1ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼ŒvLLMèŠ‚çœKV cacheæ˜¾å­˜çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¯¹äºç›¸åŒæ•°æ®å¯¹åº”çš„KVcacheï¼Œèƒ½å¤ç”¨åˆ™å°½é‡å¤ç”¨ï¼›æ— æ³•å¤ç”¨æ—¶ï¼Œå†è€ƒè™‘å¼€è¾Ÿæ–°çš„ç‰©ç†ç©ºé—´ã€‚</p><h5 id="beam-search">Beam Search</h5><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241206005411.png"></p><p>æˆ‘ä»¬ä»å³å¾€å·¦æ¥çœ‹è¿™å¼ å›¾ã€‚è™šçº¿ä½ç½®è¡¨ç¤ºâ€œå½“å‰decodingæ—¶åˆ»â€ï¼Œbeam width =4ã€‚å›¾ä¸­æ‰€æœ‰çš„blockçš†ä¸ºé€»è¾‘å—ã€‚</p><p>å› ä¸ºbeam width = 4ï¼Œè¿™æ„å‘³ç€æ ¹æ®beamsearchç®—æ³•ï¼Œåœ¨å½“å‰é˜¶æ®µæˆ‘ä»¬ç”Ÿæˆäº†top4ä¸ªæ¦‚ç‡æœ€å¤§çš„tokenï¼ˆæˆ‘ä»¬è®°è¿™4ä¸ªtokenä¸ºbeam candidate0/1/2/3ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«è£…åœ¨block5ï¼Œblock6ï¼Œblock7å’Œblock8ä¸­ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ç»§ç»­ä½¿ç”¨beam searchç®—æ³•åšdecodingï¼Œç»§ç»­æ‰¾å‡ºtop4ä¸ªæœ€å¯èƒ½çš„next tokenã€‚ç»è¿‡æˆ‘ä»¬çš„è®¡ç®—ï¼Œè¿™top 4 next tokenï¼Œæœ‰2ä¸ªæ¥è‡ªbeamcandidate 1ï¼Œæœ‰2ä¸ªæ¥è‡ªbeam candidate2ã€‚å› æ­¤æˆ‘ä»¬åœ¨block6ä¸­å¼•å‡ºblock9å’Œblock10ï¼Œç”¨äºè£…å…¶ä¸­ä¸¤ä¸ªtop 2 nexttokenï¼›å¯¹block7ä¹Ÿæ˜¯åŒç†ã€‚</p><p>ç°åœ¨ï¼Œblock9/10/11/12ä¸­è£…çš„top 4 next tokenï¼Œå°±æˆä¸ºæ–°çš„beamcandidatesï¼Œå¯ä»¥æŒ‰ç…§å’Œä¸Šè¿°ä¸€æ ·çš„æ–¹å¼ç»§ç»­åšbeamsearchç®—æ³•ã€‚è€Œå¯¹äºblock5å’Œblock8ï¼Œå®ƒä»¬å·²ç»åœ¨beamsearchçš„æœç´¢ç®—æ³•ä¸­è¢«æ·˜æ±°äº†ï¼Œåç»­ç”Ÿæˆçš„tokenä¹Ÿä¸ä¼šå’Œå®ƒä»¬äº§ç”Ÿå…³ç³»ï¼Œæ‰€ä»¥å¯ä»¥æ¸…é™¤æ‰è¿™ä¸¤ä¸ªé€»è¾‘å—ï¼Œå¹¶é‡Šæ”¾å®ƒä»¬å¯¹åº”çš„ç‰©ç†å—çš„å†…å­˜ç©ºé—´ã€‚</p><p>å¥½ï¼Œæˆ‘ä»¬ç»§ç»­å¾€å·¦è¾¹æ¥çœ‹è¿™å¹…å›¾ã€‚block3å¼•å‡ºblock5/6/7ï¼Œblock4å¼•å‡ºblock8ï¼Œè¿™æ„å‘³ç€å½“å‰è¿™4ä¸ªtop4tokenï¼Œæ˜¯ä¸Šä¸€ä¸ªtimestepä¸‹candidate1å’Œcandidate3ç›¸å…³åºåˆ—ç”Ÿæˆçš„ï¼ˆcandidate0å’Œ2çš„blockæ²¡æœ‰ç”»å‡ºï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ‰€åœ¨çš„åºåˆ—è¢«beamsearchç®—æ³•æ·˜æ±°äº†ï¼Œå› æ­¤æ²¡æœ‰ç”»å‡ºçš„å¿…è¦ï¼‰ã€‚ç”±äºblock8å·²ç»è¢«æ·˜æ±°ï¼Œæ‰€ä»¥block4ä¹Ÿç›¸ç»§è¢«æ·˜æ±°ï¼Œå¹¶é‡Šæ”¾å¯¹åº”çš„ç‰©ç†å†…å­˜ç©ºé—´ã€‚</p><p>ç”±æ­¤å¾€å·¦ä¸€è·¯æ¨ï¼Œç›´åˆ°block0ä¸ºæ­¢ï¼ˆblock0ä»£è¡¨ç€promptï¼Œå› æ­¤è¢«beamseachä¸­æ‰€æœ‰çš„åºåˆ—å…±äº«ï¼‰ã€‚è¿™ä¸€è·¯ä¸Šï¼Œæˆ‘ä»¬éƒ½<strong>æ ¹æ®æœ€æ–°æ—¶åˆ»çš„beamsearchdecodingç»“æœï¼Œé‡Šæ”¾æ‰ä¸å†è¢«éœ€è¦çš„é€»è¾‘å—å’Œå¯¹åº”çš„ç‰©ç†å†…å­˜ç©ºé—´</strong>ï¼Œè¾¾åˆ°èŠ‚çœæ˜¾å­˜çš„ç›®çš„ã€‚</p><h3 id="è°ƒåº¦å’ŒæŠ¢å ">è°ƒåº¦å’ŒæŠ¢å </h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è§£ç­”äº†â€œvLLM å¦‚ä½•ä¼˜åŒ– KV cacheçš„æ˜¾å­˜åˆ†é…â€è¿™ä¸€é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šå½“é‡‡ç”¨åŠ¨æ€æ˜¾å­˜åˆ†é…ç­–ç•¥æ—¶ï¼Œè™½ç„¶è¡¨é¢ä¸Šå¯ä»¥åŒæ—¶å¤„ç†æ›´å¤šçš„promptï¼Œä½†ç”±äºæ²¡æœ‰ä¸ºæ¯ä¸ª prompté¢„ç•™å……è¶³çš„æ˜¾å­˜ç©ºé—´ï¼Œ<strong>å¦‚æœæŸä¸€æ—¶åˆ»æ˜¾å­˜è¢«å®Œå…¨å æ»¡ï¼Œè€Œæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„prompt éƒ½å°šæœªå®Œæˆæ¨ç†ï¼Œç³»ç»Ÿåˆè¯¥å¦‚ä½•åº”å¯¹å‘¢ï¼Ÿ</strong></p><p>vllm çš„è°ƒåº¦å’ŒæŠ¢å åŸåˆ™ï¼š</p><ul><li>é‡‡ç”¨â€œ<strong>å…ˆåˆ°å…ˆæœåŠ¡</strong>â€ï¼ˆFCFSï¼‰çš„è°ƒåº¦ç­–ç•¥æ¥å¤„ç†æ‰€æœ‰è¯·æ±‚ï¼Œç¡®ä¿å…¬å¹³æ€§å¹¶é˜²æ­¢è¯·æ±‚é¥¿æ­»ã€‚</li><li>å½“ vLLMéœ€è¦æŠ¢å è¯·æ±‚æ—¶ï¼Œå®ƒä¼šä¼˜å…ˆæœåŠ¡æœ€æ—©åˆ°è¾¾çš„è¯·æ±‚ï¼Œå¹¶ä¼˜å…ˆæŠ¢å æœ€æ–°åˆ°è¾¾çš„è¯·æ±‚ã€‚æš‚åœå®ƒä»¬çš„æ‰§è¡Œï¼ŒåŒæ—¶å°†ä¸ä¹‹ç›¸å…³çš„KV cache ä» gpu ä¸Šé‡Šæ”¾æ‰ã€‚ç­‰ gpu èµ„æºå……è¶³æ—¶ï¼Œé‡æ–°æ¢å¤å®ƒä»¬çš„æ‰§è¡Œã€‚</li></ul><h4 id="swappingäº¤æ¢ç­–ç•¥">Swappingäº¤æ¢ç­–ç•¥</h4><p>å¯¹äºè¢«æŠ¢å çš„è¯·æ±‚ï¼ŒvLLMè¦å°†å…¶KV cacheä»gpuä¸Šé‡Šæ”¾æ‰ï¼Œé‚£ä¹ˆï¼š</p><p><strong>é—®é¢˜1ï¼šè¯¥é‡Šæ”¾å“ªäº›KV cacheï¼Ÿ</strong>ç”±å‰æ–‡PagedAttentionåŸç†å¯çŸ¥ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½å¯¹åº”å¤šä¸ªblockã€‚æˆ‘ä»¬æ—¢å¯ä»¥é€‰æ‹©é‡Šæ”¾æ‰éƒ¨åˆ†blockï¼Œä¹Ÿå¯ä»¥é€‰æ‹©é‡Šæ”¾æ‰å…¨éƒ¨blockï¼Œæˆ–è€…æ›´ç§‘å­¦åœ°ï¼Œæˆ‘ä»¬å¯ä»¥é¢„æµ‹ä¸€ä¸‹å“ªäº›blockè¢«ä½¿ç”¨çš„é¢‘ç‡æœ€ä½ï¼Œç„¶åé‡Šæ”¾æ‰è¿™äº›ä½é¢‘blockï¼ˆä½†è¿™ç§æ–¹å¼å®ç°èµ·æ¥éš¾åº¦è¾ƒå¤§ï¼Œæ€§ä»·æ¯”ä¸æ˜¯å¾ˆé«˜ï¼‰ã€‚</p><p>åœ¨vLLMä¸­ï¼Œé‡‡å–çš„æ˜¯all-or-nothingç­–ç•¥ï¼Œå³é‡Šæ”¾è¢«æŠ¢å è¯·æ±‚çš„æ‰€æœ‰blockã€‚</p><p><strong>é—®é¢˜2ï¼šè¦æŠŠè¿™äº›KV cacheé‡Šæ”¾åˆ°å“ªé‡Œå»ï¼Ÿ</strong>å¯¹äºè¿™äº›è¢«é€‰ä¸­è¦é‡Šæ”¾çš„KVblockï¼Œå¦‚æœå°†å®ƒä»¬ç›´æ¥ä¸¢æ‰ï¼Œé‚£æœªå…è¿‡äºæµªè´¹ã€‚vLLMé‡‡ç”¨çš„åšæ³•æ˜¯å°†å…¶ä»gpuä¸Šäº¤æ¢ï¼ˆSwapï¼‰åˆ°cpuä¸Šã€‚è¿™æ ·ç­‰åˆ°gpuæ˜¾å­˜å……ä»½æ—¶ï¼Œå†æŠŠè¿™äº›blockä»cpuä¸Šé‡è½½å›æ¥ã€‚</p><h4 id="recomputingé‡è®¡ç®—ç­–ç•¥">Recomputingé‡è®¡ç®—ç­–ç•¥</h4><p>çŸ¥é“äº†Swappingæœºåˆ¶ï¼Œé‡è®¡ç®—çš„è¿‡ç¨‹ä¹Ÿå¾ˆå¥½ç†è§£äº†ï¼šå¯¹äºæœ‰äº›ä»»åŠ¡ï¼Œå½“å®ƒä»¬å› ä¸ºèµ„æºä¸è¶³è€Œè¢«æŠ¢å æ—¶ï¼Œå¯ä»¥ä¸åšswapï¼Œè€Œæ˜¯ç›´æ¥é‡Šæ”¾å®ƒä»¬çš„ç‰©ç†å—ï¼ŒæŠŠå®ƒä»¬é‡æ–°æ”¾å…¥ç­‰å¾…å¤„ç†çš„é˜Ÿåˆ—ä¸­ï¼Œç­‰åç»­èµ„æºå……è¶³æ—¶å†é‡æ–°ä»prefillé˜¶æ®µå¼€å§‹åšæ¨ç†ã€‚</p><p>æ¯”å¦‚parallelsamplingä¸­å¹¶è¡Œé‡‡æ ·æ•°n=1çš„ä»»åŠ¡ï¼Œå¯¹äºè¿™ç§å°ç²’åº¦ä»»åŠ¡ï¼Œç›´æ¥é‡è®¡ç®—ï¼ˆä»prefill é˜¶æ®µé‡æ–°å¼€å§‹ï¼‰æ‰€éœ€çš„æˆæœ¬å¯èƒ½æ¯”æ‰§è¡Œ swappingï¼ˆè¿ç§»å†…å­˜åˆ°CPUï¼‰å¹¶åœ¨æœªæ¥é‡æ–°åŠ è½½æ›´ä½ã€‚Swapping çš„è¿‡ç¨‹ä¼šå°†å†…å­˜é¡µï¼ˆæˆ–å¼ é‡ï¼‰ä» GPUè½¬ç§»åˆ° CPUï¼Œè¿™æ¶‰åŠåˆ° PCIe æˆ– NVLink é€šä¿¡ï¼Œé€Ÿåº¦è¿œä½äº GPUå†…éƒ¨è®¡ç®—å’Œå†…å­˜æ“ä½œã€‚</p><h3 id="åˆ†å¸ƒå¼ç®¡ç†">åˆ†å¸ƒå¼ç®¡ç†</h3><p>æœ€åï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹vLLMçš„æ•´ä½“æ¶æ„ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241206012807.png"></p><p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼ŒvLLM çš„æ•´ä½“è¿ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä¸­å¤®è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰ï¼švLLMé…å¤‡äº†ä¸€ä¸ªä¸­å¤®è°ƒåº¦å™¨ï¼Œè´Ÿè´£è®¡ç®—å¹¶ç®¡ç†æ¯å¼ æ˜¾å¡ä¸Š KV cacheä»é€»è¾‘å—åˆ°ç‰©ç†å—çš„æ˜ å°„è¡¨ï¼ˆblock tablesï¼‰ã€‚</li><li>æ˜ å°„è¡¨å¹¿æ’­ï¼šåœ¨è¿›è¡Œåˆ†å¸ƒå¼è®¡ç®—æ—¶ï¼ŒSchedulerä¼šå°†ç”Ÿæˆçš„æ˜ å°„è¡¨å¹¿æ’­åˆ°å„æ˜¾å¡ã€‚</li><li>ç¼“å­˜å¼•æ“ç®¡ç†ï¼šæ¯å¼ æ˜¾å¡ä¸Šçš„ Cache Engineåœ¨æ¥æ”¶åˆ°å¯¹åº”çš„æ˜ å°„ä¿¡æ¯åï¼Œè´Ÿè´£å…·ä½“ç®¡ç†è¯¥æ˜¾å¡ä¸Šçš„ KV blockã€‚</li></ul><p>ä¸Šå›¾ä¸­ç»™å‡ºçš„ä¾‹å­ï¼Œæ˜¯ç”¨å¼ é‡æ¨¡å‹å¹¶è¡Œï¼ˆmegatron-lmï¼‰åšåˆ†å¸ƒå¼æ¨ç†æ—¶çš„æƒ…å†µï¼Œæ‰€ä»¥å›¾ä¸­æ¯ä¸ªworkerä¸Šå†™çš„æ˜¯modelshardã€‚<strong>åœ¨å¼ é‡å¹¶è¡Œä¸­ï¼Œå„å¡ä¸Šçš„è¾“å…¥æ•°æ®ç›¸åŒï¼Œåªæ˜¯å„å¡è´Ÿè´£è®¡ç®—ä¸åŒheadçš„KVcache</strong>ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ï¼Œå„å¡ä¸Šçš„é€»è¾‘å—-ç‰©ç†å—çš„æ˜ å°„å…³ç³»å…¶å®æ˜¯ç›¸åŒçš„ï¼ˆç”¨çš„åŒä¸€å¼ blocktableï¼‰ï¼Œåªæ˜¯å„å¡ä¸Šç‰©ç†å—ä¸­å®é™…å­˜å‚¨çš„æ•°æ®ä¸åŒè€Œå·²ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š &gt; ææ™ºAI |å¤§æ¨¡å‹ä¼˜åŒ–æŠ€æœ¯PagedAttentionï¼šhttps://juejin.cn/post/7290163879287881765</p><blockquote><p>å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ä¹‹ï¼švLLMæ ¸å¿ƒæŠ€æœ¯PagedAttentionåŸç†ï¼šhttps://zhuanlan.zhihu.com/p/691038809</p></blockquote><blockquote><p>LLMæ¨ç†ä¼˜åŒ– -PagedAttentionï¼šhttps://www.yidoo.xyz/paged-attention</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> LLM </tag>
            
            <tag> PagedAttention </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹ä¼˜åŒ–--KV Cache</title>
      <link href="/2024/12/02/da-mo-xing-you-hua-kv-cache/"/>
      <url>/2024/12/02/da-mo-xing-you-hua-kv-cache/</url>
      
        <content type="html"><![CDATA[<h2 id="kv-cache-ä»‹ç»">KV Cache ä»‹ç»</h2><p>KVCacheæ˜¯Transformeræ ‡é…çš„æ¨ç†åŠ é€ŸåŠŸèƒ½ï¼Œtransformerå®˜æ–¹use_cacheè¿™ä¸ªå‚æ•°é»˜è®¤æ˜¯Trueï¼Œä½†æ˜¯å®ƒåªèƒ½ç”¨äºDecoderæ¶æ„çš„æ¨¡å‹ï¼Œè¿™æ˜¯å› ä¸ºDecoderæœ‰CausalMaskï¼Œåœ¨æ¨ç†çš„æ—¶å€™å‰é¢å·²ç»ç”Ÿæˆçš„å­—ç¬¦ä¸éœ€è¦ä¸åé¢çš„å­—ç¬¦äº§ç”Ÿattentionï¼Œä»è€Œä½¿å¾—å‰é¢å·²ç»è®¡ç®—çš„Kå’ŒVå¯ä»¥ç¼“å­˜èµ·æ¥ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸ä½¿ç”¨KVCacheçš„æ¨ç†è¿‡ç¨‹ã€‚å‡è®¾æ¨¡å‹æœ€ç»ˆç”Ÿæˆäº†â€œé¥é¥é¢†å…ˆâ€4ä¸ªå­—ã€‚</p><p>å½“æ¨¡å‹ç”Ÿæˆç¬¬ä¸€ä¸ªâ€œé¥â€å­—æ—¶ï¼Œ<code>input="&lt;s&gt;"</code>,<code>"&lt;s&gt;"</code>æ˜¯èµ·å§‹å­—ç¬¦ã€‚Attentionçš„è®¡ç®—å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202155542.png"></p><p>ä¸ºäº†çœ‹ä¸Šå»æ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚æ—¶å¿½ç•¥scaleé¡¹<span class="math inline">\(1/\sqrt(d)\)</span>ï¼Œä½†æ˜¯è¦æ³¨æ„è¿™ä¸ªscaleé¢è¯•æ—¶ç»å¸¸è€ƒã€‚</p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ€ç»ˆAttentionçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼Œï¼ˆsoftmaxedè¡¨ç¤ºå·²ç»æŒ‰è¡Œè¿›è¡Œäº†softmaxï¼‰: <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202155748.png"></p><p>å½“æ¨¡å‹ç”Ÿæˆç¬¬äºŒä¸ªâ€œé¥â€å­—æ—¶ï¼Œ<code>input="&lt;s&gt;é¥"</code>,Attentionçš„è®¡ç®—å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202155837.png"></p><p>å½“QKå˜ä¸ºçŸ©é˜µæ—¶ï¼Œsoftmax ä¼šé’ˆå¯¹ è¡Œ è¿›è¡Œè®¡ç®—ã€‚å†™è¯¦ç»†ä¸€ç‚¹å¦‚ä¸‹ï¼Œsoftmaxedè¡¨ç¤ºå·²ç»æŒ‰è¡Œè¿›è¡Œäº†softmaxã€‚</p><p><strong>ï¼ˆå…³é”®ï¼‰ç”±äºdecoderæ¶æ„çš„æ¨¡å‹æœ‰Causal Maskï¼Œæ‰€ä»¥<span class="math inline">\(Q_1\)</span>ä¸<span class="math inline">\(K_2\)</span>çš„è®¡ç®—ç»“æœä¸º<span class="math inline">\(-\infty\)</span>ã€‚</strong> <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202204856.png"></p><p>å‡è®¾<span class="math inline">\(Att_1\)</span>è¡¨ç¤º Attentionçš„ç¬¬ä¸€è¡Œï¼Œ <span class="math inline">\(Att_2\)</span>è¡¨ç¤º Attentionçš„ç¬¬äºŒè¡Œï¼Œåˆ™æ ¹æ®ä¸Šé¢æ¨å¯¼ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202205002.png"></p><p>æˆ‘ä»¬å‘ç°ï¼š - <span class="math inline">\(Q_1\)</span>åœ¨ç¬¬äºŒæ­¥å‚ä¸çš„è®¡ç®—ä¸ç¬¬ä¸€æ­¥æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”ç¬¬äºŒæ­¥ç”Ÿæˆçš„<span class="math inline">\(Att_1\)</span>ä»…ä»…ä¾èµ–äº<span class="math inline">\(Q_1\)</span>ï¼Œä¸<span class="math inline">\(Q_2\)</span>æ¯«æ— å…³ç³»ã€‚ - <span class="math inline">\(Att_2\)</span>ä»…ä»…ä¾èµ–äº<span class="math inline">\(Q_2\)</span>ï¼Œä¸<span class="math inline">\(Q_1\)</span>æ¯«æ— å…³ç³»ã€‚</p><p>å½“æ¨¡å‹ç”Ÿæˆç¬¬ä¸‰ä¸ªâ€œé¢†â€å­—æ—¶ï¼Œ<code>input="&lt;s&gt;é¥é¥"</code>,Attentionçš„è®¡ç®—å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202210952.png">è¯¦ç»†çš„æ¨å¯¼å‚è€ƒç¬¬äºŒæ­¥ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202211018.png">åŒæ ·çš„ï¼Œç¬¬ä¸‰æ­¥ç”Ÿæˆçš„<span class="math inline">\(Att_3\)</span>ä»…ä»…ä¾èµ–äº<span class="math inline">\(Q_3\)</span>ï¼Œä¸<span class="math inline">\(Q_1\)</span>å’Œ<span class="math inline">\(Q_2\)</span>æ¯«æ— å…³ç³»ã€‚</p><p>å½“æ¨¡å‹ç”Ÿæˆç¬¬å››ä¸ªâ€œå…ˆâ€å­—æ—¶ï¼Œ<code>input="&lt;s&gt;é¥é¥é¢†"</code>,Attentionçš„è®¡ç®—å¦‚ä¸‹ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202211156.png"><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202211222.png">å’Œä¹‹å‰ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚</p><p>çœ‹ä¸Šé¢å›¾å’Œå…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š - å½“å‰è®¡ç®—æ–¹å¼å­˜åœ¨å¤§é‡å†—ä½™è®¡ç®— -<span class="math inline">\(Attn_k\)</span>åªä¸<span class="math inline">\(Q_k\)</span>æœ‰å…³ - æ¨ç†ç¬¬<span class="math inline">\(x_k\)</span>ä¸ªå­—ç¬¦æ—¶ï¼Œåªéœ€è¦è¾“å…¥å­—ç¬¦<span class="math inline">\(x_{k-1}\)</span>å³å¯ã€‚ç¬¬ä¸‰ä¸ªç»“è®ºçš„å‰ææ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ¯ä¸€æ­¥çš„Kå’ŒVç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·åœ¨æ¨ç†ç¬¬<span class="math inline">\(x_k\)</span>ä¸ªå­—ç¬¦æ—¶ï¼Œåªéœ€è¦è¾“å…¥å­—ç¬¦<span class="math inline">\(x_{k-1}\)</span>è®¡ç®—å…¶<span class="math inline">\(Q_k,K_k,V_k\)</span>, ç»“åˆä¹‹å‰ä¿å­˜çš„KVCacheå³å¯å¾—åˆ°å¯¹åº”çš„<span class="math inline">\(Attn_k\)</span>ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ä½¿ç”¨KV Cacheå’Œä¸ä½¿ç”¨KV Cacheçš„è¿‡ç¨‹å¯¹æ¯”ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202211901.png"></p><p><a href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/gpt2/modeling_gpt2.py#L318C1-L331C97">huggingfaceçš„å®ç°</a> </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">if layer_past is not None:        past_key, past_value = layer_past        key = torch.cat((past_key, key), dim=-2)        value = torch.cat((past_value, value), dim=-2)        if use_cache is True:        present = (key, value)    else:        present = None        if self.reorder_and_upcast_attn:        attn_output, attn_weights = self._upcast_and_reordered_attn(query, key, value, attention_mask, head_mask)    else:        attn_output, attn_weights = self._attn(query, key, value, attention_mask, head_mask)</code></pre> ## KV Cache æ­¥éª¤ æ­£æ˜¯å› ä¸º Self Attention ä¸­å¸¦Maske ï¼Œå› æ­¤ï¼Œåœ¨æ¨ç†çš„æ—¶å€™ï¼Œå‰é¢å·²ç»ç”Ÿæˆçš„ token ä¸éœ€è¦ä¸åé¢çš„ tokenè®¡ç®— Attention ï¼Œä»è€Œä½¿å¾—å‰é¢å·²ç»è®¡ç®—çš„ K å’Œ V å¯ä»¥ç¼“å­˜èµ·æ¥ã€‚ä¸€ä¸ªå…¸å‹çš„å¸¦æœ‰ KV Cache çš„æ¨ç†è¿‡ç¨‹åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µï¼š 1.é¢„å¡«å……é˜¶æ®µï¼šè¾“å…¥ä¸€ä¸ª prompt åºåˆ—ï¼Œä¸ºæ¯ä¸ª transformer å±‚ç”Ÿæˆ Key Cache å’ŒValue Cacheï¼ˆKV cacheï¼‰ã€‚ 2. è§£ç é˜¶æ®µï¼šä½¿ç”¨å¹¶æ›´æ–° KVCacheï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªåœ°ç”Ÿæˆ tokenï¼Œå½“å‰ç”Ÿæˆçš„ tokenä¾èµ–äºä¹‹å‰å·²ç»ç”Ÿæˆçš„tokenã€‚ ### é¢„å¡«å……é˜¶æ®µ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204023238.png">### è§£ç é˜¶æ®µ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204023814.png"><p></p><p>KVCacheé‡‡ç”¨åŠ¨æ€åˆ†é…ç¼“å†²åŒºå¤§å°ï¼Œå½“è¶…è¿‡å½“å‰å®¹é‡æ—¶ï¼Œå†…å­˜å¤§å°ä¼šç¿»å€ã€‚è¿™ç§æ–¹æ³•è™½ç„¶å¯è¡Œï¼Œä½†åœ¨GPUä¸Šé¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„å¼€é”€è¾ƒå¤§ï¼Œå¯¼è‡´æ•ˆç‡è¾ƒä½ã€‚ç›®å‰æµè¡Œçš„è§£å†³åŠæ³•æ˜¯æ•°æ®æ‹†åˆ†ä¸å…ƒæ•°æ®ç®¡ç†ï¼šå°†æ•°æ®æŒ‰æœ€å°å•å…ƒå­˜å‚¨ï¼Œå¹¶ä½¿ç”¨å…ƒæ•°æ®è®°å½•æ¯ä¸€å—æ•°æ®çš„ä½ç½®ï¼Œç§°ä¸ºPageAttentionã€‚ç¨‹åºåœ¨åˆå§‹åŒ–æ—¶ç”³è¯·ä¸€å—è¾ƒå¤§çš„æ˜¾å­˜åŒºåŸŸï¼ˆä¾‹å¦‚4GBï¼‰ï¼Œç„¶åæŒ‰ç…§ KVCache çš„å¤§å°å°†æ˜¾å­˜åˆ’åˆ†æˆå¤šä¸ªå°å—ï¼Œå¹¶è®°å½•æ¯ä¸ª tokenåœ¨æ¨ç†è¿‡ç¨‹ä¸­éœ€è¦è®¿é—®çš„å°å—ã€‚æ˜¾å­˜çš„åˆ†é…ã€é‡Šæ”¾å’Œç®¡ç†ç±»ä¼¼äºæ“ä½œç³»ç»Ÿå¯¹ç‰©ç†å†…å­˜çš„è™šæ‹ŸåŒ–è¿‡ç¨‹ã€‚è¿™ä¸€æ€è·¯è¢«vLLMï¼ˆå…·ä½“å‚è§è®ºæ–‡ Efficient Memory Management for Large Language ModelServing withPagedAttentionï¼‰æ‰€é‡‡ç”¨ï¼Œå¹¶å¹¿æ³›åº”ç”¨äºå¤§è§„æ¨¡è¯­è¨€æ¨¡å‹çš„æ¨ç†ä¸­ã€‚</p><h2 id="mqaä¸gqa">MQAä¸GQA</h2><p>åœ¨GPUä¸Šéƒ¨ç½²æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬éµå¾ªçš„åŸåˆ™æ˜¯ï¼šèƒ½åœ¨ä¸€å¼ å¡ä¸Šéƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå¼ å¡ï¼›èƒ½åœ¨ä¸€å°æœºå™¨ä¸Šéƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå°æœºå™¨ã€‚è¿™æ˜¯å› ä¸ºâ€œå¡å†…é€šä¿¡å¸¦å®½&gt; å¡é—´é€šä¿¡å¸¦å®½ &gt;æœºé—´é€šä¿¡å¸¦å®½â€ã€‚ç”±äºâ€œæœ¨æ¡¶æ•ˆåº”â€ï¼Œæ¨¡å‹éƒ¨ç½²æ—¶è·¨çš„è®¾å¤‡è¶Šå¤šï¼Œå—åˆ°è®¾å¤‡é—´é€šä¿¡å¸¦å®½çš„åˆ¶çº¦å°±è¶Šå¤§ã€‚</p><p>å› æ­¤ï¼Œå‡å°‘ KV Cache çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨æ›´å°‘çš„è®¾å¤‡ä¸Šæ¨ç†æ›´é•¿çš„Contextï¼Œæˆ–è€…åœ¨ç›¸åŒçš„ Context é•¿åº¦ä¸‹å®ç°æ›´å¤§çš„æ¨ç† batchsizeï¼Œä»è€Œæå‡æ¨ç†é€Ÿåº¦æˆ–å¢åŠ ååæ€»é‡ã€‚æœ€ç»ˆç›®çš„éƒ½æ˜¯ä¸ºäº†é™ä½æ¨ç†æˆæœ¬ã€‚</p><h3 id="mha">MHA</h3><p>MHAï¼ˆMulti-Head Attentionï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤šå¤´æ³¨æ„åŠ›ï¼Œæ˜¯ Transformerä¸­çš„æ ‡å‡† Attention å½¢å¼ã€‚åœ¨æ•°å­¦ä¸Šï¼Œå¤šå¤´æ³¨æ„åŠ› MHAç­‰ä»·äºå¤šä¸ªç‹¬ç«‹çš„å•å¤´æ³¨æ„åŠ›çš„æ‹¼æ¥ã€‚å…¶éµå¾ªå‰é¢æ‰€è®²çš„KV Cacheçš„åŸç†ã€‚è€Œåé¢çš„ MQAã€GQAã€éƒ½æ˜¯å›´ç»•â€œå¦‚ä½•å‡å°‘ KV CacheåŒæ—¶å°½å¯èƒ½åœ°ä¿è¯æ•ˆæœâ€è¿™ä¸ªä¸»é¢˜å‘å±•è€Œæ¥çš„äº§ç‰©ã€‚</p><h3 id="mqa">MQA</h3><p>MQAï¼Œå³â€œMulti-Query Attentionâ€ï¼Œ2019å¹´ç”± Google åœ¨è®ºæ–‡ <a href="chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://arxiv.org/pdf/1911.02150">FastTransformer Decoding: One Write-Head is All You Need</a> ä¸­æå‡ºã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204024825.png">ä½¿ç”¨ MQA çš„æ¨¡å‹åŒ…æ‹¬ PaLMã€StarCoderã€Gemini ç­‰ã€‚å¾ˆæ˜æ˜¾ï¼ŒMQA ç›´æ¥å°† KVCache å‡å°‘åˆ°äº†åŸæ¥çš„ 1/head_numã€‚</p><p>æ•ˆæœæ–¹é¢ï¼Œç›®å‰çœ‹æ¥å¤§éƒ¨åˆ†ä»»åŠ¡çš„æŸå¤±éƒ½æ¯”è¾ƒæœ‰é™ã€‚</p><h3 id="gqa">GQA</h3><p>ä¹Ÿæœ‰äººæ‹…å¿ƒ MQA å¯¹ KV Cacheçš„å‹ç¼©å¤ªä¸¥é‡ï¼Œä»¥è‡³äºä¼šå½±å“æ¨¡å‹çš„å­¦ä¹ æ•ˆç‡ä»¥åŠæœ€ç»ˆæ•ˆæœã€‚ä¸ºæ­¤ï¼Œä¸€ä¸ª MHA ä¸MQA ä¹‹é—´çš„è¿‡æ¸¡ç‰ˆæœ¬ GQAï¼ˆGrouped-Query Attentionï¼‰åº”è¿è€Œç”Ÿï¼Œå‡ºè‡ª 2023 å¹´Google çš„è®ºæ–‡ <a href="https://arxiv.org/abs/2305.13245">GQA: TrainingGeneralized Multi-Query Transformer Models from Multi-HeadCheckpoints</a>ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241203015549.png"></p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204025114.png"></p><table><thead><tr class="header"><th>æ¨¡å‹</th><th>å‚æ•°é‡</th><th>éEmbeddingå‚æ•°é‡</th><th>GQA</th><th>ä¸Šä¸‹æ–‡é•¿åº¦</th></tr></thead><tbody><tr class="odd"><td>Qwen2-0.5B</td><td>0.49B</td><td>0.35B</td><td>âˆš</td><td>32K</td></tr><tr class="even"><td>Qwen2-1.5B</td><td>1.54B</td><td>1.31B</td><td>âˆš</td><td>32K</td></tr><tr class="odd"><td>Qwen2-7B</td><td>7.07B</td><td>5.98B</td><td>âˆš</td><td>128K</td></tr><tr class="even"><td>Qwen2-57B-A14B</td><td>57.41B</td><td>56.32B</td><td>âˆš</td><td>64K</td></tr><tr class="odd"><td>Qwen2-72B</td><td>72.71B</td><td>70.21B</td><td>âˆš</td><td>128K</td></tr></tbody></table><p>åœ¨ Llama 2/3-70B ä¸­ï¼ŒGQA çš„ g=8 ï¼Œå…¶ä»–ç”¨äº† GQAçš„åŒä½“é‡æ¨¡å‹åŸºæœ¬ä¸Šä¹Ÿä¿æŒäº†è¿™ä¸ªè®¾ç½®ï¼Œè¿™å¹¶éå¶ç„¶ï¼Œè€Œæ˜¯åŒæ ·å‡ºäºæ¨ç†æ•ˆç‡çš„è€ƒè™‘ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ70Bè¿™ä¸ªä½“é‡çš„æ¨¡å‹ï¼Œå¦‚æœä¸è¿›è¡Œæç«¯çš„é‡åŒ–ï¼Œé‚£ä¹ˆä¸å¯èƒ½éƒ¨ç½²åˆ°å•å¡ï¼ˆA100/H10080Gï¼‰ä¸Šã€‚å•å¡ä¸è¡Œï¼Œé‚£ä¹ˆå°±èƒ½å•æœºäº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€å°æœºå¯ä»¥è£… 8å¼ å¡ï¼ŒAttention çš„æ¯ä¸ªHead å®é™…ä¸Šæ˜¯ç‹¬ç«‹è¿ç®—ç„¶åæ‹¼æ¥èµ·æ¥çš„ï¼Œå½“ g=8æ—¶ï¼Œæ­£å¥½å¯ä»¥æ¯å¼ å¡è´Ÿè´£è®¡ç®—ä¸€ç»„ Kã€V å¯¹åº”çš„ AttentionHeadï¼Œè¿™æ ·å¯ä»¥åœ¨å°½å¯èƒ½ä¿è¯ Kã€V å¤šæ ·æ€§çš„åŒæ—¶æœ€å¤§ç¨‹åº¦ä¸Šå‡å°‘å¡é—´é€šä¿¡ã€‚</p><p>ä¸‹é¢çœ‹ä¸€ä¸‹ GQA çš„å®éªŒæ•ˆæœã€‚ | æ¨¡å‹ | æ¨ç†æ—¶é—´ | æ•ˆæœ | | ---------- |-------- | ----- | | MHA-Large | 0.37 | 46.0 | | MHA-XXL | 1.51 | 47.2 || MQA-XXL | 0.24 | 46.6 | | GQA-8-XXL | 0.28 | 47.1 |</p><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204025823.png"></p><p>å‚è€ƒï¼š &gt; https://zhuanlan.zhihu.com/p/708120479</p><blockquote><p>å¤§æ¨¡å‹æ¨ç†åŠ é€Ÿï¼šçœ‹å›¾å­¦KV Cachehttps://zhuanlan.zhihu.com/p/662498827</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> LLM </tag>
            
            <tag> KV Cache </tag>
            
            <tag> MQA </tag>
            
            <tag> GQA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤§æ¨¡å‹æ˜¾å­˜å ç”¨åˆ†æ</title>
      <link href="/2024/11/30/da-mo-xing-xian-cun-zhan-yong-fen-xi/"/>
      <url>/2024/11/30/da-mo-xing-xian-cun-zhan-yong-fen-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="å¤§æ¨¡å‹æ¶ˆè€—çš„æ˜¾å­˜">å¤§æ¨¡å‹æ¶ˆè€—çš„æ˜¾å­˜</h2><p>åœ¨è¯¦ç»†è¯´æ˜å¤§æ¨¡å‹éœ€è¦æ¶ˆè€—çš„æ˜¾å­˜å¤§å°ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆæ˜ç¡®å‡ ä¸ªæ¦‚å¿µã€‚ä¸€ä¸ªå°±æ˜¯å¤§æ¨¡å‹åœ¨ä¸åŒé˜¶æ®µå¯¹æ˜¾å­˜çš„æ¶ˆè€—æ˜¯ä¸åŒçš„ã€‚ä½†æ˜¯å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µæˆ–è€…è¯´ä¸‰ä¸ªåœºæ™¯ã€‚å³å¤§æ¨¡å‹<strong>é¢„è®­ç»ƒé˜¶æ®µ</strong>ã€å¤§æ¨¡å‹<strong>å¾®è°ƒé˜¶æ®µ</strong>å’Œå¤§æ¨¡å‹<strong>æ¨ç†é˜¶æ®µ</strong>ã€‚-åœ¨<strong>é¢„è®­ç»ƒé˜¶æ®µ</strong>ï¼Œå¤§æ¨¡å‹é€šå¸¸é€‰æ‹©è¾ƒå¤§è§„æ¨¡çš„æ•°æ®é›†è·å–æ³›åŒ–èƒ½åŠ›ï¼Œå› æ­¤éœ€è¦è¾ƒå¤§çš„æ‰¹æ¬¡ç­‰æ¥ä¿è¯æ¨¡å‹çš„è®­ç»ƒå¼ºå¤§ã€‚è€Œæ¨¡å‹çš„æƒé‡ä¹Ÿæ˜¯ä»å¤´å¼€å§‹è®¡ç®—ï¼Œå› æ­¤é€šå¸¸ä¹Ÿä¼šé€‰æ‹©é«˜ç²¾åº¦ï¼ˆå¦‚32ä½æµ®ç‚¹æ•°ï¼‰è¿›è¡Œè®­ç»ƒã€‚éœ€è¦æ¶ˆè€—å¤§é‡çš„GPUæ˜¾å­˜èµ„æºã€‚-åœ¨<strong>å¾®è°ƒé˜¶æ®µ</strong>ï¼Œé€šå¸¸ä¼šå†»ç»“å¤§éƒ¨åˆ†å‚æ•°ï¼Œåªè®­ç»ƒå°éƒ¨åˆ†å‚æ•°ã€‚åŒæ—¶ï¼Œä¹Ÿä¼šé€‰æ‹©éå¸¸å¤šçš„ä¼˜åŒ–æŠ€æœ¯å’Œè¾ƒå°‘çš„é«˜è´¨é‡æ•°æ®é›†æ¥æé«˜å¾®è°ƒæ•ˆæœï¼Œæ­¤æ—¶ï¼Œç”±äºæ¨¡å‹å·²ç»åœ¨é¢„è®­ç»ƒé˜¶æ®µè¿›è¡Œäº†å¤§é‡çš„è®­ç»ƒï¼Œå¾®è°ƒæ—¶çš„æ•°å€¼è¯¯å·®å¯¹æ¨¡å‹çš„å½±å“é€šå¸¸è¾ƒå°ã€‚ä¹Ÿå¸¸å¸¸é€‰æ‹©16ä½ç²¾åº¦æˆ–è€…æ··åˆç²¾åº¦è®­ç»ƒã€‚å› æ­¤é€šå¸¸æ¯”é¢„è®­ç»ƒé˜¶æ®µæ¶ˆè€—æ›´ä½çš„æ˜¾å­˜èµ„æºã€‚-åœ¨<strong>æ¨ç†é˜¶æ®µ</strong>ï¼Œé€šå¸¸åªæ˜¯å°†ä¸€ä¸ªè¾“å…¥æ•°æ®ç»è¿‡æ¨¡å‹çš„å‰å‘è®¡ç®—å¾—åˆ°ç»“æœå³å¯ï¼Œå› æ­¤éœ€è¦æœ€å°‘çš„æ˜¾å­˜å³å¯è¿è¡Œã€‚### æ¨¡å‹æƒé‡è¿™éƒ¨åˆ†æ˜¾å­˜ç”¨äºå­˜å‚¨ç¥ç»ç½‘ç»œæ¨¡å‹çš„å‚æ•°ï¼ŒåŒ…æ‹¬æƒé‡ï¼ˆweightsï¼‰å’Œåç½®ï¼ˆbiasesï¼‰ã€‚æ¨¡å‹å†…å­˜æ˜¯æ¨¡å‹åœ¨è®­ç»ƒå’Œæ¨ç†è¿‡ç¨‹ä¸­éƒ½éœ€è¦çš„ï¼Œå› ä¸ºå®ƒåŒ…å«äº†æ¨¡å‹çš„ç»“æ„å’Œå­¦ä¹ åˆ°çš„çŸ¥è¯†ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹å†…å­˜çš„å¤§å°é€šå¸¸ä¸æ¨¡å‹çš„å¤æ‚åº¦å’Œå‚æ•°æ•°é‡æˆæ­£æ¯”ã€‚### æ¢¯åº¦åœ¨æ¨¡å‹è®­ç»ƒåå‘ä¼ æ’­ï¼ˆBackwardï¼‰è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—çš„æ¢¯åº¦æ‰€å çš„æ˜¾å­˜å¤§å°ã€‚æ¢¯åº¦å†…å­˜çš„å¤§å°ä¸æ¨¡å‹çš„å‚æ•°æ•°é‡æœ‰å…³ï¼Œå› ä¸ºæ¯ä¸ªå‚æ•°éƒ½éœ€è¦è®¡ç®—å¯¹åº”çš„æ¢¯åº¦ã€‚### ä¼˜åŒ–å™¨çŠ¶æ€ä¼˜åŒ–å™¨å†…å­˜ç”¨äºå­˜å‚¨ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œè¿™é€šå¸¸åŒ…æ‹¬æ¢¯åº¦çš„ä¸€é˜¶å’ŒäºŒé˜¶çŸ©ï¼ˆå¦‚åœ¨Adamä¼˜åŒ–å™¨ä¸­ä½¿ç”¨çš„å‡å€¼å’Œæ–¹å·®ä¼°è®¡ï¼‰ä¼˜åŒ–å™¨å†…å­˜çš„å¤§å°å–å†³äºæ‰€ä½¿ç”¨çš„ä¼˜åŒ–å™¨ç±»å‹ã€‚ä¾‹å¦‚ï¼ŒAdamä¼˜åŒ–å™¨éœ€è¦é¢å¤–çš„å†…å­˜æ¥å­˜å‚¨æ¢¯åº¦çš„ä¸€é˜¶å’ŒäºŒé˜¶çŸ©ï¼Œè€ŒSGDåªéœ€è¦å­˜å‚¨æ¢¯åº¦ä¿¡æ¯ï¼Œæ— å…¶ä»–ä¼˜åŒ–å™¨å†…å­˜å ç”¨ã€‚### æ¿€æ´»å€¼æ¿€æ´»å†…å­˜ç”¨äºå­˜å‚¨ç¥ç»ç½‘ç»œåœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­è®¡ç®—çš„ä¸­é—´æ¿€æ´»å€¼ã€‚è¿™äº›æ¿€æ´»å€¼åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­éœ€è¦è¢«é‡ç”¨ï¼Œä»¥è®¡ç®—å…³äºæ¨¡å‹å‚æ•°çš„æ¢¯åº¦ã€‚æ¿€æ´»å†…å­˜çš„å¤§å°ä¸ç½‘ç»œçš„æ·±åº¦å’Œè¾“å…¥æ•°æ®å¤§å°ï¼ˆbatchsizeï¼‰æœ‰å…³ã€‚æ›´æ·±çš„ç½‘ç»œå’Œæ›´å¤§çš„ batch size ä¼šå¯¼è‡´æ›´å¤§çš„æ¿€æ´»å†…å­˜éœ€æ±‚ã€‚</p><h2 id="æ•°æ®ç²¾åº¦">æ•°æ®ç²¾åº¦</h2><p>æƒ³è¦è®¡ç®—æ˜¾å­˜ï¼Œä»â€œåŸå­â€å±‚é¢æ¥çœ‹ï¼Œå°±éœ€è¦çŸ¥é“æˆ‘ä»¬çš„ä½¿ç”¨æ•°æ®çš„ç²¾åº¦ï¼Œå› ä¸ºç²¾åº¦ä»£è¡¨äº†æ•°æ®å­˜å‚¨çš„æ–¹å¼ï¼Œå†³å®šäº†ä¸€ä¸ªæ•°æ®å å¤šå°‘bitã€‚å¯¹äºä¸€ä¸ª1Bå‚æ•°çš„æ¨¡å‹ï¼Œå¦‚æœä½¿ç”¨FP32ç²¾åº¦å­˜å‚¨ï¼Œé‚£ä¹ˆæ¨¡å‹æƒé‡å ç”¨çš„æ˜¾å­˜å°±æ˜¯1B* 2 = 2GBã€‚</p><h3 id="å¸¸è§ç²¾åº¦ç±»å‹">å¸¸è§ç²¾åº¦ç±»å‹</h3><p>æµ®ç‚¹æ•°ä¸»è¦æ˜¯ç”±ç¬¦å·ä½ï¼ˆsignï¼‰ã€æŒ‡æ•°ä½ï¼ˆexponentï¼‰å’Œå°æ•°ä½ï¼ˆmantissaï¼‰ä¸‰éƒ¨åˆ†ç»„æˆã€‚ç¬¦å·ä½éƒ½æ˜¯1ä½ï¼ˆ0è¡¨ç¤ºæ­£ï¼Œ1è¡¨ç¤ºè´Ÿï¼‰ï¼ŒæŒ‡æ•°ä½å½±å“æµ®ç‚¹æ•°èŒƒå›´ï¼Œå°æ•°ä½å½±å“ç²¾åº¦ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202035151.png">- FP32ï¼š32ä½æµ®ç‚¹æ•°ï¼Œæ¯ä¸ªæ•°æ®å 4å­—èŠ‚ -TF32ï¼š<strong>19ä½æµ®ç‚¹æ•°</strong>ï¼Œæ¯ä¸ªæ•°æ®å 2å­—èŠ‚ -FP16ï¼š16ä½æµ®ç‚¹æ•°ï¼Œæ¯ä¸ªæ•°æ®å 2å­—èŠ‚ - BF16ï¼š16ä½æµ®ç‚¹æ•°ï¼Œæ¯ä¸ªæ•°æ®å 2å­—èŠ‚ -Int8ï¼š8ä½æ•´æ•°ï¼Œæ¯ä¸ªæ•°æ®å 1å­—èŠ‚ - Int4ï¼š4ä½æ•´æ•°ï¼Œæ¯ä¸ªæ•°æ®å 0.5å­—èŠ‚</p><h3 id="æ··åˆç²¾åº¦è®­ç»ƒamp">æ··åˆç²¾åº¦è®­ç»ƒAMP</h3><p>è¾ƒä½æ¨¡å‹ç²¾åº¦å¯¹äºè¿ç®—æ•ˆç‡å’Œæ˜¾å­˜å ç”¨éƒ½æ›´å‹å¥½ï¼Œä½†æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨FP16ç²¾åº¦åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šå‡ºç°å¾ˆå¤šé—®é¢˜ï¼š- underflowï¼šæ¢¯åº¦å†ä¹˜ä»¥å­¦ä¹ ç‡ä¼šå¾ˆå°ï¼Œæ— æ³•ç”¨fp16è¡¨ç¤º - roundingerrorï¼šfp16å„ä¸ªåŒºé—´ä¹‹é—´å­˜åœ¨gapï¼Œå³ä½¿æ¢¯åº¦å¯ä»¥ç”¨fp16è¡¨ç¤ºï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰æŠŠæ³•åŠ åœ¨fp16çš„æƒé‡ä¸Šï¼ˆè¢«èˆå»ï¼‰- æ¨¡å‹é¢„æµ‹å‡†ç¡®åº¦é™ä½ #### FP32æƒé‡å¤‡ä»½ï¼šè§£å†³èˆå…¥è¯¯å·®é—®é¢˜ä¿ç•™ä¸€ä»½FP32çš„ä¸»æƒé‡ï¼ˆMaster-Weightsï¼‰ï¼ŒåŒæ—¶åœ¨è®­ç»ƒä¸­ä½¿ç”¨FP16å­˜å‚¨æƒé‡ã€æ¿€æ´»ã€æ¢¯åº¦ç­‰æ•°æ®ã€‚åœ¨å‚æ•°æ›´æ–°çš„è¿‡ç¨‹æ±‡æ€»ï¼Œç”¨FP16æ›´æ–°FP32çš„ä¸»æƒé‡ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202040432.png"></p><p>Step1:ä¼˜åŒ–å™¨ä¼šå…ˆå¤‡ä»½ä¸€ä»½FP32ç²¾åº¦çš„æ¨¡å‹æƒé‡ï¼Œåˆå§‹åŒ–å¥½FP32ç²¾åº¦çš„ä¸€é˜¶å’ŒäºŒé˜¶åŠ¨é‡ï¼ˆç”¨äºæ›´æ–°æƒé‡ï¼‰ã€‚</p><p>Step2:å¼€è¾Ÿä¸€å—æ–°çš„å­˜å‚¨ç©ºé—´ï¼Œå°†FP32ç²¾åº¦çš„æ¨¡å‹æƒé‡è½¬æ¢ä¸ºFP16ç²¾åº¦çš„æ¨¡å‹æƒé‡ã€‚</p><p>Step3:è¿è¡Œforwardå’Œbackwardï¼Œäº§ç”Ÿçš„æ¢¯åº¦å’Œæ¿€æ´»å€¼éƒ½ç”¨FP16ç²¾åº¦å­˜å‚¨ã€‚</p><p>Step4:ä¼˜åŒ–å™¨åˆ©ç”¨FP16çš„æ¢¯åº¦å’ŒFP32ç²¾åº¦çš„ä¸€é˜¶å’ŒäºŒé˜¶åŠ¨é‡å»æ›´æ–°å¤‡ä»½çš„FP32çš„æ¨¡å‹æƒé‡ã€‚</p><p>Step5:é‡å¤Step2åˆ°Step4è®­ç»ƒï¼Œç›´åˆ°æ¨¡å‹æ”¶æ•›ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®­ç»ƒè¿‡ç¨‹ä¸­æ˜¾å­˜ä¸»è¦è¢«ç”¨åœ¨å››ä¸ªæ¨¡å—ä¸Šï¼š</p><ul><li>æ¨¡å‹æƒé‡æœ¬èº«ï¼ˆFP32+FP16ï¼‰</li><li>æ¢¯åº¦ï¼ˆFP16ï¼‰</li><li>ä¼˜åŒ–å™¨ï¼ˆFP32ï¼‰</li><li>æ¿€æ´»å€¼ï¼ˆFP16ï¼‰</li></ul><p>å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥å¯¹äºåˆ†æå¤§æ¨¡å‹è®­ç»ƒæ—¶å€™çš„æ˜¾å­˜é—®é¢˜åº”è¯¥ä¸åœ¨è¯ä¸‹äº†ï¼ˆé™¤äº†åŠ¨æ€éƒ¨åˆ†ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥å®æµ‹ä¸€ä¸‹ï¼Œæ­£åœ¨é˜…è¯»çš„å°ä¼™ä¼´ä¹Ÿå¯ä»¥å…ˆè‡ªå·±å°è¯•è®¡ç®—ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯çœŸçš„æ‡‚äº†ã€‚å¯¹äºllama3.18Bæ¨¡å‹ï¼ŒFP32å’ŒBF16æ··åˆç²¾åº¦è®­ç»ƒï¼Œç”¨çš„æ˜¯AdamWä¼˜åŒ–å™¨ï¼Œè¯·é—®æ¨¡å‹è®­ç»ƒæ—¶å ç”¨æ˜¾å­˜å¤§æ¦‚ä¸ºå¤šå°‘ï¼Ÿ</p><p>è§£ï¼š</p><p>æ¨¡å‹å‚æ•°ï¼š16ï¼ˆBF16ï¼‰ + 32ï¼ˆPF32ï¼‰= 48G</p><p>æ¢¯åº¦å‚æ•°ï¼š16ï¼ˆBF16ï¼‰= 16G</p><p>ä¼˜åŒ–å™¨å‚æ•°ï¼š32ï¼ˆPF32ï¼‰ + 32ï¼ˆPF32ï¼‰= 64G</p><p>ä¸è€ƒè™‘æ¿€æ´»å€¼çš„æƒ…å†µä¸‹ï¼Œæ€»æ˜¾å­˜å¤§çº¦å ç”¨ ï¼ˆ48 + 16 + 64ï¼‰ = 128G</p><h4 id="æŸå¤±ç¼©æ”¾è§£å†³æ•°æ®ä¸‹æº¢é—®é¢˜">æŸå¤±ç¼©æ”¾ï¼šè§£å†³æ•°æ®ä¸‹æº¢é—®é¢˜</h4><p>å½“é‡‡ç”¨FP16è€Œä¸æ˜¯FP32æ›´æ–°æ¢¯åº¦æ—¶ï¼Œç”±äºå€¼å¤ªå°ï¼Œä¼šé€ æˆFP16ç²¾åº¦ä¸‹æ•°æ®ä¸‹æº¢çš„é—®é¢˜ï¼Œä¸€äº›æ¢¯åº¦ä¼šå˜ä¸º0ï¼Œå¯¼è‡´æ¨¡å‹ä¸æ”¶æ•›ã€‚æ•…é‡‡ç”¨åœ¨å‰å‘è¿‡ç¨‹ç»“æŸåå¯¹æŸå¤±è¿›è¡Œæ”¾å¤§ï¼Œåœ¨åå‘è¿‡ç¨‹ç»“æŸåå¯¹æ¢¯åº¦è¿›è¡Œç¼©å°ã€‚æŸå¤±ç¼©æ”¾å¯ä»¥æœ‰ä¸¤ç§ä¸»è¦æ–¹å¼ï¼šé™æ€æŸå¤±ç¼©æ”¾å’ŒåŠ¨æ€æŸå¤±ç¼©æ”¾ã€‚ -é™æ€æŸå¤±ç¼©æ”¾ï¼šåœ¨è®­ç»ƒå¼€å§‹å‰ï¼Œè®¾ç½®ä¸€ä¸ªå›ºå®šçš„ç¼©æ”¾å› å­ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¿æŒä¸å˜ã€‚- åŠ¨æ€æŸå¤±ç¼©æ”¾ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æŸå¤±å€¼çš„å¤§å°åŠ¨æ€è°ƒæ•´ç¼©æ”¾å› å­ã€‚ -å¦‚æœåœ¨æŸè½®è®­ç»ƒä¸­æ£€æµ‹åˆ°æ¢¯åº¦æ­£å¸¸ä¸”æ²¡æœ‰æº¢å‡ºï¼Œç¼©æ”¾å› å­ä¼šé€æ¸å¢å¤§ã€‚ -å¦‚æœæ£€æµ‹åˆ°æ¢¯åº¦å‡ºç° NaN æˆ– Infï¼Œåˆ™ç¼©æ”¾å› å­å‡å°ä»¥é˜²æ­¢æ•°å€¼ä¸ç¨³å®šã€‚ ####ç²¾åº¦ç´¯åŠ æ­¤å¤–ï¼Œç ”ç©¶è€…è¿˜å‘ç°ï¼Œå¯ä»¥åœ¨æ¨¡å‹è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨FP16è¿›è¡Œä¹˜æ³•é¢„ç®—ï¼Œä½¿ç”¨FP32è¿›è¡Œç´¯åŠ è¿ç®—ï¼Œå¹¶å°†FP32è½¬æ¢ä¸ºFP16å­˜å‚¨ã€‚FP32å¯ä»¥å¼¥è¡¥æŸå¤±çš„ç²¾åº¦ï¼Œå‡å°‘èˆå…¥è¯¯å·®ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202042004.png">å¦‚è‹±ä¼Ÿè¾¾Voltaæ¶æ„ä¸­çš„TensorCoreå¯ä»¥ä½¿ç”¨FP16æ··åˆç²¾åº¦è¿›è¡ŒåŠ é€Ÿï¼Œé‡‡ç”¨çš„æ˜¯FP16çš„çŸ©é˜µä¹˜æ³•ï¼Œå¾—å‡ºå…¨ç²¾åº¦ä¹˜ç§¯ï¼Œç„¶åä½¿ç”¨FP32ç´¯åŠ ï¼Œå°†è¯¥ä¹˜ç§¯ä¸å…¶ä»–ä¸­é—´ä¹˜ç§¯ç´¯åŠ ï¼Œå‡å°‘å› FP16å¸¦æ¥çš„ç²¾åº¦æŸå¤±ã€‚#### æ›´ä¸ºåŠ¨æ€çš„ç²¾åº¦ç¼©æ”¾æ–¹æ³•åœ¨è‹±ä¼Ÿè¾¾æœ€æ–°çš„Hopperæ¶æ„GPUä¸­ï¼Œè‹±ä¼Ÿè¾¾çš„TensorCoreèƒ½å¤Ÿè‡ªåŠ¨æ ¹æ®æ‰€éœ€çš„ç²¾åº¦è¿›è¡ŒåŠ¨æ€çš„æ•°æ®ç¼©æ”¾è°ƒæ•´ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹Transformerç½‘ç»œæ¶æ„ï¼Œèƒ½å¤Ÿåœ¨æ•°æ®å­˜å…¥å†…å­˜å‰ï¼Œæ ¹æ®éœ€æ±‚æ”¹å˜å„ç§å‚æ•°ç²¾åº¦ã€‚<img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main/images/20241202042340.png">Hopperç™½çš®ä¹¦å†…å®¹å¦‚ä¸‹ï¼š &gt;åœ¨ Transformer æ¨¡å‹çš„æ¯ä¸€å±‚ï¼ŒTransformerEngine éƒ½ä¼šåˆ†æ Tensor Coreäº§ç”Ÿçš„è¾“å‡ºå€¼çš„ç»Ÿè®¡æ•°æ®ã€‚äº†è§£äº†æ¥ä¸‹æ¥ä¼šå‡ºç°å“ªç§ç±»å‹çš„ç¥ç»ç½‘ç»œå±‚ä»¥åŠå®ƒéœ€è¦ä»€ä¹ˆç²¾åº¦åï¼ŒTransformerEngine è¿˜ä¼šå†³å®šå°†å¼ é‡è½¬æ¢ä¸ºå“ªç§ç›®æ ‡æ ¼å¼ï¼Œç„¶åå†å°†å…¶å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚ FP8çš„èŒƒå›´æ¯”å…¶ä»–æ•°å­—æ ¼å¼æ›´æœ‰é™ã€‚ä¸ºäº†ä¼˜åŒ–ä½¿ç”¨å¯ç”¨èŒƒå›´ï¼ŒTransformer Engineè¿˜ä½¿ç”¨ä»å¼ é‡ç»Ÿè®¡æ•°æ®è®¡ç®—çš„ç¼©æ”¾å› å­åŠ¨æ€åœ°å°†å¼ é‡æ•°æ®ç¼©æ”¾åˆ°å¯è¡¨ç¤ºçš„èŒƒå›´å†…ã€‚å› æ­¤ï¼Œæ¯ä¸€å±‚éƒ½åœ¨å…¶æ‰€éœ€çš„èŒƒå›´å†…è¿è¡Œï¼Œå¹¶ä»¥æœ€ä½³æ–¹å¼åŠ é€Ÿã€‚## å…¶ä»–æ˜¾å­˜å ç”¨ - KVCacheï¼šåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œå¤§æ¨¡å‹éœ€è¦ç¼“å­˜ä¸€äº›ä¸­é—´ç»“æœï¼Œä»¥ä¾¿åœ¨å¤„ç†ä¸‹ä¸€ä¸ªè¾“å…¥æ—¶é‡ç”¨ã€‚è¿™äº›ç¼“å­˜çš„ç»“æœé€šå¸¸ç§°ä¸ºKVCacheã€‚KVCacheå ç”¨çš„æ˜¾å­˜å¤§å°ä¸æ¨¡å‹çš„å±‚æ•°ã€åºåˆ—é•¿åº¦å’Œæ¯ä¸ªåºåˆ—çš„tokenæ•°é‡æœ‰å…³ã€‚ -æ˜¾å­˜ç¢ç‰‡ï¼šæ˜¾å­˜ç¢ç‰‡æ˜¯æŒ‡æ˜¾å­˜ä¸­æœªè¢«ä½¿ç”¨çš„ç©ºé—²ç©ºé—´ï¼Œè¿™äº›ç©ºé—²ç©ºé—´å¯èƒ½æ— æ³•è¢«æœ‰æ•ˆåˆ©ç”¨ï¼Œå¯¼è‡´æ˜¾å­˜åˆ©ç”¨ç‡é™ä½ã€‚pagedattentionæœºåˆ¶å¯ä»¥æœ‰æ•ˆå‡å°‘æ˜¾å­˜ç¢ç‰‡ã€‚</p><h3 id="æ¨ç†ä¸kv-cache-æ˜¾å­˜">æ¨ç†ä¸KV cache æ˜¾å­˜</h3><p>æ¨ç†çš„æ—¶å€™ï¼Œæ˜¾å­˜å‡ ä¹åªè€ƒè™‘æ¨¡å‹å‚æ•°æœ¬èº«ï¼Œé™¤æ­¤ä¹‹å¤–å°±æ˜¯ç°åœ¨å¹¿æ³›ä½¿ç”¨çš„KVcacheä¹Ÿä¼šå ç”¨æ˜¾å­˜ã€‚KV cacheä¸ä¹‹å‰è®²çš„å¦‚ä½•å‡å°‘æ˜¾å­˜ä¸ä¸€æ ·ï¼ŒKVcacheçš„ç›®çš„æ˜¯å‡å°‘å»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯<strong>ä¸ºäº†æ¨ç†çš„é€Ÿåº¦ç‰ºç‰²æ˜¾å­˜</strong>ã€‚#### kv cacheä»‹ç» å…·ä½“å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡åšå®¢ï¼š<a href="https://baoblei.github.io/2024/12/02/da-mo-xing-you-hua-kv-cache/">å¤§æ¨¡å‹ä¼˜åŒ–--KVCache</a> KVCacheæ˜¯Transformeræ ‡é…çš„æ¨ç†åŠ é€ŸåŠŸèƒ½ï¼Œtransformerå®˜æ–¹use_cacheè¿™ä¸ªå‚æ•°é»˜è®¤æ˜¯Trueï¼Œä½†æ˜¯å®ƒåªèƒ½ç”¨äºDecoderæ¶æ„çš„æ¨¡å‹ï¼Œè¿™æ˜¯å› ä¸ºDecoderæœ‰CausalMaskï¼Œåœ¨æ¨ç†çš„æ—¶å€™å‰é¢å·²ç»ç”Ÿæˆçš„å­—ç¬¦ä¸éœ€è¦ä¸åé¢çš„å­—ç¬¦äº§ç”Ÿattentionï¼Œä»è€Œä½¿å¾—å‰é¢å·²ç»è®¡ç®—çš„Kå’ŒVå¯ä»¥ç¼“å­˜èµ·æ¥ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ä½¿ç”¨KV Cacheå’Œä¸ä½¿ç”¨KV Cacheçš„è¿‡ç¨‹å¯¹æ¯”ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241202211901.png">ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š - å½“å‰è®¡ç®—æ–¹å¼å­˜åœ¨å¤§é‡å†—ä½™è®¡ç®— - <span class="math inline">\(Attn_k\)</span>åªä¸<span class="math inline">\(Q_k\)</span>æœ‰å…³ - æ¨ç†ç¬¬<span class="math inline">\(x_k\)</span>ä¸ªå­—ç¬¦æ—¶ï¼Œåªéœ€è¦è¾“å…¥å­—ç¬¦<span class="math inline">\(x_{k-1}\)</span>å³å¯ã€‚ç¬¬ä¸‰ä¸ªç»“è®ºçš„å‰ææ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ¯ä¸€æ­¥çš„Kå’ŒVç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·åœ¨æ¨ç†ç¬¬<span class="math inline">\(x_k\)</span>ä¸ªå­—ç¬¦æ—¶ï¼Œåªéœ€è¦è¾“å…¥å­—ç¬¦<span class="math inline">\(x_{k-1}\)</span>è®¡ç®—å…¶<span class="math inline">\(Q_k,K_k,V_k\)</span>, ç»“åˆä¹‹å‰ä¿å­˜çš„KVCacheå³å¯å¾—åˆ°å¯¹åº”çš„<span class="math inline">\(Attn_k\)</span>ã€‚</p><p><a href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/gpt2/modeling_gpt2.py#L318C1-L331C97">huggingfaceçš„å®ç°</a> </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">if layer_past is not None:        past_key, past_value = layer_past        key = torch.cat((past_key, key), dim=-2)        value = torch.cat((past_value, value), dim=-2)        if use_cache is True:        present = (key, value)    else:        present = None        if self.reorder_and_upcast_attn:        attn_output, attn_weights = self._upcast_and_reordered_attn(query, key, value, attention_mask, head_mask)    else:        attn_output, attn_weights = self._attn(query, key, value, attention_mask, head_mask)</code></pre><p></p><h4 id="kv-cacheæ˜¾å­˜å ç”¨">KV Cacheæ˜¾å­˜å ç”¨</h4><p>å½“<strong>sequenceç‰¹åˆ«é•¿</strong>çš„æ—¶å€™ï¼ŒKVCacheå…¶å®è¿˜æ˜¯ä¸ªMemoryåˆºå®¢ã€‚</p><p>å¯¹äºfp16ç²¾åº¦ä¿å­˜çš„KV Cacheï¼Œå…¶å ç”¨çš„æ˜¾å­˜å¤§å°ä¸ºï¼š <span class="math display">\[memory = batch\_size * hidden\_size * seq\_length * layer * 2 * 2\]</span> å…¶ä¸­ä¸¤ä¸ª2åˆ†åˆ«è¡¨ç¤ºKå’ŒVï¼Œfp16ç²¾åº¦å­—èŠ‚æ•°ã€‚</p><p>æ¯”å¦‚llama 7Bæ¨¡å‹ï¼Œbatch_size=32, layer=32, dim_size=4096,seq_length=2048, float32ç±»å‹ï¼Œåˆ™éœ€è¦å ç”¨çš„æ˜¾å­˜ä¸º 2 * 32 * 4096 * 2048 *32 * 4 / 1024/1024/1024 = 64Gã€‚</p><p>ä¸ºäº†è§£å†³KVCacheæ˜¾å­˜å ç”¨é—®é¢˜ï¼Œç ”ç©¶è€…æå‡ºäº†<strong>MQAå’ŒGQA</strong>ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å…±äº«å¤šå¤´KVCache</strong>ã€‚ <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241203015549.png">ä»¥GQAä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†hidden_sizeç»´åº¦åˆ‡åˆ†ä¸ºhead*head_dimï¼Œç„¶åå°†å¤šä¸ªheadåˆ†æˆgroupç»„ï¼Œæ¯ä¸ªgroupå…±äº«ä¸€ä¸ªKVã€‚åˆ™æ€»çš„KVCacheæ˜¾å­˜å ç”¨ä¸ºï¼š <span class="math display">\[memory = batch\_size * group * head\_dim * seq\_length * layer *  2 * 2\]</span> è€ŒMQAåˆ™æ˜¯group=1ï¼Œå³æ¯ä¸ªheadå•ç‹¬ä¿å­˜ä¸€ä¸ªKVã€‚</p><blockquote><p>å¤§æ¨¡å‹æ¨ç†åŠ é€Ÿï¼šçœ‹å›¾å­¦KV Cachehttps://zhuanlan.zhihu.com/p/662498827</p></blockquote><h3 id="lora-ä¸-qlora-è®­ç»ƒæ˜¾å­˜">LoRA ä¸ QLoRA è®­ç»ƒæ˜¾å­˜</h3><h4 id="lora">LoRA</h4><p><img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241204190635.png">LoRAæ˜¯åœ¨åŸæ¥çš„æƒé‡çŸ©é˜µçš„æ—è·¯æ–°å»ºä¸€å¯¹ä½ç§©çš„å¯è®­ç»ƒæƒé‡ï¼Œè®­ç»ƒçš„æ—¶å€™åªè®­ç»ƒæ—è·¯ï¼Œå¤§å¤§é™ä½äº†è®­ç»ƒçš„æƒé‡æ•°é‡ï¼Œå‚æ•°é‡ä»dxd é™ä¸º 2xdxrã€‚</p><p>æœ‰äº†å‰é¢çš„å…¨å‚æƒ…å†µä¸‹è®­ç»ƒçš„æ˜¾å­˜åˆ†æï¼Œç°åœ¨åˆ†æèµ·æ¥å°±æ¯”è¾ƒé€šé¡ºäº†ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œè¿˜æ˜¯ä»¥BF16åŠç²¾åº¦æ¨¡å‹Adamwä¼˜åŒ–å™¨è®­ç»ƒä¸ºä¾‹å­ï¼Œloraéƒ¨åˆ†çš„å‚æ•°ç²¾åº¦ä¹Ÿæ˜¯BF16ï¼Œå¹¶ä¸”è®¾1å­—èŠ‚æ¨¡å‹å‚æ•°å¯¹åº”çš„æ˜¾å­˜å¤§å°<span class="math inline">\(\Phi\)</span>ã€‚</p><ul><li>é¦–å…ˆæ˜¯æ¨¡å‹æƒé‡æœ¬èº«çš„æƒé‡ï¼Œè¿™ä¸ªè‚¯å®šæ˜¯è¦åŠ è½½åŸå§‹æ¨¡å‹å’Œloraæ—è·¯æ¨¡å‹çš„ï¼Œå› ä¸ºloraéƒ¨åˆ†å æ¯”å°äº2ä¸ªæ•°é‡çº§ï¼Œæ‰€ä»¥æ˜¾å­˜åˆ†æçš„æ—¶å€™å¿½ç•¥ä¸è®¡ï¼Œæ˜¾å­˜å ç”¨<span class="math inline">\(2\Phi\)</span>ã€‚</li><li>ç„¶åå°±æ˜¯ä¼˜åŒ–å™¨éƒ¨åˆ†ï¼Œä¼˜åŒ–å™¨ä¹Ÿä¸éœ€è¦å¯¹åŸæ¨¡å‹è¿›è¡Œå¤‡ä»½äº†ï¼Œå› ä¸ºä¼˜åŒ–å™¨æ˜¯é’ˆå¯¹äºéœ€è¦æ›´æ–°å‚æ•°çš„æ¨¡å‹æƒé‡éƒ¨åˆ†è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼˜åŒ–å™¨åªåŒ…å«Loraæ¨¡å‹æƒé‡ç›¸å…³çš„å†…å®¹ï¼Œè€ƒè™‘åˆ°æ•°é‡çº§å¤ªå°ï¼Œä¹Ÿå¿½ç•¥ä¸è®¡ï¼Œæ•…ä¼˜åŒ–å™¨éƒ¨åˆ†å ç”¨æ˜¾å­˜0ã€‚</li><li>åŸå§‹æ¨¡å‹éƒ½ä¸æ›´æ–°æ¢¯åº¦ï¼Œè‚¯å®šåªéœ€è¦Loraéƒ¨åˆ†çš„æ¢¯åº¦æ˜¾å­˜ï¼Œè€Œè¿™éƒ¨åˆ†å ç”¨æ˜¾å­˜ä¹Ÿå¯ä»¥è¿‘ä¼¼ä¸º0ã€‚ æƒ³æ·±å…¥æ¢ç©¶çš„å¯ä»¥å»çœ‹äº†ä¸€ç¯‡<a href="https://baoblei.github.io/2024/12/04/da-mo-xing-gao-xiao-wei-diao-fang-fa-peft-lora-qlora/">åšæ–‡</a>å’Œ<a href="https://zhuanlan.zhihu.com/p/702629428">å¤§æ¨¡å‹é«˜æ•ˆå¾®è°ƒ-LoRAåŸç†è¯¦è§£å’Œè®­ç»ƒè¿‡ç¨‹æ·±å…¥åˆ†æ</a>ã€‚</li></ul><p>æ€»çš„æ¥è¯´ï¼Œä¸è€ƒè™‘æ¿€æ´»å€¼çš„æƒ…å†µä¸‹ï¼ŒLoraå¾®è°ƒè®­ç»ƒçš„æ˜¾å­˜å ç”¨åªæœ‰<span class="math inline">\(2\Phi\)</span>ï¼Œä¸€ä¸ª7Bçš„æ¨¡å‹Loraè®­ç»ƒåªéœ€è¦å ç”¨æ˜¾å­˜å¤§çº¦14Gå·¦å³ã€‚éªŒè¯ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ¥çœ‹LlamaFactoryé‡Œç»™å‡ºè®­ç»ƒä»»åŠ¡çš„æ˜¾å­˜é¢„ä¼°è¡¨æ ¼ï¼š <img src="https://cdn.jsdelivr.net/gh/baoblei/imgs_md@main//images/20241205031352.png"></p><h4 id="qlora">QLoRA</h4><p>QLoRAæœ¬è´¨ä¸Šè¿˜æ˜¯å¯¹æ¨¡å‹çš„ä¸»ä½“è¿›è¡Œäº†é‡åŒ–ï¼Œä»¥4Bité‡åŒ–ä¸ºä¾‹ï¼ŒQloraå ç”¨çš„æ˜¾å­˜ä¸»è¦å°±æ˜¯4Bité‡åŒ–åçš„æ¨¡å‹æœ¬èº«ä¹Ÿå°±æ˜¯<span class="math inline">\(0.5\Phi\)</span>ï¼Œç”±äºAã€BçŸ©é˜µçš„å‚æ•°é‡å¾ˆå°ï¼Œæ•…å¿½ç•¥ä¸è®¡ã€‚</p><h1 id="æ€»ç»“">æ€»ç»“</h1><table><colgroup><col style="width: 27%"><col style="width: 20%"><col style="width: 27%"><col style="width: 12%"><col style="width: 12%"></colgroup><thead><tr class="header"><th>éƒ¨åˆ†æ˜¾å­˜å¯¹åº”ç²¾åº¦ï¼ˆè®­ç»ƒï¼‰</th><th>å…¨å‚å¾®è°ƒï¼ˆå…¨FP16ï¼‰</th><th>å…¨å‚å¾®è°ƒï¼ˆBF16æ··åˆç²¾åº¦ï¼‰</th><th>LoRA</th><th>QLoRA</th></tr></thead><tbody><tr class="odd"><td>ä¸»å¹²æ¨¡å‹ï¼ˆæ¨¡å‹å­˜å‚¨/è®¡ç®—å‚æ•°ï¼‰</td><td>FP16/FP16</td><td>BF16/BF16</td><td>BF16/BF16</td><td>NF4/BF16</td></tr><tr class="even"><td>ä¸»å¹²æ¨¡å‹ï¼ˆæ¢¯åº¦ï¼‰</td><td>FP16</td><td>BF16</td><td>Null</td><td>Null</td></tr><tr class="odd"><td>ä¸»å¹²æ¨¡å‹ï¼ˆadamwä¼˜åŒ–å™¨ï¼‰</td><td>2 x FP16</td><td>3 x FP32</td><td>Null</td><td>Null</td></tr><tr class="even"><td>LoRAéƒ¨åˆ†ï¼ˆå¯å¿½ç•¥ä¸è®¡ï¼‰</td><td>Null</td><td>Null</td><td>BF16</td><td>BF16</td></tr><tr class="odd"><td>æ€»å’Œï¼ˆå¤§çº¦ï¼‰</td><td>8Byte</td><td>16Byte</td><td>2Byte</td><td>0.5Byte</td></tr></tbody></table><h2 id="huggingface-æ˜¾å­˜åˆ†æå·¥å…·">huggingface æ˜¾å­˜åˆ†æå·¥å…·</h2><p>huggingfaceæä¾›äº†ä¸€ä¸ªå·¥å…·å¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹å¤§æ¨¡å‹åœ¨ä¸åŒé˜¶æ®µæ¶ˆè€—çš„æ˜¾å­˜å¤§å°ã€‚ <a href="https://huggingface.co/docs/accelerate/usage_guides/model_size_estimator">modelsize estimator</a></p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><blockquote><p>https://blog.zhexuan.org/archives/llm-gpu-memory.html</p></blockquote><blockquote><p>https://juejin.cn/post/7352387675837480995</p></blockquote><blockquote><p>https://gitcode.csdn.net/662a062ca2b051225566cf63.html</p></blockquote><blockquote><p>https://hub.baai.ac.cn/view/16045</p></blockquote><blockquote><p>https://zhuanlan.zhihu.com/p/624740065</p></blockquote><blockquote><p>NVIDIA H100 Tensor Core GPUArchitectureï¼šhttps://nvdam.widen.net/s/9bz6dw7dqr/gtc22-whitepaper-hopper</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> LLMs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLMs </tag>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> KV Cache </tag>
            
            <tag> AI </tag>
            
            <tag> LoRA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoåšå®¢æ­å»º</title>
      <link href="/2024/11/28/hexo-zhu-ti-next-pei-zhi/"/>
      <url>/2024/11/28/hexo-zhu-ti-next-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€æ­å»º">åŸºç¡€æ­å»º</h2><h3 id="hexo">Hexo</h3><p>é€‰ä¸€ä¸ªåšå®¢æ¡†æ¶ï¼Œhexoæ˜¯é™æ€ç½‘ç«™æ¡†æ¶ï¼ŒåŸºäºnodejsï¼Œå¯ä»¥ç”Ÿæˆé™æ€ç½‘é¡µï¼Œéƒ¨ç½²åˆ°githubä¸Šã€‚éœ€è¦æå‰å®‰è£…<strong>git</strong>ï¼Œ<strong>nodejs</strong>ã€‚ - check gitversion: <code>git --version</code> - check nodejs version:<code>node -v</code> - check npm version: <code>npm -v</code> å®‰è£… cnmp(optional) -<code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code>- check cnmp version: <code>cnpm -v</code></p><p>å®‰è£… <strong>hexo-cli</strong> -<code>cnpm install -g hexo-cli</code> - check hexo version:<code>hexo -v</code></p><h3 id="åˆå§‹åŒ–blogç›®å½•">åˆå§‹åŒ–blogç›®å½•</h3><ul><li><code>mkdir blog | cd blog</code></li><li><code>sudo hexo init</code> # clone hexo-starter repo</li><li><code>hexo s</code> # start blog, default port 4000</li></ul><h3 id="æ·»åŠ åšå®¢">æ·»åŠ åšå®¢</h3><ul><li><code>hexo n "newblog"</code> # add new blog, save in /source/_posts<ul><li>edit blog in /source/_posts/newblog.md</li></ul></li><li><code>hexo clean</code> # clean cache</li><li><code>hexo g</code> # generate static files</li><li><code>hexo s</code> # start blog, default port 4000</li></ul><h3 id="githubéƒ¨ç½²">githubéƒ¨ç½²</h3><ul><li>build blog address:<ul><li>add new token in github</li><li>github new repo: https://<username>.github.io/</username></li></ul></li><li><code>cnpm install hexo-deployer-git --save</code><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">deploy:    type: git    repo: https://&lt;token&gt;@github.com/&lt;username&gt;/&lt;username&gt;.github.io.git    branch: master</code></pre></li><li><code>hexo d</code> # deploy blog</li></ul><h2 id="ä¸»é¢˜">ä¸»é¢˜</h2><h3 id="å®‰è£…">å®‰è£…</h3><ul><li>theme æ¨èï¼š<ul><li>https://github.com/litten/hexo-theme-yilia.git</li><li>https://github.com/theme-next/hexo-theme-next.git</li></ul></li><li>clone theme into themes folder, e.g.<code>git clone https://github.com/theme-next/hexo-theme-next.git themes/next</code></li><li>edit _config.yml, set theme to next <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">theme: next</code></pre></li><li><code>hexo c</code>&amp;&amp;<code>hexo g</code>&amp;&amp;<code>hexo d</code># clean cache, generate static files, deploy blog</li></ul><h3 id="é…ç½®ä¸»é¢˜">é…ç½®ä¸»é¢˜</h3><p>å¤§éƒ¨åˆ†é…ç½®åœ¨<code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‚è€ƒ<a href="https://theme-next.js.org/docs/getting-started/">å®˜æ–¹æ–‡æ¡£</a> ####åŸºç¡€ ##### scheme - Scheme æ˜¯ NexT æä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œå€ŸåŠ©äº Schemeï¼ŒNexTä¸ºä½ æä¾›å¤šç§ä¸åŒçš„å¤–è§‚ã€‚åŒæ—¶ï¼Œå‡ ä¹æ‰€æœ‰çš„é…ç½®éƒ½å¯ä»¥ åœ¨ Scheme ä¹‹é—´å…±ç”¨ã€‚- muse - é»˜è®¤ Schemeï¼Œè¿™æ˜¯ NexT æœ€åˆçš„ç‰ˆæœ¬ï¼Œé»‘ç™½ä¸»è°ƒï¼Œå¤§é‡ç•™ç™½ - Mist -Muse çš„ç´§å‡‘ç‰ˆæœ¬ï¼Œæ•´æ´æœ‰åºçš„å•æ å¤–è§‚ - Pisces - åŒæ Schemeï¼Œå°å®¶ç¢§ç‰ä¼¼çš„æ¸…æ–° Scheme çš„åˆ‡æ¢é€šè¿‡æ›´æ”¹ <code>_config.yml</code>æ–‡ä»¶ï¼Œæœç´¢ scheme å…³é”®å­—ã€‚ ä½ ä¼šçœ‹åˆ°æœ‰ä¸‰è¡Œ scheme çš„é…ç½®ï¼Œå°†ä½ éœ€ç”¨å¯ç”¨çš„scheme å‰é¢æ³¨é‡Š # å»é™¤å³å¯ã€‚ ##### language ##### menuèœå•é…ç½®åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€æ˜¯èœå•é¡¹ï¼ˆåç§°å’Œé“¾æ¥ï¼‰ï¼Œç¬¬äºŒæ˜¯èœå•é¡¹çš„æ˜¾ç¤ºæ–‡æœ¬ï¼Œç¬¬ä¸‰æ˜¯èœå•é¡¹å¯¹åº”çš„å›¾æ ‡ã€‚NexT ä½¿ç”¨çš„æ˜¯ Font Awesome æä¾›çš„å›¾æ ‡ï¼Œå¯ä»¥åœ¨ <a href="https://fontawesome.com/icons">Font Awesome</a> æŸ¥çœ‹ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">menu:  home: / || home  archives: /archives || archive  tags: /tags || tags  categories: /categories || th</code></pre> #### å…¶ä»– ä¸»é¢˜ç¾åŒ–æ˜¯ä¸ªé€æ¸ç§¯ç´¯çš„è¿‡ç¨‹,åæœŸå¯ä»¥åœ¨ç›¸å†Œã€æŒ‚ä»¶ã€è¯„è®ºã€æœç´¢ã€sitemapã€rssç­‰æ–¹é¢è¿›è¡Œé…ç½®ã€‚ä¸€äº›å·¥å…·æ’ä»¶ï¼š <strong>gallery page</strong>--justified gallery<p></p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> next </tag>
            
            <tag> ä¸ªäººé™æ€åšå®¢æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
